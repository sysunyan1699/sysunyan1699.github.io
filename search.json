[{"title":"ç†è§£ Spring FacrotyBean","path":"/b4b9d0ea/","content":"FactoryBean å’ŒBeanFactory åå­—å¤ªåƒäº†ï¼Œä»¥è‡³äºå®¹æ˜“æ··æ·†ï¼Œä½†æ˜¯ä»åŠŸèƒ½ä¸Šè®²å®Œå…¨ä¸ä¸€æ ·ï¼Œ ç†è§£äº†å®ƒä»¬å„è‡ªçš„åŠŸèƒ½å°±å¯ä»¥å®Œç¾åŒºåˆ†è¿™ä¿©äº† 1. BeanFactorySpring IOC å®¹å™¨ï¼Œç”¨äºç®¡ç†bean ,å…·ä½“ç»†èŠ‚å·²ç»åœ¨Spring bean å®ä¾‹åŒ–ä¸­ä»‹ç»è¿‡ï¼Œå°±ä¸å†èµ˜è¿°ï¼Œå¯ä»¥ç‚¹å‡»å»é˜…è¯»ã€‚ æ€»çš„æ¥è¯´BeanFactory æ—¶Spring å®¹å™¨ï¼Œåœ¨Springçš„å¯åŠ¨è¿‡ç¨‹ï¼ŒFactoryBean æ˜¯ä¸€ä¸ªä¼šè¢«BeanFactory ç®¡ç†çš„bean , ä½†æ˜¯å®ƒç›¸æ¯”å…¶ä»–æ™®é€šä¸šåŠ¡bean,åˆæœ‰ä¸€äº›ç‰¹æ®Šçš„åŠŸèƒ½ï¼Œæ¯”å¦‚ç”Ÿäº§å‡ºå¤æ‚é…ç½®çš„bean. æ¥ä¸‹æ¥è¯¦ç»†ä»‹ç»FactoryBean 2. FactoryBean æ˜¯ä¸€ä¸ªæ¥å£ FactoryBean æ¥å£æä¾›äº†ä¸€ç§çµæ´»çš„æ–¹å¼æ¥åˆ›å»ºå¤æ‚çš„å¯¹è±¡ã€‚ å®ç° FactoryBean æ¥å£çš„ç±»ï¼Œå¯ä»¥é€šè¿‡å…¶ getObject æ–¹æ³•æ¥åˆ›å»ºå¹¶è¿”å›å®é™…çš„å¯¹è±¡å®ä¾‹ã€‚FactoryBean å¯ä»¥ç”¨äºåˆ›å»ºå•ä¾‹ã€åŸå‹ã€ä»£ç†å¯¹è±¡æˆ–å…¶ä»–å¤æ‚çš„åˆå§‹åŒ–é€»è¾‘ã€‚ FactoryBean æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š 12345public interface FactoryBean&lt;T&gt; &#123; T getObject() throws Exception; Class&lt;?&gt; getObjectType(); boolean isSingleton();&#125; T getObject() throws Exceptionï¼šè¿™ä¸ªæ–¹æ³•è¿”å›ç”± FactoryBean åˆ›å»ºçš„å¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡å¯ä»¥æ˜¯ä¸€ä¸ªæ™®é€šçš„ Beanï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡æˆ–å…¶ä»–å¤æ‚å¯¹è±¡ã€‚ Class&lt;?&gt; getObjectType()ï¼šè¿™ä¸ªæ–¹æ³•è¿”å›ç”± FactoryBean åˆ›å»ºçš„å¯¹è±¡çš„ç±»å‹ã€‚Spring ä½¿ç”¨è¿™ä¸ªä¿¡æ¯æ¥ç¡®å®š Bean çš„ç±»å‹ã€‚ boolean isSingleton()ï¼šè¿™ä¸ªæ–¹æ³•æŒ‡ç¤ºç”± FactoryBean åˆ›å»ºçš„å¯¹è±¡æ˜¯å¦æ˜¯å•ä¾‹ï¼ˆsingletonï¼‰ã€‚å¦‚æœè¿”å› trueï¼ŒSpring å®¹å™¨ä¼šç¼“å­˜è¯¥å®ä¾‹ã€‚ 3. Spring å®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­çš„FactoryBeanæ¥ä¸‹æ¥æˆ‘ä»¬å°†é€šè¿‡ åˆ†æSpring å¯åŠ¨è¿‡ç¨‹ä¸­ FactoryBeançš„å®ä¾‹åŒ–ä»¥åŠé€šè¿‡FactoryBean.getObject çš„è¿‡ç¨‹æ¥åŠ æ·±å¯¹FactoryBeançš„ç†è§£ã€‚è¿™é‡Œæˆ‘ä»¬ç”¨ Spring AOP XMLé…ç½®æ–¹å¼åŸç†è¯¦è§£ ä¸­çš„ç¤ºä¾‹ä»£ç è¿›è¡Œè®²è§£ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public class UserService &#123; public void createUser(String username) &#123; // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† System.out.println(&quot;Creating user: &quot; + username); &#125; public void deleteUser(String username) &#123; // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† System.out.println(&quot;Deleting user: &quot; + username); &#125;&#125;// å®šä¹‰ä¸€ä¸ªå‰ç½®å¢å¼ºpublic class LoggingBeforeAdvice implements MethodBeforeAdvice &#123; @Override public void before(Method method, Object[] args, Object target) throws Throwable &#123; System.out.println(&quot;Before method: &quot; + method.getName()); &#125;&#125;// å®šä¹‰ä¸€ä¸ªåç½®å¢å¼ºpublic class LoggingAfterAdvice implements AfterReturningAdvice &#123; @Override public void afterReturning(Object returnValue, Method method, Object[] args, Object target) throws Throwable &#123; System.out.println(&quot;After method: &quot; + method.getName()); &#125;&#125;// å®šä¹‰ä¸€ä¸ª ç¯ç»•å¢å¼ºpublic class LoggingMethodInterceptor implements MethodInterceptor &#123; @Override public Object invoke(MethodInvocation invocation) throws Throwable &#123; // æ–¹æ³•æ‰§è¡Œå‰é€»è¾‘ long startTime = System.currentTimeMillis(); System.out.println(invocation.getMethod().getName()+ &quot; æ–¹æ³•å¼€å§‹æ‰§è¡Œ&quot;); // é€šè¿‡åå°„æ‰§è¡Œç›®æ ‡æ–¹æ³• Object result = invocation.proceed(); // æ–¹æ³•æ‰§è¡Œåé€»è¾‘ //System.out.println(&quot;After method: &quot; + invocation.getMethod().getName()); long endTime = System.currentTimeMillis(); System.out.println(invocation.getMethod().getName()+ &quot;æ–¹æ³•æ‰§è¡Œæ—¶é—´: &quot; + (endTime - startTime) + &quot;ms&quot;); return result; &#125;&#125; 1234567891011121314151617181920212223242526272829303132333435363738&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt; &lt;!-- å®šä¹‰ä¸šåŠ¡ç±»çš„ Bean --&gt; &lt;bean id=&quot;userService&quot; class=&quot;com.example.codingInAction.service.UserService&quot;/&gt; &lt;!-- å®šä¹‰ å‰ç½®å¢å¼º --&gt; &lt;bean id=&quot;loggingBeforeAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingBeforeAdvice&quot;/&gt; &lt;!-- å®šä¹‰ åç½®å¢å¼º --&gt; &lt;bean id=&quot;loggingAfterAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingAfterAdvice&quot;/&gt; &lt;!-- å®šä¹‰ ç¯ç»•å¢å¼º --&gt; &lt;bean id=&quot;loggingMethodInterceptor&quot; class=&quot;com.example.codingInAction.aop.LoggingMethodInterceptor&quot;/&gt; &lt;!-- ä½¿ç”¨ ProxyFactoryBean é…ç½®ä»£ç†å¯¹è±¡ --&gt; &lt;bean id=&quot;userServiceProxy&quot; class=&quot;org.springframework.aop.framework.ProxyFactoryBean&quot;&gt; &lt;!-- ç›®æ ‡å¯¹è±¡ --&gt; &lt;property name=&quot;target&quot; ref=&quot;userService&quot;/&gt; &lt;!-- æ‹¦æˆªå™¨ --&gt; &lt;property name=&quot;interceptorNames&quot;&gt; &lt;list&gt; &lt;value&gt;loggingMethodInterceptor&lt;/value&gt; &lt;value&gt;loggingBeforeAdvice&lt;/value&gt; &lt;value&gt;loggingAfterAdvice&lt;/value&gt; &lt;/list&gt; &lt;/property&gt; &lt;!-- å¼ºåˆ¶ä½¿ç”¨CGLIBä»£ç† --&gt; &lt;property name=&quot;proxyTargetClass&quot; value=&quot;true&quot;/&gt; &lt;/bean&gt;&lt;/beans&gt; å¯åŠ¨ä»£ç  1234567891011121314public class CodingInActionApplication&#123; public static void main(String[] args) &#123; ApplicationContext context = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); // è·å–ä»£ç†å¯¹è±¡ UserService userService = (UserService) context.getBean(&quot;userServiceProxy&quot;); // è°ƒç”¨æ–¹æ³•ï¼Œè§‚å¯Ÿ AOP åˆ‡é¢çš„æ•ˆæœ userService.createUser(&quot;john&quot;); userService.deleteUser(&quot;john&quot;); &#125;&#125; &amp; å‰ç¼€çš„ä½œç”¨ ä½¿ç”¨ getBean(&quot;&amp;beanName&quot;) å¯ä»¥è·å– FactoryBean å®ä¾‹æœ¬èº«ï¼Œè€Œä¸æ˜¯ FactoryBean åˆ›å»ºçš„å¯¹è±¡ã€‚ ä½¿ç”¨ getBean(&quot;beanName&quot;) åˆ™è·å–ç”± FactoryBean åˆ›å»ºçš„å¯¹è±¡ã€‚ 3.1 FactoryBean ä¹Ÿæ˜¯ä¸€ä¸ªbeanFactoryBean ä¹Ÿæ˜¯ä¸€ä¸ªbean, å’Œæ™®é€šbean ä½¿ç”¨ç›¸åŒçš„é€»è¾‘è¿›è¡Œå®ä¾‹åŒ–ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯è¢«beanFactory ç®¡ç†çš„ã€‚ å¦‚ä»£ç æ‰€ç¤º1ApplicationContext context = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); åœ¨ä»¥ä¸ŠSpring å®¹å™¨çš„å¯åŠ¨è¿‡ç¨‹ä¸­ï¼ŒuserServiceProxyä½œä¸ºä¸€ä¸ªFactoryBean ä¼šé€šè¿‡getBeanè§¦å‘å®ä¾‹åŒ–æµç¨‹ã€‚å¯ä»¥çœ‹åˆ°getBeanä¼ å‚çš„æ—¶å€™ï¼ŒbeanName å‰å¢åŠ äº† &amp; æ ‡è¯†ï¼Œè¯´æ˜è¿™ä¸ªgetBean æµç¨‹éœ€è¦è·å–çš„æ˜¯userServiceProxyè¿™ä¸ªä¸ªFactoryBean ï¼Œè€Œä¸æ˜¯ç”±å®ƒåˆ›å»ºçš„å¯¹è±¡ åœ¨å®ä¾‹åŒ– FactoryBean çš„è¿‡ç¨‹ä¸­ï¼Œå¹¶ä¸éœ€è¦&amp;æ ‡è¯† ï¼Œ åœ¨getBean æ˜¯å¦ï¼Œéœ€è¦åˆ¤æ–­ æ˜¯è¿”å›FactoryBean å®ä¾‹ è¿˜æ˜¯Factorybeanåˆ›å»ºçš„å¯¹è±¡æ—¶æ‰éœ€è¦&amp;æ ‡è¯†ã€‚ 3.1.1 transformedBeanName æ–¹æ³•è¿›å…¥getBean, å¯ä»¥çœ‹åˆ°nametç»è¿‡äº†transformedBeanNameæ–¹æ³•å¤„ç†ï¼Œ åˆæŠŠ&amp; å»æ‰äº†ã€‚ 1String beanName = transformedBeanName(name); è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯å°†ä¼ å…¥çš„ name è½¬æ¢ä¸ºå®é™…çš„ Bean åç§°,åœ¨ Spring æ¡†æ¶ä¸­ï¼ŒBean åç§°å¯èƒ½åŒ…å«ä¸€äº›ç‰¹æ®Šçš„å‰ç¼€æˆ–åç¼€ï¼Œç”¨äºå¤„ç†ç‰¹æ®Šæƒ…å†µæˆ–æŒ‡ç¤ºæŸç§è¡Œä¸ºã€‚transformedBeanName æ–¹æ³•ç”¨äºè§£æå’Œå¤„ç†è¿™äº›å‰ç¼€æˆ–åç¼€ï¼Œä»¥è·å¾—å®é™…çš„ Bean åç§°ã€‚ åœ¨è¿™ä¸ªä¾‹å­ä¸­å°±æ˜¯å»æ‰å·¥å‚ Bean å‰ç¼€ &amp;ã€‚ &amp; å‰ç¼€çš„ä½œç”¨ å‘Šè¯‰ç¨‹åº ï¼Œæˆ‘æ˜¯æ¥è·å– FactoryBean æœ¬èº«ï¼Œè€Œä¸æ˜¯è·å–FactoryBean åˆ›å»ºçš„å¯¹è±¡çš„ã€‚æ‰€ä»¥ &amp; æœ¬èº«ä¸å±äºbeanåç§°çš„ä¸€éƒ¨åˆ†ï¼Œéœ€è¦ç»è¿‡transformedBeanName æ–¹æ³•ä¼šå»æ‰è¿™ä¸ªå‰ç¼€ï¼Œä»¥è·å¾—å®é™…çš„ Bean åç§°ã€‚ å¯¹äºéFactoryBean æ¥è®²ï¼Œ name å’ŒbeanName éƒ½æ˜¯ä¸€æ ·çš„ 3.1.2 getObjectForBeanInstanceFactoryBeanåªæœ‰åœ¨å®ä¾‹åŒ–åæ‰èƒ½é€šè¿‡getObject() åˆ›å»ºå…¶ä»–é…ç½®å¤æ‚çš„bean åœ¨çœ‹IOCæºç çš„æ—¶å€™ï¼Œå‘ç°å³ä½¿æˆ‘ä»¬å·²ç»åˆ›å»ºå‡ºæ¥äº†å¯¹è±¡çš„å®ä¾‹ï¼Œè¿˜æ˜¯è¦èµ°ä¸€ä¸ªæ–¹æ³•å†å»å¤„ç†ä¸‹ï¼Œè¿™é‡Œå°±æ˜¯å¯¹FactoryBeançš„å¤„ç†ï¼Œå› ä¸ºå®ƒå¯ä»¥äº§ç”Ÿå¯¹è±¡ï¼Œæ‰€ä»¥ä½ getBeançš„æ—¶å€™å–åˆ°çš„ä¸æ˜¯å®ƒæœ¬èº«ï¼Œè€Œæ˜¯é€šè¿‡å®ƒç”Ÿæˆçš„äº§å“ã€‚ã€å¦‚æœè¦å–å®ƒæœ¬èº«ï¼ŒgetBean(&amp;+beanName)ã€‘ æˆ‘ä»¬å…ˆæ¥å›å¿†ä¸‹IOCæºç ä¸­é‚£ä¸ªå¤„ç†FactoryBeançš„ç®€ç•¥ä»£ç ï¼šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯ç›´æ¥å–å•ä¾‹çš„beanï¼Œè¿˜æ˜¯åˆ›å»ºå•ä¾‹ã€å¤šä¾‹ã€è‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸçš„beanï¼Œéƒ½ä¼šç»è¿‡bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬ç°åœ¨å°±æ¥çœ‹çœ‹è¿™é‡Œåˆ°åº•æ˜¯åšäº†ä»€ä¹ˆï¼š 123456789101112131415161718192021222324252627282930313233protected Object getObjectForBeanInstance( Object beanInstance, String name, String beanName, RootBeanDefinition mbd) &#123; //å¦‚æœæ˜¯å¯¹FactoryBeançš„è§£å¼•ç”¨ï¼Œä½†beanå¯¹è±¡ä¸æ˜¯FactoryBeanï¼ŒæŠ›å‡ºå¼‚å¸¸ if (BeanFactoryUtils.isFactoryDereference(name) &amp;&amp; !(beanInstance instanceof FactoryBean)) &#123; throw new BeanIsNotAFactoryException(transformedBeanName(name), beanInstance.getClass()); &#125; //å¦‚æœBeanå®ä¾‹ä¸æ˜¯FactoryBeanï¼Œæˆ–è€…æŒ‡å®šåç§°æ˜¯FactoryBeançš„è§£å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯æ™®é€šçš„beanè°ƒç”¨ï¼Œåˆ™ç›´æ¥è¿”å›å½“å‰çš„Beanå®ä¾‹ if (!(beanInstance instanceof FactoryBean) || BeanFactoryUtils.isFactoryDereference(name)) &#123; return beanInstance; &#125; //å¤„ç†å¯¹FactoryBeançš„è°ƒç”¨ Object object = null; if (mbd == null) &#123; //ä»Beanå·¥å‚ç¼“å­˜ä¸­è·å–ç»™å®šåç§°çš„å®ä¾‹å¯¹è±¡ object = getCachedObjectForFactoryBean(beanName); &#125; if (object == null) &#123; // Return bean instance from factory. FactoryBean factory = (FactoryBean) beanInstance; //å¦‚æœä»Beanå·¥å‚ç”Ÿäº§çš„Beanæ˜¯å•æ€æ¨¡å¼çš„ï¼Œåˆ™ç¼“å­˜ if (mbd == null &amp;&amp; containsBeanDefinition(beanName)) &#123; mbd = getMergedLocalBeanDefinition(beanName); &#125; boolean synthetic = (mbd != null &amp;&amp; mbd.isSynthetic()); //è°ƒç”¨FactoryBeanRegistrySupportç±»çš„getObjectFromFactoryBeanæ–¹æ³•ï¼Œå®ç°FactoryBeanç”Ÿäº§Beanå¯¹è±¡å®ä¾‹çš„è¿‡ç¨‹ object = getObjectFromFactoryBean(factory, beanName, !synthetic); &#125; return object;\t&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576// Beanå·¥å‚ç”Ÿäº§Beanå®ä¾‹å¯¹è±¡protected Object getObjectFromFactoryBean(FactoryBean factory, String beanName, boolean shouldPostProcess) &#123;\t// Beanå·¥å‚æ˜¯å•æ€æ¨¡å¼ï¼Œå¹¶ä¸”Beanå·¥å‚ç¼“å­˜ä¸­å­˜åœ¨æŒ‡å®šåç§°çš„Beanå®ä¾‹å¯¹è±¡\tif (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123; synchronized (getSingletonMutex()) &#123; // ç›´æ¥ä»Beanå·¥å‚ç¼“å­˜ä¸­è·å–æŒ‡å®šåç§°çš„Beanå®ä¾‹å¯¹è±¡ Object object = this.factoryBeanObjectCache.get(beanName); // Beanå·¥å‚ç¼“å­˜ä¸­æ²¡æœ‰æŒ‡å®šåç§°çš„å®ä¾‹å¯¹è±¡ï¼Œåˆ™ç”Ÿäº§è¯¥å®ä¾‹å¯¹è±¡ if (object == null) &#123; // è°ƒç”¨Beanå·¥å‚çš„getObjectæ–¹æ³•ç”Ÿäº§æŒ‡å®šBeançš„å®ä¾‹å¯¹è±¡ object = doGetObjectFromFactoryBean(factory, beanName, shouldPostProcess); // å°†ç”Ÿäº§çš„å®ä¾‹å¯¹è±¡æ·»åŠ åˆ°Beanå·¥å‚ç¼“å­˜ä¸­ this.factoryBeanObjectCache.put(beanName, (object != null ? object : NULL_OBJECT)); &#125; return (object != NULL_OBJECT ? object : null); &#125;\t&#125;\t// è°ƒç”¨Beanå·¥å‚çš„getObjectæ–¹æ³•ç”Ÿäº§æŒ‡å®šBeançš„å®ä¾‹å¯¹è±¡\telse &#123; return doGetObjectFromFactoryBean(factory, beanName, shouldPostProcess);\t&#125;&#125;//è°ƒç”¨Beanå·¥å‚çš„getObjectæ–¹æ³•ç”Ÿäº§æŒ‡å®šBeançš„å®ä¾‹å¯¹è±¡ private Object doGetObjectFromFactoryBean( final FactoryBean factory, final String beanName, final boolean shouldPostProcess) throws BeanCreationException &#123; Object object; try &#123; if (System.getSecurityManager() != null) &#123; AccessControlContext acc = getAccessControlContext(); try &#123; //å®ç°PrivilegedExceptionActionæ¥å£çš„åŒ¿åå†…ç½®ç±» //æ ¹æ®JVMæ£€æŸ¥æƒé™ï¼Œç„¶åå†³å®šBeanFactoryåˆ›å»ºå®ä¾‹å¯¹è±¡ object = AccessController.doPrivileged(new PrivilegedExceptionAction&lt;Object&gt;() &#123; public Object run() throws Exception &#123; //è°ƒç”¨BeanFactoryæ¥å£å®ç°ç±»çš„åˆ›å»ºå¯¹è±¡æ–¹æ³• return factory.getObject(); &#125; &#125;, acc); &#125; catch (PrivilegedActionException pae) &#123; throw pae.getException(); &#125; &#125; else &#123; //è°ƒç”¨BeanFactoryæ¥å£å®ç°ç±»çš„åˆ›å»ºå¯¹è±¡æ–¹æ³• object = factory.getObject(); &#125; &#125; catch (FactoryBeanNotInitializedException ex) &#123; throw new BeanCurrentlyInCreationException(beanName, ex.toString()); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(beanName, &quot;FactoryBean threw exception on object creation&quot;, ex); &#125; //åˆ›å»ºå‡ºæ¥çš„å®ä¾‹å¯¹è±¡ä¸ºnullï¼Œæˆ–è€…å› ä¸ºå•æ€å¯¹è±¡æ­£åœ¨åˆ›å»ºè€Œè¿”å›null if (object == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123; throw new BeanCurrentlyInCreationException( beanName, &quot;FactoryBean which is currently in creation returned null from getObject&quot;); &#125; //ä¸ºåˆ›å»ºå‡ºæ¥çš„Beanå®ä¾‹å¯¹è±¡æ·»åŠ BeanPostProcessoråç½®å¤„ç†å™¨ if (object != null &amp;&amp; shouldPostProcess) &#123; try &#123; object = postProcessObjectFromFactoryBean(object, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(beanName, &quot;Post-processing of the FactoryBean&#x27;s object failed&quot;, ex); &#125; &#125; return object; &#125; ç»è¿‡getObjectForBeanInstance å¤„ç†ï¼Œæœ€ç»ˆè¿”å›äº†userServiceProxyè¿™ä¸ªFactoryBean æœ¬èº« 3.2 è·å–FactoryBean åˆ›å»ºçš„å¯¹è±¡FactoryBean æœ¬èº«å·²ç»å®ä¾‹åŒ–å®Œæˆäº†ï¼Œç°åœ¨å¯ä»¥è·å–ç”±å®ƒåˆ›å»ºçš„å¯¹è±¡äº†12 // è·å–ä»£ç†å¯¹è±¡UserService userService = (UserService) context.getBean(&quot;userServiceProxy&quot;); ç”±äºuserServiceProxy æ˜¯FactoryBean, ç°åœ¨æ‰§è¡ŒgetBean(&quot;beanName&quot;) è¯´æ˜æˆ‘ä»¬è¦è·å–ç”±å®ƒåˆ›å»ºçš„å¯¹è±¡äº†ã€‚ä¸‹é¢è·Ÿç€ä»£ç è¿›è¡Œç®€å•åˆ†æã€‚ 3.2.1 transformedBeanName æ–¹æ³•è¿›å…¥æºç ï¼Œå†æ¬¡æ¥åˆ°getBean æµç¨‹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œç»è¿‡transformedBeanNameå¤„ç†åï¼Œname å’ŒbeanName ä¿æŒä¸€è‡´ã€‚ 3.2.2 getObjectForBeanInstanceæ­¤æ—¶getSingleton,ä¸€çº§ç¼“å­˜ä¸­å·²ç»æœ‰äº†IOC å®¹å™¨å¯åŠ¨è¿‡ç¨‹çš„ä¸­åˆ›å»ºçš„å®ä¾‹ï¼Œ ç›´æ¥è·å–å³å¯ã€‚å†æ¬¡è¿›å…¥getObjectForBeanInstance æ–¹æ³• 3.2.3 FactoryBean.getObjectåœ¨getObjectForBeanInstance æ–¹æ³•ä¸­ï¼Œé€æ¸æ·±å…¥æœ€ç»ˆä¼šè¿›å…¥åˆ°ProxyFactoryBean é‡å†™çš„getObject æ–¹æ³•ï¼ˆgetObject æ˜¯æ¥å£FactoryBean ä¸­å®šä¹‰çš„æ–¹æ³•è¿˜è®°å¾—å—ï¼‰ åœ¨getObject æ–¹æ³•ä¸­ï¼Œå¯ä»¥è·å–userServiceProxy åˆ›å»ºçš„å¯¹è±¡ï¼Œå³ä¸€ä¸ªä»£ç†å¯¹è±¡ 4. FactoryBean çš„åº”ç”¨åœºæ™¯FactoryBean å¯ä»¥ç”¨äºå„ç§é«˜çº§åº”ç”¨åœºæ™¯ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å…¸å‹çš„ä½¿ç”¨åœºæ™¯ï¼š 4.1 åˆ›å»ºä»£ç†å¯¹è±¡FactoryBean å¸¸ç”¨äºåˆ›å»º AOP ä»£ç†å¯¹è±¡ã€‚ä¾‹å¦‚ï¼ŒSpring AOP å†…éƒ¨å¤§é‡ä½¿ç”¨ FactoryBean æ¥åˆ›å»ºä»£ç†å¯¹è±¡ã€‚ åœ¨ä¸Šé¢çš„åŠ¨æ€ä»£ç†Demoä¸­ï¼Œæˆ‘ä»¬å°±å±•ç¤ºäº†ä¸€ä¸ªé€šè¿‡FactoryBeanåˆ›å»ºä»£ç†å¯¹è±¡çš„å¤æ‚ä¾‹å­ã€‚ 4.2 åˆ›å»ºå¤æ‚çš„ Bean å®ä¾‹åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåˆ›å»ºä¸€ä¸ª Bean å¯èƒ½æ¶‰åŠå¤æ‚çš„åˆå§‹åŒ–é€»è¾‘ã€‚é€šè¿‡ FactoryBeanï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›é€»è¾‘å°è£…åœ¨ getObject æ–¹æ³•ä¸­ï¼Œä»è€Œç®€åŒ–é…ç½®ã€‚ å¾ˆå¤šå¼€æºé¡¹ç›®åœ¨é›†æˆSpring æ—¶éƒ½ä½¿ç”¨åˆ°FactoryBeanï¼Œæ¯”å¦‚ MyBatis3 æä¾› mybatis-springé¡¹ç›®ä¸­çš„ org.mybatis.spring.SqlSessionFactoryBeanï¼š123456&lt;!-- springå’ŒMyBatisæ•´åˆï¼Œä¸éœ€è¦mybatisçš„é…ç½®æ˜ å°„æ–‡ä»¶ --&gt;&lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt; &lt;!-- è‡ªåŠ¨æ‰«æmapping.xmlæ–‡ä»¶ --&gt; &lt;property name=&quot;mapperLocations&quot; value=&quot;classpath:mapper/*.xml&quot;&gt;&lt;/property&gt;&lt;/bean&gt; 123456789101112public class SqlSessionFactoryBean implements FactoryBean&lt;SqlSessionFactory&gt;, InitializingBean, ApplicationListener&lt;ApplicationEvent&gt; &#123; private static final Log LOGGER = LogFactory.getLog(SqlSessionFactoryBean.class);...public SqlSessionFactory getObject() throws Exception &#123; if (this.sqlSessionFactory == null) &#123; this.afterPropertiesSet(); &#125; return this.sqlSessionFactory; &#125;...&#125;","tags":["java","Spring"]},{"title":"Spring å¯åŠ¨è¿‡ç¨‹ æ‹“å±•ç‚¹","path":"/114991e5/","content":"Springæ¡†æ¶æä¾›äº†ä¸°å¯Œçš„æ‰©å±•ç‚¹ï¼Œå…è®¸å¼€å‘è€…åœ¨beançš„ç”Ÿå‘½å‘¨æœŸçš„ä¸åŒé˜¶æ®µæ’å…¥è‡ªå®šä¹‰é€»è¾‘ï¼Œä»è€Œå¢å¼ºåº”ç”¨çš„åŠŸèƒ½å’Œçµæ´»æ€§ã€‚æ‹“å±•ç‚¹åŒ…æ‹¬BeanFactoryPostProcessorã€BeanPostProcessorã€å„ç§Awareç­‰ã€‚ä¸‹é¢æ¥å…·ä½“è®²è§£å„ä¸ªæ‹“å±•ç‚¹çš„ä½œç”¨ä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•ä»‹å…¥åˆ°bean çš„ç”Ÿå‘½å‘¨æœŸä¸­ã€‚ é™¤äº†Awareæ¥å£å’ŒBeanPostProcessorï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–æ‰©å±•ç‚¹ï¼Œå¦‚BeanFactoryPostProcessorã€ApplicationListenerã€InitializingBeanã€FactoryBeanç­‰ã€‚è¿™äº›æ‰©å±•ç‚¹çš„åˆç†ä½¿ç”¨å¯ä»¥æå¤§åœ°æé«˜Springåº”ç”¨çš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ 1.BeanFactoryPostProcessorBeanFactoryPostProcessor æ˜¯ Spring æ¡†æ¶ä¸­çš„ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œå®ƒåœ¨bean å¼€å§‹æ•´ä¸ªåˆ›å»ºæµç¨‹ä¹‹å‰ èµ·ä½œç”¨ã€‚ é€šè¿‡å®ç°è¯¥æ¥å£å¯ä»¥åœ¨ Bean å¼€å§‹æ•´ä¸ªåˆ›å»ºæµç¨‹ä¹‹å‰è¯»å– BeanFactory ä¸­çš„ BeanDefinition å¹¶è¿›è¡Œä¿®æ”¹ï¼Œæ¯”å¦‚è°ƒæ•´ Bean çš„å±æ€§ã€ä¾èµ–å…³ç³»ç­‰å®šä¹‰ã€‚ Spring è‡ªå¸¦äº†ä¸€äº› BeanFactoryPostProcessor çš„å®ç°ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦è‡ªå®šä¹‰å®ç°ä»¥é€‚åº”ç‰¹å®šåœºæ™¯ï¼Œä»è€Œå®ç°æ›´çµæ´»çš„åº”ç”¨é…ç½®ã€‚ 12345@FunctionalInterface public interface BeanFactoryPostProcessor &#123; void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException; &#125; 1.1 æ³¨å†Œæ—¶æœº and ä½œç”¨è¿‡ç¨‹-invokeBeanFactoryPostProcessorså‰é¢è¯´åˆ°BeanFactoryPostProcessor æ˜¯ Spring æ¡†æ¶åœ¨bean å¼€å§‹æ•´ä¸ªåˆ›å»ºæµç¨‹ä¹‹å‰ èµ·ä½œç”¨ã€‚å…·ä½“çš„ä½ç½®å¦‚ä¸‹,ä½äºrefresh ä¸­çš„invokeBeanFactoryPostProcessors æ–¹æ³•ä¸­ï¼Œ é€šè¿‡invoke è¿™ä¸ªå‘½åå°±å¯ä»¥çŸ¥é“è¿™é‡Œéœ€è¦è°ƒç”¨æ‰€æœ‰BeanFactoryPostProcessor çš„å…·ä½“å®ç°é€»è¾‘å¯¹bean å®šä¹‰è¿›è¡Œä¿®æ”¹ 12345678910111213141516AbstractApplicationContext.java@Override public void refresh() throws BeansException, IllegalStateException &#123;\t// 1. åˆ›å»ºbeanFactory ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();\t// 2.BeanFactoryPostProcessorèµ·ä½œç”¨\tinvokeBeanFactoryPostProcessors(beanFactory); // 3.æ³¨å†Œ BeanPostProcessor\tregisterBeanPostProcessors(beanFactory); // 4. beançš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œä¾èµ–å…³ç³»çš„è£…é…\tfinishBeanFactoryInitialization(beanFactory);&#125; æ‰§è¡ŒBeanFactoryPostProcessoré€»è¾‘å‰ï¼Œ éœ€è¦æœ‰BeanFactoryPostProcessorçš„å®ä¾‹ï¼Œé‚£ä¹ˆBeanFactoryPostProcessoræ˜¯å¦‚ä½•å®ä¾‹åŒ–çš„å‘¢, ä¸‹é¢æ¥çœ‹ä¸‹ BeanFactoryPostProcessor çš„å®ä¾‹åŒ–å’Œå…·ä½“èµ·ä½œç”¨çš„è¿‡ç¨‹ å…ˆè¿›å…¥123AbstractApplicationContext.javaprotected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) &#123; PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors()); &#125; å†è¿›å…¥PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessorsçš„æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶ä¼ è¿›æ¥äº†3ä¸ªBeanFactoryPostProcessorï¼Œè¿™3ä¸ªBeanFactoryPostProcessor æ˜¯åœ¨åº”ç”¨ä¸Šä¸‹æ–‡ApplicationContext é‡Œé¢å­˜å‚¨ç»´æŠ¤çš„ï¼Œä½†æ˜¯æ­¤æ—¶è¿˜æ²¡æœ‰çœ‹åˆ°è‡ªå®šä¹‰çš„ æ¥çœ‹ä¸€ä¸‹PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors çš„å…·ä½“å¤„ç†é€»è¾‘.BeanFactoryPostProcessorså°†bean åˆ†æˆäº†å¥½å‡ ç±»åˆ†åˆ«è¿›è¡Œå¤„ç†ï¼Œ 1.2 BeanDefinitionRegistryPostProcessor12345public interface BeanDefinitionRegistryPostProcessor extends BeanFactoryPostProcessor &#123; void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException; &#125; BeanDefinitionRegistryPostProcessor ç»§æ‰¿äº†BeanFactoryPostProcessor ï¼Œ å¹¶å¢åŠ äº†ä¸€ä¸ªæ–¹æ³•ï¼Œ åœ¨æ‰§è¡ŒBeanFactoryPostProcessor å‰ï¼Œéœ€è¦æ‰¾å‡ºæ‰€æœ‰çš„BeanDefinitionRegistryPostProcessor, å¹¶ä¸”å…ˆæ‰§è¡Œè‡ªå·±çš„postProcessBeanDefinitionRegistryæ–¹æ³•ï¼Œå†æ‰§è¡Œç»§æ‰¿æ¥çš„postProcessBeanFactory æ–¹æ³•ã€‚çœ‹ä»¥ä¸‹é‡ç‚¹ä»£ç ,BeanDefinitionRegistryPostProcessoråŒ…æ‹¬å‚æ•°ä¸­ä¼ è¿›æ¥æ¥çš„å’Œä»beanFactory ä¸­æ‰¾åˆ°çš„ï¼Œ å…¶ä¸­ä»beanFactoryæ‰¾åˆ°çš„BeanDefinitionRegistryPostProcessorï¼Œè¿˜æ²¡æœ‰è¿›è¡Œå®ä¾‹åŒ–ï¼Œéœ€è¦å®ä¾‹åŒ–åæ‰èƒ½ä½¿ç”¨ï¼Œè¿™ä¸ªå®ä¾‹åŒ–çš„è¿‡ç¨‹å’Œä¸šåŠ¡bean çš„å®åŠ›åŒ–è¿‡ç¨‹æ˜¯åŒä¸€ä¸ª 123456789101112131415161718192021222324if (beanFactory instanceof BeanDefinitionRegistry) &#123; BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory; List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = new ArrayList&lt;&gt;(); List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = new ArrayList&lt;&gt;(); // ä»ä¼ å‚ä¸­æ‰¾åˆ° BeanDefinitionRegistryPostProcessor for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123; if (postProcessor instanceof BeanDefinitionRegistryPostProcessor) &#123; BeanDefinitionRegistryPostProcessor registryProcessor = (BeanDefinitionRegistryPostProcessor) postProcessor; registryProcessor.postProcessBeanDefinitionRegistry(registry); registryProcessors.add(registryProcessor); &#125;\t// ä»beanFactory ä¸­æ‰¾åˆ°BeanDefinitionRegistryPostProcessorå¹¶è¿›è¡Œå®ä¾‹åŒ–\tpostProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);\tfor (String ppName : postProcessorNames) &#123; if (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); &#125; &#125;\t//å…ˆæ‰§è¡ŒBeanDefinitionRegistryPostProcessorçš„postProcessBeanDefinitionRegistryæ–¹æ³•\tinvokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);\t//å†æ‰§è¡ŒBeanFactoryPostProcessorçš„postProcessBeanFactoryæ–¹æ³•\tinvokeBeanFactoryPostProcessors(registryProcessors, beanFactory); &#125; 1.3 æ‰§è¡Œé¡ºåº- Orderedåœ¨invoke å®ŒBeanDefinitionRegistryPostProcessoråï¼Œå°±å¼€å§‹æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºå¤„ç†BeanFactoryPostProcessorã€‚ Springæä¾›äº†ä¸€äº›æœºåˆ¶æ¥ç®¡ç†å¤šä¸ªBeanFactoryPostProcessorçš„æ‰§è¡Œé¡ºåºï¼Œå…¶æ‰§è¡Œé¡ºåºåˆ†åˆ«æ˜¯ PriorityOrdered æ¥å£ ä¼˜å…ˆçº§æ¥å£ Ordered NonOrdered 1.3.1 ä¼˜å…ˆçº§æ¥å£ OrderedSpringå…è®¸BeanFactoryPostProcessorå®ç°Orderedæ¥å£æ¥æŒ‡å®šæ‰§è¡Œé¡ºåºã€‚Orderedæ¥å£è¦æ±‚å®ç°ä¸€ä¸ªæ–¹æ³•getOrder()ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªæ•´æ•°ï¼Œå®šä¹‰äº†BeanFactoryPostProcessorçš„æ‰§è¡Œé¡ºåºã€‚æ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šä¼˜å…ˆæ‰§è¡Œ ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªBeanFactoryPostProcessorå®ç°ï¼Œå®ƒä½¿ç”¨äº†Orderedæ¥å£æ¥æŒ‡å®šå…¶æ‰§è¡Œé¡ºåºï¼š 123456789101112131415161718 @Component public class CustomBeanFactoryPostProcessor implements BeanFactoryPostProcessor, Ordered &#123; @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123; // è·å–åä¸º &quot;myBean&quot; çš„ BeanDefinitionBeanDefinition beanDefinition = beanFactory.getBeanDefinition(&quot;myBean&quot;); // ä¿®æ”¹ &quot;myBean&quot; çš„å±æ€§å€¼ beanDefinition.getPropertyValues().add(&quot;name&quot;, &quot;Modified by BeanFactoryPostProcessor&quot;); &#125; @Override public int getOrder() &#123; return 10; // æ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ &#125; &#125; 1.3.2 PriorityOrdered æ¥å£PriorityOrderedæ˜¯Orderedæ¥å£çš„ä¸€ä¸ªå­æ¥å£ï¼Œå…è®¸BeanFactoryPostProcessoråœ¨å…¶ä»–æ™®é€šOrderedæ‰§è¡Œã€‚è¿™ä¸»è¦ç”¨äºé‚£äº›å¿…é¡»é¦–å…ˆåº”ç”¨çš„å¤„ç†å™¨ï¼Œæ¯”å¦‚é‚£äº›æ¶‰åŠé…ç½®å¦‚ä½•åŠ è½½çš„å¤„ç†å™¨ã€‚12345678910111213public class CustomPriorityOrderedBeanFactoryPostProcessor implements BeanFactoryPostProcessor, PriorityOrdered &#123; @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123; // å®šåˆ¶å¤„ç†é€»è¾‘ System.out.println(&quot;Executing CustomPriorityOrderedBeanFactoryPostProcessor&quot;); &#125; @Override public int getOrder() &#123; return 5; // æ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ &#125; &#125; 1.3.3 NonOrderedNonOrderedå¹¶ä¸æ˜¯ä¸€ä¸ªæ¥å£ï¼ŒæŒ‡çš„æ˜¯æ²¡æœ‰å®ç°Ordered æˆ–è€… PriorityOrdered çš„ BeanFactoryPostProcessorï¼Œ å®ƒä¼šæ”¾åœ¨æœ€åæ‰§è¡Œã€‚ æ‰€ä»¥ï¼Œç»¼ä¸Šï¼Œåœ¨Springå®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼ŒBeanFactoryPostProcessorçš„è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼š é¦–å…ˆï¼Œå®ç°PriorityOrderedçš„BeanFactoryPostProcessoræŒ‰ç…§å®ƒä»¬çš„é¡ºåºå€¼è¢«è°ƒç”¨ã€‚ å…¶æ¬¡ï¼Œå®ç°Orderedæ¥å£çš„æ™®é€šBeanFactoryPostProcessoræŒ‰ç…§å®ƒä»¬çš„é¡ºåºå€¼è¢«è°ƒç”¨ã€‚ æœ€åï¼Œæœªå®ç°ä»»ä½•æ’åºæ¥å£çš„BeanFactoryPostProcessoræŒ‰ç…§å®ƒä»¬çš„æ³¨å†Œé¡ºåºè¢«è°ƒç”¨ã€‚ 1.3.4 å¤„ç†é€»è¾‘åœ¨invoke å®ŒBeanDefinitionRegistryPostProcessoråï¼Œå°±å¼€å§‹æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºå¤„ç†BeanFactoryPostProcessorã€‚ ä»£ç é€»è¾‘ä¼šå…ˆæ‰¾å‡ºæ‰€æœ‰çš„BeanFactoryPostProcessorï¼Œ ç„¶åå°†å…¶åˆ†ç±»ä¸ºPriorityOrderedBeanFactoryPostProcessorã€OrderedBeanFactoryPostProcessorã€NonOrderedBeanFactoryPostProcessor, å¹¶æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºåˆ†åˆ«invoke postProcessBeanFactory æ–¹æ³• 123456789101112131415161718192021222324252627public static void invokeBeanFactoryPostProcessors( ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors) &#123;\t// æ‰¾å‡ºæ‰€æœ‰çš„ BeanFactoryPostProcessor\tString[] postProcessorNames = beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false);\t// åˆ†ç±»\tfor (String ppName : postProcessorNames) &#123; // processedBeansä¿å­˜å·²å¤„ç†çš„BeanFactoryPostProcessor åç§° if (processedBeans.contains(ppName)) &#123; // skip - already processed in first phase above &#125; else if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class)); &#125; else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; // orderedPostProcessor åœ¨åé¢ä¹Ÿä¼šé€šè¿‡getBeanå®ä¾‹åŒ–ï¼Œé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œæˆ‘çœç•¥äº†ï¼ŒnonOrderedPostProcessoråŒç† orderedPostProcessorNames.add(ppName); &#125; else &#123; nonOrderedPostProcessorNames.add(ppName); &#125; &#125; // åˆ†åˆ«invoke postProcessBeanFactoryæ–¹æ³•\tinvokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);\tinvokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);\tinvokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);&#125; 1.4 BeanFactoryPostProcessorä¹Ÿæ˜¯beanæ— è®ºæ˜¯ BeanDefinitionRegistryPostProcessor,è¿˜æ˜¯BeanFactoryPostProcessor, åœ¨é€šè¿‡getBeanNamesForTypeè·å–åç§°åï¼Œinvoke postProcessBeanFactory æ–¹æ³•ä¹‹å‰ï¼Œéœ€è¦å…ˆè¿›è¡Œå®ä¾‹åŒ–æ“ä½œï¼ˆéƒ½è¦è°ƒç”¨æ–¹æ³•äº†ï¼Œè‚¯å®šè¦æœ‰å¯¹è±¡å­˜åœ¨å•Šï¼‰ã€‚ BeanFactoryPostProcessor çš„å®ä¾‹åŒ–è¿‡ç¨‹å’Œä¸šåŠ¡bean çš„å®ä¾‹åŒ–è¿‡ç¨‹ å®Œå…¨ç›¸åŒï¼Œéƒ½æ˜¯getBeanæµç¨‹å®Œæˆå®ä¾‹åŒ–æ“ä½œã€‚ 12345678910111213141516// å®ä¾‹åŒ– BeanDefinitionRegistryPostProcessorpostProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); // å®ä¾‹åŒ– BeanFactoryPostProcessorString[] postProcessorNames = beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false);priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class)); 2.BeanPostProcessorBeanPostProcessoræ˜¯Springæ¡†æ¶ä¸­ä¸€ä¸ªéå¸¸å¼ºå¤§çš„æ‰©å±•ç‚¹ï¼Œæä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œç”¨äºåœ¨beançš„initæ“ä½œå‰åæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ã€‚Spring AOPå°±æ˜¯é€šè¿‡BeanPostProcessorå®ç°çš„ BeanPostProcessorä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼ŒåŒ…å«2ä¸ªæ–¹æ³• postProcessBeforeInitialization: åœ¨bean initä¹‹å‰æ‰§è¡Œã€‚ postProcessAfterInitialization: åœ¨bean init ä¹‹åæ‰§è¡Œã€‚ 12345public interface BeanPostProcessor &#123; Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException; Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException;&#125; 2.1 æ³¨å†Œæ—¶æœº-registerBeanPostProcessorsä¾ç„¶å›åˆ°refreshæ–¹æ³•ä¸­ ï¼Œå…¶ä¸­registerBeanPostProcessors æ–¹æ³•æ¶‰åŠåˆ°BeanPostProcessorçš„æ³¨å†Œæµç¨‹ã€‚ 12345678910111213141516AbstractApplicationContext.java@Override public void refresh() throws BeansException, IllegalStateException &#123;\t// 1. åˆ›å»ºbeanFactory ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();\t// 2.BeanFactoryPostProcessorèµ·ä½œç”¨\tinvokeBeanFactoryPostProcessors(beanFactory); // 3.æ³¨å†Œ BeanPostProcessor\tregisterBeanPostProcessors(beanFactory); // 4. beançš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œä¾èµ–å…³ç³»çš„è£…é…\tfinishBeanFactoryInitialization(beanFactory);&#125; è¿›å…¥registerBeanPostProcessorsåˆ†æå…·ä½“ä»£ç  123456789101112131415161718192021222324252627282930PostProcessorRegistrationDelegate.javapublic static void registerBeanPostProcessors( ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) &#123;\t// æ‰¾å‡ºæ‰€æœ‰ BeanPostProcessor åç§°\tString[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false);\t//æŒ‰ç…§ä¼˜å…ˆçº§åˆ« å¯¹BeanPostProcessor åç§° List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;&gt;(); List&lt;BeanPostProcessor&gt; internalPostProcessors = new ArrayList&lt;&gt;(); List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;&gt;(); List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;&gt;(); for (String ppName : postProcessorNames) &#123; if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); priorityOrderedPostProcessors.add(pp); &#125; else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; // orderedPostProcessor åœ¨åé¢ä¹Ÿä¼šé€šè¿‡getBean å®ä¾‹åŒ–ï¼Œé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œæˆ‘çœç•¥äº†ï¼ŒnonOrderedPostProcessoråŒç† orderedPostProcessorNames.add(ppName); &#125; else &#123; nonOrderedPostProcessorNames.add(ppName); &#125; &#125;\tregisterBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);\tregisterBeanPostProcessors(beanFactory, orderedPostProcessors);\tregisterBeanPostProcessors(beanFactory, internalPostProcessors);&#125; å¯ä»¥çœ‹åˆ°registerBeanPostProcessors çš„æ•´ç†æµç¨‹æ¯”è¾ƒç±»ä¼¼ï¼Œéƒ½æ˜¯ ç”¨beanFactory.getBeanNamesForTypeæ‰¾å‡ºæ‰€æœ‰åå­— åˆ†ç±» getBean å®ä¾‹åŒ– ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„åŒºåˆ«æ˜¯ BeanFactoryPostProcessoråœ¨å®ä¾‹åŒ–åä¼šç›´æ¥è°ƒç”¨æ¥å£postProcessBeanFactoryæ‰§è¡Œé€»è¾‘ï¼Œä½†æ˜¯BeanPostProcessor çš„å®ä¾‹åªä¼šå…ˆæ·»åŠ åˆ°beanFactory ä¸­ï¼Œç­‰åˆ°ä¸šåŠ¡beançš„init é˜¶æ®µæ‰ä¼šæ‰§è¡Œé€»è¾‘ã€‚ ç”±æ­¤å¯è§ æ³¨å†ŒBeanFactoryPostProcessor ç”¨åˆ°çš„æ˜¯invokeBeanFactoryPostProcessorsï¼ŒBeanPostProcessor åªæ˜¯registerBeanPostProcessorsï¼Œ è¿™é‡Œçš„æ–¹æ³•å‘½åè¿˜æ˜¯ç›¸å½“å‡†ç¡®çš„ 2.2 æ‰§è¡Œé¡ºåº-Orderedä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ° Spring ç®¡ç†å¤šä¸ªBeanPostProcessorçš„æ‰§è¡Œé¡ºåºï¼Œå…¶å®ç°å’ŒBeanFactoryPostProcessor å®Œå…¨ä¸€è‡´ï¼Œ PriorityOrdered æ¥å£ ä¼˜å…ˆçº§æ¥å£ Ordered NonOrdered è¿™é‡Œç»™å‡ºä¸€äº›å®é™…ä»£ç ç¤ºä¾‹å°±ä¸å†èµ˜è¿°äº†ã€‚123456789101112131415161718192021222324252627282930313233343536373839404142public class MyBeanPostProcessor implements BeanPostProcessor, Ordered &#123; @Override public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123; // è‡ªå®šä¹‰é€»è¾‘ return bean; &#125; @Override public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123; // è‡ªå®šä¹‰é€»è¾‘ return bean; &#125; @Override public int getOrder() &#123; return 10; // è¿”å›ä¸€ä¸ªæ•°å€¼æ¥æŒ‡å®šæ‰§è¡Œé¡ºåº &#125;&#125;public class PriorityLoggingBeanPostProcessor implements BeanPostProcessor, PriorityOrdered &#123; @Override public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123; // åœ¨beanåˆå§‹åŒ–ä¹‹å‰æ‰“å°æ—¥å¿— System.out.println(&quot;Before Initializing Bean &#x27;&quot; + beanName + &quot;&#x27;: &quot; + bean.getClass().getSimpleName()); return bean; &#125; @Override public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123; // åˆå§‹åŒ–åçš„å¤„ç†å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ï¼Œæ­¤ç¤ºä¾‹ä»…åœ¨åˆå§‹åŒ–å‰æ‰“å° return bean; &#125; @Override public int getOrder() &#123; // è¿”å›å€¼è¾ƒä½è¡¨ç¤ºä¼˜å…ˆçº§è¾ƒé«˜ï¼Œæ­¤å¤„è¿”å›æœ€é«˜ä¼˜å…ˆçº§ return PriorityOrdered.HIGHEST_PRECEDENCE; &#125;&#125; 2.3 BeanPostProcessorä¹Ÿæ˜¯beané€šè¿‡registerBeanPostProcessors ä»£ç å¯çŸ¥ï¼Œ BeanPostProcessorå’ŒBean FactoryPostProcessor ä¸€æ ·, é€šè¿‡getbean è¿›è¡Œå®ä¾‹åŒ–çš„1BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); å¹¶åœ¨å®ä¾‹åŒ–åæ·»åŠ åˆ°beanFactory ä¸­è¿›è¡Œç®¡ç†12345678PostProcessorRegistrationDelegate.javaprivate static void registerBeanPostProcessors( ConfigurableListableBeanFactory beanFactory, List&lt;BeanPostProcessor&gt; postProcessors) &#123; for (BeanPostProcessor postProcessor : postProcessors) &#123; beanFactory.addBeanPostProcessor(postProcessor); &#125; &#125; 2.4 Spring å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šç”¨åˆ°çš„ BeanPostProcessor2.4.1 InstantiationAwareBeanPostProcessor å›¾ä¸­ç½®ç°çš„2ä¸ªæ–¹æ³•ï¼Œæ˜¯ç»§æ‰¿è‡ªBeanPostProcessorçš„2ä¸ªæ–¹æ³• InstantiationAwareBeanPostProcessorè‡ªæœ‰çš„3ä¸ªæ–¹æ³•ä¸­æœ‰2ä¸ªæ–¹æ³•åç§°å’ŒBeanPostProcessorä¸­æ–¹å¼åç§°ç›¸åŒï¼Œä½†æ˜¯å…¥å‚å’Œè¿”å›å€¼ç•¥æœ‰ä¸åŒ postProcessBeforeInstantiation1234@Nullable default Object postProcessBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName) throws BeansException &#123; return null; &#125; åœ¨bean çš„å®ä¾‹åŒ–ä¹‹å‰ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå…¶é€»è¾‘å­˜åœ¨äºä¸‹é¢ä»£ç ä¸­resolveBeforeInstantiationæ–¹æ³•ä¸­ã€‚ è¿™ä¸ªæ–¹æ³•å¯ä»¥è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œæ¥æ›¿ä»£ Bean çš„é»˜è®¤å®ä¾‹åŒ–è¿‡ç¨‹ã€‚ä½†é€šå¸¸æƒ…å†µä¸‹ï¼Œä»£ç†å¯¹è±¡æ˜¯åœ¨ Bean å®ä¾‹åŒ–ä¹‹ååˆ›å»ºçš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¸€èˆ¬è¿”å› nullã€‚ 1234567891011@Override protected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException &#123;\tObject bean = resolveBeforeInstantiation(beanName, mbdToUse); if (bean != null) &#123; return bean; &#125;\tObject beanInstance = doCreateBean(beanName, mbdToUse, args);&#125; postProcessAfterInstantiationåœ¨ bean createä¹‹åï¼Œpopulateä¹‹å‰è°ƒç”¨ã€‚è¿”å› true è¡¨ç¤ºå…è®¸å±æ€§æ³¨å…¥ï¼Œè¿”å› false åˆ™è·³è¿‡å±æ€§æ³¨å…¥ã€‚ 123default boolean postProcessAfterInstantiation(Object bean, String beanName) throws BeansException &#123; return true; &#125; postProcessPropertiesåœ¨populate å±æ€§æ³¨å…¥è¿‡ç¨‹ä¸­è°ƒç”¨ï¼Œå¯ä»¥å¯¹å±æ€§å€¼è¿›è¡Œæ£€æŸ¥æˆ–ä¿®æ”¹ã€‚12345@Nullable default PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName) throws BeansException &#123; return null; &#125; 2.4.2 SmartInstantiationAwareBeanPostProcessorSmartInstantiationAwareBeanPostProcessor æ˜¯ Spring æ¡†æ¶ä¸­çš„ä¸€ä¸ªæ¥å£ï¼Œå®ƒæ‰©å±•äº† InstantiationAwareBeanPostProcessor æ¥å£ï¼Œæä¾›äº†æ›´ç»†ç²’åº¦çš„æ§åˆ¶å’Œé¢å¤–çš„é’©å­æ–¹æ³•æ¥ä»‹å…¥ Spring Bean çš„å®ä¾‹åŒ–è¿‡ç¨‹ã€‚è¿™ä¸ªæ¥å£ä¸»è¦ç”¨äºåœ¨ Bean createä¹‹å‰ã€createä¹‹åã€populateä¹‹å‰ã€populateä¹‹åç­‰å¤šä¸ªé˜¶æ®µæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ï¼Œä»è€Œå®ç°æ›´åŠ å¤æ‚å’Œçµæ´»çš„ Bean åˆå§‹åŒ–æ§åˆ¶ã€‚ predictBeanTypeåœ¨å®é™…åˆ›å»º Bean å®ä¾‹ä¹‹å‰é¢„æµ‹å…¶ç±»å‹ã€‚è¿™å¯¹äºæå‰æ£€æµ‹æŸäº›ç±»å‹ç›¸å…³çš„å…ƒæ•°æ®å¾ˆæœ‰ç”¨ã€‚123default Class&lt;?&gt; predictBeanType(Class&lt;?&gt; beanClass, String beanName) throws BeansException &#123; return null; &#125; determineCandidateConstructorsç¡®å®šè¦ç”¨äºåˆ›å»º Bean å®ä¾‹çš„å€™é€‰æ„é€ å‡½æ•°ã€‚å…è®¸è‡ªå®šä¹‰é€‰æ‹©ç”¨äºå®ä¾‹åŒ– Bean çš„æ„é€ å‡½æ•°ã€‚ 12345default Constructor&lt;?&gt;[] determineCandidateConstructors(Class&lt;?&gt; beanClass, String beanName) throws BeansException &#123; return null; &#125; getEarlyBeanReferenceå…è®¸åœ¨ Bean å®ä¾‹åŒ–ä¹‹å‰æå‰æš´éœ² Bean çš„å¼•ç”¨ã€‚é€šå¸¸ç”¨äºè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ 123default Object getEarlyBeanReference(Object bean, String beanName) throws BeansException &#123; return bean; &#125; 2.5 BeanFactoryPostProcessor vs BeanPostProcessorBeanFactoryPostProcessorå’ŒBeanPostProcessoråç§°ç›¸ä¼¼ï¼Œä½†æ˜¯ä½œç”¨å¤§ä¸ç›¸åŒï¼Œä¸‹é¢ç»™å‡ºä¸€äº›å¯¹æ¯” ä¸ºäº†æ›´æ¸…æ¥šåœ°æ¯”è¾ƒ BeanFactoryPostProcessor å’Œ BeanPostProcessorï¼Œä¸‹è¡¨æ€»ç»“äº†å®ƒä»¬çš„å…³é”®å·®å¼‚ï¼š ç‰¹å¾ BeanFactoryPostProcessor BeanPostProcessor ç›®çš„ ä¿®æ”¹æˆ–è°ƒæ•´ bean çš„é…ç½®å…ƒæ•°æ® åœ¨ bean åˆå§‹åŒ–å‰åå¯¹å®ä¾‹è¿›è¡Œä¿®æ”¹æˆ–å¢å¼º ä½œç”¨å¯¹è±¡ æ“ä½œ BeanDefinitionï¼ˆbean çš„å®šä¹‰ï¼‰ ç›´æ¥æ“ä½œ bean å®ä¾‹ æ‰§è¡Œæ—¶æœº åœ¨æ‰€æœ‰ bean å®ä¾‹åŒ–å‰ï¼Œå®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼ŒåŠ è½½å®Œæ‰€æœ‰ bean å®šä¹‰ä¹‹åæ‰§è¡Œ å¯¹æ¯ä¸ª beanï¼Œåˆ†åˆ«åœ¨åˆå§‹åŒ–Initializationæ–¹æ³•ä¹‹å‰å’Œä¹‹åæ‰§è¡Œ æ–¹æ³•æ¥å£ postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) postProcessBeforeInitialization(Object bean, String beanName) postProcessAfterInitialization(Object bean, String beanName) å½±å“èŒƒå›´ å¯ä»¥ä¿®æ”¹æ•´ä¸ªå®¹å™¨ä¸­çš„æ‰€æœ‰ bean å®šä¹‰ å¯¹æ¯ä¸ª bean å®ä¾‹çš„ä¿®æ”¹æ˜¯ç‹¬ç«‹çš„ åº”ç”¨ç¤ºä¾‹ ä¿®æ”¹ bean çš„ä½œç”¨åŸŸã€è§£æé…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦ç­‰ åˆ›å»ºä»£ç†å¯¹è±¡ä»¥å®ç° AOPï¼Œæ‰§è¡Œè‡ªå®šä¹‰åˆå§‹åŒ–æˆ–æ¸…ç†ä»£ç ç­‰ æ‰§è¡Œé¡ºåºæ§åˆ¶æ¥å£ é€šå¸¸å¯ä»¥é€šè¿‡å®ç° Ordered æˆ– PriorityOrdered æ¥å£æ¥æ§åˆ¶æ‰§è¡Œé¡ºåº åŒæ ·å¯ä»¥å®ç° Ordered æˆ– PriorityOrdered æ¥æ§åˆ¶æ‰§è¡Œé¡ºåº 3. æ— æ‰€ä¸çŸ¥çš„AwareSpringæ¡†æ¶ä¸­ï¼ŒAwareæ¥å£çš„ä½œç”¨æ˜¯è®©beanèƒ½å¤Ÿæ‹¿åˆ°å¯¹Springå®¹å™¨ä¸­çš„å„ç§èµ„æºï¼Œä»è€Œå¢å¼ºbeançš„åŠŸèƒ½å’Œçµæ´»æ€§ã€‚ ä¸åŒçš„ Aware åŸºæœ¬éƒ½èƒ½å¤Ÿè§åçŸ¥æ„ï¼ŒAwareä¹‹å‰çš„åå­—å°±æ˜¯å¯ä»¥æ‹¿åˆ°ä»€ä¹ˆèµ„æºï¼Œä¾‹å¦‚BeanNameAwareå¯ä»¥æ‹¿åˆ°BeanNameï¼Œä»¥æ­¤ç±»æ¨ã€‚è°ƒç”¨æ—¶æœºéœ€è¦æ³¨æ„ï¼šæ‰€æœ‰çš„Awareæ–¹æ³•éƒ½æ˜¯åœ¨inité˜¶æ®µä¹‹å‰è°ƒç”¨çš„ 3.1 Awareè°ƒç”¨æ—¶æœºåœ¨Spring å¯åŠ¨è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°Aware ,éƒ½æ˜¯åœ¨populateåï¼Œinit ä¹‹å‰è°ƒç”¨çš„ã€‚ å…¶è°ƒç”¨ä»£ç å¦‚ä¸‹ï¼Œ 12345678910protected Object initializeBean(String beanName, Object bean, @Nullable RootBeanDefinition mbd) &#123; // è°ƒç”¨ bean ç›¸å…³çš„ Aware\tinvokeAwareMethods(beanName, bean); // è°ƒç”¨ ApplicationContext çš„ç›¸å…³ Aware\tapplyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); invokeInitMethods(beanName, wrappedBean, mbd); applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); &#125; åœ¨Spring ä¸­ä¸€äº›ä¼šç”¨åˆ°Aware åˆ—ä¸¾å¦‚ä¸‹ï¼Œ è¿™ä¹Ÿæ˜¯åœ¨å®é™…è¿è¡Œä¸­å®ƒä»¬ä¼šè¢«è°ƒç”¨çš„é¡ºåº BeanNameAware: æœ€å…ˆè¢«è°ƒç”¨ï¼Œç”¨äºè®¾ç½®beançš„åç§°ã€‚ BeanClassLoaderAware: åœ¨beanå®ä¾‹åŒ–åï¼Œç”¨äºè®¾ç½®beançš„ç±»åŠ è½½å™¨ã€‚ BeanFactoryAware: åœ¨bean populate å®Œæˆåï¼Œç”¨äºè®¾ç½®beançš„BeanFactoryã€‚ EnvironmentAware: åœ¨beançš„populate å®Œæˆåï¼Œç”¨äºè®¾ç½®beançš„ç¯å¢ƒä¿¡æ¯ã€‚ EmbeddedValueResolverAware: åœ¨beançš„populate å®Œæˆåï¼Œç”¨äºè®¾ç½®Spring ELè§£æå™¨ã€‚ ApplicationContextAware: æœ€åè¢«è°ƒç”¨ï¼Œç”¨äºè®¾ç½®beançš„ApplicationContextã€‚ ä¸‹é¢å°†åˆ†ç»„è¿›è¡Œè§£é‡Š 3.2 Aware Group 1- Bean ç›¸å…³Awareåœ¨invokeAwareMethodsæ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ä»¥ä¸‹3ä¸ªAware BeanNameAware: ç”¨äºè®©beanè·å–å…¶åœ¨å®¹å™¨ä¸­çš„åç§°ã€‚åœ¨å®ä¾‹åŒ–ä¹‹åï¼Œè®¾ç½®ä¾èµ–ä¹‹å‰è¢«è°ƒç”¨ã€‚ BeanClassLoaderAware: ç”¨äºè®©beanè·å–ç±»åŠ è½½å™¨ã€‚è¿™é€šå¸¸åœ¨beanå®ä¾‹åŒ–ä¹‹åå’Œä¾èµ–æ³¨å…¥ä¹‹å‰è¢«è°ƒç”¨ã€‚ BeanFactoryAware: ç”¨äºè®©beanè·å–å®ƒæ‰€åœ¨çš„BeanFactoryå®ä¾‹ã€‚åœ¨ä¾èµ–æ³¨å…¥ä¹‹åï¼Œbeanåˆå§‹åŒ–ä¹‹å‰è¢«è°ƒç”¨ã€‚ ç‚¹å‡»æŸ¥çœ‹invokeAwareMethodsï¼Œ å…¶é€»è¾‘æ¶‰åŠåˆ°3ä¸ªAware æ¥å£ 1.BeanFactoryAware123public interface BeanFactoryAware &#123; void setBeanFactory(BeanFactory beanFactory) throws BeansException;&#125; ä½œç”¨ï¼šå…è®¸beanè·å–BeanFactoryå®ä¾‹ï¼Œä»è€Œèƒ½å¤Ÿè®¿é—®Springå®¹å™¨ä¸­çš„å…¶ä»–beanã€‚ ä½¿ç”¨åœºæ™¯ï¼šåœ¨éœ€è¦åŠ¨æ€è·å–æˆ–åˆ›å»ºbeançš„åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œä¾‹å¦‚å®ç°å¤æ‚çš„ä¾èµ–å…³ç³»æˆ–è‡ªå®šä¹‰åˆå§‹åŒ–é€»è¾‘ã€‚ 2.BeanNameAware123public interface BeanNameAware &#123; void setBeanName(String name);&#125; å®ç° BeanNameAware æ¥å£çš„ bean ä¼šåœ¨ Spring å®¹å™¨åˆ›å»ºå¹¶åˆå§‹åŒ–è¯¥ bean æ—¶ï¼Œè°ƒç”¨ setBeanName æ–¹æ³•ï¼Œå°†å®¹å™¨ä¸­ä¸ºè¯¥ bean é…ç½®çš„åç§°ä¼ é€’ç»™å®ƒã€‚è¿™å¯¹äºéœ€è¦çŸ¥é“è‡ªå·±åœ¨å®¹å™¨ä¸­çš„åç§°çš„ bean æ¥è¯´éå¸¸æœ‰ç”¨ã€‚ 3.3 Aware Group 2-ApplicationContext ç›¸å…³Awareå¹¶ä¸æ˜¯æ‰€æœ‰çš„Awareæ¥å£éƒ½ä½¿ç”¨åŒæ ·çš„æ–¹å¼è°ƒç”¨ã€‚BeanÃ—Ã—Awareéƒ½æ˜¯åœ¨ä»£ç ä¸­ç›´æ¥è°ƒç”¨çš„ï¼Œè€ŒApplicationContextç›¸å…³çš„Awareéƒ½æ˜¯é€šè¿‡BeanPostProcessor#postProcessBeforeInitialization()å®ç°çš„ EnvironmentAware: å…è®¸beanè®¿é—®Springçš„Environmentæ¥å£ï¼Œç”¨äºè·å–ç¯å¢ƒå±æ€§å’Œé…ç½®æ–‡ä»¶ä¿¡æ¯ã€‚ EmbeddedValueResolverAware: å…è®¸beanè·å–Springçš„å­—ç¬¦ä¸²å€¼è§£æå™¨ï¼Œç‰¹åˆ«æ˜¯ç”¨æ¥è§£æSpring ELè¡¨è¾¾å¼ï¼ˆSpELï¼‰ã€‚ ApplicationContextAware: å…è®¸beanè·å–ApplicationContextï¼Œè¿™æ˜¯BeanFactoryçš„ä¸€ä¸ªå­æ¥å£ï¼Œæä¾›æ›´å¤šå®¹å™¨åŠŸèƒ½å’Œåº”ç”¨ä¸Šä¸‹æ–‡ç›¸å…³çš„ä¿¡æ¯ã€‚ è·Ÿè¿›ä»£ç æœ€åæ¥åˆ°ApplicationContextAwareProcessorä¸­ï¼ŒApplicationContextAwareProcessor æ˜¯ä¸€ä¸ªBeanPostProcessor, æœ€ååœ¨å…¶é‡å†™çš„postProcessBeforeInitializationæ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨å¦‚ä¸‹æ–¹æ³•ã€‚ 3.4 Awareæ‰§è¡Œæ—¶æœº12345678910protected Object initializeBean(String beanName, Object bean, @Nullable RootBeanDefinition mbd) &#123; invokeAwareMethods(beanName, bean); applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); invokeInitMethods(beanName, wrappedBean, mbd); applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); &#125; ç¤ºä¾‹ä»£ç 123456789101112131415161718192021import org.springframework.beans.factory.BeanFactory;import org.springframework.beans.factory.BeanFactoryAware;import org.springframework.stereotype.Component;@Componentpublic class MyBeanFactoryAwareBean implements BeanFactoryAware &#123; private BeanFactory beanFactory; @Override public void setBeanFactory(BeanFactory beanFactory) throws BeansException &#123; this.beanFactory = beanFactory; System.out.println(&quot;BeanFactory has been set: &quot; + beanFactory); &#125; public void doSomething() &#123; // ä½¿ç”¨beanFactoryè·å–å¦ä¸€ä¸ªbean MyOtherBean otherBean = beanFactory.getBean(MyOtherBean.class); otherBean.performTask(); &#125;&#125; 4.Beanç”Ÿå‘½å‘¨æœŸå¯¹bean çš„ç”Ÿå‘½å‘¨æœŸåšç»†åŒ–çš„è¯å¯ä»¥åˆ†ä¸ºä»¥ä¸‹é˜¶æ®µ å®ä¾‹åŒ–ï¼ˆInstantiationï¼‰ï¼š Springå®¹å™¨ä½¿ç”¨æ„é€ å‡½æ•°æˆ–å·¥å‚æ–¹æ³•å®ä¾‹åŒ–beanã€‚ å±æ€§å¡«å……ï¼ˆDependency Injectionï¼‰ï¼š Springå®¹å™¨è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œå°†æ‰€æœ‰éœ€è¦çš„å±æ€§å’Œä¾èµ–æ³¨å…¥åˆ°beanå®ä¾‹ä¸­ã€‚ è®¾ç½®ç‰¹æ®Šå›è°ƒæ¥å£ï¼ˆAwareæ¥å£ï¼‰ï¼š å¦‚æœbeanå®ç°äº†Awareæ¥å£ï¼ŒSpringå®¹å™¨ä¼šåœ¨è¿™ä¸ªé˜¶æ®µè°ƒç”¨ç›¸åº”çš„æ–¹æ³•ã€‚ åŒ…æ‹¬BeanNameAwareã€BeanClassLoaderAwareã€BeanFactoryAwareç­‰ã€‚ åˆå§‹åŒ–å‰å¤„ç†ï¼ˆBeanPostProcessorçš„postProcessBeforeInitializationæ–¹æ³•ï¼‰ï¼š Springå®¹å™¨ä¼šåœ¨è¿™ä¸ªé˜¶æ®µè°ƒç”¨æ‰€æœ‰æ³¨å†Œçš„BeanPostProcessorçš„postProcessBeforeInitializationæ–¹æ³•ã€‚ åˆå§‹åŒ–ï¼ˆInitializationï¼‰ï¼š å¦‚æœbeanå®ç°äº†InitializingBeanæ¥å£ï¼ŒSpringå®¹å™¨ä¼šè°ƒç”¨å…¶afterPropertiesSetæ–¹æ³•ã€‚ å¦‚æœbeané…ç½®äº†è‡ªå®šä¹‰çš„initæ–¹æ³•ï¼ŒSpringå®¹å™¨ä¼šè°ƒç”¨è¯¥æ–¹æ³•ã€‚ åˆå§‹åŒ–åå¤„ç†ï¼ˆBeanPostProcessorçš„postProcessAfterInitializationæ–¹æ³•ï¼‰ï¼š Springå®¹å™¨ä¼šåœ¨è¿™ä¸ªé˜¶æ®µè°ƒç”¨æ‰€æœ‰æ³¨å†Œçš„BeanPostProcessorçš„postProcessAfterInitializationæ–¹æ³•ã€‚","tags":["java","Spring"]},{"title":"Understanding LSTM Networks","path":"/4579c6a3/","content":"Understanding LSTM Networks Recurrent Neural Networksé€’å½’ç¥ç»ç½‘ç»œHumans donâ€™t start their thinking from scratch every second. As you read this essay, you understand each word based on your understanding of previous words. You donâ€™t throw everything away and start thinking from scratch again. Your thoughts have persistence.äººç±»ä¸ä¼šæ¯ç§’éƒ½ä»å¤´å¼€å§‹æ€è€ƒã€‚å½“ä½ é˜…è¯»è¿™ç¯‡æ–‡ç« æ—¶ï¼Œä½ ä¼šåŸºäºå¯¹ä¹‹å‰è¯è¯­çš„ç†è§£æ¥ç†è§£æ¯ä¸ªè¯ã€‚ä½ ä¸ä¼šæŠŠæ‰€æœ‰ä¸œè¥¿éƒ½ä¸¢æ‰ç„¶åé‡æ–°å¼€å§‹æ€è€ƒã€‚ä½ çš„æ€ç»´æ˜¯æœ‰è¿ç»­æ€§çš„ã€‚ Traditional neural networks canâ€™t do this, and it seems like a major shortcoming. For example, imagine you want to classify what kind of event is happening at every point in a movie. Itâ€™s unclear how a traditional neural network could use its reasoning about previous events in the film to inform later ones.ä¼ ç»Ÿçš„ç¥ç»ç½‘ç»œåšä¸åˆ°è¿™ä¸€ç‚¹ï¼Œè¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªä¸»è¦çš„ç¼ºé™·ã€‚æ¯”å¦‚ï¼Œæƒ³è±¡ä¸€ä¸‹ä½ æƒ³å¯¹ç”µå½±ä¸­æ¯ä¸ªæ—¶åˆ»å‘ç”Ÿçš„äº‹ä»¶ç±»å‹è¿›è¡Œåˆ†ç±»ã€‚ç›®å‰å°šä¸æ¸…æ¥šä¼ ç»Ÿçš„ç¥ç»ç½‘ç»œå¦‚ä½•åˆ©ç”¨å…¶å¯¹ç”µå½±ä¸­å…ˆå‰äº‹ä»¶çš„æ¨ç†æ¥ä¸ºåæ¥çš„äº‹ä»¶æä¾›ä¿¡æ¯ã€‚ Recurrent neural networks address this issue. They are networks with loops in them, allowing information to persist.å¾ªç¯ç¥ç»ç½‘ç»œè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å®ƒä»¬æ˜¯å†…éƒ¨å¸¦æœ‰å¾ªç¯çš„ç½‘ç»œï¼Œå…è®¸ä¿¡æ¯æŒç»­å­˜åœ¨ã€‚ Recurrent Neural Networks have loops. é€’å½’ç¥ç»ç½‘ç»œæœ‰å¾ªç¯ã€‚ In the above diagram, a chunk of neural network, ğ´, looks at some input $ğ‘¥_ğ‘¡$ and outputs a value $â„_ğ‘¡$. A loop allows information to be passed from one step of the network to the next.åœ¨ä¸Šå›¾ä¸­ï¼Œç¥ç»ç½‘ç»œçš„ä¸€éƒ¨åˆ† $A$ ,æŸ¥çœ‹ä¸€äº›è¾“å…¥$x_tâ€‹$ å¹¶è¾“å‡ºä¸€ä¸ªå€¼ $h_t$ã€‚ä¸€ä¸ªå¾ªç¯å…è®¸ä¿¡æ¯ä»ç½‘ç»œçš„ä¸€ä¸ªæ­¥éª¤ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªæ­¥éª¤ã€‚ These loops make recurrent neural networks seem kind of mysterious. However, if you think a bit more, it turns out that they arenâ€™t all that different than a normal neural network. A recurrent neural network can be thought of as multiple copies of the same network, each passing a message to a successor. Consider what happens if we unroll the loop:è¿™äº›å¾ªç¯ä½¿å¾ªç¯ç¥ç»ç½‘ç»œçœ‹èµ·æ¥æœ‰ç‚¹ç¥ç§˜ã€‚ç„¶è€Œï¼Œå¦‚æœä½ å¤šæƒ³ä¸€ç‚¹ï¼Œå°±ä¼šå‘ç°å®ƒä»¬ä¸æ™®é€šçš„ç¥ç»ç½‘ç»œå¹¶æ²¡æœ‰å¤ªå¤§çš„ä¸åŒã€‚é€’å½’ç¥ç»ç½‘ç»œå¯ä»¥è¢«è®¤ä¸ºæ˜¯åŒä¸€ç½‘ç»œçš„å¤šä¸ªå‰¯æœ¬ï¼Œæ¯ä¸ªå‰¯æœ¬å°†æ¶ˆæ¯ä¼ é€’ç»™ç»§ä»»è€…ã€‚è€ƒè™‘ä¸€ä¸‹å¦‚æœæˆ‘ä»¬å±•å¼€å¾ªç¯ä¼šå‘ç”Ÿä»€ä¹ˆï¼šAn unrolled recurrent neural network. å±•å¼€çš„å¾ªç¯ç¥ç»ç½‘ç»œã€‚ This chain-like nature reveals that recurrent neural networks are intimately related to sequences and lists. Theyâ€™re the natural architecture of neural network to use for such data.è¿™ç§é“¾å¼ç»“æ„è¡¨æ˜ï¼Œé€’å½’ç¥ç»ç½‘ç»œä¸åºåˆ—å’Œåˆ—è¡¨å¯†åˆ‡ç›¸å…³ã€‚å®ƒä»¬æ˜¯å¤„ç†æ­¤ç±»æ•°æ®çš„è‡ªç„¶ç¥ç»ç½‘ç»œæ¶æ„ã€‚ And they certainly are used! In the last few years, there have been incredible success applying RNNs to a variety of problems: speech recognition, language modeling, translation, image captioningâ€¦ The list goes on. Iâ€™ll leave discussion of the amazing feats one can achieve with RNNs to Andrej Karpathyâ€™s excellent blog post, The Unreasonable Effectiveness of Recurrent Neural Networks. But they really are pretty amazing.ä»–ä»¬å½“ç„¶è¢«ä½¿ç”¨äº†ï¼åœ¨è¿‡å»çš„å‡ å¹´é‡Œï¼Œå°†RNNåº”ç”¨äºå„ç§é—®é¢˜å–å¾—äº†ä»¤äººéš¾ä»¥ç½®ä¿¡çš„æˆåŠŸï¼šè¯­éŸ³è¯†åˆ«ã€è¯­è¨€å»ºæ¨¡ã€ç¿»è¯‘ã€å›¾åƒå­—å¹•â€¦â€¦è¿™æ ·çš„ä¾‹å­ä¸èƒœæšä¸¾ã€‚æˆ‘å°†æŠŠå…³äºRNNå¯ä»¥å®ç°çš„æƒŠäººå£®ä¸¾çš„è®¨è®ºç•™ç»™Andrej Karpathyçš„ä¼˜ç§€åšå®¢æ–‡ç« ï¼Œé€’å½’ç¥ç»ç½‘ç»œçš„ä¸åˆç†æœ‰æ•ˆæ€§ã€‚ä½†ä»–ä»¬çœŸçš„éå¸¸äº†ä¸èµ·ã€‚ Essential to these successes is the use of â€œLSTMs,â€ a very special kind of recurrent neural network which works, for many tasks, much much better than the standard version. Almost all exciting results based on recurrent neural networks are achieved with them. Itâ€™s these LSTMs that this essay will explore.è¿™äº›æˆåŠŸçš„å…³é”®æ˜¯â€œLSTMâ€çš„ä½¿ç”¨ï¼Œè¿™æ˜¯ä¸€ç§éå¸¸ç‰¹æ®Šçš„é€’å½’ç¥ç»ç½‘ç»œï¼Œå¯¹äºè®¸å¤šä»»åŠ¡ï¼Œå®ƒæ¯”æ ‡å‡†ç‰ˆæœ¬è¦å¥½å¾—å¤šã€‚å‡ ä¹æ‰€æœ‰åŸºäºé€’å½’ç¥ç»ç½‘ç»œçš„ä»¤äººå…´å¥‹çš„ç»“æœéƒ½æ˜¯é€šè¿‡å®ƒä»¬å®ç°çš„ã€‚æœ¬æ–‡å°†æ¢è®¨çš„æ­£æ˜¯è¿™äº› LSTMã€‚ The Problem of Long-Term Dependenciesé•¿æœŸä¾èµ–æ€§é—®é¢˜ One of the appeals of RNNs is the idea that they might be able to connect previous information to the present task, such as using previous video frames might inform the understanding of the present frame. If RNNs could do this, theyâ€™d be extremely useful. But can they? It depends.RNNçš„å¸å¼•åŠ›ä¹‹ä¸€æ˜¯ï¼Œå®ƒä»¬å¯èƒ½èƒ½å¤Ÿå°†å…ˆå‰çš„ä¿¡æ¯ä¸å½“å‰ä»»åŠ¡è”ç³»èµ·æ¥ï¼Œä¾‹å¦‚ä½¿ç”¨ä»¥å‰çš„è§†é¢‘å¸§å¯èƒ½ä¼šä¸ºç†è§£å½“å‰å¸§æä¾›ä¿¡æ¯ã€‚å¦‚æœRNNå¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œå®ƒä»¬å°†éå¸¸æœ‰ç”¨ã€‚ä½†æ˜¯ä»–ä»¬èƒ½åšåˆ°å—ï¼Ÿè¿™è¦è§†æƒ…å†µè€Œå®šã€‚ Sometimes, we only need to look at recent information to perform the present task. For example, consider a language model trying to predict the next word based on the previous ones. If we are trying to predict the last word in â€œthe clouds are in the _sky_,â€ we donâ€™t need any further context â€“ itâ€™s pretty obvious the next word is going to be sky. In such cases, where the gap between the relevant information and the place that itâ€™s needed is small, RNNs can learn to use the past information.æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦æŸ¥çœ‹æœ€è¿‘çš„ä¿¡æ¯å°±å¯ä»¥å®Œæˆå½“å‰çš„ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸€ä¸ªè¯­è¨€æ¨¡å‹,å®ƒå°è¯•åŸºäºå‰é¢çš„å•è¯æ¥é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯ã€‚å¦‚æœæˆ‘ä»¬è¯•å›¾é¢„æµ‹â€œthe clouds are in the skyâ€ä¸­çš„æœ€åä¸€ä¸ªå•è¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä»»ä½•è¿›ä¸€æ­¥çš„ä¸Šä¸‹æ–‡â€”â€”å¾ˆæ˜æ˜¾ä¸‹ä¸€ä¸ªå•è¯å°†æ˜¯skyã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç›¸å…³ä¿¡æ¯å’Œæ‰€éœ€ä½ç½®ä¹‹é—´çš„é—´éš”è¾ƒå°ï¼ŒRNNså¯ä»¥å­¦ä¹ ä½¿ç”¨è¿‡å»çš„ä¿¡æ¯ã€‚ But there are also cases where we need more context. Consider trying to predict the last word in the text â€œI grew up in Franceâ€¦ I speak fluent _French_.â€ Recent information suggests that the next word is probably the name of a language, but if we want to narrow down which language, we need the context of France, from further back. Itâ€™s entirely possible for the gap between the relevant information and the point where it is needed to become very large.ä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æ›´å¤šçš„èƒŒæ™¯ä¿¡æ¯ã€‚è€ƒè™‘è¯•å›¾é¢„æµ‹æ–‡æœ¬â€œI grew up in Franceâ€¦ I speak fluent French.â€ä¸­çš„æœ€åä¸€ä¸ªå•è¯ã€‚æœ€è¿‘çš„ä¿¡æ¯è¡¨æ˜ä¸‹ä¸€ä¸ªå•è¯å¯èƒ½æ˜¯æŸç§è¯­è¨€çš„åç§°ï¼Œä½†å¦‚æœæˆ‘ä»¬æƒ³ç¼©å°è¯­è¨€èŒƒå›´ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ—©çš„æ³•å›½è¿™ä¸€èƒŒæ™¯ä¿¡æ¯ã€‚ç›¸å…³ä¿¡æ¯å’Œéœ€è¦ä½¿ç”¨è¯¥ä¿¡æ¯çš„ç‚¹ä¹‹é—´çš„é—´éš”å®Œå…¨æœ‰å¯èƒ½å˜å¾—éå¸¸å¤§ã€‚ Unfortunately, as that gap grows, RNNs become unable to learn to connect the information.ä¸å¹¸çš„æ˜¯ï¼Œéšç€è¿™ç§é—´éš”çš„æ‰©å¤§ï¼ŒRNNå˜å¾—æ— æ³•å­¦ä¹ å»è¿æ¥ä¿¡æ¯ã€‚ In theory, RNNs are absolutely capable of handling such â€œlong-term dependencies.â€ A human could carefully pick parameters for them to solve toy problems of this form. Sadly, in practice, RNNs donâ€™t seem to be able to learn them. The problem was explored in depth by Hochreiter (1991) [German] and Bengio, et al. (1994), who found some pretty fundamental reasons why it might be difficult.ç†è®ºä¸Šï¼ŒRNNså®Œå…¨æœ‰èƒ½åŠ›å¤„ç†è¿™ç§â€œé•¿æœŸä¾èµ–â€ã€‚äººç±»å¯ä»¥ä»”ç»†æŒ‘é€‰å‚æ•°ï¼Œä½¿å®ƒä»¬è§£å†³è¿™ç§å½¢å¼çš„ç©å…·é—®é¢˜ã€‚é—æ†¾çš„æ˜¯ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼ŒRNNsä¼¼ä¹æ— æ³•å­¦ä¼šå®ƒä»¬ã€‚è¿™ä¸ªé—®é¢˜åœ¨Hochreiterï¼ˆ1991ï¼‰å’ŒBengioç­‰äººï¼ˆ1994ï¼‰çš„ç ”ç©¶ä¸­å¾—åˆ°äº†æ·±å…¥æ¢è®¨ï¼Œä»–ä»¬å‘ç°äº†ä¸€äº›å¯èƒ½å¯¼è‡´è¿™ä¸€å›°éš¾çš„åŸºæœ¬åŸå› ã€‚ Thankfully, LSTMs donâ€™t have this problem!å€¼å¾—åº†å¹¸çš„æ˜¯ï¼ŒLSTM æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼ LSTM NetworksLong Short Term Memory networks â€“ usually just called â€œLSTMsâ€ â€“ are a special kind of RNN, capable of learning long-term dependencies. They were introduced by Hochreiter &amp; Schmidhuber (1997), and were refined and popularized by many people in following work.1 They work tremendously well on a large variety of problems, and are now widely used.é•¿çŸ­æœŸè®°å¿†ç½‘ç»œâ€”â€”é€šå¸¸ç®€ç§°ä¸ºâ€œLSTMsâ€â€”â€”æ˜¯ä¸€ç§ç‰¹æ®Šçš„RNNï¼Œèƒ½å¤Ÿå­¦ä¹ é•¿æœŸä¾èµ–ã€‚å®ƒä»¬ç”±Hochreiterå’ŒSchmidhuberï¼ˆ1997ï¼‰å¼•å…¥ï¼Œå¹¶åœ¨éšåçš„å·¥ä½œä¸­è¢«è®¸å¤šäººæ”¹è¿›å’Œæ¨å¹¿ã€‚LSTMsåœ¨å¤§é‡ä¸åŒçš„é—®é¢˜ä¸Šè¡¨ç°å‡ºè‰²ï¼Œç°åœ¨è¢«å¹¿æ³›ä½¿ç”¨ã€‚ LSTMs are explicitly designed to avoid the long-term dependency problem. Remembering information for long periods of time is practically their default behavior, not something they struggle to learn!LSTMsè¢«æ˜ç¡®è®¾è®¡ç”¨äºé¿å…é•¿æœŸä¾èµ–é—®é¢˜ã€‚è®°ä½é•¿æ—¶é—´çš„ä¿¡æ¯å‡ ä¹æ˜¯å®ƒä»¬çš„é»˜è®¤è¡Œä¸ºï¼Œè€Œä¸æ˜¯å®ƒä»¬éœ€è¦åŠªåŠ›å­¦ä¹ çš„ä¸œè¥¿ï¼ All recurrent neural networks have the form of a chain of repeating modules of neural network. In standard RNNs, this repeating module will have a very simple structure, such as a single tanh layer.æ‰€æœ‰é€’å½’ç¥ç»ç½‘ç»œéƒ½å…·æœ‰ç¥ç»ç½‘ç»œé‡å¤æ¨¡å—é“¾çš„å½¢å¼ã€‚åœ¨æ ‡å‡† RNN ä¸­ï¼Œè¯¥é‡å¤æ¨¡å—å°†å…·æœ‰éå¸¸ç®€å•çš„ç»“æ„ï¼Œä¾‹å¦‚å•ä¸ª tanh å±‚ã€‚ The repeating module in a standard RNN contains a single layer.æ ‡å‡† RNN ä¸­çš„é‡å¤æ¨¡å—åŒ…å«å•å±‚ã€‚ LSTMs also have this chain like structure, but the repeating module has a different structure. Instead of having a single neural network layer, there are four, interacting in a very special way.LSTM ä¹Ÿå…·æœ‰è¿™ç§é“¾çŠ¶ç»“æ„ï¼Œä½†é‡å¤æ¨¡å—å…·æœ‰ä¸åŒçš„ç»“æ„ã€‚ä¸æ˜¯åªæœ‰ä¸€ä¸ªç¥ç»ç½‘ç»œå±‚ï¼Œè€Œæ˜¯æœ‰å››ä¸ªï¼Œä»¥ä¸€ç§éå¸¸ç‰¹æ®Šçš„æ–¹å¼è¿›è¡Œäº¤äº’ã€‚ The repeating module in an LSTM contains four interacting layers.LSTM ä¸­çš„é‡å¤æ¨¡å—åŒ…å«å››ä¸ªäº¤äº’å±‚ã€‚ Donâ€™t worry about the details of whatâ€™s going on. Weâ€™ll walk through the LSTM diagram step by step later. For now, letâ€™s just try to get comfortable with the notation weâ€™ll be using.ä¸ç”¨æ‹…å¿ƒå…·ä½“çš„ç»†èŠ‚ã€‚æˆ‘ä»¬ç¨åä¼šä¸€æ­¥æ­¥è®²è§£LSTMçš„å›¾è¡¨ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬å…ˆç†Ÿæ‚‰ä¸€ä¸‹æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„ç¬¦å·ã€‚In the above diagram, each line carries an entire vector, from the output of one node to the inputs of others. The pink circles represent pointwise operations, like vector addition, while the yellow boxes are learned neural network layers. Lines merging denote concatenation, while a line forking denote its content being copied and the copies going to different locations.åœ¨ä¸Šå›¾ä¸­ï¼Œæ¯æ¡çº¿éƒ½å¸¦æœ‰ä¸€ä¸ªå®Œæ•´çš„å‘é‡ï¼Œä»ä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºåˆ°å…¶ä»–èŠ‚ç‚¹çš„è¾“å…¥ã€‚ç²‰çº¢è‰²çš„åœ†åœˆä»£è¡¨é€ç‚¹è¿ç®—ï¼Œå¦‚å‘é‡åŠ æ³•ï¼Œè€Œé»„è‰²æ¡†æ˜¯å­¦ä¹ çš„ç¥ç»ç½‘ç»œå±‚ã€‚åˆå¹¶çš„è¡Œè¡¨ç¤ºä¸²è”ï¼Œè€Œåˆ†å‰çš„è¡Œè¡¨ç¤ºæ­£åœ¨å¤åˆ¶å…¶å†…å®¹å¹¶å°†å‰¯æœ¬å‘é€åˆ°ä¸åŒçš„ä½ç½®ã€‚ The Core Idea Behind LSTMsLSTM èƒŒåçš„æ ¸å¿ƒæ€æƒ³ The key to LSTMs is the cell state, the horizontal line running through the top of the diagram.LSTMsçš„å…³é”®æ˜¯å•å…ƒçŠ¶æ€ï¼Œè¿™æ¡æ¨ªçº¿è´¯ç©¿äº†å›¾è¡¨çš„é¡¶éƒ¨ã€‚ The cell state is kind of like a conveyor belt. It runs straight down the entire chain, with only some minor linear interactions. Itâ€™s very easy for information to just flow along it unchanged.å•å…ƒçŠ¶æ€æœ‰ç‚¹åƒä¼ é€å¸¦ã€‚å®ƒç›´æ¥æ²¿ç€æ•´ä¸ªé“¾æ¡è¿è¡Œï¼Œåªæœ‰ä¸€äº›å°çš„çº¿æ€§äº¤äº’ã€‚ä¿¡æ¯å¯ä»¥éå¸¸å®¹æ˜“åœ°æ²¿ç€å®ƒä¸å˜åœ°æµåŠ¨ã€‚ The LSTM does have the ability to remove or add information to the cell state, carefully regulated by structures called gates.LSTMç¡®å®å…·æœ‰ä»å•å…ƒçŠ¶æ€ä¸­ç§»é™¤æˆ–æ·»åŠ ä¿¡æ¯çš„èƒ½åŠ›ï¼Œè¿™äº›æ“ä½œç”±ç§°ä¸ºé—¨æ§çš„ç»“æ„ä¸¥æ ¼è°ƒæ§ã€‚ Gates are a way to optionally let information through. They are composed out of a sigmoid neural net layer and a pointwise multiplication operation.é—¨æ§æ˜¯ä¸€ç§é€‰æ‹©æ€§åœ°è®©ä¿¡æ¯é€šè¿‡çš„æ–¹å¼ã€‚å®ƒä»¬ç”±ä¸€ä¸ªsigmoidç¥ç»ç½‘ç»œå±‚å’Œä¸€ä¸ªé€ç‚¹ä¹˜æ³•æ“ä½œç»„æˆã€‚The sigmoid layer outputs numbers between zero and one, describing how much of each component should be let through. A value of zero means â€œlet nothing through,â€ while a value of one means â€œlet everything through!â€sigmoid å±‚è¾“å‡ºä»‹äº 0 å’Œ 1 ä¹‹é—´çš„æ•°å­—ï¼Œæè¿°æ¯ä¸ªç»„ä»¶åº”é€šè¿‡å¤šå°‘ã€‚å€¼ä¸ºé›¶è¡¨ç¤ºâ€œä»€ä¹ˆéƒ½ä¸è®©é€šè¿‡â€ï¼Œè€Œå€¼ä¸º 1 è¡¨ç¤ºâ€œè®©æ‰€æœ‰ä¸œè¥¿éƒ½é€šè¿‡ï¼â€ An LSTM has three of these gates, to protect and control the cell state.LSTM æœ‰ä¸‰ä¸ªè¿™æ ·çš„é—¨ï¼Œç”¨äºä¿æŠ¤å’Œæ§åˆ¶å•å…ƒçŠ¶æ€ã€‚ Step-by-Step LSTM Walk Throughå¾ªåºæ¸è¿›çš„ LSTM æ¼”ç»ƒ forget gate layerThe first step in our LSTM is to decide what information weâ€™re going to throw away from the cell state. This decision is made by a sigmoid layer called the â€œforget gate layer.â€ It looks at $h_{tâˆ’1}$ and $x_t$, and outputs a number between 00 and 11 for each number in the cell state $C_{tâˆ’1}$. A 1 represents â€œcompletely keep thisâ€ while a 0 represents â€œcompletely get rid of this.â€LSTMçš„ç¬¬ä¸€æ­¥æ˜¯å†³å®šè¦ä»å•å…ƒçŠ¶æ€ä¸­ä¸¢å¼ƒå“ªäº›ä¿¡æ¯ã€‚è¿™ä¸ªå†³ç­–æ˜¯ç”±ä¸€ä¸ªåä¸ºâ€œé—å¿˜é—¨å±‚â€çš„sigmoidå±‚åšå‡ºçš„ã€‚å®ƒæŸ¥çœ‹ $h_{t-1}â€‹$ å’Œ $x_t$ï¼Œå¹¶ä¸ºå•å…ƒçŠ¶æ€ $C_{t-1}$ ä¸­çš„æ¯ä¸ªæ•°å­—è¾“å‡ºä¸€ä¸ªä»‹äº0å’Œ1ä¹‹é—´çš„æ•°å€¼ã€‚1è¡¨ç¤ºâ€œå®Œå…¨ä¿ç•™è¿™ä¸ªâ€ï¼Œè€Œ0è¡¨ç¤ºâ€œå®Œå…¨ä¸¢å¼ƒè¿™ä¸ªâ€ã€‚ Letâ€™s go back to our example of a language model trying to predict the next word based on all the previous ones. In such a problem, the cell state might include the gender of the present subject, so that the correct pronouns can be used. When we see a new subject, we want to forget the gender of the old subject.è®©æˆ‘ä»¬å›åˆ°æˆ‘ä»¬çš„ä¾‹å­ï¼Œä¸€ä¸ªè¯­è¨€æ¨¡å‹è¯•å›¾åŸºäºæ‰€æœ‰å‰é¢çš„å•è¯æ¥é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯ã€‚åœ¨è¿™æ ·çš„é—®é¢˜ä¸­ï¼Œå•å…ƒçŠ¶æ€å¯èƒ½åŒ…å«å½“å‰ä¸»è¯­çš„æ€§åˆ«ï¼Œä»¥ä¾¿ä½¿ç”¨æ­£ç¡®çš„ä»£è¯ã€‚å½“æˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªæ–°çš„ä¸»è¯­æ—¶ï¼Œæˆ‘ä»¬æƒ³å¿˜è®°æ—§ä¸»è¯­çš„æ€§åˆ«ã€‚ input gate layerThe next step is to decide what new information weâ€™re going to store in the cell state. This has two parts. First, a sigmoid layer called the â€œinput gate layerâ€ decides which values weâ€™ll update. Next, a tanh layer creates a vector of new candidate values, $\\tilde{C}_t$, that could be added to the state. In the next step, weâ€™ll combine these two to create an update to the state.ä¸‹ä¸€æ­¥æ˜¯å†³å®šè¦åœ¨å•å…ƒçŠ¶æ€ä¸­å­˜å‚¨å“ªäº›æ–°ä¿¡æ¯ã€‚è¿™åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ã€‚é¦–å…ˆï¼Œä¸€ä¸ªåä¸ºâ€œè¾“å…¥é—¨å±‚â€çš„sigmoidå±‚å†³å®šæˆ‘ä»¬å°†æ›´æ–°å“ªäº›å€¼ã€‚æ¥ä¸‹æ¥ï¼Œä¸€ä¸ªtanhå±‚åˆ›å»ºä¸€ä¸ªæ–°çš„å€™é€‰å€¼å‘é‡$\\tilde{C}_t$ï¼Œè¿™äº›å€™é€‰å€¼å¯ä»¥è¢«æ·»åŠ åˆ°çŠ¶æ€ä¸­ã€‚åœ¨ä¸‹ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å°†ç»“åˆè¿™ä¸¤éƒ¨åˆ†æ¥æ›´æ–°çŠ¶æ€ã€‚ In the example of our language model, weâ€™d want to add the gender of the new subject to the cell state, to replace the old one weâ€™re forgetting.åœ¨æˆ‘ä»¬çš„è¯­è¨€æ¨¡å‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å°†æ–°ä¸»è¯­çš„æ€§åˆ«æ·»åŠ åˆ°å•å…ƒæ ¼çŠ¶æ€ä¸­ï¼Œä»¥æ›¿æ¢æˆ‘ä»¬å¿˜è®°çš„æ—§ä¸»è¯­ã€‚ Itâ€™s now time to update the old cell state$C_{t-1}$, into the new cell state $C_t$â€‹. The previous steps already decided what to do, we just need to actually do it.ç°åœ¨æ˜¯æ—¶å€™å°†æ—§çš„å•å…ƒæ ¼çŠ¶æ€$C_{t-1}$æ›´æ–°ä¸ºæ–°çš„å•å…ƒæ ¼çŠ¶æ€ $C_t$â€‹äº†ã€‚å‰é¢çš„æ­¥éª¤å·²ç»å†³å®šäº†è¦åšä»€ä¹ˆï¼Œæˆ‘ä»¬åªéœ€è¦å®é™…å»æ‰§è¡Œå®ƒã€‚ We multiply the old state by $ğ‘“_ğ‘¡$, forgetting the things we decided to forget earlier. Then we add $i_t \\ast \\tilde{C}_t$. This is the new candidate values, scaled by how much we decided to update each state value.æˆ‘ä»¬å°†æ—§çŠ¶æ€ä¹˜ä»¥ $f_t$ï¼Œå¿˜è®°æˆ‘ä»¬ä¹‹å‰å†³å®šå¿˜è®°çš„å†…å®¹ã€‚ç„¶åæˆ‘ä»¬åŠ ä¸Š $i_t \\ast \\tilde{C}_t$ã€‚è¿™äº›æ˜¯æ–°çš„å€™é€‰å€¼ï¼ŒæŒ‰æˆ‘ä»¬å†³å®šæ›´æ–°æ¯ä¸ªçŠ¶æ€å€¼çš„ç¨‹åº¦è¿›è¡Œç¼©æ”¾ã€‚ In the case of the language model, this is where weâ€™d actually drop the information about the old subjectâ€™s gender and add the new information, as we decided in the previous steps.åœ¨è¯­è¨€æ¨¡å‹çš„æƒ…å†µä¸‹ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨å‰é¢çš„æ­¥éª¤ä¸­å†³å®šçš„é‚£æ ·ï¼Œæˆ‘ä»¬å®é™…ä¸Šä¼šåˆ é™¤æœ‰å…³æ—§ä¸»é¢˜æ€§åˆ«çš„ä¿¡æ¯å¹¶æ·»åŠ æ–°ä¿¡æ¯ã€‚ output layerFinally, we need to decide what weâ€™re going to output. This output will be based on our cell state, but will be a filtered version. First, we run a sigmoid layer which decides what parts of the cell state weâ€™re going to output. Then, we put the cell state through tanh (to push the values to be between âˆ’1 and 1) and multiply it by the output of the sigmoid gate, so that we only output the parts we decided to.æœ€åï¼Œæˆ‘ä»¬éœ€è¦å†³å®šè¾“å‡ºä»€ä¹ˆã€‚è¿™ä¸ªè¾“å‡ºå°†åŸºäºæˆ‘ä»¬çš„å•å…ƒçŠ¶æ€ï¼Œä½†ä¼šæ˜¯ä¸€ä¸ªè¿‡æ»¤åçš„ç‰ˆæœ¬ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è¿è¡Œä¸€ä¸ªsigmoidå±‚æ¥å†³å®šè¦è¾“å‡ºå•å…ƒçŠ¶æ€çš„å“ªäº›éƒ¨åˆ†ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†å•å…ƒçŠ¶æ€é€šè¿‡tanhï¼ˆå°†å€¼å‹ç¼©åˆ°-1åˆ°1ä¹‹é—´ï¼‰ï¼Œå¹¶å°†å…¶ä¸sigmoidé—¨çš„è¾“å‡ºç›¸ä¹˜ï¼Œè¿™æ ·æˆ‘ä»¬åªè¾“å‡ºæˆ‘ä»¬å†³å®šè¾“å‡ºçš„éƒ¨åˆ†ã€‚ For the language model example, since it just saw a subject, it might want to output information relevant to a verb, in case thatâ€™s what is coming next. For example, it might output whether the subject is singular or plural, so that we know what form a verb should be conjugated into if thatâ€™s what follows next.å¯¹äºè¯­è¨€æ¨¡å‹çš„ä¾‹å­ï¼Œç”±äºå®ƒåˆšåˆšçœ‹åˆ°ä¸€ä¸ªä¸»è¯­ï¼Œå®ƒå¯èƒ½æƒ³è¾“å‡ºä¸åŠ¨è¯ç›¸å…³çš„ä¿¡æ¯ï¼Œä»¥é˜²æ¥ä¸‹æ¥éœ€è¦åŠ¨è¯ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½ä¼šè¾“å‡ºä¸»è¯­æ˜¯å•æ•°è¿˜æ˜¯å¤æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±çŸ¥é“å¦‚æœæ¥ä¸‹æ¥æ˜¯åŠ¨è¯ï¼Œè¯¥åŠ¨è¯åº”è¯¥å˜æˆä»€ä¹ˆå½¢å¼ã€‚ Variants on Long Short Term Memoryé•¿çŸ­æœŸè®°å¿†çš„å˜ä½“ What Iâ€™ve described so far is a pretty normal LSTM. But not all LSTMs are the same as the above. In fact, it seems like almost every paper involving LSTMs uses a slightly different version. The differences are minor, but itâ€™s worth mentioning some of them.æˆ‘åˆ°ç›®å‰ä¸ºæ­¢æè¿°çš„æ˜¯ä¸€ä¸ªç›¸å½“æ™®é€šçš„LSTMã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„LSTMéƒ½ä¸ä¸Šè¿°ç›¸åŒã€‚å®é™…ä¸Šï¼Œå‡ ä¹æ¯ç¯‡æ¶‰åŠLSTMçš„è®ºæ–‡éƒ½ä½¿ç”¨äº†ç¨å¾®ä¸åŒçš„ç‰ˆæœ¬ã€‚è¿™äº›å·®å¼‚å¾ˆå°ï¼Œä½†å€¼å¾—ä¸€æã€‚ One popular LSTM variant, introduced by Gers &amp; Schmidhuber (2000), is adding â€œpeephole connections.â€ This means that we let the gate layers look at the cell state.ä¸€ä¸ªç”±Gerså’ŒSchmidhuberï¼ˆ2000ï¼‰å¼•å…¥çš„æµè¡ŒLSTMå˜ä½“æ˜¯æ·»åŠ â€œçª¥è§†è¿æ¥â€ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬è®©é—¨æ§å±‚æŸ¥çœ‹å•å…ƒçŠ¶æ€ã€‚ The above diagram adds peepholes to all the gates, but many papers will give some peepholes and not others.ä¸Šå›¾ä¸ºæ‰€æœ‰é—¨æ§æ·»åŠ äº†çª¥è§†è¿æ¥ï¼Œä½†è®¸å¤šè®ºæ–‡ä¼šåªä¸ºéƒ¨åˆ†é—¨æ§æ·»åŠ çª¥è§†è¿æ¥ï¼Œè€Œä¸æ˜¯å…¨éƒ¨ã€‚ Another variation is to use coupled forget and input gates. Instead of separately deciding what to forget and what we should add new information to, we make those decisions together. We only forget when weâ€™re going to input something in its place. We only input new values to the state when we forget something older.å¦ä¸€ç§å˜ä½“æ˜¯ä½¿ç”¨è€¦åˆçš„é—å¿˜é—¨å’Œè¾“å…¥é—¨ã€‚æˆ‘ä»¬ä¸æ˜¯åˆ†åˆ«å†³å®šè¦å¿˜è®°ä»€ä¹ˆä»¥åŠè¦æ·»åŠ ä»€ä¹ˆæ–°ä¿¡æ¯ï¼Œè€Œæ˜¯å°†è¿™äº›å†³ç­–ç»“åˆåœ¨ä¸€èµ·ã€‚æˆ‘ä»¬åªæœ‰åœ¨è¦è¾“å…¥æ–°ä¿¡æ¯æ—¶æ‰ä¼šå¿˜è®°æŸäº›å†…å®¹ã€‚åªæœ‰åœ¨å¿˜è®°æ—§ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬æ‰ä¼šå°†æ–°å€¼è¾“å…¥åˆ°çŠ¶æ€ä¸­ã€‚ A slightly more dramatic variation on the LSTM is the Gated Recurrent Unit, or GRU, introduced by Cho, et al. (2014). It combines the forget and input gates into a single â€œupdate gate.â€ It also merges the cell state and hidden state, and makes some other changes. The resulting model is simpler than standard LSTM models, and has been growing increasingly popular.LSTMçš„ä¸€ä¸ªç¨å¾®æ›´æ˜¾è‘—çš„å˜ä½“æ˜¯é—¨æ§å¾ªç¯å•å…ƒï¼ˆGRUï¼‰ï¼Œç”±Choç­‰äººï¼ˆ2014ï¼‰å¼•å…¥ã€‚å®ƒå°†é—å¿˜é—¨å’Œè¾“å…¥é—¨ç»„åˆæˆä¸€ä¸ªâ€œæ›´æ–°é—¨â€ã€‚å®ƒè¿˜åˆå¹¶äº†å•å…ƒçŠ¶æ€å’Œéšè—çŠ¶æ€ï¼Œå¹¶åšäº†ä¸€äº›å…¶ä»–çš„æ”¹å˜ã€‚æœ€ç»ˆçš„æ¨¡å‹æ¯”æ ‡å‡†çš„LSTMæ¨¡å‹æ›´ç®€å•ï¼Œå¹¶ä¸”è¶Šæ¥è¶Šå—æ¬¢è¿ã€‚ These are only a few of the most notable LSTM variants. There are lots of others, like Depth Gated RNNs by Yao, et al. (2015). Thereâ€™s also some completely different approach to tackling long-term dependencies, like Clockwork RNNs by Koutnik, et al. (2014).è¿™äº›åªæ˜¯ä¸€äº›æœ€è‘—åçš„LSTMå˜ä½“ã€‚è¿˜æœ‰è®¸å¤šå…¶ä»–å˜ä½“ï¼Œä¾‹å¦‚Yaoç­‰äººï¼ˆ2015ï¼‰æå‡ºçš„æ·±åº¦é—¨æ§RNNã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›å®Œå…¨ä¸åŒçš„æ–¹æ³•æ¥è§£å†³é•¿æœŸä¾èµ–é—®é¢˜ï¼Œä¾‹å¦‚Koutnikç­‰äººï¼ˆ2014ï¼‰æå‡ºçš„æ—¶é’Ÿå¼RNNã€‚ Which of these variants is best? Do the differences matter? Greff, et al. (2015) do a nice comparison of popular variants, finding that theyâ€™re all about the same. Jozefowicz, et al. (2015) tested more than ten thousand RNN architectures, finding some that worked better than LSTMs on certain tasks.è¿™äº›å˜ä½“ä¸­å“ªä¸€ä¸ªæœ€å¥½ï¼Ÿå·®å¼‚é‡è¦å—ï¼ŸGreffç­‰äººï¼ˆ2015ï¼‰å¯¹æµè¡Œå˜ä½“è¿›è¡Œäº†å¾ˆå¥½çš„æ¯”è¾ƒï¼Œå‘ç°å®ƒä»¬çš„è¡¨ç°å‡ ä¹ç›¸åŒã€‚Jozefowiczç­‰äººï¼ˆ2015ï¼‰æµ‹è¯•äº†è¶…è¿‡ä¸€ä¸‡ç§RNNæ¶æ„ï¼Œå‘ç°å…¶ä¸­ä¸€äº›åœ¨æŸäº›ä»»åŠ¡ä¸Šçš„è¡¨ç°æ¯”LSTMsæ›´å¥½ã€‚ Conclusion ç»“è®ºEarlier, I mentioned the remarkable results people are achieving with RNNs. Essentially all of these are achieved using LSTMs. They really work a lot better for most tasks!å‰é¢ï¼Œæˆ‘æåˆ°äº†äººä»¬ç”¨é€’å½’ç¥ç»ç½‘ç»œï¼ˆRNNsï¼‰å–å¾—çš„æ˜¾è‘—æˆæœã€‚åŸºæœ¬ä¸Šæ‰€æœ‰è¿™äº›æˆæœéƒ½æ˜¯ä½¿ç”¨LSTMså®ç°çš„ã€‚å¯¹äºå¤§å¤šæ•°ä»»åŠ¡ï¼ŒLSTMsçš„æ•ˆæœç¡®å®è¦å¥½å¾—å¤šï¼ Written down as a set of equations, LSTMs look pretty intimidating. Hopefully, walking through them step by step in this essay has made them a bit more approachable.ä½œä¸ºä¸€ç»„æ–¹ç¨‹å†™ä¸‹æ¥ï¼ŒLSTMsçœ‹èµ·æ¥ç›¸å½“ä»¤äººç”Ÿç•ã€‚å¸Œæœ›é€šè¿‡åœ¨æœ¬æ–‡ä¸­ä¸€æ­¥ä¸€æ­¥åœ°è®²è§£å®ƒä»¬ï¼Œä½¿å®ƒä»¬å˜å¾—æ›´å®¹æ˜“ç†è§£ã€‚ LSTMs were a big step in what we can accomplish with RNNs. Itâ€™s natural to wonder: is there another big step? A common opinion among researchers is: â€œYes! There is a next step and itâ€™s attention!â€ The idea is to let every step of an RNN pick information to look at from some larger collection of information. For example, if you are using an RNN to create a caption describing an image, it might pick a part of the image to look at for every word it outputs. In fact, Xu, _et al._ (2015) do exactly this â€“ it might be a fun starting point if you want to explore attention! Thereâ€™s been a number of really exciting results using attention, and it seems like a lot more are around the cornerâ€¦LSTMsæ˜¯æˆ‘ä»¬ç”¨RNNsèƒ½å®ç°çš„ä¸€ä¸ªå¤§è¿›æ­¥ã€‚å¾ˆè‡ªç„¶åœ°ä¼šæœ‰äººé—®ï¼šè¿˜æœ‰å¦ä¸€ä¸ªå¤§è¿›æ­¥å—ï¼Ÿç ”ç©¶äººå‘˜çš„ä¸€ä¸ªæ™®éçœ‹æ³•æ˜¯ï¼šâ€œæ˜¯çš„ï¼ä¸‹ä¸€ä¸ªè¿›æ­¥æ˜¯æ³¨æ„åŠ›æœºåˆ¶ï¼â€è¿™ä¸ªæƒ³æ³•æ˜¯è®©RNNçš„æ¯ä¸€æ­¥éƒ½ä»ä¸€äº›æ›´å¤§çš„ä¿¡æ¯é›†åˆä¸­é€‰æ‹©è¦çœ‹çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ä½¿ç”¨RNNæ¥åˆ›å»ºæè¿°å›¾åƒçš„æ ‡é¢˜ï¼Œå®ƒå¯èƒ½ä¼šä¸ºå®ƒè¾“å‡ºçš„æ¯ä¸ªå•è¯é€‰æ‹©å›¾åƒçš„ä¸€éƒ¨åˆ†ã€‚äº‹å®ä¸Šï¼ŒXuç­‰äººï¼ˆ2015ï¼‰æ­£æ˜¯è¿™æ ·åšçš„â€”â€”å¦‚æœä½ æƒ³æ¢ç´¢æ³¨æ„åŠ›æœºåˆ¶ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªæœ‰è¶£çš„èµ·ç‚¹ï¼ä½¿ç”¨æ³¨æ„åŠ›æœºåˆ¶å·²ç»å–å¾—äº†è®¸å¤šéå¸¸ä»¤äººå…´å¥‹çš„æˆæœï¼Œä¼¼ä¹è¿˜ä¼šæœ‰æ›´å¤šçš„æˆæœå³å°†åˆ°æ¥â€¦â€¦ Attention isnâ€™t the only exciting thread in RNN research. For example, Grid LSTMs by Kalchbrenner, _et al._ (2015) seem extremely promising. Work using RNNs in generative models â€“ such as Gregor, _et al._ (2015), Chung, _et al._ (2015), or Bayer &amp; Osendorfer (2015) â€“ also seems very interesting. The last few years have been an exciting time for recurrent neural networks, and the coming ones promise to only be more so!æ³¨æ„åŠ›æœºåˆ¶å¹¶ä¸æ˜¯RNNç ”ç©¶ä¸­å”¯ä¸€ä»¤äººå…´å¥‹çš„æ–¹å‘ã€‚ä¾‹å¦‚ï¼ŒKalchbrennerç­‰äººï¼ˆ2015ï¼‰çš„Grid LSTMsçœ‹èµ·æ¥éå¸¸æœ‰å‰é€”ã€‚åœ¨ç”Ÿæˆæ¨¡å‹ä¸­ä½¿ç”¨RNNçš„å·¥ä½œâ€”â€”ä¾‹å¦‚Gregorç­‰äººï¼ˆ2015ï¼‰ã€Chungç­‰äººï¼ˆ2015ï¼‰æˆ–Bayerå’ŒOsendorferï¼ˆ2015ï¼‰çš„å·¥ä½œâ€”â€”ä¹Ÿéå¸¸æœ‰è¶£ã€‚è¿‡å»å‡ å¹´æ˜¯é€’å½’ç¥ç»ç½‘ç»œçš„æ¿€åŠ¨äººå¿ƒçš„æ—¶æœŸï¼Œæœªæ¥å‡ å¹´åªä¼šæ›´åŠ æ¿€åŠ¨äººå¿ƒï¼ Acknowledgments ç¡®è®¤Iâ€™m grateful to a number of people for helping me better understand LSTMs, commenting on the visualizations, and providing feedback on this post.æˆ‘æ„Ÿè°¢è®¸å¤šäººå¸®åŠ©æˆ‘æ›´å¥½åœ°ç†è§£ LSTMï¼Œå¯¹å¯è§†åŒ–è¿›è¡Œè¯„è®ºï¼Œå¹¶å¯¹è¿™ç¯‡æ–‡ç« æä¾›åé¦ˆã€‚ Iâ€™m very grateful to my colleagues at Google for their helpful feedback, especially Oriol Vinyals, Greg Corrado, Jon Shlens, Luke Vilnis, and Ilya Sutskever. Iâ€™m also thankful to many other friends and colleagues for taking the time to help me, including Dario Amodei, and Jacob Steinhardt. Iâ€™m especially thankful to Kyunghyun Cho for extremely thoughtful correspondence about my diagrams.æˆ‘éå¸¸æ„Ÿè°¢ Google åŒäº‹æä¾›çš„æœ‰ç›Šåé¦ˆï¼Œå°¤å…¶æ˜¯ Oriol Vinyalsã€Greg Corradoã€Jon Shlensã€Luke Villnis å’Œ Ilya Sutskeverã€‚æˆ‘è¿˜è¦æ„Ÿè°¢è®¸å¤šå…¶ä»–æœ‹å‹å’ŒåŒäº‹æŠ½å‡ºæ—¶é—´å¸®åŠ©æˆ‘ï¼ŒåŒ…æ‹¬ Dario Amodei å’Œ Jacob Steinhardtã€‚æˆ‘ç‰¹åˆ«æ„Ÿè°¢ Kyunghyun Cho å¯¹æˆ‘çš„å›¾è¡¨è¿›è¡Œäº†éå¸¸å‘¨åˆ°çš„é€šä¿¡ã€‚ Before this post, I practiced explaining LSTMs during two seminar series I taught on neural networks. Thanks to everyone who participated in those for their patience with me, and for their feedback.åœ¨è¿™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œæˆ‘åœ¨æˆ‘æ•™æˆçš„å…³äºç¥ç»ç½‘ç»œçš„ä¸¤ä¸ªç³»åˆ—ç ”è®¨ä¼šä¸Šç»ƒä¹ äº†è§£é‡Š LSTMã€‚æ„Ÿè°¢æ‰€æœ‰å‚ä¸æ´»åŠ¨çš„äººå¯¹æˆ‘çš„è€å¿ƒå’Œåé¦ˆã€‚ æ³¨é‡Š-å¦‚ä½•ç†è§£é—¨æ§ç»“æ„çš„è®¡ç®—æ ¹æ®å‰é¢çš„æ–‡ç« ï¼Œ æˆ‘ä»¬å·²ç»çŸ¥é“åŸºç¡€ ç¥ç»ç½‘ç»œå’Œ åŸºç¡€RNN ä¸­ï¼Œæ•°æ®ä»è¾“å…¥å±‚åˆ°éšè—å±‚åˆ°è¾“å‡ºå±‚çš„è®¡ç®—ï¼Œè¿™é‡Œå†å¤ä¹ ä¸€ä¸‹ åŸºç¡€ç¥ç»ç½‘ç»œéšè—å±‚$h_tâ€‹=f(W_{xhâ€‹}x_tâ€‹+b_hâ€‹)$ $x_t$â€‹ï¼šå½“å‰è¾“å…¥ $W_{xh}$ï¼šè¾“å…¥å±‚åˆ°éšè—å±‚çš„æƒé‡çŸ©é˜µ $b_h$â€‹ï¼šåç½® $f$ï¼šæ¿€æ´»å‡½æ•°ï¼ˆå¦‚tanhæˆ–ReLUï¼‰ è®¡ç®—éšè—çŠ¶æ€åˆ†ä¸º2ä¸ªæ­¥éª¤ è®¡ç®—éšè—å±‚çš„è¾“å…¥åŠ æƒå’Œï¼š åº”ç”¨æ¿€æ´»å‡½æ•°ï¼Œè®¡ç®—éšè—å±‚çš„è¾“å‡ºåŸºç¡€RNN RNNçš„éšè—å±‚å…·æœ‰å¾ªç¯è¿æ¥ï¼Œå³å¤šäº†ä¸€ä¸ªéšè—å±‚åˆ°éšè—å±‚çš„æƒé‡çŸ©é˜µå‚ä¸è®¡ç®— ï¼Œä½¿å¾—æ¯ä¸ªéšè—çŠ¶æ€ä¾èµ–äºå‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€å’Œå½“å‰æ—¶é—´æ­¥çš„è¾“å…¥ã€‚å…¬å¼å¦‚ä¸‹ï¼š$h_tâ€‹=f(W_{hh}â€‹h_{tâˆ’1}â€‹+W_{xhâ€‹}x_tâ€‹+b_hâ€‹)$ $h_tâ€‹$ï¼šå½“å‰æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ $h_{t-1}$ï¼šå‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ $x_t$â€‹ï¼šå½“å‰æ—¶é—´æ­¥çš„è¾“å…¥ $W_{hh}$â€‹ï¼šéšè—çŠ¶æ€åˆ°éšè—çŠ¶æ€çš„æƒé‡çŸ©é˜µ $W_{xh}$ï¼šè¾“å…¥åˆ°éšè—çŠ¶æ€çš„æƒé‡çŸ©é˜µ $b_h$â€‹ï¼šåç½® $f$ï¼šæ¿€æ´»å‡½æ•°ï¼ˆå¦‚tanhæˆ–ReLUï¼‰ ä»ä¸Šé¢æ–‡ç« ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ ä¸è®ºè®¡ç®—è¿‡ç¨‹åœ¨å¤æ‚ï¼Œéƒ½æ˜¯è¦æ ¹æ®è¾“å…¥æ±‚è¾“å‡ºã€‚ã€‚ è€Œåœ¨LSTM ä¸­ï¼Œ å¤æ‚çš„ç‚¹åœ¨äºã€‚éšè—å±‚çš„è®¡ç®—ç”±ç®€å•çš„éšè—å±‚-éšè—å±‚æƒé‡çŸ©é˜µå‚ä¸è®¡ç®— æ‹†åˆ†æˆäº†å¤šä¸ªæ­¥éª¤ LSTM1. é—å¿˜é—¨ï¼ˆForget Gateï¼‰é—å¿˜é—¨æ§åˆ¶å•å…ƒçŠ¶æ€ä¸­å“ªäº›ä¿¡æ¯éœ€è¦è¢«ä¿ç•™æˆ–ä¸¢å¼ƒã€‚é—å¿˜é—¨æ¥æ”¶å½“å‰æ—¶é—´æ­¥çš„è¾“å…¥ $x_t$å’Œå‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ $h_{t-1}$ï¼Œé€šè¿‡ä¸€ä¸ª$Sigmoid$å‡½æ•°è®¡ç®—å¾—åˆ°ä¸€ä¸ªä»‹äº0å’Œ1ä¹‹é—´çš„æ ‡é‡ï¼ˆæˆ–å‘é‡ï¼‰ï¼Œç”¨äºç¼©æ”¾å‰ä¸€æ—¶é—´æ­¥çš„ç»†èƒçŠ¶æ€ã€‚ å…¬å¼å¦‚ä¸‹ï¼š $f_t = \\sigma(W_f \\cdot [h_{t-1}, x_t] + b_f)$å¦‚æœæŠŠå±‚çº§å…³ç³»ä¹Ÿåœ¨å…¬å¼ä¸­ä½“ç°å‡ºæ¥ï¼Œè¯¥å…¬å¼å¯ä»¥ç»†åŒ–æˆå¦‚ä¸‹æ ¼å¼ï¼š$f_t^l = \\sigma(W_f \\cdot [h_{t-1}^l, x_t^{l-1}] + b_f)$ å…¶ä¸­ $x$ ä¹Ÿå¯ä»¥æ›¿æ¢æˆå…¶ä»–å˜é‡ï¼Œåªè¦æ˜¯ä»£è¡¨å½“å‰æ—¶é—´æ­¥çš„è¾“å…¥å³å¯ã€‚ä¾‹å¦‚åœ¨ RECURRENT NEURAL NETWORK REGULARIZATION è¯¥å…¬å¼å°±è¡¨ç¤ºæˆäº† $f_t^l = \\sigma(W_f \\cdot [h_{t-1}^l, h_t^{l-1}] + b_f)$ $[h_t, x_{t-1}]$æˆ–è€…$[h_t^{l-1}, h_{t-1}^l]$è¡¨ç¤ºå°†å½“å‰è¾“å…¥å’Œå‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€å‘é‡æ‹¼æ¥æˆä¸€ä¸ªå‘é‡ã€‚ $W_fâ€‹$ æ˜¯è¯¥é—å¿˜é—¨çš„æƒé‡çŸ©é˜µã€‚ $b_f$â€‹ æ˜¯åç½®å‘é‡ã€‚ $\\sigma$ æ˜¯$sigmoid$ éçº¿æ€§æ¿€æ´»å‡½æ•°ï¼Œè¾“å‡ºèŒƒå›´åœ¨0åˆ°1ä¹‹é—´ã€‚ 2. è¾“å…¥é—¨ï¼ˆInput Gateï¼‰è¾“å…¥é—¨æ§åˆ¶æ–°ä¿¡æ¯å†™å…¥å•å…ƒçŠ¶æ€çš„è¿‡ç¨‹ã€‚è¾“å…¥é—¨åŒæ ·æ¥æ”¶å½“å‰æ—¶é—´æ­¥çš„è¾“å…¥ $x_t$å’Œå‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ $h_{t-1}$ï¼Œå¹¶é€šè¿‡Sigmoidå‡½æ•°ç”Ÿæˆä¸€ä¸ªä»‹äº0å’Œ1ä¹‹é—´çš„æ ‡é‡ï¼Œè¡¨ç¤ºå…è®¸å¤šå°‘æ–°ä¿¡æ¯è¿›å…¥ç»†èƒçŠ¶æ€ã€‚0è¡¨ç¤ºå®Œå…¨ä¸å…è®¸æ–°ä¿¡æ¯è¿›å…¥ï¼Œ1è¡¨ç¤ºå®Œå…¨å…è®¸æ–°ä¿¡æ¯è¿›å…¥ã€‚$tanh$å±‚ç”Ÿæˆå€™é€‰å•å…ƒçŠ¶æ€ã€‚ å…¬å¼å¦‚ä¸‹ï¼š$i_t = \\sigma(W_i \\cdot [h_{t-1}, x_t] + b_i)$ $\\tilde{C}_t = \\tanh(W_C \\cdot [h_{t-1}, x_t] + b_C)$ $W_iâ€‹$ï¼šè¾“å…¥é—¨çš„æƒé‡çŸ©é˜µï¼Œç”¨äºå°†å‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€å’Œå½“å‰æ—¶é—´æ­¥çš„è¾“å…¥è¿›è¡Œçº¿æ€§å˜æ¢ã€‚$W_Câ€‹$ï¼šå€™é€‰ç»†èƒçŠ¶æ€çš„æƒé‡çŸ©é˜µï¼Œç”¨äºå°†å‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€å’Œå½“å‰æ—¶é—´æ­¥çš„è¾“å…¥è¿›è¡Œçº¿æ€§å˜æ¢ã€‚ 3. å•å…ƒçŠ¶æ€ï¼ˆCell Stateï¼‰å•å…ƒçŠ¶æ€ $C_t$â€‹ æ˜¯LSTMå•å…ƒå†…éƒ¨çš„é•¿æœŸè®°å¿†ï¼Œå®ƒåœ¨æ—¶é—´æ­¥ä¹‹é—´å‡ ä¹ç›´æ¥ä¼ é€’ï¼Œé€šè¿‡é—å¿˜é—¨å’Œè¾“å…¥é—¨çš„è°ƒèŠ‚è¿›è¡Œæ›´æ–°ã€‚æ–°çš„å•å…ƒçŠ¶æ€ç”±å‰ä¸€æ—¶é—´æ­¥çš„å•å…ƒçŠ¶æ€ä¹˜ä»¥é—å¿˜é—¨çš„è¾“å‡ºåŠ ä¸Šè¾“å…¥é—¨è¾“å‡ºå’Œå€™é€‰å€¼çš„ä¹˜ç§¯å¾—åˆ°ã€‚ å…¬å¼å¦‚ä¸‹ï¼š$C_t = f_t \\cdot C_{t-1} + i_t \\cdot \\tilde{C}_t$ 4. è¾“å‡ºé—¨ï¼ˆOutput Gateï¼‰- å¾—åˆ°éšè—çŠ¶æ€è¾“å‡ºé—¨å†³å®šå“ªäº›ä¿¡æ¯ä»ç»†èƒçŠ¶æ€ä¼ é€’åˆ°éšè—çŠ¶æ€ï¼ˆLSTMå•å…ƒçš„è¾“å‡ºï¼‰ã€‚è¾“å‡ºé—¨é€šè¿‡Sigmoidå‡½æ•°å†³å®šå“ªäº›ä¿¡æ¯å°†è¢«è¾“å‡ºï¼Œå¹¶å°†ç»†èƒçŠ¶æ€é€šè¿‡Tanhå±‚å¤„ç†åä¹˜ä»¥è¯¥è¾“å‡ºã€‚ å…¬å¼å¦‚ä¸‹ï¼š$o_t = \\sigma(W_o \\cdot [h_{t-1}, x_t] + b_o)$$h_t = o_t \\cdot \\tanh(C_t)$","tags":["AI","ç¥ç»ç½‘ç»œ","Ilya sutskeverâ€˜s 30  papers"]},{"title":"RECURRENT NEURAL NETWORK REGULARIZATION","path":"/7057a5e3/","content":"RECURRENT NEURAL NETWORK REGULARIZATION ABSTRACT æ‘˜è¦We present a simple regularization technique for Recurrent Neural Networks (RNNs) with Long Short-Term Memory (LSTM) units. Dropout, the most suc- cessful technique for regularizing neural networks, does not work well with RNNs and LSTMs. In this paper, we show how to correctly apply dropout to LSTMs, and show that it substantially reduces overfitting on a variety of tasks. These tasks include language modeling, speech recognition, image caption generation, and machine translation.æˆ‘ä»¬æå‡ºäº†ä¸€ç§ç”¨äºé•¿çŸ­æœŸè®°å¿†ï¼ˆLSTMï¼‰å•å…ƒçš„å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰çš„ç®€å•æ­£åˆ™åŒ–æŠ€æœ¯ã€‚æœ€æˆåŠŸçš„æ­£åˆ™åŒ–ç¥ç»ç½‘ç»œæŠ€æœ¯â€”â€”Dropoutï¼Œåœ¨RNNå’ŒLSTMä¸Šæ•ˆæœä¸å¥½ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•æ­£ç¡®åœ°å°†Dropoutåº”ç”¨äºLSTMï¼Œå¹¶è¯æ˜å®ƒåœ¨å„ç§ä»»åŠ¡ä¸Šæ˜¾è‘—å‡å°‘äº†è¿‡æ‹Ÿåˆã€‚è¿™äº›ä»»åŠ¡åŒ…æ‹¬è¯­è¨€å»ºæ¨¡ã€è¯­éŸ³è¯†åˆ«ã€å›¾åƒæè¿°ç”Ÿæˆå’Œæœºå™¨ç¿»è¯‘ã€‚ 1 INTRODUCTION å¼•è¨€The Recurrent Neural Network (RNN) is neural sequence model that achieves state of the art per- formance on important tasks that include language modeling Mikolov (2012), speech recognition Graves et al. (2013), and machine translation Kalchbrenner &amp; Blunsom (2013). It is known that successful applications of neural networks require good regularization. Unfortunately, dropout Srivastava (2013), the most powerful regularization method for feedforward neural networks, does not work well with RNNs. As a result, practical applications of RNNs often use models that are too small because large RNNs tend to overfit. Existing regularization methods give relatively small improvements for RNNs Graves (2013). In this work, we show that dropout, when correctly used, greatly reduces overfitting in LSTMs, and evaluate it on three different problems. The code for this work can be found in https://github.com/wojzaremba/lstm. é€’å½’ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰æ˜¯ä¸€ç§ç¥ç»åºåˆ—æ¨¡å‹ï¼Œå¯åœ¨é‡è¦ä»»åŠ¡ä¸Šå®ç°æœ€å…ˆè¿›çš„æ€§èƒ½ï¼ŒåŒ…æ‹¬è¯­è¨€å»ºæ¨¡Mikolovï¼ˆ2012ï¼‰ï¼Œè¯­éŸ³è¯†åˆ«Gravesç­‰äººï¼ˆ2013ï¼‰å’Œæœºå™¨ç¿»è¯‘Kalchbrenner&amp;Blunsomï¼ˆ2013ï¼‰ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œç¥ç»ç½‘ç»œçš„æˆåŠŸåº”ç”¨éœ€è¦è‰¯å¥½çš„æ­£åˆ™åŒ–ã€‚ä¸å¹¸çš„æ˜¯ï¼Œdropout Srivastava ï¼ˆ2013ï¼‰ æ˜¯å‰é¦ˆç¥ç»ç½‘ç»œæœ€å¼ºå¤§çš„æ­£åˆ™åŒ–æ–¹æ³•ï¼Œä½†ä¸èƒ½å¾ˆå¥½åœ°ç”¨äº RNNã€‚å› æ­¤ï¼ŒRNN çš„å®é™…åº”ç”¨é€šå¸¸ä½¿ç”¨å¤ªå°çš„æ¨¡å‹ï¼Œå› ä¸ºå¤§å‹ RNN å¾€å¾€ä¼šè¿‡åº¦æ‹Ÿåˆã€‚ç°æœ‰çš„æ­£åˆ™åŒ–æ–¹æ³•å¯¹RNNs Gravesï¼ˆ2013ï¼‰è¿›è¡Œäº†ç›¸å¯¹è¾ƒå°çš„æ”¹è¿›ã€‚åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œæˆ‘ä»¬è¡¨æ˜ï¼Œå¦‚æœæ­£ç¡®ä½¿ç”¨ï¼Œå‹å·®å¯ä»¥å¤§å¤§å‡å°‘LSTMä¸­çš„è¿‡æ‹Ÿåˆï¼Œå¹¶åœ¨ä¸‰ä¸ªä¸åŒçš„é—®é¢˜ä¸Šå¯¹å…¶è¿›è¡Œè¯„ä¼°ã€‚ æ­¤å·¥ä½œçš„ä»£ç å¯ä»¥åœ¨https://github.com/wojzaremba/lstmæ‰¾åˆ°ã€‚ 2 RELATED WORKDropout Srivastava (2013) is a recently introduced regularization method that has been very suc- cessful with feed-forward neural networks. While much work has extended dropout in various ways Wang &amp; Manning (2013); Wan et al. (2013), there has been relatively little research in applying it to RNNs. The only paper on this topic is by Bayer et al. (2013), who focuses on â€œmarginalized dropoutâ€ Wang &amp; Manning (2013), a noiseless deterministic approximation to standard dropout. Bayer et al. (2013) claim that conventional dropout does not work well with RNNs because the re- currence amplifies noise, which in turn hurts learning. In this work, we show that this problem can be fixed by applying dropout to a certain subset of the RNNsâ€™ connections. As a result, RNNs can now also benefit from dropout.Dropout Srivastavaï¼ˆ2013ï¼‰æ˜¯ä¸€ç§æœ€è¿‘å¼•å…¥çš„æ­£åˆ™åŒ–æ–¹æ³•ï¼Œåœ¨å‰é¦ˆç¥ç»ç½‘ç»œä¸­éå¸¸æˆåŠŸã€‚å°½ç®¡å¾ˆå¤šå·¥ä½œä»¥å„ç§æ–¹å¼æ‰©å±•äº†Dropout Wang &amp; Manningï¼ˆ2013ï¼‰ï¼›Wanç­‰ï¼ˆ2013ï¼‰ï¼Œä½†åœ¨RNNä¸Šåº”ç”¨å®ƒçš„ç ”ç©¶ç›¸å¯¹è¾ƒå°‘ã€‚å…³äºè¿™ä¸ªä¸»é¢˜çš„å”¯ä¸€è®ºæ–‡æ˜¯Bayerç­‰äººï¼ˆ2013ï¼‰çš„ï¼Œä»–ä»¬ä¸“æ³¨äºâ€œè¾¹ç¼˜åŒ–Dropoutâ€ Wang &amp; Manningï¼ˆ2013ï¼‰ï¼Œè¿™æ˜¯æ ‡å‡†Dropoutçš„ä¸€ç§æ— å™ªå£°ç¡®å®šæ€§è¿‘ä¼¼ã€‚Bayerç­‰äººï¼ˆ2013ï¼‰è®¤ä¸ºä¼ ç»Ÿçš„Dropoutåœ¨RNNä¸Šæ•ˆæœä¸å¥½ï¼Œå› ä¸ºé€’å½’æ”¾å¤§äº†å™ªå£°ï¼Œè¿›è€Œå½±å“äº†å­¦ä¹ ã€‚åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†é€šè¿‡å°†Dropoutåº”ç”¨äºRNNè¿æ¥çš„æŸä¸ªå­é›†å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å› æ­¤ï¼ŒRNNç°åœ¨ä¹Ÿå¯ä»¥å—ç›ŠäºDropoutã€‚ Independently of our work, Pham et al. (2013) developed the very same RNN regularization method and applied it to handwriting recognition. We rediscovered this method and demonstrated strong empirical results over a wide range of problems. Other work that applied dropout to LSTMs is Pachitariu &amp; Sahani (2013).ç‹¬ç«‹äºæˆ‘ä»¬çš„å·¥ä½œï¼ŒPhamç­‰äººï¼ˆ2013ï¼‰å¼€å‘äº†å®Œå…¨ç›¸åŒçš„RNNæ­£åˆ™åŒ–æ–¹æ³•å¹¶å°†å…¶åº”ç”¨äºæ‰‹å†™è¯†åˆ«ã€‚æˆ‘ä»¬é‡æ–°å‘ç°äº†è¿™ç§æ–¹æ³•ï¼Œå¹¶åœ¨å¹¿æ³›çš„é—®é¢˜ä¸Šå±•ç¤ºäº†å¼ºå¤§çš„å®è¯ç»“æœã€‚å…¶ä»–å°†Dropoutåº”ç”¨äºLSTMçš„å·¥ä½œåŒ…æ‹¬Pachitariu &amp; Sahaniï¼ˆ2013ï¼‰ã€‚ There have been a number of architectural variants of the RNN that perform better on problems with long term dependencies Hochreiter &amp; Schmidhuber (1997); Graves et al. (2009); Cho et al. (2014); Jaeger et al. (2007); KoutnÃ­k et al. (2014); Sundermeyer et al. (2012). In this work, we show how to correctly apply dropout to LSTMs, the most commonly-used RNN variant; this way of applying dropout is likely to work well with other RNN architectures as well. In this paper, we consider the following tasks: language modeling, speech recognition, and machine translation. Language modeling is the first task where RNNs have achieved substantial success Mikolov et al. (2010; 2011); Pascanu et al. (2013). RNNs have also been successfully used for speech recognition Robinson et al. (1996); Graves et al. (2013) and have recently been applied to machine translation, where they are used for language modeling, re-ranking, or phrase modeling Devlin et al. (2014); Kalchbrenner &amp; Blunsom (2013); Cho et al. (2014); Chow et al. (1987); Mikolov et al. (2013).å·²ç»æœ‰è®¸å¤šRNNçš„æ¶æ„å˜ä½“åœ¨å¤„ç†é•¿æœŸä¾èµ–é—®é¢˜ä¸Šè¡¨ç°æ›´å¥½ï¼š Hochreiter &amp; Schmidhuber (1997); Gravesç­‰ï¼ˆ2009ï¼‰ï¼›Choç­‰ï¼ˆ2014ï¼‰ï¼›Jaegerç­‰ï¼ˆ2007ï¼‰ï¼›KoutnÃ­kç­‰ï¼ˆ2014ï¼‰ï¼›Sundermeyerç­‰ï¼ˆ2012ï¼‰ã€‚åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•æ­£ç¡®åœ°å°†dropoutåº”ç”¨äºLSTMï¼Œè¿™æ˜¯æœ€å¸¸ç”¨çš„RNNå˜ä½“ï¼›è¿™ç§åº”ç”¨dropoutçš„æ–¹æ³•ä¹Ÿå¯èƒ½é€‚ç”¨äºå…¶ä»–RNNæ¶æ„ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬è€ƒè™‘äº†ä»¥ä¸‹ä»»åŠ¡ï¼šè¯­è¨€å»ºæ¨¡ã€è¯­éŸ³è¯†åˆ«å’Œæœºå™¨ç¿»è¯‘ã€‚è¯­è¨€å»ºæ¨¡æ˜¯RNNé¦–æ¬¡å–å¾—æ˜¾è‘—æˆåŠŸçš„ä»»åŠ¡ Mikolovç­‰ï¼ˆ2010ï¼›2011ï¼‰ï¼›Pascanuç­‰ï¼ˆ2013ï¼‰ã€‚RNNä¹Ÿå·²æˆåŠŸåº”ç”¨äºè¯­éŸ³è¯†åˆ« Robinsonç­‰ï¼ˆ1996ï¼‰ï¼›Gravesç­‰ï¼ˆ2013ï¼‰ï¼Œå¹¶ä¸”æœ€è¿‘è¢«åº”ç”¨äºæœºå™¨ç¿»è¯‘ï¼Œåœ¨é‚£é‡Œå®ƒä»¬è¢«ç”¨äºè¯­è¨€å»ºæ¨¡ã€é‡æ’åºæˆ–çŸ­è¯­å»ºæ¨¡ Devlinç­‰ï¼ˆ2014ï¼‰ï¼›Kalchbrenner &amp; Blunsomï¼ˆ2013ï¼‰ï¼›Choç­‰ï¼ˆ2014ï¼‰ï¼›Chowç­‰ï¼ˆ1987ï¼‰ï¼›Mikolovç­‰ï¼ˆ2013ï¼‰ã€‚ 3 REGULARIZING RNNS WITH LSTM CELLS ä½¿ç”¨LSTMå•å…ƒå¯¹RNNè¿›è¡Œæ­£åˆ™åŒ–In this section we describe the deep LSTM (Section 3.1). Next, we show how to regularize them (Section 3.2), and explain why our regularization scheme works.åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬æè¿°äº†æ·±åº¦LSTMï¼ˆ3.1èŠ‚ï¼‰ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å±•ç¤ºå¦‚ä½•å¯¹å®ƒä»¬è¿›è¡Œæ­£åˆ™åŒ–ï¼ˆ3.2èŠ‚ï¼‰ï¼Œå¹¶è§£é‡Šæˆ‘ä»¬çš„æ­£åˆ™åŒ–æ–¹æ¡ˆä¸ºä½•æœ‰æ•ˆã€‚ We let subscripts denote timesteps and superscripts denote layers. All our states are n-dimensional. Let $h_t^l \\in \\mathbb{R}^n$ be a hidden state in layer$l$ in timestep $t$. Moreover, let $T_{n,m} : \\mathbb{R}^n \\to \\mathbb{R}^m$be an affine transform ($Wx + b$ for some $W$ and $b$). Let $\\odot$ be element-wise multiplication and let $h_t^0â€‹$ be an input word vector at timestep $k$. We use the activations $h_t^L$â€‹ to predict $y_t$â€‹, since $L$ is the number of layers in our deep LSTM.æˆ‘ä»¬ç”¨ä¸‹æ ‡è¡¨ç¤ºæ—¶é—´æ­¥é•¿ï¼Œç”¨ä¸Šæ ‡è¡¨ç¤ºå±‚æ¬¡ã€‚æˆ‘ä»¬æ‰€æœ‰çš„çŠ¶æ€éƒ½æ˜¯nç»´çš„ã€‚ä»¤$h_t^l \\in \\mathbb{R}^n$ ä¸ºæ—¶é—´æ­¥$t$ä¸­å±‚$l$çš„éšè—çŠ¶æ€ã€‚æ­¤å¤–ï¼Œä»¤$T_{n,m} : \\mathbb{R}^n \\to \\mathbb{R}^m$ä¸ºä»¿å°„å˜æ¢ï¼ˆæŸäº›$W$å’Œ$b$,$Wx + b$ï¼‰ã€‚ä»¤$\\odot$ä¸ºé€å…ƒç´ ä¹˜æ³•ï¼Œå¹¶ä»¤$h_t^0$â€‹ä¸ºæ—¶é—´æ­¥$k$çš„è¾“å…¥è¯å‘é‡ã€‚æˆ‘ä»¬ä½¿ç”¨æ¿€æ´»å€¼$h_t^L$â€‹æ¥é¢„æµ‹$y_tâ€‹$ï¼Œå› ä¸º$L$æ˜¯æˆ‘ä»¬æ·±åº¦LSTMçš„å±‚æ•°ã€‚ 3.1 LONG-SHORT TERM MEMORY UNITS é•¿çŸ­æœŸè®°å¿†å•å…ƒThe RNN dynamics can be described using deterministic transitions from previous to current hidden states. The deterministic state transition is a functionRNNçš„åŠ¨æ€å¯ä»¥ç”¨ä»å…ˆå‰éšè—çŠ¶æ€åˆ°å½“å‰éšè—çŠ¶æ€çš„ç¡®å®šæ€§è½¬æ¢æ¥æè¿°ã€‚ç¡®å®šæ€§çŠ¶æ€è½¬æ¢æ˜¯ä¸€ä¸ªå‡½æ•° RNN : $h_t^{l-1}â€‹$, $h_{t-1}^l \\rightarrow h_t^l$ For classical RNNs, this function is given by$h_t^l = f(T_{n,n} h_t^{l-1} + T_{n,n} h_{t-1}^l), where f \\in \\{\\text{sigm, tanh}\\}$ The LSTM has complicated dynamics that allow it to easily â€œmemorizeâ€ information for an extended number of timesteps. The â€œlong termâ€ memory is stored in a vector of memory cells $c_t^l \\in \\mathbb{R}^n$. Although many LSTM architectures that differ in their connectivity structure and activation functions, all LSTM architectures have explicit memory cells for storing information for long periods of time. The LSTM can decide to overwrite the memory cell, retrieve it, or keep it for the next time step. The LSTM architecture used in our experiments is given by the following equations Graves et al. (2013):LSTMå…·æœ‰å¤æ‚çš„åŠ¨æ€ï¼Œå…è®¸å®ƒè½»æ¾åœ°â€œè®°ä½â€å¤šä¸ªæ—¶é—´æ­¥é•¿çš„ä¿¡æ¯ã€‚â€œé•¿æœŸâ€è®°å¿†å­˜å‚¨åœ¨è®°å¿†å•å…ƒå‘é‡$c_t^l \\in \\mathbb{R}^n$ä¸­ã€‚å°½ç®¡è®¸å¤šLSTMæ¶æ„åœ¨è¿æ¥ç»“æ„å’Œæ¿€æ´»å‡½æ•°ä¸Šæœ‰æ‰€ä¸åŒï¼Œä½†æ‰€æœ‰LSTMæ¶æ„éƒ½æœ‰æ˜ç¡®çš„è®°å¿†å•å…ƒç”¨äºé•¿æ—¶é—´å­˜å‚¨ä¿¡æ¯ã€‚LSTMå¯ä»¥å†³å®šè¦†ç›–è®°å¿†å•å…ƒã€æ£€ç´¢æˆ–è€…åœ¨ä¸‹ä¸€ä¸ªæ—¶é—´æ­¥ä¸­ä¿ç•™å®ƒã€‚æˆ‘ä»¬å®éªŒä¸­ä½¿ç”¨çš„LSTMæ¶æ„ç”±ä»¥ä¸‹æ–¹ç¨‹ç»™å‡º Gravesç­‰ï¼ˆ2013ï¼‰ï¼š LSTM : $h_t^{l-1}$, $h_{t-1}^l$, $c_{t-1}^l \\rightarrow h_t^l$â€‹, $c_t^l$ $\\left( \\begin{array}{c} i \\ f \\ o \\ g \\end{array} \\right) = \\left( \\begin{array}{c} \\text{sigm} \\ \\text{sigm} \\ \\text{sigm} \\ \\text{tanh} \\end{array} \\right) T_{2n,4n} \\left( \\begin{array}{c} h_{t}^{l-1} \\ h_{t-1}^{l} \\end{array} \\right)â€‹$ $c_t^l = f \\odot c_{t-1}^l + i \\odot g$ $h_t^l = o \\odot \\text{tanh}(c_t^l)$In these equations, sigm and tanh are applied element-wise. Figure 1 illustrates the LSTM equations.åœ¨è¿™äº›æ–¹ç¨‹ä¸­ï¼Œsigmå’Œtanhé€å…ƒç´ åº”ç”¨ã€‚å›¾1å±•ç¤ºäº†LSTMæ–¹ç¨‹ 3.2 REGULARIZATION WITH DROPOUTThe main contribution of this paper is a recipe for applying dropout to LSTMs in a way that success-fully reduces overfitting. The main idea is to apply the dropout operator only to the non-recurrentæœ¬æ–‡çš„ä¸»è¦è´¡çŒ®æ˜¯æä¾›äº†ä¸€ç§å°†dropoutåº”ç”¨äºLSTMçš„æ–¹æ³•ï¼Œä»è€ŒæˆåŠŸåœ°å‡å°‘äº†è¿‡æ‹Ÿåˆã€‚ä¸»è¦æ€æƒ³æ˜¯ä»…å°†dropoutæ“ä½œç¬¦åº”ç”¨äºéé€’å½’è¿æ¥ã€‚Figure 1: A graphical representation of LSTM memory cells used in this paper (there are minor differences in comparison to Graves (2013)).å›¾1ï¼šæœ¬æ–‡ä¸­ä½¿ç”¨çš„LSTMè®°å¿†å•å…ƒçš„å›¾å½¢è¡¨ç¤ºï¼ˆä¸Gravesï¼ˆ2013ï¼‰ç›¸æ¯”æœ‰ç»†å¾®å·®åˆ«ï¼‰ã€‚ Figure 2: Regularized multilayer RNN. The dashed arrows indicate connections where dropout is applied, and the solid lines indicate connections where dropout is not applied.å›¾2ï¼šæ­£åˆ™åŒ–çš„å¤šå±‚RNNã€‚è™šçº¿ç®­å¤´è¡¨ç¤ºåº”ç”¨äº†dropoutçš„è¿æ¥ï¼Œå®çº¿è¡¨ç¤ºæœªåº”ç”¨dropoutçš„è¿æ¥ã€‚âš ï¸ï¼š x è¡¨ç¤ºè¾“å…¥å±‚ï¼Œ y è¡¨ç¤ºè¾“å‡ºå±‚ connections (Figure 2). The following equation describes it more precisely, where D is the dropoutoperator that sets a random subset of its argument to zero:è¿æ¥ï¼ˆå›¾2ï¼‰ã€‚ä»¥ä¸‹æ–¹ç¨‹æ›´å‡†ç¡®åœ°æè¿°äº†è¿™ä¸€ç‚¹ï¼Œå…¶ä¸­ $D$ æ˜¯å°†å…¶å‚æ•°çš„éšæœºå­é›†è®¾ç½®ä¸ºé›¶çš„dropoutæ“ä½œç¬¦ï¼š $\\left( \\begin{array}{c} i \\ f \\ o \\ g \\end{array} \\right) = \\left( \\begin{array}{c} \\text{sigm} \\ \\text{sigm} \\ \\text{sigm} \\ \\text{tanh} \\end{array} \\right) T_{2n,4n} \\left( \\begin{array}{c} {D}(h_{t}^{l-1}) \\ h_{t-1}^{l} \\end{array} \\right)â€‹$ $c_t^l = f \\odot c_{t-1}^l + i \\odot g$ $h_t^l = o \\odot \\text{tanh}(c_t^l)$ Our method works as follows. The dropout operator corrupts the information carried by the units,forcing them to perform their intermediate computations more robustly. At the same time, we do not want to erase all the information from the units. It is especially important that the units rememberevents that occurred many timesteps in the past. Figure 3 shows how information could flow from an event that occurred at timestep t âˆ’ 2 to the prediction in timestep t + 2 in our implementation of dropout. We can see that the information is corrupted by the dropout operator exactly L + 1 times,æˆ‘ä»¬çš„æ–¹æ³•å¦‚ä¸‹ã€‚dropout è¿ç®—ç¬¦ä¼šç ´åå•å…ƒæºå¸¦çš„ä¿¡æ¯ï¼Œè¿«ä½¿å®ƒä»¬æ›´ç¨³å¥åœ°æ‰§è¡Œä¸­é—´è®¡ç®—ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¸æƒ³æŠ¹å»å•å…ƒçš„æ‰€æœ‰ä¿¡æ¯ã€‚ç‰¹åˆ«é‡è¦çš„æ˜¯ï¼Œå•å…ƒéœ€è¦è®°ä½è®¸å¤šæ—¶é—´æ­¥é•¿ä¹‹å‰å‘ç”Ÿçš„äº‹ä»¶ã€‚å›¾3æ˜¾ç¤ºäº†åœ¨æˆ‘ä»¬å®ç°çš„dropoutä¸­ï¼Œä¿¡æ¯å¦‚ä½•ä»æ—¶é—´æ­¥ $t-2$ ä¼ é€’åˆ°æ—¶é—´æ­¥ $t+2$ çš„é¢„æµ‹ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¿¡æ¯æ°å¥½è¢«dropoutæ“ä½œç¬¦ç ´åäº† $L+1$ æ¬¡ã€‚ Figure 3: The thick line shows a typical path of information flow in the LSTM. The information is affected by dropout L + 1 times, where L is depth of network.å›¾ 3ï¼šç²—çº¿æ˜¾ç¤ºäº† LSTM ä¸­ä¿¡æ¯æµçš„å…¸å‹è·¯å¾„ã€‚ä¿¡æ¯å— L + 1 æ¬¡çš„dropoutå½±å“ï¼Œå…¶ä¸­ L æ˜¯ç½‘ç»œæ·±åº¦ã€‚ Figure 4: Some interesting samples drawn from a large regularized model conditioned on â€œThe meaning of life isâ€. We have removed â€œunkâ€, â€œNâ€, â€œ$â€ from the set of permissible words.å›¾4ï¼šä»ä¸€ä¸ªä»¥â€œThe meaning of life isâ€ä¸ºæ¡ä»¶çš„å¤§å‹æ­£åˆ™åŒ–æ¨¡å‹ä¸­æŠ½å–çš„ä¸€äº›æœ‰è¶£æ ·æœ¬ã€‚æˆ‘ä»¬å·²ç»ä»å…è®¸çš„å•è¯é›†ä¸­ç§»é™¤äº†â€œunkâ€ã€â€œNâ€ã€â€œ$â€ã€‚ and this number is independent of the number of timesteps traversed by the information. Standard dropout perturbs the recurrent connections, which makes it difficult for the LSTM to learn to store information for long periods of time. By not using dropout on the recurrent connections, the LSTM can benefit from dropout regularization without sacrificing its valuable memorization ability.è¿™ä¸ªæ•°å­—ä¸ä¿¡æ¯ç»è¿‡çš„æ—¶é—´æ­¥æ•°æ— å…³ã€‚æ ‡å‡†çš„dropoutä¼šæ‰°ä¹±é€’å½’è¿æ¥ï¼Œè¿™ä½¿å¾—LSTMéš¾ä»¥å­¦ä¹ é•¿æ—¶é—´å­˜å‚¨ä¿¡æ¯ã€‚é€šè¿‡ä¸åœ¨é€’å½’è¿æ¥ä¸Šä½¿ç”¨dropoutï¼ŒLSTMå¯ä»¥ä»dropoutæ­£åˆ™åŒ–ä¸­å—ç›Šï¼Œè€Œä¸ç‰ºç‰²å…¶å®è´µçš„è®°å¿†èƒ½åŠ›ã€‚ 4 EXPERIMENTS å®éªŒWe present results in three domains: language modeling (Section 4.1), speech recognition (Section 4.2), machine translation (Section 4.3), and image caption generation (Section 4.4).æˆ‘ä»¬åœ¨ä¸‰ä¸ªé¢†åŸŸä¸­å±•ç¤ºäº†ç»“æœï¼šè¯­è¨€å»ºæ¨¡ï¼ˆç¬¬4.1èŠ‚ï¼‰ã€è¯­éŸ³è¯†åˆ«ï¼ˆç¬¬4.2èŠ‚ï¼‰ã€æœºå™¨ç¿»è¯‘ï¼ˆç¬¬4.3èŠ‚ï¼‰å’Œå›¾åƒæè¿°ç”Ÿæˆï¼ˆç¬¬4.4èŠ‚ï¼‰ã€‚ 4.1 LANGUAGE MODELING è¯­è¨€å»ºæ¨¡We conducted word-level prediction experiments on the Penn Tree Bank (PTB) dataset Marcus et al. (1993), which consists of 929k training words, 73k validation words, and 82k test words. It has 10k words in its vocabulary. We downloaded it from Tomas Mikolovâ€™s webpageâ€ . We trained regularized LSTMs of two sizes; these are denoted the medium LSTM and large LSTM. Both LSTMs have two layers and are unrolled for 35 steps. We initialize the hidden states to zero. We then use the final hidden states of the current minibatch as the initial hidden state of the subsequent minibatch (successive minibatches sequentially traverse the training set). The size of each minibatch is 20.æˆ‘ä»¬åœ¨Penn Tree Bank (PTB)æ•°æ®é›†ä¸Šè¿›è¡Œäº†è¯çº§é¢„æµ‹å®éªŒï¼Œè¯¥æ•°æ®é›†åŒ…æ‹¬92.9ä¸‡ä¸ªè®­ç»ƒè¯ã€7.3ä¸‡ä¸ªéªŒè¯è¯å’Œ8.2ä¸‡ä¸ªæµ‹è¯•è¯ã€‚å…¶è¯æ±‡è¡¨æœ‰1ä¸‡ä¸ªå•è¯ã€‚æˆ‘ä»¬ä»Tomas Mikolovçš„ç½‘é¡µä¸‹è½½äº†è¯¥æ•°æ®é›†ã€‚æˆ‘ä»¬è®­ç»ƒäº†ä¸¤ç§è§„æ¨¡çš„æ­£åˆ™åŒ–LSTMï¼›å®ƒä»¬åˆ†åˆ«è¢«ç§°ä¸ºä¸­å‹LSTMå’Œå¤§å‹LSTMã€‚ä¸¤ä¸ªLSTMéƒ½æœ‰ä¸¤å±‚ï¼Œå±•å¼€35æ­¥ã€‚æˆ‘ä»¬å°†éšè—çŠ¶æ€åˆå§‹åŒ–ä¸ºé›¶ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨å½“å‰å°æ‰¹é‡çš„æœ€ç»ˆéšè—çŠ¶æ€ä½œä¸ºåç»­å°æ‰¹é‡çš„åˆå§‹éšè—çŠ¶æ€ï¼ˆè¿ç»­çš„å°æ‰¹é‡ä¾æ¬¡éå†è®­ç»ƒé›†ï¼‰ã€‚æ¯ä¸ªå°æ‰¹é‡çš„å¤§å°ä¸º20ã€‚ The medium LSTM has 650 units per layer and its parameters are initialized uniformly in [âˆ’0.05, 0.05]. As described earlier, we apply 50% dropout on the non-recurrent connections. We train the LSTM for 39 epochs with a learning rate of 1, and after 6 epochs we decrease it by a factor of 1.2 after each epoch. We clip the norm of the gradients (normalized by minibatch size) at 5. Training this network takes about half a day on an NVIDIA K20 GPU.ä¸­å‹LSTMæ¯å±‚æœ‰650ä¸ªå•å…ƒï¼Œå…¶å‚æ•°åœ¨[âˆ’0.05, 0.05]èŒƒå›´å†…å‡åŒ€åˆå§‹åŒ–ã€‚å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬åœ¨éé€’å½’è¿æ¥ä¸Šåº”ç”¨50%çš„dropoutã€‚æˆ‘ä»¬ç”¨å­¦ä¹ ç‡ä¸º1è®­ç»ƒLSTMå…±39ä¸ªå‘¨æœŸï¼Œåœ¨ç¬¬6ä¸ªå‘¨æœŸåï¼Œæ¯ä¸ªå‘¨æœŸå°†å­¦ä¹ ç‡æŒ‰1.2çš„å› å­é€’å‡ã€‚æˆ‘ä»¬å°†æ¢¯åº¦çš„èŒƒæ•°ï¼ˆæŒ‰å°æ‰¹é‡å¤§å°å½’ä¸€åŒ–ï¼‰å‰ªè£åˆ°5ã€‚è®­ç»ƒè¯¥ç½‘ç»œåœ¨NVIDIA K20 GPUä¸Šå¤§çº¦éœ€è¦åŠå¤©æ—¶é—´ã€‚ The large LSTM has 1500 units per layer and its parameters are initialized uniformly in [âˆ’0.04, 0.04]. We apply 65% dropout on the non-recurrent connections. We train the model for 55 epochs with a learning rate of 1; after 14 epochs we start to reduce the learning rate by a factor of 1.15 after each epoch. We clip the norm of the gradients (normalized by minibatch size) at 10 Mikolov et al. (2010). Training this network takes an entire day on an NVIDIA K20 GPU.å¤§å‹LSTMæ¯å±‚æœ‰1500ä¸ªå•å…ƒï¼Œå…¶å‚æ•°åœ¨[âˆ’0.04, 0.04]èŒƒå›´å†…å‡åŒ€åˆå§‹åŒ–ã€‚æˆ‘ä»¬åœ¨éé€’å½’è¿æ¥ä¸Šåº”ç”¨65%çš„dropoutã€‚æˆ‘ä»¬ç”¨å­¦ä¹ ç‡ä¸º1è®­ç»ƒæ¨¡å‹å…±55ä¸ªå‘¨æœŸï¼›åœ¨ç¬¬14ä¸ªå‘¨æœŸåï¼Œæ¯ä¸ªå‘¨æœŸå¼€å§‹æŒ‰1.15çš„å› å­é€’å‡å­¦ä¹ ç‡ã€‚æˆ‘ä»¬å°†æ¢¯åº¦çš„èŒƒæ•°ï¼ˆæŒ‰å°æ‰¹é‡å¤§å°å½’ä¸€åŒ–ï¼‰å‰ªè£åˆ°10 Mikolovç­‰ï¼ˆ2010ï¼‰ã€‚è®­ç»ƒè¯¥ç½‘ç»œåœ¨NVIDIA K20 GPUä¸Šéœ€è¦æ•´æ•´ä¸€å¤©æ—¶é—´ã€‚ For comparison, we trained a non-regularized network. We optimized its parameters to get the best validation performance. The lack of regularization effectively constrains size of the network, forcing us to use small network because larger networks overfit. Our best performing non-regularized LSTM has two hidden layers with 200 units per layer, and its weights are initialized uniformly in [âˆ’0.1, 0.1]. We train it for 4 epochs with a learning rate of 1 and then we decrease the learning rate by a factor of 2 after each epoch, for a total of 13 training epochs. The size of each minibatch is 20, and we unroll the network for 20 steps. Training this network takes 2-3 hours on an NVIDIA K20 GPU.ä¸ºäº†æ¯”è¾ƒï¼Œæˆ‘ä»¬è®­ç»ƒäº†ä¸€ä¸ªæœªæ­£åˆ™åŒ–çš„ç½‘ç»œã€‚æˆ‘ä»¬ä¼˜åŒ–å…¶å‚æ•°ä»¥è·å¾—æœ€ä½³éªŒè¯æ€§èƒ½ã€‚ç¼ºä¹æ­£åˆ™åŒ–æœ‰æ•ˆåœ°é™åˆ¶äº†ç½‘ç»œçš„å¤§å°ï¼Œè¿«ä½¿æˆ‘ä»¬ä½¿ç”¨å°å‹ç½‘ç»œï¼Œå› ä¸ºè¾ƒå¤§çš„ç½‘ç»œä¼šè¿‡æ‹Ÿåˆã€‚æˆ‘ä»¬è¡¨ç°æœ€å¥½çš„æœªæ­£åˆ™åŒ–LSTMæœ‰ä¸¤å±‚éšè—å±‚ï¼Œæ¯å±‚200ä¸ªå•å…ƒï¼Œå…¶æƒé‡åœ¨[âˆ’0.1, 0.1]èŒƒå›´å†…å‡åŒ€åˆå§‹åŒ–ã€‚æˆ‘ä»¬ç”¨å­¦ä¹ ç‡ä¸º1è®­ç»ƒäº†4ä¸ªå‘¨æœŸï¼Œç„¶åæ¯ä¸ªå‘¨æœŸå°†å­¦ä¹ ç‡æŒ‰2çš„å› å­é€’å‡ï¼Œæ€»å…±è®­ç»ƒ13ä¸ªå‘¨æœŸã€‚æ¯ä¸ªå°æ‰¹é‡çš„å¤§å°ä¸º20ï¼Œæˆ‘ä»¬å±•å¼€ç½‘ç»œ20æ­¥ã€‚è®­ç»ƒè¯¥ç½‘ç»œåœ¨NVIDIA K20 GPUä¸Šéœ€è¦2-3å°æ—¶ã€‚ Table 1 compares previous results with our LSTMs, and Figure 4 shows samples drawn from a single large regularized LSTM.è¡¨1æ¯”è¾ƒäº†ä»¥å‰çš„ç»“æœå’Œæˆ‘ä»¬çš„LSTMï¼Œå›¾4æ˜¾ç¤ºäº†ä»å•ä¸ªå¤§å‹æ­£åˆ™åŒ–LSTMä¸­æŠ½å–çš„æ ·æœ¬ã€‚ 4.2 SPEECH RECOGNITION è¯­éŸ³è¯†åˆ«Deep Neural Networks have been used for acoustic modeling for over half a century (see Bourlard &amp; Morgan (1993) for a good review). Acoustic modeling is a key component in mapping acoustic signals to sequences of words, as it models $p(s_t|X)$ where $s_t$â€‹ is the phonetic state at time $t$ and $X$ is the acoustic observation. Recent work has shown that LSTMs can achieve excellent performance on acoustic modeling Sak et al. (2014), yet relatively small LSTMs (in terms of the number of their parameters) can easily overfit the training set. A useful metric for measuring the performance of acoustic models is frame accuracy, which is measured at each sts_tstâ€‹ for all timesteps ttt. Generally, this metric correlates with the actual metric of interest, the Word Error Rate (WER).æ·±åº¦ç¥ç»ç½‘ç»œå·²ç»è¢«ç”¨äºå£°å­¦å»ºæ¨¡è¶…è¿‡åŠä¸ªä¸–çºªï¼ˆå‚è§Bourlard &amp; Morgan (1993)çš„è‰¯å¥½ç»¼è¿°ï¼‰ã€‚å£°å­¦å»ºæ¨¡æ˜¯å°†å£°å­¦ä¿¡å·æ˜ å°„åˆ°å•è¯åºåˆ—ä¸­çš„å…³é”®ç»„æˆéƒ¨åˆ†ï¼Œå› ä¸ºå®ƒå¯¹p(stâˆ£X)p(s_t|X)p(stâ€‹âˆ£X)å»ºæ¨¡ï¼Œå…¶ä¸­sts_tstâ€‹æ˜¯æ—¶é—´tttçš„è¯­éŸ³çŠ¶æ€ï¼ŒXXXæ˜¯å£°å­¦è§‚æµ‹ã€‚æœ€è¿‘çš„å·¥ä½œè¡¨æ˜ï¼ŒLSTMåœ¨å£°å­¦å»ºæ¨¡ä¸Šå¯ä»¥å–å¾—ä¼˜å¼‚çš„æ€§èƒ½ Sakç­‰ï¼ˆ2014ï¼‰ï¼Œä½†ç›¸å¯¹è¾ƒå°çš„LSTMï¼ˆå°±å‚æ•°æ•°é‡è€Œè¨€ï¼‰å¾ˆå®¹æ˜“å¯¹è®­ç»ƒé›†è¿‡æ‹Ÿåˆã€‚è¡¡é‡å£°å­¦æ¨¡å‹æ€§èƒ½çš„ä¸€ä¸ªæœ‰ç”¨æŒ‡æ ‡æ˜¯å¸§å‡†ç¡®ç‡ï¼Œå®ƒåœ¨æ‰€æœ‰æ—¶é—´æ­¥é•¿tttå¤„æµ‹é‡æ¯ä¸ªsts_tstâ€‹çš„å‡†ç¡®ç‡ã€‚é€šå¸¸ï¼Œè¿™ä¸ªæŒ‡æ ‡ä¸å®é™…æ„Ÿå…´è¶£çš„æŒ‡æ ‡ï¼Œå³å•è¯é”™è¯¯ç‡ï¼ˆWERï¼‰ç›¸å…³ã€‚ Since computing the WER involves using a language model and tuning the decoding parameters for every change in the acoustic model, we decided to focus on frame accuracy in these experiments. Table 2 shows that dropout improves the frame accuracy of the LSTM. Not surprisingly, the training frame accuracy drops due to the noise added during training, but as is often the case with dropout, this yields models that generalize better to unseen data. Note that the test set is easier than the training set, as its accuracy is higher. We report the performance of an LSTM on an internal Google Icelandic Speech dataset, which is relatively small (93k utterances), so overfitting is a great concern.ç”±äºè®¡ç®—WERæ¶‰åŠä½¿ç”¨è¯­è¨€æ¨¡å‹å¹¶è°ƒæ•´å£°å­¦æ¨¡å‹æ¯æ¬¡å˜åŒ–çš„è§£ç å‚æ•°ï¼Œæˆ‘ä»¬å†³å®šåœ¨è¿™äº›å®éªŒä¸­ä¸“æ³¨äºå¸§å‡†ç¡®ç‡ã€‚è¡¨2æ˜¾ç¤ºäº†dropoutæé«˜äº†LSTMçš„å¸§å‡†ç¡®ç‡ã€‚ä¸å‡ºæ‰€æ–™ï¼Œç”±äºè®­ç»ƒè¿‡ç¨‹ä¸­åŠ å…¥çš„å™ªå£°ï¼Œè®­ç»ƒå¸§å‡†ç¡®ç‡ä¸‹é™äº†ï¼Œä½†ä¸dropoutç»å¸¸å‡ºç°çš„æƒ…å†µä¸€æ ·ï¼Œè¿™ä½¿å¾—æ¨¡å‹åœ¨æœªè§æ•°æ®ä¸Šçš„æ³›åŒ–èƒ½åŠ›æ›´å¼ºã€‚è¯·æ³¨æ„ï¼Œæµ‹è¯•é›†æ¯”è®­ç»ƒé›†æ›´å®¹æ˜“ï¼Œå› ä¸ºå®ƒçš„å‡†ç¡®ç‡æ›´é«˜ã€‚æˆ‘ä»¬æŠ¥å‘Šäº†LSTMåœ¨Googleå†…éƒ¨å†°å²›è¯­è¯­éŸ³æ•°æ®é›†ä¸Šçš„æ€§èƒ½ï¼Œè¯¥æ•°æ®é›†ç›¸å¯¹è¾ƒå°ï¼ˆ93kå¥å­ï¼‰ï¼Œå› æ­¤è¿‡æ‹Ÿåˆæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ã€‚ 4.3 MACHINE TRANSLATION æœºå™¨ç¿»è¯‘We formulate a machine translation problem as a language modelling task, where an LSTM is trained to assign high probability to a correct translation of a source sentence. Thus, the LSTM is trained on concatenations of source sentences and their translations Sutskever et al. (2014) (see also Cho et al. (2014)). We compute a translation by approximating the most probable sequence of words using a simple beam search with a beam of size 12. We ran an LSTM on the WMTâ€™14 English to French dataset, on the â€œselectedâ€ subset from Schwenk (2014) which has 340M French words and 304M English words. Our LSTM has 4 hidden layers, and both its layers and word embeddings have 1000 units. Its English vocabulary has 160,000 words and its French vocabulary has 80,000 words. The optimal dropout probability was 0.2. Table 3 shows the performance of an LSTM trained with and without dropout. While our LSTM does not beat the phrase-based LIUM SMT system Schwenk et al. (2011), our results show that dropout improves the translation performance of the LSTM.æˆ‘ä»¬å°†æœºå™¨ç¿»è¯‘é—®é¢˜è¡¨è¿°ä¸ºä¸€ä¸ªè¯­è¨€å»ºæ¨¡ä»»åŠ¡ï¼Œå…¶ä¸­LSTMè¢«è®­ç»ƒä¸ºå¯¹æºå¥å­çš„æ­£ç¡®ç¿»è¯‘èµ‹äºˆé«˜æ¦‚ç‡ã€‚å› æ­¤ï¼ŒLSTMåœ¨æºå¥å­åŠå…¶ç¿»è¯‘çš„ä¸²è”ä¸Šè¿›è¡Œè®­ç»ƒ Sutskeverç­‰ï¼ˆ2014ï¼‰ï¼ˆå¦è§Choç­‰ï¼ˆ2014ï¼‰ï¼‰ã€‚æˆ‘ä»¬é€šè¿‡ä½¿ç”¨å¤§å°ä¸º12çš„ç®€å•æŸæœç´¢æ¥è¿‘ä¼¼æœ€å¯èƒ½çš„å•è¯åºåˆ—æ¥è®¡ç®—ç¿»è¯‘ã€‚æˆ‘ä»¬åœ¨WMTâ€™14è‹±æ³•æ•°æ®é›†ä¸Šçš„â€œselectedâ€å­é›†ï¼ˆæ¥è‡ªSchwenkï¼ˆ2014ï¼‰ï¼ŒåŒ…å«3.4äº¿ä¸ªæ³•è¯­å•è¯å’Œ3.04äº¿ä¸ªè‹±è¯­å•è¯ï¼‰ä¸Šè¿è¡Œäº†ä¸€ä¸ªLSTMã€‚æˆ‘ä»¬çš„LSTMæœ‰4ä¸ªéšè—å±‚ï¼Œå…¶å±‚å’Œè¯åµŒå…¥éƒ½æœ‰1000ä¸ªå•å…ƒã€‚å®ƒçš„è‹±è¯­è¯æ±‡é‡æœ‰160,000ä¸ªå•è¯ï¼Œæ³•è¯­è¯æ±‡é‡æœ‰80,000ä¸ªå•è¯ã€‚æœ€ä½³çš„dropoutæ¦‚ç‡æ˜¯0.2ã€‚è¡¨3æ˜¾ç¤ºäº†ä½¿ç”¨å’Œä¸ä½¿ç”¨dropoutè®­ç»ƒçš„LSTMçš„æ€§èƒ½ã€‚è™½ç„¶æˆ‘ä»¬çš„LSTMæ²¡æœ‰å‡»è´¥åŸºäºçŸ­è¯­çš„LIUM SMTç³»ç»Ÿ Schwenkç­‰ï¼ˆ2011ï¼‰ï¼Œä½†æˆ‘ä»¬çš„ç»“æœè¡¨æ˜dropoutæé«˜äº†LSTMçš„ç¿»è¯‘æ€§èƒ½ã€‚ 4.4 IMAGE CAPTION GENERATIONå›¾åƒæè¿°ç”ŸæˆWe applied the dropout variant to the image caption generation model of Vinyals et al. (2014). The image caption generation is similar to the sequence-to-sequence model of Sutskever et al. (2014), but where the input image is mapped onto a vector with a highly-accurate pre-trained convolutional neural network (Szegedy et al., 2014), which is converted into a caption with a single-layer LSTM (see Vinyals et al. (2014) for the details on the architecture). We test our dropout scheme on LSTM as the convolutional neural network is not trained on the image caption dataset because it is not large (MSCOCO (Lin et al., 2014)).æˆ‘ä»¬å°†dropoutå˜ä½“åº”ç”¨äºVinyalsç­‰äººï¼ˆ2014ï¼‰çš„å›¾åƒæè¿°ç”Ÿæˆæ¨¡å‹ã€‚å›¾åƒæè¿°ç”Ÿæˆç±»ä¼¼äºSutskeverç­‰äººï¼ˆ2014ï¼‰çš„åºåˆ—åˆ°åºåˆ—æ¨¡å‹ï¼Œä½†è¾“å…¥å›¾åƒè¢«æ˜ å°„åˆ°ä¸€ä¸ªå…·æœ‰é«˜ç²¾åº¦çš„é¢„è®­ç»ƒå·ç§¯ç¥ç»ç½‘ç»œï¼ˆSzegedyç­‰äººï¼Œ2014ï¼‰çš„å‘é‡ï¼Œè¯¥å‘é‡é€šè¿‡å•å±‚LSTMè½¬æ¢ä¸ºæè¿°ï¼ˆæœ‰å…³æ¶æ„çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§Vinyalsç­‰äººï¼Œ2014ï¼‰ã€‚æˆ‘ä»¬åœ¨LSTMä¸Šæµ‹è¯•äº†æˆ‘ä»¬çš„dropoutæ–¹æ¡ˆï¼Œå› ä¸ºå·ç§¯ç¥ç»ç½‘ç»œå¹¶æœªåœ¨å›¾åƒæè¿°æ•°æ®é›†ä¸Šè¿›è¡Œè®­ç»ƒï¼Œå› ä¸ºå®ƒä¸æ˜¯å¾ˆå¤§ï¼ˆMSCOCOï¼ˆLinç­‰äººï¼Œ2014ï¼‰ï¼‰ã€‚ Our results are summarized in the following Table 4. In brief, dropout helps relative to not using dropout, but using an ensemble eliminates the gains attained by dropout. Thus, in this setting, the main effect of dropout is to produce a single model that is as good as an ensemble, which is a reasonable improvement given the simplicity of the technique.æˆ‘ä»¬çš„ç»“æœæ€»ç»“åœ¨ä»¥ä¸‹è¡¨4ä¸­ã€‚ç®€è€Œè¨€ä¹‹ï¼Œdropoutç›¸å¯¹äºä¸ä½¿ç”¨dropoutæœ‰å¸®åŠ©ï¼Œä½†ä½¿ç”¨é›†æˆæ–¹æ³•æ¶ˆé™¤äº†é€šè¿‡dropoutè·å¾—çš„æ”¶ç›Šã€‚å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œdropoutçš„ä¸»è¦ä½œç”¨æ˜¯äº§ç”Ÿä¸€ä¸ªä¸é›†æˆä¸€æ ·å¥½çš„å•ä¸€æ¨¡å‹ï¼Œè€ƒè™‘åˆ°è¯¥æŠ€æœ¯çš„ç®€å•æ€§ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆç†çš„æ”¹è¿›ã€‚ 5 CONCLUSIONWe presented a simple way of applying dropout to LSTMs that results in large performance increases on several problems in different domains. Our work makes dropout useful for RNNs, and our results suggest that our implementation of dropout could improve performance on a wide variety of applications.æˆ‘ä»¬æå‡ºäº†ä¸€ç§å°†dropoutåº”ç”¨äºLSTMçš„ç®€å•æ–¹æ³•ï¼Œè¿™åœ¨ä¸åŒé¢†åŸŸçš„å‡ ä¸ªé—®é¢˜ä¸Šå¯¼è‡´äº†æ€§èƒ½çš„å¤§å¹…æå‡ã€‚æˆ‘ä»¬çš„å·¥ä½œä½¿dropoutå¯¹RNNæœ‰ç”¨ï¼Œå¹¶ä¸”æˆ‘ä»¬çš„ç»“æœè¡¨æ˜ï¼Œæˆ‘ä»¬å®ç°çš„dropoutå¯ä»¥æé«˜å„ç§åº”ç”¨çš„æ€§èƒ½ã€‚ 6 ACKNOWLEDGMENTSWe wish to acknowledge Tomas Mikolov for useful comments on the first version of the paper.æˆ‘ä»¬å¸Œæœ›æ„Ÿè°¢Tomas Mikolovå¯¹è®ºæ–‡ç¬¬ä¸€ç‰ˆæå‡ºçš„æœ‰ç›Šæ„è§ã€‚ æ³¨é‡Š1. å…ƒç´ ä¹˜æ³•å…ƒç´ ä¹˜æ³•ï¼ˆElement-wise multiplicationï¼‰ï¼Œä¹Ÿç§°ä¸ºHadamardä¹˜ç§¯ï¼ˆHadamard productï¼‰ï¼Œæ˜¯å¯¹ä¸¤ä¸ªåŒå½¢çŸ©é˜µæˆ–å‘é‡çš„å¯¹åº”å…ƒç´ è¿›è¡Œé€ä¸€ç›¸ä¹˜çš„æ“ä½œï¼Œå¹¿æ³›åº”ç”¨äºå„ç§çº¿æ€§ä»£æ•°å’Œç¥ç»ç½‘ç»œè®¡ç®—ä¸­ã€‚ ç”¨ç¬¦å·â€œâŠ™â€è¡¨ç¤ºã€‚ å…¬å¼è¡¨ç¤ºç»™å®šä¸¤ä¸ªç›¸åŒå¤§å°çš„çŸ©é˜µæˆ–å‘é‡ $A$ å’Œ $B$ï¼Œå…¶å…ƒç´ ä¹˜æ³• $C$ è®¡ç®—å¦‚ä¸‹ï¼š$C = A \\odot B$ å…¶ä¸­ï¼š $A = [a_1, a_2, â€¦, a_n]$ $B = [b_1, b_2, â€¦, b_n]$ $C = [c_1, c_2, â€¦, c_n]$ $c_i = a_i \\cdot b_i$ç¤ºä¾‹ å‡è®¾æœ‰ä¸¤ä¸ªå‘é‡ $A$ å’Œ $B$ï¼š $A=[1,2,3]$$B=[4,5,6]$ å®ƒä»¬çš„å…ƒç´ ä¹˜æ³• $C$ ä¸ºï¼š$C = A \\odot B = [1 \\cdot 4, 2 \\cdot 5, 3 \\cdot 6] = [4, 10, 18]$ åº”ç”¨åœºæ™¯ ç¥ç»ç½‘ç»œä¸­çš„LSTMï¼š ç”¨äºæ›´æ–°å•å…ƒçŠ¶æ€ï¼Œå¦‚å…¬å¼ $c_t = f \\odot c_{t-1} + i \\odot \\tilde{c}_t$ä¸­ã€‚ å›¾åƒå¤„ç†ï¼š ç”¨äºå›¾åƒæ»¤æ³¢ï¼Œå°†æ»¤æ³¢å™¨åº”ç”¨äºå›¾åƒçš„æ¯ä¸ªåƒç´ ã€‚ æ•°æ®å¤„ç†ï¼š åœ¨æ•°æ®é¢„å¤„ç†ä¸­ï¼Œç”¨äºæŒ‰å…ƒç´ ç¼©æ”¾æˆ–è°ƒæ•´æ•°æ®ã€‚ 2. å…¬å¼æ‹†è§£:RNNRNN : $h_t^{l-1}â€‹$, $h_{t-1}^l \\rightarrow h_t^l$ è¡¨æ˜åœ¨RNNä¸­ï¼Œ éšè—çŠ¶æ€çš„è®¡ç®—ç»“æœä¾èµ–äºå½“å‰æ—¶é—´æ­¥çš„è¾“å…¥ $h_t$å’Œå‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ $h_{t-1}$ã€‚ å†ç»†åŒ–ä¸€ç‚¹ï¼Œ å½“å‰æ—¶é—´æ­¥çš„è¾“å…¥ $h_t$ åº”è¯¥æ¥æºäºä¸Šä¸€å±‚ï¼Œæ‰€ä»¥æ˜¯ $h_t^{l-1}â€‹$ å‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ $h_{t-1}$ ï¼Œåº”è¯¥æ˜¯åŒä¸€å±‚çš„å‰ä¸€ä¸ªæ—¶é—´æ­¥ï¼Œ æ‰€ä»¥æ˜¯$h_{t-1}^l$ è¯¥çŠ¶æ€è½¬ç§»è¿‡ç¨‹ï¼Œå¦‚æœç”¨å…·ä½“çš„æ•°å­¦å…¬å¼è¡¨ç¤ºï¼Œå¯ä»¥å¦‚ä¸‹æ‰€ç¤º$h_t^l = f(T_{n,n} h_t^{l-1} + T_{n,n} h_{t-1}^l), where f \\in \\{\\text{sigm, tanh}\\}$ 3. å…¬å¼æ‹†è§£:LSTM çŠ¶æ€æ›´æ–°LSTM : $h_t^{l-1}$, $h_{t-1}^l$, $c_{t-1}^l \\rightarrow h_t^l$â€‹, $c_t^l$æè¿°äº†LSTMå¦‚ä½•é€šè¿‡å½“å‰å±‚çš„è¾“å…¥å‘é‡ $h_t^{l-1}$ã€å‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ $h_{t-1}^l$å’Œå•å…ƒçŠ¶æ€ $c_{t-1}^l$ æ¥ç”Ÿæˆæ–°çš„éšè—çŠ¶æ€ $h_t^l$ å’Œå•å…ƒçŠ¶æ€ $c_t^l$ã€‚ $h_t^{l-1}$ï¼šè¡¨ç¤ºç¬¬ $lâˆ’1$ å±‚åœ¨æ—¶é—´æ­¥ $t$ çš„éšè—çŠ¶æ€å‘é‡ã€‚è¿™æ˜¯ç¬¬ $l$ å±‚çš„å½“å‰è¾“å…¥ã€‚ $h_{t-1}^l$ï¼šè¡¨ç¤ºç¬¬ $l$ å±‚åœ¨æ—¶é—´æ­¥ $tâˆ’1$ çš„éšè—çŠ¶æ€å‘é‡ã€‚è¿™æ˜¯ç¬¬ $l$ å±‚çš„å‰ä¸€ä¸ªæ—¶é—´æ­¥çš„çŠ¶æ€ã€‚ $c_{t-1}^l$ï¼šè¡¨ç¤ºç¬¬ $l$ å±‚åœ¨æ—¶é—´æ­¥ $tâˆ’1$çš„å•å…ƒçŠ¶æ€å‘é‡ã€‚è¿™æ˜¯ç¬¬ $l$ å±‚çš„å‰ä¸€ä¸ªæ—¶é—´æ­¥çš„å•å…ƒçŠ¶æ€ã€‚ $h_t^l$ï¼šè¡¨ç¤ºç¬¬ $l$ å±‚åœ¨æ—¶é—´æ­¥ $t$ çš„éšè—çŠ¶æ€å‘é‡ã€‚è¿™æ˜¯ç»è¿‡ç¬¬ $l$ å±‚è®¡ç®—åçš„æ–°çŠ¶æ€ã€‚ $c_t^l$ï¼šè¡¨ç¤ºç¬¬ $l$ å±‚åœ¨æ—¶é—´æ­¥ $t$ çš„æ–°çš„å•å…ƒçŠ¶æ€å‘é‡ã€‚è¿™æ˜¯æ›´æ–°åçš„å•å…ƒçŠ¶æ€ã€‚ $\\left( \\begin{array}{c} i \\ f \\ o \\ g \\end{array} \\right) = \\left( \\begin{array}{c} \\text{sigm} \\ \\text{sigm} \\ \\text{sigm} \\ \\text{tanh} \\end{array} \\right) T_{2n,4n} \\left( \\begin{array}{c} h_{t}^{l-1} \\ h_{t-1}^{l} \\end{array} \\right)â€‹$ æè¿°äº†è¾“å…¥é—¨ $i$ã€é—å¿˜é—¨ $f$ã€è¾“å‡ºé—¨ $o$ å’Œå€™é€‰è®°å¿†å•å…ƒ $g$ çš„è®¡ç®—ã€‚è¿™é‡Œï¼ŒçŸ©é˜µ $T_{2n,4n}$â€‹ åŒ…å«äº†ç›¸åº”çš„æƒé‡ï¼Œè¾“å…¥åŒ…æ‹¬å½“å‰è¾“å…¥ $h_t^{l-1}$å’Œå‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ $h_{t-1}^l$â€‹ è¾“å…¥é—¨ $i$ å’Œ é—å¿˜é—¨ $f$ æ§åˆ¶ä¿¡æ¯çš„æ›´æ–°å’Œé—å¿˜ï¼Œä½¿ç”¨$sigmoid$æ¿€æ´»å‡½æ•°ã€‚ è¾“å‡ºé—¨ $o$ æ§åˆ¶è¾“å‡ºä¿¡æ¯ï¼Œä½¿ç”¨$sigmoid$æ¿€æ´»å‡½æ•°ã€‚ å€™é€‰è®°å¿†å•å…ƒ $g$ æä¾›æ–°çš„ä¿¡æ¯å†…å®¹ï¼Œä½¿ç”¨$tanh$æ¿€æ´»å‡½æ•°ã€‚ æƒé‡çŸ©é˜µ $T_{2n,4n}$ ä¸€ä¸ªå¤§å°ä¸º $2n \\times 4n$ çš„çŸ©é˜µï¼Œå…¶ä¸­ $n$ æ˜¯éšè—çŠ¶æ€å‘é‡çš„ç»´åº¦ã€‚å°†è¾“å…¥å‘é‡ $h_t^{l-1}$â€‹ å’Œéšè—çŠ¶æ€å‘é‡ $h_{t-1}^l$ æ‹¼æ¥èµ·æ¥ï¼ˆå‘é‡é•¿åº¦ä¸º $2n$ï¼‰ï¼Œå¹¶é€šè¿‡çŸ©é˜µ $T_{2n,4n}$â€‹ è¿›è¡Œçº¿æ€§å˜æ¢ï¼Œç”Ÿæˆä¸€ä¸ªé•¿åº¦ä¸º $4n$ çš„è¾“å‡ºå‘é‡,å³ $i, f, o, g$ å››ä¸ªéƒ¨åˆ†1. é—å¿˜é—¨ï¼ˆForget Gateï¼‰ $f_t^l = \\sigma(W_f \\cdot [h_{t-1}^l, h_t^{l-1}] + b_f)$ $[h_t^{l-1}, h_{t-1}^l]$è¡¨ç¤ºå°†å½“å‰è¾“å…¥å’Œå‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€å‘é‡æ‹¼æ¥æˆä¸€ä¸ªå‘é‡ã€‚ $W_fâ€‹$ æ˜¯è¯¥æ‹¼æ¥å‘é‡çš„æƒé‡çŸ©é˜µã€‚ $b_f$â€‹ æ˜¯åç½®å‘é‡ã€‚ $\\sigma$ æ˜¯$sigmoid$æ¿€æ´»å‡½æ•°ï¼Œè¾“å‡ºèŒƒå›´åœ¨0åˆ°1ä¹‹é—´ã€‚ å‡è®¾ $n = 4$ï¼š å½“å‰è¾“å…¥å‘é‡ $h_t^{l-1}$ä¸º $[h_1â€‹,h_2â€‹,h_3â€‹,h_4â€‹]$ã€‚ å‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ $h_{t-1}^l$ ä¸º $[h_5, h_6, h_7, h_8]$ æ‹¼æ¥åçš„å‘é‡ä¸ºï¼š$[h_1, h_2, h_3, h_4, h_5, h_6, h_7, h_8]$ æƒé‡çŸ©é˜µ $W_fâ€‹$ å°†æ­¤å‘é‡è¿›è¡Œçº¿æ€§å˜æ¢ï¼Œç”Ÿæˆä¸€ä¸ªé•¿åº¦ä¸º $n$ çš„å‘é‡ã€‚ çº¿æ€§å˜æ¢è¿›è¡Œçº¿æ€§å˜æ¢çš„å…¬å¼ä¸ºï¼š$z_f = W_f \\cdot [h_t^{l-1}, h_{t-1}^l] + b_f$ å…·ä½“æ­¥éª¤ï¼š çŸ©é˜µä¹˜æ³•ï¼š $W_f$æ˜¯ä¸€ä¸ª $n \\times 2n$ çš„çŸ©é˜µï¼Œæ‹¼æ¥å‘é‡æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º $2n$ çš„å‘é‡ã€‚ é€šè¿‡çŸ©é˜µä¹˜æ³•ï¼Œç»“æœæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º $n$ çš„å‘é‡ã€‚ åŠ åç½®ï¼š å°†å¾—åˆ°çš„å‘é‡ä¸åç½®å‘é‡ $b_f$ ç›¸åŠ ï¼Œä»ç„¶æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º $n$ çš„å‘é‡ã€‚ ä¾‹å¦‚ï¼Œå‡è®¾ $W_f$â€‹ å’Œ $b_f$â€‹ ä¸ºï¼š$W_f = \\begin{pmatrix} w_{11} &amp; w_{12} &amp; w_{13} &amp; w_{14} &amp; w_{15} &amp; w_{16} &amp; w_{17} &amp; w_{18} \\ w_{21} &amp; w_{22} &amp; w_{23} &amp; w_{24} &amp; w_{25} &amp; w_{26} &amp; w_{27} &amp; w_{28} \\ w_{31} &amp; w_{32} &amp; w_{33} &amp; w_{34} &amp; w_{35} &amp; w_{36} &amp; w_{37} &amp; w_{38} \\ w_{41} &amp; w_{42} &amp; w_{43} &amp; w_{44} &amp; w_{45} &amp; w_{46} &amp; w_{47} &amp; w_{48} \\end{pmatrix}$ æ‹¼æ¥å‘é‡ä¸ºï¼š$[h_1, h_2, h_3, h_4, h_5, h_6, h_7, h_8]$ çŸ©é˜µä¹˜æ³•ï¼š$z_f = W_f \\cdot [h_1, h_2, h_3, h_4, h_5, h_6, h_7, h_8]$ è®¡ç®—æ¯ä¸ªå…ƒç´ ï¼š$\\begin{aligned} z_{f1} &amp;= w_{11}h_1 + w_{12}h_2 + w_{13}h_3 + w_{14}h_4 + w_{15}h_5 + w_{16}h_6 + w_{17}h_7 + w_{18}h_8 \\ z_{f2} &amp;= w_{21}h_1 + w_{22}h_2 + w_{23}h_3 + w_{24}h_4 + w_{25}h_5 + w_{26}h_6 + w_{27}h_7 + w_{28}h_8 \\ z_{f3} &amp;= w_{31}h_1 + w_{32}h_2 + w_{33}h_3 + w_{34}h_4 + w_{35}h_5 + w_{36}h_6 + w_{37}h_7 + w_{38}h_8 \\ z_{f4} &amp;= w_{41}h_1 + w_{42}h_2 + w_{43}h_3 + w_{44}h_4 + w_{45}h_5 + w_{46}h_6 + w_{47}h_7 + w_{48}h_8 \\end{aligned}$ åŠ åç½®ï¼š$z_f = \\begin{pmatrix} z_{f1} + b_1 \\ z_{f2} + b_2 \\ z_{f3} + b_3 \\ z_{f4} + b_4 \\end{pmatrix}$ sigmoid éçº¿æ€§æ¿€æ´»é€šè¿‡$sigmoid$æ¿€æ´»å‡½æ•°å¾—åˆ°é—å¿˜é—¨çš„æ¿€æ´»å€¼ï¼š$f_t^l = \\sigma(z_f)$é€šè¿‡ $sigmoid$ éçº¿æ€§æ¿€æ´»å‡½æ•°ï¼Œå¾—åˆ°é—å¿˜é—¨çš„æ¿€æ´»å€¼ã€‚ 2. è¾“å…¥é—¨ï¼ˆInput Gateï¼‰è®¡ç®—è¾“å…¥é—¨çš„æ¿€æ´»å€¼ï¼Œå†³å®šæ–°çš„è¾“å…¥ä¿¡æ¯çš„å“ªäº›éƒ¨åˆ†å°†æ›´æ–°å•å…ƒçŠ¶æ€ï¼š $i_t^l = \\sigma(W_i \\cdot [h_{t-1}^l, h_t^{l-1}] + b_i)$ è¾“å…¥è°ƒåˆ¶é—¨ï¼ˆInput Modulation Gateï¼‰è¾“å…¥è°ƒåˆ¶é—¨äº§ç”Ÿæ–°çš„å€™é€‰è®°å¿†å†…å®¹ï¼Œé€šè¿‡ tanh å‡½æ•°è¿›è¡Œæ¿€æ´»ã€‚å®ƒçš„æ•°å­¦è¡¨ç¤ºä¸ºï¼š$g_t = \\tanh(W_g \\cdot [h_{t-1}, h_t] + b_g)$ 3. å•å…ƒçŠ¶æ€ç»“åˆé—å¿˜é—¨å’Œè¾“å…¥é—¨çš„ä¿¡æ¯ï¼Œæ›´æ–°å•å…ƒçŠ¶æ€ï¼š $c_t^l = f \\odot c_{t-1}^l + i \\odot g$ æè¿°äº†å¦‚ä½•æ›´æ–°å•å…ƒçŠ¶æ€ã€‚è¿™é‡Œï¼Œ$\\odot$ è¡¨ç¤ºå…ƒç´ ä¹˜æ³•ï¼ˆHadamardä¹˜ç§¯ï¼‰ã€‚ é—å¿˜é—¨$f$å†³å®šäº†å‰ä¸€æ—¶é—´æ­¥çš„å•å…ƒçŠ¶æ€ $c_{t-1}^l$æœ‰å¤šå°‘è¢«ä¿ç•™ã€‚é—å¿˜é—¨çš„è¾“å‡ºå€¼åœ¨0å’Œ1ä¹‹é—´ï¼š å½“ $f$â€‹ æ¥è¿‘1æ—¶ï¼Œè¡¨ç¤ºå¤§éƒ¨åˆ†å•å…ƒçŠ¶æ€è¢«ä¿ç•™ã€‚ å½“ $f$æ¥è¿‘0æ—¶ï¼Œè¡¨ç¤ºå¤§éƒ¨åˆ†å•å…ƒçŠ¶æ€è¢«é—å¿˜ã€‚ è¾“å…¥é—¨ $i$ å’Œå€™é€‰è®°å¿†å•å…ƒ $g$ å†³å®šäº†å¤šå°‘æ–°çš„ä¿¡æ¯è¢«æ·»åŠ åˆ°å½“å‰å•å…ƒçŠ¶æ€ $c_t^l$ã€‚ 4. è¾“å‡ºé—¨è®¡ç®—è¾“å‡ºé—¨çš„æ¿€æ´»å€¼ï¼Œå†³å®šéšè—çŠ¶æ€çš„æ›´æ–°ï¼šè¾“å‡ºé—¨ï¼š$o_t^l = \\sigma(W_o \\cdot [h_{t-1}^l, h_t^{l-1}] + b_o)$éšè—çŠ¶æ€ï¼š$h_t^l = o_t^l * \\tanh(c_t^l)$è¾“å‡ºé—¨ $o$ æ§åˆ¶äº†ä»å•å…ƒçŠ¶æ€ $c_t^l$ ä¼ é€’åˆ°éšè—çŠ¶æ€ $h_t^l$â€‹ çš„ä¿¡æ¯ï¼Œé€šè¿‡$tanh$å‡½æ•°è¿›è¡Œéçº¿æ€§å˜æ¢ã€‚ LSTMé€šè¿‡è¾“å…¥é—¨ã€é—å¿˜é—¨ã€è¾“å‡ºé—¨å’Œå€™é€‰è®°å¿†å•å…ƒçš„ååŒä½œç”¨ï¼Œæœ‰æ•ˆåœ°æ•æ‰åºåˆ—æ•°æ®ä¸­çš„é•¿çŸ­æœŸä¾èµ–å…³ç³»ï¼Œè§£å†³äº†ä¼ ç»ŸRNNä¸­æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸çš„é—®é¢˜ã€‚è¿™ä¸ªæ›´æ–°æœºåˆ¶ä½¿å¾—LSTMåœ¨å¤„ç†é•¿åºåˆ—æ•°æ®æ—¶è¡¨ç°å‡ºè‰²ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°ä¿ç•™é‡è¦ä¿¡æ¯å¹¶è¿‡æ»¤æ— å…³ä¿¡æ¯ã€‚ 5. æ›´æ–°éšè—çŠ¶æ€ï¼ˆHidden State Updateï¼‰ç»“åˆæ–°çš„å•å…ƒçŠ¶æ€å’Œè¾“å‡ºé—¨çš„æ¿€æ´»å€¼ï¼Œæ›´æ–°éšè—çŠ¶æ€ï¼š $h_t^l = o_t^l * \\tanh(c_t^l)$ 4. åº”ç”¨äº†dropout çš„LSTMä»æ­£æ–‡ä¸­å¯ä»¥çœ‹å‡ºï¼Œå’Œæ ‡å‡†çš„LSTM çŠ¶æ€æ›´æ–°è¿‡ç¨‹ç›¸æ¯”ï¼Œ å…¶å˜åŒ–åªæ˜¯å¢åŠ äº†ä¸€ä¸ª$D$ã€‚$D$ æ˜¯å°†å…¶å‚æ•°çš„éšæœºå­é›†è®¾ç½®ä¸ºé›¶çš„dropoutæ“ä½œç¬¦ã€‚ $\\left( \\begin{array}{c} i \\ f \\ o \\ g \\end{array} \\right) = \\left( \\begin{array}{c} \\text{sigm} \\ \\text{sigm} \\ \\text{sigm} \\ \\text{tanh} \\end{array} \\right) T_{2n,4n} \\left( \\begin{array}{c} {D}(h_{t}^{l-1}) \\ h_{t-1}^{l} \\end{array} \\right)â€‹$ å¦‚ä½•ç†è§£å…¶ä¸»è¦æ€æƒ³æ˜¯ä»…å°†dropoutæ“ä½œç¬¦åº”ç”¨äºéé€’å½’è¿æ¥ã€‚ç”±äºï¼š $h_t^{l-1}$ï¼šè¡¨ç¤ºç¬¬ $lâˆ’1$ å±‚åœ¨æ—¶é—´æ­¥ $t$ çš„éšè—çŠ¶æ€å‘é‡ã€‚è¿™æ˜¯ç¬¬ $l$ å±‚çš„å½“å‰è¾“å…¥ã€‚ $h_{t-1}^l$ï¼šè¡¨ç¤ºç¬¬ $l$ å±‚åœ¨æ—¶é—´æ­¥ $tâˆ’1$ çš„éšè—çŠ¶æ€å‘é‡ã€‚è¿™æ˜¯ç¬¬ $l$ å±‚çš„å‰ä¸€ä¸ªæ—¶é—´æ­¥çš„çŠ¶æ€ã€‚åŒä¸€å±‚å‰åæ—¶é—´æ­¥ä¹‹é—´çš„æ•°æ®æµè½¬ å°±æ˜¯é€’å½’æ“ä½œï¼Œ ä¸åŒå±‚ä¹‹é—´çš„æ•°æ®æµè½¬æ˜¯éé€’å½’æ“ä½œï¼Œ æ ¹æ®å…¬å¼ï¼Œ$D$ åº”ç”¨åœ¨äº†$h_t^{l-1}$ä¸Šï¼Œ æ‰€ä»¥è¯´$D$ æ˜¯åº”ç”¨åœ¨éé€’å½’è¿æ¥ä¸Šçš„æ“ä½œç¬¦åˆ","tags":["AI","ç¥ç»ç½‘ç»œ","Ilya sutskeverâ€˜s 30  papers"]},{"title":"The Unreasonable Effectiveness of Recurrent Neural Networks","path":"/2472be8a/","content":"Andrej Karpathy blog:# The Unreasonable Effectiveness of Recurrent Neural Networks Thereâ€™s something magical about Recurrent Neural Networks (RNNs). I still remember when I trained my first recurrent network for Image Captioning. Within a few dozen minutes of training my first baby model (with rather arbitrarily-chosen hyperparameters) started to generate very nice looking descriptions of images that were on the edge of making sense. Sometimes the ratio of how simple your model is to the quality of the results you get out of it blows past your expectations, and this was one of those times. What made this result so shocking at the time was that the common wisdom was that RNNs were supposed to be difficult to train (with more experience Iâ€™ve in fact reached the opposite conclusion). Fast forward about a year: Iâ€™m training RNNs all the time and Iâ€™ve witnessed their power and robustness many times, and yet their magical outputs still find ways of amusing me. This post is about sharing some of that magic with you.å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰æœ‰å…¶ç‹¬ç‰¹çš„é­…åŠ›ã€‚æˆ‘è¿˜è®°å¾—ç¬¬ä¸€æ¬¡è®­ç»ƒç”¨äºå›¾åƒæè¿°ç”Ÿæˆçš„å¾ªç¯ç¥ç»ç½‘ç»œæ—¶çš„æƒ…æ™¯ã€‚åªç”¨äº†çŸ­çŸ­å‡ ååˆ†é’Ÿï¼Œå³ä½¿æ˜¯éšæ„é€‰æ‹©çš„è¶…å‚æ•°ï¼Œè¿™ä¸ªåˆæ­¥æ¨¡å‹å·²ç»å¼€å§‹ç”Ÿæˆçœ‹èµ·æ¥éå¸¸ä¸é”™çš„å›¾åƒæè¿°ï¼Œå°½ç®¡è¿™äº›æè¿°æœ‰æ—¶åªæ˜¯å‹‰å¼ºåˆç†ã€‚æœ‰æ—¶ï¼Œæ¨¡å‹çš„ç®€å•ç¨‹åº¦ä¸å…¶è¾“å‡ºç»“æœçš„è´¨é‡ä¹‹é—´çš„æ¯”ä¾‹ä¼šè¿œè¿œè¶…å‡ºé¢„æœŸï¼Œè¿™æ¬¡å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ã€‚è¿™æ¬¡ç»“æœå¦‚æ­¤ä»¤äººéœ‡æƒŠçš„åŸå› åœ¨äºï¼Œå½“æ—¶çš„æ™®éè®¤çŸ¥æ˜¯ï¼ŒRNNå¾ˆéš¾è®­ç»ƒï¼ˆéšç€ç»éªŒçš„å¢åŠ ï¼Œæˆ‘å®é™…ä¸Šå¾—å‡ºäº†ç›¸åçš„ç»“è®ºï¼‰ã€‚æ—¶é—´å¿«è¿›å¤§çº¦ä¸€å¹´ï¼šæˆ‘ä¸€ç›´åœ¨è®­ç»ƒRNNï¼Œç›®ç¹äº†å®ƒä»¬çš„å¼ºå¤§å’Œç¨³å¥ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œå®ƒä»¬ç¥å¥‡çš„è¾“å‡ºä¾ç„¶èƒ½ä¸æ–­å¸¦ç»™æˆ‘æƒŠå–œã€‚è¿™ç¯‡æ–‡ç« æ—¨åœ¨ä¸å¤§å®¶åˆ†äº«è¿™ç§é­”åŠ›ã€‚ Weâ€™ll train RNNs to generate text character by character and ponder the question â€œhow is that even possible?â€æˆ‘ä»¬å°†è®­ç»ƒå¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰é€å­—ç¬¦åœ°ç”Ÿæˆæ–‡æœ¬ï¼Œå¹¶æ€è€ƒè¿™ä¸ªé—®é¢˜ï¼šâ€œè¿™åˆ°åº•æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿâ€ By the way, together with this post I am also releasing code on Github that allows you to train character-level language models based on multi-layer LSTMs. You give it a large chunk of text and it will learn to generate text like it one character at a time. You can also use it to reproduce my experiments below. But weâ€™re getting ahead of ourselves; What are RNNs anyway?é¡ºä¾¿æä¸€ä¸‹ï¼Œä¸è¿™ç¯‡æ–‡ç« ä¸€èµ·ï¼Œæˆ‘è¿˜åœ¨Githubä¸Šå‘å¸ƒäº†ä»£ç ï¼Œè¿™äº›ä»£ç å¯ä»¥ç”¨æ¥è®­ç»ƒåŸºäºå¤šå±‚LSTMçš„å­—ç¬¦çº§è¯­è¨€æ¨¡å‹ã€‚ä½ åªéœ€æä¾›ä¸€å¤§æ®µæ–‡æœ¬ï¼Œå®ƒå°±ä¼šé€å­—ç¬¦åœ°å­¦ä¹ ç”Ÿæˆç±»ä¼¼çš„æ–‡æœ¬ã€‚ä½ è¿˜å¯ä»¥ä½¿ç”¨å®ƒæ¥é‡ç°æˆ‘ä¸‹é¢çš„å®éªŒã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆå›åˆ°æ­£é¢˜ä¸Šæ¥ï¼šæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹RNNåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ Recurrent Neural Networks é€’å½’ç¥ç»ç½‘ç»œSequencesSequences. Depending on your background you might be wondering: _What makes Recurrent Networks so special_? A glaring limitation of Vanilla Neural Networks (and also Convolutional Networks) is that their API is too constrained: they accept a fixed-sized vector as input (e.g. an image) and produce a fixed-sized vector as output (e.g. probabilities of different classes). Not only that: These models perform this mapping using a fixed amount of computational steps (e.g. the number of layers in the model). The core reason that recurrent nets are more exciting is that they allow us to operate over _sequences_ of vectors: Sequences in the input, the output, or in the most general case both. A few examples may make this more concrete:åºåˆ—ã€‚æ ¹æ®ä½ çš„èƒŒæ™¯ï¼Œä½ å¯èƒ½ä¼šé—®ï¼šå¾ªç¯ç¥ç»ç½‘ç»œæœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ï¼Ÿä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„é™åˆ¶æ˜¯Vanilla ç¥ç»ç½‘ç»œï¼ˆä»¥åŠå·ç§¯ç¥ç»ç½‘ç»œï¼‰çš„APIè¿‡äºå—é™ï¼šå®ƒä»¬æ¥å—å›ºå®šå¤§å°çš„å‘é‡ä½œä¸ºè¾“å…¥ï¼ˆä¾‹å¦‚ï¼Œä¸€å¼ å›¾ç‰‡ï¼‰ï¼Œå¹¶äº§ç”Ÿå›ºå®šå¤§å°çš„å‘é‡ä½œä¸ºè¾“å‡ºï¼ˆä¾‹å¦‚ï¼Œä¸åŒç±»åˆ«çš„æ¦‚ç‡ï¼‰ã€‚ä¸ä»…å¦‚æ­¤ï¼Œè¿™äº›æ¨¡å‹ä½¿ç”¨å›ºå®šæ•°é‡çš„è®¡ç®—æ­¥éª¤æ¥å®Œæˆè¿™ä¸ªæ˜ å°„ï¼ˆä¾‹å¦‚ï¼Œæ¨¡å‹ä¸­çš„å±‚æ•°ï¼‰ã€‚å¾ªç¯ç¥ç»ç½‘ç»œæ›´ä»¤äººå…´å¥‹çš„æ ¸å¿ƒåŸå› åœ¨äºå®ƒä»¬å…è®¸æˆ‘ä»¬å¯¹å‘é‡åºåˆ—è¿›è¡Œæ“ä½œï¼šè¾“å…¥ä¸­çš„åºåˆ—ï¼Œè¾“å‡ºä¸­çš„åºåˆ—ï¼Œæˆ–è€…åœ¨æœ€ä¸€èˆ¬çš„æƒ…å†µä¸‹ï¼Œä¸¤è€…éƒ½æ˜¯åºåˆ—ã€‚å‡ ä¸ªä¾‹å­å¯ä»¥è®©è¿™ä¸€ç‚¹æ›´åŠ å…·ä½“ï¼š Each rectangle is a vector and arrows represent functions (e.g. matrix multiply). Input vectors are in red, output vectors are in blue and green vectors hold the RNNâ€™s state (more on this soon). From left to right: (1) Vanilla mode of processing without RNN, from fixed-sized input to fixed-sized output (e.g. image classification). (2) Sequence output (e.g. image captioning takes an image and outputs a sentence of words). (3) Sequence input (e.g. sentiment analysis where a given sentence is classified as expressing positive or negative sentiment). (4) Sequence input and sequence output (e.g. Machine Translation: an RNN reads a sentence in English and then outputs a sentence in French). (5) Synced sequence input and output (e.g. video classification where we wish to label each frame of the video). Notice that in every case are no pre-specified constraints on the lengths sequences because the recurrent transformation (green) is fixed and can be applied as many times as we like.æ¯ä¸ªçŸ©å½¢ä»£è¡¨ä¸€ä¸ªå‘é‡ï¼Œç®­å¤´ä»£è¡¨å‡½æ•°ï¼ˆä¾‹å¦‚çŸ©é˜µä¹˜æ³•ï¼‰ã€‚è¾“å…¥å‘é‡ç”¨çº¢è‰²è¡¨ç¤ºï¼Œè¾“å‡ºå‘é‡ç”¨è“è‰²è¡¨ç¤ºï¼Œç»¿è‰²å‘é‡è¡¨ç¤ºRNNçš„çŠ¶æ€ï¼ˆç¨åä¼šè¯¦ç»†è¯´æ˜ï¼‰ã€‚ä»å·¦åˆ°å³ä¾æ¬¡æ˜¯ï¼š (1) æ™®é€šæ¨¡å¼çš„å¤„ç†ï¼Œæ²¡æœ‰ä½¿ç”¨RNNï¼Œä»å›ºå®šå¤§å°çš„è¾“å…¥åˆ°å›ºå®šå¤§å°çš„è¾“å‡ºï¼ˆä¾‹å¦‚å›¾åƒåˆ†ç±»ï¼‰ã€‚ (2) åºåˆ—è¾“å‡ºï¼ˆä¾‹å¦‚å›¾åƒæè¿°ç”Ÿæˆï¼Œè¾“å…¥ä¸€å¼ å›¾ç‰‡ï¼Œè¾“å‡ºä¸€ä¸ªå•è¯å¥å­ï¼‰ã€‚ (3) åºåˆ—è¾“å…¥ï¼ˆä¾‹å¦‚æƒ…æ„Ÿåˆ†æï¼Œå°†ç»™å®šçš„å¥å­åˆ†ç±»ä¸ºè¡¨è¾¾æ­£é¢æˆ–è´Ÿé¢æƒ…æ„Ÿï¼‰ã€‚ (4) åºåˆ—è¾“å…¥å’Œåºåˆ—è¾“å‡ºï¼ˆä¾‹å¦‚æœºå™¨ç¿»è¯‘ï¼šRNNè¯»å–ä¸€æ®µè‹±æ–‡å¥å­ï¼Œç„¶åè¾“å‡ºä¸€æ®µæ³•æ–‡å¥å­ï¼‰ã€‚ (5) åŒæ­¥çš„åºåˆ—è¾“å…¥å’Œè¾“å‡ºï¼ˆä¾‹å¦‚è§†é¢‘åˆ†ç±»ï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹è§†é¢‘çš„æ¯ä¸€å¸§è¿›è¡Œæ ‡ç­¾ï¼‰ã€‚ æ³¨æ„ï¼Œåœ¨æ¯ç§æƒ…å†µä¸‹ï¼Œåºåˆ—é•¿åº¦éƒ½æ²¡æœ‰é¢„å…ˆæŒ‡å®šçš„é™åˆ¶ï¼Œå› ä¸ºå¾ªç¯å˜æ¢ï¼ˆç»¿è‰²ï¼‰æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥æ ¹æ®éœ€è¦åº”ç”¨å¤šæ¬¡ã€‚ As you might expect, the sequence regime of operation is much more powerful compared to fixed networks that are doomed from the get-go by a fixed number of computational steps, and hence also much more appealing for those of us who aspire to build more intelligent systems. Moreover, as weâ€™ll see in a bit, RNNs combine the input vector with their state vector with a fixed (but learned) function to produce a new state vector. This can in programming terms be interpreted as running a fixed program with certain inputs and some internal variables. Viewed this way, RNNs essentially describe programs. In fact, it is known that RNNs are Turing-Complete in the sense that they can to simulate arbitrary programs (with proper weights). But similar to universal approximation theorems for neural nets you shouldnâ€™t read too much into this. In fact, forget I said anything.æ­£å¦‚ä½ æ‰€é¢„æ–™çš„é‚£æ ·ï¼Œç›¸è¾ƒäºå—é™äºå›ºå®šè®¡ç®—æ­¥éª¤çš„å›ºå®šç½‘ç»œï¼Œåºåˆ—æ“ä½œæ¨¡å¼è¦å¼ºå¤§å¾—å¤šï¼Œå› æ­¤å¯¹äºé‚£äº›å¸Œæœ›æ„å»ºæ›´æ™ºèƒ½ç³»ç»Ÿçš„äººæ¥è¯´ä¹Ÿæ›´å…·å¸å¼•åŠ›ã€‚æ­¤å¤–ï¼Œæ­£å¦‚æˆ‘ä»¬ç¨åä¼šçœ‹åˆ°çš„ï¼ŒRNNé€šè¿‡å›ºå®šï¼ˆä½†å¯å­¦ä¹ ï¼‰çš„å‡½æ•°å°†è¾“å…¥å‘é‡ä¸å…¶çŠ¶æ€å‘é‡ç»“åˆï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„çŠ¶æ€å‘é‡ã€‚è¿™åœ¨ç¼–ç¨‹æœ¯è¯­ä¸­å¯ä»¥ç†è§£ä¸ºè¿è¡Œä¸€ä¸ªå…·æœ‰ç‰¹å®šè¾“å…¥å’Œä¸€äº›å†…éƒ¨å˜é‡çš„å›ºå®šç¨‹åºã€‚ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼ŒRNNæœ¬è´¨ä¸Šæ˜¯åœ¨æè¿°ç¨‹åºã€‚äº‹å®ä¸Šï¼ŒRNNè¢«è®¤ä¸ºæ˜¯å›¾çµå®Œå¤‡çš„ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å¯ä»¥æ¨¡æ‹Ÿä»»æ„ç¨‹åºï¼ˆåœ¨é€‚å½“çš„æƒé‡ä¸‹ï¼‰ã€‚ä½†æ˜¯ï¼Œä¸ç¥ç»ç½‘ç»œçš„é€šç”¨è¿‘ä¼¼å®šç†ç±»ä¼¼ï¼Œä½ ä¸åº”è¯¥å¯¹æ­¤è¿‡äºè§£è¯»ã€‚å®é™…ä¸Šï¼Œå¿˜æ‰æˆ‘åˆšæ‰è¯´çš„è¯å§ã€‚ If training vanilla neural nets is optimization over functions, training recurrent nets is optimization over programs.å¦‚æœè¯´è®­ç»ƒæ™®é€šç¥ç»ç½‘ç»œæ˜¯å¯¹å‡½æ•°çš„ä¼˜åŒ–ï¼Œé‚£ä¹ˆè®­ç»ƒå¾ªç¯ç½‘ç»œå°±æ˜¯å¯¹ç¨‹åºçš„ä¼˜åŒ–ã€‚ Sequential processing in absence of sequences. You might be thinking that having sequences as inputs or outputs could be relatively rare, but an important point to realize is that even if your inputs/outputs are fixed vectors, it is still possible to use this powerful formalism to _process_ them in a sequential manner. For instance, the figure below shows results from two very nice papers from DeepMind. On the left, an algorithm learns a recurrent network policy that steers its attention around an image; In particular, it learns to read out house numbers from left to right (Ba et al.). On the right, a recurrent network _generates_ images of digits by learning to sequentially add color to a canvas (Gregor et al.):åœ¨æ²¡æœ‰åºåˆ—çš„æƒ…å†µä¸‹è¿›è¡Œé¡ºåºå¤„ç†ã€‚æ‚¨å¯èƒ½è®¤ä¸ºå°†åºåˆ—ä½œä¸ºè¾“å…¥æˆ–è¾“å‡ºå¯èƒ½ç›¸å¯¹ç½•è§ï¼Œä½†éœ€è¦æ„è¯†åˆ°çš„é‡è¦ä¸€ç‚¹æ˜¯ï¼Œå³ä½¿ä½ çš„è¾“å…¥/è¾“å‡ºæ˜¯å›ºå®šå‘é‡ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨è¿™ç§å¼ºå¤§çš„å½¢å¼ä¸»ä¹‰ä»¥é¡ºåºæ–¹å¼å¤„ç†å®ƒä»¬ã€‚ä¾‹å¦‚ï¼Œä¸‹å›¾æ˜¾ç¤ºäº† DeepMind çš„ä¸¤ç¯‡éå¸¸å¥½çš„è®ºæ–‡çš„ç»“æœã€‚åœ¨å·¦è¾¹ï¼Œç®—æ³•å­¦ä¹ ä¸€ä¸ªå¾ªç¯ç½‘ç»œç­–ç•¥ï¼Œå°†å…¶æ³¨æ„åŠ›å¼•å¯¼åˆ°å›¾åƒå‘¨å›´;ç‰¹åˆ«æ˜¯ï¼Œå®ƒå­¦ä¼šäº†ä»å·¦åˆ°å³è¯»å‡ºé—¨ç‰Œå·ï¼ˆBaç­‰äººï¼‰ã€‚åœ¨å³è¾¹ï¼Œä¸€ä¸ªå¾ªç¯ç½‘ç»œé€šè¿‡å­¦ä¹ ä¾æ¬¡å‘ç”»å¸ƒæ·»åŠ é¢œè‰²æ¥ç”Ÿæˆæ•°å­—å›¾åƒï¼š The takeaway is that even if your data is not in form of sequences, you can still formulate and train powerful models that learn to process it sequentially. Youâ€™re learning stateful programs that process your fixed-sized data.è¦ç‚¹æ˜¯ï¼Œå³ä½¿ä½ çš„æ•°æ®ä¸æ˜¯ä»¥åºåˆ—å½¢å¼å­˜åœ¨ï¼Œä½ ä»ç„¶å¯ä»¥è®¾è®¡å’Œè®­ç»ƒå¼ºå¤§çš„æ¨¡å‹ï¼Œä½¿å…¶å­¦ä¼šä»¥é¡ºåºæ–¹å¼å¤„ç†è¿™äº›æ•°æ®ã€‚ä½ æ­£åœ¨å­¦ä¹ çš„æ˜¯å¤„ç†å›ºå®šå¤§å°æ•°æ®çš„æœ‰çŠ¶æ€ç¨‹åºã€‚ RNN computationRNN computation. So how do these things work? At the core, RNNs have a deceptively simple API: They accept an input vector x and give you an output vector y. However, crucially this output vectorâ€™s contents are influenced not only by the input you just fed in, but also on the entire history of inputs youâ€™ve fed in in the past. Written as a class, the RNNâ€™s API consists of a single step function:RNN è®¡ç®—ã€‚é‚£ä¹ˆè¿™äº›ä¸œè¥¿æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿåœ¨æ ¸å¿ƒä¸Šï¼ŒRNN æœ‰ä¸€ä¸ªçœ‹ä¼¼ç®€å•çš„ APIï¼šå®ƒä»¬æ¥å—ä¸€ä¸ªè¾“å…¥å‘é‡ x å¹¶ç»™ä½ ä¸€ä¸ªè¾“å‡ºå‘é‡ y ã€‚ç„¶è€Œï¼Œè‡³å…³é‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªè¾“å‡ºå‘é‡çš„å†…å®¹ä¸ä»…å—åˆ°ä½ åˆšåˆšè¾“å…¥çš„è¾“å…¥çš„å½±å“ï¼Œè¿˜å—åˆ°ä½ è¿‡å»è¾“å…¥çš„æ•´ä¸ªè¾“å…¥å†å²çš„å½±å“ã€‚RNN çš„ API ç¼–å†™ä¸ºä¸€ä¸ªç±»ï¼Œç”±ä¸€ä¸ª step å‡½æ•°ç»„æˆï¼š12rnn = RNN()y = rnn.step(x) # x is an input vector, y is the RNN&#x27;s output vectorThe RNN class has some internal state that it gets to update every time step is called. In the simplest case this state consists of a single _hidden_ vector h. Here is an implementation of the step function in a Vanilla RNN:RNN ç±»å…·æœ‰ä¸€äº›å†…éƒ¨çŠ¶æ€ï¼Œæ¯æ¬¡è°ƒç”¨æ—¶ step éƒ½ä¼šæ›´æ–°ã€‚åœ¨æœ€ç®€å•çš„æƒ…å†µä¸‹ï¼Œæ­¤çŠ¶æ€ç”±å•ä¸ªéšè—å‘é‡ç»„æˆ h ã€‚ä»¥ä¸‹æ˜¯ Vanilla RNN ä¸­ step å‡½æ•°çš„å®ç°ï¼š 12345678class RNN: # ... def step(self, x): # update the hidden state self.h = np.tanh(np.dot(self.W_hh, self.h) + np.dot(self.W_xh, x)) # compute the output vector y = np.dot(self.W_hy, self.h) return y The above specifies the forward pass of a vanilla RNN. This RNNâ€™s parameters are the three matrices W_hh, W_xh, W_hy. The hidden state self.h is initialized with the zero vector. The np.tanh function implements a non-linearity that squashes the activations to the range [-1, 1]. Notice briefly how this works: There are two terms inside of the tanh: one is based on the previous hidden state and one is based on the current input. In numpy np.dot is matrix multiplication. The two intermediates interact with addition, and then get squashed by the tanh into the new state vector. If youâ€™re more comfortable with math notation, we can also write the hidden state update as $â„_ğ‘¡=tanhâ¡(ğ‘Š_{â„â„}â„_{ğ‘¡âˆ’1}+ğ‘Š_{ğ‘¥â„}ğ‘¥_ğ‘¡)$, where tanh is applied elementwise.ä¸Šè¿°å†…å®¹æè¿°äº†ä¸€ä¸ªåŸºç¡€RNNçš„å‰å‘ä¼ æ’­è¿‡ç¨‹ã€‚è¿™ä¸ªRNNçš„å‚æ•°æ˜¯ä¸‰ä¸ªçŸ©é˜µW_hhã€W_xhå’ŒW_hyã€‚éšè—çŠ¶æ€self.håˆå§‹åŒ–ä¸ºé›¶å‘é‡ã€‚np.tanhå‡½æ•°å®ç°äº†ä¸€ç§éçº¿æ€§æ¿€æ´»å‡½æ•°ï¼Œå°†æ¿€æ´»å€¼å‹ç¼©åˆ°[-1, 1]èŒƒå›´å†…ã€‚ç®€è¦è¯´æ˜å…¶å·¥ä½œåŸç†ï¼štanhå†…éƒ¨æœ‰ä¸¤ä¸ªé¡¹ï¼Œä¸€ä¸ªåŸºäºå‰ä¸€ä¸ªæ—¶é—´æ­¥éšè—çŠ¶æ€ï¼Œå¦ä¸€ä¸ªåŸºäºå½“å‰æ—¶é—´æ­¥è¾“å…¥ã€‚åœ¨numpyä¸­ï¼Œnp.dotè¡¨ç¤ºçŸ©é˜µä¹˜æ³•ã€‚è¿™ä¸¤ä¸ªä¸­é—´ç»“æœé€šè¿‡åŠ æ³•ç›¸äº’ä½œç”¨ï¼Œç„¶åé€šè¿‡tanhå‡½æ•°å‹ç¼©ä¸ºæ–°çš„çŠ¶æ€å‘é‡ã€‚å¦‚æœä½ å¯¹æ•°å­¦è¡¨ç¤ºæ³•æ›´ç†Ÿæ‚‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†éšè—çŠ¶æ€çš„æ›´æ–°å†™æˆ $â„_ğ‘¡=tanhâ¡(ğ‘Š_{â„â„}â„_{ğ‘¡âˆ’1}+ğ‘Š_{ğ‘¥â„}ğ‘¥_ğ‘¡)$ï¼Œå…¶ä¸­tanhé€å…ƒç´ åº”ç”¨ã€‚ âš ï¸ï¼šnumpyæ˜¯Pythonä¸­ä¸€ä¸ªéå¸¸æµè¡Œçš„æ•°å€¼è®¡ç®—åº“ã€‚np.tanhå‡½æ•°å’Œnp.dotå‡½æ•°éƒ½æ˜¯numpyåº“ä¸­çš„å‡½æ•°ã€‚np.tanhå‡½æ•°ç”¨äºè®¡ç®—å…ƒç´ çº§çš„åŒæ›²æ­£åˆ‡ï¼Œè€Œnp.dotå‡½æ•°ç”¨äºæ‰§è¡ŒçŸ©é˜µä¹˜æ³•ã€‚ We initialize the matrices of the RNN with random numbers and the bulk of work during training goes into finding the matrices that give rise to desirable behavior, as measured with some loss function that expresses your preference to what kinds of outputs $y$ youâ€™d like to see in response to your input sequences $x$.æˆ‘ä»¬ç”¨éšæœºæ•°åˆå§‹åŒ–RNNçš„çŸ©é˜µï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¤§éƒ¨åˆ†å·¥ä½œæ˜¯æ‰¾åˆ°èƒ½å¤Ÿäº§ç”Ÿç†æƒ³è¡Œä¸ºçš„çŸ©é˜µï¼Œè¿™é€šè¿‡æŸç§æŸå¤±å‡½æ•°æ¥è¡¡é‡ï¼Œè¯¥æŸå¤±å‡½æ•°è¡¨è¾¾äº†ä½ å¯¹è¾“å…¥åºåˆ—$x$å¯¹åº”è¾“å‡º$y$çš„æœŸæœ›ã€‚ Going deepGoing deep. RNNs are neural networks and everything works monotonically better (if done right) if you put on your deep learning hat and start stacking models up like pancakes. For instance, we can form a 2-layer recurrent network as follows:æ·±å…¥ç ”ç©¶ã€‚RNNæ˜¯ç¥ç»ç½‘ç»œçš„ä¸€ç§ï¼Œå¦‚æœæ–¹æ³•å¾—å½“ï¼Œé‡‡ç”¨æ·±åº¦å­¦ä¹ çš„æ–¹æ³•å¹¶åƒå ç…é¥¼ä¸€æ ·å°†æ¨¡å‹å †å èµ·æ¥ï¼Œä¸€åˆ‡éƒ½ä¼šå•è°ƒåœ°å˜å¾—æ›´å¥½ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å¦‚ä¸‹æ„å»ºä¸€ä¸ªä¸¤å±‚çš„å¾ªç¯ç¥ç»ç½‘ç»œï¼š12y1 = rnn1.step(x)y = rnn2.step(y1) In other words we have two separate RNNs: One RNN is receiving the input vectors and the second RNN is receiving the output of the first RNN as its input. Except neither of these RNNs know or care - itâ€™s all just vectors coming in and going out, and some gradients flowing through each module during backpropagation.æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„ RNNï¼šä¸€ä¸ª RNN æ¥æ”¶è¾“å…¥å‘é‡ï¼Œç¬¬äºŒä¸ª RNN æ¥æ”¶ç¬¬ä¸€ä¸ª RNN çš„è¾“å‡ºä½œä¸ºå…¶è¾“å…¥ã€‚é™¤äº†è¿™äº› RNN éƒ½ä¸çŸ¥é“æˆ–ä¸å…³å¿ƒä¹‹å¤–â€”â€”å®ƒä»¬éƒ½åªæ˜¯è¿›å‡ºçš„å‘é‡ï¼Œä»¥åŠåœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­æµè¿‡æ¯ä¸ªæ¨¡å—çš„ä¸€äº›æ¢¯åº¦ã€‚ Getting fancyGetting fancy. Iâ€™d like to briefly mention that in practice most of us use a slightly different formulation than what I presented above called a _Long Short-Term Memory_ (LSTM) network. The LSTM is a particular type of recurrent network that works slightly better in practice, owing to its more powerful update equation and some appealing backpropagation dynamics. I wonâ€™t go into details, but everything Iâ€™ve said about RNNs stays exactly the same, except the mathematical form for computing the update (the line self.h = ... ) gets a little more complicated. From here on I will use the terms â€œRNN/LSTMâ€ interchangeably but all experiments in this post use an LSTM.æ›´å¤æ‚çš„æ¨¡å‹ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬å¤§å¤šæ•°äººä½¿ç”¨çš„å…¬å¼ä¸æˆ‘ä¸Šé¢æåˆ°çš„ç¨æœ‰ä¸åŒï¼Œè¢«ç§°ä¸ºé•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼ˆLSTMï¼‰ã€‚LSTMæ˜¯ä¸€ç§ç‰¹å®šç±»å‹çš„å¾ªç¯ç¥ç»ç½‘ç»œï¼Œå®é™…ä¸Šæ•ˆæœæ›´å¥½ï¼Œå› ä¸ºå®ƒå…·æœ‰æ›´å¼ºå¤§çš„æ›´æ–°æ–¹ç¨‹å’Œä¸€äº›æ›´å…·å¸å¼•åŠ›çš„åå‘ä¼ æ’­åŠ¨æ€ã€‚æˆ‘ä¸ä¼šæ·±å…¥è®¨è®ºç»†èŠ‚ï¼Œä½†æˆ‘æ‰€è¯´çš„å…³äºRNNçš„ä¸€åˆ‡éƒ½å®Œå…¨ç›¸åŒï¼Œé™¤äº†è®¡ç®—æ›´æ–°çš„æ•°å­¦å½¢å¼ï¼ˆå³self.h = â€¦è¿™ä¸€è¡Œï¼‰å˜å¾—ç¨å¾®å¤æ‚äº†ä¸€äº›ã€‚ä»ç°åœ¨å¼€å§‹ï¼Œæˆ‘ä¼šäº¤æ›¿ä½¿ç”¨â€œRNN/LSTMâ€è¿™ä¸¤ä¸ªæœ¯è¯­ï¼Œä½†æœ¬æ–‡ä¸­çš„æ‰€æœ‰å®éªŒéƒ½ä½¿ç”¨LSTMã€‚ Character-Level Language Modelså­—ç¬¦çº§è¯­è¨€æ¨¡å‹ Okay, so we have an idea about what RNNs are, why they are super exciting, and how they work. Weâ€™ll now ground this in a fun application: Weâ€™ll train RNN character-level language models. That is, weâ€™ll give the RNN a huge chunk of text and ask it to model the probability distribution of the next character in the sequence given a sequence of previous characters. This will then allow us to generate new text one character at a time.å¥½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å·²ç»å¯¹RNNæ˜¯ä»€ä¹ˆã€ä¸ºä»€ä¹ˆå®ƒä»¬éå¸¸ä»¤äººå…´å¥‹ä»¥åŠå®ƒä»¬å¦‚ä½•å·¥ä½œæœ‰äº†ä¸€å®šçš„äº†è§£ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†æŠŠè¿™äº›çŸ¥è¯†åº”ç”¨åˆ°ä¸€ä¸ªæœ‰è¶£çš„å®é™…åº”ç”¨ä¸­ï¼šæˆ‘ä»¬å°†è®­ç»ƒRNNå­—ç¬¦çº§åˆ«çš„è¯­è¨€æ¨¡å‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä¼šç»™RNNæä¾›ä¸€å¤§æ®µæ–‡æœ¬ï¼Œå¹¶è®©å®ƒæ ¹æ®å‰é¢å­—ç¬¦çš„åºåˆ—æ¥å»ºæ¨¡ä¸‹ä¸€ä¸ªå­—ç¬¦çš„æ¦‚ç‡åˆ†å¸ƒã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸€æ¬¡ç”Ÿæˆä¸€ä¸ªå­—ç¬¦çš„æ–°æ–‡æœ¬ã€‚ As a working example, suppose we only had a vocabulary of four possible letters â€œheloâ€, and wanted to train an RNN on the training sequence â€œhelloâ€. This training sequence is in fact a source of 4 separate training examples: 1. The probability of â€œeâ€ should be likely given the context of â€œhâ€, 2. â€œlâ€ should be likely in the context of â€œheâ€, 3. â€œlâ€ should also be likely given the context of â€œhelâ€, and finally 4. â€œoâ€ should be likely given the context of â€œhellâ€.ä½œä¸ºä¸€ä¸ªå®é™…ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬åªæœ‰å››ä¸ªå¯èƒ½çš„å­—æ¯â€œheloâ€çš„è¯æ±‡è¡¨ï¼Œå¹¶ä¸”æƒ³è¦åœ¨è®­ç»ƒåºåˆ—â€œhelloâ€ä¸Šè®­ç»ƒä¸€ä¸ªRNNã€‚è¿™ä¸ªè®­ç»ƒåºåˆ—å®é™…ä¸Šæ˜¯å››ä¸ªç‹¬ç«‹çš„è®­ç»ƒç¤ºä¾‹çš„æ¥æºï¼š åœ¨â€œhâ€çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œâ€œeâ€çš„æ¦‚ç‡åº”è¯¥å¾ˆå¤§ã€‚ åœ¨â€œheâ€çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œâ€œlâ€çš„æ¦‚ç‡åº”è¯¥å¾ˆå¤§ã€‚ åœ¨â€œhelâ€çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œâ€œlâ€çš„æ¦‚ç‡ä¹Ÿåº”è¯¥å¾ˆå¤§ã€‚ æœ€åï¼Œåœ¨â€œhellâ€çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œâ€œoâ€çš„æ¦‚ç‡åº”è¯¥å¾ˆå¤§ã€‚ Concretely, we will encode each character into a vector using 1-of-k encoding (i.e. all zero except for a single one at the index of the character in the vocabulary), and feed them into the RNN one at a time with the step function. We will then observe a sequence of 4-dimensional output vectors (one dimension per character), which we interpret as the confidence the RNN currently assigns to each character coming next in the sequence. Hereâ€™s a diagram:å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨1-of-kç¼–ç å°†æ¯ä¸ªå­—ç¬¦ç¼–ç æˆä¸€ä¸ªå‘é‡ï¼ˆå³ï¼Œé™¤äº†åœ¨è¯æ±‡è¡¨ä¸­å­—ç¬¦ç´¢å¼•å¤„ä¸º1ï¼Œå…¶ä½™å…¨ä¸º0ï¼‰ï¼Œç„¶åç”¨stepå‡½æ•°å°†å®ƒä»¬é€ä¸€è¾“å…¥RNNã€‚éšåï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ç³»åˆ—4ç»´è¾“å‡ºå‘é‡ï¼ˆæ¯ä¸ªå­—ç¬¦ä¸€ä¸ªç»´åº¦ï¼‰ï¼Œæˆ‘ä»¬å°†è¿™äº›è¾“å‡ºå‘é‡è§£é‡Šä¸ºRNNå½“å‰å¯¹åºåˆ—ä¸­ä¸‹ä¸€ä¸ªå­—ç¬¦çš„ç½®ä¿¡åº¦ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºæ„å›¾ï¼š An example RNN with 4-dimensional input and output layers, and a hidden layer of 3 units (neurons). This diagram shows the activations in the forward pass when the RNN is fed the characters â€œhellâ€ as input. The output layer contains confidences the RNN assigns for the next character (vocabulary is â€œh,e,l,oâ€); We want the green numbers to be high and red numbers to be low.å…·æœ‰ 4 ç»´è¾“å…¥å’Œè¾“å‡ºå±‚çš„ç¤ºä¾‹ RNNï¼Œä»¥åŠ 3 ä¸ªå•å…ƒï¼ˆç¥ç»å…ƒï¼‰çš„éšè—å±‚ã€‚æ­¤å›¾æ˜¾ç¤ºäº†å°†å­—ç¬¦â€œhellâ€ä½œä¸ºè¾“å…¥é¦ˆé€ RNN æ—¶å‰å‘ä¼ é€’ä¸­çš„æ¿€æ´»ã€‚è¾“å‡ºå±‚åŒ…å« RNN ä¸ºä¸‹ä¸€ä¸ªå­—ç¬¦åˆ†é…çš„ç½®ä¿¡åº¦ï¼ˆè¯æ±‡ä¸ºâ€œhï¼Œeï¼Œlï¼Œoâ€ï¼‰;æˆ‘ä»¬å¸Œæœ›ç»¿è‰²æ•°å­—é«˜ï¼Œçº¢è‰²æ•°å­—ä½ã€‚ âš ï¸ï¼š W_xh æŒ‡è¾“å…¥å±‚å’Œéšè—å±‚ä¹‹é—´çš„æƒé‡çŸ©é˜µï¼Œ W_hh æŒ‡éšè—å±‚ä¹‹é—´çš„æƒé‡çŸ©é˜µï¼Œ W_hy æŒ‡éšè—å±‚å’Œè¾“å‡ºå±‚ä¹‹é—´çš„æƒé‡çŸ©é˜µ For example, we see that in the first time step when the RNN saw the character â€œhâ€ it assigned confidence of 1.0 to the next letter being â€œhâ€, 2.2 to letter â€œeâ€, -3.0 to â€œlâ€, and 4.1 to â€œoâ€. Since in our training data (the string â€œhelloâ€) the next correct character is â€œeâ€, we would like to increase its confidence (green) and decrease the confidence of all other letters (red). Similarly, we have a desired target character at every one of the 4 time steps that weâ€™d like the network to assign a greater confidence to. Since the RNN consists entirely of differentiable operations we can run the backpropagation algorithm (this is just a recursive application of the chain rule from calculus) to figure out in what direction we should adjust every one of its weights to increase the scores of the correct targets (green bold numbers). We can then perform a _parameter update_, which nudges every weight a tiny amount in this gradient direction. If we were to feed the same inputs to the RNN after the parameter update we would find that the scores of the correct characters (e.g. â€œeâ€ in the first time step) would be slightly higher (e.g. 2.3 instead of 2.2), and the scores of incorrect characters would be slightly lower. We then repeat this process over and over many times until the network converges and its predictions are eventually consistent with the training data in that correct characters are always predicted next.ä¾‹å¦‚ï¼Œæˆ‘ä»¬çœ‹åˆ°åœ¨ç¬¬ä¸€ä¸ªæ—¶é—´æ­¥ä¸­ï¼Œå½“RNNçœ‹åˆ°å­—ç¬¦â€œhâ€æ—¶ï¼Œå®ƒå¯¹ä¸‹ä¸€ä¸ªå­—ç¬¦çš„ç½®ä¿¡åº¦åˆ†é…ä¸ºï¼šå­—ç¬¦â€œhâ€æ˜¯1.0ï¼Œå­—ç¬¦â€œeâ€æ˜¯2.2ï¼Œå­—ç¬¦â€œlâ€æ˜¯-3.0ï¼Œå­—ç¬¦â€œoâ€æ˜¯4.1ã€‚ç”±äºåœ¨æˆ‘ä»¬çš„è®­ç»ƒæ•°æ®ï¼ˆå­—ç¬¦ä¸²â€œhelloâ€ï¼‰ä¸­ï¼Œä¸‹ä¸€ä¸ªæ­£ç¡®å­—ç¬¦æ˜¯â€œeâ€ï¼Œæˆ‘ä»¬å¸Œæœ›å¢åŠ â€œeâ€çš„ç½®ä¿¡åº¦ï¼ˆç”¨ç»¿è‰²è¡¨ç¤ºï¼‰ï¼Œå¹¶é™ä½æ‰€æœ‰å…¶ä»–å­—ç¬¦çš„ç½®ä¿¡åº¦ï¼ˆç”¨çº¢è‰²è¡¨ç¤ºï¼‰ã€‚ç±»ä¼¼åœ°ï¼Œåœ¨æ¯ä¸€ä¸ªæ—¶é—´æ­¥ä¸Šï¼Œæˆ‘ä»¬éƒ½æœ‰ä¸€ä¸ªæœŸæœ›çš„ç›®æ ‡å­—ç¬¦ï¼Œå¸Œæœ›ç½‘ç»œèƒ½å¯¹å…¶åˆ†é…æ›´é«˜çš„ç½®ä¿¡åº¦ã€‚ç”±äºRNNå®Œå…¨ç”±å¯å¾®æ“ä½œç»„æˆï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œåå‘ä¼ æ’­ç®—æ³•ï¼ˆè¿™åªæ˜¯å¾®ç§¯åˆ†ä¸­é“¾å¼æ³•åˆ™çš„é€’å½’åº”ç”¨ï¼‰æ¥ç¡®å®šåº”è°ƒæ•´æ¯ä¸ªæƒé‡çš„æ–¹å‘ï¼Œä»¥æé«˜æ­£ç¡®ç›®æ ‡çš„å¾—åˆ†ï¼ˆç»¿è‰²åŠ ç²—æ•°å­—ï¼‰ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå‚æ•°æ›´æ–°ï¼Œå°†æ¯ä¸ªæƒé‡åœ¨è¯¥æ¢¯åº¦æ–¹å‘ä¸Šå¾®è°ƒä¸€ä¸ªå°é‡ã€‚å¦‚æœåœ¨å‚æ•°æ›´æ–°åå†æ¬¡å°†ç›¸åŒçš„è¾“å…¥æä¾›ç»™RNNï¼Œæˆ‘ä»¬ä¼šå‘ç°æ­£ç¡®å­—ç¬¦çš„å¾—åˆ†ï¼ˆä¾‹å¦‚ï¼Œç¬¬ä¸€ä¸ªæ—¶é—´æ­¥ä¸­çš„â€œeâ€ï¼‰ä¼šç•¥æœ‰æé«˜ï¼ˆä¾‹å¦‚ï¼Œä»2.2æé«˜åˆ°2.3ï¼‰ï¼Œè€Œé”™è¯¯å­—ç¬¦çš„å¾—åˆ†ä¼šç•¥æœ‰é™ä½ã€‚ç„¶åï¼Œæˆ‘ä»¬åå¤è¿›è¡Œè¿™ä¸ªè¿‡ç¨‹å¤šæ¬¡ï¼Œç›´åˆ°ç½‘ç»œæ”¶æ•›ï¼Œå…¶é¢„æµ‹æœ€ç»ˆä¸è®­ç»ƒæ•°æ®ä¸€è‡´ï¼Œå³æ€»æ˜¯é¢„æµ‹å‡ºæ­£ç¡®çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ã€‚ âš ï¸ï¼šå›¾ä¸­output å±‚ æ•°å­—å¹¶ä¸æ˜¯ç½®ä¿¡åº¦ï¼Œè€Œæ˜¯logits, è¿™äº›logitså¹¶ä¸ç›´æ¥è¡¨ç¤ºæ¦‚ç‡/ç½®ä¿¡åº¦,è¦å°†è¿™äº›logitsè½¬åŒ–ä¸ºæ¦‚ç‡ï¼ˆç½®ä¿¡åº¦ï¼‰ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨Softmaxå‡½æ•°ã€‚ A more technical explanation is that we use the standard Softmax classifier (also commonly referred to as the cross-entropy loss) on every output vector simultaneously. The RNN is trained with mini-batch Stochastic Gradient Descent and I like to use RMSProp or Adam (per-parameter adaptive learning rate methods) to stablilize the updates.æ›´æŠ€æœ¯æ€§çš„è§£é‡Šæ˜¯ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªè¾“å‡ºå‘é‡ä¸Š åŒæ—¶ä½¿ç”¨æ ‡å‡†çš„Softmaxåˆ†ç±»å™¨ï¼ˆä¹Ÿå¸¸è¢«ç§°ä¸ºäº¤å‰ç†µæŸå¤±ï¼‰ã€‚RNNä½¿ç”¨å°æ‰¹é‡éšæœºæ¢¯åº¦ä¸‹é™æ³•è¿›è¡Œè®­ç»ƒï¼Œæˆ‘å–œæ¬¢ä½¿ç”¨RMSPropæˆ–Adamï¼ˆæ¯ä¸ªå‚æ•°çš„è‡ªé€‚åº”å­¦ä¹ ç‡æ–¹æ³•ï¼‰æ¥ç¨³å®šæ›´æ–°ã€‚ Notice also that the first time the character â€œlâ€ is input, the target is â€œlâ€, but the second time the target is â€œoâ€. The RNN therefore cannot rely on the input alone and must use its recurrent connection to keep track of the context to achieve this task.å¦è¯·æ³¨æ„ï¼Œç¬¬ä¸€æ¬¡è¾“å…¥å­—ç¬¦â€œlâ€æ—¶ï¼Œç›®æ ‡æ˜¯â€œlâ€ï¼Œä½†ç¬¬äºŒæ¬¡ç›®æ ‡æ˜¯â€œoâ€ã€‚å› æ­¤ï¼ŒRNN ä¸èƒ½å•ç‹¬ä¾èµ–è¾“å…¥ï¼Œå¿…é¡»ä½¿ç”¨å…¶å¾ªç¯è¿æ¥æ¥è·Ÿè¸ªä¸Šä¸‹æ–‡ä»¥å®ç°æ­¤ä»»åŠ¡ã€‚ At test time, we feed a character into the RNN and get a distribution over what characters are likely to come next. We sample from this distribution, and feed it right back in to get the next letter. Repeat this process and youâ€™re sampling text! Lets now train an RNN on different datasets and see what happens.åœ¨æµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªå­—ç¬¦è¾“å…¥RNNï¼Œå¹¶è·å¾—ä¸‹ä¸€ä¸ªå­—ç¬¦å¯èƒ½å‡ºç°çš„æ¦‚ç‡åˆ†å¸ƒã€‚æˆ‘ä»¬ä»è¿™ä¸ªåˆ†å¸ƒä¸­é‡‡æ ·ï¼Œå¹¶å°†é‡‡æ ·å¾—åˆ°çš„å­—ç¬¦å†æ¬¡è¾“å…¥RNNä»¥è·å–ä¸‹ä¸€ä¸ªå­—ç¬¦ã€‚é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œå°±å¯ä»¥ç”Ÿæˆæ–‡æœ¬äº†ï¼ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨ä¸åŒçš„æ•°æ®é›†ä¸Šè®­ç»ƒä¸€ä¸ªRNNï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ To further clarify, for educational purposes I also wrote a minimal character-level RNN language model in Python/numpy. It is only about 100 lines long and hopefully it gives a concise, concrete and useful summary of the above if youâ€™re better at reading code than text. Weâ€™ll now dive into example results, produced with the much more efficient Lua/Torch codebase.ä¸ºäº†è¿›ä¸€æ­¥è¯´æ˜ï¼Œæˆ‘è¿˜ç”¨Pythonå’Œnumpyç¼–å†™äº†ä¸€ä¸ªæœ€å°çš„å­—ç¬¦çº§RNNè¯­è¨€æ¨¡å‹ã€‚å®ƒåªæœ‰å¤§çº¦100è¡Œä»£ç ï¼Œå¸Œæœ›èƒ½ä¸ºä½ æä¾›ä¸€ä¸ªç®€æ´ã€å…·ä½“ä¸”æœ‰ç”¨çš„æ€»ç»“ï¼Œå¦‚æœä½ æ›´æ“…é•¿é˜…è¯»ä»£ç è€Œä¸æ˜¯æ–‡å­—ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨ä½¿ç”¨æ›´åŠ é«˜æ•ˆçš„Lua/Torchä»£ç åº“ç”Ÿæˆçš„ç¤ºä¾‹ç»“æœã€‚ Fun with RNNsAll 5 example character models below were trained with the code Iâ€™m releasing on Github. The input in each case is a single file with some text, and weâ€™re training an RNN to predict the next character in the sequence.ä¸‹é¢çš„æ‰€æœ‰ 5 ä¸ªç¤ºä¾‹å­—ç¬¦æ¨¡å‹éƒ½æ˜¯ä½¿ç”¨æˆ‘åœ¨ Github ä¸Šå‘å¸ƒçš„ä»£ç è®­ç»ƒçš„ã€‚æ¯ç§æƒ…å†µä¸‹çš„è¾“å…¥éƒ½æ˜¯ä¸€ä¸ªåŒ…å«ä¸€äº›æ–‡æœ¬çš„å•ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬æ­£åœ¨è®­ç»ƒä¸€ä¸ª RNN æ¥é¢„æµ‹åºåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ã€‚ Paul Graham generator ä¿ç½—Â·æ ¼é›·å„å§†å‘ç”µæœºLets first try a small dataset of English as a sanity check. My favorite fun dataset is the concatenation of Paul Grahamâ€™s essays. The basic idea is that thereâ€™s a lot of wisdom in these essays, but unfortunately Paul Graham is a relatively slow generator. Wouldnâ€™t it be great if we could sample startup wisdom on demand? Thatâ€™s where an RNN comes in.è®©æˆ‘ä»¬é¦–å…ˆå°è¯•ä¸€ä¸ªå°å‹çš„è‹±æ–‡æ•°æ®é›†æ¥è¿›è¡ŒåŸºæœ¬æ£€æŸ¥ã€‚æˆ‘æœ€å–œæ¬¢çš„æœ‰è¶£æ•°æ®é›†æ˜¯ä¿ç½—Â·æ ¼é›·å„å§†ï¼ˆPaul Grahamï¼‰çš„æ–‡ç« åˆé›†ã€‚åŸºæœ¬æƒ³æ³•æ˜¯ï¼Œè¿™äº›æ–‡ç« ä¸­æœ‰å¾ˆå¤šæ™ºæ…§ï¼Œä½†é—æ†¾çš„æ˜¯ï¼Œä¿ç½—Â·æ ¼é›·å„å§†çš„å†™ä½œé€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ã€‚å¦‚æœæˆ‘ä»¬èƒ½æŒ‰éœ€é‡‡æ ·åˆ›ä¸šæ™ºæ…§ï¼Œé‚£ä¸æ˜¯å¾ˆæ£’å—ï¼Ÿè¿™æ­£æ˜¯RNNçš„ç”¨æ­¦ä¹‹åœ°ã€‚ Concatenating all pg essays over the last ~5 years we get approximately 1MB text file, or about 1 million characters (this is considered a very small dataset by the way). _Technical:_ Lets train a 2-layer LSTM with 512 hidden nodes (approx. 3.5 million parameters), and with dropout of 0.5 after each layer. Weâ€™ll train with batches of 100 examples and truncated backpropagation through time of length 100 characters. With these settings one batch on a TITAN Z GPU takes about 0.46 seconds (this can be cut in half with 50 character BPTT at negligible cost in performance). Without further ado, lets see a sample from the RNN:å°†è¿‡å»å¤§çº¦5å¹´é—´çš„æ‰€æœ‰ä¿ç½—Â·æ ¼é›·å„å§†çš„æ–‡ç« åˆå¹¶èµ·æ¥ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªå¤§çº¦1MBçš„æ–‡æœ¬æ–‡ä»¶ï¼Œçº¦100ä¸‡ä¸ªå­—ç¬¦ï¼ˆé¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œè¿™è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªéå¸¸å°çš„æ•°æ®é›†ï¼‰ã€‚æŠ€æœ¯ç»†èŠ‚ï¼šè®©æˆ‘ä»¬è®­ç»ƒä¸€ä¸ªå…·æœ‰2å±‚ã€æ¯å±‚512ä¸ªéšè—èŠ‚ç‚¹çš„LSTMï¼ˆå¤§çº¦350ä¸‡ä¸ªå‚æ•°ï¼‰ï¼Œå¹¶åœ¨æ¯å±‚ä¹‹åä½¿ç”¨0.5çš„dropoutã€‚æˆ‘ä»¬å°†ä½¿ç”¨100ä¸ªæ ·æœ¬çš„æ‰¹æ¬¡å’Œé•¿åº¦ä¸º100å­—ç¬¦çš„æˆªæ–­æ—¶é—´åå‘ä¼ æ’­è¿›è¡Œè®­ç»ƒã€‚åœ¨è¿™äº›è®¾ç½®ä¸‹ï¼Œåœ¨TITAN Z GPUä¸Šå¤„ç†ä¸€ä¸ªæ‰¹æ¬¡å¤§çº¦éœ€è¦0.46ç§’ï¼ˆä½¿ç”¨50å­—ç¬¦çš„æˆªæ–­æ—¶é—´åå‘ä¼ æ’­ï¼Œå‡ ä¹ä¸ä¼šå½±å“æ€§èƒ½ï¼Œå¯ä»¥å°†æ—¶é—´å‡åŠï¼‰ã€‚äº‹ä¸å®œè¿Ÿï¼Œè®©æˆ‘ä»¬çœ‹çœ‹RNNç”Ÿæˆçš„ä¸€ä¸ªæ ·æœ¬ï¼š _â€œThe surprised in investors werenâ€™t going to raise money. Iâ€™m not the company with the time there are all interesting quickly, donâ€™t have to get off the same programmers. Thereâ€™s a super-angel round fundraising, why do you can do. If you have a different physical investment are become in people who reduced in a startup with the way to argument the acquirer could see them just that youâ€™re also the founders will part of usersâ€™ affords that and an alternation to the idea. [2] Donâ€™t work at first member to see the way kids will seem in advance of a bad successful startup. And if you have to act the big company too.â€__â€œæŠ•èµ„è€…çš„æƒŠè®¶æ˜¯ï¼Œä»–ä»¬å¹¶ä¸æ‰“ç®—ç­¹é›†èµ„é‡‘ã€‚æˆ‘ä¸æ˜¯é‚£ä¸ªæœ‰æ—¶é—´çš„å…¬å¸ï¼Œæœ‰è¶£çš„äº‹æƒ…å¾ˆå¿«å°±ä¼šå‡ºç°ï¼Œä¸éœ€è¦è®©ç›¸åŒçš„ç¨‹åºå‘˜ç¦»å¼€ã€‚æœ‰ä¸€ä¸ªè¶…çº§å¤©ä½¿è½®çš„èèµ„ï¼Œä½ ä¸ºä»€ä¹ˆè¦è¿™æ ·åšã€‚å¦‚æœä½ æœ‰ä¸åŒçš„å®ä½“æŠ•èµ„ï¼Œä¼šæˆä¸ºé‚£äº›åœ¨åˆåˆ›å…¬å¸é‡Œå‡å°‘çš„äººä¸­äº‰è®ºçš„æ–¹å¼ï¼Œæ”¶è´­è€…å¯èƒ½ä¼šçœ‹åˆ°ä»–ä»¬åªæ˜¯åˆ›å§‹äººå°†æˆä¸ºç”¨æˆ·åŠªåŠ›çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ˜¯å¯¹æƒ³æ³•çš„ä¸€ç§æ›¿ä»£ã€‚[2] ä¸€å¼€å§‹ä¸è¦åœ¨æˆå‘˜èº«ä¸Šå·¥ä½œï¼Œçœ‹å­©å­ä»¬å°†å¦‚ä½•æå‰åœ¨ä¸€ä¸ªå¤±è´¥çš„æˆåŠŸåˆåˆ›å…¬å¸ä¸­è¡¨ç°å‡ºæ¥ã€‚è€Œä¸”ï¼Œå¦‚æœä½ å¿…é¡»è¡ŒåŠ¨ï¼Œé‚£ä¹ˆå¤§å…¬å¸ä¹Ÿä¸€æ ·ã€‚â€_ Okay, clearly the above is unfortunately not going to replace Paul Graham anytime soon, but remember that the RNN had to learn English completely from scratch and with a small dataset (including where you put commas, apostrophes and spaces). I also like that it learns to support its own arguments (e.g. [2], above). Sometimes it says something that offers a glimmer of insight, such as _â€œa company is a meeting to think to investorsâ€_. Hereâ€™s a link to 50K character sample if youâ€™d like to see more.å¥½çš„ï¼Œå¾ˆæ˜æ˜¾ï¼Œä»¥ä¸Šå†…å®¹æš‚æ—¶è¿˜æ— æ³•æ›¿ä»£ä¿ç½—Â·æ ¼é›·å„å§†ï¼Œä½†è¯·è®°ä½ï¼ŒRNNå¿…é¡»ä»é›¶å¼€å§‹å­¦ä¹ è‹±è¯­ï¼Œè€Œä¸”æ˜¯ç”¨ä¸€ä¸ªå°æ•°æ®é›†ï¼ˆåŒ…æ‹¬é€—å·ã€æ’‡å·å’Œç©ºæ ¼çš„ä½ç½®ï¼‰ã€‚æˆ‘ä¹Ÿå–œæ¬¢å®ƒå­¦ä¼šäº†æ”¯æŒè‡ªå·±çš„è®ºç‚¹ï¼ˆä¾‹å¦‚ï¼Œä¸Šæ–‡ä¸­çš„[2]ï¼‰ã€‚æœ‰æ—¶ï¼Œå®ƒä¼šè¯´å‡ºä¸€äº›ç•¥å¸¦å¯å‘æ€§çš„è¯ï¼Œæ¯”å¦‚â€œa company is a meeting to think to investorsâ€ï¼ˆå…¬å¸æ˜¯ä¸æŠ•èµ„è€…æ€è€ƒçš„ä¼šè®®ï¼‰ã€‚å¦‚æœä½ æƒ³æŸ¥çœ‹æ›´å¤šï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª50Kå­—ç¬¦çš„æ ·æœ¬é“¾æ¥ã€‚ Temperature. We can also play with the temperature of the Softmax during sampling. Decreasing the temperature from 1 to some lower number (e.g. 0.5) makes the RNN more confident, but also more conservative in its samples. Conversely, higher temperatures will give more diversity but at cost of more mistakes (e.g. spelling mistakes, etc). In particular, setting temperature very near zero will give the most likely thing that Paul Graham might say:æ¸©åº¦ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨é‡‡æ ·è¿‡ç¨‹ä¸­è°ƒæ•´Softmaxçš„æ¸©åº¦ã€‚å°†æ¸©åº¦ä»1é™ä½åˆ°æŸä¸ªè¾ƒä½çš„æ•°å€¼ï¼ˆä¾‹å¦‚0.5ï¼‰ï¼Œä¼šä½¿RNNæ›´æœ‰ä¿¡å¿ƒï¼Œä½†ä¹Ÿæ›´ä¿å®ˆäºå…¶é‡‡æ ·ç»“æœã€‚ç›¸åï¼Œè¾ƒé«˜çš„æ¸©åº¦ä¼šå¸¦æ¥æ›´å¤šçš„å¤šæ ·æ€§ï¼Œä½†ä»£ä»·æ˜¯ä¼šæœ‰æ›´å¤šçš„é”™è¯¯ï¼ˆä¾‹å¦‚æ‹¼å†™é”™è¯¯ç­‰ï¼‰ã€‚ç‰¹åˆ«æ˜¯ï¼Œå°†æ¸©åº¦è®¾ç½®å¾—éå¸¸æ¥è¿‘é›¶ï¼Œä¼šäº§ç”Ÿæœ€æœ‰å¯èƒ½æ˜¯ä¿ç½—Â·æ ¼é›·å„å§†ä¼šè¯´çš„è¯ï¼š _â€œis that they were all the same thing that was a startup is that they were all the same thing that was a startup is that they were all the same thing that was a startup is that they were all the sameâ€â€œä»–ä»¬éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåˆ›ä¸šå…¬å¸æ˜¯ï¼Œä»–ä»¬éƒ½æ˜¯åˆ›ä¸šå…¬å¸ï¼Œä»–ä»¬éƒ½æ˜¯ä¸€æ ·çš„åˆ›ä¸šå…¬å¸ï¼Œä»–ä»¬éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåˆ›ä¸šå…¬å¸æ˜¯ä¸€æ ·çš„â€_ looks like weâ€™ve reached an infinite loop about startups.çœ‹èµ·æ¥æˆ‘ä»¬å·²ç»è¾¾åˆ°äº†ä¸€ä¸ªå…³äºåˆåˆ›å…¬å¸çš„æ— é™å¾ªç¯ã€‚ Shakespeare èå£«æ¯”äºšIt looks like we can learn to spell English words. But how about if there is more structure and style in the data? To examine this I downloaded all the works of Shakespeare and concatenated them into a single (4.4MB) file. We can now afford to train a larger network, in this case lets try a 3-layer RNN with 512 hidden nodes on each layer. After we train the network for a few hours we obtain samples such as:çœ‹èµ·æ¥æˆ‘ä»¬å¯ä»¥å­¦ä¼šæ‹¼å†™è‹±è¯­å•è¯ã€‚ä½†å¦‚æœæ•°æ®ä¸­æœ‰æ›´å¤šçš„ç»“æ„å’Œé£æ ¼å‘¢ï¼Ÿä¸ºæ­¤ï¼Œæˆ‘ä¸‹è½½äº†èå£«æ¯”äºšçš„æ‰€æœ‰ä½œå“ï¼Œå¹¶å°†å®ƒä»¬åˆå¹¶æˆä¸€ä¸ªå•ä¸€çš„ï¼ˆ4.4MBï¼‰æ–‡ä»¶ã€‚æˆ‘ä»¬ç°åœ¨æœ‰èƒ½åŠ›è®­ç»ƒä¸€ä¸ªæ›´å¤§çš„ç½‘ç»œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè®©æˆ‘ä»¬å°è¯•ä¸€ä¸ª3å±‚çš„RNNï¼Œæ¯å±‚æœ‰512ä¸ªéšè—èŠ‚ç‚¹ã€‚ç»è¿‡å‡ ä¸ªå°æ—¶çš„è®­ç»ƒï¼Œæˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹æ ·æœ¬ï¼š123456789101112131415161718192021222324PANDARUS:Alas, I think he shall be come approached and the dayWhen little srain would be attain&#x27;d into being never fed,And who is but a chain and subjects of his death,I should not sleep.Second Senator:They are away this miseries, produced upon my soul,Breaking and strongly should be buried, when I perishThe earth and thoughts of many states.DUKE VINCENTIO:Well, your wit is in the care of side and that.Second Lord:They would be ruled after this chamber, andmy fair nues begun out of the fact, to be conveyed,Whose noble souls I&#x27;ll have the heart of the wars.Clown:Come, sir, I will make did behold your worship.VIOLA:I&#x27;ll drink it. Remember, all the RNN knows are characters, so in particular it samples both speakerâ€™s names and the contents. Sometimes we also get relatively extented monologue passages, such as:è¯·è®°ä½ï¼ŒRNNæ‰€çŸ¥é“çš„åªæœ‰å­—ç¬¦ï¼Œå› æ­¤å®ƒæ—¢é‡‡æ ·è¯´è¯è€…çš„åå­—ï¼Œä¹Ÿé‡‡æ ·å†…å®¹ã€‚æœ‰æ—¶æˆ‘ä»¬è¿˜ä¼šå¾—åˆ°ç›¸å¯¹è¾ƒé•¿çš„ç‹¬ç™½æ®µè½ï¼Œä¾‹å¦‚ï¼š12345678910111213141516171819VIOLA:Why, Salisbury must find his flesh and thoughtThat which I am not aps, not a man and in fire,To show the reining of the raven and the warsTo grace my hand reproach within, and not a fair are hand,That Caesar and my goodly father&#x27;s world;When I was heaven of presence and our fleets,We spare with hours, but cut thy council I am great,Murdered and by thy master&#x27;s ready thereMy power to give thee but so much as hell:Some service in the noble bondman here,Would show him to her wine.KING LEAR:O, if you were a feeble sight, the courtesy of your law,Your sight and several breath, will wear the godsWith his heads, and my hands are wonder&#x27;d at the deeds,So drop upon your lordship&#x27;s head, and your opinionShall be against your honour. I can barely recognize these samples from actual Shakespeare :) If you like Shakespeare, you might appreciate this 100,000 character sample. Of course, you can also generate an infinite amount of your own samples at different temperatures with the provided code.æˆ‘å‡ ä¹æ— æ³•è¾¨è®¤è¿™äº›æ ·æœ¬æ˜¯å¦çœŸçš„æ˜¯èå£«æ¯”äºšçš„ä½œå“ :) å¦‚æœä½ å–œæ¬¢èå£«æ¯”äºšï¼Œä½ å¯èƒ½ä¼šå–œæ¬¢è¿™ä¸ª10ä¸‡å­—ç¬¦çš„æ ·æœ¬ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æä¾›çš„ä»£ç åœ¨ä¸åŒæ¸©åº¦ä¸‹ç”Ÿæˆæ— é™é‡çš„æ ·æœ¬ã€‚ Wikipedia ç»´åŸºç™¾ç§‘We saw that the LSTM can learn to spell words and copy general syntactic structures. Lets further increase the difficulty and train on structured markdown. In particular, lets take the Hutter Prize 100MB dataset of raw Wikipedia and train an LSTM. Following Graves et al., I used the first 96MB for training, the rest for validation and ran a few models overnight. We can now sample Wikipedia articles! Below are a few fun excerpts. First, some basic markdown output:æˆ‘ä»¬å·²ç»çœ‹åˆ°LSTMå¯ä»¥å­¦ä¼šæ‹¼å†™å•è¯å’Œå¤åˆ¶ä¸€èˆ¬çš„å¥æ³•ç»“æ„ã€‚è®©æˆ‘ä»¬è¿›ä¸€æ­¥å¢åŠ éš¾åº¦ï¼Œè®­ç»ƒåœ¨ç»“æ„åŒ–çš„Markdownä¸Šã€‚ç‰¹åˆ«æ˜¯ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨Hutter Prizeçš„100MBåŸå§‹ç»´åŸºç™¾ç§‘æ•°æ®é›†æ¥è®­ç»ƒä¸€ä¸ªLSTMã€‚æŒ‰ç…§Gravesç­‰äººçš„æ–¹æ³•ï¼Œæˆ‘ä½¿ç”¨å‰96MBè¿›è¡Œè®­ç»ƒï¼Œå‰©ä½™çš„ç”¨äºéªŒè¯ï¼Œå¹¶åœ¨ä¸€å¤œä¹‹é—´è¿è¡Œäº†å‡ ä¸ªæ¨¡å‹ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥é‡‡æ ·ç”Ÿæˆç»´åŸºç™¾ç§‘æ–‡ç« äº†ï¼ä»¥ä¸‹æ˜¯ä¸€äº›æœ‰è¶£çš„æ‘˜å½•ã€‚é¦–å…ˆï¼Œæ˜¯ä¸€äº›åŸºæœ¬çš„Markdownè¾“å‡ºï¼š1234567891011121314151617Naturalism and decision for the majority of Arab countries&#x27; capitalide was groundedby the Irish language by [[John Clair]], [[An Imperial Japanese Revolt]], associated with Guangzham&#x27;s sovereignty. His generals were the powerful ruler of the Portugal in the [[Protestant Immineners]], which could be said to be directly in Cantonese Communication, which followed a ceremony and set inspired prison, training. The emperor travelled back to [[Antioch, Perth, October 25|21]] to note, the Kingdom of Costa Rica, unsuccessful fashioned the [[Thrales]], [[Cynth&#x27;s Dajoard]], known in western [[Scotland]], near Italy to the conquest of India with the conflict. Copyright was the succession of independence in the slop of Syrian influence that was a famous German movement based on a more popular servicious, non-doctrinal and sexual power post. Many governments recognize the military housing of the [[Civil Liberalization and Infantry Resolution 265 National Party in Hungary]], that is sympathetic to be to the [[Punjab Resolution]](PJS)[http://www.humah.yahoo.com/guardian.cfm/7754800786d17551963s89.htm Official economics Adjoint for the Nazism, Montgomery was swear to advance to the resources for those Socialism&#x27;s rule, was starting to signing a major tripad of aid exile.]] In case you were wondering, the yahoo url above doesnâ€™t actually exist, the model just hallucinated it. Also, note that the model learns to open and close the parenthesis correctly. Thereâ€™s also quite a lot of structured markdown that the model learns, for example sometimes it creates headings, lists, etc.:å¦‚æœä½ åœ¨å¥½å¥‡ï¼Œä¸Šè¿°çš„Yahooç½‘å€å®é™…ä¸Šå¹¶ä¸å­˜åœ¨ï¼Œè¿™æ˜¯æ¨¡å‹è‡†æƒ³å‡ºæ¥çš„ã€‚æ­¤å¤–ï¼Œè¯·æ³¨æ„ï¼Œæ¨¡å‹å­¦ä¼šäº†æ­£ç¡®åœ°æ‰“å¼€å’Œå…³é—­æ‹¬å·ã€‚æ¨¡å‹è¿˜å­¦ä¹ äº†å¤§é‡çš„ç»“æ„åŒ–Markdownï¼Œä¾‹å¦‚ï¼Œæœ‰æ—¶å®ƒä¼šåˆ›å»ºæ ‡é¢˜ã€åˆ—è¡¨ç­‰å†…å®¹ï¼š1234567891011121314151617181920&#123; &#123; cite journal | id=Cerling Nonforest Department|format=Newlymeslated|none &#125; &#125;&#x27;&#x27;www.e-complete&#x27;&#x27;.&#x27;&#x27;&#x27;See also&#x27;&#x27;&#x27;: [[List of ethical consent processing]]== See also ==*[[Iender dome of the ED]]*[[Anti-autism]]===[[Religion|Religion]]===*[[French Writings]]*[[Maria]]*[[Revelation]]*[[Mount Agamul]]== External links==* [http://www.biblegateway.nih.gov/entrepre/ Website of the World Festival. The labour of India-county defeats at the Ripper of California Road.]==External links==* [http://www.romanology.com/ Constitution of the Netherlands and Hispanic Competition for Bilabial and Commonwealth Industry (Republican Constitution of the Extent of the Netherlands)]Sometimes the model snaps into a mode of generating random but valid XML:æœ‰æ—¶ï¼Œæ¨¡å‹ä¼šè¿›å…¥ç”Ÿæˆéšæœºä½†æœ‰æ•ˆçš„ XML çš„æ¨¡å¼ï¼š123456789101112131415&lt;page&gt; &lt;title&gt;Antichrist&lt;/title&gt; &lt;id&gt;865&lt;/id&gt; &lt;revision&gt; &lt;id&gt;15900676&lt;/id&gt; &lt;timestamp&gt;2002-08-03T18:14:12Z&lt;/timestamp&gt; &lt;contributor&gt; &lt;username&gt;Paris&lt;/username&gt; &lt;id&gt;23&lt;/id&gt; &lt;/contributor&gt; &lt;minor /&gt; &lt;comment&gt;Automated conversion&lt;/comment&gt; &lt;text xml:space=&quot;preserve&quot;&gt;#REDIRECT [[Christianity]]&lt;/text&gt; &lt;/revision&gt;&lt;/page&gt; The model completely makes up the timestamp, id, and so on. Also, note that it closes the correct tags appropriately and in the correct nested order. Here are 100,000 characters of sampled wikipedia if youâ€™re interested to see more.è¯¥æ¨¡å‹å®Œå…¨ç”±æ—¶é—´æˆ³ã€id ç­‰ç»„æˆã€‚å¦å¤–ï¼Œè¯·æ³¨æ„ï¼Œå®ƒæ­£ç¡®åœ°å…³é—­äº†æ ‡ç­¾ï¼Œå¹¶ä¸”æŒ‰ç…§æ­£ç¡®çš„åµŒå¥—é¡ºåºã€‚è¿™é‡Œæœ‰ 100,000 ä¸ªå­—ç¬¦çš„æ ·æœ¬ç»´åŸºç™¾ç§‘ï¼Œå¦‚æœæ‚¨æœ‰å…´è¶£æŸ¥çœ‹æ›´å¤šã€‚ Algebraic Geometry (Latex) ä»£æ•°å‡ ä½•ï¼ˆLatexï¼‰The results above suggest that the model is actually quite good at learning complex syntactic structures. Impressed by these results, my labmate (Justin Johnson) and I decided to push even further into structured territories and got a hold of this book on algebraic stacks/geometry. We downloaded the raw Latex source file (a 16MB file) and trained a multilayer LSTM. Amazingly, the resulting sampled Latex _almost_ compiles. We had to step in and fix a few issues manually but then you get plausible looking math, itâ€™s quite astonishing:ä¸Šè¿°ç»“æœè¡¨æ˜ï¼Œæ¨¡å‹åœ¨å­¦ä¹ å¤æ‚å¥æ³•ç»“æ„æ–¹é¢å®é™…ä¸Šç›¸å½“ä¸é”™ã€‚è¿™äº›ç»“æœç»™æˆ‘ç•™ä¸‹äº†æ·±åˆ»çš„å°è±¡ï¼Œæˆ‘çš„å®éªŒå®¤åŒäº‹Justin Johnsonå’Œæˆ‘å†³å®šè¿›ä¸€æ­¥æ¢ç´¢ç»“æ„åŒ–é¢†åŸŸï¼Œå¹¶æ‰¾åˆ°äº†ä¸€æœ¬å…³äºä»£æ•°å /å‡ ä½•çš„ä¹¦ã€‚æˆ‘ä»¬ä¸‹è½½äº†åŸå§‹çš„Latexæºæ–‡ä»¶ï¼ˆä¸€ä¸ª16MBçš„æ–‡ä»¶ï¼‰å¹¶è®­ç»ƒäº†ä¸€ä¸ªå¤šå±‚LSTMã€‚ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œç”Ÿæˆçš„Latexå‡ ä¹å¯ä»¥ç¼–è¯‘ã€‚æˆ‘ä»¬ä¸å¾—ä¸æ‰‹åŠ¨ä¿®å¤ä¸€äº›é—®é¢˜ï¼Œä½†æœ€ç»ˆå¾—åˆ°äº†çœ‹èµ·æ¥å¾ˆåˆç†çš„æ•°å­¦è¡¨è¾¾ï¼Œè¿™çœŸæ˜¯ä»¤äººæƒŠå¹ï¼šSampled (fake) algebraic geometry. Hereâ€™s the actual pdf.é‡‡æ ·ï¼ˆå‡ï¼‰ä»£æ•°å‡ ä½•ã€‚è¿™æ˜¯å®é™…çš„pdfã€‚ Hereâ€™s another sample: ä¸‹é¢æ˜¯å¦ä¸€ä¸ªç¤ºä¾‹ï¼šMore hallucinated algebraic geometry. Nice try on the diagram (right).æ›´å¤šå¹»è§‰çš„ä»£æ•°å‡ ä½•ã€‚ä¸é”™çš„å°è¯•å›¾ï¼ˆå³ï¼‰ã€‚ As you can see above, sometimes the model tries to generate latex diagrams, but clearly it hasnâ€™t really figured them out. I also like the part where it chooses to skip a proof (_â€œProof omitted.â€_, top left). Of course, keep in mind that latex has a relatively difficult structured syntactic format that I havenâ€™t even fully mastered myself. For instance, here is a raw sample from the model (unedited):æ­£å¦‚ä½ åœ¨ä¸Šé¢çœ‹åˆ°çš„ï¼Œæœ‰æ—¶æ¨¡å‹å°è¯•ç”ŸæˆLatexå›¾è¡¨ï¼Œä½†æ˜¾ç„¶å®ƒè¿˜æ²¡æœ‰çœŸæ­£æŒæ¡è¿™ç§æŠ€èƒ½ã€‚æˆ‘ä¹Ÿå–œæ¬¢å®ƒé€‰æ‹©è·³è¿‡è¯æ˜çš„éƒ¨åˆ†ï¼ˆâ€œProof omitted.â€ï¼Œå·¦ä¸Šè§’ï¼‰ã€‚å½“ç„¶ï¼Œè¯·è®°ä½ï¼ŒLatexæœ‰ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„ç»“æ„åŒ–å¥æ³•æ ¼å¼ï¼Œæˆ‘è‡ªå·±éƒ½è¿˜æ²¡æœ‰å®Œå…¨æŒæ¡ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯æ¨¡å‹ç”Ÿæˆçš„ä¸€ä¸ªåŸå§‹æ ·æœ¬ï¼ˆæœªç¼–è¾‘ï¼‰ï¼š123456789101112131415\\begin&#123;proof&#125;We may assume that $\\mathcal&#123;I&#125;$ is an abelian sheaf on $\\mathcal&#123;C&#125;$.\\item Given a morphism $\\Delta : \\mathcal&#123;F&#125; \\to \\mathcal&#123;I&#125;$is an injective and let $\\mathfrak q$ be an abelian sheaf on $X$.Let $\\mathcal&#123;F&#125;$ be a fibered complex. Let $\\mathcal&#123;F&#125;$ be a category.\\begin&#123;enumerate&#125;\\item \\hyperref[setain-construction-phantom]&#123;Lemma&#125;\\label&#123;lemma-characterize-quasi-finite&#125;Let $\\mathcal&#123;F&#125;$ be an abelian quasi-coherent sheaf on $\\mathcal&#123;C&#125;$.Let $\\mathcal&#123;F&#125;$ be a coherent $\\mathcal&#123;O&#125;_X$-module. Then$\\mathcal&#123;F&#125;$ is an abelian catenary over $\\mathcal&#123;C&#125;$.\\item The following are equivalent\\begin&#123;enumerate&#125;\\item $\\mathcal&#123;F&#125;$ is an $\\mathcal&#123;O&#125;_X$-module.\\end&#123;lemma&#125; This sample from a relatively decent model illustrates a few common mistakes. For example, the model opens a \\begin&#123;proof&#125; environment but then ends it with a \\end&#123;lemma&#125;. This is an example of a problem weâ€™d have to fix manually, and is likely due to the fact that the dependency is too long-term: By the time the model is done with the proof it has forgotten whether it was doing a proof or a lemma. Similarly, it opens an \\begin&#123;enumerate&#125; but then forgets to close it. We observed that these became less common with larger/better models, but nonetheless, these are the kinds of mistakes that come up.è¿™ä¸ªæ¥è‡ªç›¸å¯¹ä¸é”™æ¨¡å‹çš„æ ·æœ¬å±•ç¤ºäº†ä¸€äº›å¸¸è§çš„é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œæ¨¡å‹æ‰“å¼€äº†ä¸€ä¸ª \\begin{proof} ç¯å¢ƒï¼Œä½†éšåå´ä»¥ \\end{lemma} ç»“æŸã€‚è¿™æ˜¯ä¸€ä¸ªæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨ä¿®å¤çš„é—®é¢˜çš„ä¾‹å­ï¼Œå¯èƒ½æ˜¯ç”±äºä¾èµ–å…³ç³»è¿‡äºé•¿æœŸï¼šåˆ°æ¨¡å‹å®Œæˆè¯æ˜æ—¶ï¼Œå®ƒå·²ç»å¿˜è®°äº†è‡ªå·±æ˜¯åœ¨è¿›è¡Œè¯æ˜è¿˜æ˜¯å¼•ç†ã€‚ç±»ä¼¼åœ°ï¼Œå®ƒæ‰“å¼€äº†ä¸€ä¸ª \\begin{enumerate}ï¼Œä½†éšåå¿˜è®°äº†å…³é—­å®ƒã€‚æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œè¿™äº›é”™è¯¯åœ¨è¾ƒå¤§/æ›´å¥½çš„æ¨¡å‹ä¸­å˜å¾—ä¸é‚£ä¹ˆå¸¸è§ï¼Œä½†è¿™äº›éƒ½æ˜¯å¯èƒ½å‡ºç°çš„é”™è¯¯ç±»å‹ã€‚ Linux Source Code Linux æºä»£ç I wanted to push structured data to its limit, so for the final challenge I decided to use code. In particular, I took all the source and header files found in the Linux repo on Github, concatenated all of them in a single giant file (474MB of C code) (I was originally going to train only on the kernel but that by itself is only ~16MB). Then I trained several as-large-as-fits-on-my-GPU 3-layer LSTMs over a period of a few days. These models have about 10 million parameters, which is still on the lower end for RNN models. The results are superfun:æˆ‘æƒ³å°†ç»“æ„åŒ–æ•°æ®æ¨å‘æé™ï¼Œå› æ­¤åœ¨æœ€åçš„æŒ‘æˆ˜ä¸­æˆ‘å†³å®šä½¿ç”¨ä»£ç ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘æ”¶é›†äº†Githubä¸ŠLinuxä»“åº“ä¸­çš„æ‰€æœ‰æºæ–‡ä»¶å’Œå¤´æ–‡ä»¶ï¼Œå°†å®ƒä»¬åˆå¹¶æˆä¸€ä¸ªå·¨å¤§çš„æ–‡ä»¶ï¼ˆ474MBçš„Cä»£ç ï¼‰ï¼ˆæˆ‘æœ¬æ¥æ‰“ç®—åªè®­ç»ƒå†…æ ¸ä»£ç ï¼Œä½†å®ƒæœ¬èº«åªæœ‰å¤§çº¦16MBï¼‰ã€‚ç„¶åï¼Œæˆ‘åœ¨å‡ å¤©å†…è®­ç»ƒäº†å¤šä¸ªå°½å¯èƒ½é€‚åº”GPUå®¹é‡çš„ä¸‰å±‚LSTMæ¨¡å‹ã€‚è¿™äº›æ¨¡å‹å¤§çº¦æœ‰1000ä¸‡ä¸ªå‚æ•°ï¼Œè¿™åœ¨RNNæ¨¡å‹ä¸­ä»ç„¶ç®—æ˜¯è¾ƒå°‘çš„ã€‚ç»“æœéå¸¸æœ‰è¶£ï¼š1234567891011121314151617181920212223242526272829303132/* * Increment the size file of the new incorrect UI_FILTER group information * of the size generatively. */static int indicate_policy(void)&#123; int error; if (fd == MARN_EPT) &#123; /* * The kernel blank will coeld it to userspace. */ if (ss-&gt;segment &lt; mem_total) unblock_graph_and_set_blocked(); else ret = 1; goto bail; &#125; segaddr = in_SB(in.addr); selector = seg / 16; setup_works = true; for (i = 0; i &lt; blocks; i++) &#123; seq = buf[i++]; bpf = bd-&gt;bd.next + i * search; if (fd) &#123; current = blocked; &#125; &#125; rw-&gt;name = &quot;Getjbbregs&quot;; bprm_self_clearl(&amp;iv-&gt;version); regs-&gt;new = blocks[(BPF_STATS &lt;&lt; info-&gt;historidac)] | PFMR_CLOBATHINC_SECONDS &lt;&lt; 12; return segtable;&#125;The code looks really quite great overall. Of course, I donâ€™t think it compiles but when you scroll through the generate code it feels very much like a giant C code base. Notice that the RNN peppers its code with comments here and there at random. It is also very good at making very few syntactic errors. For example, it uses strings properly, pointer notation, etc. It also opens and closes brackets { correctly and learns to indent its code very well. A common error is that it canâ€™t keep track of variable names: It often uses undefined variables (e.g. rw above), declares variables it never uses (e.g. int error), or returns non-existing variables. Lets see a few more examples. Hereâ€™s another snippet that shows a wider array of operations that the RNN learns: æ€»ä½“æ¥è¯´ï¼Œè¿™äº›ä»£ç çœ‹èµ·æ¥éå¸¸ä¸é”™ã€‚å½“ç„¶ï¼Œæˆ‘ä¸è®¤ä¸ºå®ƒèƒ½ç¼–è¯‘ï¼Œä½†å½“ä½ æ»šåŠ¨æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç æ—¶ï¼Œå®ƒç¡®å®ç»™äººä¸€ç§å·¨å¤§çš„Cä»£ç åº“çš„æ„Ÿè§‰ã€‚æ³¨æ„ï¼ŒRNNä¼šéšæœºåœ¨ä»£ç ä¸­æ’å…¥æ³¨é‡Šï¼Œå¹¶ä¸”åœ¨è¯­æ³•é”™è¯¯æ–¹é¢è¡¨ç°å¾—éå¸¸å‡ºè‰²ã€‚ä¾‹å¦‚ï¼Œå®ƒèƒ½æ­£ç¡®ä½¿ç”¨å­—ç¬¦ä¸²ã€æŒ‡é’ˆç¬¦å·ç­‰ï¼Œè¿˜èƒ½æ­£ç¡®åœ°æ‰“å¼€å’Œå…³é—­å¤§æ‹¬å·{}ï¼Œå¹¶å¾ˆå¥½åœ°å­¦ä¹ ä»£ç ç¼©è¿›ã€‚ä¸€ä¸ªå¸¸è§çš„é”™è¯¯æ˜¯å®ƒæ— æ³•è·Ÿè¸ªå˜é‡åï¼šå®ƒç»å¸¸ä½¿ç”¨æœªå®šä¹‰çš„å˜é‡ï¼ˆä¾‹å¦‚ä¸Šé¢çš„rwï¼‰ï¼Œå£°æ˜ä»æœªä½¿ç”¨çš„å˜é‡ï¼ˆä¾‹å¦‚int errorï¼‰ï¼Œæˆ–è€…è¿”å›ä¸å­˜åœ¨çš„å˜é‡ã€‚è®©æˆ‘ä»¬å†çœ‹ä¸€äº›ä¾‹å­ã€‚ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä»£ç ç‰‡æ®µï¼Œå±•ç¤ºäº†RNNå­¦åˆ°çš„æ›´å¹¿æ³›çš„æ“ä½œï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051/* * If this error is set, we will need anything right after that BSD. */static void action_new_function(struct s_stat_info *wb)&#123; unsigned long flags; int lel_idx_bit = e-&gt;edd, *sys &amp; ~((unsigned long) *FIRST_COMPAT); buf[0] = 0xFFFFFFFF &amp; (bit &lt;&lt; 4); min(inc, slist-&gt;bytes); printk(KERN_WARNING &quot;Memory allocated %02x/%02x, &quot; &quot;original MLL instead &quot;), min(min(multi_run - s-&gt;len, max) * num_data_in), frame_pos, sz + first_seg); div_u64_w(val, inb_p); spin_unlock(&amp;disk-&gt;queue_lock); mutex_unlock(&amp;s-&gt;sock-&gt;mutex); mutex_unlock(&amp;func-&gt;mutex); return disassemble(info-&gt;pending_bh);&#125;static void num_serial_settings(struct tty_struct *tty)&#123; if (tty == tty) disable_single_st_p(dev); pci_disable_spool(port); return 0;&#125;static void do_command(struct seq_file *m, void *v)&#123; int column = 32 &lt;&lt; (cmd[2] &amp; 0x80); if (state) cmd = (int)(int_state ^ (in_8(&amp;ch-&gt;ch_flags) &amp; Cmd) ? 2 : 1); else seq = 1; for (i = 0; i &lt; 16; i++) &#123; if (k &amp; (1 &lt;&lt; 1)) pipe = (in_use &amp; UMXTHREAD_UNCCA) + ((count &amp; 0x00000000fffffff8) &amp; 0x000000f) &lt;&lt; 8; if (count == 0) sub(pid, ppc_md.kexec_handle, 0x20000000); pipe_set_bytes(i, 0); &#125; /* Free our user pages pointer to place camera if all dash */ subsystem_info = &amp;of_changes[PAGE_SIZE]; rek_controls(offset, idx, &amp;soffset); /* Now we want to deliberately put it to device */ control_check_polarity(&amp;context, val, 0); for (i = 0; i &lt; COUNTER; i++) seq_puts(s, &quot;policy &quot;);&#125; Notice that in the second function the model compares tty == tty, which is vacuously true. On the other hand, at least the variable tty exists in the scope this time! In the last function, notice that the code does not return anything, which happens to be correct since the function signature is void. However, the first two functions were also declared void and did return values. This is again a form of a common mistake due to long-term interactions.æ³¨æ„åœ¨ç¬¬äºŒä¸ªå‡½æ•°ä¸­ï¼Œæ¨¡å‹æ¯”è¾ƒäº†tty == ttyï¼Œè¿™æ˜¯æ˜¾ç„¶ä¸ºçœŸçš„ã€‚å¦ä¸€æ–¹é¢ï¼Œè‡³å°‘è¿™æ¬¡å˜é‡ttyå­˜åœ¨äºä½œç”¨åŸŸä¸­ï¼åœ¨æœ€åä¸€ä¸ªå‡½æ•°ä¸­ï¼Œæ³¨æ„ä»£ç æ²¡æœ‰è¿”å›ä»»ä½•ä¸œè¥¿ï¼Œè¿™æ­£å¥½æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºå‡½æ•°ç­¾åæ˜¯voidã€‚ç„¶è€Œï¼Œå‰ä¸¤ä¸ªå‡½æ•°ä¹Ÿå£°æ˜ä¸ºvoidï¼Œä½†å´è¿”å›äº†å€¼ã€‚è¿™å†æ¬¡æ˜¯ä¸€ç§ç”±äºé•¿æ—¶é—´äº¤äº’è€Œå¯¼è‡´çš„å¸¸è§é”™è¯¯å½¢å¼ã€‚ Sometimes the model decides that itâ€™s time to sample a new file. This is usually a very amusing part: The model first recites the GNU license character by character, samples a few includes, generates some macros and then dives into the code:æœ‰æ—¶ï¼Œæ¨¡å‹ä¼šå†³å®šæ˜¯æ—¶å€™é‡‡æ ·ä¸€ä¸ªæ–°æ–‡ä»¶äº†ã€‚è¿™é€šå¸¸æ˜¯éå¸¸æœ‰è¶£çš„éƒ¨åˆ†ï¼šæ¨¡å‹é¦–å…ˆé€å­—ç¬¦åœ°èƒŒè¯µGNUè®¸å¯è¯ï¼Œé‡‡æ ·å‡ ä¸ªincludeè¯­å¥ï¼Œç”Ÿæˆä¸€äº›å®ï¼Œç„¶åæ·±å…¥åˆ°ä»£ç ä¸­ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/* * Copyright (c) 2006-2010, Intel Mobile Communications. All rights reserved. * * This program is free software; you can redistribute it and/or modify it * under the terms of the GNU General Public License version 2 as published by * the Free Software Foundation. * * This program is distributed in the hope that it will be useful, * but WITHOUT ANY WARRANTY; without even the implied warranty of * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the * * GNU General Public License for more details. * * You should have received a copy of the GNU General Public License * along with this program; if not, write to the Free Software Foundation, * Inc., 675 Mass Ave, Cambridge, MA 02139, USA. */#include &lt;linux/kexec.h&gt;#include &lt;linux/errno.h&gt;#include &lt;linux/io.h&gt;#include &lt;linux/platform_device.h&gt;#include &lt;linux/multi.h&gt;#include &lt;linux/ckevent.h&gt;#include &lt;asm/io.h&gt;#include &lt;asm/prom.h&gt;#include &lt;asm/e820.h&gt;#include &lt;asm/system_info.h&gt;#include &lt;asm/setew.h&gt;#include &lt;asm/pgproto.h&gt;#define REG_PG vesa_slot_addr_pack#define PFM_NOCOMP AFSR(0, load)#define STACK_DDR(type) (func)#define SWAP_ALLOCATE(nr) (e)#define emulate_sigs() arch_get_unaligned_child()#define access_rw(TST) asm volatile(&quot;movd %%esp, %0, %3&quot; : : &quot;r&quot; (0)); \\ if (__type &amp; DO_READ)static void stat_PC_SEC __read_mostly offsetof(struct seq_argsqueue, \\ pC&gt;[1]);static voidos_prefix(unsigned long sys)&#123;#ifdef CONFIG_PREEMPT PUT_PARAM_RAID(2, sel) = get_state_state(); set_pid_sum((unsigned long)state, current_state_str(), (unsigned long)-1-&gt;lr_full; low;&#125;There are too many fun parts to cover- I could probably write an entire blog post on just this part. Iâ€™ll cut it short for now, but here is 1MB of sampled Linux code for your viewing pleasure.æœ‰å¤ªå¤šæœ‰è¶£çš„éƒ¨åˆ†è¦æ¶µç›– - æˆ‘å¯èƒ½ä¼šå†™ä¸€æ•´ç¯‡å…³äºè¿™éƒ¨åˆ†çš„åšå®¢æ–‡ç« ã€‚æˆ‘ç°åœ¨ä¼šç¼©çŸ­å®ƒï¼Œä½†è¿™é‡Œæœ‰ 1MB çš„ Linux ä»£ç æ ·æœ¬ä¾›æ‚¨æŸ¥çœ‹ã€‚ Generating Baby Names ç”Ÿæˆå©´å„¿åå­—Lets try one more for fun. Lets feed the RNN a large text file that contains 8000 baby names listed out, one per line (names obtained from here). We can feed this to the RNN and then generate new names! Here are some example names, only showing the ones that do not occur in the training data (90% donâ€™t):å†æ¥è¯•ä¸€ä¸ªæœ‰è¶£çš„å®éªŒã€‚æˆ‘ä»¬å‘RNNè¾“å…¥ä¸€ä¸ªåŒ…å«8000ä¸ªå©´å„¿åå­—çš„å¤§æ–‡æœ¬æ–‡ä»¶ï¼Œæ¯è¡Œä¸€ä¸ªåå­—ï¼ˆåå­—ä»è¿™é‡Œè·å¾—ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥å°†å…¶è¾“å…¥RNNï¼Œç„¶åç”Ÿæˆæ–°çš„åå­—ï¼ä»¥ä¸‹æ˜¯ä¸€äº›ç¤ºä¾‹åå­—ï¼Œåªå±•ç¤ºé‚£äº›æ²¡æœ‰å‡ºç°åœ¨è®­ç»ƒæ•°æ®ä¸­çš„åå­—ï¼ˆ90%éƒ½ä¸åœ¨è®­ç»ƒæ•°æ®ä¸­ï¼‰ï¼š_Rudi Levette Berice Lussa Hany Mareanne Chrestina Carissy Marylen Hammine Janye Marlise Jacacrie Hendred Romand Charienna Nenotto Ette Dorane Wallen Marly Darine Salina Elvyn Ersia Maralena Minoria Ellia Charmin Antley Nerille Chelon Walmor Evena Jeryly Stachon Charisa Allisa Anatha Cathanie Geetra Alexie Jerin Cassen Herbett Cossie Velen Daurenge Robester Shermond Terisa Licia Roselen Ferine Jayn Lusine Charyanne Sales Sanny Resa Wallon Martine Merus Jelen Candica Wallin Tel Rachene Tarine Ozila Ketia Shanne Arnande Karella Roselina Alessia Chasty Deland Berther Geamar Jackein Mellisand Sagdy Nenc Lessie Rasemy Guen Gavi Milea Anneda Margoris Janin Rodelin Zeanna Elyne Janah Ferzina Susta Pey Castina_ You can see many more here. Some of my favorites include â€œBabyâ€ (haha), â€œKillieâ€, â€œCharâ€, â€œRâ€, â€œMoreâ€, â€œMarsâ€, â€œHiâ€, â€œSaddieâ€, â€œWithâ€ and â€œAhbortâ€. Well that was fun. Of course, you can imagine this being quite useful inspiration when writing a novel, or naming a new startup :)ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°æ›´å¤šã€‚æˆ‘æœ€å–œæ¬¢çš„ä¸€äº›åŒ…æ‹¬â€œå®è´â€ï¼ˆhahaï¼‰ã€â€œKillieâ€ã€â€œCharâ€ã€â€œRâ€ã€â€œMoreâ€ã€â€œMarsâ€ã€â€œHiâ€ã€â€œSaddieâ€ã€â€œWithâ€å’Œâ€œAhbortâ€ã€‚å—¯ï¼Œè¿™å¾ˆæœ‰è¶£ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥æƒ³è±¡è¿™åœ¨å†™å°è¯´æˆ–å‘½åæ–°çš„åˆ›ä¸šå…¬å¸æ—¶æ˜¯éå¸¸æœ‰ç”¨çš„çµæ„Ÿ:) Understanding whatâ€™s going onWe saw that the results at the end of training can be impressive, but how does any of this work? Lets run two quick experiments to briefly peek under the hood.æˆ‘ä»¬çœ‹åˆ°è®­ç»ƒç»“æŸæ—¶çš„ç»“æœä»¤äººå°è±¡æ·±åˆ»ï¼Œä½†è¿™äº›æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿè®©æˆ‘ä»¬è¿›è¡Œä¸¤ä¸ªå¿«é€Ÿå®éªŒï¼Œç®€è¦æ¢ç©¶ä¸€ä¸‹å…¶å†…éƒ¨å·¥ä½œåŸç†ã€‚ The evolution of samples while trainingè®­ç»ƒæ—¶æ ·æœ¬çš„æ¼”å˜First, itâ€™s fun to look at how the sampled text evolves while the model trains. For example, I trained an LSTM of Leo Tolstoyâ€™s War and Peace and then generated samples every 100 iterations of training. At iteration 100 the model samples random jumbles:é¦–å…ˆï¼Œè§‚å¯Ÿæ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ç”Ÿæˆæ–‡æœ¬çš„æ¼”å˜æ˜¯å¾ˆæœ‰è¶£çš„ã€‚ä¾‹å¦‚ï¼Œæˆ‘è®­ç»ƒäº†ä¸€ä¸ªåŸºäºåˆ—å¤«Â·æ‰˜å°”æ–¯æ³°çš„ã€Šæˆ˜äº‰ä¸å’Œå¹³ã€‹çš„LSTMï¼Œå¹¶åœ¨æ¯100æ¬¡è¿­ä»£è®­ç»ƒåç”Ÿæˆæ ·æœ¬ã€‚åœ¨ç¬¬100æ¬¡è¿­ä»£æ—¶ï¼Œæ¨¡å‹ç”Ÿæˆçš„æ ·æœ¬æ˜¯éšæœºæ··æ‚çš„å­—ç¬¦ï¼š 12tyntd-iafhatawiaoihrdemot lytdws e ,tfti, astai f ogoh eoase rrranbyne &#x27;nhthnee e plia tklrgd t o idoe ns,smtt h ne etie h,hregtrs nigtike,aoaenns lng However, notice that at least it is starting to get an idea about words separated by spaces. Except sometimes it inserts two spaces. It also doesnâ€™t know that comma is amost always followed by a space. At 300 iterations we see that the model starts to get an idea about quotes and periods:ç„¶è€Œï¼Œè¯·æ³¨æ„è‡³å°‘æ¨¡å‹å¼€å§‹æœ‰äº†å…³äºå•è¯ç”±ç©ºæ ¼åˆ†éš”çš„æ¦‚å¿µã€‚å°½ç®¡æœ‰æ—¶å®ƒä¼šæ’å…¥ä¸¤ä¸ªç©ºæ ¼ã€‚å®ƒè¿˜ä¸çŸ¥é“é€—å·åå‡ ä¹æ€»æ˜¯è·Ÿç€ä¸€ä¸ªç©ºæ ¼ã€‚åœ¨è®­ç»ƒ300æ¬¡è¿­ä»£æ—¶ï¼Œæˆ‘ä»¬çœ‹åˆ°æ¨¡å‹å¼€å§‹äº†è§£å¼•å·å’Œå¥å·çš„ç”¨æ³•ï¼š1234&quot;Tmont thithey&quot; fomesscerliundKeushey. Thom heresheulke, anmerenith ol sivh I lalterthend Bleipile shuwy fil on aseterlomecoaniogennc Phe lism thond hon at. MeiDimorotion in ther thize.&quot;The words are now also separated with spaces and the model starts to get the idea about periods at the end of a sentence. At iteration 500:ç°åœ¨ï¼Œå•è¯ä¹‹é—´ä¹Ÿç”¨ç©ºæ ¼åˆ†éš”ï¼Œæ¨¡å‹å¼€å§‹ç†è§£å¥æœ«çš„å¥å·ã€‚åœ¨ç¬¬500æ¬¡è¿­ä»£æ—¶ï¼š12we counter. He stutn co des. His stanted out one ofler that concossions and was to gearang reay Jotrets and with fre colt otf paitt thin wall. Which das stimn the model has now learned to spell the shortest and most common words such as â€œweâ€, â€œHeâ€, â€œHisâ€, â€œWhichâ€, â€œandâ€, etc. At iteration 700 weâ€™re starting to see more and more English-like text emerge:æ¨¡å‹ç°åœ¨å·²ç»å­¦ä¼šäº†æ‹¼å†™æœ€çŸ­å’Œæœ€å¸¸è§çš„å•è¯ï¼Œæ¯”å¦‚â€œweâ€ã€â€œHeâ€ã€â€œHisâ€ã€â€œWhichâ€ã€â€œandâ€ç­‰ã€‚åœ¨ç¬¬700æ¬¡è¿­ä»£æ—¶ï¼Œæˆ‘ä»¬å¼€å§‹çœ‹åˆ°è¶Šæ¥è¶Šå¤šç±»ä¼¼è‹±è¯­çš„æ–‡æœ¬å‡ºç°ï¼š123Aftair fall unsuch that the hall for Prince Velzonski&#x27;s that me ofher hearly, and behs to so arwage fiving were to it beloge, pavu say falling misfort how, and Gogition is so overelical and ofter. At iteration 1200 weâ€™re now seeing use of quotations and question/exclamation marks. Longer words have now been learned as well:åœ¨ç¬¬1200æ¬¡è¿­ä»£æ—¶ï¼Œæˆ‘ä»¬ç°åœ¨çœ‹åˆ°äº†å¼•å·å’Œé—®å·/æ„Ÿå¹å·çš„ä½¿ç”¨ã€‚æ›´é•¿çš„å•è¯ä¹Ÿå·²ç»è¢«å­¦ä¼šäº†ï¼š12&quot;Kite vouch!&quot; he repeated by herdoor. &quot;But I would be done and quarts, feeling, then, son is people....&quot;Until at last we start to get properly spelled words, quotations, names, and so on by about iteration 2000:ç›´åˆ°æœ€åï¼Œåœ¨å¤§çº¦ç¬¬2000æ¬¡è¿­ä»£æ—¶ï¼Œæˆ‘ä»¬å¼€å§‹å¾—åˆ°æ­£ç¡®æ‹¼å†™çš„å•è¯ã€å¼•å·ã€åå­—ç­‰ï¼š123&quot;Why do what that day,&quot; replied Natasha, and wishing to himself the fact theprincess, Princess Mary was easier, fed in had oftened him.Pierre aking his soul came to the packs and drove up his father-in-law women. The picture that emerges is that the model first discovers the general word-space structure and then rapidly starts to learn the words; First starting with the short words and then eventually the longer ones. Topics and themes that span multiple words (and in general longer-term dependencies) start to emerge only much later.å‡ºç°çš„æƒ…å†µæ˜¯ï¼Œæ¨¡å‹é¦–å…ˆå‘ç°äº†æ•´ä½“çš„å•è¯-ç©ºæ ¼ç»“æ„ï¼Œç„¶åè¿…é€Ÿå¼€å§‹å­¦ä¹ å•è¯ï¼›å…ˆæ˜¯çŸ­å•è¯ï¼Œç„¶åé€æ¸å­¦ä¹ é•¿å•è¯ã€‚è·¨è¶Šå¤šä¸ªå•è¯çš„ä¸»é¢˜å’Œä¸»é¢˜ï¼ˆä»¥åŠä¸€èˆ¬çš„é•¿æœŸä¾èµ–å…³ç³»ï¼‰è¦åˆ°å¾ˆä¹…ä»¥åæ‰ä¼šå¼€å§‹å‡ºç°ã€‚ Visualizing the predictions and the â€œneuronâ€ firings in the RNNå¯è§†åŒ– RNN ä¸­çš„é¢„æµ‹å’Œâ€œç¥ç»å…ƒâ€æ”¾ç”µ Another fun visualization is to look at the predicted distributions over characters. In the visualizations below we feed a Wikipedia RNN model character data from the validation set (shown along the blue/green rows) and under every character we visualize (in red) the top 5 guesses that the model assigns for the next character. The guesses are colored by their probability (so dark red = judged as very likely, white = not very likely). For example, notice that there are stretches of characters where the model is extremely confident about the next letter (e.g., the model is very confident about characters during the _http://www._ sequence).å¦ä¸€ä¸ªæœ‰è¶£çš„å¯è§†åŒ–æ˜¯æŸ¥çœ‹æ¨¡å‹å¯¹å­—ç¬¦çš„é¢„æµ‹åˆ†å¸ƒã€‚åœ¨ä¸‹é¢çš„å¯è§†åŒ–ä¸­ï¼Œæˆ‘ä»¬å‘ä¸€ä¸ªè®­ç»ƒå¥½çš„Wikipedia RNNæ¨¡å‹ï¼Œæä¾›éªŒè¯é›†çš„å­—ç¬¦æ•°æ®ï¼ˆæ˜¾ç¤ºåœ¨è“è‰²/ç»¿è‰²è¡Œä¸Šï¼‰ï¼Œå¹¶åœ¨æ¯ä¸ªå­—ç¬¦ä¸‹æ–¹å¯è§†åŒ–ï¼ˆç”¨çº¢è‰²è¡¨ç¤ºï¼‰æ¨¡å‹å¯¹ä¸‹ä¸€ä¸ªå­—ç¬¦çš„å‰5ä¸ªçŒœæµ‹ã€‚çŒœæµ‹æ ¹æ®å…¶æ¦‚ç‡è¿›è¡Œç€è‰²ï¼ˆæ·±çº¢è‰²=è¢«è®¤ä¸ºéå¸¸å¯èƒ½ï¼Œç™½è‰²=ä¸å¤ªå¯èƒ½ï¼‰ã€‚ä¾‹å¦‚ï¼Œè¯·æ³¨æ„åœ¨æŸäº›å­—ç¬¦åºåˆ—ä¸­ï¼Œæ¨¡å‹å¯¹ä¸‹ä¸€ä¸ªå­—ç¬¦æä¸ºè‡ªä¿¡(ä¾‹å¦‚ï¼Œæ¨¡å‹å¯¹ http://www åºåˆ—ä¸­çš„å­—ç¬¦éå¸¸æœ‰ä¿¡å¿ƒï¼‰ The input character sequence (blue/green) is colored based on the _firing_ of a randomly chosen neuron in the hidden representation of the RNN. Think about it as green = very excited and blue = not very excited (for those familiar with details of LSTMs, these are values between [-1,1] in the hidden state vector, which is just the gated and tanhâ€™d LSTM cell state). Intuitively, this is visualizing the firing rate of some neuron in the â€œbrainâ€ of the RNN while it reads the input sequence. Different neurons might be looking for different patterns; Below weâ€™ll look at 4 different ones that I found and thought were interesting or interpretable (many also arenâ€™t):è¾“å…¥å­—ç¬¦åºåˆ—ï¼ˆè“è‰²/ç»¿è‰²ï¼‰æ˜¯æ ¹æ®RNNéšè—è¡¨ç¤ºä¸­éšæœºé€‰æ‹©çš„ä¸€ä¸ªç¥ç»å…ƒçš„æ¿€æ´»æƒ…å†µè¿›è¡Œç€è‰²çš„ã€‚å¯ä»¥ç†è§£ä¸ºç»¿è‰²=éå¸¸æ¿€åŠ¨ï¼Œè“è‰²=ä¸å¤ªæ¿€åŠ¨ï¼ˆå¯¹äºç†Ÿæ‚‰LSTMç»†èŠ‚çš„äººæ¥è¯´ï¼Œè¿™äº›å€¼åœ¨éšè—çŠ¶æ€å‘é‡ä¸­ä»‹äº[-1,1]ä¹‹é—´ï¼Œè¿™æ˜¯ç»è¿‡é—¨æ§å’Œtanhå‡½æ•°å¤„ç†çš„LSTMå•å…ƒçŠ¶æ€ï¼‰ã€‚ç›´è§‚åœ°è¯´ï¼Œè¿™æ˜¯åœ¨å¯è§†åŒ–RNNâ€œè„‘ä¸­â€æŸä¸ªç¥ç»å…ƒåœ¨è¯»å–è¾“å…¥åºåˆ—æ—¶çš„æ¿€æ´»ç‡ã€‚ä¸åŒçš„ç¥ç»å…ƒå¯èƒ½åœ¨å¯»æ‰¾ä¸åŒçš„æ¨¡å¼ï¼›ä¸‹é¢æˆ‘ä»¬å°†æŸ¥çœ‹4ä¸ªæˆ‘å‘ç°æœ‰è¶£æˆ–å¯è§£é‡Šçš„ç¥ç»å…ƒï¼ˆä¹Ÿæœ‰å¾ˆå¤šæ˜¯æ— æ³•è§£é‡Šçš„ï¼‰ï¼š The neuron highlighted in this image seems to get very excited about URLs and turns off outside of the URLs. The LSTM is likely using this neuron to remember if it is inside a URL or not.æ­¤å›¾åƒä¸­çªå‡ºæ˜¾ç¤ºçš„ç¥ç»å…ƒä¼¼ä¹å¯¹ URL éå¸¸å…´å¥‹ï¼Œå¹¶åœ¨ URL ä¹‹å¤–å…³é—­ã€‚LSTM å¯èƒ½ä½¿ç”¨è¿™ä¸ªç¥ç»å…ƒæ¥è®°ä½å®ƒæ˜¯å¦åœ¨ URL å†…ã€‚ The highlighted neuron here gets very excited when the RNN is inside the [[ ]] markdown environment and turns off outside of it. Interestingly, the neuron canâ€™t turn on right after it sees the character â€œ[â€œ, it must wait for the second â€œ[â€œ and then activate. This task of counting whether the model has seen one or two â€œ[â€œ is likely done with a different neuron.å½“ RNN ä½äº [[ ]] markdown ç¯å¢ƒå†…éƒ¨å¹¶åœ¨å…¶å¤–éƒ¨å…³é—­æ—¶ï¼Œæ­¤å¤„çªå‡ºæ˜¾ç¤ºçš„ç¥ç»å…ƒä¼šéå¸¸å…´å¥‹ã€‚æœ‰è¶£çš„æ˜¯ï¼Œç¥ç»å…ƒåœ¨çœ‹åˆ°å­—ç¬¦â€œ[â€åæ— æ³•ç«‹å³æ‰“å¼€ï¼Œå®ƒå¿…é¡»ç­‰å¾…ç¬¬äºŒä¸ªâ€œ[â€ç„¶åæ¿€æ´»ã€‚è®¡ç®—æ¨¡å‹æ˜¯å¦çœ‹åˆ°ä¸€ä¸ªæˆ–ä¸¤ä¸ªâ€œ[â€çš„ä»»åŠ¡å¯èƒ½æ˜¯ç”¨ä¸åŒçš„ç¥ç»å…ƒå®Œæˆçš„ã€‚ Here we see a neuron that varies seemingly linearly across the [[ ]] environment. In other words its activation is giving the RNN a time-aligned coordinate system across the [[ ]] scope. The RNN can use this information to make different characters more or less likely depending on how early/late it is in the [[ ]] scope (perhaps?).åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªç¥ç»å…ƒï¼Œå®ƒåœ¨[[ ]]ç¯å¢ƒä¸­ä¼¼ä¹å‘ˆçº¿æ€§å˜åŒ–ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒçš„æ¿€æ´»ä¸º RNN æä¾›äº†ä¸€ä¸ªè·¨ [[ ]] èŒƒå›´çš„æ—¶é—´å¯¹é½åæ ‡ç³»ã€‚RNN å¯ä»¥ä½¿ç”¨æ­¤ä¿¡æ¯æˆ–å¤šæˆ–å°‘åœ°ä½¿ä¸åŒçš„å­—ç¬¦æ›´æœ‰å¯èƒ½ï¼Œå…·ä½“å–å†³äºå®ƒåœ¨ [[ ]] èŒƒå›´å†…çš„æ—©/æ™šï¼ˆä¹Ÿè®¸ï¼Ÿ Here is another neuron that has very local behavior: it is relatively silent but sharply turns off right after the first â€œwâ€ in the â€œwwwâ€ sequence. The RNN might be using this neuron to count up how far in the â€œwwwâ€ sequence it is, so that it can know whether it should emit another â€œwâ€, or if it should start the URL.è¿™æ˜¯å¦ä¸€ä¸ªå…·æœ‰éå¸¸å±€éƒ¨è¡Œä¸ºçš„ç¥ç»å…ƒï¼šå®ƒç›¸å¯¹å®‰é™ï¼Œä½†åœ¨â€œwwwâ€åºåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªâ€œwâ€ä¹‹åæ€¥å‰§å…³é—­ã€‚RNN å¯èƒ½æ­£åœ¨ä½¿ç”¨è¿™ä¸ªç¥ç»å…ƒæ¥è®¡ç®—å®ƒåœ¨â€œwwwâ€åºåˆ—ä¸­çš„è·ç¦»ï¼Œä»¥ä¾¿å®ƒå¯ä»¥çŸ¥é“å®ƒæ˜¯å¦åº”è¯¥å‘å‡ºå¦ä¸€ä¸ªâ€œwâ€ï¼Œæˆ–è€…å®ƒæ˜¯å¦åº”è¯¥å¯åŠ¨ URLã€‚ Of course, a lot of these conclusions are slightly hand-wavy as the hidden state of the RNN is a huge, high-dimensional and largely distributed representation. These visualizations were produced with custom HTML/CSS/Javascript, you can see a sketch of whatâ€™s involved here if youâ€™d like to create something similar.å½“ç„¶ï¼Œå¾ˆå¤šè¿™äº›ç»“è®ºéƒ½æœ‰äº›ç¬¼ç»Ÿï¼Œå› ä¸ºRNNçš„éšè—çŠ¶æ€æ˜¯ä¸€ä¸ªå·¨å¤§çš„ã€é«˜ç»´çš„ã€å¹¿æ³›åˆ†å¸ƒçš„è¡¨ç¤ºã€‚è¿™äº›å¯è§†åŒ–æ˜¯ä½¿ç”¨è‡ªå®šä¹‰çš„HTML/CSS/Javascriptç”Ÿæˆçš„ï¼Œå¦‚æœä½ æƒ³åˆ›å»ºç±»ä¼¼çš„ä¸œè¥¿ï¼Œå¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°æ¶‰åŠçš„å†…å®¹ç¤ºä¾‹ã€‚ We can also condense this visualization by excluding the most likely predictions and only visualize the text, colored by activations of a cell. We can see that in addition to a large portion of cells that do not do anything interpretible, about 5% of them turn out to have learned quite interesting and interpretible algorithms:æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æ’é™¤æœ€å¯èƒ½çš„é¢„æµ‹å¹¶ä»…æ ¹æ®å•å…ƒæ¿€æ´»æƒ…å†µå¯¹æ–‡æœ¬è¿›è¡Œç€è‰²æ¥ç®€åŒ–è¿™ç§å¯è§†åŒ–ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†å¤§éƒ¨åˆ†ä¸å¯è§£é‡Šçš„å•å…ƒå¤–ï¼Œå¤§çº¦æœ‰5%çš„å•å…ƒå­¦ä¼šäº†ç›¸å½“æœ‰è¶£ä¸”å¯è§£é‡Šçš„ç®—æ³•ï¼šAgain, what is beautiful about this is that we didnâ€™t have to hardcode at any point that if youâ€™re trying to predict the next character it might, for example, be useful to keep track of whether or not you are currently inside or outside of quote. We just trained the LSTM on raw data and it decided that this is a useful quantitity to keep track of. In other words one of its cells gradually tuned itself during training to become a quote detection cell, since this helps it better perform the final task. This is one of the cleanest and most compelling examples of where the power in Deep Learning models (and more generally end-to-end training) is coming from.å†æ¬¡å¼ºè°ƒï¼Œè¿™å…¶ä¸­çš„ç¾å¦™ä¹‹å¤„åœ¨äºï¼Œæˆ‘ä»¬ä¸éœ€è¦åœ¨ä»»ä½•æ—¶å€™ç¡¬ç¼–ç ï¼Œä¾‹å¦‚åœ¨é¢„æµ‹ä¸‹ä¸€ä¸ªå­—ç¬¦æ—¶éœ€è¦è·Ÿè¸ªå½“å‰æ˜¯å¦åœ¨å¼•å·å†…æˆ–å¼•å·å¤–ã€‚æˆ‘ä»¬åªæ˜¯å¯¹LSTMè¿›è¡ŒåŸå§‹æ•°æ®çš„è®­ç»ƒï¼Œå®ƒè‡ªå·±å†³å®šè·Ÿè¸ªè¿™ä¸ªä¿¡æ¯æ˜¯æœ‰ç”¨çš„ã€‚æ¢å¥è¯è¯´ï¼Œå…¶ä¸­ä¸€ä¸ªå•å…ƒåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­é€æ¸è°ƒæ•´è‡ªå·±ï¼Œå˜æˆäº†ä¸€ä¸ªå¼•å·æ£€æµ‹å•å…ƒï¼Œå› ä¸ºè¿™æœ‰åŠ©äºå®ƒæ›´å¥½åœ°å®Œæˆæœ€ç»ˆä»»åŠ¡ã€‚è¿™æ˜¯æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆæ›´å¹¿æ³›åœ°è¯´ï¼Œç«¯åˆ°ç«¯è®­ç»ƒï¼‰åŠ›é‡çš„æœ€æ¸…æ™°å’Œæœ€æœ‰è¯´æœåŠ›çš„ä¾‹å­ä¹‹ä¸€ã€‚ Source Code æºä»£ç I hope Iâ€™ve convinced you that training character-level language models is a very fun exercise. You can train your own models using the char-rnn code I released on Github (under MIT license). It takes one large text file and trains a character-level model that you can then sample from. Also, it helps if you have a GPU or otherwise training on CPU will be about a factor of 10x slower. In any case, if you end up training on some data and getting fun results let me know! And if you get lost in the Torch/Lua codebase remember that all it is is just a more fancy version of this 100-line gist.æˆ‘å¸Œæœ›æˆ‘å·²ç»è®©ä½ ç›¸ä¿¡ï¼Œè®­ç»ƒå­—ç¬¦çº§è¯­è¨€æ¨¡å‹æ˜¯ä¸€ä¸ªéå¸¸æœ‰è¶£çš„ç»ƒä¹ ã€‚ä½ å¯ä»¥ä½¿ç”¨æˆ‘åœ¨Githubä¸Šå‘å¸ƒçš„char-rnnä»£ç ï¼ˆåŸºäºMITè®¸å¯è¯ï¼‰æ¥è®­ç»ƒä½ è‡ªå·±çš„æ¨¡å‹ã€‚å®ƒéœ€è¦ä¸€ä¸ªå¤§å‹æ–‡æœ¬æ–‡ä»¶ï¼Œå¹¶è®­ç»ƒä¸€ä¸ªå­—ç¬¦çº§æ¨¡å‹ï¼Œä½ å¯ä»¥ä»ä¸­è¿›è¡Œé‡‡æ ·ã€‚æ­¤å¤–ï¼Œå¦‚æœä½ æœ‰GPUï¼Œè¿™ä¼šæ›´æœ‰å¸®åŠ©ï¼Œå¦åˆ™åœ¨CPUä¸Šè®­ç»ƒçš„é€Ÿåº¦å¤§çº¦ä¼šæ…¢10å€ã€‚ä¸ç®¡æ€æ ·ï¼Œå¦‚æœä½ åœ¨ä¸€äº›æ•°æ®ä¸Šè®­ç»ƒå¹¶å¾—åˆ°äº†æœ‰è¶£çš„ç»“æœï¼Œè¯·å‘Šè¯‰æˆ‘ï¼å¦‚æœä½ åœ¨Torch/Luaä»£ç åº“ä¸­è¿·å¤±äº†æ–¹å‘ï¼Œè¯·è®°ä½ï¼Œè¿™åªæ˜¯è¿™ä¸ª100è¡Œä»£ç ç¤ºä¾‹çš„æ›´å¤æ‚ç‰ˆæœ¬ã€‚ _Brief digression._ The code is written in Torch 7, which has recently become my favorite deep learning framework. Iâ€™ve only started working with Torch/LUA over the last few months and it hasnâ€™t been easy (I spent a good amount of time digging through the raw Torch code on Github and asking questions on their _gitter_ to get things done), but once you get a hang of things it offers a lot of flexibility and speed. Iâ€™ve also worked with Caffe and Theano in the past and I believe Torch, while not perfect, gets its levels of abstraction and philosophy right better than others. In my view the desirable features of an effective framework are:ç®€å•æ’æ›²ä¸€ä¸‹ã€‚è¿™æ®µä»£ç æ˜¯ç”¨Torch 7ç¼–å†™çš„ï¼Œå®ƒæœ€è¿‘æˆä¸ºäº†æˆ‘æœ€å–œæ¬¢çš„æ·±åº¦å­¦ä¹ æ¡†æ¶ã€‚æˆ‘åªæ˜¯è¿‡å»å‡ ä¸ªæœˆæ‰å¼€å§‹ä½¿ç”¨Torch/LUAï¼Œè¿‡ç¨‹å¹¶ä¸å®¹æ˜“ï¼ˆæˆ‘èŠ±äº†å¤§é‡æ—¶é—´åœ¨Githubä¸ŠæŒ–æ˜Torchçš„æºä»£ç ï¼Œå¹¶åœ¨ä»–ä»¬çš„gitterä¸Šæé—®ä»¥è§£å†³é—®é¢˜ï¼‰ï¼Œä½†ä¸€æ—¦ä½ æŒæ¡äº†å®ƒï¼Œå®ƒå°±èƒ½æä¾›å¾ˆå¤§çš„çµæ´»æ€§å’Œé€Ÿåº¦ã€‚æˆ‘è¿‡å»ä¹Ÿä½¿ç”¨è¿‡Caffeå’ŒTheanoï¼Œæˆ‘è®¤ä¸ºTorchè™½ç„¶ä¸å®Œç¾ï¼Œä½†å®ƒåœ¨æŠ½è±¡å±‚æ¬¡å’Œç†å¿µä¸Šåšå¾—æ¯”å…¶ä»–æ¡†æ¶æ›´å¥½ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œä¸€ä¸ªæœ‰æ•ˆæ¡†æ¶çš„ç†æƒ³ç‰¹æ€§æ˜¯ï¼š CPU/GPU transparent Tensor library with a lot of functionality (slicing, array/matrix operations, etc. )CPU/GPUé€æ˜çš„å¼ é‡åº“ï¼šå…·æœ‰ä¸°å¯Œçš„åŠŸèƒ½ï¼ˆåˆ‡ç‰‡ã€æ•°ç»„/çŸ©é˜µæ“ä½œç­‰ï¼‰ã€‚ï¼‰ An entirely separate code base in a scripting language (ideally Python) that operates over Tensors and implements all Deep Learning stuff (forward/backward, computation graphs, etc)å®Œå…¨ç‹¬ç«‹çš„è„šæœ¬è¯­è¨€ä»£ç åº“ï¼šç†æƒ³æƒ…å†µä¸‹æ˜¯Pythonï¼Œæ“ä½œå¼ é‡å¹¶å®ç°æ‰€æœ‰æ·±åº¦å­¦ä¹ ç›¸å…³åŠŸèƒ½ï¼ˆå‰å‘/åå‘ä¼ æ’­ã€è®¡ç®—å›¾ç­‰ï¼‰ã€‚ It should be possible to easily share pretrained models (Caffe does this well, others donâ€™t), and cruciallyèƒ½å¤Ÿè½»æ¾å…±äº«é¢„è®­ç»ƒæ¨¡å‹ï¼šCaffeåœ¨è¿™æ–¹é¢åšå¾—å¾ˆå¥½ï¼Œå…¶ä»–æ¡†æ¶åˆ™ä¸å°½å¦‚äººæ„ã€‚ NO compilation step (or at least not as currently done in Theano). The trend in Deep Learning is towards larger, more complex networks that are are time-unrolled in complex graphs. It is critical that these do not compile for a long time or development time greatly suffers. Second, by compiling one gives up interpretability and the ability to log/debug effectively. If there is an _option_ to compile the graph once it has been developed for efficiency in prod thatâ€™s fine.æ²¡æœ‰ç¼–è¯‘æ­¥éª¤ï¼šæˆ–è‡³å°‘ä¸åƒTheanoç›®å‰é‚£æ ·ã€‚æ·±åº¦å­¦ä¹ çš„å‘å±•è¶‹åŠ¿æ˜¯ä½¿ç”¨æ›´å¤§ã€æ›´å¤æ‚çš„ç½‘ç»œï¼Œè¿™äº›ç½‘ç»œåœ¨å¤æ‚çš„è®¡ç®—å›¾ä¸­è¿›è¡Œæ—¶é—´å±•å¼€ã€‚å…³é”®æ˜¯è¿™äº›å›¾ä¸åº”é•¿æ—¶é—´ç¼–è¯‘ï¼Œå¦åˆ™ä¼šä¸¥é‡å½±å“å¼€å‘æ—¶é—´ã€‚å…¶æ¬¡ï¼Œé€šè¿‡ç¼–è¯‘ï¼Œä¼šå¤±å»å¯è§£é‡Šæ€§å’Œæœ‰æ•ˆè®°å½•/è°ƒè¯•çš„èƒ½åŠ›ã€‚å¦‚æœæœ‰é€‰é¡¹å¯ä»¥åœ¨å¼€å‘å®Œæˆåç¼–è¯‘å›¾ä»¥æé«˜ç”Ÿäº§æ•ˆç‡ï¼Œé‚£ä¹Ÿå¾ˆå¥½ã€‚ Further Reading å»¶ä¼¸é˜…è¯»Before the end of the post I also wanted to position RNNs in a wider context and provide a sketch of the current research directions. RNNs have recently generated a significant amount of buzz and excitement in the field of Deep Learning. Similar to Convolutional Networks they have been around for decades but their full potential has only recently started to get widely recognized, in large part due to our growing computational resources. Hereâ€™s a brief sketch of a few recent developments (definitely not complete list, and a lot of this work draws from research back to 1990s, see related work sections):åœ¨æ–‡ç« çš„ç»“å°¾ï¼Œæˆ‘è¿˜æƒ³æŠŠRNNæ”¾åœ¨æ›´å¹¿æ³›çš„èƒŒæ™¯ä¸­ï¼Œå¹¶æä¾›å½“å‰ç ”ç©¶æ–¹å‘çš„æ¦‚è¿°ã€‚æœ€è¿‘ï¼ŒRNNåœ¨æ·±åº¦å­¦ä¹ é¢†åŸŸå¼•èµ·äº†å¤§é‡å…³æ³¨å’Œå…´å¥‹ã€‚ç±»ä¼¼äºå·ç§¯ç½‘ç»œï¼ŒRNNå·²ç»å­˜åœ¨äº†å‡ åå¹´ï¼Œä½†å®ƒä»¬çš„å…¨éƒ¨æ½œåŠ›ç›´åˆ°æœ€è¿‘æ‰å¼€å§‹è¢«å¹¿æ³›è®¤å¯ï¼Œè¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šè¦å½’åŠŸäºæˆ‘ä»¬ä¸æ–­å¢é•¿çš„è®¡ç®—èµ„æºã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æœ€è¿‘å‘å±•çš„ç®€è¦æ¦‚è¿°ï¼ˆç»ä¸æ˜¯å®Œæ•´çš„åˆ—è¡¨ï¼Œå…¶ä¸­å¾ˆå¤šå·¥ä½œå¯ä»¥è¿½æº¯åˆ°1990å¹´ä»£ï¼Œè¯¦è§ç›¸å…³ç ”ç©¶éƒ¨åˆ†ï¼‰ï¼š In the domain of NLP/Speech, RNNs transcribe speech to text, perform machine translation, generate handwritten text, and of course, they have been used as powerful language models (Sutskever et al.) (Graves) (Mikolov et al.) (both on the level of characters and words). Currently it seems that word-level models work better than character-level models, but this is surely a temporary thing.åœ¨NLP/Speeché¢†åŸŸï¼ŒRNNç”¨äºå°†è¯­éŸ³è½¬å½•ä¸ºæ–‡æœ¬ã€æ‰§è¡Œæœºå™¨ç¿»è¯‘ã€ç”Ÿæˆæ‰‹å†™æ–‡æœ¬ï¼Œå½“ç„¶ï¼Œå®ƒä»¬ä¹Ÿè¢«ç”¨ä½œå¼ºå¤§çš„è¯­è¨€æ¨¡å‹ï¼ˆSutskeverç­‰äººï¼‰ï¼ˆGravesï¼‰ï¼ˆMikolovç­‰äººï¼‰ï¼ˆåŒ…æ‹¬å­—ç¬¦çº§å’Œå•è¯çº§ï¼‰ã€‚ç›®å‰çœ‹æ¥ï¼Œå•è¯çº§æ¨¡å‹æ¯”å­—ç¬¦çº§æ¨¡å‹æ•ˆæœæ›´å¥½ï¼Œä½†è¿™è‚¯å®šåªæ˜¯æš‚æ—¶çš„ã€‚ Computer Vision. RNNs are also quickly becoming pervasive in Computer Vision. For example, weâ€™re seeing RNNs in frame-level video classification, image captioning (also including my own work and many others), video captioning and very recently visual question answering. My personal favorite RNNs in Computer Vision paper is Recurrent Models of Visual Attention, both due to its high-level direction (sequential processing of images with glances) and the low-level modeling (REINFORCE learning rule that is a special case of policy gradient methods in Reinforcement Learning, which allows one to train models that perform non-differentiable computation (taking glances around the image in this case)). Iâ€™m confident that this type of hybrid model that consists of a blend of CNN for raw perception coupled with an RNN glance policy on top will become pervasive in perception, especially for more complex tasks that go beyond classifying some objects in plain view.è®¡ç®—æœºè§†è§‰ã€‚RNNä¹Ÿè¿…é€Ÿåœ¨è®¡ç®—æœºè§†è§‰é¢†åŸŸæ™®åŠã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬çœ‹åˆ°RNNç”¨äºå¸§çº§è§†é¢‘åˆ†ç±»ã€å›¾åƒæè¿°ç”Ÿæˆï¼ˆåŒ…æ‹¬æˆ‘è‡ªå·±çš„å·¥ä½œå’Œè®¸å¤šå…¶ä»–äººçš„å·¥ä½œï¼‰ã€è§†é¢‘æè¿°ç”Ÿæˆä»¥åŠæœ€è¿‘çš„è§†è§‰é—®ç­”ã€‚æˆ‘ä¸ªäººæœ€å–œæ¬¢çš„è®¡ç®—æœºè§†è§‰é¢†åŸŸçš„RNNè®ºæ–‡æ˜¯ã€Šè§†è§‰æ³¨æ„åŠ›çš„é€’å½’æ¨¡å‹ã€‹ï¼Œå› ä¸ºå®ƒåœ¨é«˜å±‚æ¬¡æ–¹å‘ï¼ˆé€šè¿‡æ‰«è§†å¯¹å›¾åƒè¿›è¡Œé¡ºåºå¤„ç†ï¼‰å’Œä½å±‚æ¬¡å»ºæ¨¡ï¼ˆREINFORCEå­¦ä¹ è§„åˆ™ï¼Œè¿™æ˜¯å¼ºåŒ–å­¦ä¹ ä¸­ç­–ç•¥æ¢¯åº¦æ–¹æ³•çš„ç‰¹ä¾‹ï¼Œå…è®¸è®­ç»ƒæ‰§è¡Œä¸å¯å¾®è®¡ç®—çš„æ¨¡å‹ï¼ˆåœ¨æœ¬ä¾‹ä¸­æ˜¯ç¯é¡¾å›¾åƒï¼‰ï¼‰ä¸Šéƒ½å¾ˆå‡ºè‰²ã€‚æˆ‘ç›¸ä¿¡è¿™ç§æ··åˆæ¨¡å‹ï¼Œå³ç»“åˆäº†ç”¨äºåŸå§‹æ„ŸçŸ¥çš„CNNå’Œç”¨äºæ‰«è§†ç­–ç•¥çš„RNNçš„æ¨¡å‹ï¼Œå°†åœ¨æ„ŸçŸ¥é¢†åŸŸæ™®åŠï¼Œç‰¹åˆ«æ˜¯åœ¨è¶…è¶Šç®€å•å¯¹è±¡åˆ†ç±»çš„å¤æ‚ä»»åŠ¡ä¸­ã€‚ Inductive Reasoning, Memories and Attention. Another extremely exciting direction of research is oriented towards addressing the limitations of vanilla recurrent networks. One problem is that RNNs are not inductive: They memorize sequences extremely well, but they donâ€™t necessarily always show convincing signs of generalizing in the _correct_ way (Iâ€™ll provide pointers in a bit that make this more concrete). A second issue is they unnecessarily couple their representation size to the amount of computation per step. For instance, if you double the size of the hidden state vector youâ€™d quadruple the amount of FLOPS at each step due to the matrix multiplication. Ideally, weâ€™d like to maintain a huge representation/memory (e.g. containing all of Wikipedia or many intermediate state variables), while maintaining the ability to keep computation per time step fixed.å½’çº³æ¨ç†ã€è®°å¿†å’Œæ³¨æ„åŠ›ã€‚å¦ä¸€ä¸ªæå…¶ä»¤äººå…´å¥‹çš„ç ”ç©¶æ–¹å‘æ˜¯è§£å†³æ™®é€šå¾ªç¯ç½‘ç»œçš„å±€é™æ€§ã€‚ä¸€ä¸ªé—®é¢˜æ˜¯RNNä¸å…·å¤‡å½’çº³èƒ½åŠ›ï¼šå®ƒä»¬éå¸¸æ“…é•¿è®°å¿†åºåˆ—ï¼Œä½†ä¸ä¸€å®šæ€»æ˜¯èƒ½ä»¥æ­£ç¡®çš„æ–¹å¼è¡¨ç°å‡ºä»¤äººä¿¡æœçš„æ³›åŒ–èƒ½åŠ›ï¼ˆç¨åæˆ‘ä¼šæä¾›ä¸€äº›å…·ä½“çš„ä¾‹å­ï¼‰ã€‚ç¬¬äºŒä¸ªé—®é¢˜æ˜¯å®ƒä»¬ä¸å¿…è¦åœ°å°†è¡¨ç¤ºå¤§å°ä¸æ¯æ­¥è®¡ç®—é‡è€¦åˆåœ¨ä¸€èµ·ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ å°†éšè—çŠ¶æ€å‘é‡çš„å¤§å°åŠ å€ï¼Œé‚£ä¹ˆç”±äºçŸ©é˜µä¹˜æ³•ï¼Œæ¯æ­¥çš„æµ®ç‚¹è¿ç®—é‡ï¼ˆFLOPSï¼‰å°†å¢åŠ å››å€ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¿æŒä¸€ä¸ªå·¨å¤§çš„è¡¨ç¤º/è®°å¿†ï¼ˆä¾‹å¦‚åŒ…å«æ•´ä¸ªç»´åŸºç™¾ç§‘æˆ–è®¸å¤šä¸­é—´çŠ¶æ€å˜é‡ï¼‰ï¼ŒåŒæ—¶ä¿æŒæ¯ä¸ªæ—¶é—´æ­¥çš„è®¡ç®—é‡å›ºå®šã€‚ The first convincing example of moving towards these directions was developed in DeepMindâ€™s Neural Turing Machines paper. This paper sketched a path towards models that can perform read/write operations between large, external memory arrays and a smaller set of memory registers (think of these as our working memory) where the computation happens. Crucially, the NTM paper also featured very interesting memory addressing mechanisms that were implemented with a (soft, and fully-differentiable) attention model. The concept of soft attention has turned out to be a powerful modeling feature and was also featured in Neural Machine Translation by Jointly Learning to Align and Translate for Machine Translation and Memory Networks for (toy) Question Answering. In fact, Iâ€™d go as far as to say thatç¬¬ä¸€ä¸ªæœç€è¿™äº›æ–¹å‘å‰è¿›çš„ä»¤äººä¿¡æœçš„ä¾‹å­æ˜¯DeepMindçš„ã€Šç¥ç»å›¾çµæœºã€‹ï¼ˆNeural Turing Machinesï¼‰è®ºæ–‡ã€‚è¿™ç¯‡è®ºæ–‡å‹¾ç”»äº†ä¸€ä¸ªæ¨¡å‹çš„è·¯å¾„ï¼Œè¿™äº›æ¨¡å‹å¯ä»¥åœ¨å¤§å‹å¤–éƒ¨å­˜å‚¨é˜µåˆ—å’Œä¸€å°ç»„è®¡ç®—å‘ç”Ÿçš„å­˜å‚¨å¯„å­˜å™¨ï¼ˆå¯ä»¥å°†è¿™äº›è§†ä¸ºæˆ‘ä»¬çš„å·¥ä½œè®°å¿†ï¼‰ä¹‹é—´æ‰§è¡Œè¯»/å†™æ“ä½œã€‚è‡³å…³é‡è¦çš„æ˜¯ï¼ŒNTMè®ºæ–‡è¿˜å±•ç¤ºäº†éå¸¸æœ‰è¶£çš„è®°å¿†å¯»å€æœºåˆ¶ï¼Œè¿™äº›æœºåˆ¶é€šè¿‡ä¸€ä¸ªï¼ˆè½¯ä¸”å®Œå…¨å¯å¾®åˆ†çš„ï¼‰æ³¨æ„åŠ›æ¨¡å‹å®ç°ã€‚è½¯æ³¨æ„åŠ›çš„æ¦‚å¿µè¢«è¯æ˜æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å»ºæ¨¡ç‰¹æ€§ï¼Œå®ƒä¹Ÿå‡ºç°åœ¨ã€Šé€šè¿‡è”åˆå­¦ä¹ å¯¹é½å’Œç¿»è¯‘çš„ç¥ç»æœºå™¨ç¿»è¯‘ã€‹å’Œã€Šè®°å¿†ç½‘ç»œç”¨äºï¼ˆç©å…·ï¼‰é—®ç­”ã€‹ä¸­ã€‚å®é™…ä¸Šï¼Œæˆ‘ç”šè‡³å¯ä»¥è¯´ The concept of attention is the most interesting recent architectural innovation in neural networks.æ³¨æ„åŠ›çš„æ¦‚å¿µæ˜¯ç¥ç»ç½‘ç»œä¸­æœ€è¿‘æœ€æœ‰è¶£çš„æ¶æ„åˆ›æ–°ã€‚ Now, I donâ€™t want to dive into too many details but a soft attention scheme for memory addressing is convenient because it keeps the model fully-differentiable, but unfortunately one sacrifices efficiency because everything that can be attended to is attended to (but softly). Think of this as declaring a pointer in C that doesnâ€™t point to a specific address but instead defines an entire distribution over all addresses in the entire memory, and dereferencing the pointer returns a weighted sum of the pointed content (that would be an expensive operation!). This has motivated multiple authors to swap soft attention models for hard attention where one samples a particular chunk of memory to attend to (e.g. a read/write action for some memory cell instead of reading/writing from all cells to some degree). This model is significantly more philosophically appealing, scalable and efficient, but unfortunately it is also non-differentiable. This then calls for use of techniques from the Reinforcement Learning literature (e.g. REINFORCE) where people are perfectly used to the concept of non-differentiable interactions. This is very much ongoing work but these hard attention models have been explored, for example, in Inferring Algorithmic Patterns with Stack-Augmented Recurrent Nets, Reinforcement Learning Neural Turing Machines, and Show Attend and Tell.ç°åœ¨ï¼Œæˆ‘ä¸æƒ³æ·±å…¥ç ”ç©¶å¤ªå¤šç»†èŠ‚ï¼Œä½†ç”¨äºå†…å­˜å¯»å€çš„è½¯æ³¨æ„åŠ›æ–¹æ¡ˆå¾ˆæ–¹ä¾¿ï¼Œå› ä¸ºå®ƒä½¿æ¨¡å‹ä¿æŒå®Œå…¨å¯å¾®åˆ†ï¼Œä½†ä¸å¹¸çš„æ˜¯ï¼Œäººä»¬ç‰ºç‰²äº†æ•ˆç‡ï¼Œå› ä¸ºæ‰€æœ‰å¯ä»¥å¤„ç†çš„ä¸œè¥¿éƒ½è¢«å¤„ç†äº†ï¼ˆä½†å¾ˆè½¯ï¼‰ã€‚å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆåœ¨ C è¯­è¨€ä¸­å£°æ˜ä¸€ä¸ªæŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆä¸æŒ‡å‘ç‰¹å®šåœ°å€ï¼Œè€Œæ˜¯åœ¨æ•´ä¸ªå†…å­˜ä¸­çš„æ‰€æœ‰åœ°å€ä¸Šå®šä¹‰æ•´ä¸ªåˆ†å¸ƒï¼Œå¹¶ä¸”å–æ¶ˆå¼•ç”¨æŒ‡é’ˆä¼šè¿”å›æŒ‡å‘å†…å®¹çš„åŠ æƒæ€»å’Œï¼ˆè¿™å°†æ˜¯ä¸€ä¸ªæ˜‚è´µçš„æ“ä½œï¼è¿™ä¿ƒä½¿å¤šä½ä½œè€…å°†è½¯æ³¨æ„åŠ›æ¨¡å‹æ¢æˆç¡¬æ³¨æ„åŠ›æ¨¡å‹ï¼Œå…¶ä¸­ä¸€ä¸ªäººå¯¹è¦å…³æ³¨çš„ç‰¹å®šå†…å­˜å—è¿›è¡Œé‡‡æ ·ï¼ˆä¾‹å¦‚ï¼Œå¯¹æŸäº›è®°å¿†å•å…ƒè¿›è¡Œè¯»/å†™æ“ä½œï¼Œè€Œä¸æ˜¯åœ¨æŸç§ç¨‹åº¦ä¸Šä»æ‰€æœ‰å•å…ƒè¯»å–/å†™å…¥ï¼‰ã€‚è¿™ä¸ªæ¨¡å‹åœ¨å“²å­¦ä¸Šæ›´å…·å¸å¼•åŠ›ã€å¯æ‰©å±•æ€§å’Œæ•ˆç‡ï¼Œä½†ä¸å¹¸çš„æ˜¯ï¼Œå®ƒä¹Ÿæ˜¯ä¸å¯å¾®åˆ†çš„ã€‚ç„¶åï¼Œè¿™éœ€è¦ä½¿ç”¨å¼ºåŒ–å­¦ä¹ æ–‡çŒ®ä¸­çš„æŠ€æœ¯ï¼ˆä¾‹å¦‚REINFORCEï¼‰ï¼Œåœ¨è¿™äº›æŠ€æœ¯ä¸­ï¼Œäººä»¬å®Œå…¨ä¹ æƒ¯äº†ä¸å¯å¾®åˆ†äº¤äº’çš„æ¦‚å¿µã€‚è¿™æ˜¯ä¸€é¡¹æ­£åœ¨è¿›è¡Œçš„å·¥ä½œï¼Œä½†è¿™äº›ç¡¬æ³¨æ„åŠ›æ¨¡å‹å·²ç»è¢«æ¢ç´¢è¿‡ï¼Œä¾‹å¦‚ï¼Œåœ¨ä½¿ç”¨å †æ ˆå¢å¼ºçš„å¾ªç¯ç½‘ç»œæ¨æ–­ç®—æ³•æ¨¡å¼ã€å¼ºåŒ–å­¦ä¹ ç¥ç»å›¾çµæœºå’Œæ˜¾ç¤ºã€å‡ºå¸­å’Œè®²è¿°ä¸­ã€‚ People. If youâ€™d like to read up on RNNs I recommend theses from Alex Graves, Ilya Sutskever and Tomas Mikolov. For more about REINFORCE and more generally Reinforcement Learning and policy gradient methods (which REINFORCE is a special case of) David Silverâ€™s class, or one of Pieter Abbeelâ€™s classes.äººã€‚å¦‚æœä½ æƒ³æ·±å…¥äº†è§£RNNï¼Œæˆ‘æ¨èé˜…è¯»Alex Gravesã€Ilya Sutskeverå’ŒTomas Mikolovçš„è®ºæ–‡ã€‚å…³äºREINFORCEå’Œæ›´å¹¿æ³›çš„å¼ºåŒ–å­¦ä¹ åŠç­–ç•¥æ¢¯åº¦æ–¹æ³•ï¼ˆREINFORCEæ˜¯å…¶ç‰¹ä¾‹ï¼‰ï¼Œå¯ä»¥å‚è€ƒDavid Silverçš„è¯¾ç¨‹ï¼Œæˆ–Pieter Abbeelçš„è¯¾ç¨‹ä¹‹ä¸€ã€‚ Code. If youâ€™d like to play with training RNNs I hear good things about keras or passage for Theano, the code released with this post for Torch, or this gist for raw numpy code I wrote a while ago that implements an efficient, batched LSTM forward and backward pass. You can also have a look at my numpy-based NeuralTalk which uses an RNN/LSTM to caption images, or maybe this Caffe implementation by Jeff Donahue.ä»£ç ã€‚å¦‚æœä½ æƒ³å°è¯•è®­ç»ƒRNNï¼Œæˆ‘å¬è¯´kerasæˆ–passage for Theanoçš„è¯„ä»·å¾ˆå¥½ï¼Œå¯ä»¥å‚è€ƒæœ¬æ–‡å‘å¸ƒçš„ç”¨äºTorchçš„ä»£ç ï¼Œæˆ–è€…æˆ‘ä¹‹å‰ç¼–å†™çš„è¿™ä¸ªå®ç°äº†é«˜æ•ˆæ‰¹é‡LSTMå‰å‘å’Œåå‘ä¼ é€’çš„çº¯numpyä»£ç ã€‚ä½ ä¹Ÿå¯ä»¥çœ‹çœ‹æˆ‘åŸºäºnumpyçš„NeuralTalkï¼Œå®ƒä½¿ç”¨RNN/LSTMç”Ÿæˆå›¾åƒæè¿°ï¼Œæˆ–è€…çœ‹çœ‹Jeff Donahueçš„è¿™ä¸ªCaffeå®ç°ã€‚ Conclusion ç»“è®ºWeâ€™ve learned about RNNs, how they work, why they have become a big deal, weâ€™ve trained an RNN character-level language model on several fun datasets, and weâ€™ve seen where RNNs are going. You can confidently expect a large amount of innovation in the space of RNNs, and I believe they will become a pervasive and critical component to intelligent systems.æˆ‘ä»¬å·²ç»äº†è§£äº†RNNï¼Œå®ƒä»¬æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä¸ºä»€ä¹ˆå®ƒä»¬å˜å¾—å¦‚æ­¤é‡è¦ã€‚æˆ‘ä»¬åœ¨å‡ ä¸ªæœ‰è¶£çš„æ•°æ®é›†ä¸Šè®­ç»ƒäº†ä¸€ä¸ªRNNå­—ç¬¦çº§è¯­è¨€æ¨¡å‹ï¼Œå¹¶ä¸”çœ‹åˆ°äº†RNNçš„å‘å±•æ–¹å‘ã€‚ä½ å¯ä»¥è‡ªä¿¡åœ°æœŸå¾…åœ¨RNNé¢†åŸŸå‡ºç°å¤§é‡çš„åˆ›æ–°ï¼Œæˆ‘ç›¸ä¿¡å®ƒä»¬å°†æˆä¸ºæ™ºèƒ½ç³»ç»Ÿä¸­æ™®éä¸”å…³é”®çš„ç»„æˆéƒ¨åˆ†ã€‚ Lastly, to add some meta to this post, I trained an RNN on the source file of this blog post. Unfortunately, at about 46K characters I havenâ€™t written enough data to properly feed the RNN, but the returned sample (generated with low temperature to get a more typical sample) is:æœ€åï¼Œä¸ºäº†ç»™è¿™ç¯‡æ–‡ç« å¢åŠ ä¸€äº›å…ƒå†…å®¹ï¼Œæˆ‘ç”¨è¿™ç¯‡åšå®¢æ–‡ç« çš„æºæ–‡ä»¶è®­ç»ƒäº†ä¸€ä¸ªRNNã€‚ä¸å¹¸çš„æ˜¯ï¼Œå¤§çº¦46Kå­—ç¬¦çš„æ•°æ®é‡è¿˜ä¸è¶³ä»¥å……åˆ†è®­ç»ƒRNNï¼Œä½†ç”Ÿæˆçš„æ ·æœ¬ï¼ˆåœ¨ä½æ¸©ä¸‹ç”Ÿæˆï¼Œä»¥è·å¾—æ›´å…¸å‹çš„æ ·æœ¬ï¼‰å¦‚ä¸‹ï¼š 12I&#x27;ve the RNN with and works, but the computed with program of the RNN with and the computed of the RNN with with and the code Yes, the post was about RNN and how well it works, so clearly this works :). See you next time!æ˜¯çš„ï¼Œè¿™ç¯‡æ–‡ç« æ˜¯å…³äº RNN åŠå…¶å·¥ä½œæƒ…å†µçš„ï¼Œæ‰€ä»¥å¾ˆæ˜æ˜¾è¿™:)å·¥ä½œã€‚ä¸‹æ¬¡å†è§ï¼ EDIT (extra links): ç¼–è¾‘ï¼ˆé¢å¤–é“¾æ¥ï¼‰Videos: è§†é¢‘ï¼š I gave a talk on this work at the London Deep Learning meetup (video).æˆ‘åœ¨ä¼¦æ•¦æ·±åº¦å­¦ä¹ èšä¼šä¸Šå°±è¿™é¡¹å·¥ä½œå‘è¡¨äº†æ¼”è®²ï¼ˆè§†é¢‘ï¼‰ã€‚ Discussions: è®¨è®ºï¼š HN discussion HN è®¨è®º Reddit discussion on r/machinelearningReddit å…³äº r/machinelearning çš„è®¨è®º Reddit discussion on r/programmingReddit ä¸Šå…³äº r/programming çš„è®¨è®º Replies: ç­”å¤ï¼š Yoav Goldberg compared these RNN results to n-gram maximum likelihood (counting) baselineYoav Goldberg å°†è¿™äº› RNN ç»“æœä¸ n-gram æœ€å¤§ä¼¼ç„¶ï¼ˆè®¡æ•°ï¼‰åŸºçº¿è¿›è¡Œäº†æ¯”è¾ƒ @nylk trained char-rnn on cooking recipes. They look great!@nylkåŸ¹è®­äº†char-rnnçš„çƒ¹é¥ªé£Ÿè°±ã€‚å®ƒä»¬çœ‹èµ·æ¥å¾ˆæ£’ï¼ @MrChrisJohnson trained char-rnn on Eminem lyrics and then synthesized a rap song with robotic voice reading it out. Hilarious :)@MrChrisJohnsonç”¨ Eminem çš„æ­Œè¯è®­ç»ƒäº† char-rnnï¼Œç„¶ååˆæˆäº†ä¸€é¦–å¸¦æœ‰æœºå™¨äººå£°éŸ³çš„è¯´å”±æ­Œæ›²ã€‚æç¬‘:) @samim trained char-rnn on Obama Speeches. They look fun!@samimåŸ¹è®­äº†å¥¥å·´é©¬æ¼”è®²çš„char-rnnã€‚ä»–ä»¬çœ‹èµ·æ¥å¾ˆæœ‰è¶£ï¼ JoÃ£o Felipe trained char-rnn irish folk music and sampled musicè‹¥æ˜‚Â·è´¹åˆ©ä½©ï¼ˆJoÃ£o Felipeï¼‰è®­ç»ƒäº†char-rnnçˆ±å°”å…°æ°‘é—´éŸ³ä¹å¹¶é‡‡æ ·äº†éŸ³ä¹ Bob Sturm also trained char-rnn on music in ABC notationé²å‹ƒÂ·æ–¯ç‰¹å§†ï¼ˆBob Sturmï¼‰è¿˜å¯¹char-rnnè¿›è¡Œäº†ABCè®°è°±æ³•çš„éŸ³ä¹åŸ¹è®­ RNN Bible bot by MaximilienRNN Bible bot çš„ Maximilien Learning Holiness learning the Bibleå­¦ä¹ åœ£æ´ å­¦ä¹ åœ£ç» Terminal.com snapshot that has char-rnn set up and ready to go in a browser-based virtual machine (thanks @samim)Terminal.com å·²è®¾ç½® char-rnn å¹¶å‡†å¤‡åœ¨åŸºäºæµè§ˆå™¨çš„è™šæ‹Ÿæœºä¸­ä½¿ç”¨çš„å¿«ç…§ï¼ˆæ„Ÿè°¢ @samimï¼‰ æ³¨é‡Š1.Vanilla ç¥ç»ç½‘ç»œâ€œVanilla ç¥ç»ç½‘ç»œâ€é€šå¸¸æŒ‡çš„æ˜¯æœ€åŸºæœ¬ã€æœ€ç®€å•çš„ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œæ²¡æœ‰ä½¿ç”¨ä»»ä½•ç‰¹æ®Šçš„å±‚æˆ–å¤æ‚çš„æ¶æ„ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¸€èˆ¬æŒ‡çš„æ˜¯ç®€å•çš„å‰é¦ˆç¥ç»ç½‘ç»œï¼ˆFeedforward Neural Network, FNNï¼‰ 2. å‘é‡ï¼ˆVectorï¼‰vs åºåˆ—ï¼ˆSequenceï¼‰å‘é‡ï¼ˆVectorï¼‰ï¼š å®šä¹‰ï¼šåœ¨æ•°å­¦å’Œè®¡ç®—æœºç§‘å­¦ä¸­ï¼Œå‘é‡æ˜¯ä¸€ç»„æœ‰åºçš„æ•°å€¼ã€‚è¿™äº›æ•°å€¼å¯ä»¥è¡¨ç¤ºå¤šç»´ç©ºé—´ä¸­çš„ä¸€ä¸ªç‚¹æˆ–æŸä¸ªç‰¹å®šçš„æ•°æ®ç»“æ„ã€‚ ç‰¹æ€§ï¼š å›ºå®šé•¿åº¦ï¼šå‘é‡çš„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œä¾‹å¦‚ä¸€ä¸ªåŒ…å«ä¸‰ä¸ªæ•°å€¼çš„å‘é‡$x_1, x_2, x_3$ã€‚ è¿™ç§å¤„ç†æ–¹å¼å¯¹äºå›¾åƒåˆ†ç±»ã€å›ºå®šé•¿åº¦çš„æ–‡æœ¬åˆ†ç±»ç­‰ä»»åŠ¡éå¸¸æœ‰æ•ˆã€‚ æ— æ—¶é—´ä¾èµ–ï¼šå‘é‡ä¸­çš„å…ƒç´ æ²¡æœ‰æ—¶é—´æˆ–é¡ºåºä¸Šçš„ä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼Œä¸€å¼ å›¾ç‰‡çš„åƒç´ æ•°æ®å¯ä»¥ä½œä¸ºè¾“å…¥å‘é‡ï¼Œä½†è¿™äº›åƒç´ ä¹‹é—´æ²¡æœ‰æ—¶é—´é¡ºåºä¸Šçš„å…³ç³»ã€‚ ç¤ºä¾‹ï¼š å›¾åƒå¤„ç†ä¸­çš„åƒç´ å€¼å‘é‡ã€‚ é™æ€æ–‡æœ¬åˆ†ç±»ä¸­çš„å•è¯å‘é‡ã€‚ å‘é‡è¾“å…¥è¾“å‡ºï¼šå‘é‡è¾“å…¥è¾“å‡ºé€šå¸¸æŒ‡çš„æ˜¯ç¥ç»ç½‘ç»œå¤„ç†å›ºå®šé•¿åº¦çš„å‘é‡ï¼Œå³ä¸€ç»„å›ºå®šå¤§å°çš„æ•°å€¼è¾“å…¥å’Œè¾“å‡ºã€‚ åº”ç”¨åœºæ™¯ï¼š å›¾åƒåˆ†ç±»ï¼šè¾“å…¥æ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„å›¾åƒå‘é‡ï¼Œè¾“å‡ºæ˜¯ä¸€ä¸ªç±»åˆ«æ ‡ç­¾å‘é‡ã€‚ é™æ€æ–‡æœ¬åˆ†ç±»ï¼šè¾“å…¥æ˜¯ä¸€ä¸ªè¡¨ç¤ºå•ä¸ªæ–‡æ¡£çš„å‘é‡ï¼Œè¾“å‡ºæ˜¯åˆ†ç±»æ ‡ç­¾ã€‚ åºåˆ—ï¼ˆSequenceï¼‰ï¼š å®šä¹‰ï¼šåºåˆ—æ˜¯ä¸€ç»„æŒ‰ç‰¹å®šé¡ºåºæ’åˆ—çš„æ•°æ®ï¼Œé€šå¸¸æ˜¯æ—¶é—´æˆ–é¡ºåºç›¸å…³çš„ã€‚ ç‰¹æ€§ï¼š å˜é•¿ï¼šåºåˆ—çš„é•¿åº¦å¯ä»¥å˜åŒ–ï¼Œä¾‹å¦‚ä¸€æ®µæ–‡æœ¬å¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦åºåˆ—$c_1, c_2, â€¦, c_t$ æœ‰æ—¶é—´ä¾èµ–ï¼šåºåˆ—ä¸­çš„å…ƒç´ æœ‰æ—¶é—´æˆ–é¡ºåºä¸Šçš„ä¾èµ–å…³ç³»ã€‚åç»­å…ƒç´ ä¾èµ–äºå‰é¢å‡ºç°çš„å…ƒç´ ã€‚ä¾‹å¦‚ï¼Œåœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­ï¼Œä¸€ä¸ªå¥å­çš„å•è¯é¡ºåºå†³å®šäº†å¥å­çš„æ„ä¹‰ã€‚ ç¤ºä¾‹ï¼š æ—¶é—´åºåˆ—æ•°æ®ï¼Œå¦‚è‚¡ç¥¨ä»·æ ¼çš„æ¯æ—¥è®°å½•ã€‚ æ–‡æœ¬æ•°æ®ï¼Œå¦‚ä¸€æ®µå¥å­ä¸­çš„å•è¯åºåˆ—ã€‚ åºåˆ—è¾“å…¥è¾“å‡ºï¼šåºåˆ—è¾“å…¥è¾“å‡ºæŒ‡çš„æ˜¯ç¥ç»ç½‘ç»œå¤„ç†ä¸€ç³»åˆ—çš„è¾“å…¥æ•°æ®ï¼Œè¿™äº›æ•°æ®æœ‰æ—¶é—´æˆ–é¡ºåºä¸Šçš„ä¾èµ–å…³ç³»ã€‚RNNï¼ˆå¾ªç¯ç¥ç»ç½‘ç»œï¼‰å°±æ˜¯å¤„ç†åºåˆ—æ•°æ®çš„å…¸å‹æ¨¡å‹ã€‚ åº”ç”¨åœºæ™¯ï¼š è¯­è¨€æ¨¡å‹å’Œæ–‡æœ¬ç”Ÿæˆï¼šè¾“å…¥æ˜¯ä¸€ä¸ªæ–‡æœ¬åºåˆ—ï¼Œè¾“å‡ºæ˜¯ä¸‹ä¸€ä¸ªå­—ç¬¦æˆ–å•è¯çš„é¢„æµ‹åºåˆ—ã€‚ æœºå™¨ç¿»è¯‘ï¼šè¾“å…¥æ˜¯æºè¯­è¨€çš„å¥å­åºåˆ—ï¼Œè¾“å‡ºæ˜¯ç›®æ ‡è¯­è¨€çš„å¥å­åºåˆ—ã€‚ è¯­éŸ³è¯†åˆ«ï¼šè¾“å…¥æ˜¯è¯­éŸ³ä¿¡å·çš„æ—¶é—´åºåˆ—ï¼Œè¾“å‡ºæ˜¯å¯¹åº”çš„æ–‡æœ¬åºåˆ—ã€‚ 3. RNN computationè®ºæ–‡æ­£æ–‡ä¸­å¯¹è¯¥è¿‡ç¨‹çš„æè¿°æ–‡å­—è¾ƒå¤šï¼Œæˆ‘åå€’è§‰å¾—ç»“åˆæ•°å­¦å…¬å¼åæ›´å¥½ç†è§£ã€‚è¿™é‡Œæè¿°å°±æ˜¯ RNN çš„å‰å‘ä¼ æ’­è¿‡ç¨‹ï¼Œ å¦‚æœä½ äº†è§£äº†åŸºç¡€ç¥ç»ç½‘ç»œçš„å‰å‘ä¼ æ’­è¿‡ç¨‹ï¼Œé‚£ä¹ˆRNNä¹Ÿéå¸¸å¥½ç†è§£ã€‚ ç®€å•ç†è§£å°±æ˜¯ ç›¸æ¯”åœ¨ç¥ç»ç½‘ç»œä¸€æ–‡ä¸­è®²è¿°çš„åŸºç¡€ å‰å‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œé€’å½’ç¥ç»ç½‘ç»œåœ¨æ­¤åŸºç¡€ä¸Šå¢åŠ äº†ä¸€ä¸ªéšè—å±‚åˆ°éšè—å±‚çš„æƒé‡çŸ©é˜µå‚ä¸è®¡ç®—ã€‚ è¿™3ä¸ªæƒé‡çŸ©é˜µåˆ†åˆ«å¯¹åº”æ–‡ä¸­W_hhï¼ˆéšè—å±‚åˆ°éšè—å±‚ï¼‰ã€W_xhï¼ˆè¾“å…¥å±‚åˆ°éšè—å±‚ï¼‰å’ŒW_hyï¼ˆéšè—å±‚åˆ°è¾“å‡ºå±‚ï¼‰,ä¸‹é¢ä»¥$â„_ğ‘¡=tanhâ¡(ğ‘Š_{â„â„}â„_{ğ‘¡âˆ’1}+ğ‘Š_{ğ‘¥â„}ğ‘¥_ğ‘¡)$ æ¥æ‹†è§£æ•´ä¸ªè¿‡ç¨‹ å‡è®¾ç½‘ç»œç»“æ„å’Œå‚æ•°å¦‚ä¸‹ è¾“å…¥å±‚ï¼š2ä¸ªèŠ‚ç‚¹ï¼Œè¡¨ç¤ºè¾“å…¥ç‰¹å¾ $x_1$ å’Œ $x_2$ã€‚ éšè—å±‚ï¼š2ä¸ªèŠ‚ç‚¹ï¼Œè¡¨ç¤ºéšè—çŠ¶æ€ $h_1$ å’Œ $h_2$â€‹ï¼Œ,ä½¿ç”¨tanhæ¿€æ´»å‡½æ•°ã€‚ è¾“å‡ºå±‚ï¼š1ä¸ªèŠ‚ç‚¹ï¼Œè¡¨ç¤ºè¾“å‡º $y$ï¼Œä½¿ç”¨çº¿æ€§æ¿€æ´»å‡½æ•°ã€‚ æƒé‡çŸ©é˜µ è¾“å…¥å±‚åˆ°éšè—å±‚çš„æƒé‡ï¼š $W_{xh} = \\begin{bmatrix} W_{11} &amp; W_{12} \\ W_{21} &amp; W_{22} \\end{bmatrix}$ $W_{11}$ã€$W_{12}$â€‹ è¿æ¥ $x_1$â€‹ åˆ° $h_1$â€‹ å’Œ $h_2$â€‹ï¼Œ$W_{21}$ã€$W_{22}$â€‹ è¿æ¥ $x_2$â€‹ åˆ° $h_1$â€‹ å’Œ $h_2$ã€‚ éšè—å±‚åˆ°éšè—å±‚çš„æƒé‡ï¼š$W_{hh} = \\begin{bmatrix} U_{11} &amp; U_{12} \\ U_{21} &amp; U_{22} \\end{bmatrix}$ $U_{11}$å’Œ $U_{12}$ è¿æ¥ $h_1(t-1)$åˆ° $h_1(t)$ å’Œ $h_2(t)$ã€‚ $U_{21}$ å’Œ $U_{22}$ è¿æ¥ $h_2(t-1)$ åˆ° $h_1(t)$ å’Œ $h_2(t)$ã€‚[[#5. åºåˆ—æ•°æ®çš„å¤„ç†]] éšè—å±‚åˆ°è¾“å‡ºå±‚çš„æƒé‡ï¼š $W_{hy} = \\begin{bmatrix} W_{31} &amp; W_{32} \\end{bmatrix}$ $W_{31}$â€‹ å’Œ $W_{32}$åˆ†åˆ«è¿æ¥$h_1$ å’Œ$h_2$åˆ° $y$ã€‚ å‰å‘ä¼ æ’­è¿‡ç¨‹å¯¹äºæ¯ä¸ªæ—¶é—´æ­¥ $t$ï¼Œå‰å‘ä¼ æ’­çš„è®¡ç®—æ­¥éª¤å¦‚ä¸‹ï¼š 1. è¾“å…¥å±‚åˆ°éšè—å±‚è®¡ç®—å½“å‰æ—¶é—´æ­¥çš„éšè—çŠ¶æ€, å³æ­£æ–‡ä¸­çš„â€œéšè—çŠ¶æ€çš„æ›´æ–°â€$â„_ğ‘¡=tanhâ¡(ğ‘Š_{â„â„}â„_{ğ‘¡âˆ’1}+ğ‘Š_{ğ‘¥â„}ğ‘¥_ğ‘¡)$å…¶ä¸­ï¼Œ$\\mathbf{x}_t$â€‹ æ˜¯å½“å‰æ—¶é—´æ­¥çš„è¾“å…¥å‘é‡ï¼Œ$\\mathbf{h}_{t-1}$æ˜¯å‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ã€‚å…·ä½“å±•å¼€å¦‚ä¸‹ï¼š $\\begin{bmatrix} h_{1t} \\ h_{2t} \\end{bmatrix} = \\text{tanh} \\left( \\begin{bmatrix} W_{11} &amp; W_{12} \\ W_{21} &amp; W_{22} \\end{bmatrix} \\begin{bmatrix} x_{1t} \\ x_{2t} \\end{bmatrix} + \\begin{bmatrix} U_{11} &amp; U_{12} \\ U_{21} &amp; U_{22} \\end{bmatrix} \\begin{bmatrix} h_{1(t-1)} \\ h_{2(t-1)} \\end{bmatrix} + \\begin{bmatrix} b_1 \\ b_2 \\end{bmatrix} \\right)$ åˆ†å¼€è®¡ç®—ï¼š$h_{1t} = \\text{tanh}(W_{11} x_{1t} + W_{12} x_{2t} + U_{11} h_{1(t-1)} + U_{12} h_{2(t-1)} )$ $h_{2t} = \\text{tanh}(W_{21} x_{1t} + W_{22} x_{2t} + U_{21} h_{1(t-1)} + U_{22} h_{2(t-1)})$ 2. éšè—å±‚åˆ°è¾“å‡ºå±‚è®¡ç®—å½“å‰æ—¶é—´æ­¥çš„è¾“å‡ºã€‚ $y_t = W_{hy} \\mathbf{h}_t$å…·ä½“å±•å¼€å¦‚ä¸‹ï¼š$y_t = \\begin{bmatrix} W_{31} &amp; W_{32} \\end{bmatrix} \\begin{bmatrix} h_{1t} \\ h_{2t} \\end{bmatrix}$ åˆ†å¼€è®¡ç®—ï¼š $y_t = W_{31} h_{1t} + W_{32} h_{2t}$ âš ï¸ï¼š tanh æ˜¯éçº¿æ€§æ¿€æ´»å‡½æ•° 4. 1-of-kç¼–ç 1-of-kç¼–ç ï¼Œä¹Ÿç§°ä¸ºç‹¬çƒ­ç¼–ç ï¼ˆOne-Hot Encodingï¼‰ï¼Œæ˜¯ä¸€ç§å°†åˆ†ç±»æ•°æ®è½¬æ¢ä¸ºäºŒè¿›åˆ¶å‘é‡çš„æ–¹æ³•ã€‚å®ƒçš„ç›®çš„æ˜¯å°†éæ•°å€¼å‹çš„ç±»åˆ«å˜é‡è½¬åŒ–ä¸ºé€‚åˆäºæœºå™¨å­¦ä¹ ç®—æ³•å¤„ç†çš„æ•°å€¼å‹æ•°æ®ã€‚ å·¥ä½œåŸç†å‡è®¾æœ‰ä¸€ä¸ªç±»åˆ«å˜é‡ï¼Œå®ƒæœ‰ $k$ ä¸ªä¸åŒçš„ç±»åˆ«ã€‚1-of-kç¼–ç å°†æ¯ä¸ªç±»åˆ«è¡¨ç¤ºä¸ºä¸€ä¸ªé•¿åº¦ä¸º $k$ çš„äºŒè¿›åˆ¶å‘é‡ï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªä½ç½®ä¸º1ï¼Œå…¶ä»–ä½ç½®ä¸º0ã€‚ ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸€ä¸ªæœ‰å››ä¸ªç±»åˆ«çš„å˜é‡ï¼šâ€Aâ€, â€œBâ€, â€œCâ€, â€œDâ€ã€‚å…¶1-of-kç¼–ç å¦‚ä¸‹ï¼š ç±»åˆ« 1-of-kç¼–ç  A [1, 0, 0, 0] B [0, 1, 0, 0] C [0, 0, 1, 0] D [0, 0, 0, 1] ä¼˜ç‚¹ æ¶ˆé™¤æ’åºå…³ç³»ï¼šç‹¬çƒ­ç¼–ç å°†åˆ†ç±»å˜é‡è½¬åŒ–ä¸ºäºŒè¿›åˆ¶å‘é‡ï¼Œé¿å…äº†å¯¹åˆ†ç±»å˜é‡çš„è¯¯è§£ï¼Œå³è®¤ä¸ºå®ƒä»¬ä¹‹é—´å­˜åœ¨æ’åºå…³ç³»ã€‚ é€‚åˆæ¨¡å‹å¤„ç†ï¼šè®¸å¤šæœºå™¨å­¦ä¹ ç®—æ³•ï¼ˆå¦‚çº¿æ€§å›å½’ã€é€»è¾‘å›å½’ç­‰ï¼‰æ— æ³•ç›´æ¥å¤„ç†éæ•°å€¼å‹æ•°æ®ï¼Œ1-of-kç¼–ç ä½¿è¿™äº›æ•°æ®é€‚åˆäºè¿™äº›ç®—æ³•ã€‚ ç¼ºç‚¹ é«˜ç»´åº¦é—®é¢˜ï¼šå½“ç±»åˆ«æ•°é‡è¾ƒå¤šæ—¶ï¼Œç¼–ç åçš„å‘é‡é•¿åº¦ä¼šå˜å¾—å¾ˆé•¿ï¼Œå¯¼è‡´é«˜ç»´åº¦é—®é¢˜ï¼Œå¢åŠ è®¡ç®—å’Œå­˜å‚¨æˆæœ¬ã€‚ å®é™…åº”ç”¨ æ–‡æœ¬å¤„ç†ï¼šåœ¨è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰ä»»åŠ¡ä¸­ï¼Œ1-of-kç¼–ç å¸¸ç”¨äºå°†å•è¯è½¬åŒ–ä¸ºäºŒè¿›åˆ¶å‘é‡ã€‚ åˆ†ç±»ä»»åŠ¡ï¼šåœ¨åˆ†ç±»ä»»åŠ¡ä¸­ï¼Œç”¨äºå°†ç±»åˆ«æ ‡ç­¾è½¬åŒ–ä¸ºæ¨¡å‹å¯ä»¥å¤„ç†çš„æ•°å€¼å‹æ•°æ®ã€‚ 1-of-kç¼–ç æ˜¯æ•°æ®é¢„å¤„ç†ä¸­çš„ä¸€ç§é‡è¦æŠ€æœ¯ï¼Œå¹¿æ³›åº”ç”¨äºå„ç§æœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ ä»»åŠ¡ä¸­ã€‚å®ƒå¸®åŠ©å°†åˆ†ç±»æ•°æ®è½¬åŒ–ä¸ºæ•°å€¼æ•°æ®ï¼Œä½¿å¾—å„ç§æ¨¡å‹èƒ½å¤Ÿæ›´å¥½åœ°å¤„ç†è¿™äº›æ•°æ®ã€‚ 5. ç½®ä¿¡åº¦åœ¨æœºå™¨å­¦ä¹ ä¸­ï¼Œç½®ä¿¡åº¦ï¼ˆconfidenceï¼‰æ˜¯è¡¡é‡æ¨¡å‹é¢„æµ‹ç»“æœç¡®å®šæ€§çš„ä¸€ä¸ªæŒ‡æ ‡ã€‚ç½®ä¿¡åº¦å¯ä»¥ç†è§£ä¸ºæ¨¡å‹å¯¹å…¶é¢„æµ‹çš„æŸä¸ªç»“æœæ˜¯æ­£ç¡®çš„ä¿¡å¿ƒç¨‹åº¦ã€‚ åœ¨æœºå™¨å­¦ä¹ ä¸­ï¼Œç½®ä¿¡åº¦é€šå¸¸ä»¥æ¦‚ç‡å€¼çš„å½¢å¼è¡¨ç¤ºï¼Œåæ˜ äº†æ¨¡å‹å¯¹æŸä¸ªé¢„æµ‹çš„ç¡®å®šæ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨åˆ†ç±»ä»»åŠ¡ä¸­ï¼Œæ¨¡å‹å¯¹æŸä¸ªæ ·æœ¬å±äºæŸä¸€ç±»çš„ç½®ä¿¡åº¦å¯èƒ½æ˜¯80%ï¼Œè¡¨ç¤ºæ¨¡å‹è®¤ä¸ºè¯¥æ ·æœ¬å±äºè¯¥ç±»çš„æ¦‚ç‡ä¸º80%ã€‚å…·ä½“åº”ç”¨ï¼š åˆ†ç±»ä»»åŠ¡ï¼šå¦‚å›¾åƒåˆ†ç±»ï¼Œæ¨¡å‹è¾“å‡ºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡åˆ†å¸ƒã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€å¼ å›¾ç‰‡ï¼Œæ¨¡å‹å¯èƒ½è¾“å‡ºï¼š[çŒ«: 0.7, ç‹—: 0.2, å…”å­: 0.1]ï¼Œå…¶ä¸­çŒ«çš„ç½®ä¿¡åº¦æœ€é«˜ã€‚ ç½®ä¿¡åº¦é˜ˆå€¼ï¼šåœ¨æŸäº›åº”ç”¨ä¸­ï¼Œå¯èƒ½ä¼šè®¾ç½®ä¸€ä¸ªç½®ä¿¡åº¦é˜ˆå€¼ï¼Œåªæœ‰å½“é¢„æµ‹çš„ç½®ä¿¡åº¦è¶…è¿‡æŸä¸ªå€¼æ—¶ï¼Œæ‰è®¤ä¸ºé¢„æµ‹æœ‰æ•ˆã€‚ ç½®ä¿¡åº¦çš„è®¡ç®— æ¦‚ç‡åˆ†å¸ƒï¼šä½¿ç”¨Softmaxå‡½æ•°å°†æ¨¡å‹è¾“å‡ºçš„logitsè½¬åŒ–ä¸ºæ¦‚ç‡åˆ†å¸ƒï¼Œè¿™äº›æ¦‚ç‡å€¼å³ä¸ºç½®ä¿¡åº¦ã€‚ Softmaxå…¬å¼ï¼šå¯¹äºç¬¬ $i$ ä¸ªè¾“å‡ºèŠ‚ç‚¹ï¼Œç½®ä¿¡åº¦ $P(y_i)$ ä¸ºï¼š $P(y_i) = \\frac{e^{z_i}}{\\sum_{j} e^{z_j}}$ å…¶ä¸­ï¼Œ $z_i$ æ˜¯ç¬¬ $i$ ä¸ªèŠ‚ç‚¹çš„logitã€‚Logits Logits æ˜¯ç¥ç»ç½‘ç»œåœ¨åˆ†ç±»ä»»åŠ¡ä¸­çš„è¾“å‡ºå±‚çš„åŸå§‹å¾—åˆ†ã€‚å®ƒä»¬æ˜¯æœªç»è¿‡å½’ä¸€åŒ–çš„æ•°å€¼ï¼Œç”¨äºè¡¨ç¤ºæ¯ä¸ªç±»åˆ«çš„ç›¸å¯¹ç½®ä¿¡åº¦ã€‚Logits æ˜¯é€šè¿‡å‰å‘ä¼ æ’­è®¡ç®—å¾—åˆ°çš„ï¼Œè¡¨ç¤ºæ¨¡å‹å¯¹æ¯ä¸ªå¯èƒ½çš„ç±»åˆ«çš„åˆå§‹ä¼°è®¡ã€‚ å…·ä½“ç†è§£ åŸå§‹å¾—åˆ†ï¼šLogits æ˜¯ç¥ç»ç½‘ç»œæœ€åä¸€å±‚è¾“å‡ºçš„åŸå§‹åˆ†æ•°ï¼Œè¿™äº›åˆ†æ•°è¿˜æ²¡æœ‰è¢«è½¬æ¢ä¸ºæ¦‚ç‡ã€‚ ç”¨é€”ï¼šåœ¨åˆ†ç±»ä»»åŠ¡ä¸­ï¼ŒLogits è¢«ç”¨æ¥è®¡ç®—æ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ï¼Œè¿™é€šå¸¸é€šè¿‡ Softmax å‡½æ•°å®Œæˆã€‚ Softmax è½¬æ¢ï¼šSoftmax å‡½æ•°å°† Logits è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒï¼Œä½¿å¾—è¿™äº›æ¦‚ç‡çš„å’Œä¸º1ã€‚å…¬å¼å¦‚ä¸Š 6. Softmax[[0-ç¥ç»ç½‘ç»œï¼ˆNeural Networksï¼‰#^cfe178]] 7. è¶…å‚æ•° Temperature æ¸©åº¦Temperatureæ˜¯åœ¨æ¨¡å‹ä½¿ç”¨æˆ–è°ƒä¼˜è¿‡ç¨‹ä¸­è®¾å®šçš„å‚æ•°ï¼Œå¹¶ä¸é€šè¿‡æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­çš„ä¼˜åŒ–ç®—æ³•æ¥æ›´æ–°ï¼Œå› æ­¤å®ƒå±äºè¶…å‚æ•°ã€‚Temperatureä½œä¸ºè¶…å‚æ•°ï¼Œåœ¨ç¥ç»ç½‘ç»œä¸­ç”¨æ¥æ§åˆ¶Softmaxè¾“å‡ºçš„æ¦‚ç‡åˆ†å¸ƒå¹³æ»‘ç¨‹åº¦ï¼Œå®ƒçš„ä½œç”¨æ˜¯è°ƒèŠ‚æ¨¡å‹ç”Ÿæˆæ ·æœ¬çš„å¤šæ ·æ€§å’Œç¡®å®šæ€§ã€‚ Temperatureçš„å…¬å¼Softmaxå‡½æ•°å¸¦æœ‰Temperatureçš„å…¬å¼å¦‚ä¸‹ï¼š $P(y_i) = \\frac{e^{z_i / T}}{\\sum_{j} e^{z_j / T}}$ å…¶ä¸­ï¼Œ$z_i$ æ˜¯logitså€¼ï¼Œ$T$ æ˜¯Temperatureå‚æ•°ã€‚ Temperatureçš„å½±å“ é«˜Temperatureï¼ˆT &gt; 1ï¼‰ï¼š å¹³æ»‘åˆ†å¸ƒï¼šä½¿æ¦‚ç‡åˆ†å¸ƒæ›´åŠ å¹³æ»‘ï¼Œå¢åŠ ç”Ÿæˆæ ·æœ¬çš„å¤šæ ·æ€§ã€‚ å¢åŠ éšæœºæ€§ï¼šè¾“å‡ºç±»åˆ«ä¹‹é—´çš„æ¦‚ç‡å·®è·ç¼©å°ï¼Œä½¿å¾—é€‰æ‹©æ›´éšæœºã€‚ ç¤ºä¾‹ï¼šå‡è®¾ logits ä¸º $[2.0,1.0,0.1]$ï¼Œä½¿ç”¨ $T = 2$ æ—¶ï¼Œæ¦‚ç‡å¯èƒ½å˜å¾—æ›´æ¥è¿‘ï¼Œå¦‚ $[0.4,0.35,0.25]$ã€‚ ä½Temperatureï¼ˆ0 &lt; T &lt; 1ï¼‰ï¼š å°–é”åˆ†å¸ƒï¼šä½¿æ¦‚ç‡åˆ†å¸ƒæ›´åŠ å°–é”ï¼Œå¢åŠ ç”Ÿæˆæ ·æœ¬çš„ç¡®å®šæ€§ã€‚ å‡å°‘éšæœºæ€§ï¼šè¾“å‡ºç±»åˆ«ä¹‹é—´çš„æ¦‚ç‡å·®è·åŠ å¤§ï¼Œä½¿å¾—é€‰æ‹©æ›´ç¡®å®šã€‚ ç¤ºä¾‹ï¼šå‡è®¾ logits ä¸º $[2.0,1.0,0.1]$ï¼Œä½¿ç”¨ $T = 0.5$ æ—¶ï¼Œæ¦‚ç‡å¯èƒ½å˜å¾—æ›´å°–é”ï¼Œå¦‚ $[0.7,0.25,0.05]$ã€‚ Temperatureç­‰äº1ï¼š æ ‡å‡†Softmaxï¼šæ¦‚ç‡åˆ†å¸ƒä¿æŒåŸæ ·ï¼Œä¸åšä»»ä½•è°ƒæ•´ã€‚ ä½œç”¨åŠåº”ç”¨åœºæ™¯ æ–‡æœ¬ç”Ÿæˆï¼š æ§åˆ¶ç”Ÿæˆæ–‡æœ¬çš„å¤šæ ·æ€§å’Œåˆ›é€ æ€§ã€‚åœ¨æ–‡æœ¬ç”Ÿæˆä»»åŠ¡ä¸­ï¼Œé«˜Temperatureå¯èƒ½ç”Ÿæˆæ›´æœ‰åˆ›æ„ä½†ä¸ä¸€å®šåˆç†çš„å¥å­ï¼Œè€Œä½Temperatureå¯èƒ½ç”Ÿæˆæ›´åˆç†ä½†ç¼ºä¹å¤šæ ·æ€§çš„å¥å­ã€‚ æ¢ç´¢ä¸åˆ©ç”¨ï¼š åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼Œé«˜Temperatureç”¨äºæ¢ç´¢å¤šæ ·æ€§ç­–ç•¥ï¼Œä½Temperatureç”¨äºåˆ©ç”¨å·²çŸ¥çš„æœ€ä½³ç­–ç•¥ã€‚","tags":["AI","ç¥ç»ç½‘ç»œ","Ilya sutskeverâ€˜s 30  papers"]},{"title":"é€’å½’ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Networks, RNNsï¼‰","path":"/6ac941eb/","content":"å‰ç½®æ¦‚å¿µ1. æ—¶é—´æ­¥ï¼ˆTime Stepï¼‰å’Œåºåˆ—æ•°æ®ï¼ˆSequential Dataï¼‰1.1 åºåˆ—æ•°æ®ï¼ˆSequential Dataï¼‰åºåˆ—æ•°æ®ï¼ˆSequential Dataï¼‰æ˜¯æŒ‡æŒ‰ç…§æ—¶é—´æˆ–å…¶ä»–é¡ºåºæ’åˆ—çš„æ•°æ®ï¼Œå…¶ä¸­æ¯ä¸ªæ•°æ®ç‚¹çš„æ„ä¹‰å’Œä»·å€¼éƒ½ä¾èµ–äºå®ƒåœ¨åºåˆ—ä¸­çš„ä½ç½®å’Œå‰åæ•°æ®ç‚¹çš„å…³ç³»ã€‚åºåˆ—æ•°æ®å¹¿æ³›å­˜åœ¨äºè®¸å¤šå®é™…åº”ç”¨ä¸­ï¼Œå¦‚æ—¶é—´åºåˆ—ã€è‡ªç„¶è¯­è¨€å¤„ç†ã€è¯­éŸ³è¯†åˆ«ç­‰ã€‚ åºåˆ—æ•°æ®çš„ç‰¹ç‚¹ æ—¶é—´ä¾èµ–æ€§ï¼šåºåˆ—æ•°æ®ä¸­çš„æ¯ä¸ªæ•°æ®ç‚¹ä¸å…¶å‰åæ•°æ®ç‚¹å­˜åœ¨ä¾èµ–å…³ç³»ã€‚è¿™ç§ä¾èµ–æ€§å¯ä»¥æ˜¯çŸ­æœŸçš„ï¼ˆä»…ä¾èµ–äºæœ€è¿‘çš„æ•°æ®ç‚¹ï¼‰æˆ–é•¿æœŸçš„ï¼ˆä¾èµ–äºè¾ƒæ—©çš„æ•°æ®ç‚¹ï¼‰ã€‚ é¡ºåºå…³ç³»ï¼šåºåˆ—æ•°æ®çš„é¡ºåºæ˜¯è‡³å…³é‡è¦çš„ï¼Œæ•°æ®ç‚¹çš„é¡ºåºå…³ç³»å†³å®šäº†å…¶å®é™…æ„ä¹‰ã€‚ä¾‹å¦‚ï¼Œåœ¨è¯­éŸ³ä¿¡å·ä¸­ï¼ŒéŸ³é¢‘å¸§çš„é¡ºåºå†³å®šäº†æœ€ç»ˆè¯­éŸ³çš„å†…å®¹ã€‚ åŠ¨æ€æ€§ï¼šåºåˆ—æ•°æ®å¾€å¾€æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ•°æ®ç‚¹çš„å€¼éšæ—¶é—´æˆ–å…¶ä»–é¡ºåºå˜åŒ–è€Œå˜åŒ–ã€‚ 1.2 æ—¶é—´æ­¥æ—¶é—´æ­¥æŒ‡çš„æ˜¯åºåˆ—æ•°æ®ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ åœ¨æ—¶é—´ç»´åº¦ä¸Šçš„ä½ç½®ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªæ—¶é—´åºåˆ—ä¸­ï¼Œæ¯ä¸ªæ—¶é—´ç‚¹ä¸Šçš„æ•°æ®ç§°ä¸ºä¸€ä¸ªæ—¶é—´æ­¥ã€‚åœ¨é€’å½’ç¥ç»ç½‘ç»œä¸­ï¼Œè¾“å…¥åºåˆ—æŒ‰æ—¶é—´æ­¥é€æ­¥å¤„ç†ï¼Œæ¯ä¸ªæ—¶é—´æ­¥çš„è¾“å…¥ä¸ä»…å½±å“å½“å‰æ—¶é—´æ­¥çš„è¾“å‡ºï¼Œè¿˜å½±å“åç»­æ—¶é—´æ­¥çš„è®¡ç®—ã€‚ 1.3 åºåˆ—æ•°æ®ä¸æ—¶é—´æ­¥çš„å®é™…ä¾‹å­åºåˆ—æ•°æ®å¯ä»¥åˆ†ä¸ºå¤šç§ç±»å‹ï¼Œå…·ä½“åŒ…æ‹¬ï¼š 1. æ—¶é—´åºåˆ—æ•°æ®æ—¶é—´åºåˆ—æ•°æ®æ˜¯æŒ‰ç…§æ—¶é—´é¡ºåºæ’åˆ—çš„æ•°æ®ï¼Œå¸¸ç”¨äºé‡‘èå¸‚åœºåˆ†æã€æ°”è±¡é¢„æŠ¥ç­‰é¢†åŸŸã€‚ç¤ºä¾‹ï¼šè‚¡ç¥¨ä»·æ ¼ã€æ¸©åº¦è®°å½•ç­‰ã€‚12æ—¶é—´ï¼š t1 t2 t3 t4 t5è‚¡ç¥¨ä»·æ ¼ï¼š 100 102 101 103 104 2. è‡ªç„¶è¯­è¨€å¤„ç†æ•°æ®è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„æ•°æ®æ˜¯æŒ‰ç…§æ–‡æœ¬ä¸­çš„é¡ºåºæ’åˆ—çš„å•è¯æˆ–å­—ç¬¦ï¼Œå¸¸ç”¨äºæ–‡æœ¬åˆ†ç±»ã€æœºå™¨ç¿»è¯‘ç­‰ä»»åŠ¡ã€‚ ç¤ºä¾‹ï¼šä¸€æ®µæ–‡æœ¬ã€ä¸€å¥è¯ç­‰ã€‚12æ—¶é—´ï¼š t1 t2 t3 t4 t5å¥å­ï¼š æˆ‘ å–œæ¬¢ å­¦ä¹  æœºå™¨ å­¦ä¹  3. è¯­éŸ³ä¿¡å·æ•°æ®è¯­éŸ³ä¿¡å·æ˜¯è¿ç»­çš„éŸ³é¢‘å¸§åºåˆ—ï¼Œæ¯ä¸ªéŸ³é¢‘å¸§è¡¨ç¤ºä¸€å°æ®µæ—¶é—´å†…çš„å£°éŸ³ç‰¹å¾ï¼Œå¸¸ç”¨äºè¯­éŸ³è¯†åˆ«ã€è¯­éŸ³åˆæˆç­‰ä»»åŠ¡ã€‚ ç¤ºä¾‹ï¼šä¸€æ®µè¯­éŸ³ä¿¡å·ã€‚12æ—¶é—´æ­¥ï¼š t1 t2 t3 t4 t5éŸ³é¢‘å¸§ï¼š F1 F2 F3 F4 F5 4. è§†é¢‘æ•°æ®è§†é¢‘æ•°æ®æ˜¯ç”±ä¸€ç³»åˆ—æŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„å›¾åƒå¸§ç»„æˆï¼Œå¸¸ç”¨äºè§†é¢‘åˆ†ç±»ã€ç›®æ ‡æ£€æµ‹ç­‰ä»»åŠ¡ã€‚ ç¤ºä¾‹ï¼šä¸€æ®µè§†é¢‘ã€‚12æ—¶é—´æ­¥ï¼š t1 t2 t3 t4 t5è§†é¢‘å¸§ï¼š F1 F2 F3 F4 F5 1.4 åºåˆ—æ•°æ®çš„å®é™…åº”ç”¨åœºæ™¯ æ—¶é—´åºåˆ—é¢„æµ‹ï¼šé€šè¿‡åˆ†æå†å²æ•°æ®ï¼Œé¢„æµ‹æœªæ¥çš„å€¼ã€‚ç¤ºä¾‹ï¼šè‚¡ç¥¨ä»·æ ¼é¢„æµ‹ã€å¤©æ°”é¢„æŠ¥ã€é”€å”®é‡é¢„æµ‹ç­‰ã€‚ è‡ªç„¶è¯­è¨€å¤„ç†ï¼šå¤„ç†å’Œç†è§£äººç±»è¯­è¨€ï¼Œæ‰§è¡Œå„ç§è¯­è¨€ç›¸å…³ä»»åŠ¡ã€‚ç¤ºä¾‹ï¼šæ–‡æœ¬åˆ†ç±»ã€æƒ…æ„Ÿåˆ†æã€æœºå™¨ç¿»è¯‘ã€æ–‡æœ¬ç”Ÿæˆç­‰ã€‚ è¯­éŸ³è¯†åˆ«ï¼šå°†è¯­éŸ³ä¿¡å·è½¬æ¢ä¸ºæ–‡æœ¬ï¼Œæˆ–è€…è¯†åˆ«è¯­éŸ³ä¸­çš„æƒ…æ„Ÿã€è¯­ç§ç­‰ä¿¡æ¯ã€‚ç¤ºä¾‹ï¼šè¯­éŸ³åˆ°æ–‡æœ¬è½¬æ¢ã€è¯­éŸ³æƒ…æ„Ÿè¯†åˆ«ã€è¯­éŸ³ç¿»è¯‘ç­‰ã€‚ è§†é¢‘å¤„ç†ï¼šå¤„ç†å’Œåˆ†æè§†é¢‘æ•°æ®ï¼Œæ‰§è¡Œå„ç§è§†é¢‘ç›¸å…³ä»»åŠ¡ã€‚ç¤ºä¾‹ï¼šè§†é¢‘åˆ†ç±»ã€ç›®æ ‡æ£€æµ‹ã€è¡Œä¸ºè¯†åˆ«ç­‰ 1.5 åºåˆ—æ•°æ®çš„å¤„ç†å¤„ç†åºåˆ—æ•°æ®æ—¶ï¼Œéœ€è¦è€ƒè™‘æ•°æ®çš„é¡ºåºå’Œæ—¶é—´ä¾èµ–æ€§ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„å¤„ç†æ–¹æ³•å’Œæ¨¡å‹ï¼š 1. é€’å½’ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Networks, RNNsï¼‰RNNsé€šè¿‡å¾ªç¯ç»“æ„èƒ½å¤Ÿè®°ä½å’Œåˆ©ç”¨åºåˆ—æ•°æ®ä¸­çš„æ—¶é—´ä¾èµ–æ€§ï¼Œé€‚ç”¨äºå¤„ç†å„ç§åºåˆ—æ•°æ®ã€‚ ç‰¹ç‚¹ï¼š èƒ½å¤Ÿå¤„ç†å˜é•¿åºåˆ—æ•°æ®ã€‚ èƒ½å¤Ÿæ•æ‰çŸ­æœŸå’Œé•¿æœŸä¾èµ–å…³ç³»ã€‚ 2. é•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼ˆLong Short-Term Memory, LSTMï¼‰LSTMæ˜¯RNNçš„ä¸€ç§å˜ä½“ï¼Œä¸“é—¨ç”¨äºè§£å†³RNNä¸­çš„æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸é—®é¢˜ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°æ•æ‰é•¿åºåˆ—ä¸­çš„ä¾èµ–å…³ç³»ã€‚ ç‰¹ç‚¹ï¼š é€šè¿‡å¼•å…¥é—å¿˜é—¨ã€è¾“å…¥é—¨å’Œè¾“å‡ºé—¨æ§åˆ¶ä¿¡æ¯æµåŠ¨ã€‚ èƒ½å¤Ÿè®°ä½é•¿æ—¶é—´çš„ä¾èµ–å…³ç³»ã€‚ 3. é—¨æ§å¾ªç¯å•å…ƒï¼ˆGated Recurrent Unit, GRUï¼‰GRUæ˜¯LSTMçš„ç®€åŒ–ç‰ˆæœ¬ï¼Œå…·æœ‰ç±»ä¼¼çš„é—¨æ§æœºåˆ¶ï¼Œä½†å‚æ•°æ›´å°‘ï¼Œè®¡ç®—æ•ˆç‡æ›´é«˜ã€‚ ç‰¹ç‚¹ï¼š é€šè¿‡æ›´æ–°é—¨å’Œé‡ç½®é—¨æ§åˆ¶ä¿¡æ¯æµåŠ¨ã€‚ è®¡ç®—æ•ˆç‡æ›´é«˜ï¼Œé€‚åˆå¤„ç†é•¿åºåˆ—æ•°æ®ã€‚ 4. Transformeræ¨¡å‹Transformeræ¨¡å‹é€šè¿‡è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-Attentionï¼‰å¤„ç†åºåˆ—æ•°æ®ï¼Œèƒ½å¤Ÿå¹¶è¡Œå¤„ç†åºåˆ—ä¸­çš„æ¯ä¸ªä½ç½®ï¼Œè§£å†³äº†ä¼ ç»ŸRNNçš„è®¡ç®—ç“¶é¢ˆé—®é¢˜ã€‚ ç‰¹ç‚¹ï¼š é€šè¿‡æ³¨æ„åŠ›æœºåˆ¶æ•æ‰åºåˆ—ä¸­ä»»æ„ä½ç½®ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚ è®¡ç®—æ•ˆç‡é«˜ï¼Œé€‚åˆå¤„ç†é•¿åºåˆ—æ•°æ®ã€‚ 2. ä»€ä¹ˆæ˜¯RNNé€’å½’ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Networks, RNNsï¼‰æ˜¯ä¸€ç±»ä¸“é—¨ç”¨äºå¤„ç†åºåˆ—æ•°æ®çš„ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚RNNsé€šè¿‡å¾ªç¯ç»“æ„ä½¿å¾—ç½‘ç»œèƒ½å¤Ÿæ•æ‰å’Œè®°å¿†è¾“å…¥æ•°æ®ä¸­çš„æ—¶é—´ä¾èµ–æ€§ï¼Œé€‚ç”¨äºå„ç§åºåˆ—æ•°æ®å¤„ç†ä»»åŠ¡ï¼Œå¦‚æ—¶é—´åºåˆ—é¢„æµ‹ã€è‡ªç„¶è¯­è¨€å¤„ç†ã€è¯­éŸ³è¯†åˆ«ç­‰ã€‚ å¦‚æœä½ å·²ç»å¯¹åŸºç¡€ç¥ç»ç½‘ç»œçš„å±‚æ¬¡ç»“æ„å’Œå‰å‘ä¼ æ’­è¿‡ç¨‹äº†è§£äº†ï¼Œ é‚£ä¹ˆRNN ä¸å®ƒçš„åŒºåˆ«å°±æ˜¯å…¶éšè—å±‚å…·æœ‰å¾ªç¯è¿æ¥ï¼Œä½¿å¾—å½“å‰æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ä¸ä»…ä¾èµ–äºå½“å‰è¾“å…¥ï¼Œè¿˜ä¾èµ–äºå‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ã€‚ ä¸‹é¢åœ¨ åŸºç¡€ç¥ç»ç½‘ç»œä¸­çš„å±‚æ¬¡ç»“æ„çš„åŸºç¡€ä¸Šè¯´æ˜ RNN ç½‘ç»œç»“æ„å’Œå‚æ•° è¾“å…¥å±‚ï¼š2ä¸ªèŠ‚ç‚¹ï¼Œè¡¨ç¤ºè¾“å…¥ç‰¹å¾ $x_1$ å’Œ $x_2â€‹$ã€‚ éšè—å±‚ï¼š2ä¸ªèŠ‚ç‚¹ï¼Œè¡¨ç¤ºéšè—çŠ¶æ€ $h_1$ å’Œ $h_2$â€‹ï¼Œåç½®å‘é‡åˆ†åˆ«ä¸º$b_1$ã€$b_2$,ä½¿ç”¨ReLUæ¿€æ´»å‡½æ•°ã€‚ è¾“å‡ºå±‚ï¼š1ä¸ªèŠ‚ç‚¹ï¼Œè¡¨ç¤ºè¾“å‡º $y$ï¼Œåç½®å‘é‡åˆ†åˆ«ä¸º$b_3$,ä½¿ç”¨çº¿æ€§æ¿€æ´»å‡½æ•°ã€‚ æƒé‡çŸ©é˜µ è¾“å…¥å±‚åˆ°éšè—å±‚çš„æƒé‡ï¼š $W_{xh} = \\begin{bmatrix} W_{11} &amp; W_{12} \\ W_{21} &amp; W_{22} \\end{bmatrix}$ $W_{11}â€‹$ã€$W_{12}$â€‹ è¿æ¥ $x_1$â€‹ åˆ° $h_1$â€‹ å’Œ $h_2$â€‹ï¼Œ$W_{21}â€‹$ã€$W_{22}$â€‹ è¿æ¥ $x_2$â€‹ åˆ° $h_1$â€‹ å’Œ $h_2â€‹$ã€‚ éšè—å±‚åˆ°éšè—å±‚çš„æƒé‡ï¼š$W_{hh} = \\begin{bmatrix} U_{11} &amp; U_{12} \\ U_{21} &amp; U_{22} \\end{bmatrix}$ $U_{11}â€‹$å’Œ $U_{12}â€‹$ è¿æ¥ $h_1(t-1)$åˆ° $h_1(t)$ å’Œ $h_2(t)$ã€‚ $U_{21}â€‹$ å’Œ $U_{22}$ è¿æ¥ $h_2(t-1)$ åˆ° $h_1(t)$ å’Œ $h_2(t)$ã€‚ éšè—å±‚åˆ°è¾“å‡ºå±‚çš„æƒé‡ï¼š $W_{hy} = \\begin{bmatrix} W_{31} &amp; W_{32} \\end{bmatrix}$ $W_{31}$â€‹ å’Œ $W_{32}$åˆ†åˆ«è¿æ¥$h_1$ å’Œ$h_2â€‹$åˆ° $y$ã€‚ åç½®å‘é‡ éšè—å±‚çš„åç½®ï¼š$\\mathbf{b}_h = \\begin{bmatrix} b_1 \\ b_2 \\end{bmatrix}$ è¾“å‡ºå±‚çš„åç½®ï¼š$b_3$å‰å‘ä¼ æ’­è¿‡ç¨‹ å¯¹äºæ¯ä¸ªæ—¶é—´æ­¥ $t$ï¼Œå‰å‘ä¼ æ’­çš„è®¡ç®—æ­¥éª¤å¦‚ä¸‹ï¼š è¾“å…¥å±‚åˆ°éšè—å±‚ï¼šè®¡ç®—å½“å‰æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ã€‚$\\mathbf{h}_t = \\text{ReLU}(W_{xh} \\mathbf{x}_t + W_{hh} \\mathbf{h}_{t-1} + \\mathbf{b}_h)$ å…¶ä¸­ï¼Œ$\\mathbf{x}_t$â€‹ æ˜¯å½“å‰æ—¶é—´æ­¥çš„è¾“å…¥å‘é‡ï¼Œ$\\mathbf{h}_{t-1}â€‹$æ˜¯å‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ã€‚å…·ä½“å±•å¼€å¦‚ä¸‹ï¼š $\\begin{bmatrix} h_{1t} \\ h_{2t} \\end{bmatrix} = \\text{ReLU} \\left( \\begin{bmatrix} W_{11} &amp; W_{12} \\ W_{21} &amp; W_{22} \\end{bmatrix} \\begin{bmatrix} x_{1t} \\ x_{2t} \\end{bmatrix} + \\begin{bmatrix} U_{11} &amp; U_{12} \\ U_{21} &amp; U_{22} \\end{bmatrix} \\begin{bmatrix} h_{1(t-1)} \\ h_{2(t-1)} \\end{bmatrix} + \\begin{bmatrix} b_1 \\ b_2 \\end{bmatrix} \\right)$ åˆ†å¼€è®¡ç®—ï¼š $h_{1t} = \\text{ReLU}(W_{11} x_{1t} + W_{12} x_{2t} + U_{11} h_{1(t-1)} + U_{12} h_{2(t-1)} + b_1)$ $h_{2t} = \\text{ReLU}(W_{21} x_{1t} + W_{22} x_{2t} + U_{21} h_{1(t-1)} + U_{22} h_{2(t-1)} + b_2)$ éšè—å±‚åˆ°è¾“å‡ºå±‚ï¼šè®¡ç®—å½“å‰æ—¶é—´æ­¥çš„è¾“å‡ºã€‚ $y_t = W_{hy} \\mathbf{h}_t + b_3$å…·ä½“å±•å¼€å¦‚ä¸‹ï¼š $y_t = \\begin{bmatrix} W_{31} &amp; W_{32} \\end{bmatrix} \\begin{bmatrix} h_{1t} \\ h_{2t} \\end{bmatrix} + b_3$ åˆ†å¼€è®¡ç®—ï¼š $y_t = W_{31} h_{1t} + W_{32} h_{2t} + b_3$ Dropoutåœ¨RNNä¸­çš„è¡¨ç°åœ¨ä¼ ç»Ÿçš„å‰é¦ˆç¥ç»ç½‘ç»œä¸­ï¼ŒDropoutè¢«è¯æ˜æ˜¯éå¸¸æœ‰æ•ˆçš„æ­£åˆ™åŒ–æ–¹æ³•ã€‚ç„¶è€Œï¼Œç›´æ¥å°†è¿™ç§æ–¹æ³•åº”ç”¨äºRNNæ—¶ï¼Œä¼šç ´åæ—¶é—´æ­¥ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¯¼è‡´æ¨¡å‹æ€§èƒ½ä¸‹é™ã€‚ åœ¨RNNä¸­ï¼ŒDropoutçš„æ•ˆæœç¡®å®æ²¡æœ‰åœ¨å‰é¦ˆç¥ç»ç½‘ç»œä¸­é‚£ä¹ˆæ˜æ˜¾ï¼ŒåŸå› å¦‚ä¸‹ï¼š æ—¶é—´æ­¥ä¹‹é—´çš„ä¾èµ–æ€§ï¼šRNNä¸­çš„éšè—å±‚å…·æœ‰æ—¶é—´æ­¥ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå³å½“å‰æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ä¾èµ–äºå‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ã€‚ä¼ ç»Ÿçš„Dropoutæ–¹æ³•åœ¨RNNä¸­ä¼šç ´åè¿™ç§æ—¶é—´æ­¥ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä»è€Œå½±å“æ¨¡å‹çš„å­¦ä¹ æ•ˆæœã€‚ æ¢¯åº¦ä¼ æ’­çš„å½±å“ï¼šRNNé€šè¿‡åå‘ä¼ æ’­é€šè¿‡æ—¶é—´ï¼ˆBackpropagation Through Time, BPTTï¼‰æ¥æ›´æ–°æƒé‡ï¼ŒDropoutä¼šåœ¨æ—¶é—´æ­¥ä¹‹é—´å¼•å…¥ä¸ç¨³å®šæ€§ï¼Œå¯èƒ½å¯¼è‡´æ¢¯åº¦ä¼ æ’­è¿‡ç¨‹ä¸­çš„é—®é¢˜ï¼Œå¦‚æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸ã€‚ 3. RNNä¸­çš„æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸åœ¨è®­ç»ƒå¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰æ—¶ï¼Œå¸¸å¸¸ä¼šé‡åˆ°æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸é—®é¢˜ï¼Œè¿™ä¸¤è€…éƒ½æ˜¯ç”±RNNçš„åå‘ä¼ æ’­ç®—æ³•ï¼ˆBPTT, Backpropagation Through Timeï¼‰å¼•èµ·çš„ã€‚ 1. æ¢¯åº¦æ¶ˆå¤±ï¼ˆVanishing Gradientï¼‰ç°è±¡ï¼š å½“æ¢¯åº¦åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­é€å±‚ä¼ é€’æ—¶ï¼Œå®ƒçš„æ•°å€¼ä¼šé€æ¸å˜å°ï¼Œæœ€ç»ˆè¶‹è¿‘äºé›¶ã€‚ è¿™å¯¼è‡´å‰é¢å±‚çš„æƒé‡æ›´æ–°å‡ ä¹åœæ­¢ï¼Œä½¿ç½‘ç»œéš¾ä»¥è®­ç»ƒã€‚ åŸå› ï¼š åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œæ¢¯åº¦æ˜¯é€šè¿‡é“¾å¼æ³•åˆ™é€å±‚ç›¸ä¹˜çš„ã€‚å¦‚æœæŸäº›å±‚çš„æ¢¯åº¦å°äº1ï¼ˆä¾‹å¦‚å°äº1çš„æ¿€æ´»å‡½æ•°å¯¼æ•°ï¼‰ï¼Œåˆ™ä¹˜ç§¯ä¼šå¿«é€Ÿç¼©å°ã€‚ å¸¸è§çš„æ¿€æ´»å‡½æ•°å¦‚tanhå’Œsigmoidåœ¨è¾“å…¥å€¼è¾ƒå¤§æˆ–è¾ƒå°æ—¶ï¼Œå…¶å¯¼æ•°æ¥è¿‘é›¶ï¼Œä»è€ŒåŠ å‰§äº†æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ã€‚ 2. æ¢¯åº¦çˆ†ç‚¸ï¼ˆExploding Gradientï¼‰ç°è±¡ï¼š å½“æ¢¯åº¦åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­é€å±‚ä¼ é€’æ—¶ï¼Œå®ƒçš„æ•°å€¼ä¼šé€æ¸å˜å¤§ï¼Œæœ€ç»ˆå˜å¾—éå¸¸å¤§ã€‚ è¿™å¯¼è‡´å‰é¢å±‚çš„æƒé‡æ›´æ–°è¿‡å¤§ï¼Œä½¿ç½‘ç»œå‚æ•°å˜å¾—ä¸ç¨³å®šï¼Œç”šè‡³å¯¼è‡´æº¢å‡ºã€‚ åŸå› ï¼š åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæŸäº›å±‚çš„æ¢¯åº¦å¤§äº1ï¼ˆä¾‹å¦‚å¤§äº1çš„æ¿€æ´»å‡½æ•°å¯¼æ•°ï¼‰ï¼Œåˆ™ä¹˜ç§¯ä¼šå¿«é€Ÿå¢å¤§ã€‚ å¸¸è§çš„åŸå› åŒ…æ‹¬ä¸åˆç†çš„åˆå§‹åŒ–æƒé‡å’Œæœªå¤„ç†çš„æ•°å€¼ä¸ç¨³å®šé—®é¢˜ã€‚ è§£å†³æ–¹æ³• æ¢¯åº¦è£å‰ªï¼ˆGradient Clippingï¼‰ï¼š å½“æ¢¯åº¦çš„èŒƒæ•°è¶…è¿‡æŸä¸ªé˜ˆå€¼æ—¶ï¼Œå°†å…¶ç¼©æ”¾åˆ°è¯¥é˜ˆå€¼ã€‚ è¿™å¯ä»¥æœ‰æ•ˆé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸ã€‚ é•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼ˆLSTMï¼‰å’Œé—¨æ§å¾ªç¯å•å…ƒï¼ˆGRUï¼‰ï¼š è¿™äº›æ˜¯ä¸“é—¨è®¾è®¡ç”¨äºç¼“è§£æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸é—®é¢˜çš„RNNå˜ç§ã€‚ é€šè¿‡å¼•å…¥é—¨æœºåˆ¶ï¼Œå®ƒä»¬èƒ½å¤Ÿæ›´å¥½åœ°ä¿æŒé•¿æ—¶é—´ä¾èµ–ã€‚ é€‚å½“çš„æƒé‡åˆå§‹åŒ–ï¼š ä½¿ç”¨å¦‚Xavieråˆå§‹åŒ–æˆ–Heåˆå§‹åŒ–æ¥è®¾ç½®åˆå§‹æƒé‡ï¼Œå¯ä»¥å‡å°‘æ¢¯åº¦æ¶ˆå¤±å’Œçˆ†ç‚¸çš„é£é™©ã€‚ ä½¿ç”¨ä¸åŒçš„æ¿€æ´»å‡½æ•°ï¼š ReLUç­‰æ¿€æ´»å‡½æ•°åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥ç¼“è§£æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ã€‚","tags":["AI","ç¥ç»ç½‘ç»œ","Ilya sutskeverâ€˜s 30  papers"]},{"title":"ç¥ç»ç½‘ç»œï¼ˆNeural Networksï¼‰","path":"/f27811be/","content":"0. ä»€ä¹ˆæ˜¯ç¥ç»ç½‘ç»œ (Neural Networks)ç¥ç»ç½‘ç»œæ˜¯å®ç°AI çš„ä¸€ç§æŠ€æœ¯æ‰‹æ®µï¼Œä¸€ç§å¹¿æ³›ç”¨äºæœºå™¨å­¦ä¹ ï¼ˆMachine Learningï¼‰å’Œæ·±åº¦å­¦ä¹ ï¼ˆDeep Learningï¼‰é¢†åŸŸçš„è®¡ç®—æ¨¡å‹/ç®—æ³•æ¶æ„ã€‚ å®ƒå—åˆ°äººç±»å¤§è„‘ç¥ç»å…ƒï¼ˆNeuronsï¼‰å’Œå®ƒä»¬çš„äº’åŠ¨æ–¹å¼çš„å¯å‘ï¼Œå®ƒç”±å¤šä¸ªå±‚ï¼ˆLayersï¼‰ç»„æˆï¼Œæ¯å±‚åŒ…å«å¤šä¸ªç¥ç»å…ƒï¼Œè¿™äº›ç¥ç»å…ƒé€šè¿‡æƒé‡ï¼ˆWeightsï¼‰è¿æ¥ä¼ é€’ä¿¡æ¯ã€‚ ç¥ç»ç½‘ç»œçš„è®­ç»ƒè¿‡ç¨‹åŸºäºæœºå™¨å­¦ä¹ çš„åŸºæœ¬å‰æï¼Œå³èƒ½å¤Ÿä»æ•°æ®ä¸­å­¦ä¹ ã€‚é€šè¿‡å‘ç½‘ç»œæä¾›å¤§é‡çš„æ•°æ®æ ·æœ¬ï¼ˆåŒ…æ‹¬è¾“å…¥å’ŒæœŸæœ›çš„è¾“å‡ºï¼‰ï¼Œç¥ç»ç½‘ç»œå¯ä»¥å­¦ä¹ åˆ°å¦‚ä½•æ˜ å°„è¾“å…¥åˆ°è¾“å‡ºï¼Œè¿™ç§èƒ½åŠ›æ˜¯é€šè¿‡è°ƒæ•´å†…éƒ¨ç»“æ„ï¼ˆå³æƒé‡ï¼‰æ¥å®ç°çš„ã€‚ è¿™ä¸€å­¦ä¹ è¿‡ç¨‹ä½¿ç”¨äº†æœºå™¨å­¦ä¹ ä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå¦‚æŸå¤±å‡½æ•°ï¼ˆLoss Functionsï¼‰ã€æ¢¯åº¦ä¸‹é™ï¼ˆGradient Descentï¼‰å’Œåå‘ä¼ æ’­ç®—æ³•ï¼ˆBackpropagation Algorithmsï¼‰ã€‚è¿™äº›éƒ½æ˜¯æœºå™¨å­¦ä¹ é¢†åŸŸçš„åŸºæœ¬å·¥å…·ï¼Œç”¨äºè®­ç»ƒæ¨¡å‹ä»¥æ”¹è¿›å…¶æ€§èƒ½ã€‚ 1. ç¥ç»ç½‘ç»œçš„å±‚æ¬¡ç»“æ„1.1 èŠ‚ç‚¹ï¼ˆNodesï¼‰æˆ–ç¥ç»å…ƒï¼ˆNeuronsï¼‰èŠ‚ç‚¹æ˜¯ç¥ç»ç½‘ç»œçš„åŸºæœ¬å•ä½ï¼Œä¹Ÿç§°ä¸ºç¥ç»å…ƒã€‚æ¯ä¸ªèŠ‚ç‚¹æ¥æ”¶è¾“å…¥ä¿¡å·ï¼Œè¿›è¡ŒåŠ æƒæ±‚å’Œå’Œéçº¿æ€§å˜æ¢ï¼Œç„¶åå°†ç»“æœä¼ é€’ç»™ä¸‹ä¸€å±‚çš„èŠ‚ç‚¹ã€‚èŠ‚ç‚¹çš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š æ¥æ”¶è¾“å…¥ï¼šä»å‰ä¸€å±‚çš„æ‰€æœ‰èŠ‚ç‚¹æ¥æ”¶è¾“å…¥ä¿¡å·ã€‚ åŠ æƒæ±‚å’Œï¼šå¯¹æ¥æ”¶åˆ°çš„è¾“å…¥ä¿¡å·ä¹˜ä»¥ç›¸åº”çš„æƒé‡å¹¶æ±‚å’Œã€‚ åº”ç”¨æ¿€æ´»å‡½æ•°ï¼šå¯¹åŠ æƒæ±‚å’Œçš„ç»“æœåº”ç”¨æ¿€æ´»å‡½æ•°ï¼Œç”ŸæˆèŠ‚ç‚¹çš„è¾“å‡ºã€‚ ä¼ é€’è¾“å‡ºï¼šå°†è¾“å‡ºä¿¡å·ä¼ é€’ç»™ä¸‹ä¸€å±‚çš„èŠ‚ç‚¹ã€‚ 1.2 å±‚ï¼ˆLayersï¼‰å±‚æ˜¯ç”±å¤šä¸ªèŠ‚ç‚¹ç»„æˆçš„ä¸€ä¸ªé›†åˆï¼Œåœ¨ç¥ç»ç½‘ç»œä¸­èµ·ç€åˆ†å±‚å¤„ç†è¾“å…¥æ•°æ®çš„ä½œç”¨ã€‚æ¯ä¸€å±‚ä¸­çš„èŠ‚ç‚¹æ‰§è¡Œç›¸åŒç±»å‹çš„è®¡ç®—ï¼Œä½†æ¯ä¸ªèŠ‚ç‚¹æœ‰å„è‡ªçš„æƒé‡å’Œåç½®ã€‚ ä¸€ä¸ªå…¸å‹çš„ç¥ç»ç½‘ç»œç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š è¾“å…¥å±‚ï¼ˆInput Layerï¼‰ï¼šæ¥æ”¶å¤–éƒ¨è¾“å…¥æ•°æ®ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªè¾“å…¥ç‰¹å¾ã€‚ éšè—å±‚ï¼ˆHidden Layersï¼‰ï¼šä½äºè¾“å…¥å±‚å’Œè¾“å‡ºå±‚ä¹‹é—´ï¼Œç”¨äºç‰¹å¾æå–å’Œæ•°æ®å˜æ¢ã€‚ä¸€ä¸ªç¥ç»ç½‘ç»œå¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªéšè—å±‚ã€‚ è¾“å‡ºå±‚ï¼ˆOutput Layerï¼‰ï¼šç”Ÿæˆæœ€ç»ˆçš„é¢„æµ‹ç»“æœï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªè¾“å‡ºã€‚ 1.3 èŠ‚ç‚¹å’Œå±‚çš„å…³ç³»èŠ‚ç‚¹å’Œå±‚ä¹‹é—´çš„å…³ç³»å¯ä»¥æ¦‚æ‹¬å¦‚ä¸‹ï¼š å±‚æ˜¯èŠ‚ç‚¹çš„é›†åˆï¼šæ¯ä¸€å±‚ç”±å¤šä¸ªèŠ‚ç‚¹ç»„æˆï¼Œè¿™äº›èŠ‚ç‚¹åœ¨åŒä¸€å±‚å†…è¿›è¡Œç›¸åŒç±»å‹çš„è®¡ç®—ã€‚ æ•°æ®ä¼ é€’å’Œå¤„ç†ï¼šæ•°æ®åœ¨ç¥ç»ç½‘ç»œä¸­é€å±‚ä¼ é€’ï¼Œæ¯ä¸€å±‚çš„èŠ‚ç‚¹æ¥æ”¶å‰ä¸€å±‚çš„è¾“å‡ºï¼Œè¿›è¡Œè®¡ç®—åå°†ç»“æœä¼ é€’ç»™ä¸‹ä¸€å±‚çš„èŠ‚ç‚¹ã€‚ å±‚æ¬¡ç»“æ„ï¼šç¥ç»ç½‘ç»œçš„å±‚æ¬¡ç»“æ„å†³å®šäº†æ•°æ®å¤„ç†çš„é¡ºåºå’Œæ–¹å¼ã€‚è¾“å…¥æ•°æ®ç»è¿‡è¾“å…¥å±‚åï¼Œä¾æ¬¡é€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ªéšè—å±‚è¿›è¡Œå¤æ‚çš„ç‰¹å¾æå–ï¼Œæœ€ç»ˆé€šè¿‡è¾“å‡ºå±‚ç”Ÿæˆé¢„æµ‹ç»“æœã€‚ 1.4 å±‚ä¸å±‚ä¹‹é—´çš„è¿æ¥å±‚ä¸å±‚ä¹‹é—´çš„è¿æ¥ç”±æƒé‡çŸ©é˜µå†³å®šã€‚æ¯ä¸€å±‚çš„èŠ‚ç‚¹ä¸ä¸‹ä¸€å±‚çš„æ¯ä¸ªèŠ‚ç‚¹ç›¸è¿ï¼Œè¿æ¥çš„å¼ºåº¦ç”±æƒé‡å€¼å†³å®šã€‚åœ¨å‰å‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œè¾“å…¥å±‚çš„èŠ‚ç‚¹å°†è¾“å…¥æ•°æ®ä¼ é€’ç»™ç¬¬ä¸€ä¸ªéšè—å±‚çš„èŠ‚ç‚¹ï¼Œåè€…å†å°†å¤„ç†åçš„æ•°æ®ä¼ é€’ç»™ä¸‹ä¸€ä¸ªéšè—å±‚ï¼Œä¾æ­¤ç±»æ¨ï¼Œç›´åˆ°è¾“å‡ºå±‚ã€‚ 2. æƒé‡æƒé‡æ˜¯è¿æ¥ç¥ç»ç½‘ç»œä¸­ä¸åŒå±‚èŠ‚ç‚¹çš„å‚æ•°ï¼Œç”¨äºè°ƒèŠ‚è¾“å…¥ä¿¡å·åœ¨ç½‘ç»œä¸­çš„ä¼ é€’å’Œå˜æ¢å¼ºåº¦ã€‚æ¯ä¸ªè¿æ¥éƒ½æœ‰ä¸€ä¸ªæƒé‡ï¼Œè¡¨ç¤ºè¾“å…¥ä¿¡å·å¯¹è¾“å‡ºä¿¡å·çš„å½±å“åŠ›ã€‚ è°ƒèŠ‚ä¿¡å·å¼ºåº¦ï¼šæƒé‡ä¹˜ä»¥è¾“å…¥ä¿¡å·åï¼Œå†é€šè¿‡æ±‚å’Œå’Œæ¿€æ´»å‡½æ•°çš„å˜æ¢ï¼Œå†³å®šäº†è¾“å‡ºä¿¡å·çš„å€¼ã€‚ä¸åŒçš„æƒé‡å€¼ä»£è¡¨è¾“å…¥ä¿¡å·çš„é‡è¦ç¨‹åº¦ã€‚ ç‰¹å¾å­¦ä¹ ï¼šé€šè¿‡å­¦ä¹ å’Œè°ƒæ•´æƒé‡ï¼Œç¥ç»ç½‘ç»œèƒ½å¤Ÿè¯†åˆ«å’Œæå–è¾“å…¥æ•°æ®ä¸­çš„é‡è¦ç‰¹å¾ã€‚ ä¼˜åŒ–ï¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæƒé‡è¢«è°ƒæ•´ä»¥æœ€å°åŒ–é¢„æµ‹è¯¯å·®ã€‚é€šè¿‡åå‘ä¼ æ’­ç®—æ³•ï¼Œæƒé‡çš„å€¼ä¸æ–­æ›´æ–°ï¼Œä½¿å¾—æ¨¡å‹çš„é¢„æµ‹æ›´åŠ å‡†ç¡®ã€‚ 2.1 æƒé‡çš„å­˜åœ¨å½¢å¼æƒé‡å¹¶ä¸å­˜åœ¨äºå•ç‹¬çš„èŠ‚ç‚¹å†…ï¼Œè€Œæ˜¯å­˜åœ¨äºèŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥ä¸Šã€‚å…·ä½“æ¥è¯´ï¼Œæ¯ä¸€å±‚çš„èŠ‚ç‚¹ä¸ä¸‹ä¸€å±‚çš„èŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥ç”±ä¸€ç»„æƒé‡å‚æ•°è¡¨ç¤ºã€‚æƒé‡çŸ©é˜µè¡¨ç¤ºäº†ä¸¤ä¸ªå±‚ä¹‹é—´æ‰€æœ‰èŠ‚ç‚¹è¿æ¥çš„æƒé‡å€¼ã€‚ 2.2 æƒé‡çš„åˆå§‹åŒ–å’Œè°ƒæ•´æƒé‡çš„åˆå§‹åŒ–æ–¹æ³•æœ‰å¤šç§ï¼ŒåŒ…æ‹¬é›¶åˆå§‹åŒ–ã€éšæœºåˆå§‹åŒ–ã€Xavieråˆå§‹åŒ–å’ŒHeåˆå§‹åŒ–ç­‰ã€‚è¿™äº›æ–¹æ³•æ—¨åœ¨ä¸ºæ¨¡å‹æä¾›ä¸€ä¸ªè‰¯å¥½çš„èµ·ç‚¹ï¼Œä»¥ä¾¿æ›´å¥½åœ°è¿›è¡Œè®­ç»ƒã€‚ 2.3 æƒé‡çš„è®­ç»ƒè°ƒæ•´åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæƒé‡é€šè¿‡ä¼˜åŒ–ç®—æ³•è¿›è¡Œè°ƒæ•´ã€‚æœ€å¸¸ç”¨çš„ä¼˜åŒ–ç®—æ³•æ˜¯æ¢¯åº¦ä¸‹é™ï¼ˆGradient Descentï¼‰åŠå…¶å˜ç§ï¼ˆå¦‚éšæœºæ¢¯åº¦ä¸‹é™ã€Adamä¼˜åŒ–ç®—æ³•ç­‰ï¼‰ã€‚è®­ç»ƒæ­¥éª¤å¦‚ä¸‹ï¼š å‰å‘ä¼ æ’­ï¼šè®¡ç®—ç½‘ç»œçš„é¢„æµ‹è¾“å‡ºã€‚ è®¡ç®—æŸå¤±ï¼šé€šè¿‡æŸå¤±å‡½æ•°è¡¡é‡é¢„æµ‹è¾“å‡ºä¸çœŸå®æ ‡ç­¾ä¹‹é—´çš„å·®è·ã€‚ åå‘ä¼ æ’­ï¼šè®¡ç®—æŸå¤±å‡½æ•°å¯¹æ¯ä¸ªæƒé‡çš„æ¢¯åº¦ã€‚ æ›´æ–°æƒé‡ï¼šä½¿ç”¨æ¢¯åº¦ä¸‹é™æ³•æ›´æ–°æƒé‡ï¼Œä»¥æœ€å°åŒ–æŸå¤±å‡½æ•°ã€‚ 2.4 ä¼˜åŒ–ç®—æ³•ä¸ºäº†æé«˜è®­ç»ƒæ•ˆç‡å’Œç¨³å®šæ€§ï¼Œå¯ä»¥ä½¿ç”¨å„ç§ä¼˜åŒ–ç®—æ³•ï¼ŒåŒ…æ‹¬ï¼š åŠ¨é‡ï¼ˆMomentumï¼‰ï¼šç»“åˆå½“å‰æ¢¯åº¦å’Œä¹‹å‰æ›´æ–°çš„æ–¹å‘ï¼ŒåŠ é€Ÿæ”¶æ•›ã€‚ AdaGradï¼šæ ¹æ®è¿‡å»çš„æ¢¯åº¦è°ƒæ•´å­¦ä¹ ç‡ï¼Œé€‚åº”æ€§åœ°è¿›è¡Œå‚æ•°æ›´æ–°ã€‚ RMSPropï¼šæ”¹è¿›AdaGradï¼Œä½¿ç”¨æŒ‡æ•°åŠ æƒå¹³å‡è®¡ç®—æ¢¯åº¦å¹³æ–¹å’Œï¼Œé¿å…å­¦ä¹ ç‡è¿‡å¿«å‡å°ã€‚ Adamï¼šç»“åˆåŠ¨é‡å’ŒRMSPropçš„ä¼˜ç‚¹ï¼Œé€‚åº”æ€§åœ°è°ƒæ•´å­¦ä¹ ç‡å’ŒåŠ¨é‡ï¼Œå¹¿æ³›åº”ç”¨äºå„ç§ç¥ç»ç½‘ç»œè®­ç»ƒã€‚ 2.5 æƒé‡åœ¨ä¸åŒç±»å‹ç¥ç»ç½‘ç»œä¸­çš„è§’è‰²ä¸åŒç±»å‹çš„ç¥ç»ç½‘ç»œä¸­ï¼Œæƒé‡çš„å…·ä½“ä½œç”¨å¯èƒ½æœ‰æ‰€ä¸åŒï¼š å‰é¦ˆç¥ç»ç½‘ç»œï¼ˆFeedforward Neural Networks, FNNsï¼‰ï¼šæƒé‡è¿æ¥æ¯ä¸€å±‚çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œè´Ÿè´£å°†è¾“å…¥æ•°æ®é€å±‚ä¼ é€’å’Œå˜æ¢ã€‚ å·ç§¯ç¥ç»ç½‘ç»œï¼ˆConvolutional Neural Networks, CNNsï¼‰ï¼šæƒé‡æ˜¯å·ç§¯æ ¸çš„å‚æ•°ï¼Œè´Ÿè´£åœ¨å±€éƒ¨æ„ŸçŸ¥é‡ä¸Šæå–ç‰¹å¾ã€‚ é€’å½’ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Networks, RNNsï¼‰ï¼šæƒé‡ç”¨äºå¤„ç†åºåˆ—æ•°æ®ï¼ŒåŒ…æ‹¬å½“å‰æ—¶é—´æ­¥çš„è¾“å…¥ä¸å‰ä¸€æ—¶é—´æ­¥çš„éšè—çŠ¶æ€ä¹‹é—´çš„å…³ç³»ã€‚ 3. åç½®ï¼ˆBiasesï¼‰åç½®æ˜¯æ¯ä¸ªèŠ‚ç‚¹é™„åŠ çš„ä¸€ä¸ªå‚æ•°ï¼Œç”¨äºè°ƒæ•´èŠ‚ç‚¹çš„è¾“å‡ºç‹¬ç«‹äºè¾“å…¥ä¿¡å·ã€‚åç½®å¸®åŠ©ç¥ç»ç½‘ç»œå­¦åˆ°æ›´çµæ´»çš„å†³ç­–è¾¹ç•Œã€‚ ä½œç”¨ è°ƒèŠ‚è¾“å‡ºï¼šåç½®æä¾›ä¸€ä¸ªé¢å¤–çš„è‡ªç”±åº¦ï¼Œä½¿å¾—ç¥ç»ç½‘ç»œèƒ½å¤Ÿæ›´å¥½åœ°æ‹Ÿåˆæ•°æ®ã€‚ é¿å…é›¶è¾“å‡ºï¼šåœ¨è¾“å…¥ä¿¡å·ä¸ºé›¶çš„æƒ…å†µä¸‹ï¼Œåç½®ç¡®ä¿èŠ‚ç‚¹ä»ç„¶èƒ½å¤Ÿäº§ç”Ÿéé›¶è¾“å‡ºã€‚ 4. æ¿€æ´»å‡½æ•°ï¼ˆActivation Functionï¼‰æ¿€æ´»å‡½æ•°ï¼ˆActivation Functionï¼‰æ˜¯ç¥ç»ç½‘ç»œä¸­çš„ä¸€ä¸ªå…³é”®ç»„ä»¶ï¼Œå®ƒå¼•å…¥äº†éçº¿æ€§å˜æ¢ï¼Œä½¿å¾—ç¥ç»ç½‘ç»œèƒ½å¤Ÿå­¦ä¹ å’Œè¡¨ç¤ºå¤æ‚çš„éçº¿æ€§å…³ç³»ã€‚å¦‚æœæ²¡æœ‰æ¿€æ´»å‡½æ•°ï¼Œç¥ç»ç½‘ç»œçš„æ¯ä¸€å±‚åªè¿›è¡Œçº¿æ€§å˜æ¢ï¼Œé‚£ä¹ˆæ— è®ºå¤šå°‘å±‚çš„å †å ï¼Œæ•´ä½“ä»ç„¶æ˜¯ä¸€ä¸ªçº¿æ€§å˜æ¢ã€‚è¿™å°†æå¤§é™åˆ¶ç¥ç»ç½‘ç»œçš„è¡¨ç¤ºèƒ½åŠ›ã€‚å› æ­¤ï¼Œæ¿€æ´»å‡½æ•°å¯¹äºç¥ç»ç½‘ç»œçš„æ€§èƒ½å’Œèƒ½åŠ›è‡³å…³é‡è¦ã€‚ çº¿æ€§ï¼ˆLinearï¼‰å’Œéçº¿æ€§ï¼ˆNonlinearï¼‰æ˜¯æ•°å­¦å’Œä¿¡å·å¤„ç†ä¸­ä¸¤ä¸ªåŸºæœ¬çš„æ¦‚å¿µï¼Œè¿™äº›æ¦‚å¿µåœ¨ç¥ç»ç½‘ç»œå’Œæœºå™¨å­¦ä¹ ä¸­ä¹Ÿå…·æœ‰é‡è¦æ„ä¹‰ã€‚ç†è§£è¿™ä¸¤ä¸ªæ¦‚å¿µæœ‰åŠ©äºæŒæ¡ä¸ºä»€ä¹ˆæ¿€æ´»å‡½æ•°å¯¹ç¥ç»ç½‘ç»œçš„æ€§èƒ½å¦‚æ­¤é‡è¦ã€‚ 4.1 çº¿æ€§ï¼ˆLinearï¼‰vs éçº¿æ€§ï¼ˆNonlinearï¼‰4.1.1 çº¿æ€§ï¼ˆLinearï¼‰çº¿æ€§å…³ç³»æ˜¯æŒ‡ä¸¤ä¸ªå˜é‡ä¹‹é—´çš„å…³ç³»å¯ä»¥ç”¨ä¸€ä¸ªçº¿æ€§æ–¹ç¨‹è¡¨ç¤ºã€‚å¯¹äºä¸€ä¸ªå˜é‡ $x$ å’Œå…¶å¯¹åº”çš„è¾“å‡º $y$ï¼Œçº¿æ€§å…³ç³»å¯ä»¥è¡¨ç¤ºä¸ºï¼š$y = mx + b$å…¶ä¸­ï¼Œ$m$ æ˜¯æ–œç‡ï¼Œ$b$ æ˜¯æˆªè·ã€‚è¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬ç»˜åˆ¶ $y$ å¯¹ $x$ çš„å›¾åƒï¼Œå®ƒå°†æ˜¯ä¸€æ¡ç›´çº¿ã€‚ ç‰¹ç‚¹ å åŠ æ€§ï¼šçº¿æ€§ç³»ç»Ÿæ»¡è¶³å åŠ åŸç†ï¼Œå³è¾“å…¥çš„çº¿æ€§ç»„åˆä¼šäº§ç”Ÿè¾“å‡ºçš„çº¿æ€§ç»„åˆã€‚å¦‚æœ $f(x_1) = y_1$â€‹ å’Œ$f(x_2) = y_2$ï¼Œé‚£ä¹ˆå¯¹äºä»»ä½•å¸¸æ•° $a$å’Œ $b$ï¼Œæœ‰ $f(ax_1 + bx_2) = ay_1 + by_2$â€‹ã€‚ åŒè´¨æ€§ï¼šçº¿æ€§ç³»ç»Ÿæ»¡è¶³åŒè´¨æ€§ï¼Œå³è¾“å…¥çš„æ”¾å¤§ä¼šå¯¼è‡´è¾“å‡ºçš„ç›¸åº”æ”¾å¤§ã€‚å¦‚æœ $f(x) = y$ï¼Œé‚£ä¹ˆå¯¹äºä»»ä½•å¸¸æ•° $k$ï¼Œæœ‰ $f(kx) = ky$ã€‚ åœ¨ç¥ç»ç½‘ç»œä¸­çš„åº”ç”¨åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œçº¿æ€§å˜æ¢é€šå¸¸é€šè¿‡çŸ©é˜µä¹˜æ³•å’ŒåŠ æ³•å®ç°ï¼Œä¾‹å¦‚è¾“å…¥ä¸æƒé‡çŸ©é˜µçš„ä¹˜ç§¯åŠ ä¸Šåç½®ï¼š$z = W \\cdot x + b$ 4.1.2 éçº¿æ€§ï¼ˆNonlinearï¼‰éçº¿æ€§å…³ç³»æ˜¯æŒ‡ä¸¤ä¸ªå˜é‡ä¹‹é—´çš„å…³ç³»ä¸èƒ½ç”¨ä¸€ä¸ªç®€å•çš„çº¿æ€§æ–¹ç¨‹è¡¨ç¤ºã€‚éçº¿æ€§å…³ç³»çš„æ•°å­¦è¡¨ç¤ºå½¢å¼å¯ä»¥éå¸¸å¤šæ ·ï¼Œå¸¸è§çš„å½¢å¼åŒ…æ‹¬å¤šé¡¹å¼ã€æŒ‡æ•°å‡½æ•°ã€å¯¹æ•°å‡½æ•°ã€ä¸‰è§’å‡½æ•°ç­‰ã€‚ä¾‹å¦‚ï¼Œå¯¹äºå˜é‡ $x$ å’Œ $y$ï¼Œéçº¿æ€§å…³ç³»å¯ä»¥è¡¨ç¤ºä¸ºï¼š$y=ax^2+bx+c$å…¶ä¸­ï¼Œ$a$ã€$b$ã€$c$ æ˜¯å¸¸æ•°ã€‚è¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬ç»˜åˆ¶ $y$ å¯¹ $x$ çš„å›¾åƒï¼Œå®ƒå°†ä¸æ˜¯ä¸€æ¡ç›´çº¿ï¼Œè€Œæ˜¯ä¸€ä¸ªæ›²çº¿ã€‚ç‰¹ç‚¹ éå åŠ æ€§ï¼šéçº¿æ€§ç³»ç»Ÿä¸æ»¡è¶³å åŠ åŸç†ã€‚å¦‚æœ $f(x_1) = y_1â€‹$ å’Œ $f(x_2) = y_2â€‹$ï¼Œé‚£ä¹ˆ $f(ax_1 + bx_2) eq ay_1 + by_2$â€‹ã€‚ å¤æ‚æ€§ï¼šéçº¿æ€§ç³»ç»Ÿå¯ä»¥è¡¨ç¤ºå¤æ‚çš„å…³ç³»å’Œæ¨¡å¼ï¼Œèƒ½å¤Ÿæ•æ‰åˆ°æ•°æ®ä¸­çš„å¤æ‚ç»“æ„å’ŒåŠ¨æ€ã€‚ ä¸ºä»€ä¹ˆéœ€è¦éçº¿æ€§å¦‚æœç¥ç»ç½‘ç»œåªä½¿ç”¨çº¿æ€§æ¿€æ´»å‡½æ•°ï¼ˆä¾‹å¦‚ï¼Œæ’ç­‰å‡½æ•° f(z)=zï¼‰ï¼Œé‚£ä¹ˆæ— è®ºç½‘ç»œæœ‰å¤šå°‘å±‚ï¼Œå…¶æœ€ç»ˆè¾“å‡ºä»ç„¶æ˜¯è¾“å…¥çš„çº¿æ€§å˜æ¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ•´ä¸ªç½‘ç»œç­‰æ•ˆäºä¸€ä¸ªå•å±‚çš„çº¿æ€§æ¨¡å‹ï¼Œæ— æ³•æ•æ‰æ•°æ®ä¸­çš„å¤æ‚å…³ç³»ã€‚å› æ­¤ï¼Œå¼•å…¥éçº¿æ€§æ¿€æ´»å‡½æ•°ä½¿å¾—ç½‘ç»œå…·æœ‰æ›´å¼ºçš„è¡¨è¾¾èƒ½åŠ›ï¼Œèƒ½å¤Ÿå­¦ä¹ å’Œè¡¨ç¤ºå¤æ‚çš„éçº¿æ€§å…³ç³»ï¼Œä»è€Œè§£å†³æ›´å¤æ‚çš„é—®é¢˜ã€‚ 4.2 å¸¸è§çš„éçº¿æ€§æ¿€æ´»å‡½æ•°4.2.1 Sigmoid å‡½æ•°$Ïƒ(z)=\\frac{1}{1+e^{âˆ’z}} â€‹$ ç‰¹ç‚¹ï¼š è¾“å‡ºå€¼åœ¨0åˆ°1ä¹‹é—´ï¼Œé€‚ç”¨äºæ¦‚ç‡é¢„æµ‹ã€‚ åœ¨æå€¼åŒºé—´æ¢¯åº¦è¾ƒå°ï¼Œå¯èƒ½å¯¼è‡´æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ã€‚ è®¡ç®—å¤æ‚åº¦è¾ƒé«˜ã€‚ åº”ç”¨ï¼š å¸¸ç”¨äºäºŒåˆ†ç±»é—®é¢˜çš„è¾“å‡ºå±‚ã€‚ 4.2.2 Tanhï¼ˆåŒæ›²æ­£åˆ‡ï¼‰å‡½æ•°$tanh(z)=\\frac{e^z-e^{-z}}{e^z+e^{-z}}$â€‹ç‰¹ç‚¹ï¼š è¾“å‡ºå€¼åœ¨-1åˆ°1ä¹‹é—´ã€‚ ç›¸å¯¹äºSigmoidå‡½æ•°ï¼ŒTanhå‡½æ•°çš„è¾“å‡ºå‡å€¼ä¸º0ï¼Œä½¿å¾—æ•°æ®æ›´ä¸­å¿ƒåŒ–ã€‚ ä¹Ÿå­˜åœ¨æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œä½†åœ¨0é™„è¿‘çš„æ¢¯åº¦è¾ƒå¤§ï¼Œæ¢¯åº¦æ¶ˆå¤±é—®é¢˜ç¨å¥½äºSigmoidã€‚ åº”ç”¨ï¼š å¸¸ç”¨äºéšè—å±‚ã€‚4.2.3 ReLUï¼ˆRectified Linear Unitï¼‰å‡½æ•°$ReLU(z)=max(0,z)$ ç‰¹ç‚¹ï¼š è®¡ç®—ç®€å•ï¼Œæ”¶æ•›é€Ÿåº¦å¿«ã€‚ åœ¨æ­£åŒºé—´ä¿æŒçº¿æ€§å…³ç³»ï¼Œåœ¨è´ŸåŒºé—´è¾“å‡ºä¸º0ã€‚ è§£å†³äº†Sigmoidå’ŒTanhçš„æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ã€‚ å¯èƒ½å¯¼è‡´éƒ¨åˆ†ç¥ç»å…ƒâ€œæ­»äº¡â€ï¼Œå³åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æŸäº›ç¥ç»å…ƒçš„è¾“å‡ºå§‹ç»ˆä¸º0ï¼Œä¸å†æ›´æ–°ã€‚ åº”ç”¨ï¼š å¹¿æ³›ç”¨äºéšè—å±‚ã€‚4.2.4 Leaky ReLU å‡½æ•°$Leaky ReLU(z)=max(Î±z,z)$ ç‰¹ç‚¹ï¼š è§£å†³äº†ReLUçš„â€œæ­»äº¡ç¥ç»å…ƒâ€é—®é¢˜ã€‚ åœ¨è´ŸåŒºé—´ç»™å®šä¸€ä¸ªå¾ˆå°çš„æ–œç‡ï¼ˆé€šå¸¸ä¸º0.01ï¼‰ã€‚ åº”ç”¨ï¼š æ›¿ä»£ReLUï¼Œåœ¨éšè—å±‚ä¸­ä½¿ç”¨4.2.5 Softmax å‡½æ•°$Softmax(z_iâ€‹)=\\frac{e^z_i}{âˆ‘_jâ€‹â€‹e^z_j} â€‹$ ç‰¹ç‚¹ï¼š å°†è¾“å‡ºå€¼è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒï¼Œæ€»å’Œä¸º1ã€‚ é€‚ç”¨äºå¤šåˆ†ç±»é—®é¢˜ã€‚ åº”ç”¨ï¼š å¸¸ç”¨äºå¤šåˆ†ç±»é—®é¢˜çš„è¾“å‡ºå±‚ã€‚4.2.6 Swish å‡½æ•°$Swish(z)=zâ‹…Ïƒ(z)=\\frac{z}{1+e^{âˆ’z}} â€‹â€‹$ ç‰¹ç‚¹ï¼š å¹³æ»‘çš„éçº¿æ€§å‡½æ•°ï¼Œæ€§èƒ½ä¼˜äºReLUå’ŒSigmoidã€‚ ç”±Googleæå‡ºï¼Œç»“åˆäº†ReLUå’ŒSigmoidçš„ç‰¹ç‚¹ã€‚ åº”ç”¨ï¼š æ–°å‹æ¿€æ´»å‡½æ•°ï¼Œåœ¨ä¸€äº›æ·±åº¦å­¦ä¹ æ¨¡å‹ä¸­è¡¨ç°å‡ºè‰²ã€‚ 4.3 æ¿€æ´»å‡½æ•°çš„é€‰æ‹©æ¿€æ´»å‡½æ•°çš„é€‰æ‹©å¯¹äºç¥ç»ç½‘ç»œçš„è®­ç»ƒå’Œæ€§èƒ½æœ‰é‡è¦å½±å“ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„é€‰æ‹©å‡†åˆ™ï¼š éšè—å±‚ï¼šé€šå¸¸ä½¿ç”¨ReLUæˆ–å…¶å˜ç§ï¼ˆå¦‚Leaky ReLUã€Swishï¼‰ï¼Œå› ä¸ºå®ƒä»¬è®¡ç®—ç®€å•ä¸”èƒ½æœ‰æ•ˆç¼“è§£æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ã€‚ è¾“å‡ºå±‚ï¼š å›å½’é—®é¢˜ï¼šä½¿ç”¨çº¿æ€§æ¿€æ´»å‡½æ•°ã€‚ äºŒåˆ†ç±»é—®é¢˜ï¼šä½¿ç”¨Sigmoidå‡½æ•°ã€‚ å¤šåˆ†ç±»é—®é¢˜ï¼šä½¿ç”¨Softmaxå‡½æ•° 5.è®­ç»ƒè¿‡ç¨‹å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œï¼ŒåŒ…å«ä¸€ä¸ªè¾“å…¥å±‚ã€ä¸€ä¸ªéšè—å±‚å’Œä¸€ä¸ªè¾“å‡ºå±‚ï¼š è¾“å…¥å±‚**ï¼š2ä¸ªèŠ‚ç‚¹ï¼Œè¡¨ç¤ºè¾“å…¥ç‰¹å¾ $x_1$ å’Œ $x_2â€‹$ã€‚ éšè—å±‚ï¼š2ä¸ªèŠ‚ç‚¹ï¼Œè¡¨ç¤ºéšè—çŠ¶æ€ $h_1$ å’Œ $h_2$â€‹ï¼Œåç½®å‘é‡åˆ†åˆ«ä¸º$b_1$ã€$b_2$,ä½¿ç”¨ReLUæ¿€æ´»å‡½æ•°ã€‚ è¾“å‡ºå±‚ï¼š1ä¸ªèŠ‚ç‚¹ï¼Œè¡¨ç¤ºè¾“å‡º $y$ï¼Œåç½®å‘é‡åˆ†åˆ«ä¸º$b_3$,ä½¿ç”¨çº¿æ€§æ¿€æ´»å‡½æ•°ã€‚ æƒé‡çŸ©é˜µ è¾“å…¥å±‚åˆ°éšè—å±‚çš„æƒé‡ï¼šå‡è®¾æƒé‡ä¸º $W^{(1)} = \\begin{bmatrix} W_{11} &amp; W_{12} \\ W_{21} &amp; W_{22} \\end{bmatrix}$,å…¶ä¸­ $W_{11}â€‹$ã€$W_{12}$â€‹ è¿æ¥ $x_1$â€‹ åˆ° $h_1$â€‹ å’Œ $h_2$â€‹ï¼Œ$W_{21}â€‹$ã€$W_{22}$â€‹ è¿æ¥ $x_2$â€‹ åˆ° $h_1$â€‹ å’Œ $h_2â€‹$ã€‚ éšè—å±‚åˆ°è¾“å‡ºå±‚çš„æƒé‡ï¼šå‡è®¾æƒé‡ä¸º $W^{(2)} = \\begin{bmatrix} W_{31} &amp; W_{32} \\end{bmatrix}$ $W_{31}$â€‹ å’Œ $W_{32}$åˆ†åˆ«è¿æ¥$h_1$ å’Œ$h_2â€‹$åˆ° $y$ã€‚å…¶ä¸­ $W_{31}$ã€$W_{32}$åˆ†åˆ«è¿æ¥ $h_1$å’Œ $h_2$åˆ° $y$ å¦‚æœæŒ‡å®šå…·ä½“æ•°æ®ï¼Œå¯ä»¥è®¾ç½®ä¸º è¾“å…¥æ•°æ®ä¸º$\\mathbf{X} = [0.5, 0.6]$ éšè—å±‚æƒé‡çŸ©é˜µ $\\mathbf{W}^{(1)} = \\begin{bmatrix} 0.1 &amp; 0.2 \\ 0.3 &amp; 0.4 \\end{bmatrix}$ éšè—å±‚åç½®å‘é‡ $\\mathbf{b}^{(1)} = \\begin{bmatrix} 0.1 \\ 0.2 \\end{bmatrix}$ è¾“å‡ºå±‚æƒé‡çŸ©é˜µ $\\mathbf{W}^{(2)} = \\begin{bmatrix} 0.5 &amp; 0.6 \\end{bmatrix}$ è¾“å‡ºå±‚åç½®å‘é‡$\\mathbf{b}^{(2)} = \\begin{bmatrix} 0.3 \\end{bmatrix}$ åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œé€šè¿‡è°ƒæ•´æƒé‡å’Œåç½®ï¼Œä½¿å¾—æ¨¡å‹çš„é¢„æµ‹ç»“æœå°½å¯èƒ½å‡†ç¡®ã€‚ä»¥ä¸‹çš„ä¸»è¦æ­¥éª¤. 5.1 å‰å‘ä¼ æ’­ï¼ˆForward Propagationï¼‰å‰å‘ä¼ æ’­æ˜¯æ•°æ®ä»è¾“å…¥å±‚ç»è¿‡éšè—å±‚ä¼ é€’åˆ°è¾“å‡ºå±‚çš„è¿‡ç¨‹ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€å±‚çš„èŠ‚ç‚¹æ¥æ”¶å‰ä¸€å±‚çš„è¾“å‡ºï¼Œè¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¹¶é€šè¿‡æ¿€æ´»å‡½æ•°ç”Ÿæˆè¾“å‡ºã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š åŠ æƒæ±‚å’Œï¼šæ¯ä¸ªèŠ‚ç‚¹æ¥æ”¶å‰ä¸€å±‚æ‰€æœ‰èŠ‚ç‚¹çš„è¾“å‡ºï¼Œè®¡ç®—åŠ æƒå’Œã€‚ $z_i = \\sum_{j} w_{ij} x_j + b_i$â€‹ å…¶ä¸­ï¼Œ$z_i$ æ˜¯ç¬¬ $i$ ä¸ªèŠ‚ç‚¹çš„åŠ æƒå’Œï¼Œ$w_{ij}$ æ˜¯ä»ç¬¬ $j$ ä¸ªè¾“å…¥åˆ°ç¬¬ $i$ ä¸ªèŠ‚ç‚¹çš„æƒé‡ï¼Œ$x_j$æ˜¯ç¬¬ $j$ ä¸ªè¾“å…¥ï¼Œ$b_i$â€‹ æ˜¯åç½®ã€‚ æ¿€æ´»å‡½æ•°ï¼šå¯¹åŠ æƒå’Œåº”ç”¨æ¿€æ´»å‡½æ•°ï¼Œç”ŸæˆèŠ‚ç‚¹çš„è¾“å‡ºã€‚ $a_i = f(z_i)$å¸¸ç”¨çš„æ¿€æ´»å‡½æ•°åŒ…æ‹¬Sigmoidã€Tanhå’ŒReLUã€‚5.1.1 è¾“å…¥å±‚è¾“å…¥å±‚æ¥æ”¶å¤–éƒ¨æ•°æ®ï¼Œå°†å…¶ä¼ é€’ç»™ç¬¬ä¸€ä¸ªéšè—å±‚ã€‚å‡è®¾è¾“å…¥æ•°æ®ä¸º $\\mathbf{X} = [x_1, x_2]$5.1.2 éšè—å±‚ è®¡ç®—éšè—å±‚çš„è¾“å…¥åŠ æƒå’Œï¼š$z_1^{(1)} = w_{11}x_1 + w_{12}x_2 + b_1$ $z_2^{(1)} = w_{21}x_1 + w_{22}x_2 + b_2$ ä»£å…¥å…·ä½“æ•°æ®ï¼š$z^{(1)} = \\mathbf{W}^{(1)} \\mathbf{X} + \\mathbf{b}^{(1)} = \\begin{bmatrix} 0.1 &amp; 0.2 \\ 0.3 &amp; 0.4 \\end{bmatrix} \\begin{bmatrix} 0.5 \\ 0.6 \\end{bmatrix} + \\begin{bmatrix} 0.1 \\ 0.2 \\end{bmatrix} = \\begin{bmatrix} 0.1 \\cdot 0.5 + 0.2 \\cdot 0.6 + 0.1 \\ 0.3 \\cdot 0.5 + 0.4 \\cdot 0.6 + 0.2 \\end{bmatrix} = \\begin{bmatrix} 0.27 \\ 0.62 \\end{bmatrix}$ åº”ç”¨æ¿€æ´»å‡½æ•°ï¼Œè®¡ç®—éšè—å±‚çš„è¾“å‡ºï¼š$h_1 = \\text{ReLU}(z_1^{(1)})$ $h_2 = \\text{ReLU}(z_2^{(1)})$ $h^&#123;(1)&#125; = \\text&#123;ReLU&#125;(z^&#123;(1)&#125;) = \\begin&#123;bmatrix&#125; \\max(0, 0.27) \\\\ \\max(0, 0.62) \\end&#123;bmatrix&#125; = \\begin&#123;bmatrix&#125; 0.27 \\\\ 0.62 \\end&#123;bmatrix&#125;$ 5.1.3 è¾“å‡ºå±‚ è®¡ç®—è¾“å‡ºå±‚çš„è¾“å…¥åŠ æƒå’Œï¼š$z^{(2)} = w_{31}h_1 + w_{32}h_2 + b_3$$z^{(2)} = \\mathbf{W}^{(2)} a^{(1)} + \\mathbf{b}^{(2)} = \\begin{bmatrix} 0.5 &amp; 0.6 \\end{bmatrix} \\begin{bmatrix} 0.27 \\ 0.62 \\end{bmatrix} + \\begin{bmatrix} 0.3 \\end{bmatrix} = 0.5 \\cdot 0.27 + 0.6 \\cdot 0.62 + 0.3 = 0.735$ åº”ç”¨æ¿€æ´»å‡½æ•°ï¼Œè®¡ç®—æœ€ç»ˆè¾“å‡ºï¼š$y = z^{(2)}$å‡è®¾è¾“å‡ºå±‚ä½¿ç”¨çº¿æ€§æ¿€æ´»å‡½æ•°ï¼ˆå³ä¸åšéçº¿æ€§å˜æ¢ï¼‰$y = z^{(2)} = 0.735$ 5.2 è®¡ç®—æŸå¤±ï¼ˆLoss Calculationï¼‰ä½¿ç”¨æŸå¤±å‡½æ•°è®¡ç®—é¢„æµ‹è¾“å‡ºä¸çœŸå®æ ‡ç­¾ä¹‹é—´çš„å·®å¼‚ã€‚æŸå¤±å‡½æ•°æ˜¯ä¸€ä¸ªè¡¡é‡æ¨¡å‹é¢„æµ‹è¯¯å·®çš„æŒ‡æ ‡ï¼Œå¸¸è§çš„æŸå¤±å‡½æ•°åŒ…æ‹¬å‡æ–¹è¯¯å·®ï¼ˆMSEï¼‰å’Œäº¤å‰ç†µæŸå¤±ã€‚ å‡æ–¹è¯¯å·®ï¼ˆMSE, Mean Squared Errorï¼‰ï¼šç”¨äºå›å½’é—®é¢˜ã€‚ $\\text{MSE} = \\frac{1}{N} \\sum_{i=1}^N (y_i - \\hat{y}_i)^2$ äº¤å‰ç†µæŸå¤±ï¼ˆCross-Entropy Lossï¼‰ï¼šç”¨äºåˆ†ç±»é—®é¢˜ã€‚ $\\text{Cross-Entropy} = -\\sum_{i=1}^N y_i \\log(\\hat{y}_i)$ 5.3 åå‘ä¼ æ’­ï¼ˆBackpropagationï¼‰åå‘ä¼ æ’­ç®—æ³•é€šè¿‡è®¡ç®—æŸå¤±å‡½æ•°å¯¹æ¯ä¸ªæ¨¡å‹å‚æ•°ï¼ˆæƒé‡å’Œåç½®ï¼‰çš„åå¯¼æ•°/æ¢¯åº¦ï¼Œæ¥æŒ‡å¯¼å‚æ•°æ›´æ–°ï¼Œä½¿å¾—æŸå¤±å‡½æ•°é€æ­¥å‡å°ï¼Œä»è€Œæé«˜æ¨¡å‹çš„å‡†ç¡®æ€§ã€‚ è®¡ç®—æ¢¯åº¦ï¼šé¦–å…ˆè®¡ç®—è¾“å‡ºå±‚èŠ‚ç‚¹çš„æŸå¤±æ¢¯åº¦ï¼Œå³æŸå¤±å‡½æ•°å¯¹è¾“å‡ºå±‚æ¯ä¸ªèŠ‚ç‚¹è¾“å‡ºçš„åå¯¼æ•°ã€‚ç„¶åé€šè¿‡é“¾å¼æ³•åˆ™ï¼Œä¾æ¬¡è®¡ç®—æ¯ä¸ªéšè—å±‚èŠ‚ç‚¹çš„æ¢¯åº¦ã€‚æ¢¯åº¦ç”±åä¸€å±‚èŠ‚ç‚¹çš„æ¢¯åº¦å’Œå½“å‰å±‚èŠ‚ç‚¹çš„è¾“å‡ºå€¼å…±åŒå†³å®šã€‚ ä¼ æ’­è¯¯å·®ï¼šè¯¯å·®ä»è¾“å‡ºå±‚é€å±‚ä¼ æ’­å›è¾“å…¥å±‚ï¼Œè®¡ç®—æ¯ä¸ªå‚æ•°çš„æ¢¯åº¦ã€‚ âˆ‚ æ˜¯åå¯¼æ•°ç¬¦å· 5.3.1 åå¯¼æ•°å’Œæ¢¯åº¦åå¯¼æ•°è¡¨ç¤ºåœ¨å›ºå®šå…¶ä»–å˜é‡çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå˜é‡çš„å˜åŒ–ç‡ã€‚å‡è®¾ $f(x, y)$ æ˜¯ä¸€ä¸ªå…³äº $x$ å’Œ $y$çš„å‡½æ•°ï¼Œåˆ™ $f$ å¯¹ $x$ çš„åå¯¼æ•°è®°ä½œ $\\frac{\\partial f}{\\partial x}$ã€‚ åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œåå¯¼æ•°ç”¨äºè®¡ç®—æ¢¯åº¦ï¼Œå¸®åŠ©åå‘ä¼ æ’­ç®—æ³•æ›´æ–°æƒé‡ã€‚æ¢¯åº¦æ˜¯æŸå¤±å‡½æ•°å…³äºæ¯ä¸ªå‚æ•°çš„å¯¼æ•°ï¼Œè¡¨ç¤ºæŸå¤±å‡½æ•°å˜åŒ–ç‡ã€‚å¯¹äºä¸€ä¸ªæƒé‡ $w$ï¼Œæ¢¯åº¦ $\\frac{\\partial L}{\\partial w}$ è¡¨ç¤ºæƒé‡å˜åŒ–å¯¹æŸå¤±å‡½æ•° $L$ çš„å½±å“ã€‚å…·ä½“è€Œè¨€ï¼Œæ¢¯åº¦è¡¨ç¤ºæŸå¤±å‡½æ•°ç›¸å¯¹äºæ¯ä¸ªå‚æ•°çš„åå¯¼æ•°ï¼š $\\frac{\\partial L}{\\partial W} = \\text{æ¢¯åº¦}$ é€šè¿‡è®¡ç®—æ¯ä¸ªå‚æ•°çš„åå¯¼æ•°ï¼Œåå‘ä¼ æ’­ç®—æ³•èƒ½é€æ­¥è°ƒæ•´ç½‘ç»œæƒé‡ï¼Œä½¿å¾—æŸå¤±å‡½æ•° $L$ æœ€å°åŒ–ï¼Œæé«˜æ¨¡å‹çš„é¢„æµ‹èƒ½åŠ›ã€‚ 5.3.2 åå¯¼æ•°æ¨å¯¼è¿‡ç¨‹å¦‚æœ $f(x, y) = x^2 + y^2$ï¼Œåˆ™å¯¹ $x$ çš„åå¯¼æ•°ä¸ºï¼š $\\frac{\\partial f}{\\partial x} = \\frac{\\partial (x^2 + y^2)}{\\partial x} = 2x$ æ ¹æ®æ±‚å¯¼æ³•åˆ™ï¼Œåˆ†å¼€å¯¹æ¯ä¸€é¡¹æ±‚å¯¼ï¼š$\\frac{\\partial f}{\\partial x} = \\frac{\\partial (x^2 + y^2)}{\\partial x} =\\frac{\\partial}{\\partial x} (x^2) + \\frac{\\partial}{\\partial x} (y^2)$ å¯¹äº $x^2$ï¼Œä½¿ç”¨å¹‚å‡½æ•°æ±‚å¯¼æ³•åˆ™ $\\frac{\\partial}{\\partial x} (x^n) = nx^{n-1}$ï¼š$\\frac{\\partial}{\\partial x} (x^2) = 2x^{2-1}= 2x$å¯¹äº $y^2$ï¼Œå› ä¸º$y$ è¢«è§†ä¸ºå¸¸æ•°ï¼Œå¯¹ $x$ æ±‚å¯¼ç»“æœä¸º 0ï¼š$\\frac{\\partial}{\\partial x} (y^2) = 0$ åŒç†ï¼Œå¯¹ $y$ çš„åå¯¼æ•°ä¸ºï¼š $\\frac{\\partial f}{\\partial y} = \\frac{\\partial (x^2 + y^2)}{\\partial y} = 2y$ ç°åœ¨æ ¹æ®ä»¥ä¸Šç†è§£é€å±‚åå‘è®¡ç®—æ¯ä¸ªå‚æ•°çš„æ¢¯åº¦ 5.3.3 è®¡ç®—è¾“å‡ºå±‚çš„æ¢¯åº¦å‡è®¾æˆ‘ä»¬ä½¿ç”¨å‡æ–¹è¯¯å·®ï¼ˆMSEï¼‰ä½œä¸ºæŸå¤±å‡½æ•°ï¼š$L = \\frac{1}{2} (y - t)^2$ å…¶ä¸­ï¼Œ$t$ æ˜¯ç›®æ ‡å€¼ã€‚ é¦–å…ˆï¼Œè®¡ç®—æŸå¤±ç›¸å¯¹äºè¾“å‡º $y$ çš„æ¢¯åº¦ï¼š $\\frac{\\partial L}{\\partial y} = y - t$ ç„¶åï¼Œè®¡ç®—æŸå¤±ç›¸å¯¹äºéšè—å±‚åˆ°è¾“å‡ºå±‚æƒé‡ $W_{31}$â€‹ å’Œ $W_{32}$çš„æ¢¯åº¦ï¼š $\\frac{\\partial L}{\\partial W_{31}} = \\frac{\\partial L}{\\partial y} \\cdot \\frac{\\partial y}{\\partial W_{31}}=\\frac{\\partial L}{\\partial y} \\cdot \\frac{\\partial (w_{31}h_1 + w_{32}h_2 + b_3)}{\\partial W_{31}} = (y - t) \\cdot h_1$ ç”±äº $W_{31}$å’Œ $h_1$â€‹ ç›¸ä¹˜ï¼Œè€Œ $h_1$â€‹ ä¸ä¾èµ–äº $W_{31}$ï¼Œå…¶ä½™é¡¹åœ¨åå¯¼æ•°è®¡ç®—ä¸­éƒ½æ˜¯å¸¸æ•°ï¼Œå› æ­¤å¯ä»¥å¿½ç•¥ã€‚æ‰€ä»¥ åœ¨è¿™ä¸ªè¡¨è¾¾å¼ä¸­ï¼Œ$W_{31}$å’Œ $h_1$â€‹ ç›¸ä¹˜ï¼Œå…¶ä½™é¡¹ä¸ $W_{31}$æ— å…³ï¼Œå› æ­¤åœ¨å¯¹ $W_{31}â€‹$ æ±‚å¯¼æ—¶å¯ä»¥å¿½ç•¥ã€‚$\\frac{\\partial L}{\\partial W_{31}} = \\frac{\\partial L}{\\partial y} \\cdot \\frac{\\partial y}{\\partial W_{31}}=\\frac{\\partial L}{\\partial y} \\cdot \\frac{\\partial (w_{31}h_1)}{\\partial W_{31}}$ æ ¹æ®å¹‚å‡½æ•°æ±‚å¯¼æ³•åˆ™ $\\frac{\\partial}{\\partial x} (x^n) = nx^{n-1}$æ ¹æ®çº¿æ€§æ±‚å¯¼æ³•åˆ™ï¼Œå¸¸æ•°é¡¹å¯ä»¥ç›´æ¥æå–å‡ºæ¥ $\\frac{\\partial}{\\partial x} (a\\cdot x) = a$ $\\frac{\\partial L}{\\partial W_{31}} = \\frac{\\partial L}{\\partial y} \\cdot \\frac{\\partial y}{\\partial W_{31}}=\\frac{\\partial L}{\\partial y} \\cdot \\frac{\\partial (w_{31}h_1)}{\\partial W_{31}} = \\frac{\\partial L}{\\partial y} \\cdot \\frac{\\partial (w_{31}h_1)}{\\partial W_{31}}= (y-t) \\cdot h_1$ åŒç†å¯å¾—ï¼š$\\frac{\\partial L}{\\partial W_{32}} = \\frac{\\partial L}{\\partial y} \\cdot \\frac{\\partial y}{\\partial W_{32}} = (y - t) \\cdot h_2$ è®¡ç®—æŸå¤±ç›¸å¯¹äºåç½® $b_3â€‹$ çš„æ¢¯åº¦ï¼š $\\frac{\\partial L}{\\partial b_3} = \\frac{\\partial L}{\\partial y} \\cdot \\frac{\\partial y}{\\partial b_3} = (y - t) \\cdot 1 = y - t$ 5.3.4 è®¡ç®—éšè—å±‚çš„æ¢¯åº¦å¯¹äºéšè—å±‚çš„æ¢¯åº¦ï¼Œéœ€è¦è®¡ç®—æŸå¤±ç›¸å¯¹äºéšè—çŠ¶æ€ $h_1$â€‹ å’Œ $h_2$â€‹ çš„æ¢¯åº¦ï¼š $\\frac{\\partial L}{\\partial h_1} = \\frac{\\partial L}{\\partial y} \\cdot \\frac{\\partial y}{\\partial h_1} = (y - t) \\cdot W_{31}$ $\\frac{\\partial L}{\\partial h_2} = \\frac{\\partial L}{\\partial y} \\cdot \\frac{\\partial y}{\\partial h_2} = (y - t) \\cdot W_{32}$ å…¶ä¸­ï¼Œ$y = w_{31}h_1 + w_{32}h_2 + b_3$ è®¡ç®—æ¨å¯¼è¿‡ç¨‹åŒä¸Šï¼Œå¯ä»¥å¾—åˆ°ä»¥ä¸Šç»“æœ ç”±äºéšè—å±‚ä½¿ç”¨çš„æ˜¯ReLUæ¿€æ´»å‡½æ•°ï¼Œå…¶å¯¼æ•°ä¸ºï¼š $\\frac{\\partial \\text{ReLU}(z)}{\\partial z} = \\begin{cases} 1 &amp; \\text{if } z &gt; 0 \\ 0 &amp; \\text{if } z \\leq 0 \\end{cases}$ å…¶ä¸­ $h_1 = \\text{ReLU}(z_1^{(1)})$ å› æ­¤åº”ç”¨é“¾å¼æ³•åˆ™åï¼š $\\frac{\\partial L}{\\partial z_1} = \\frac{\\partial L}{\\partial h_1} \\cdot \\frac{\\partial h_1}{\\partial z_1} = (y - t) \\cdot W_{31} \\cdot \\begin{cases} 1 &amp; \\text{if } z_1 &gt; 0 \\ 0 &amp; \\text{if } z_1 \\leq 0 \\end{cases}$ $\\frac{\\partial L}{\\partial z_2} = \\frac{\\partial L}{\\partial h_2} \\cdot \\frac{\\partial h_2}{\\partial z_2} = (y - t) \\cdot W_{32} \\cdot \\begin{cases} 1 &amp; \\text{if } z_2 &gt; 0 \\ 0 &amp; \\text{if } z_2 \\leq 0 \\end{cases}$ 5.3.5 è®¡ç®—è¾“å…¥å±‚çš„æ¢¯åº¦æœ€åï¼Œè®¡ç®—æŸå¤±ç›¸å¯¹äºè¾“å…¥å±‚æƒé‡ $W_{11}, W_{12}, W_{21}, W_{22}$â€‹ çš„æ¢¯åº¦ï¼š $\\frac{\\partial L}{\\partial W_{11}} = \\frac{\\partial L}{\\partial z_1} \\cdot \\frac{\\partial z_1}{\\partial W_{11}} = \\frac{\\partial L}{\\partial z_1} \\cdot x_1$ $\\frac{\\partial L}{\\partial W_{12}} = \\frac{\\partial L}{\\partial z_2} \\cdot \\frac{\\partial z_2}{\\partial W_{12}} = \\frac{\\partial L}{\\partial z_2} \\cdot x_1$ $\\frac{\\partial L}{\\partial W_{21}} = \\frac{\\partial L}{\\partial z_1} \\cdot \\frac{\\partial z_1}{\\partial W_{21}} = \\frac{\\partial L}{\\partial z_1} \\cdot x_2$ $\\frac{\\partial L}{\\partial W_{22}} = \\frac{\\partial L}{\\partial z_2} \\cdot \\frac{\\partial z_2}{\\partial W_{22}} = \\frac{\\partial L}{\\partial z_2} \\cdot x_2$â€‹ 5.4 æ›´æ–°æƒé‡ï¼ˆWeight Updateï¼‰ä½¿ç”¨æ¢¯åº¦ä¸‹é™ç®—æ³•æ ¹æ®è®¡ç®—å¾—åˆ°çš„æ¢¯åº¦è°ƒæ•´æƒé‡ã€‚æ¢¯åº¦ä¸‹é™çš„åŸºæœ¬å…¬å¼ä¸ºï¼š$W_{newâ€‹}=W_{old}â€‹âˆ’Î·â‹…\\frac{\\partial L}{\\partial W}$ å…¶ä¸­ï¼Œ$\\eta$ æ˜¯å­¦ä¹ ç‡ï¼ˆLearning Rateï¼‰ï¼Œ$\\frac{\\partial L}{\\partial W}$â€‹ æ˜¯æŸå¤±å‡½æ•°å¯¹æƒé‡çš„æ¢¯åº¦ã€‚ å¸¸è§çš„æ¢¯åº¦ä¸‹é™å˜ç§ æ‰¹é‡æ¢¯åº¦ä¸‹é™ï¼ˆBatch Gradient Descentï¼‰ï¼šåœ¨æ•´ä¸ªè®­ç»ƒæ•°æ®é›†ä¸Šè®¡ç®—æ¢¯åº¦ï¼Œç„¶åæ›´æ–°æƒé‡ã€‚é€‚ç”¨äºå°æ•°æ®é›†ï¼Œä½†è®¡ç®—é‡å¤§ï¼Œæ•ˆç‡è¾ƒä½ã€‚ éšæœºæ¢¯åº¦ä¸‹é™ï¼ˆStochastic Gradient Descent, SGDï¼‰ï¼šåœ¨æ¯ä¸ªè®­ç»ƒæ ·æœ¬ä¸Šè®¡ç®—æ¢¯åº¦ï¼Œç„¶åæ›´æ–°æƒé‡ã€‚è®¡ç®—æ•ˆç‡é«˜ï¼Œä½†æ¢¯åº¦å™ªå£°å¤§ï¼Œæ”¶æ•›ä¸ç¨³å®šã€‚ å°æ‰¹é‡æ¢¯åº¦ä¸‹é™ï¼ˆMini-Batch Gradient Descentï¼‰ï¼šåœ¨å°æ‰¹é‡è®­ç»ƒæ ·æœ¬ä¸Šè®¡ç®—æ¢¯åº¦ï¼Œç„¶åæ›´æ–°æƒé‡ã€‚ç»“åˆäº†æ‰¹é‡å’Œéšæœºæ¢¯åº¦ä¸‹é™çš„ä¼˜ç‚¹ï¼Œå¸¸ç”¨åœ¨å®é™…è®­ç»ƒä¸­ã€‚ 6. è¶…å‚æ•°ï¼ˆHyperparametersï¼‰ vs æ¨¡å‹å‚æ•°ï¼ˆParametersï¼‰è¶…å‚æ•°ï¼ˆHyperparametersï¼‰ï¼š å®šä¹‰ï¼šè¶…å‚æ•°æ˜¯æŒ‡åœ¨æ¨¡å‹è®­ç»ƒä¹‹å‰éœ€è¦æ‰‹åŠ¨è®¾ç½®çš„å‚æ•°ï¼Œä¸é€šè¿‡è®­ç»ƒæ•°æ®å­¦ä¹ å¾—åˆ°ï¼Œè€Œæ˜¯é€šè¿‡è¯•éªŒã€ç»éªŒæˆ–è‡ªåŠ¨è°ƒä¼˜æ–¹æ³•è®¾å®šã€‚ ä½œç”¨ï¼šæ§åˆ¶æ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ã€æ¨¡å‹å¤æ‚åº¦ã€æ­£åˆ™åŒ–ç¨‹åº¦ç­‰ã€‚ ç¤ºä¾‹ï¼šå­¦ä¹ ç‡ï¼ˆlearning rateï¼‰ã€æ‰¹å¤§å°ï¼ˆbatch sizeï¼‰ã€éšè—å±‚çš„æ•°é‡å’Œå¤§å°ã€æ­£åˆ™åŒ–ç³»æ•°ï¼ˆå¦‚L2æ­£åˆ™åŒ–ä¸­çš„Î»ï¼‰ã€è®­ç»ƒè½®æ•°ï¼ˆepochsï¼‰ç­‰ã€‚ è°ƒæ•´æ–¹æ³•ï¼šæ‰‹åŠ¨è°ƒè¯•ï¼ˆManual Tuningï¼‰ã€ç½‘æ ¼æœç´¢ï¼ˆGrid Searchï¼‰ã€éšæœºæœç´¢ï¼ˆRandom Searchï¼‰ã€è´å¶æ–¯ä¼˜åŒ–ï¼ˆBayesian Optimizationï¼‰ç­‰ã€‚ è°ƒæ•´é¢‘ç‡ï¼šé€šå¸¸åœ¨è®­ç»ƒä¹‹å‰è®¾å®šï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¸å˜ã€‚å¯èƒ½éœ€è¦å¤šæ¬¡è¯•éªŒå’Œè°ƒä¼˜è¿‡ç¨‹æ‰èƒ½ç¡®å®šæœ€ä½³è¶…å‚æ•°ã€‚ æ¨¡å‹å‚æ•°ï¼ˆModel Parametersï¼‰ï¼š å®šä¹‰ï¼šæ¨¡å‹å‚æ•°æ˜¯æŒ‡åœ¨æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­é€šè¿‡æ•°æ®å­¦ä¹ å¾—åˆ°çš„å‚æ•°ï¼Œè¿™äº›å‚æ•°å®šä¹‰äº†æ¨¡å‹çš„æœ€ç»ˆå½¢æ€å’Œè¡Œä¸ºã€‚ ä½œç”¨ï¼šç›´æ¥å½±å“æ¨¡å‹çš„é¢„æµ‹è¾“å‡ºï¼Œåæ˜ äº†æ¨¡å‹ä»æ•°æ®ä¸­å­¦åˆ°çš„çŸ¥è¯†ã€‚ ç¤ºä¾‹ï¼šç¥ç»ç½‘ç»œä¸­çš„æƒé‡å’Œåç½®ã€çº¿æ€§å›å½’ä¸­çš„å›å½’ç³»æ•°ã€æ”¯æŒå‘é‡æœºä¸­çš„æ”¯æŒå‘é‡ç­‰ã€‚ è°ƒæ•´æ–¹æ³•ï¼šé€šè¿‡è®­ç»ƒæ•°æ®å’Œä¼˜åŒ–ç®—æ³•ï¼ˆå¦‚æ¢¯åº¦ä¸‹é™ï¼‰è‡ªåŠ¨è°ƒæ•´ã€‚ è°ƒæ•´é¢‘ç‡ï¼šåœ¨æ¯ä¸ªè®­ç»ƒè¿­ä»£ä¸­éƒ½è¦æ›´æ–°ï¼Œç›´åˆ°æ¨¡å‹æ”¶æ•›æˆ–è¾¾åˆ°é¢„è®¾çš„è®­ç»ƒè½®æ•°ã€‚ ç¥ç»ç½‘ç»œä¸­çš„è¶…å‚æ•°å’Œæ¨¡å‹å‚æ•°è¶…å‚æ•°ï¼š å­¦ä¹ ç‡ï¼ˆLearning Rateï¼‰ï¼šå†³å®šæ¯æ¬¡æƒé‡æ›´æ–°çš„æ­¥é•¿ã€‚ æ‰¹å¤§å°ï¼ˆBatch Sizeï¼‰ï¼šå†³å®šæ¯æ¬¡æƒé‡æ›´æ–°æ—¶ä½¿ç”¨çš„è®­ç»ƒæ ·æœ¬æ•°é‡ã€‚ éšè—å±‚æ•°å’Œæ¯å±‚ç¥ç»å…ƒæ•°é‡ï¼šå®šä¹‰ç¥ç»ç½‘ç»œçš„ç»“æ„å’Œå¤æ‚åº¦ã€‚ æ­£åˆ™åŒ–ç³»æ•°ï¼šæ§åˆ¶æ­£åˆ™åŒ–é¡¹åœ¨æŸå¤±å‡½æ•°ä¸­çš„æƒé‡ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆã€‚ è®­ç»ƒè½®æ•°ï¼ˆEpochsï¼‰ï¼šæ¨¡å‹åœ¨æ•´ä¸ªè®­ç»ƒæ•°æ®é›†ä¸Šå®Œæ•´è®­ç»ƒçš„æ¬¡æ•°ã€‚ æ¨¡å‹å‚æ•°ï¼š æƒé‡ï¼ˆWeightsï¼‰ï¼šè¿æ¥ç¥ç»å…ƒçš„æƒé‡ï¼Œè¡¨ç¤ºè¾“å…¥ç‰¹å¾çš„é‡è¦æ€§ã€‚ åç½®ï¼ˆBiasesï¼‰ï¼šæ¯ä¸ªç¥ç»å…ƒçš„åç½®ï¼Œç”¨äºè°ƒæ•´æ¿€æ´»å‡½æ•°çš„è¾“å‡ºã€‚ 7. åºåˆ—æ•°æ® vs éåºåˆ—æ•°æ®1. åºåˆ—æ•°æ®ï¼ˆSequential Dataï¼‰åºåˆ—æ•°æ®ï¼ˆSequential Dataï¼‰æ˜¯æŒ‡æŒ‰ç…§æ—¶é—´æˆ–å…¶ä»–é¡ºåºæ’åˆ—çš„æ•°æ®ï¼Œå…¶ä¸­æ¯ä¸ªæ•°æ®ç‚¹çš„æ„ä¹‰å’Œä»·å€¼éƒ½ä¾èµ–äºå®ƒåœ¨åºåˆ—ä¸­çš„ä½ç½®å’Œå‰åæ•°æ®ç‚¹çš„å…³ç³»ã€‚åºåˆ—æ•°æ®å¹¿æ³›å­˜åœ¨äºè®¸å¤šå®é™…åº”ç”¨ä¸­ï¼Œå¦‚æ—¶é—´åºåˆ—ã€è‡ªç„¶è¯­è¨€å¤„ç†ã€è¯­éŸ³è¯†åˆ«ç­‰ã€‚ åºåˆ—æ•°æ®çš„ç‰¹ç‚¹ æ—¶é—´ä¾èµ–æ€§ï¼šåºåˆ—æ•°æ®ä¸­çš„æ¯ä¸ªæ•°æ®ç‚¹ä¸å…¶å‰åæ•°æ®ç‚¹å­˜åœ¨ä¾èµ–å…³ç³»ã€‚è¿™ç§ä¾èµ–æ€§å¯ä»¥æ˜¯çŸ­æœŸçš„ï¼ˆä»…ä¾èµ–äºæœ€è¿‘çš„æ•°æ®ç‚¹ï¼‰æˆ–é•¿æœŸçš„ï¼ˆä¾èµ–äºè¾ƒæ—©çš„æ•°æ®ç‚¹ï¼‰ã€‚ é¡ºåºå…³ç³»ï¼šåºåˆ—æ•°æ®çš„é¡ºåºæ˜¯è‡³å…³é‡è¦çš„ï¼Œæ•°æ®ç‚¹çš„é¡ºåºå…³ç³»å†³å®šäº†å…¶å®é™…æ„ä¹‰ã€‚ä¾‹å¦‚ï¼Œåœ¨è¯­éŸ³ä¿¡å·ä¸­ï¼ŒéŸ³é¢‘å¸§çš„é¡ºåºå†³å®šäº†æœ€ç»ˆè¯­éŸ³çš„å†…å®¹ã€‚ åŠ¨æ€æ€§ï¼šåºåˆ—æ•°æ®å¾€å¾€æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ•°æ®ç‚¹çš„å€¼éšæ—¶é—´æˆ–å…¶ä»–é¡ºåºå˜åŒ–è€Œå˜åŒ–ã€‚ é€’å½’ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰å’Œå…¶å˜ä½“å¦‚LSTMå’ŒGRUæ“…é•¿å¤„ç†åºåˆ—æ•°æ® 2. éåºåˆ—æ•°æ®éåºåˆ—åŒ–æ•°æ®æ˜¯æŒ‡é‚£äº›æ•°æ®ç‚¹ä¹‹é—´æ²¡æœ‰æ—¶é—´æˆ–é¡ºåºä¾èµ–å…³ç³»çš„æ•°æ®ã€‚ä¸åºåˆ—åŒ–æ•°æ®ï¼ˆå¦‚æ—¶é—´åºåˆ—ã€æ–‡æœ¬ã€è¯­éŸ³ä¿¡å·ç­‰ï¼‰ä¸åŒï¼Œéåºåˆ—åŒ–æ•°æ®ä¸­çš„æ¯ä¸ªæ•°æ®ç‚¹éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¾èµ–äºå‰åçš„æ•°æ®ç‚¹ã€‚éåºåˆ—åŒ–æ•°æ®åœ¨å„ç§é¢†åŸŸä¸­å¹¿æ³›å­˜åœ¨ï¼ŒåŒ…æ‹¬å›¾åƒæ•°æ®ã€è¡¨æ ¼æ•°æ®ï¼ˆç»“æ„åŒ–æ•°æ®ï¼‰ã€å›¾æ•°æ®ç­‰ã€‚ä¸åŒç±»å‹çš„éåºåˆ—åŒ–æ•°æ®å¯ä»¥é€šè¿‡ä¸åŒçš„ç¥ç»ç½‘ç»œè¿›è¡Œå¤„ç†ï¼Œå¦‚å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰å¤„ç†å›¾åƒæ•°æ®ï¼Œå‰é¦ˆç¥ç»ç½‘ç»œï¼ˆFNNï¼‰å¤„ç†è¡¨æ ¼æ•°æ®ï¼Œå›¾ç¥ç»ç½‘ç»œï¼ˆGNNï¼‰å¤„ç†å›¾æ•°æ®ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œé€‰æ‹©åˆé€‚çš„ç¥ç»ç½‘ç»œæ¨¡å‹èƒ½å¤Ÿæœ‰æ•ˆåœ°å¤„ç†å„ç§éåºåˆ—åŒ–æ•°æ®ï¼Œè§£å†³å®é™…é—®é¢˜ã€‚ éåºåˆ—åŒ–æ•°æ®çš„å®é™…åº”ç”¨1. å›¾åƒæ•°æ®çš„åº”ç”¨å›¾åƒæ•°æ®æ˜¯é«˜ç»´éåºåˆ—æ•°æ®ï¼Œå…·æœ‰ç©ºé—´ç»“æ„ç‰¹æ€§ã€‚å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰æ˜¯å¤„ç†å›¾åƒæ•°æ®çš„ä¸»è¦ç¥ç»ç½‘ç»œç±»å‹ã€‚ åŒ»ç–—å½±åƒåˆ†æï¼šé€šè¿‡CNNå¤„ç†åŒ»ç–—å½±åƒï¼ˆå¦‚MRIã€CTå›¾åƒï¼‰ï¼Œè¿›è¡Œç–¾ç—…è¯Šæ–­å’Œåˆ†ç±»ã€‚ è‡ªåŠ¨é©¾é©¶ï¼šä½¿ç”¨CNNåˆ†ææ±½è½¦æ‘„åƒå¤´æ•æ‰çš„é“è·¯å›¾åƒï¼Œè¯†åˆ«è¡Œäººã€äº¤é€šæ ‡å¿—å’Œå…¶ä»–è½¦è¾†ã€‚å›¾åƒåˆ†ç±»ï¼šä½¿ç”¨CNNå¯¹è¾“å…¥å›¾åƒè¿›è¡Œåˆ†ç±»ã€‚ä¾‹å¦‚ï¼ŒImageNetæ•°æ®é›†ä¸Šçš„ç‰©ä½“è¯†åˆ«ä»»åŠ¡ã€‚ å…·ä½“åº”ç”¨ï¼šå·ç§¯å±‚æå–å›¾åƒçš„å±€éƒ¨ç‰¹å¾ï¼Œæ± åŒ–å±‚å‡å°‘ç‰¹å¾ç»´åº¦ï¼Œå…¨è¿æ¥å±‚è¿›è¡Œåˆ†ç±»ã€‚ å…¸å‹æ¨¡å‹ï¼šAlexNetã€VGGã€ResNetç­‰ã€‚å›¾åƒåˆ†å‰²ï¼šå°†å›¾åƒåˆ’åˆ†ä¸ºå…·æœ‰ä¸åŒè¯­ä¹‰æ„ä¹‰çš„åŒºåŸŸã€‚ä¾‹å¦‚ï¼Œè‡ªåŠ¨é©¾é©¶ä¸­çš„é“è·¯æ ‡è®°è¯†åˆ«ã€‚ å…·ä½“åº”ç”¨ï¼šåˆ©ç”¨å…¨å·ç§¯ç¥ç»ç½‘ç»œï¼ˆFCNï¼‰æˆ–U-Netå¯¹å›¾åƒè¿›è¡Œåƒç´ çº§åˆ†ç±»ã€‚ å…¸å‹æ¨¡å‹ï¼šU-Netã€SegNetç­‰ã€‚ 2. è¡¨æ ¼æ•°æ®çš„åº”ç”¨è¡¨æ ¼æ•°æ®é€šå¸¸å­˜å‚¨åœ¨æ•°æ®åº“æˆ–ç”µå­è¡¨æ ¼ä¸­ï¼ŒåŒ…å«å¤šç§ç‰¹å¾å’Œç›®æ ‡å˜é‡ã€‚å‰é¦ˆç¥ç»ç½‘ç»œï¼ˆFNNï¼‰é€‚ç”¨äºå¤„ç†è¡¨æ ¼æ•°æ®ã€‚å›å½’åˆ†æï¼šé¢„æµ‹è¿ç»­å€¼ï¼Œå¦‚æˆ¿ä»·é¢„æµ‹ã€‚ å…·ä½“åº”ç”¨ï¼šè¾“å…¥å±‚æ¥æ”¶å¤šç§ç‰¹å¾ï¼Œéšè—å±‚æå–ç‰¹å¾ä¹‹é—´çš„å¤æ‚å…³ç³»ï¼Œè¾“å‡ºå±‚ç»™å‡ºé¢„æµ‹å€¼ã€‚ å…¸å‹æ¨¡å‹ï¼šå¤šå±‚æ„ŸçŸ¥å™¨ï¼ˆMLPï¼‰ã€‚-åˆ†ç±»ä»»åŠ¡ï¼šå¯¹æ•°æ®è¿›è¡Œåˆ†ç±»ï¼Œå¦‚ä¿¡ç”¨å¡æ¬ºè¯ˆæ£€æµ‹ã€‚ å…·ä½“åº”ç”¨ï¼šè¾“å…¥å±‚æ¥æ”¶å„ç‰¹å¾å€¼ï¼Œéšè—å±‚æå–ç‰¹å¾é—´å…³ç³»ï¼Œè¾“å‡ºå±‚è¿›è¡Œåˆ†ç±»ã€‚ å…¸å‹æ¨¡å‹ï¼šå¤šå±‚æ„ŸçŸ¥å™¨ï¼ˆMLPï¼‰ã€‚ å®¢æˆ·åˆ†ç±»ï¼šä½¿ç”¨FNNå¯¹å®¢æˆ·è¿›è¡Œåˆ†ç±»ï¼Œå¦‚æ ¹æ®å®¢æˆ·è´­ä¹°è¡Œä¸ºé¢„æµ‹å®¢æˆ·æµå¤±é£é™©ã€‚ 3. å›¾æ•°æ®çš„åº”ç”¨å›¾æ•°æ®ç”±èŠ‚ç‚¹å’Œè¾¹æ„æˆï¼Œå…·æœ‰å¤æ‚çš„è¿æ¥ç»“æ„ã€‚å›¾ç¥ç»ç½‘ç»œï¼ˆGraph Neural Networks, GNNsï¼‰ä¸“é—¨ç”¨äºå¤„ç†å›¾æ•°æ®ã€‚ èŠ‚ç‚¹åˆ†ç±»ï¼šåœ¨å›¾ä¸­ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é…æ ‡ç­¾ï¼Œå¦‚ç¤¾äº¤ç½‘ç»œä¸­çš„ç”¨æˆ·åˆ†ç±»ã€‚ å…·ä½“åº”ç”¨ï¼šå›¾å·ç§¯ç¥ç»ç½‘ç»œï¼ˆGCNï¼‰é€šè¿‡èšåˆé‚»å±…èŠ‚ç‚¹çš„ä¿¡æ¯æ›´æ–°æ¯ä¸ªèŠ‚ç‚¹çš„è¡¨ç¤ºï¼Œç„¶åè¿›è¡Œåˆ†ç±»ã€‚ å…¸å‹æ¨¡å‹ï¼šGCNã€GraphSAGEã€‚å›¾åˆ†ç±»ï¼šå¯¹æ•´ä¸ªå›¾è¿›è¡Œåˆ†ç±»ï¼Œå¦‚åˆ†å­ç»“æ„çš„åŒ–å­¦æ€§è´¨é¢„æµ‹ã€‚ å…·ä½“åº”ç”¨ï¼šå°†å›¾åµŒå…¥åˆ°å›ºå®šé•¿åº¦çš„å‘é‡è¡¨ç¤ºä¸­ï¼Œç„¶åä½¿ç”¨å‰é¦ˆç¥ç»ç½‘ç»œè¿›è¡Œåˆ†ç±»ã€‚ å…¸å‹æ¨¡å‹ï¼šDGCNNã€GraphSAGEã€‚ ç¤¾äº¤ç½‘ç»œåˆ†æï¼šé€šè¿‡GNNåˆ†æç¤¾äº¤ç½‘ç»œä¸­çš„ç”¨æˆ·å…³ç³»ï¼Œè¿›è¡Œç”¨æˆ·åˆ†ç±»å’Œæ¨èç³»ç»Ÿã€‚ åŒ–å­¦åˆ†å­å»ºæ¨¡ï¼šä½¿ç”¨GNNåˆ†æåŒ–å­¦åˆ†å­ç»“æ„ï¼Œé¢„æµ‹åˆ†å­çš„ç‰©ç†å’ŒåŒ–å­¦æ€§è´¨ã€‚ 8. å‘é‡åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œå‘é‡æ˜¯ä¸€ä¸ªé‡è¦çš„æ•°å­¦å·¥å…·ï¼Œç”¨äºè¡¨ç¤ºå’Œæ“ä½œå¤šä¸ªæ•°å€¼ã€‚å‘é‡åœ¨ç¥ç»ç½‘ç»œçš„å„ä¸ªéƒ¨åˆ†éƒ½æœ‰å¹¿æ³›çš„åº”ç”¨ï¼ŒåŒ…æ‹¬è¾“å…¥æ•°æ®ã€æƒé‡ã€åç½®ã€æ¿€æ´»å€¼ç­‰ã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£å‘é‡åœ¨ç¥ç»ç½‘ç»œä¸­çš„è§’è‰²ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œè¯¦ç»†é˜è¿°ï¼š å‘é‡çš„å®šä¹‰ä¸€ä¸ªå‘é‡æ˜¯ä¸€ä¸ªå…·æœ‰æ–¹å‘å’Œå¤§å°çš„æ•°é‡é›†åˆï¼Œé€šå¸¸ç”¨ä¸€ç»´æ•°ç»„æ¥è¡¨ç¤ºã€‚åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œå‘é‡å¯ä»¥ç”¨æ¥è¡¨ç¤ºè¾“å…¥ç‰¹å¾ã€éšè—å±‚çš„æ¿€æ´»å€¼ã€è¾“å‡ºå€¼ä»¥åŠæ¨¡å‹çš„æƒé‡å’Œåç½®ã€‚ å‘é‡åœ¨ç¥ç»ç½‘ç»œä¸­çš„å…·ä½“åº”ç”¨1. è¾“å…¥å‘é‡è¾“å…¥å‘é‡è¡¨ç¤ºç¥ç»ç½‘ç»œæ¥æ”¶åˆ°çš„åŸå§‹æ•°æ®ã€‚åœ¨ä¸€ä¸ªç®€å•çš„å‰é¦ˆç¥ç»ç½‘ç»œä¸­ï¼Œè¾“å…¥å‘é‡é€šå¸¸æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªç‰¹å¾çš„æ•°æ®ç‚¹ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªå›¾åƒåˆ†ç±»ä»»åŠ¡ï¼Œæ¯ä¸ªè¾“å…¥å‘é‡å¯èƒ½ä»£è¡¨ä¸€å¼ å›¾åƒçš„åƒç´ å€¼ã€‚ ç¤ºä¾‹ï¼š å¯¹äºä¸€ä¸ªå…·æœ‰ä¸‰ä¸ªç‰¹å¾çš„è¾“å…¥æ•°æ®ç‚¹$(x_1, x_2, x_3)$ï¼Œè¾“å…¥å‘é‡å¯ä»¥è¡¨ç¤ºä¸ºï¼š$\\mathbf{x} = \\begin{bmatrix} x_1 \\ x_2 \\ x_3 \\end{bmatrix}$ 2. æƒé‡å‘é‡æƒé‡å‘é‡è¡¨ç¤ºç¥ç»å…ƒä¹‹é—´çš„è¿æ¥å¼ºåº¦ã€‚åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œæ¯ä¸ªç¥ç»å…ƒçš„è¾“å‡ºéƒ½æ˜¯å‰ä¸€å±‚ç¥ç»å…ƒè¾“å‡ºçš„åŠ æƒå’Œã€‚æƒé‡å‘é‡å†³å®šäº†è¾“å…¥ç‰¹å¾å¯¹è¾“å‡ºçš„å½±å“ç¨‹åº¦ã€‚ ç¤ºä¾‹ï¼š å¯¹äºä¸€ä¸ªå…·æœ‰ä¸‰ä¸ªè¾“å…¥ç‰¹å¾çš„ç¥ç»å…ƒï¼Œå…¶æƒé‡å‘é‡å¯ä»¥è¡¨ç¤ºä¸ºï¼š $\\mathbf{w} = \\begin{bmatrix} w_1 \\ w_2 \\ w_3 \\end{bmatrix}$ 3. åç½®å‘é‡åç½®å‘é‡æ˜¯ä¸€ä¸ªé¢å¤–çš„å‚æ•°ï¼Œç”¨äºè°ƒæ•´ç¥ç»å…ƒçš„è¾“å‡ºï¼Œä½¿å…¶èƒ½å¤Ÿæ›´å¥½åœ°æ‹Ÿåˆæ•°æ®ã€‚åç½®å‘é‡ä¸æƒé‡å‘é‡ä¸€èµ·ï¼Œå½±å“æ¯ä¸ªç¥ç»å…ƒçš„è¾“å‡ºã€‚ ç¤ºä¾‹ï¼š å¯¹äºä¸€ä¸ªå…·æœ‰ä¸‰ä¸ªè¾“å…¥ç‰¹å¾çš„ç¥ç»å…ƒï¼Œå…¶åç½®å‘é‡å¯ä»¥è¡¨ç¤ºä¸ºï¼š $\\mathbf{b} = b$ 4. æ¿€æ´»å€¼å‘é‡æ¿€æ´»å€¼å‘é‡è¡¨ç¤ºç¥ç»ç½‘ç»œä¸­æ¯ä¸€å±‚çš„è¾“å‡ºã€‚åœ¨å‰å‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œè¾“å…¥å‘é‡ä¸æƒé‡å‘é‡ç›¸ä¹˜å¹¶åŠ ä¸Šåç½®å‘é‡ï¼Œç»è¿‡æ¿€æ´»å‡½æ•°åå¾—åˆ°çš„å€¼å³ä¸ºæ¿€æ´»å€¼ã€‚ ç¤ºä¾‹ï¼š å¯¹äºä¸€ä¸ªå…·æœ‰ä¸‰ä¸ªç¥ç»å…ƒçš„éšè—å±‚ï¼Œå…¶æ¿€æ´»å€¼å‘é‡å¯ä»¥è¡¨ç¤ºä¸ºï¼š $\\mathbf{a} = \\begin{bmatrix} a_1 \\ a_2 \\ a_3 \\end{bmatrix}$ å‘é‡æ“ä½œåœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œå¸¸è§çš„å‘é‡æ“ä½œåŒ…æ‹¬å‘é‡åŠ æ³•ã€å‘é‡ä¹˜æ³•ï¼ˆç‚¹ç§¯ï¼‰ã€æ ‡é‡ä¹˜æ³•å’Œå‘é‡çš„æ¿€æ´»å‡½æ•°åº”ç”¨ã€‚ 1. å‘é‡åŠ æ³•å‘é‡åŠ æ³•æ˜¯å°†ä¸¤ä¸ªå‘é‡çš„å¯¹åº”å…ƒç´ ç›¸åŠ ã€‚å‡è®¾æœ‰ä¸¤ä¸ªå‘é‡ $\\mathbf{a}$ å’Œ $\\mathbf{b}$ï¼Œå®ƒä»¬çš„å‘é‡åŠ æ³•è¡¨ç¤ºä¸ºï¼š $\\mathbf{c} = \\mathbf{a} + \\mathbf{b}$$\\mathbf{c} = \\begin{bmatrix} a_1 + b_1 \\ a_2 + b_2 \\ a_3 + b_3 \\end{bmatrix}$ 2. å‘é‡ä¹˜æ³•ï¼ˆç‚¹ç§¯ï¼‰å‘é‡ç‚¹ç§¯æ˜¯å°†ä¸¤ä¸ªå‘é‡çš„å¯¹åº”å…ƒç´ ç›¸ä¹˜å¹¶æ±‚å’Œã€‚å‡è®¾æœ‰ä¸¤ä¸ªå‘é‡ a\\mathbf{a}a å’Œ $\\mathbf{b}$ï¼Œå®ƒä»¬çš„ç‚¹ç§¯è¡¨ç¤ºä¸ºï¼š$c = \\mathbf{a} \\cdot \\mathbf{b}$$c = a_1 \\cdot b_1 + a_2 \\cdot b_2 + a_3 \\cdot b_3$ 3. æ ‡é‡ä¹˜æ³•æ ‡é‡ä¹˜æ³•æ˜¯å°†å‘é‡çš„æ¯ä¸ªå…ƒç´ ä¹˜ä»¥ä¸€ä¸ªæ ‡é‡ã€‚å‡è®¾æœ‰ä¸€ä¸ªå‘é‡ $\\mathbf{a}$ å’Œä¸€ä¸ªæ ‡é‡ $k$ï¼Œå®ƒä»¬çš„æ ‡é‡ä¹˜æ³•è¡¨ç¤ºä¸ºï¼š $\\mathbf{b} = k \\cdot \\mathbf{a}$ $\\mathbf{b} = \\begin{bmatrix} k \\cdot a_1 \\ k \\cdot a_2 \\ k \\cdot a_3 \\end{bmatrix}$ ç¤ºä¾‹ï¼šå‰å‘ä¼ æ’­ä¸­çš„å‘é‡è¿ç®—ä»¥ä¸€ä¸ªç®€å•çš„ä¸¤å±‚ç¥ç»ç½‘ç»œä¸ºä¾‹ï¼Œè¯´æ˜å‘é‡åœ¨å‰å‘ä¼ æ’­ä¸­çš„åº”ç”¨ã€‚ è¾“å…¥å±‚ï¼šè¾“å…¥å‘é‡ $\\mathbf{x}$$\\mathbf{x} = \\begin{bmatrix} x_1 \\ x_2 \\end{bmatrix}$ éšè—å±‚ï¼šæƒé‡å‘é‡ $\\mathbf{W}$ å’Œåç½®å‘é‡ $\\mathbf{b}$$\\mathbf{W} = \\begin{bmatrix} w_{11} &amp; w_{12} \\ w_{21} &amp; w_{22} \\end{bmatrix}$ $\\mathbf{b} = \\begin{bmatrix} b_1 \\ b_2 \\end{bmatrix}$ è®¡ç®—éšè—å±‚æ¿€æ´»å€¼ï¼š$\\mathbf{z} = \\mathbf{W} \\cdot \\mathbf{x} + \\mathbf{b}$ $\\mathbf{z} = \\begin{bmatrix} w_{11}x_1 + w_{12}x_2 + b_1 \\ w_{21}x_1 + w_{22}x_2 + b_2 \\end{bmatrix}$ åº”ç”¨æ¿€æ´»å‡½æ•°ï¼ˆå¦‚ReLUï¼‰ï¼š$\\mathbf{a} = \\text{ReLU}(\\mathbf{z})$$\\mathbf{a} = \\begin{bmatrix} \\text{ReLU}(z_1) \\ \\text{ReLU}(z_2) \\end{bmatrix}$ è¾“å‡ºå±‚ï¼šæƒé‡å‘é‡ $\\mathbf{Wâ€™}$ å’Œåç½® $\\mathbf{bâ€™}$$\\mathbf{Wâ€™} = \\begin{bmatrix} w_{31} &amp; w_{32} \\end{bmatrix}$$\\mathbf{bâ€™} = bâ€™$ è®¡ç®—è¾“å‡ºå€¼ï¼š$y = \\mathbf{Wâ€™} \\cdot \\mathbf{a} + \\mathbf{bâ€™}$$y = w_{31}a_1 + w_{32}a_2 + bâ€™$ 9.è¯¯å·®è®­ç»ƒè¯¯å·®ã€æµ‹è¯•è¯¯å·®å’ŒéªŒè¯è¯¯å·®æ˜¯ä¸‰ä¸ªä¸åŒçš„æ¦‚å¿µï¼Œå®ƒä»¬åˆ†åˆ«è¡¡é‡æ¨¡å‹åœ¨ä¸åŒæ•°æ®é›†ä¸Šçš„è¡¨ç°ã€‚è¿™äº›è¯¯å·®å¸®åŠ©æˆ‘ä»¬è¯„ä¼°æ¨¡å‹çš„æ‹Ÿåˆç¨‹åº¦å’Œæ³›åŒ–èƒ½åŠ› 9.1 åŒºåˆ«å’Œè”ç³» è®­ç»ƒè¯¯å·®ï¼šè¡¡é‡æ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„è¡¨ç°ï¼Œä¸»è¦ç”¨äºè®­ç»ƒè¿‡ç¨‹ä¸­è°ƒæ•´æ¨¡å‹å‚æ•°ã€‚ éªŒè¯è¯¯å·®ï¼šè¡¡é‡æ¨¡å‹åœ¨éªŒè¯æ•°æ®ä¸Šçš„è¡¨ç°ï¼Œä¸»è¦ç”¨äºè¶…å‚æ•°è°ƒä¼˜å’Œæ¨¡å‹é€‰æ‹©ã€‚éªŒè¯æ•°æ®æ˜¯ä»è®­ç»ƒæ•°æ®ä¸­åˆ†ç¦»å‡ºæ¥çš„ä¸€éƒ¨åˆ†ï¼Œä¸å‚ä¸æ¨¡å‹è®­ç»ƒã€‚ æµ‹è¯•è¯¯å·®ï¼šè¡¡é‡æ¨¡å‹åœ¨æµ‹è¯•æ•°æ®ä¸Šçš„è¡¨ç°ï¼Œä¸»è¦ç”¨äºè¯„ä¼°æ¨¡å‹çš„æœ€ç»ˆæ³›åŒ–èƒ½åŠ›ã€‚æµ‹è¯•æ•°æ®åœ¨è®­ç»ƒå’ŒéªŒè¯è¿‡ç¨‹ä¸­éƒ½ä¸ä½¿ç”¨ï¼Œåªæœ‰åœ¨æ¨¡å‹è®­ç»ƒå®Œæˆåæ‰ç”¨äºè¯„ä¼°ã€‚ 9.2 è®­ç»ƒè¯¯å·®ï¼ˆTraining Errorï¼‰è®­ç»ƒè¯¯å·®æ˜¯æŒ‡æ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„è¯¯å·®ã€‚å®ƒåæ˜ äº†æ¨¡å‹å¯¹è®­ç»ƒæ•°æ®çš„æ‹Ÿåˆç¨‹åº¦ã€‚è®¡ç®—æ–¹æ³• è®­ç»ƒè¯¯å·®é€šå¸¸é€šè¿‡åœ¨è®­ç»ƒæ•°æ®ä¸Šè®¡ç®—æŸå¤±å‡½æ•°ï¼ˆä¾‹å¦‚å‡æ–¹è¯¯å·®ã€äº¤å‰ç†µæŸå¤±ç­‰ï¼‰æ¥å¾—åˆ°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½¿ç”¨å‡æ–¹è¯¯å·®ï¼ˆMSEï¼‰ä½œä¸ºæŸå¤±å‡½æ•°ï¼Œè®­ç»ƒè¯¯å·®å¯ä»¥è¡¨ç¤ºä¸ºï¼š $\\text{MSE}_{\\text{train}} = \\frac{1}{N_{\\text{train}}} \\sum_{i=1}^{N_{\\text{train}}} (y_i - \\hat{y}_i)^2$ å…¶ä¸­ï¼ŒNtrainN_{\\text{train}}Ntrainâ€‹ æ˜¯è®­ç»ƒæ•°æ®çš„æ ·æœ¬æ•°é‡ï¼Œyiy_iyiâ€‹ æ˜¯ç¬¬ iii ä¸ªæ ·æœ¬çš„çœŸå®å€¼ï¼Œy^i\\hat{y}_i y^â€‹iâ€‹ æ˜¯æ¨¡å‹å¯¹ç¬¬ iii ä¸ªæ ·æœ¬çš„é¢„æµ‹å€¼ã€‚ ç›®æ ‡æœ€å°åŒ–è®­ç»ƒè¯¯å·®ï¼Œä»¥ä¾¿æ¨¡å‹èƒ½å¤Ÿè‰¯å¥½åœ°æ‹Ÿåˆè®­ç»ƒæ•°æ®ã€‚ æ„ä¹‰ä½è®­ç»ƒè¯¯å·®è¡¨æ˜æ¨¡å‹èƒ½å¤Ÿå¾ˆå¥½åœ°æ‹Ÿåˆè®­ç»ƒæ•°æ®ã€‚ä½†è¿™å¹¶ä¸ä¸€å®šæ„å‘³ç€æ¨¡å‹åœ¨æ–°æ•°æ®ä¸Šçš„è¡¨ç°ä¹Ÿä¼šè‰¯å¥½ã€‚ 9.3 é¢„æµ‹è¯¯å·®/æµ‹è¯•è¯¯å·®é¢„æµ‹è¯¯å·®/æµ‹è¯•è¯¯å·® æ˜¯æŒ‡æ¨¡å‹åœ¨æœªè§è¿‡çš„æ•°æ®ï¼ˆé€šå¸¸æ˜¯æµ‹è¯•æ•°æ®æˆ–éªŒè¯æ•°æ®ï¼‰ä¸Šçš„è¯¯å·®ã€‚å®ƒåæ˜ äº†æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ï¼Œå³æ¨¡å‹åœ¨æ–°æ•°æ®ä¸Šçš„è¡¨ç°ã€‚ è®¡ç®—æ–¹æ³•ï¼šåœ¨æ¨¡å‹è®­ç»ƒå®Œæˆåï¼Œä½¿ç”¨æµ‹è¯•æ•°æ®æˆ–éªŒè¯æ•°æ®è®¡ç®—æŸå¤±å‡½æ•°çš„å€¼ï¼Œè®¡ç®—æ–¹æ³•ä¸è®­ç»ƒè¯¯å·®ç±»ä¼¼ ç›®æ ‡ï¼šè¯„ä¼°æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ï¼ŒæœŸæœ›æ¨¡å‹åœ¨æµ‹è¯•æ•°æ®ä¸Šçš„è¯¯å·®å°½å¯èƒ½ä½ã€‚ æ„ä¹‰ï¼šä½é¢„æµ‹è¯¯å·®è¡¨æ˜æ¨¡å‹å…·æœ‰è‰¯å¥½çš„æ³›åŒ–èƒ½åŠ›ï¼Œèƒ½å¤Ÿåœ¨æ–°æ•°æ®ä¸Šè¡¨ç°è‰¯å¥½ã€‚ 9.4 è¯¯å·®çš„ä½œç”¨è®­ç»ƒè¯¯å·®å’Œé¢„æµ‹è¯¯å·®çš„å…³ç³»å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¯Šæ–­æ¨¡å‹çš„çŠ¶æ€ï¼Œåˆ¤æ–­æ¨¡å‹æ˜¯å¦è¿‡æ‹Ÿåˆæˆ–æ¬ æ‹Ÿåˆã€‚ æ¬ æ‹Ÿåˆï¼ˆUnderfittingï¼‰ï¼šæ¨¡å‹åœ¨è®­ç»ƒæ•°æ®å’Œæµ‹è¯•æ•°æ®ä¸Šçš„è¯¯å·®éƒ½å¾ˆé«˜ï¼Œè¯´æ˜æ¨¡å‹å¤æ‚åº¦ä¸è¶³ï¼Œæ— æ³•æ•æ‰æ•°æ®ä¸­çš„è§„å¾‹ã€‚ åˆé€‚æ‹Ÿåˆï¼ˆGood Fitï¼‰ï¼šæ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„è¯¯å·®è¾ƒä½ï¼Œå¹¶ä¸”åœ¨æµ‹è¯•æ•°æ®ä¸Šçš„è¯¯å·®ä¹Ÿè¾ƒä½ï¼Œè¯´æ˜æ¨¡å‹å…·æœ‰è‰¯å¥½çš„æ³›åŒ–èƒ½åŠ›ã€‚ è¿‡æ‹Ÿåˆï¼ˆOverfittingï¼‰ï¼šæ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„è¯¯å·®å¾ˆä½ï¼Œä½†åœ¨æµ‹è¯•æ•°æ®ä¸Šçš„è¯¯å·®å¾ˆé«˜ï¼Œè¯´æ˜æ¨¡å‹è¿‡äºå¤æ‚ï¼Œæ•æ‰åˆ°äº†è®­ç»ƒæ•°æ®ä¸­çš„å™ªå£°å’Œç»†èŠ‚ï¼Œæ³›åŒ–èƒ½åŠ›è¾ƒå·®ã€‚ 10.è¿‡åº¦æ‹Ÿåˆè¿‡åº¦æ‹Ÿåˆï¼ˆOverfittingï¼‰æ˜¯æœºå™¨å­¦ä¹ ä¸­çš„ä¸€ä¸ªå¸¸è§é—®é¢˜ï¼ŒæŒ‡çš„æ˜¯æ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šè¡¨ç°è‰¯å¥½ï¼Œä½†åœ¨æœªè§è¿‡çš„æµ‹è¯•æ•°æ®æˆ–å®é™…åº”ç”¨ä¸­è¡¨ç°ä¸ä½³ã€‚è¿™é€šå¸¸æ˜¯å› ä¸ºæ¨¡å‹è¿‡äºå¤æ‚ï¼Œæ•æ‰åˆ°äº†è®­ç»ƒæ•°æ®ä¸­çš„å™ªå£°å’Œå¶ç„¶æ€§æ¨¡å¼ï¼Œè€Œä¸æ˜¯æ•°æ®çš„æ½œåœ¨è§„å¾‹ã€‚ è¿‡åº¦æ‹Ÿåˆçš„å…·ä½“è¡¨ç° è®­ç»ƒè¯¯å·®ä½ï¼Œæµ‹è¯•è¯¯å·®é«˜ï¼šæ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„è¯¯å·®å¾ˆä½ï¼Œä½†åœ¨æµ‹è¯•æ•°æ®æˆ–æ–°æ•°æ®ä¸Šçš„è¯¯å·®å¾ˆé«˜ã€‚ é«˜æ–¹å·®ï¼šæ¨¡å‹å¯¹è®­ç»ƒæ•°æ®ä¸­çš„ç»†èŠ‚å’Œå™ªå£°è¿‡äºæ•æ„Ÿï¼Œå¯¼è‡´å¯¹ä¸åŒæ•°æ®é›†çš„è¡¨ç°å·®å¼‚å¾ˆå¤§ã€‚ å¤æ‚æ¨¡å‹ï¼šè¿‡äºå¤æ‚çš„æ¨¡å‹ï¼ˆä¾‹å¦‚ï¼Œå…·æœ‰å¤ªå¤šå‚æ•°çš„æ·±åº¦ç¥ç»ç½‘ç»œï¼‰å®¹æ˜“è¿‡åº¦æ‹Ÿåˆã€‚ è¿‡åº¦æ‹Ÿåˆçš„åŸå›  æ¨¡å‹å¤æ‚åº¦é«˜ï¼šæ¨¡å‹çš„å‚æ•°è¿‡å¤šï¼Œèƒ½å¤Ÿæ‹Ÿåˆè®­ç»ƒæ•°æ®ä¸­çš„æ¯ä¸€ä¸ªç»†èŠ‚å’Œå™ªå£°ã€‚ è®­ç»ƒæ•°æ®ä¸è¶³ï¼šè®­ç»ƒæ•°æ®é‡è¿‡å°‘ï¼Œæ¨¡å‹æ— æ³•å­¦ä¹ åˆ°æ•°æ®çš„çœŸå®åˆ†å¸ƒå’Œè§„å¾‹ã€‚ å™ªå£°æ•°æ®ï¼šè®­ç»ƒæ•°æ®ä¸­åŒ…å«å¤§é‡å™ªå£°ï¼Œæ¨¡å‹å°†è¿™äº›å™ªå£°è¯¯è®¤ä¸ºæ˜¯æ•°æ®çš„æ½œåœ¨æ¨¡å¼ã€‚ ç¼ºä¹æ­£åˆ™åŒ–ï¼šæ²¡æœ‰ä½¿ç”¨æ­£åˆ™åŒ–æŠ€æœ¯æ¥çº¦æŸæ¨¡å‹çš„å¤æ‚åº¦ã€‚ å¦‚ä½•æ£€æµ‹è¿‡åº¦æ‹Ÿåˆ è®­ç»ƒè¯¯å·®ä¸éªŒè¯è¯¯å·®ï¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œè§‚å¯Ÿè®­ç»ƒè¯¯å·®å’ŒéªŒè¯è¯¯å·®çš„å˜åŒ–ã€‚å¦‚æœè®­ç»ƒè¯¯å·®æŒç»­ä¸‹é™ï¼Œè€ŒéªŒè¯è¯¯å·®åœ¨æŸä¸ªç‚¹ä¹‹åå¼€å§‹ä¸Šå‡ï¼Œè¿™é€šå¸¸æ˜¯è¿‡åº¦æ‹Ÿåˆçš„ä¿¡å·ã€‚ äº¤å‰éªŒè¯ï¼šä½¿ç”¨äº¤å‰éªŒè¯æŠ€æœ¯è¯„ä¼°æ¨¡å‹åœ¨å¤šä¸ªæ•°æ®å­é›†ä¸Šçš„è¡¨ç°ï¼Œé¿å…æ¨¡å‹å¯¹å•ä¸€è®­ç»ƒé›†çš„è¿‡åº¦ä¾èµ–ã€‚ å­¦ä¹ æ›²çº¿ï¼šç»˜åˆ¶å­¦ä¹ æ›²çº¿ï¼ˆè®­ç»ƒè¯¯å·®å’ŒéªŒè¯è¯¯å·®éšè®­ç»ƒæ ·æœ¬æ•°é‡å˜åŒ–çš„æ›²çº¿ï¼‰ï¼Œåˆ†ææ¨¡å‹çš„å­¦ä¹ è¡Œä¸ºã€‚ è§£å†³è¿‡åº¦æ‹Ÿåˆçš„æ–¹æ³• å¢åŠ è®­ç»ƒæ•°æ®ï¼šé€šè¿‡å¢åŠ è®­ç»ƒæ•°æ®é‡ï¼Œæ¨¡å‹å¯ä»¥æ›´å¥½åœ°å­¦ä¹ æ•°æ®çš„çœŸå®åˆ†å¸ƒï¼Œå‡å°‘å¯¹å™ªå£°çš„æ‹Ÿåˆã€‚ ç®€åŒ–æ¨¡å‹ï¼šå‡å°‘æ¨¡å‹çš„å‚æ•°æ•°é‡æˆ–é€‰æ‹©æ›´ç®€å•çš„æ¨¡å‹ï¼Œé¿å…è¿‡åº¦æ‹Ÿåˆã€‚ æ­£åˆ™åŒ–ï¼šä½¿ç”¨æ­£åˆ™åŒ–æŠ€æœ¯ï¼ˆå¦‚L1å’ŒL2æ­£åˆ™åŒ–ï¼‰æ¥çº¦æŸæ¨¡å‹å‚æ•°ï¼Œä½¿å…¶æ›´å¹³æ»‘ï¼Œå‡å°‘å¯¹è®­ç»ƒæ•°æ®çš„è¿‡åº¦æ‹Ÿåˆã€‚ L1æ­£åˆ™åŒ–ï¼šé€šè¿‡å¯¹æ¨¡å‹å‚æ•°çš„ç»å¯¹å€¼æ±‚å’Œï¼Œä½¿éƒ¨åˆ†å‚æ•°å˜ä¸ºé›¶ï¼Œèµ·åˆ°ç‰¹å¾é€‰æ‹©çš„ä½œç”¨ã€‚ L2æ­£åˆ™åŒ–ï¼šé€šè¿‡å¯¹æ¨¡å‹å‚æ•°çš„å¹³æ–¹å’Œè¿›è¡Œçº¦æŸï¼Œä½¿å‚æ•°å€¼å°½å¯èƒ½å°ï¼Œä»è€Œä½¿æ¨¡å‹æ›´å¹³æ»‘ã€‚ Dropoutï¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­éšæœºä¸¢å¼ƒä¸€éƒ¨åˆ†ç¥ç»å…ƒï¼Œé˜²æ­¢æ¨¡å‹å¯¹æŸäº›è·¯å¾„çš„è¿‡åº¦ä¾èµ–ã€‚ æ•°æ®å¢å¼ºï¼šé€šè¿‡å¯¹è®­ç»ƒæ•°æ®è¿›è¡Œæ—‹è½¬ã€ç¼©æ”¾ã€è£å‰ªç­‰å˜æ¢ï¼Œç”Ÿæˆæ›´å¤šçš„è®­ç»ƒæ ·æœ¬ï¼Œå¢åŠ æ•°æ®çš„å¤šæ ·æ€§ã€‚ æ—©åœæ³•ï¼ˆEarly Stoppingï¼‰ï¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ç›‘æ§éªŒè¯è¯¯å·®ï¼Œå½“éªŒè¯è¯¯å·®ä¸å†ä¸‹é™æ—¶ï¼Œæå‰åœæ­¢è®­ç»ƒï¼Œé˜²æ­¢æ¨¡å‹è¿‡åº¦æ‹Ÿåˆã€‚ 11. æ³›åŒ–èƒ½åŠ›æ³›åŒ–èƒ½åŠ›ï¼ˆGeneralizationï¼‰æ˜¯æŒ‡æœºå™¨å­¦ä¹ æ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä»¥å¤–çš„æ•°æ®ï¼ˆé€šå¸¸æ˜¯æœªè§è¿‡çš„æµ‹è¯•æ•°æ®æˆ–çœŸå®åº”ç”¨ä¸­çš„æ•°æ®ï¼‰ä¸Šè¡¨ç°è‰¯å¥½çš„èƒ½åŠ›ã€‚å®ƒåæ˜ äº†æ¨¡å‹å¯¹æ•°æ®çš„æ™®éè§„å¾‹çš„å­¦ä¹ ç¨‹åº¦ï¼Œè€Œä¸æ˜¯å¯¹è®­ç»ƒæ•°æ®çš„è®°å¿†ç¨‹åº¦ã€‚ ä¸€ä¸ªå…·æœ‰è‰¯å¥½æ³›åŒ–èƒ½åŠ›çš„æ¨¡å‹èƒ½å¤Ÿæœ‰æ•ˆåœ°ä»è®­ç»ƒæ•°æ®ä¸­å­¦ä¹ åˆ°æ½œåœ¨çš„è§„å¾‹ï¼Œå¹¶å°†è¿™äº›è§„å¾‹åº”ç”¨äºæ–°æ•°æ®ä¸Šï¼Œä»è€Œåœ¨å®é™…åº”ç”¨ä¸­ä¿æŒé«˜æ•ˆå’Œå‡†ç¡®çš„è¡¨ç°ã€‚ ç†è§£æ³›åŒ–èƒ½åŠ›éœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š è®­ç»ƒè¯¯å·®å’Œæµ‹è¯•è¯¯å·®å¦‚æœæ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„è¯¯å·®å¾ˆä½ï¼Œä½†åœ¨æµ‹è¯•æ•°æ®ä¸Šçš„è¯¯å·®å¾ˆé«˜ï¼Œè¿™é€šå¸¸è¡¨æ˜æ¨¡å‹è¿‡åº¦æ‹Ÿåˆï¼ˆOverfittingï¼‰ã€‚ç›¸åï¼Œå¦‚æœæ¨¡å‹åœ¨è®­ç»ƒæ•°æ®å’Œæµ‹è¯•æ•°æ®ä¸Šçš„è¯¯å·®éƒ½è¾ƒä½ï¼Œè¿™è¡¨æ˜æ¨¡å‹å…·æœ‰è‰¯å¥½çš„æ³›åŒ–èƒ½åŠ›ã€‚ æ¨¡å‹å¤æ‚åº¦ ç®€å•æ¨¡å‹ï¼šæ¨¡å‹å¤æ‚åº¦ä½ï¼Œå‚æ•°è¾ƒå°‘ï¼Œå®¹æ˜“æ¬ æ‹Ÿåˆï¼ˆUnderfittingï¼‰ï¼Œå³æ— æ³•å……åˆ†æ•æ‰æ•°æ®ä¸­çš„è§„å¾‹ã€‚ å¤æ‚æ¨¡å‹ï¼šæ¨¡å‹å¤æ‚åº¦é«˜ï¼Œå‚æ•°è¾ƒå¤šï¼Œå®¹æ˜“è¿‡åº¦æ‹Ÿåˆï¼Œå³æ•æ‰äº†è®­ç»ƒæ•°æ®ä¸­çš„å™ªå£°å’Œå¶ç„¶æ¨¡å¼ã€‚ä¸€ä¸ªå…·æœ‰è‰¯å¥½æ³›åŒ–èƒ½åŠ›çš„æ¨¡å‹åº”åœ¨ç®€å•å’Œå¤æ‚ä¹‹é—´å–å¾—å¹³è¡¡ï¼Œæ—¢èƒ½æ•æ‰æ•°æ®çš„æ½œåœ¨è§„å¾‹ï¼Œåˆä¸è¿‡åº¦æ‹Ÿåˆå™ªå£°ã€‚ 12.æ­£åˆ™åŒ–æ­£åˆ™åŒ–ï¼ˆRegularizationï¼‰æ˜¯ä¸€ç§åœ¨æœºå™¨å­¦ä¹ å’Œç»Ÿè®¡å­¦ä¸­ç”¨äºé˜²æ­¢æ¨¡å‹è¿‡æ‹Ÿåˆï¼ˆoverfittingï¼‰çš„æŠ€æœ¯,æé«˜æ¨¡å‹æ³›åŒ–èƒ½åŠ›çš„å…³é”®æŠ€æœ¯ã€‚ æ­£åˆ™åŒ–çš„ç±»å‹ L1 æ­£åˆ™åŒ–ï¼ˆLasso æ­£åˆ™åŒ–ï¼‰ï¼š å®šä¹‰ï¼šåœ¨æŸå¤±å‡½æ•°ä¸­æ·»åŠ æ‰€æœ‰æ¨¡å‹å‚æ•°ç»å¯¹å€¼çš„å’Œã€‚ æ•°å­¦è¡¨è¾¾ï¼š $\\text{Loss} = \\text{Original Loss} + \\lambda \\sum |w_i|$ ç‰¹ç‚¹ï¼šå¯ä»¥å¯¼è‡´ä¸€äº›å‚æ•°å®Œå…¨ä¸ºé›¶ï¼Œèµ·åˆ°ç‰¹å¾é€‰æ‹©çš„ä½œç”¨ã€‚ L2 æ­£åˆ™åŒ–ï¼ˆRidge æ­£åˆ™åŒ–ï¼‰ï¼š å®šä¹‰ï¼šåœ¨æŸå¤±å‡½æ•°ä¸­æ·»åŠ æ‰€æœ‰æ¨¡å‹å‚æ•°å¹³æ–¹å’Œã€‚ æ•°å­¦è¡¨è¾¾ï¼š $\\text{Loss} = \\text{Original Loss} + \\lambda \\sum w_i^2$ ç‰¹ç‚¹ï¼šå¯ä»¥é˜²æ­¢å‚æ•°å˜å¾—è¿‡å¤§ï¼Œä½†ä¸ä¼šä½¿å‚æ•°å®Œå…¨ä¸ºé›¶ã€‚ å¼¹æ€§ç½‘ç»œï¼ˆElastic Netï¼‰æ­£åˆ™åŒ–ï¼š å®šä¹‰ï¼šç»“åˆ L1 å’Œ L2 æ­£åˆ™åŒ–ã€‚ æ•°å­¦è¡¨è¾¾ï¼š$\\text{Loss} = \\text{Original Loss} + \\lambda_1 \\sum |w_i| + \\lambda_2 \\sum w_i^2$ ç‰¹ç‚¹ï¼šç»“åˆäº† L1 å’Œ L2 çš„ä¼˜ç‚¹ï¼Œæ—¢å¯ä»¥é€‰æ‹©ç‰¹å¾åˆå¯ä»¥é˜²æ­¢å‚æ•°è¿‡å¤§ã€‚ Dropout æ­£åˆ™åŒ–ï¼š å®šä¹‰ï¼šåœ¨æ¯æ¬¡è®­ç»ƒæ—¶éšæœºä¸¢å¼ƒä¸€éƒ¨åˆ†ç¥ç»å…ƒï¼Œä½¿å¾—æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¸ä¼šè¿‡äºä¾èµ–æŸäº›ç‰¹å®šçš„ç¥ç»å…ƒã€‚ ç‰¹ç‚¹ï¼šé€šè¿‡åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å¼•å…¥éšæœºæ€§ï¼Œå¢å¼ºæ¨¡å‹çš„é²æ£’æ€§ã€‚ æ­£åˆ™åŒ–çš„åŸç† å¤æ‚åº¦æƒ©ç½šï¼šé€šè¿‡å‘æŸå¤±å‡½æ•°ä¸­æ·»åŠ ä¸€ä¸ªè¡¨ç¤ºæ¨¡å‹å¤æ‚åº¦çš„é¡¹ï¼Œæ¨¡å‹åœ¨è®­ç»ƒæ—¶ä¸ä»…è¦æœ€å°åŒ–åŸå§‹æŸå¤±å‡½æ•°ï¼Œè¿˜è¦è€ƒè™‘æ¨¡å‹çš„å¤æ‚åº¦ã€‚ å‚æ•°çº¦æŸï¼šé™åˆ¶æ¨¡å‹å‚æ•°çš„å¤§å°æˆ–æ•°é‡ï¼Œé˜²æ­¢æ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šè¿‡åº¦æ‹Ÿåˆã€‚ å¢å¼ºæ³›åŒ–èƒ½åŠ›ï¼šé€šè¿‡æ§åˆ¶æ¨¡å‹çš„å¤æ‚åº¦ï¼Œæå‡æ¨¡å‹åœ¨æœªè§æ•°æ®ä¸Šçš„è¡¨ç°ã€‚ æ­£åˆ™åŒ–åœ¨æ¨¡å‹ä¸­çš„åº”ç”¨æ­£åˆ™åŒ–æŠ€æœ¯åœ¨è®¸å¤šæœºå™¨å­¦ä¹ æ¨¡å‹ä¸­åº”ç”¨å¹¿æ³›ï¼ŒåŒ…æ‹¬çº¿æ€§å›å½’ã€é€»è¾‘å›å½’ã€æ”¯æŒå‘é‡æœºï¼ˆSVMï¼‰ã€ç¥ç»ç½‘ç»œç­‰ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ­£åˆ™åŒ–å‚æ•°ï¼ˆå¦‚ Î»\\lambdaÎ»ï¼‰é€šå¸¸éœ€è¦é€šè¿‡äº¤å‰éªŒè¯ç­‰æ–¹æ³•è¿›è¡Œè°ƒä¼˜ï¼Œä»¥è·å¾—æœ€ä½³çš„æ¨¡å‹æ€§èƒ½ã€‚","tags":["AI","ç¥ç»ç½‘ç»œ","Ilya sutskeverâ€˜s 30  papers"]},{"title":"Ilya sutskever's approx 30 research papers about AI","path":"/17f5a37e/","content":"ä¹‹å‰æ— æ„ä¸­åˆ·åˆ°è¿™ä¸ªtwitter, æœ‰ç‚¹å¥½å¥‡è¿™30ç¯‡paper åˆ°åº•è®²äº†å•¥ï¼Œå­¦å®Œåˆ°åº•èƒ½çŸ¥é“ä»€ä¹ˆï¼Œæ‰€ä»¥å†³å®šè¯»ä¸€è¯»ã€‚ å¦‚ä½•è¯»ä½œä¸ºä¸€ä¸ªç®—æ³•å’ŒAIå°ç™½, çœŸçš„å­¦ä¼šåœ¨ä»Šå¤©90%å…³äºAI çš„å†…å®¹æœ‰ç‚¹è¶…å‡ºèƒ½åŠ›èŒƒç•´ï¼Œ æ‰€ä»¥æˆ‘çš„ç›®æ ‡æ˜¯è¯»æ‡‚è¿™äº›paperçš„æ–‡æœ¬å†…å®¹ï¼Œå»ºç«‹ä¸€ä¸ªæ•´ä½“çš„å¤§æ¡†æ¶å³å¯ã€‚ ä¾ç„¶å¯¹äºä¸€ä¸ªç®—æ³•å’ŒAIå°ç™½æ¥è¯´ï¼Œç›´æ¥é˜…è¯»paper,ã€ä¼šé‡åˆ°å¤§é‡è¯»ä¸æ‡‚çš„æ¦‚å¿µï¼Œ éœ€è¦æŸ¥è¯¢ç›¸å…³èµ„æ–™ï¼Œæˆ‘è§‰å¾—å¦‚æœä½ ä¹Ÿæ˜¯å°ç™½åŒæ—¶ä¹Ÿå¯¹è¿™äº›paper æ„Ÿå…´è¶£çš„è¯ï¼Œæˆ‘æŸ¥è¯¢çš„èµ„æ–™å’Œé˜…è¯»è¿‡ç¨‹å¯¹ä½ ä¹Ÿä¼šæœ‰å¸®åŠ©ï¼Œæ‰€ä»¥æˆ‘ä¼šæŠŠè¿™äº›å†…å®¹éƒ½è®°å½•ä¸‹æ¥ï¼Œä¾›ä½ å‚è€ƒã€‚ é˜…è¯»è®°å½•ç¥ç»ç½‘ç»œï¼ˆNeural Networksï¼‰ é€’å½’ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Networks, RNNsï¼‰ The Unreasonable Effectiveness of Recurrent Neural Networks Understanding LSTM Networks RECURRENT NEURAL NETWORK REGULARIZATION) 30 research papershttps://arc.net/folder/D0472A20-9C20-4D3F-B145-D2865C0A9FEE The Annotated Transformerç®€ä»‹ï¼šTransformer æ¨¡å‹æ³¨é‡Šç‰ˆï¼Œè¯¦ç»†è§£æäº† Transformer æ¨¡å‹çš„å†…éƒ¨ç»“æ„å’Œå·¥ä½œåŸç†ã€‚æ¨èç†ç”±ï¼šç†è§£ç°ä»£ NLP æ¨¡å‹çš„åŸºç¡€ã€‚ The First Law of Complexodynamicsç®€ä»‹ï¼šæ¢è®¨äº†å¤æ‚åŠ¨åŠ›å­¦çš„ç¬¬ä¸€å®šå¾‹ï¼Œè§£é‡Šäº†å¤æ‚ç³»ç»Ÿçš„æ¼”å˜è§„å¾‹ã€‚æ¨èç†ç”±ï¼šæä¾›äº†å…³äºå¤æ‚ç³»ç»Ÿçš„ä¸€äº›ç†è®ºåŸºç¡€ã€‚ The Unreasonable Effectiveness of Recurrent Neural Networksç®€ä»‹ï¼šè®¨è®ºäº† RNN åœ¨å¤„ç†åºåˆ—æ•°æ®æ—¶çš„æœ‰æ•ˆæ€§ã€‚æ¨èç†ç”±ï¼šå¸®åŠ©ç†è§£ RNN çš„åº”ç”¨å’Œä¼˜åŠ¿ã€‚ Understanding LSTM Networksç®€ä»‹ï¼šè¯¦ç»†ä»‹ç»äº† LSTM ç½‘ç»œçš„ç»“æ„å’ŒåŠŸèƒ½ã€‚æ¨èç†ç”±ï¼šLSTM æ˜¯ RNN çš„é‡è¦å˜ç§ï¼Œå¹¿æ³›åº”ç”¨äºåºåˆ—æ•°æ®å¤„ç†ã€‚ Recurrent Neural Network Regulationç®€ä»‹ï¼šæ¢è®¨äº† RNN çš„æ­£åˆ™åŒ–æ–¹æ³•ã€‚æ¨èç†ç”±ï¼šæ­£åˆ™åŒ–æ˜¯æé«˜æ¨¡å‹æ³›åŒ–èƒ½åŠ›çš„é‡è¦æ‰‹æ®µã€‚ Keeping Neural Networks Simple by Minimizing the Description Length of the Weightsç®€ä»‹ï¼šé€šè¿‡æœ€å°åŒ–æƒé‡æè¿°é•¿åº¦æ¥ç®€åŒ–ç¥ç»ç½‘ç»œã€‚æ¨èç†ç”±ï¼šæä¾›äº†ä¸€ç§ç®€åŒ–æ¨¡å‹çš„æ–¹æ³•ï¼Œæå‡æ¨¡å‹çš„è§£é‡Šæ€§ã€‚ Pointer Networksç®€ä»‹ï¼šä»‹ç»äº†æŒ‡é’ˆç½‘ç»œåŠå…¶åœ¨å¤„ç†ç¦»æ•£åºåˆ—é—®é¢˜ä¸Šçš„åº”ç”¨ã€‚æ¨èç†ç”±ï¼šæ‹“å±•äº†å¯¹åºåˆ—æ¨¡å‹çš„è®¤è¯†ã€‚ ImageNet Classification with Deep Convolutional Neural Networksç®€ä»‹ï¼šæ·±åº¦å·ç§¯ç¥ç»ç½‘ç»œåœ¨ ImageNet åˆ†ç±»ä¸Šçš„åº”ç”¨ã€‚æ¨èç†ç”±ï¼šç»å…¸è®ºæ–‡ï¼Œæ¨åŠ¨äº†æ·±åº¦å­¦ä¹ åœ¨è®¡ç®—æœºè§†è§‰é¢†åŸŸçš„é©å‘½ã€‚ Order Matters: Sequence to Sequence for Setsç®€ä»‹ï¼šè®¨è®ºäº†é¡ºåºåœ¨åºåˆ—åˆ°åºåˆ—æ¨¡å‹ä¸­çš„é‡è¦æ€§ã€‚æ¨èç†ç”±ï¼šæä¾›äº†å¯¹åºåˆ—æ¨¡å‹çš„æ·±åˆ»ç†è§£ã€‚ GPipe: Easy Scaling with Micro-Batch Pipeline Parallelismç®€ä»‹ï¼šä»‹ç»äº†é€šè¿‡å¾®æ‰¹æ¬¡æµæ°´çº¿å¹¶è¡Œå®ç°æ¨¡å‹æ‰©å±•çš„æ–¹æ³•ã€‚æ¨èç†ç”±ï¼šè§£å†³å¤§è§„æ¨¡æ¨¡å‹è®­ç»ƒçš„ç“¶é¢ˆé—®é¢˜ã€‚ Deep Residual Learning for Image Recognitionç®€ä»‹ï¼šæ·±åº¦æ®‹å·®å­¦ä¹ åœ¨å›¾åƒè¯†åˆ«ä¸­çš„åº”ç”¨ã€‚æ¨èç†ç”±ï¼šæ®‹å·®ç½‘ç»œæ˜¯æ·±åº¦å­¦ä¹ çš„ä¸€å¤§çªç ´ã€‚ Multi-Scale Context Aggregation by Dilated Convolutionsç®€ä»‹ï¼šé€šè¿‡è†¨èƒ€å·ç§¯å®ç°å¤šå°ºåº¦ä¸Šä¸‹æ–‡èšåˆã€‚æ¨èç†ç”±ï¼šåœ¨å¤„ç†å›¾åƒå’Œä¿¡å·æ—¶çš„æœ‰æ•ˆæ–¹æ³•ã€‚ Neural Message Passing for Quantum Chemistryç®€ä»‹ï¼šç¥ç»æ¶ˆæ¯ä¼ é€’åœ¨é‡å­åŒ–å­¦ä¸­çš„åº”ç”¨ã€‚æ¨èç†ç”±ï¼šå±•ç¤ºäº†ç¥ç»ç½‘ç»œåœ¨ç§‘å­¦è®¡ç®—ä¸­çš„æ½œåŠ›ã€‚ Attention Is All You Needç®€ä»‹ï¼šTransformer æ¨¡å‹çš„å¥ åŸºè®ºæ–‡ï¼Œæå‡ºäº†æ³¨æ„åŠ›æœºåˆ¶ã€‚æ¨èç†ç”±ï¼šç°ä»£ NLP æ¨¡å‹çš„åŸºçŸ³ã€‚ Neural Machine Translation By Jointly Learning To Align And Translateç®€ä»‹ï¼šé€šè¿‡è”åˆå­¦ä¹ å¯¹é½å’Œç¿»è¯‘çš„ç¥ç»æœºå™¨ç¿»è¯‘æ–¹æ³•ã€‚æ¨èç†ç”±ï¼šNMT çš„é‡è¦å‘å±•ã€‚ Identity Mappings in Deep Residual Networksç®€ä»‹ï¼šæ®‹å·®ç½‘ç»œä¸­çš„æ’ç­‰æ˜ å°„ã€‚æ¨èç†ç”±ï¼šå¸®åŠ©ç†è§£æ·±åº¦ç½‘ç»œçš„è®­ç»ƒã€‚ A simple neural network module for relational reasoningç®€ä»‹ï¼šç”¨äºå…³ç³»æ¨ç†çš„ç®€å•ç¥ç»ç½‘ç»œæ¨¡å—ã€‚æ¨èç†ç”±ï¼šå¢å¼ºæ¨¡å‹çš„æ¨ç†èƒ½åŠ›ã€‚ Variational Lossy Autoencoderç®€ä»‹ï¼šå˜åˆ†æœ‰æŸè‡ªç¼–ç å™¨çš„ä»‹ç»ã€‚æ¨èç†ç”±ï¼šæä¾›äº†ä¸€ç§æ–°é¢–çš„ç”Ÿæˆæ¨¡å‹ã€‚ Relational recurrent neural networksç®€ä»‹ï¼šå…³ç³»é€’å½’ç¥ç»ç½‘ç»œã€‚æ¨èç†ç”±ï¼šç»“åˆå…³ç³»æ¨ç†å’Œåºåˆ—å»ºæ¨¡çš„ä¼˜åŠ¿ã€‚ Quantifying the Rise and Fall of Complexity in Closed Systems: The Coffee Automatonç®€ä»‹ï¼šå®šé‡åˆ†æå°é—­ç³»ç»Ÿä¸­å¤æ‚æ€§çš„å…´è¡°ã€‚æ¨èç†ç”±ï¼šç†è®ºæ€§å¼ºï¼Œæœ‰åŠ©äºç†è§£å¤æ‚ç³»ç»Ÿã€‚ Neural Turing Machinesç®€ä»‹ï¼šç¥ç»å›¾çµæœºçš„æ¦‚å¿µå’Œåº”ç”¨ã€‚æ¨èç†ç”±ï¼šè¿æ¥ç¥ç»ç½‘ç»œå’Œè®¡ç®—ç†è®ºçš„é‡è¦å·¥ä½œã€‚ Deep Speech 2: End-to-End Speech Recognition in English and Mandarinç®€ä»‹ï¼šç«¯åˆ°ç«¯è¯­éŸ³è¯†åˆ«ç³»ç»Ÿ Deep Speech 2 çš„ä»‹ç»ã€‚æ¨èç†ç”±ï¼šè¯­éŸ³è¯†åˆ«é¢†åŸŸçš„é‡è¦è¿›å±•ã€‚ Scaling Laws for Neural Language Modelsç®€ä»‹ï¼šç¥ç»è¯­è¨€æ¨¡å‹çš„è§„æ¨¡æ³•åˆ™ã€‚æ¨èç†ç”±ï¼šå¸®åŠ©ç†è§£æ¨¡å‹æ‰©å±•çš„è§„å¾‹ã€‚ A Tutorial Introduction to the Minimum Description Length Principleç®€ä»‹ï¼šæœ€å°æè¿°é•¿åº¦åŸç†çš„æ•™ç¨‹ã€‚æ¨èç†ç”±ï¼šç†è®ºåŸºç¡€ï¼Œé€‚ç”¨äºå¤šç§æ¨¡å‹é€‰æ‹©é—®é¢˜ã€‚ Machine Super Intelligenceç®€ä»‹ï¼šæœºå™¨è¶…çº§æ™ºèƒ½çš„è®¨è®ºã€‚æ¨èç†ç”±ï¼šæœªæ¥ AI å‘å±•çš„é‡è¦å‚è€ƒã€‚ Kolmogorov Complexity and Algorithmic Randomnessç®€ä»‹ï¼šKolmogorov å¤æ‚æ€§å’Œç®—æ³•éšæœºæ€§çš„ä»‹ç»ã€‚æ¨èç†ç”±ï¼šè®¡ç®—å¤æ‚æ€§ç†è®ºçš„ç»å…¸ã€‚ CS231n Convolutional Neural Networks for Visual Recognitionç®€ä»‹ï¼šCS231n è¯¾ç¨‹ç½‘ç«™ï¼ŒåŒ…å«å·ç§¯ç¥ç»ç½‘ç»œçš„è¯¦ç»†æ•™ç¨‹ã€‚æ¨èç†ç”±ï¼šå…¨é¢çš„å­¦ä¹ èµ„æºï¼Œé€‚åˆå…¥é—¨å’Œè¿›é˜¶å­¦ä¹ ã€‚","tags":["AI","ç¥ç»ç½‘ç»œ","Ilya sutskeverâ€˜s 30  papers"]},{"title":"InnoDBäº‹åŠ¡-æŒä¹…æ€§çš„å®ç°,binglog & redo log","path":"/6cb5dc64/","content":"åœ¨MySQL InnoDB è¿™ä¸ªè¯­å¢ƒä¸‹ï¼Œ crash safeã€æ•°æ®ä¸ä¸¢å¤± éƒ½æŒ‡çš„æ˜¯äº‹åŠ¡çš„æŒä¹…æ€§ç‰¹æ€§ï¼Œå³äº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œåº”å½“ä¿è¯æ‰€æœ‰è¢«æˆåŠŸæäº¤çš„æ•°æ®ä¿®æ”¹éƒ½èƒ½å¤Ÿæ­£ç¡®åœ°è¢«æŒä¹…åŒ–ï¼Œä¸ä¸¢å¤±æ•°æ®, å³ä½¿å®•æœºä¹Ÿèƒ½å¤Ÿæ¢å¤æ•°æ® åœ¨InnoDB ä¸­ï¼ŒæŒä¹…æ€§ åŸºäºbinlog å’Œredo log å®ç°ï¼Œ ä¸”binlog ä¸redo log çš„å†™å…¥é€šè¿‡2PC åè°ƒ. 0 XA äº‹åŠ¡ï¼šbinlog å’Œredo log çš„ä¸¤é˜¶æ®µæäº¤ åœ¨MySQLä¸­ï¼ŒInnoDBå­˜å‚¨å¼•æ“ çš„ redo log å’ŒMySQLæœåŠ¡å™¨å±‚binlog ä¹‹é—´çš„ä¸€è‡´æ€§æ˜¯é€šè¿‡å†…éƒ¨çš„XAæœºåˆ¶ï¼ˆå³åˆ†å¸ƒå¼äº‹åŠ¡ï¼‰æ¥å®ç°çš„ï¼Œä»»ä½•ä¸€ä¸ªæ•°æ®å‡ºç°é—®é¢˜éƒ½ä¼šè¿›è¡Œä¼šæ»šã€‚ XAäº‹åŠ¡æ˜¯ä¸€ç§åˆ†å¸ƒå¼äº‹åŠ¡ã€‚é€šè¿‡ä¸¤é˜¶æ®µæäº¤åè®®å’ŒXAæ¥å£æ ‡å‡†ï¼Œäº‹åŠ¡ç®¡ç†å™¨å’Œèµ„æºç®¡ç†å™¨èƒ½å¤Ÿå¯é åœ°ååŒå·¥ä½œï¼Œå®ç°è·¨ç³»ç»Ÿçš„äº‹åŠ¡å¤„ç†ï¼Œç¡®ä¿å¤šä¸ªç‹¬ç«‹èµ„æºçš„ä¸€è‡´æ€§ã€‚ åœ¨binlog å’Œredo log çš„ä¸¤é˜¶æ®µæäº¤ï¼Œ binlog å……å½“åè°ƒè€…çš„è§’è‰²ã€‚ å…³äºXA äº‹åŠ¡å…·ä½“å¯åœ¨è¿™ç¯‡æ–‡ç« ä¸­æŸ¥çœ‹ binlog å’Œ redo log å„è‡ªå†™å…¥çš„è¿‡ç¨‹è¿˜æœ‰å¾ˆå¤šç»†èŠ‚ï¼Œæ¥ä¸‹æ¥è¿›è¡Œè®²è§£ 1 binlogbinlogæ˜¯ MySQL æœåŠ¡å™¨å±‚ä½¿ç”¨çš„æ—¥å¿—æ–‡ä»¶ï¼Œè®°å½•äº†æ‰€æœ‰ä¿®æ”¹æ•°æ®åº“å†…å®¹çš„SQLè¯­å¥ï¼ˆå¦‚ INSERT, UPDATE, DELETEï¼‰,ä¹Ÿè¢«ç§°ä¸ºé€»è¾‘æ—¥å¿—ã€‚ binlog ä¸»è¦ç”¨äºä¸»å¤‡å¤åˆ¶åŒæ­¥ã€å´©æºƒæ¢å¤ç­‰åŠŸèƒ½ã€‚ 1.1 binlog çš„ä¸‰ç§æ—¥å¿—æ ¼å¼ æ ¼å¼ å®šä¹‰ ä¼˜ç‚¹ ç¼ºç‚¹ Statement-Based Logging (SBL) è®°å½•æ‰§è¡Œçš„ SQL è¯­å¥æœ¬èº«ï¼Œè€Œä¸æ˜¯æ¯è¡Œæ•°æ®çš„å˜æ›´ã€‚ 1. ç©ºé—´æ•ˆç‡é«˜ï¼šé€šå¸¸å ç”¨æ›´å°‘çš„ç©ºé—´ï¼Œå› ä¸ºè®°å½•çš„æ˜¯ SQL è¯­å¥ã€‚ 2. æ˜“äºå®¡è®¡ï¼šç›´æ¥è®°å½• SQL è¯­å¥ï¼Œæ˜“äºé˜…è¯»å’Œç†è§£ã€‚ 1. éç¡®å®šæ€§è¡Œä¸ºï¼šå¯èƒ½åœ¨ä¸»ä»å¤åˆ¶ä¸­å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠåˆ°éç¡®å®šæ€§å‡½æ•°ï¼ˆå¦‚ NOW()ã€RAND()ï¼‰çš„ SQL è¯­å¥ã€‚2. å¤åˆ¶é”™è¯¯ï¼šæŸäº›ç‰¹å®šæƒ…å†µä¸‹å¯èƒ½å¼•èµ·ä»æœåŠ¡å™¨çš„å¤åˆ¶é”™è¯¯ã€‚ Row-Based Logging (RBL) è®°å½•æ•°æ®å˜æ›´å‰åçš„æ¯è¡Œæ•°æ®çš„å…·ä½“å˜åŒ–ï¼Œè€Œä¸æ˜¯æ‰§è¡Œçš„ SQL è¯­å¥ã€‚ 1. æ•°æ®ä¸€è‡´æ€§ï¼šåœ¨å¤åˆ¶è¿‡ç¨‹ä¸­æä¾›é«˜åº¦çš„æ•°æ®ä¸€è‡´æ€§ã€‚2. å®‰å…¨æ€§æ›´é«˜ï¼šä¸è®°å½• SQL è¯­å¥ï¼Œé™ä½äº† SQL æ³¨å…¥çš„é£é™©ã€‚ 1. ç©ºé—´å ç”¨å¤§ï¼šå› ä¸ºè®°å½•äº†æ¯ä¸€è¡Œçš„å˜åŒ–ï¼Œå¯èƒ½å¯¼è‡´ binlog æ–‡ä»¶è¿…é€Ÿå¢å¤§ã€‚2. å¯è¯»æ€§å·®ï¼šä¸è®°å½• SQL è¯­å¥ï¼Œå¯¹äºäººç±»å®¡è®¡ä¸å‹å¥½ã€‚ Mixed-Based Logging (MBL) ç»“åˆäº† SBL å’Œ RBL çš„ç‰¹ç‚¹ï¼Œæ ¹æ®æ“ä½œçš„ç±»å‹è‡ªåŠ¨é€‰æ‹©ä½¿ç”¨åŸºäºè¯­å¥çš„æ ¼å¼æˆ–åŸºäºè¡Œçš„æ ¼å¼è®°å½•ã€‚ 1. çµæ´»æ€§é«˜ï¼šæ ¹æ® SQL è¯­å¥çš„ç‰¹æ€§é€‰æ‹©æœ€åˆé€‚çš„æ—¥å¿—æ ¼å¼ã€‚2. å¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§ï¼šåœ¨ç¡®ä¿æ•°æ®ä¸€è‡´æ€§çš„åŒæ—¶è€ƒè™‘æ—¥å¿—å¤§å°å’Œæ€§èƒ½ã€‚ 1. é…ç½®å¤æ‚ï¼šéœ€è¦é€‚å½“é…ç½®ä»¥ç¡®ä¿æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚2. é¢„æµ‹æ€§å·®ï¼šè‡ªåŠ¨åˆ‡æ¢æ—¥å¿—æ ¼å¼å¯èƒ½ä½¿å¾—æ—¥å¿—çš„ç»“æœéš¾ä»¥é¢„æµ‹ã€‚ 1.2 binlogå†™å…¥è¿‡ç¨‹binlog çš„å†™å…¥é€»è¾‘æ¯”è¾ƒç®€å•ï¼šäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…ˆæŠŠæ—¥å¿—å†™åˆ° binlog cacheï¼Œäº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå†æŠŠ binlog cache å†™åˆ° binlog æ–‡ä»¶ä¸­ã€‚ 1.2.1 binlog cacheå¯¹äºæ¯ä¸ªå®¢æˆ·ç«¯ä¼šè¯ï¼ŒMySQL æœåŠ¡å™¨ä¸ºå…¶åˆ†é…ä¸€ä¸ª binlog cacheã€‚è¿™ä¸ªç¼“å­˜æ˜¯ç”¨æ¥ä¸´æ—¶å­˜å‚¨ä¸€ä¸ªäº‹åŠ¡ä¸­äº§ç”Ÿçš„æ‰€æœ‰ binlog äº‹ä»¶ã€‚ ä½†æ˜¯binlog cache åˆ·æ–°åˆ°ç£ç›˜æ—¶ å¤šä¸ªçº¿ç¨‹æ˜¯å…±å†™åŒä¸€ä»½ binlog æ–‡ä»¶ã€‚ å½“ä¸€ä¸ªæ–°äº‹åŠ¡å¼€å§‹æ—¶ï¼Œæ ¹æ®binlog æ—¥å¿—æ ¼å¼è®°å½• æ¯ä¸ªä¿®æ”¹SQL è¯­å¥åˆ°binlog cache ä¸­ 1.2.2 page cache ä¸ ç£ç›˜åˆ·æ–°æŒä¹…åŒ–å½“äº‹åŠ¡åˆ°è¾¾æäº¤é˜¶æ®µæ—¶ï¼Œé¦–å…ˆå°† binlog cache ä¸­çš„å†…å®¹ å†™å…¥åˆ°binlog æ–‡ä»¶ä¸­ï¼Œç„¶åæäº¤äº‹åŠ¡åˆ° InnoDBï¼Œå³ commit redo log ã€‚ æ³¨æ„ï¼Œè¿™é‡Œçš„å†™å…¥å¹¶ä¸æ˜¯ç›´æ¥å†™åˆ°åˆ°ç£ç›˜ï¼Œè€Œæ˜¯å…ˆå†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿçš„page cache, ç„¶åé€šè¿‡sync_binlog å‚æ•°æ¥å†³å®š ä½•æ—¶æŠŠæ•°æ®å†™å…¥åˆ° ç£ç›˜ã€‚ ç£ç›˜åˆ·æ–°é¢‘ç‡é€šè¿‡ sync_binlog é…ç½®å‚æ•°ï¼Œ sync_binlog=0 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ä¸ä¸»åŠ¨åˆ·æ–°ç£ç›˜ï¼Œç”±æ–‡ä»¶ç³»ç»Ÿè‡ªå·±æ§åˆ¶åˆ·ç›˜é¢‘ç‡ sync_binlog=1 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ä¼šå°† binlog cache ä¸­çš„å†…å®¹åˆ·æ–°åˆ°ç£ç›˜ sync_binlog=N(N&gt;1) çš„æ—¶å€™ï¼Œè¡¨ç¤ºç´¯ç§¯ N ä¸ªæäº¤äº‹åŠ¡åæ‰å°†å¤šä¸ªbinlog cacheä¸­çš„å†…å®¹åˆ·æ–°åˆ°ç£ç›˜ã€‚ å¯ä»¥çœ‹åˆ°å¦‚æœsync_binlogä¸è®¾ç½®ä¸º1 ï¼Œæœ‰æœ‰åŠ©äºæé«˜åˆ·ç›˜æ•ˆç‡ï¼Œ ä½†æ˜¯æœ‰ä¸¢å¤±binlog çš„é£é™©ã€‚ 1.2.3 binlog cache ä¸å¤Ÿç”¨æ€ä¹ˆåŠå¦‚æœbinlog cache å†™æ»¡äº†æ€ä¹ˆåŠï¼Ÿéœ€è¦æŠŠæ•°æ®æš‚å­˜åˆ°ç£ç›˜ æ¯ä¸ªäº‹åŠ¡çš„ binlog äº‹ä»¶é¦–å…ˆè¢«å†™å…¥åˆ° binlog cache ä¸­ï¼Œè¿™ä¸ªç¼“å­˜çš„å¤§å°ç”± binlog_cache_size ç³»ç»Ÿå˜é‡æ§åˆ¶ã€‚ å¦‚æœä¸€ä¸ªäº‹åŠ¡éå¸¸å¤§ï¼Œæ¶‰åŠå¤§é‡çš„æ•°æ®ä¿®æ”¹ï¼Œå¯¼è‡´binlog cacheä¸è¶³ä»¥å­˜å‚¨å½“å‰äº‹åŠ¡çš„æ‰€æœ‰äº‹ä»¶æ—¶ï¼ŒMySQLé‡‡ç”¨çš„å¤„ç†æœºåˆ¶æ˜¯å°†ç¼“å­˜ä¸­çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜ä¸Šçš„ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ã€‚è¿™ä¸€è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š æ£€æµ‹ç¼“å­˜æº¢å‡ºï¼šå½“è¯•å›¾å‘binlog cacheä¸­å†™å…¥æ•°æ®ï¼Œè€Œç¼“å­˜ç©ºé—´ä¸è¶³ä»¥å®¹çº³æ›´å¤šæ•°æ®æ—¶ï¼Œå°†è§¦å‘æº¢å‡ºå¤„ç†æœºåˆ¶ã€‚ æ•°æ®å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼šMySQLå°†å½“å‰binlog cacheä¸­çš„æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªä¸´æ—¶æ–‡ä»¶é€šå¸¸ä½äºMySQLçš„æ•°æ®ç›®å½•ä¸‹ï¼Œå…·æœ‰å”¯ä¸€æ ‡è¯†ï¼Œç¡®ä¿æ•°æ®çš„éš”ç¦»å’Œå®‰å…¨ã€‚ æ¸…ç©ºbinlog cacheï¼šå°†æ•°æ®å†™å…¥ä¸´æ—¶æ–‡ä»¶åï¼Œbinlog cacheä¼šè¢«æ¸…ç©ºï¼Œä¸ºæ¥ä¸‹æ¥çš„æ—¥å¿—æ•°æ®è…¾å‡ºç©ºé—´ã€‚ ç»§ç»­äº‹åŠ¡æ—¥å¿—çš„è®°å½•ï¼šäº‹åŠ¡ç»§ç»­æ‰§è¡Œï¼Œæ–°çš„æ—¥å¿—äº‹ä»¶ä¼šå†æ¬¡è¢«è®°å½•åˆ°ç°åœ¨å·²ç»è¢«æ¸…ç©ºçš„binlog cacheä¸­ã€‚ äº‹åŠ¡æäº¤ï¼šäº‹åŠ¡å¦‚æœæœ€ç»ˆè¢«æäº¤ï¼ŒMySQLä¼šå°†ä¸´æ—¶æ–‡ä»¶ä¸­çš„æ—¥å¿—æ•°æ®ä»¥åŠç°åœ¨binlog cacheä¸­çš„æ•°æ®ä¸€å¹¶å†™å…¥åˆ°å…¨å±€çš„binlogæ–‡ä»¶ä¸­ã€‚å¦‚æœäº‹åŠ¡å›æ»šï¼Œåˆ™ä¸´æ—¶æ–‡ä»¶å’Œbinlog cacheä¸­çš„æ•°æ®éƒ½å°†è¢«ä¸¢å¼ƒã€‚ 1.3 xidXIDï¼ˆTransaction Identifierï¼‰ å¯ä»¥ç†è§£æˆæ—¶MySQL server å±‚çš„äº‹åŠ¡å”¯ä¸€æ ‡è¯†ã€‚ MySQLæœåŠ¡å™¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªå…¨å±€äº‹åŠ¡IDè®¡æ•°å™¨ï¼Œæ¯ä¸ªæ–°äº‹åŠ¡éƒ½ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„IDã€‚è¯¥è®¡æ•°å™¨åœ¨å†…å­˜ä¸­é€’å¢ï¼Œä¿è¯æ¯ä¸ªäº‹åŠ¡IDåœ¨å®ä¾‹ä¸­æ˜¯å”¯ä¸€çš„ã€‚ å½“ä¸€ä¸ªæ–°äº‹åŠ¡å¼€å§‹æ—¶ï¼ŒMySQLæœåŠ¡å™¨å±‚ä¼šä»å…¨å±€è®¡æ•°å™¨ä¸­è·å–ä¸€ä¸ªæ–°çš„äº‹åŠ¡IDï¼Œå°†å…¶èµ‹äºˆè¯¥äº‹åŠ¡ï¼Œå¹¶å­˜å‚¨åœ¨è¯¥äº‹åŠ¡çš„ä¸Šä¸‹æ–‡ä¸­ã€‚ 2 redo logredo logæ˜¯ InnoDB å­˜å‚¨å¼•æ“ç‰¹æœ‰çš„æ—¥å¿—æ–‡ä»¶ï¼Œç”¨äºè®°å½•å¯¹æ•°æ®åº“åšå‡ºçš„æ›´æ”¹å‰çš„æ•°æ®é¡µçŠ¶æ€,ä¹Ÿè¢«ç§°ä½œç‰©ç†æ—¥å¿—ï¼Œç¡®ä¿åœ¨æ•°æ®åº“ç³»ç»Ÿå‘ç”Ÿå´©æºƒåèƒ½å¤Ÿæ¢å¤è¿™äº›æ›´æ”¹ã€‚è®°å½•å†…å®¹ï¼šRedo log è®°å½•çš„æ˜¯æ•°æ®é¡µä¿®æ”¹çš„ç‰©ç†æ“ä½œï¼Œè€Œéå…·ä½“çš„ SQL è¯­å¥ã€‚ å¾ªç¯ä½¿ç”¨ï¼šRedo log æ˜¯å›ºå®šå¤§å°çš„ï¼Œé€šå¸¸é…ç½®ä¸ºä¸€ç»„æ–‡ä»¶ï¼Œå·¥ä½œåœ¨å¾ªç¯å†™å…¥çš„æ–¹å¼ã€‚ å´©æºƒæ¢å¤ï¼šç³»ç»Ÿé‡å¯åï¼ŒInnoDB é€šè¿‡å›æ”¾ redo log æ¥æ¢å¤æœªå®Œæˆçš„äº‹åŠ¡ï¼Œç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚ æé«˜æ€§èƒ½ï¼šRedo log å…è®¸ InnoDB åœ¨äº‹åŠ¡æäº¤æ—¶ä¸å¿…å°†æ‰€æœ‰æ•°æ®é¡µå†™å›ç£ç›˜ï¼Œåªéœ€ç¡®ä¿ redo log å·²è¢«å†™å…¥ç£ç›˜ã€‚ è®°å½•çš„æ˜¯æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹ã€‚ ä¸è®ºæ•°æ®é¡µæ˜¯å¦åœ¨buffer pool ä¸­ï¼Œ redo log éƒ½è¦è®°å½•ä¿®æ”¹ï¼Œ å› ä¸ºä¸è®°ä¸èƒ½ä¿è¯crash safe. ä¿å­˜è‡ªå¢å€¼ 2.1 ä¸ºä»€ä¹ˆè¦è®°å½•redo log2.1.1 buffer poolMySQL ä¸ºäº†å®ç°é«˜æ€§èƒ½ï¼Œæ˜¯ä¸å¯èƒ½æ¯æ¬¡éƒ½ä»ç£ç›˜è¯»æ•°æ®æˆ–è€…æŠŠå¯¹æ•°æ®çš„ä¿®æ”¹æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šçš„,æ‰€ä»¥ InnoDB ç”³è¯·äº†ä¸€å—è¿ç»­çš„å†…å­˜ï¼Œç”¨äºå­˜å‚¨ä»ç£ç›˜ä¸Šè¯»å–çš„pages, è¿™ä¸ªå†…å­˜å°±æ˜¯buffer poolã€‚ buffer pool æœ‰ä¸€å—å†…å­˜å«åšï¼Œchange buffer ç”¨äºæš‚å­˜å¯¹æ•°æ®çš„ä¿®æ”¹ é‚£ä¹ˆåœ¨ä¿®æ”¹æ•°æ®æ—¶ï¼Œå°±ä¼šé‡åˆ°ä¸¤ç§æƒ…å†µ æ•°æ®æ‰€åœ¨çš„page åœ¨buffer pool ä¸­ï¼Œ å°±ä¼šç›´æ¥æ›´æ–°page æ•°æ®æ‰€åœ¨çš„page ä¸åœ¨buffer pool ä¸­ï¼Œ å¦‚æœä¸éœ€è¦åŠ è½½å¯¹åº”page, å°±ä¼šå…ˆæŠŠå¯¹æ•°æ®çš„ä¿®æ”¹å…ˆè®°åœ¨change buffer ä¸­ ä¸è®ºæ˜¯buffer pool, è¿˜æ˜¯ buffer pool ä¸­çš„change buffer, éƒ½æ˜¯å†…å­˜ï¼Œä¸€æ—¦å‘ç”Ÿå®•æœºï¼Œé‚£å°±æ•°æ®çš„ä¿®æ”¹çš„ä¿®æ”¹å°±ä¼šä¸¢å¤±ï¼Œæ­¤æ—¶å°±è¿èƒŒäº†äº‹åŠ¡çš„æŒä¹…æ€§ã€‚ ä¸ºäº†èƒ½æŠŠä¿®æ”¹è¿‡çš„æ•°æ®æŒä¹…åŒ–åˆä¸å½±å“æ€§èƒ½ï¼ŒInnoDB ç»™å‡ºçš„æ–¹æ¡ˆæ˜¯ä¼˜å…ˆæŠŠä¿®æ”¹æ“ä½œè®°ä¸‹æ¥å¹¶æŒä¹…åŒ–ï¼Œ äº‹åŠ¡æäº¤åï¼Œä¸‡ä¸€å®•æœºä¸¢å¤±äº†buffer pool ä¸­å·²ä¿®æ”¹ä½†æ˜¯æœªæŒä¹…åŒ–çš„å†…å®¹ï¼Œå°±å¯ä»¥æ ¹æ®æŒä¹…åŒ–çš„ä¿®æ”¹æ“ä½œé‡æ–°å¾—åˆ°ä¿®æ”¹åæ•°æ®ã€‚ è¿™é‡Œè®°å½•ä¸‹æ¥çš„ä¿®æ”¹æ“ä½œå°±æ˜¯redo log, è€Œè¿™ç§å…ˆè®°å½•ä¿®æ”¹æ“ä½œï¼Œå†è®°å½•ä¿®æ”¹åçš„æŠ€æœ¯å«åšWALã€‚ 2.1.2 WALWALï¼ˆWrite-Ahead Loggingï¼‰æ˜¯ä¸€ç§åœ¨æ•°æ®åº“ç³»ç»Ÿä¸­å¹¿æ³›é‡‡ç”¨çš„æ—¥å¿—ç®¡ç†æŠ€æœ¯ï¼Œç”¨äºä¿è¯æ•°æ®åº“çš„äº‹åŠ¡æŒä¹…æ€§å’Œæ¢å¤èƒ½åŠ›ã€‚ å®ƒçš„å…³é”®ç‚¹å°±æ˜¯å…ˆå†™æ—¥å¿—ï¼Œå†å†™çœŸæ­£çš„æ•°æ®ã€‚ redo log ç›´æ¥åº”ç”¨äº† WAL æŠ€æœ¯ï¼Œç¡®ä¿åœ¨ä»»ä½•æ•°æ®è¢«å†™å…¥æ•°æ®åº“é¡µä¹‹å‰ï¼Œç›¸åº”çš„æ—¥å¿—ä¿¡æ¯ï¼ˆå¦‚æ•°æ®é¡µçš„ä¿®æ”¹ï¼‰å…ˆè¢«å†™å…¥åˆ° redo log ä¸­ã€‚ æ€»çš„æ¥è¯´WAL æŠ€æœ¯çš„ä¼˜åŠ¿æœ‰ä»¥ä¸‹3é¡¹ï¼Œ æ¢å¤èƒ½åŠ›ï¼šWAL æä¾›äº†å¼ºå¤§çš„æ•°æ®æ¢å¤èƒ½åŠ›ã€‚åœ¨å‘ç”Ÿç³»ç»Ÿæ•…éšœåï¼Œå¯ä»¥åˆ©ç”¨æ—¥å¿—æ–‡ä»¶ä¸­çš„è®°å½•æ¥é‡åšæˆ–æ’¤é”€äº‹åŠ¡ï¼Œæ¢å¤åˆ°æœ€åä¸€è‡´çš„çŠ¶æ€ã€‚ æ€§èƒ½ä¼˜åŒ–ï¼šé€šè¿‡å°†å¯¹ç£ç›˜æ•°æ®çš„éšæœºå†™è½¬æ¢ä¸ºé¡ºåºå†™ ï¼Œ åŒæ—¶åˆ©ç”¨ ç»„æäº¤ ï¼ŒWAL å¯ä»¥æ˜¾è‘—æé«˜æ•°æ®åº“çš„å†™æ€§èƒ½ã€‚ äº‹åŠ¡åŸå­æ€§å’ŒæŒä¹…æ€§ï¼šWAL é€šè¿‡ç¡®ä¿æ‰€æœ‰æ—¥å¿—è®°å½•åœ¨å®é™…æ•°æ®å†™å…¥å‰è¢«æäº¤åˆ°ç£ç›˜ï¼Œä»è€Œæ”¯æŒæ•°æ®åº“äº‹åŠ¡çš„åŸå­æ€§å’ŒæŒä¹…æ€§ã€‚ 2.2 redo log è®°å½•çš„å†…å®¹ä¹‹æ‰€ä»¥è¯´redo log æ˜¯ç‰©ç†æ—¥å¿—ï¼Œ æ˜¯å› ä¸ºå…¶è®°å½•äº†å¯¹ç‰¹å®šæ•°æ®page æ•°æ®çš„ä¿®æ”¹ã€‚è¯¥ä¾‹å­æ¥è‡ªæå®¢ä¸“æ ã€ŠMySQL å®æˆ˜45è®²ã€‹ 12mysql&gt; create table t(ID int primary key, c int);mysql&gt; insert into t(id,k) values(id1,k1),(id2,k2); è¿™æ¡æ›´æ–°è¯­å¥åšäº†å¦‚ä¸‹çš„æ“ä½œï¼ˆæŒ‰ç…§å›¾ä¸­çš„æ•°å­—é¡ºåºï¼‰ï¼š Page 1 åœ¨å†…å­˜ä¸­ï¼Œç›´æ¥æ›´æ–°å†…å­˜ï¼› Page 2 æ²¡æœ‰åœ¨å†…å­˜ä¸­ï¼Œå°±åœ¨å†…å­˜çš„ change buffer åŒºåŸŸï¼Œè®°å½•ä¸‹â€œæˆ‘è¦å¾€ Page 2 æ’å…¥ä¸€è¡Œâ€è¿™ä¸ªä¿¡æ¯ å°†ä¸Šè¿°ä¸¤ä¸ªåŠ¨ä½œè®°å…¥ redo log ä¸­ï¼ˆå›¾ä¸­ 3 å’Œ 4ï¼‰ã€‚ Redo logä¸æ˜¯è®°å½•æ•°æ®é¡µâ€œæ›´æ–°ä¹‹åçš„çŠ¶æ€â€ï¼Œè€Œæ˜¯è®°å½•è¿™ä¸ªé¡µ â€œåšäº†ä»€ä¹ˆæ”¹åŠ¨â€ã€‚ 2.3 redo log å†™å…¥è¿‡ç¨‹# 23 | MySQLæ˜¯æ€ä¹ˆä¿è¯æ•°æ®ä¸ä¸¢çš„ï¼Ÿ redo log çš„å†™å…¥æœºåˆ¶-redo log buffer redo log çš„å†™å…¥æœºåˆ¶å’Œ binlog ç±»å‹ï¼Œ éœ€è¦ç»å† MySQL ç³»ç»Ÿå†…å­˜cache ï¼Œ redo lo buffer æ–‡ä»¶ç³»ç»Ÿpage cache åˆ·æ–°æŒä¹…åŒ–åˆ°ç£ç›˜ 2.3.1 redo log bufferadd(id1,k1) to page1, new change buffer item add(id2,k2) to page2 éƒ½æ˜¯å…ˆå†™å…¥redo log buffer ä¸­ ç›¸æ¯”è¾ƒ æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±ä¸€å—ç‹¬ç«‹çš„ binlog cache ï¼Œ è€Œ redo log buffer æ˜¯å…¨å±€å…±ç”¨çš„ã€‚ 2.3.2 redo logæŒä¹…åŒ–åˆ°ç£ç›˜äº‹åŠ¡æäº¤ï¼Œæ‰§è¡Œcommit redo log åï¼Œä¼šè§¦å‘redo log buffer ä¸­å†…å®¹å†™å…¥åˆ°redo log ä¸­ã€‚ ä¸ºäº†æ§åˆ¶ redo log çš„å†™å…¥ç­–ç•¥ï¼ŒInnoDB æä¾›äº† innodb_flush_log_at_trx_commit å‚æ•°ï¼Œå®ƒæœ‰ä¸‰ç§å¯èƒ½å–å€¼ï¼š è®¾ç½®ä¸º 0 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½åªæ˜¯æŠŠ redo log ç•™åœ¨ redo log buffer ä¸­ ; è®¾ç½®ä¸º 1 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½å°† redo log ç›´æ¥æŒä¹…åŒ–åˆ°ç£ç›˜ï¼› è®¾ç½®ä¸º 2 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½åªæ˜¯æŠŠ redo log å†™åˆ° page cacheã€‚ æ‰€ä»¥æƒ³è¦ç¡®ä¿MySQLå¼‚å¸¸é‡å¯ä¹‹åredo log æ•°æ®ä¸ä¸¢å¤±ï¼Œinnodb_flush_log_at_trx_commit è¿™ä¸ªå‚æ•° å»ºè®®è®¾ç½®æˆ1. å‰é¢åœ¨binlogéƒ¨åˆ†è¯´åˆ°ï¼Œ åœ¨äº‹åŠ¡æäº¤å‰ï¼Œäº‹åŠ¡binlog æ˜¯ä¸ä¼šè¢«å†™å…¥åˆ°çœŸæ­£çš„binlog æ–‡ä»¶ä¸­çš„ã€‚ redo log ä¸ä¸€æ ·ï¼Œåœ¨äº‹åŠ¡æäº¤å‰ï¼Œredo log æœ‰å¯èƒ½å¤‡æŒä¹…åŒ–ç£ç›˜ã€‚æœ‰ä»¥ä¸‹3ç§æƒ…å†µ åå°çº¿ç¨‹,æ¯éš” 1 ç§’ï¼Œå°±ä¼šæŠŠ redo log buffer ä¸­çš„æ—¥å¿—ï¼Œè°ƒç”¨ write å†™åˆ°æ–‡ä»¶ç³»ç»Ÿçš„ page cacheï¼Œç„¶åè°ƒç”¨ fsync æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚ï¼Œ redo log buffer å ç”¨çš„ç©ºé—´å³å°†è¾¾åˆ° innodb_log_buffer_size ä¸€åŠçš„æ—¶å€™ï¼Œåå°çº¿ç¨‹ä¼šä¸»åŠ¨å†™ç›˜ã€‚æ³¨æ„ï¼Œç”±äºè¿™ä¸ªäº‹åŠ¡å¹¶æ²¡æœ‰æäº¤ï¼Œæ‰€ä»¥è¿™ä¸ªå†™ç›˜åŠ¨ä½œåªæ˜¯ writeï¼Œè€Œæ²¡æœ‰è°ƒç”¨ fsyncï¼Œä¹Ÿå°±æ˜¯åªç•™åœ¨äº†æ–‡ä»¶ç³»ç»Ÿçš„ page cacheã€‚ å¹¶è¡Œçš„äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œé¡ºå¸¦å°†è¿™ä¸ªäº‹åŠ¡çš„ redo log buffer æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚å¦‚æœ innodb_flush_log_at_trx_commit è®¾ç½®çš„æ˜¯ 1ï¼Œé‚£ä¹ˆæŒ‰ç…§è¿™ä¸ªå‚æ•°çš„é€»è¾‘ï¼Œ è¦æŠŠ redo log buffer é‡Œçš„æ—¥å¿—å…¨éƒ¨æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚è¿™æ—¶å€™ï¼Œå°±ä¼šå¸¦ä¸Šæœªæäº¤äº‹åŠ¡ åœ¨ redo log buffer é‡Œçš„æ—¥å¿—ä¸€èµ·æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚2.3.3 2PCçš„ç»†åŒ–è¿‡ç¨‹ 2.4 æ—¥å¿—æ–‡ä»¶ç»„InnoDB çš„ redo log æ˜¯ä»¥æ—¥å¿—æ–‡ä»¶ç»„çš„å½¢å¼ç»„ç»‡çš„ã€‚ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ç»„é€šå¸¸åŒ…å«ä¸¤ä¸ªæˆ–æ›´å¤šçš„æ—¥å¿—æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶åœ¨ç‰©ç†ä¸Šæ˜¯è¿ç»­çš„ï¼Œå¹¶ä¸”å¾ªç¯ä½¿ç”¨ã€‚å½“ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶å†™æ»¡åï¼ŒInnoDB ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ç»§ç»­å†™å…¥ã€‚å½“æœ€åä¸€ä¸ªæ–‡ä»¶å†™æ»¡åï¼Œå®ƒä¼šå›åˆ°ç¬¬ä¸€ä¸ªæ–‡ä»¶å¹¶å¼€å§‹è¦†ç›–æ—§çš„æ—¥å¿—è®°å½•ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œç¯å½¢å†™å…¥â€ã€‚ 2.5 LSNLSNï¼ˆLog Sequence Numberï¼‰,æ—¥å¿—åºåˆ—å·,æ˜¯ä¸€ä¸ªä¸æ–­å¢é•¿çš„å…¨å±€å˜é‡ï¼Œ ç”¨æ¥è®°å½•å½“å‰redo log æ–‡ä»¶ä¸­ å·²ç»å†™å…¥çš„æ—¥å¿—é‡ï¼Œ å•ä½æ˜¯å­—èŠ‚ã€‚ å›¾ç‰‡ä¸­çš„write pos LSN æŒ‡å½“å‰å·²ç»äº§ç”Ÿçš„çš„æ—¥å¿—é‡ï¼Œéšç€æ›´å¤šçš„äº‹åŠ¡æ•°æ®è¢«å†™å…¥ï¼Œwrite pos LSN ä¼šä¸æ–­å¢åŠ  checkpoint LSN æ˜¯redo log ä¸­çš„ä¸€ä¸ªä½ç½®ï¼Œè¡¨ç¤ºæ‰€æœ‰ä¹‹å‰çš„æ—¥å¿—è®°å½•éƒ½å·²ç»è¢«åº”ç”¨ï¼ˆæˆ–è¯´æ˜¯â€œåˆ·æ–°â€ï¼‰åˆ°äº†ç£ç›˜çš„æ•°æ®é¡µä¸Šï¼Œå› æ­¤ï¼Œä»è¿™ä¸ªä½ç½®ä»¥å‰çš„æ—¥å¿—æ•°æ®å¯ä»¥å®‰å…¨åœ°è¢«è¦†å†™ï¼Œ ä¸ä¼šå‡ºç°æ•°æ®ä¸¢å¤±çš„æƒ…å†µã€‚ redo log ä¼šæœ‰å¤šä¸ªæ£€æŸ¥ç‚¹ write pos LSN å’Œ checkpoint LSNä¹‹é—´ç©ºç€çš„éƒ¨åˆ†ï¼Œå¯ä»¥ç”¨æ¥è®°å½•æ–°çš„æ“ä½œã€‚ å¦‚æœ write pos LSN èµ¶ä¸Šäº†æœ€ä¸€ä¸ªcheckpoint LSN ä½ç½®ï¼Œè¿™æ„å‘³ç€ redo log çš„ç©ºé—´ä¸è¶³ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®åº“æ“ä½œåœé¡¿ï¼Œå› ä¸ºç³»ç»Ÿéœ€è¦ç­‰å¾…è¶³å¤Ÿçš„æ—¥å¿—ç©ºé—´æ¥è®°å½•æ–°çš„äº‹åŠ¡æ•°æ®ã€‚ 2.6 ç»„æäº¤å‰é¢æè¿‡ï¼Œredo log æå‡æ€§èƒ½ï¼Œä¸€ä¸ªæ˜¯æŠŠå¯¹ç£ç›˜çš„éšæœºå†™è½¬æ¢æˆäº†é¡ºåºå†™ï¼Œä¸€ä¸ªæ˜¯ç»„æäº¤æœºåˆ¶ã€‚ ç»„æäº¤æœºåˆ¶ï¼ˆGroup Commitï¼‰æ˜¯ä¸€ç§é€šè¿‡åˆå¹¶å¤šä¸ªäº‹åŠ¡çš„æ—¥å¿—æäº¤æ“ä½œæ¥æé«˜I/Oæ•ˆç‡çš„ç­–ç•¥ã€‚è¿™ä¸€æœºåˆ¶åŸºäºLSNï¼ˆLog Sequence Numberï¼Œæ—¥å¿—åºåˆ—å·ï¼‰æ¥è¿½è¸ªå’Œç®¡ç†æ—¥å¿—æäº¤ã€‚ ä»¥ä¸‹å›¾ä¸ºä¾‹è§£é‡Š äº‹åŠ¡trx1å¼€å§‹ï¼š trx1è¿›å…¥äº‹åŠ¡é˜Ÿåˆ—å¹¶è¢«é€‰ä¸ºç»„çš„é¢†å¯¼è€…ï¼Œæ—¥å¿—è®°å½•çš„LSNå¼€å§‹å¢åŠ ã€‚ äº‹åŠ¡trx2å’Œtrx3åŠ å…¥ åœ¨trx1è¿›å…¥é˜Ÿåˆ—ä¹‹åï¼Œtrx2å’Œtrx3ç´§éšå…¶åè¿›å…¥æäº¤é˜Ÿåˆ—ã€‚ LSNæ›´æ–°åˆ°160ï¼š éšç€trx2å’Œtrx3çš„æ—¥å¿—å†™å…¥ç¼“å†²åŒºï¼Œæ•´ä¸ªç»„çš„æœ€åä¸€ä¸ªæ—¥å¿—åºåˆ—å·LSNå˜ä¸º160ã€‚ é¢†å¯¼è€…trx1æ‰§è¡Œå†™ç›˜ï¼š trx1ä½œä¸ºç»„çš„é¢†å¯¼è€…ï¼Œæºå¸¦LSN=160å»æ‰§è¡Œä¸€æ¬¡æ€§æ—¥å¿—å†™ç›˜ï¼ˆfsyncï¼‰æ“ä½œã€‚ å†™ç›˜å®Œæˆï¼š trx1çš„fsyncæ“ä½œå®Œæˆåï¼Œæ‰€æœ‰LSN &lt;= 160çš„æ—¥å¿—è®°å½•éƒ½è¢«æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚ äº‹åŠ¡è¿”å›æäº¤æˆåŠŸï¼š trx1ã€trx2å’Œtrx3éƒ½æ ‡è®°ä¸ºæäº¤æˆåŠŸå¹¶ä»æäº¤é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚ 3 äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„binlog å’Œredolog å’Œundo logä¸‹é¢å°†ç»“åˆMySQL çš„é€»è¾‘æ¶æ„ å’Œå…·ä½“SQL , æ¥å…·ä½“åœ°çœ‹ä¸€ä¸‹binlog å’Œredo log çš„å†™å…¥ SQL12mysql&gt; create table T(ID int primary key, c int);mysql&gt; update T set c=c+1 where ID=2; ç»“æœMySQL çš„é€»è¾‘æ¶æ„ï¼Œ è¯¥update sqlçš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ æ‰§è¡Œå™¨å…ˆæ‰¾InnoDBå– ID=2 è¿™ä¸€è¡Œã€‚ID æ˜¯ä¸»é”®ï¼Œå¼•æ“ç›´æ¥ç”¨æ ‘æœç´¢æ‰¾åˆ°è¿™ä¸€è¡Œã€‚å¦‚æœ ID=2 è¿™ä¸€è¡Œæ‰€åœ¨çš„æ•°æ®é¡µæœ¬æ¥å°±åœ¨buffer pool ä¸­ï¼Œå°±ç›´æ¥è¿”å›ç»™æ‰§è¡Œå™¨ï¼›å¦åˆ™ï¼Œéœ€è¦å…ˆä»ç£ç›˜è¯»å…¥buffer poolï¼Œç„¶åå†è¿”å›ã€‚ æ‰§è¡Œå™¨æ‹¿åˆ°å¼•æ“ç»™çš„è¡Œæ•°æ®ï¼ŒæŠŠè¿™ä¸ªå€¼åŠ ä¸Š 1ï¼Œæ¯”å¦‚åŸæ¥æ˜¯ Nï¼Œç°åœ¨å°±æ˜¯ N+1ï¼Œå¾—åˆ°æ–°çš„ä¸€è¡Œæ•°æ®ï¼Œå†è°ƒç”¨å¼•æ“æ¥å£å†™å…¥è¿™è¡Œæ–°æ•°æ®ã€‚ InnoDBå¼•æ“è®°å½•è¯¥è¡Œæ•°æ®çš„undo log, ç„¶åæ–°æ•°æ®æ›´æ–°åˆ°å†…å­˜ä¸­ï¼Œå¦‚æœæ•°æ®æœ¬æ¥å°±åœ¨å†…å­˜ä¸­ï¼Œåˆ™ç›´æ¥ä¿®æ”¹æ•°æ®é¡µï¼Œå¦‚æœä¸å†å†…å­˜ä¸­ï¼Œåˆ™å°†ä¿®æ”¹è®°å½•åœ¨change buffer ä¸­ï¼ŒåŒæ—¶å°†è¿™ä¸ªæ›´æ–°æ“ä½œè®°å½•åˆ° redo log é‡Œé¢ï¼Œæ­¤æ—¶ redo log å¤„äº prepare çŠ¶æ€ã€‚ ç„¶åå‘ŠçŸ¥æ‰§è¡Œå™¨æ‰§è¡Œå®Œæˆäº†ï¼Œéšæ—¶å¯ä»¥æäº¤äº‹åŠ¡ã€‚æ‰§è¡Œå™¨ç”Ÿæˆè¿™ä¸ªæ“ä½œçš„ binlogï¼Œå¹¶æŠŠ binlog å†™å…¥ç£ç›˜ã€‚ æ‰§è¡Œå™¨è°ƒç”¨å¼•æ“çš„æäº¤äº‹åŠ¡æ¥å£ï¼Œå¼•æ“æŠŠåˆšåˆšå†™å…¥çš„ redo log æ”¹æˆæäº¤ï¼ˆcommitï¼‰çŠ¶æ€ï¼Œæ›´æ–°å®Œæˆã€‚æ ¹æ® innodb_flush_log_at_trx_commit å†³å®šredo log æ˜¯å¦æŒä¹…åŒ–åˆ°ç£ç›˜ buffer pool ä¸­å¯¹æ•°æ®é¡µçš„æ›´æ–° ,ç­‰å¾…è„é¡µåˆ·çº¿æ“ä½œæŒä¹…åŒ–åˆ°ç£ç›˜ 14.prepareé˜¶æ®µ,å°†äº‹åŠ¡çš„xidå†™å…¥ï¼Œå°†binlog_cacheé‡Œçš„è¿›è¡Œflushä»¥åŠsyncæ“ä½œ(å¤§äº‹åŠ¡çš„è¯è¿™æ­¥éå¸¸è€—æ—¶)15.commité˜¶æ®µï¼Œç”±äºä¹‹å‰è¯¥äº‹åŠ¡äº§ç”Ÿçš„redo logå·²ç»syncåˆ°ç£ç›˜äº†ã€‚æ‰€ä»¥è¿™æ­¥åªæ˜¯åœ¨redo logé‡Œæ ‡è®°commit 4 å´©æºƒæ¢å¤çš„é€»è¾‘å´©æºƒæ¢å¤è¿‡ç¨‹ä¸­ï¼ŒInnoDB ä¼šä»æœ€è¿‘çš„ checkpoint LSNå¼€å§‹ï¼Œåº”ç”¨ redo log ä¸­çš„æ›´æ”¹ï¼Œç›´åˆ°è¾¾åˆ°å´©æºƒæ—¶çš„ write pos LSNï¼Œä»¥æ­¤æ¥æ¢å¤æ•°æ®åº“åˆ°æœ€åä¸€æ¬¡æäº¤çš„çŠ¶æ€ã€‚ çœ‹ä¸€ä¸‹å´©æºƒæ¢å¤æ—¶çš„åˆ¤æ–­è§„åˆ™ å¦‚æœ redo log é‡Œé¢çš„äº‹åŠ¡æ˜¯å®Œæ•´çš„ï¼Œåˆ™ç›´æ¥æäº¤ï¼› å¦‚æœ redo log é‡Œé¢çš„äº‹åŠ¡åªæœ‰å®Œæ•´çš„ prepareï¼Œåˆ™åˆ¤æ–­å¯¹åº”çš„äº‹åŠ¡ binlog æ˜¯å¦å­˜åœ¨å¹¶å®Œæ•´ï¼š å¦‚æœå®Œæ•´ï¼Œåˆ™æäº¤äº‹åŠ¡ï¼› å¦åˆ™ï¼Œå›æ»šäº‹åŠ¡ã€‚==æ­¤å¤„äº‹åŠ¡å›æ»šåŸºäºundo log == å¦‚æœredo log æ²¡æœ‰å®Œæ•´çš„prepare, åˆ™äº‹åŠ¡åŸºäºundo log å›æ»š âš ï¸è¯´æ˜ä¸€ä¸‹ï¼Œinnodb_flush_log_at_trx_commit å®é™…ä¸Šæ§åˆ¶äº†redo prepare å’Œcommit ä¸¤ä¸ªé˜¶æ®µçš„åˆ·ç›˜ç­–ç•¥ï¼Œæ¯”å¦‚innodb_flush_log_at_trx_commit =1 æ—¶åœ¨ prepare é˜¶æ®µå’Œ commit é˜¶æ®µï¼Œredo log éƒ½ä¼šæŒä¹…åŒ–å†™å…¥ç£ç›˜ã€‚æ‰€ä»¥æ‰ä¼šå‡ºç°ç¬¬äºŒç§ç£ç›˜æœ‰ä¸”åªæœ‰å®Œæ•´prepare çš„æƒ…å†µã€‚ æ¥ä¸‹æ¥æ ¹æ®ä¸€äº›å…·ä½“çš„é—®é¢˜æ¥è¯¦ç»†è¯´æ˜å´©æºƒæ¢å¤æ—¶çš„ç»†èŠ‚ 4.1 å¦‚ä½•åˆ¤æ–­ redo log æ˜¯å®Œæ•´çš„redo log commit é˜¶æ®µä¼šæœ‰commit æ ‡è¯† 4.2. å¦‚æœåˆ¤æ–­binlog å®Œæ•´æ€§ä¸€ä¸ªäº‹åŠ¡çš„ binlog æ˜¯æœ‰å®Œæ•´æ ¼å¼çš„ï¼šstatement æ ¼å¼çš„ binlogï¼Œæœ€åä¼šæœ‰ COMMITï¼›row æ ¼å¼çš„ binlogï¼Œæœ€åä¼šæœ‰ä¸€ä¸ª XID eventã€‚ 4.3. redo log å’Œ binlog æ˜¯æ€ä¹ˆå…³è”èµ·æ¥çš„åœ¨å´©æºƒæ¢å¤æ—¶ï¼Œé€šè¿‡è¯»å–Redo Logä¸­çš„Xidï¼Œèƒ½å¤Ÿå°†å…¶ä¸Binlogä¸­çš„Xidè¿›è¡ŒåŒ¹é…ã€‚ XIDï¼ˆTransaction Identifierï¼‰ å¯ä»¥ç†è§£æˆæ—¶MySQL server å±‚çš„äº‹åŠ¡å”¯ä¸€æ ‡è¯†ã€‚redo log ä¸­ä¼šè®°å½•XID å¦‚æœç¢°åˆ°åªæœ‰ parepareã€è€Œæ²¡æœ‰ commit çš„ redo logï¼Œå°±æ‹¿ç€ XID å» binlog æ‰¾å¯¹åº”çš„äº‹åŠ¡ã€‚ 4.4. ä¸ºä»€ä¹ˆè¦ç”¨2PC åè°ƒbinlogå’Œredo logç±»ä¼¼çš„é—®é¢˜è¿˜æœ‰ï¼Œä¸ºä»€ä¹ˆå¤„äº prepare é˜¶æ®µçš„ redo log åŠ ä¸Šå®Œæ•´ binlog å°±å¯ä»¥æäº¤äº‹åŠ¡ã€‚ è¿™ä¸¤ä¸ªé—®é¢˜æœ¬è´¨ä¸Šéƒ½æ˜¯æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚ binlog æ˜¯server å±‚æ—¥å¿—ï¼Œ æ˜¯MySQL ä¸€å¼€å§‹å°±æœ‰çš„åŠŸèƒ½ï¼Œè¢«ç”¨åœ¨äº†å¾ˆå¤šåœ°æ–¹ï¼Œæ¯”å¦‚å¤‡ä»½ã€ä¸»å¤‡åŒæ­¥å¤åˆ¶ã€‚redo log æ˜¯InnoDB å±‚æ—¥å¿—ï¼Œæ˜¯InnoDB ä¸ºäº†å®ç°äº‹åŠ¡åŠŸèƒ½æ–°å¢çš„ã€‚ä½¿ç”¨2PCå¯ä»¥ç»´æŠ¤ä¸¤ä»½ä¹‹é—´çš„é€»è¾‘ä¸€è‡´ã€‚ é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆè¦ç»´æŠ¤ä¸¤ä»½æ—¥å¿—é—´çš„é€»è¾‘ä¸€è‡´å‘¢ã€‚ binlog æ˜¯server å±‚æ—¥å¿—ï¼Œ æ˜¯MySQL ä¸€å¼€å§‹å°±æœ‰çš„åŠŸèƒ½ï¼Œè¢«ç”¨åœ¨äº†å¾ˆå¤šåœ°æ–¹ï¼Œæ¯”å¦‚å¤‡ä»½ã€ä¸»å¤‡åŒæ­¥å¤åˆ¶ã€‚redo log æ˜¯InnoDB å±‚æ—¥å¿—ï¼Œæ˜¯InnoDB ä¸ºäº†å®ç°äº‹åŠ¡åŠŸèƒ½æ–°å¢çš„ã€‚å¦‚æœä¸¤ä»½æ—¥å¿—é€»è¾‘æˆ–è€…è¯´æ•°æ®ä¸ä¸€è‡´ï¼Œ é‚£ä¹ˆç”¨æ—¥å¿—æ¢å¤å‡ºæ¥çš„æ•°æ®åº“çŠ¶æ€å°±æœ‰å¯èƒ½å’Œå®ƒæœ¬æ¥åº”è¯¥çš„çŠ¶æ€ä¸ä¸€è‡´ã€‚ å…·ä½“ä¸¾ä¾‹æ¥è®²ï¼Œå¦‚æœä¸ç”¨2PCï¼Œä¸¤ç§æ—¥å¿—è¦ä¹ˆæ˜¯å…ˆå†™ redo log å†å†™ binlogï¼Œæˆ–è€…å…ˆå†™binlog å†å†™redo log ã€‚ä»ç„¶ç”¨å‰é¢çš„ update è¯­å¥æ¥åšä¾‹å­ã€‚å‡è®¾å½“å‰ ID=2 çš„è¡Œï¼Œå­—æ®µ c çš„å€¼æ˜¯ 0ï¼Œå†å‡è®¾æ‰§è¡Œ update è¯­å¥è¿‡ç¨‹ä¸­åœ¨å†™å®Œç¬¬ä¸€ä¸ªæ—¥å¿—åï¼Œç¬¬äºŒä¸ªæ—¥å¿—è¿˜æ²¡æœ‰å†™å®ŒæœŸé—´å‘ç”Ÿäº† crashï¼Œä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ å…ˆå†™ redo log åå†™ binlogã€‚å‡è®¾åœ¨ redo log å†™å®Œï¼Œbinlog è¿˜æ²¡æœ‰å†™å®Œçš„æ—¶å€™ï¼ŒMySQL è¿›ç¨‹å¼‚å¸¸é‡å¯ã€‚ç”±äºæˆ‘ä»¬å‰é¢è¯´è¿‡çš„ï¼Œredo log å†™å®Œä¹‹åï¼Œç³»ç»Ÿå³ä½¿å´©æºƒï¼Œä»ç„¶èƒ½å¤ŸæŠŠæ•°æ®æ¢å¤å›æ¥ï¼Œæ‰€ä»¥æ¢å¤åè¿™ä¸€è¡Œ c çš„å€¼æ˜¯ 1ã€‚ä½†æ˜¯ç”±äº binlog æ²¡å†™å®Œå°± crash äº†ï¼Œè¿™æ—¶å€™ binlog é‡Œé¢å°±æ²¡æœ‰è®°å½•è¿™ä¸ªè¯­å¥ã€‚å› æ­¤ï¼Œä¹‹åå¤‡ä»½æ—¥å¿—çš„æ—¶å€™ï¼Œå­˜èµ·æ¥çš„ binlog é‡Œé¢å°±æ²¡æœ‰è¿™æ¡è¯­å¥ã€‚ç„¶åä½ ä¼šå‘ç°ï¼Œå¦‚æœéœ€è¦ç”¨è¿™ä¸ª binlog æ¥æ¢å¤ä¸´æ—¶åº“çš„è¯ï¼Œç”±äºè¿™ä¸ªè¯­å¥çš„ binlog ä¸¢å¤±ï¼Œè¿™ä¸ªä¸´æ—¶åº“å°±ä¼šå°‘äº†è¿™ä¸€æ¬¡æ›´æ–°ï¼Œæ¢å¤å‡ºæ¥çš„è¿™ä¸€è¡Œ c çš„å€¼å°±æ˜¯ 0ï¼Œä¸åŸåº“çš„å€¼ä¸åŒã€‚ å…ˆå†™ binlog åå†™ redo logã€‚å¦‚æœåœ¨ binlog å†™å®Œä¹‹å crashï¼Œç”±äº redo log è¿˜æ²¡å†™ï¼Œå´©æºƒæ¢å¤ä»¥åè¿™ä¸ªäº‹åŠ¡æ— æ•ˆï¼Œæ‰€ä»¥è¿™ä¸€è¡Œ c çš„å€¼æ˜¯ 0ã€‚ä½†æ˜¯ binlog é‡Œé¢å·²ç»è®°å½•äº†â€œæŠŠ c ä» 0 æ”¹æˆ 1â€è¿™ä¸ªæ—¥å¿—ã€‚æ‰€ä»¥ï¼Œåœ¨ä¹‹åç”¨ binlog æ¥æ¢å¤çš„æ—¶å€™å°±å¤šäº†ä¸€ä¸ªäº‹åŠ¡å‡ºæ¥ï¼Œæ¢å¤å‡ºæ¥çš„è¿™ä¸€è¡Œ c çš„å€¼å°±æ˜¯ 1ï¼Œä¸åŸåº“çš„å€¼ä¸åŒã€‚å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä¸ä½¿ç”¨â€œä¸¤é˜¶æ®µæäº¤â€ï¼Œé‚£ä¹ˆæ•°æ®åº“çš„çŠ¶æ€å°±æœ‰å¯èƒ½å’Œç”¨å®ƒçš„æ—¥å¿—æ¢å¤å‡ºæ¥çš„åº“çš„çŠ¶æ€ä¸ä¸€è‡´ã€‚ åŒç†ï¼Œä¸ºä»€ä¹ˆå¤„äº prepare é˜¶æ®µçš„ redo log åŠ ä¸Šå®Œæ•´ binlog å°±å¯ä»¥æäº¤äº‹åŠ¡ã€‚å› ä¸ºå¦‚æœbinlog å†™å®Œä»¥å MySQL å‘ç”Ÿå´©æºƒï¼Œè¿™æ—¶å€™ binlog å·²ç»å†™å…¥äº†ï¼Œä¹‹åå°±ä¼šè¢«ä»åº“ï¼ˆæˆ–è€…ç”¨è¿™ä¸ª binlog æ¢å¤å‡ºæ¥çš„åº“ï¼‰ä½¿ç”¨ã€‚å¦‚æœredo log äº‹åŠ¡ä¸æäº¤çš„è¯ï¼Œå°±ä¼šå‘ç”Ÿæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µ 4.5. ä¸è¦binlog å¯ä»¥å—ä»…ä»äº‹åŠ¡æŒä¹…åŒ–/å´©æºƒæ¢å¤è¿™ä¸ªåŠŸèƒ½æ¥è®²ï¼Œ åªè¦redo log æ˜¯å¯ä»¥å®Œæˆçš„ã€‚ä½†æ˜¯binlog ä½œä¸º MySQL ä¸€å¼€å§‹å°±æœ‰çš„åŠŸèƒ½ï¼Œè¢«ç”¨åœ¨äº†å¾ˆå¤šåœ°æ–¹ï¼Œæœ‰redo log æ— æ³•æ›¿ä»£çš„åŠŸèƒ½ ã€‚ å½’æ¡£ã€‚redo log æ˜¯å¾ªç¯å†™ï¼Œå†™åˆ°æœ«å°¾æ˜¯è¦å›åˆ°å¼€å¤´ç»§ç»­å†™çš„ã€‚è¿™æ ·å†å²æ—¥å¿—æ²¡æ³•ä¿ç•™ï¼Œredo log ä¹Ÿå°±èµ·ä¸åˆ°å½’æ¡£çš„ä½œç”¨ã€‚ ä¸»ä»å¤åˆ¶åŒæ­¥ MySQL é«˜å¯ç”¨ åœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œ ä¹Ÿä¼šä½¿ç”¨binlogåšæ•°æ®åŒæ­¥ï¼Œæ¯”å¦‚ä½¿ç”¨canal åŒæ­¥binlogæ•°æ® åˆ°ES4.6 æ•°æ®ä¸€å®šä¸ä¼šä¸¢å¤±å—-åŒ1 è®¾ç½® åœ¨ä»‹ç»binlogå’Œredo log å†™å…¥è¿‡ç¨‹çš„æ—¶å€™ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°sync_binlog æ§åˆ¶binlog æŒä¹…åŒ–åˆ°ç£ç›˜çš„é¢‘ç‡ sync_binlog=0 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ä¸ä¸»åŠ¨åˆ·æ–°ç£ç›˜ï¼Œç”±æ–‡ä»¶ç³»ç»Ÿè‡ªå·±æ§åˆ¶åˆ·ç›˜é¢‘ç‡ sync_binlog=1 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ä¼šå°† binlog cache ä¸­çš„å†…å®¹åˆ·æ–°åˆ°ç£ç›˜ sync_binlog=N(N&gt;1) çš„æ—¶å€™ï¼Œè¡¨ç¤ºç´¯ç§¯ N ä¸ªæäº¤äº‹åŠ¡åæ‰å°†å¤šä¸ªbinlog cacheä¸­çš„å†…å®¹åˆ·æ–°åˆ°ç£ç›˜ã€‚ innodb_flush_log_at_trx_commit æ§åˆ¶redo log æŒä¹…åŒ–åˆ°ç£ç›˜çš„é¢‘ç‡ è®¾ç½®ä¸º 0 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½åªæ˜¯æŠŠ redo log ç•™åœ¨ redo log buffer ä¸­ ; è®¾ç½®ä¸º 1 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½å°† redo log ç›´æ¥æŒä¹…åŒ–åˆ°ç£ç›˜ï¼› è®¾ç½®ä¸º 2 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½åªæ˜¯æŠŠ redo log å†™åˆ° page cacheã€‚ å¯ä»¥çœ‹åˆ°å—ï¼Œåªæœ‰åœ¨åŒ1è®¾ç½®çš„æ—¶å€™ï¼Œsync_binlog å’Œ innodb_flush_log_at_trx_commit éƒ½è®¾ç½®æˆ 1ï¼Œ æ‰èƒ½ç¡®ä¿ä¸€å®šä¸ä¼šä¸¢æ•°æ® é€šå¸¸æˆ‘ä»¬è¯´ MySQL çš„â€œåŒ 1â€é…ç½®ï¼ŒæŒ‡çš„å°±æ˜¯ sync_binlog å’Œ innodb_flush_log_at_trx_commit éƒ½è®¾ç½®æˆ 1ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªäº‹åŠ¡å®Œæ•´æäº¤å‰ï¼Œéœ€è¦ç­‰å¾…ä¸¤æ¬¡åˆ·ç›˜ï¼Œä¸€æ¬¡æ˜¯ redo logï¼ˆprepare é˜¶æ®µï¼‰ï¼Œä¸€æ¬¡æ˜¯ binlogã€‚ å¦‚æœä¸è®¾ç½®æˆåŒ1ï¼Œ æœ‰åŠ©äºæé«˜æ€§èƒ½ã€‚ 5. binlog vs redo logå·®å¼‚ å±‚çº§å·®å¼‚ï¼šBinlog å·¥ä½œåœ¨ MySQL æœåŠ¡å™¨å±‚ï¼Œæ‰€æœ‰å¼•æ“éƒ½å¯ä»¥ä½¿ç”¨ï¼›è€Œ redo log æ˜¯ InnoDB å­˜å‚¨å¼•æ“å±‚ç‰¹æœ‰çš„ã€‚ è®°å½•å½¢å¼ï¼šBinlog å¯ä»¥è®°å½• SQL è¯­å¥æˆ–è¡Œå˜æ›´ï¼Œredo log è®°å½•çš„æ˜¯æ•°æ®é¡µçš„ç‰©ç†å˜åŒ–ï¼Œå³â€œåœ¨æŸä¸ªæ•°æ®é¡µä¸Šåšäº†ä»€ä¹ˆä¿®æ”¹â€ ç›®çš„å’Œç”¨é€”ï¼šBinlog ä¸»è¦ç”¨äºæ•°æ®å¤åˆ¶å’Œå´©æºƒæ¢å¤ï¼Œè€Œ redo log ä¸»è¦ç”¨äºäº‹åŠ¡çš„æŒä¹…æ€§å’Œå´©æºƒæ¢å¤ã€‚ å¤§å°ç®¡ç†ï¼šRedo log çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œå¾ªç¯ä½¿ç”¨å¾ªç¯å†™ï¼›binlog æ˜¯è¿½åŠ å†™ï¼Œå¯ä»¥ä¸æ–­å¢é•¿ï¼Œéœ€è¦å®šæœŸè¿›è¡Œæ¸…ç†ã€‚ æ—¥å¿—å†™å…¥ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±ä¸€å—ç‹¬ç«‹çš„ binlog cache ï¼Œ è€Œ redo log buffer æ˜¯å…¨å±€å…±ç”¨çš„ å…±åŒç‚¹ äº‹åŠ¡å®‰å…¨ï¼šä¸¤è€…éƒ½æ˜¯ä¸ºäº†ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§å’ŒåŸå­æ€§ã€‚ æ¢å¤æ”¯æŒï¼šåœ¨ç³»ç»Ÿæˆ–ç¡¬ä»¶æ•…éšœåï¼Œä¸¤è€…éƒ½èƒ½è¢«ç”¨æ¥æ¢å¤æ•°æ®ã€‚ å†™å‰æ—¥å¿—ï¼šéƒ½é‡‡ç”¨äº†å†™å‰æ—¥å¿—ï¼ˆwrite-ahead logging, WALï¼‰çš„æŠ€æœ¯ï¼Œå³åœ¨å®é™…ä¿®æ”¹æ•°æ®åº“å†…å®¹å‰å…ˆè®°å½•æ—¥å¿—ã€‚ ä»ç”Ÿäº§åˆ°å†™å…¥ç£ç›˜å‡æœ‰å†…å­˜page - åˆ°page cache - ç£ç›˜ï¼Œåˆ·æ–°åˆ°ç£ç›˜çš„æ—¶æœºå‡æœ‰å‚æ•°æ§åˆ¶ ç›¸å…³æ–‡ç« Intro to äº‹åŠ¡Intro to InnoDB äº‹åŠ¡InnoDBäº‹åŠ¡-åŸå­æ€§çš„å®ç°,undo logInnoDBäº‹åŠ¡-éš”ç¦»æ€§çš„å®ç°,MVCC &amp; é”","tags":["MySQL","äº‹åŠ¡"]},{"title":"InnoDBäº‹åŠ¡-éš”ç¦»æ€§çš„å®ç°, MVCC & é”","path":"/9faedfe0/","content":"éš”ç¦»æ€§ï¼Œè¿˜æœ‰ä¸€ä¸ªè¯´æ³•å°±æ˜¯ æ•°æ®å¯è§æ€§ã€‚ éš”ç¦»æ€§ã€æ•°æ®å¯è§æ€§æ˜¯ä¸€ä¸ªåœ¨å¹¶å‘äº‹åŠ¡ä¸‹æ‰éœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼Œå¹¶å‘äº‹åŠ¡å¯ä»¥åˆ†3ç§æƒ…å†µè€ƒè™‘ è¯»-è¯»ï¼Œ è¯»æ“ä½œä¸ä¼šå¯¹æ•°æ®äº§ç”Ÿå½±å“ï¼Œæ‰€ä»¥ä¸éœ€è¦å…³æ³¨ è¯»-å†™ or å†™-è¯»ï¼Œ å¯èƒ½ä¼šå‡ºç°è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯» å†™-å†™ï¼Œå¯èƒ½ä¼šè„å†™çš„æƒ…å†µ å¹¶å‘äº‹åŠ¡ä¸‹çš„æ•°æ®çš„ä¸€è‡´æ€§å†™é—®é¢˜ è„å†™ï¼šä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹äº†å¦ä¸€ä¸ªæœªæäº¤äº‹åŠ¡ä¿®æ”¹è¿‡çš„æ•°æ®ã€‚ å¹¶å‘äº‹åŠ¡ä¸‹çš„æ•°æ®çš„ä¸€è‡´æ€§è¯»é—®é¢˜ è„è¯»ï¼šäº‹åŠ¡è¯»å–äº†æœªæäº¤çš„æ•°æ®ï¼Œå¯èƒ½é€ æˆæ•°æ®ä¸ä¸€è‡´ã€‚ ä¸å¯é‡å¤è¯»ï¼šäº‹åŠ¡åœ¨å†…éƒ¨çš„å¤šæ¬¡è¯»å–ä¸­çœ‹åˆ°äº†åŒä¸€æ•°æ®çš„ä¸åŒç‰ˆæœ¬ï¼Œä¸»è¦ç”±äºå…¶ä»–äº‹åŠ¡çš„æ›´æ–°æ“ä½œã€‚ å¹»è¯»ï¼šäº‹åŠ¡åœ¨ä¸¤æ¬¡æŸ¥è¯¢åŒä¸€ä¸ªèŒƒå›´æ—¶çœ‹åˆ°äº†ä¸ä¸€æ ·çš„è¡Œï¼Œé€šå¸¸æ˜¯å› ä¸ºå…¶ä»–äº‹åŠ¡æ·»åŠ æˆ–åˆ é™¤äº†è¡Œã€‚ MySQL çš„ 4ç§ äº‹åŠ¡éš”ç¦»çº§åˆ« éš”ç¦»çº§åˆ« è§£å†³çš„é—®é¢˜ æœªè§£å†³çš„é—®é¢˜ åŸç†æè¿° è¯»æœªæäº¤ æ—  è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯» å…è®¸äº‹åŠ¡è¯»å–å…¶ä»–äº‹åŠ¡æœªæäº¤çš„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´è„è¯»ã€‚ è¯»å·²æäº¤ è„è¯» ä¸å¯é‡å¤è¯»ã€å¹»è¯» åªèƒ½çœ‹åˆ°å·²ç»è¢«å…¶ä»–äº‹åŠ¡æäº¤çš„æ•°æ®ï¼Œé¿å…äº†è„è¯»ï¼Œä½†ä¸èƒ½é˜²æ­¢åœ¨åŒä¸€äº‹åŠ¡ä¸­çœ‹åˆ°ä¸ä¸€è‡´çš„æ•°æ®ã€‚ å¯é‡å¤è¯» è„è¯»ã€ä¸å¯é‡å¤è¯» MySQL åœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹åŠ ä¸Šgap é”å¯éƒ¨åˆ†è§£å†³å¹»è¯»é—®é¢˜ åœ¨äº‹åŠ¡å¼€å§‹åæ‰€æœ‰SELECTæ“ä½œéƒ½çœ‹åˆ°ä¸€è‡´çš„å¿«ç…§ï¼Œé¿å…äº†ä¸å¯é‡å¤è¯»ï¼Œä½†æ— æ³•é˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥æ–°è¡Œï¼ˆå¹»è¯»ï¼‰ã€‚ ä¸²è¡ŒåŒ– è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯» æ—  â€œå†™â€ä¼šåŠ â€œå†™é”â€ï¼Œâ€œè¯»â€ä¼šåŠ â€œè¯»é”â€ã€‚å½“å‡ºç°è¯»å†™é”å†²çªçš„æ—¶å€™ï¼Œåè®¿é—®çš„äº‹åŠ¡å¿…é¡»ç­‰å‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚é€šè¿‡å¼ºåˆ¶äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œé˜²æ­¢äº†è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ï¼Œæä¾›äº†æœ€é«˜çº§åˆ«çš„éš”ç¦»ã€‚ ç”±äºè„å†™å¯¼è‡´çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜éå¸¸ä¸¥é‡ï¼Œä»»ä½•ä¸€ç§éš”ç¦»çº§åˆ«ä¸‹éƒ½ä¸å…è®¸å‘ç”Ÿï¼Œå¯¹æ•°æ®çš„ä¿®æ”¹æ“ä½œå¿…é¡»é€šè¿‡é”ä¸²è¡Œæ‰§è¡Œ InnoDB åœ¨è§£å†³ å¹¶å‘äº‹åŠ¡æ—¶ï¼Œåˆ†æˆä¸¤ç§æƒ…å†µå¯¹åº”ä¸åŒçš„è§£å†³æ–¹æ¡ˆ å¿«ç…§è¯»-MVCC å½“å‰è¯»- é” 1 å¿«ç…§è¯»çš„éš”ç¦»æ€§-MVCC ä¸€è‡´æ€§è§†å›¾ï¼šåœ¨å¿«ç…§è¯»ä¸­ï¼Œäº‹åŠ¡ä¼šåˆ›å»ºä¸€ä¸ªä¸€è‡´æ€§è§†å›¾ï¼ˆConsistent Read Viewï¼‰ï¼Œç¡®ä¿å½“å‰äº‹åŠ¡è¯»å–åˆ°çš„éƒ½æ˜¯äº‹åŠ¡å¼€å§‹æ—¶çš„æ•°æ®çŠ¶æ€ã€‚å®ƒä¾èµ–äºMVCCçš„å®ç°ã€‚ æ— éœ€é”å®šï¼šå¿«ç…§è¯»æ˜¯ä¸€ç§æ— é”çš„è¯»å–ï¼Œå³è¯»å–æ•°æ®æ—¶ä¸éœ€è¦å¯¹è¡Œè®°å½•è¿›è¡Œé”å®šï¼Œå› æ­¤å®ƒä¸ä¼šé˜»å¡äº‹åŠ¡çš„è¯»å†™ï¼ŒåŒæ—¶ä¹Ÿä¸ä¼šè¢«å…¶ä»–äº‹åŠ¡çš„è¯»å†™æ“ä½œé˜»å¡ã€‚ éš”ç¦»çº§åˆ«å½±å“ï¼šå¿«ç…§è¯»çš„è¡Œä¸ºå—äº‹åŠ¡éš”ç¦»çº§åˆ«çš„å½±å“ï¼Œä¸åŒçš„éš”ç¦»çº§åˆ«ä¼šå½±å“è¯»å–åˆ°çš„ç‰ˆæœ¬ã€‚ åœ¨è¯»æœªæäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ‰€æœ‰äº‹åŠ¡éƒ½è¯»å–æœ€æ–°äº‹åŠ¡ï¼› åœ¨ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«ä¸‹ï¼Œä½¿ç”¨é”æ§åˆ¶æ•°æ®çš„è®¿é—®ã€‚ åœ¨è¯»å·²æäº¤å’Œå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œä½¿ç”¨MVCC æ¥æ§åˆ¶æ•°æ®çš„å¯è§æ€§ã€‚ InnoDBå­˜å‚¨å¼•æ“çš„MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰æœºåˆ¶æ˜¯åŸºäºReadViewå’ŒUndo Logå…±åŒå®ç°çš„ï¼Œå…³é”®æ˜¯é€šè¿‡TRX_IDå’ŒROLL_PTRä¸¤ä¸ªè¡Œè®°å½•éšè—åˆ—æ¥è·Ÿè¸ªå’Œç®¡ç†æ¯ä¸€è¡Œçš„ä¿®æ”¹ç‰ˆæœ¬ã€‚ 1.1 ç‰ˆæœ¬é“¾ -undo logåœ¨åŸºäºundo log å®ç°åŸå­æ€§ ä¸€æ–‡ä¸­ï¼Œå¯ä»¥çœ‹åˆ° è¡Œè®°å½•ä¸­æœ‰roll_pointer, update æ“ä½œä¸­TRX_UNDO_UPD_EXIST_REC å’Œ TRX_UNDO_DEL_MARK_REC ç±»å‹çš„undo log ä¸­ï¼Œä¹Ÿæœ‰roll_pointer,é€šè¿‡è¿™äº›roll_pointer, å¯ä»¥å½¢æˆä¸€æ¡è¡Œè®°å½•çš„ç‰ˆæœ¬é“¾ã€‚ insert æ“ä½œä¸­ï¼Œå¯¹åº”çš„undo logæ²¡æœ‰roll_pointer å±æ€§ï¼Œå› ä¸ºinsert æ“ä½œå°±æ˜¯ä¸€ä¸ªè¡Œè®°å½•çš„åˆå§‹ç‰ˆæœ¬ï¼Œæ²¡æœ‰æ¯”å®ƒæ›´æ—©çš„æ“ä½œäº†ã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªé€šè¿‡roll_pointer ç»„æˆçš„ç‰ˆæœ¬é“¾ï¼Œæ¯ä¸ªundo log è¿›è¡Œäº†å†…å®¹çœç•¥ä»¥å±•ç¤ºé“¾æ¥çš„é‡ç‚¹å†…å®¹ 1.2 readviewæœ‰äº†ç‰ˆæœ¬é“¾ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•åˆ¤æ–­å“ªä¸ªç‰ˆæœ¬çš„æ•°æ®å¯¹å½“å‰äº‹åŠ¡å¯è§å‘¢ï¼Œè¿™é‡Œéœ€è¦å¼•å…¥readview æ¦‚å¿µã€‚ Read View ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªå…³é”®çš„éƒ¨åˆ†ï¼š m_idsï¼šå½“å‰ç³»ç»Ÿä¸­æ´»è·ƒçš„äº‹åŠ¡IDåˆ—è¡¨ã€‚è¿™äº›äº‹åŠ¡åœ¨ç”Ÿæˆ Read View æ—¶å·²ç»å¼€å§‹ä½†å°šæœªæäº¤ã€‚ min_trx_idï¼šç”Ÿæˆ Read View æ—¶ï¼Œæ´»è·ƒäº‹åŠ¡IDä¸­çš„æœ€å°å€¼ã€‚è¿™æ˜¯å› ä¸ºä»»ä½• ID å°äºæ­¤å€¼çš„äº‹åŠ¡åœ¨ Read View ç”Ÿæˆå‰å·²ç»æäº¤ã€‚ max_trx_idï¼šç”Ÿæˆ Read View æ—¶ï¼Œå·²çŸ¥çš„ä¸‹ä¸€ä¸ªäº‹åŠ¡IDã€‚ä»»ä½•å¤§äºæˆ–ç­‰äºæ­¤ ID çš„äº‹åŠ¡åœ¨ç”Ÿæˆ Read View åå¼€å§‹çš„ã€‚ creator_trx_idï¼šç”Ÿæˆè¿™ä¸ª Read View çš„äº‹åŠ¡çš„äº‹åŠ¡IDã€‚ ä¸€ä¸ªäº‹åŠ¡åªæœ‰è¿›è¡Œä¿®æ”¹æ“ä½œæ—¶ï¼Œæ‰ä¼šè¢«åˆ†é…trx_id, å¦åˆ™ä¸€ä¸ªäº‹åŠ¡çš„trx_id é»˜è®¤éƒ½æ˜¯0ï¼Œ æ‰€ä»¥ creator_trx_id ä¹Ÿæœ‰å¯èƒ½æ—¶0 è¿ä½œæ–¹å¼ï¼š å½“äº‹åŠ¡æ‰§è¡ŒæŸ¥è¯¢æ“ä½œæ—¶ï¼Œå®ƒä¼šæ ¹æ®è‡ªå·±çš„ Read View æ¥åˆ¤æ–­æ•°æ®è¡Œçš„å¯è§æ€§ã€‚å…·ä½“æ¥è¯´ï¼Œæ¯è¡Œæ•°æ®éƒ½æœ‰è‡ªå·±çš„ç³»ç»Ÿç‰ˆæœ¬å·ï¼ˆtrx_idï¼Œå³äº‹åŠ¡IDï¼‰ã€‚Read View é€šè¿‡ä»¥ä¸‹é€»è¾‘æ¥ç¡®å®šè¡Œçš„å¯è§æ€§ï¼š å¦‚æœè¡ŒåŠè®°å½•çš„trx_id å’Œcreator_trx_id ç›¸ç­‰ï¼Œè¯´æ˜å½“å‰äº‹åŠ¡åœ¨è®¿é—®è‡ªå·±ä¿®æ”¹çš„æ•°æ®ï¼Œæ•°æ®å¯è§ã€‚ å¦‚æœè¡Œçš„ç‰ˆæœ¬å·å°äº min_trx_idï¼Œè¯´æ˜è¡Œæ˜¯åœ¨ Read View ç”Ÿæˆä¹‹å‰è¢«åˆ›å»ºæˆ–æœ€åä¿®æ”¹çš„ï¼Œå› æ­¤å¯¹å½“å‰äº‹åŠ¡å¯è§ã€‚ å¦‚æœè¡Œçš„ç‰ˆæœ¬å·å¤§äºæˆ–ç­‰äº max_trx_idï¼Œè¯´æ˜è¡Œæ˜¯åœ¨ Read View ç”Ÿæˆä¹‹åè¢«åˆ›å»ºæˆ–ä¿®æ”¹çš„ï¼Œå› æ­¤å¯¹å½“å‰äº‹åŠ¡ä¸å¯è§ã€‚ å¦‚æœè¡Œçš„ç‰ˆæœ¬å·åœ¨ min_trx_id å’Œ max_trx_id ä¹‹é—´ï¼Œè¿˜éœ€è¦æ£€æŸ¥è¿™ä¸ªç‰ˆæœ¬å·æ˜¯å¦å±äº m_ids åˆ—è¡¨ä¸­çš„æŸä¸ªäº‹åŠ¡ï¼š å¦‚æœå±äºï¼Œè¯´æ˜è¯¥è¡Œå¯èƒ½ç”±å°šæœªæäº¤çš„äº‹åŠ¡ä¿®æ”¹ï¼Œå¯¹å½“å‰äº‹åŠ¡ä¸å¯è§ã€‚ å¦‚æœä¸å±äºï¼Œè¯´æ˜è¯¥è¡Œç”±å·²æäº¤çš„äº‹åŠ¡ä¿®æ”¹ï¼Œå¯¹å½“å‰äº‹åŠ¡å¯è§ã€‚ å¦‚æœæŸä¸ªç‰ˆæœ¬çš„æ•°æ®å¯¹å½“å‰äº‹åŠ¡ä¸å¯è§ï¼Œé‚£å°±é¡ºç€ç‰ˆæœ¬é“¾æ‰¾æ´—ä¸€ä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼Œå¹¶æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤è¿›è¡Œåˆ¤æ–­ã€‚å¦‚æœä¸€ä¸ªæ•°æ®ç›´åˆ°æœ€åä¸€ä¸ªç‰ˆæœ¬éƒ½ä¸å¯è§ï¼Œé‚£å°±è¯´æ˜è¯¥æ¡æ•°æ®å¯¹å½“å‰äº‹åŠ¡å®Œå…¨ä¸å¯è§ 1.2.1 readview å’Œ è¯»å·²æäº¤ï¼ˆRead Committedï¼‰ ç”Ÿæˆæ—¶æœºï¼šåœ¨ RC éš”ç¦»çº§åˆ«ä¸‹ï¼ŒRead View ä¸æ˜¯åœ¨äº‹åŠ¡å¼€å§‹æ—¶ç”Ÿæˆï¼Œè€Œæ˜¯åœ¨ä¸€ä¸ªäº‹åŠ¡å†…æ¯æ¬¡æ‰§è¡Œ SQL æŸ¥è¯¢æ—¶éƒ½ä¼šç”Ÿæˆæ–°çš„readview, æ‰€ä»¥è¯¥äº‹åŠ¡å†…æ˜¯å¯ä»¥çœ‹åˆ°å…¶ä»–äº‹åŠ¡å·²æäº¤çš„å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œè¿™åœ¨æ•°æ®ä¸€è‡´æ€§ä¸Šå°±è¡¨ç°ä¸ºä¸å¯é‡å¤è¯» è¡Œä¸ºï¼šæ¯æ¬¡æŸ¥è¯¢éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„ Read Viewï¼ŒåŒ…å«å½“å‰æ—¶åˆ»æ‰€æœ‰æœªå®Œæˆçš„äº‹åŠ¡IDã€‚è¿™ç¡®ä¿äº†æŸ¥è¯¢åªèƒ½çœ‹åˆ°é‚£äº›åœ¨æ‰§è¡ŒæŸ¥è¯¢å‰å·²ç»æäº¤çš„äº‹åŠ¡æ‰€åšçš„æ›´æ”¹ã€‚ 1.2.2 readview å’Œ å¯é‡å¤è¯»ï¼ˆRepeatable Readï¼‰InnoDB çš„ é»˜è®¤éš”ç¦»çº§åˆ«ã€‚ ç”Ÿæˆæ—¶æœºï¼šåœ¨ RR éš”ç¦»çº§åˆ«ä¸‹ï¼ŒRead View æ˜¯åœ¨äº‹åŠ¡çš„ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ“ä½œå¼€å§‹æ—¶åˆ›å»ºçš„ï¼Œä¸”åœ¨æ•´ä¸ªäº‹åŠ¡æœŸé—´ä¿æŒä¸å˜ã€‚è¿™æ„å‘³ç€æ•´ä¸ªäº‹åŠ¡ä¸­æ‰€æœ‰çš„æŸ¥è¯¢éƒ½å°†çœ‹åˆ°ç›¸åŒçš„æ•°æ®å¿«ç…§ã€‚ è¡Œä¸ºï¼šä¸€æ—¦ç”Ÿæˆï¼Œè¿™ä¸ª Read View å°†åŒ…å«äº‹åŠ¡å¼€å§‹æ—¶åˆ»çš„æ‰€æœ‰æ´»è·ƒäº‹åŠ¡IDã€‚æ— è®ºè¿™äº›äº‹åŠ¡åæ¥å¦‚ä½•æäº¤æˆ–å›æ»šï¼Œå½“å‰äº‹åŠ¡çš„åç»­æŸ¥è¯¢éƒ½ä¸ä¼šæ„ŸçŸ¥åˆ°è¿™äº›å˜åŒ–ã€‚ 1.2.3 ä¸¤è€…çš„å¯¹æ¯” æ•°æ®å¯è§æ€§ï¼šåœ¨è¯»å·²æäº¤ä¸­ï¼Œäº‹åŠ¡å¯èƒ½çœ‹åˆ°å…¶ä»–äº‹åŠ¡æäº¤çš„æ›´æ–°ï¼ˆå³äº‹åŠ¡ä¸­çš„æŸ¥è¯¢å¯èƒ½è¿”å›ä¸åŒçš„ç»“æœï¼‰ï¼Œè€Œåœ¨å¯é‡å¤è¯»ä¸­ï¼Œäº‹åŠ¡ä¿è¯äº†å§‹ç»ˆå¯¹æ•°æ®çš„ä¸€è‡´è§†å›¾ã€‚ Read View çš„ç”Ÿæˆé¢‘ç‡ï¼šè¯»å·²æäº¤æ¯æ¬¡æŸ¥è¯¢éƒ½é‡æ–°ç”Ÿæˆ Read Viewï¼Œè€Œå¯é‡å¤è¯»åªåœ¨äº‹åŠ¡å¼€å§‹æ—¶ç”Ÿæˆä¸€æ¬¡ã€‚ ç³»ç»Ÿå¼€é”€ï¼šç”±äºè¯»å·²æäº¤æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦ç”Ÿæˆ Read Viewï¼Œå¯èƒ½ä¼šæœ‰æ›´é«˜çš„ç³»ç»Ÿå¼€é”€ï¼Œå°¤å…¶æ˜¯åœ¨æŸ¥è¯¢é¢‘ç¹çš„åœºæ™¯ä¸­ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¯é‡å¤è¯»çš„å¼€é”€ä¸»è¦é›†ä¸­åœ¨äº‹åŠ¡å¼€å§‹é˜¶æ®µã€‚ 2 å½“å‰è¯»çš„éš”ç¦»å‹-é”å½“å‰è¯»æŒ‡çš„æ˜¯è¯»å–æ•°æ®æ—¶æ€»æ˜¯è·å–æ•°æ®çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶é€šè¿‡åŠ é”ï¼ˆè¡Œçº§åˆ«çš„æ’ä»–é”ï¼ŒSé”æˆ–Xé”ï¼‰ä»¥ç¡®ä¿ä¸€è‡´æ€§ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡ä¿®æ”¹æˆ–åˆ é™¤è¿™äº›æ•°æ®ã€‚ å½“å‰è¯»é€šå¸¸ç”¨äºéœ€è¦ä¿®æ”¹æ•°æ®çš„æŸ¥è¯¢ï¼Œå¦‚ selectâ€¦lock in share mode (å…±äº«è¯»é”) selectâ€¦for update UPDATE DELETE å…³äºè¡Œé”å’Œé—´éš™é”çš„å…·ä½“åŠ é”è§„åˆ™ï¼Œå’Œéš”ç¦»çº§åˆ«å’Œç´¢å¼•æœ‰å…³ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒä½•ç™»æˆçš„åŠ é”åˆ†ææ–‡ç« MySQL åŠ é”åˆ†æ 3. å¹»è¯»bad caseåœ¨å‰é¢ä»‹ç»éš”ç¦»çº§åˆ«æ—¶ï¼Œæåˆ° åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ åŠ ä¸Š é—´éš™é”ï¼Œ å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šè§£å†³å¹»è§‰ã€‚ä½†æ˜¯å¦‚æœä¸€ä¸ªäº‹åŠ¡ä¸­ å¿«ç…§è¯»å’Œå½“å‰è¯»æ··ç”¨ï¼Œå°±ä¼šå‡ºç°å¹»è¯»bad case. å¹»è¯»è¢«å®Œå…¨è§£å†³äº†å—ï¼Ÿ è¿™ç¯‡æ–‡ç« ä¸­ä¾‹ä¸¾ä¸¤ä¸ªå¹»è¯» bad case,è®²çš„æ¯”è¾ƒæ¸…æ™°ï¼Œå¯ä»¥å‚è€ƒ 4. å½“å‰è¯»vså¿«ç…§è¯» å¿«ç…§è¯»ï¼ˆSnapshot Readï¼‰ï¼š è¯»å–æ•°æ®æ—¶ä½¿ç”¨çš„æ˜¯æŸä¸€æ—¶é—´ç‚¹çš„å¿«ç…§ï¼Œä¸ä¼šåŠ é”ã€‚ ä½¿ç”¨MVCCæœºåˆ¶ï¼Œæ ¹æ®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«å’Œç‰ˆæœ¬å·è¿”å›åˆé€‚çš„è¡Œç‰ˆæœ¬ã€‚ é€šå¸¸ç”¨äºSELECTæŸ¥è¯¢ã€‚ å½“å‰è¯»ï¼ˆCurrent Readï¼‰ï¼š å§‹ç»ˆè¯»å–æœ€æ–°ç‰ˆæœ¬çš„è¡Œã€‚ å¯èƒ½ä¼šåŠ é”ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡ä¿®æ”¹æˆ–åˆ é™¤è¯»å–çš„æ•°æ®ã€‚ é€šå¸¸ç”¨äºä¿®æ”¹æ•°æ®çš„æŸ¥è¯¢æ“ä½œï¼Œå¦‚SELECT ... FOR UPDATEã€SELECT ... LOCK IN SHARE MODEã€UPDATEå’ŒDELETEã€‚ ç›¸å…³æ–‡ç« Intro to äº‹åŠ¡Intro to InnoDB äº‹åŠ¡InnoDBäº‹åŠ¡-åŸå­æ€§çš„å®ç°,undo logInnoDBäº‹åŠ¡-æŒä¹…æ€§çš„å®ç°, binglog &amp; redo log&amp;undo log","tags":["MySQL","äº‹åŠ¡"]},{"title":"InnoDBäº‹åŠ¡-åŸå­æ€§çš„å®ç°,undo log","path":"/b36b0ce9/","content":"åŸå­æ€§æŒ‡çš„æ˜¯äº‹åŠ¡è¦ä¹ˆå®Œå…¨æˆåŠŸæ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨å¤±è´¥å›æ»šï¼Œä¸å…è®¸éƒ¨åˆ†æ‰§è¡Œã€‚ è¿™æœ¬è´¨ä¸Šæ˜¯åœ¨è¦æ±‚å…·æœ‰rollback å›æ»šèƒ½åŠ›ã€‚ InnoDBä¸­çš„äº‹åŠ¡å¯èƒ½ä¼šç”±ç”¨æˆ·ä¸»åŠ¨è§¦å‘Rollbackï¼›ä¹Ÿå¯èƒ½å› ä¸ºé‡åˆ°æ­»é”å¼‚å¸¸Rollbackï¼›æˆ–è€…å‘ç”ŸCrashï¼Œé‡å¯åå¯¹æœªæäº¤çš„äº‹åŠ¡å›æ»šã€‚ InnoDB çš„ rollbackå›æ»šèƒ½åŠ› æ˜¯åŸºäº undo log å®ç°çš„ã€‚undo log è®°å½•äº†ä¿®æ”¹æ“ä½œå‰çš„æ—§ç‰ˆæœ¬æ•°æ®ï¼Œä»¥ä¾¿åœ¨å›æ»šæ—¶æ¢å¤æ•°æ®ã€‚ 1 ä¸€æ¡ undo log çš„ç»“æ„1.1 undo log çš„åˆ†ç±»åªæœ‰åœ¨äº‹åŠ¡ä¸­å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼ˆå¦‚ INSERTã€DELETEã€UPDATEï¼‰çš„æ—¶å€™ï¼Œ æ‰éœ€è¦è®°å½•undo logï¼Œå¿«ç…§è¯» select ä¸éœ€è¦è®°å½•ã€‚ ä¸åŒçš„ä¿®æ”¹æ“ä½œäº§ç”Ÿçš„ undo log è®°å½•çš„å†…å®¹å’Œç»“æ„ä¼šæœ‰æ‰€ä¸åŒï¼Œå› ä¸ºæ¯ç§æ“ä½œå¯¹æ•°æ®çš„å½±å“ä¸åŒ, æ‰€ä»¥undo log ä¹Ÿä¼šæœ‰ä¸åŒçš„ç±»å‹ã€‚ InnoDB çš„ undo log ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼š TRX_UNDO_INSERTï¼šæ­¤ç±»ä¸»è¦åŒ…æ‹¬ TRX_UNDO_INSERT_REC ç±»å‹çš„æ—¥å¿—ï¼Œä¸“é—¨ç”¨äºè®°å½•æ’å…¥æ“ä½œçš„æ’¤é”€ä¿¡æ¯ã€‚ TRX_UNDO_UPDATEï¼šæ­¤ç±»åŒ…æ‹¬ TRX_UNDO_UPD_EXIST_REC å’Œ TRX_UNDO_DEL_MARK_RECï¼Œç”¨äºè®°å½•æ›´æ–°å­˜åœ¨çš„è®°å½•å’Œæ ‡è®°åˆ é™¤æ“ä½œçš„æ’¤é”€ä¿¡æ¯ã€‚ å…±åŒç‚¹ï¼šæ‰€æœ‰ç±»å‹çš„æ“ä½œéƒ½éœ€è¦ä¸”åªéœ€è¦è®°å½•è¶³å¤Ÿçš„ä¿¡æ¯æ¥é€†è½¬æ‰€æ‰§è¡Œçš„æ“ä½œã€‚è¿™äº›è®°å½•éƒ½å­˜å‚¨åœ¨ InnoDB çš„ undo è¡¨ç©ºé—´æˆ–è€…ç³»ç»Ÿè¡¨ç©ºé—´ä¸­ å·®å¼‚ï¼šä¸åŒæ“ä½œç±»å‹çš„ undo æ—¥å¿—è®°å½•çš„å…·ä½“å†…å®¹æ ¹æ®æ“ä½œçš„æ€§è´¨è€Œå¼‚ã€‚INSERT ä¸»è¦å…³æ³¨æ ‡è®°æ–°å¢è¡Œçš„åˆ é™¤ï¼ŒDELETE éœ€è¦è®°å½•å®Œæ•´çš„è¡Œæ•°æ®ä»¥ä¾¿æ¢å¤ï¼Œè€Œ UPDATE è®°å½•ä¿®æ”¹å‰çš„å­—æ®µå€¼ã€‚ âš ï¸ï¼šå¯¹äº undo log çš„è®°å½•å¹¶ä¸æ˜¯åŸºäºæ¯æ¡ä¿®æ”¹ SQL è¯­å¥ï¼Œè€Œæ˜¯åŸºäº ä¿®æ”¹SQL è¯­å¥å½±å“çš„æ¯ä¸€æ¡è®°å½•ã€‚è¿™æ„å‘³ç€æ¯æ¡è¢«ä¿®æ”¹çš„è®°å½•éƒ½ä¼šæœ‰å¯¹åº”çš„ undo log ã€‚å¦‚æœä¸€ä¸ª SQL è¯­å¥å½±å“ä¿®æ”¹äº†å¤šè¡Œæ•°æ®ï¼Œé‚£ä¹ˆå°†ä¼šæœ‰å¤šæ¡ undo log ç”Ÿæˆã€‚ 1.2 INSERT æ“ä½œçš„ Undo logå¯¹äº INSERT æ“ä½œï¼Œundo æ—¥å¿—é€šå¸¸è®°å½•è¾ƒå°‘çš„ä¿¡æ¯ï¼Œä¸»è¦æ˜¯æŠŠè¿™æ¡è®°å½•çš„ä¸»é”®ä¿¡æ¯è®°ä¸Šã€‚ 1.2.1 end of record å’Œ start of recordåœ¨InnoDBçš„undoæ—¥å¿—ç»“æ„ä¸­ï¼Œend of recordå’Œstart of record ä¸¤ä¸ªå­—æ®µå…±åŒèµ·åˆ°é“¾æ¥undoæ—¥å¿—è®°å½•çš„ä½œç”¨ï¼Œä½¿è¿™äº›è®°å½•å½¢æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¹¶æä¾›é¡ºåºéå†å’Œåå‘éå†çš„åŠŸèƒ½ end of record å®šä¹‰ï¼š end of recordå­—æ®µæŒ‡ç¤ºå½“å‰undoæ—¥å¿—è®°å½•çš„ç»“æŸä½ç½®ï¼Œå¹¶æä¾›ä¸‹ä¸€æ¡undoæ—¥å¿—è®°å½•çš„èµ·å§‹åœ°å€ã€‚ å½“æœ€åä¸€æ¡undoæ—¥å¿—è®°å½•æ²¡æœ‰åç»§æ—¶ï¼Œåˆ™ä¸‹ä¸€æ¡undoæ—¥å¿—è®°å½•çš„èµ·å§‹åœ°å€ä¸ºNULL ç›®çš„ï¼š æŒ‡å‘é“¾è¡¨ä¸­çš„ä¸‹ä¸€æ¡è®°å½•ï¼Œæ–¹ä¾¿é¡ºåºéå†æ—¥å¿—è®°å½•ï¼Œå¯ä»¥ç”¨äºå›æ”¾æˆ–è€…é‡åšæ—¥å¿—ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¢å¤é˜¶æ®µ start of record å®šä¹‰ï¼š start of recordå­—æ®µæŒ‡ç¤ºå½“å‰undoæ—¥å¿—è®°å½•çš„èµ·å§‹ä½ç½®ï¼Œå¹¶æä¾›ä¸Šä¸€æ¡undoæ—¥å¿—è®°å½•çš„ç»“æŸåœ°å€ã€‚ å¦‚æœå½“å‰undoæ—¥å¿—è®°å½•æ˜¯é“¾è¡¨ä¸­çš„ç¬¬ä¸€æ¡ï¼Œåˆ™ä¸Šä¸€æ¡undoæ—¥å¿—è®°å½•çš„ç»“æŸåœ°å€ä¸ºNULLã€‚ ç›®çš„ï¼š æŒ‡å‘é“¾è¡¨ä¸­çš„ä¸Šä¸€æ¡è®°å½•ï¼Œæ–¹ä¾¿åå‘éå†æ—¥å¿—è®°å½•ï¼Œç”¨äºäº‹åŠ¡å›æ»š 1.2.2 undo typeè¯¥å­—æ®µæŒ‡å®šundoæ—¥å¿—è®°å½•çš„ç±»å‹, ç”¨äºåŒºåˆ†ä¸åŒç±»å‹çš„undoæ“ä½œï¼Œå¦‚TRX_UNDO_INSERT_REC ã€ TRX_UNDO_UPD_EXIST_REC å’Œ TRX_UNDO_DEL_MARK_REC 1.2.3 undo noæ—¥å¿—ç¼–å·ï¼Œ åœ¨ä¸€ä¸ªäº‹åŠ¡å†…ä»0å¼€å§‹é€’å¢ï¼Œæ¯ç”Ÿæˆä¸€æ¡æ—¥å¿—ï¼Œundo no å°±åŠ 1 1.2.4 table idåŸå§‹è®°å½•æ‰€åœ¨è¡¨çš„æ ‡è¯†ç¬¦ï¼Œä½¿undoæ—¥å¿—èƒ½å¤Ÿä¸åŸå§‹è®°å½•æ‰€åœ¨çš„è¡¨å…³è”ã€‚ 1.2.5 æ­¤éƒ¨åˆ†ä»¥&lt;é•¿åº¦ï¼Œå€¼&gt;çš„å½¢å¼ä¿å­˜æ¯ä¸ªä¸»é”®åˆ—çš„ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨å›æ»šæ’å…¥æ“ä½œæ—¶æ¢å¤ä¸»é”®å€¼ï¼š lenï¼šè¡¨ç¤ºå¯¹åº”åˆ—çš„å­˜å‚¨ç©ºé—´å¤§å°ã€‚ valueï¼šå­˜å‚¨ä¸»é”®çš„å®é™…å€¼ã€‚ 1.3 DELETE æ“ä½œçš„ Undo log-æ ‡è®°åˆ é™¤ trx_idè®°å½•ä¸Šä¸€ä¸ªæ—§ç‰ˆæœ¬æ•°æ®çš„trx_id, è¯¥å€¼ä»è¡Œè®°å½•çš„éšè—åˆ—trx_id ä¸­è·å– ç›®çš„ï¼š åœ¨å›æ»šè¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªå­—æ®µå¯ä»¥å¸®åŠ©æ¢å¤è¢«åˆ é™¤çš„è®°å½•çš„åŸå§‹äº‹åŠ¡ä¿¡æ¯ï¼Œç¡®ä¿åœ¨æ¢å¤æœŸé—´ä¸ä¼šå‡ºç°ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ roll_pointerè®°å½•ä¸Šä¸€ä¸ªæ—§ç‰ˆæœ¬æ•°æ®çš„roll_pointer, è¯¥å€¼ä»è¡Œè®°å½•çš„éšè—åˆ—roll_pointer ä¸­è·å– æè¿°ï¼š æŒ‡å‘è¢«åˆ é™¤è®°å½•çš„åŸå§‹å›æ»šæŒ‡é’ˆ (roll_pointer)ã€‚ åœ¨InnoDBä¸­ï¼Œæ¯æ¡è¡Œè®°å½•éƒ½æœ‰ä¸€ä¸ªä½ï¼ˆbitï¼‰æ ‡è®°æ¥æŒ‡ç¤ºè¯¥è®°å½•çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬æ˜¯å¦å·²è¢«åˆ é™¤ã€‚è¿™æ˜¯é€šè¿‡è®°å½•å¤´ï¼ˆRecord Headerï¼‰ä¸­çš„info bitså­—æ®µå®ç°çš„ã€‚ 1.3.1 æ ‡è®°åˆ é™¤TRX_UNDO_DEL_MARK_REC æ—¥å¿— æŒ‡çš„æ˜¯å¯¹è®°å½•çš„é€»è¾‘åˆ é™¤ï¼Œé€»è¾‘åˆ é™¤æŒ‡çš„æ˜¯åªè¢«æ ‡è®°ä¸ºåˆ é™¤çŠ¶æ€ï¼Œå¹¶ä¸ä¼šç«‹å³å°†å…¶ç‰©ç†åˆ é™¤ï¼Œå› ä¸ºè¿˜è¦æ”¯æŒäº‹åŠ¡å›æ»šï¼Œä»¥åŠMVCCã€‚ è¢«æ ‡è®°åˆ é™¤çš„æ•°æ®å¦‚æœçœŸçš„éœ€è¦åˆ é™¤ï¼Œä¼šåœ¨é€‚å½“çš„æ—¶å€™ç”±åå°çº¿ç¨‹å®é™…æ¸…ç† 1.3.2 è¡Œè®°å½•çš„åˆ é™¤æ ‡è®°æ¯æ¡è¡Œè®°å½•çš„å¤´éƒ¨éƒ½æœ‰ä¸€ä¸ªinfo bitså­—æ®µï¼Œç”¨æ¥å­˜å‚¨è®°å½•çš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ˜¯å¦å·²è¢«åˆ é™¤ã€‚ åœ¨info bitså­—æ®µçš„ç¬¬5ä¸ªbitä½ä¸Šï¼Œæ ‡è®°è®°å½•æ˜¯å¦å·²è¢«åˆ é™¤ï¼Œ å½“æ­¤bitä½ä¸º1æ—¶ï¼Œè¡¨ç¤ºè¯¥è®°å½•å·²è¢«æ ‡è®°åˆ é™¤ï¼›ä¸º0æ—¶ï¼Œè¡¨ç¤ºè¯¥è®°å½•æ˜¯æ­£å¸¸çš„ã€‚ 1.4 UPDATE æ“ä½œçš„ Undo logupdate çš„æ“ä½œ åˆ†ä¸ºä¸¤ç§ ä¸æ›´æ–°ä¸»é”®çš„update, è¿™ç§æ“ä½œ ä¸€æ¡è®°å½• åªä¼šTRX_UNDO_UPD_EXIST_REC ä¸€æ¡undo log æ›´æ–°ä¸»é”®çš„update ï¼Œè¿™ç§updateåœ¨å®é™…æ‰§è¡Œæ—¶ï¼Œ ä¼šå…ˆåˆ é™¤æ—§è®°å½•ï¼Œå†insert ä¸€æ¡æ–°çºªå½•ï¼Œ æ‰€ä»¥ä¼šè®°å½•ä¸¤æ¡undo log, ä¸€æ¡TRX_UNDO_DEL_MARK_RECï¼Œ ä¸€æ¡TRX_UNDO_INSERT_REC å…·ä½“å­—æ®µä¿¡æ¯å’Œå‰é¢ä¸¤ç§ç±»ä¼¼ï¼Œä¸å†è¯¦è¿°ã€‚ 2ä¸€ä¸ªäº‹åŠ¡ä¸­çš„å¤šæ¡undo logå¦‚ä½•ç»„ç»‡åœ¨ä¸€èµ·2.1 undo page -åˆ†ç±»å‹å­˜å‚¨undo logInnoDB å¯¹æ•°æ®çš„ç®¡ç†æ˜¯ä»¥ page ä¸ºå•ä½è¿›è¡Œçš„ï¼Œundo log ä¹Ÿéµå¾ªè¿™ä¸€åŸåˆ™ï¼Œå³å­˜å‚¨åœ¨ä¸“é—¨çš„ undo pages ä¸­ã€‚ æ¯ä¸ª undo page ä¸­çš„æ—¥å¿—è®°å½•æ˜¯ä¸“ç”¨çš„ï¼Œä¸åŒç±»å‹çš„undo log ä¸èƒ½æ··ç€å­˜å‚¨ï¼Œ å³ä¸€ä¸ª page ä¸­ä¸èƒ½åŒæ—¶è®°å½• TRX_UNDO_INSERT ç±»å‹å’Œ TRX_UNDO_UPDATE ç±»å‹çš„æ—¥å¿—ã€‚ è¿™æ ·è®¾è®¡çš„ç†ç”±æ˜¯ä¸ºäº†é¿å…åœ¨å›æ»šæ—¶éœ€è¦åœ¨åŒä¸€é¡µé¢ä¸Šæœç´¢ä¸åŒç±»å‹çš„æ—¥å¿—è®°å½•ï¼Œä»è€Œæé«˜äº†å›æ»šæ“ä½œçš„æ•ˆç‡ã€‚ å¯æ˜¯ ä¸€ä¸ªäº‹åŠ¡å†…å¯ä»¥åŒæ—¶å­˜åœ¨insert undo logå’Œupdate undo log, å¦‚æœäº‹åŠ¡éœ€è¦å›æ»šåˆ™æ‰€æœ‰æ“ä½œéƒ½éœ€è¦å›æ»šï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦åˆ†å¼€å­˜å‚¨å‘¢ï¼Ÿ ä¼˜åŒ–äº‹åŠ¡å›æ»šçš„é€»è¾‘ æ“ä½œä¾èµ–æ€§å‡å°‘ï¼šæ’å…¥æ“ä½œçš„å›æ»šä»…æ¶‰åŠåˆ°åˆ é™¤ä¹‹å‰æ’å…¥çš„è¡Œï¼Œè€Œæ›´æ–°æˆ–åˆ é™¤æ“ä½œçš„å›æ»šéœ€è¦æ¢å¤åŸå§‹æ•°æ®ã€‚å°†è¿™äº›æ“ä½œçš„æ—¥å¿—åˆ†å¼€ï¼Œå¯ä»¥åœ¨å›æ»šæ—¶å‡å°‘å¯¹ä¸åŒç±»å‹æ—¥å¿—å¤„ç†é€»è¾‘çš„ä¾èµ–ï¼Œä½¿å¾—å›æ»šè¿‡ç¨‹æ›´åŠ æ¨¡å—åŒ–å’Œæœ‰åºã€‚ æ‰§è¡Œæ•ˆç‡ï¼šåˆ†å¼€å­˜å‚¨ä½¿å¾—å¤„ç†å„è‡ªçš„å›æ»šé€»è¾‘æ—¶å¯ä»¥æ›´åŠ é«˜æ•ˆï¼Œå› ä¸ºæ¯ç§ç±»å‹çš„å›æ»šå¤„ç†åªéœ€å…³æ³¨å…¶å¯¹åº”ç±»å‹çš„æ—¥å¿—é¡µã€‚è¿™å‡å°‘äº†åœ¨å•ä¸€æ—¥å¿—é¡µä¸­æœç´¢å’Œå¤„ç†ä¸åŒç±»å‹æ—¥å¿—çš„å¤æ‚æ€§å’Œæ—¶é—´ã€‚ å¹¶è¡Œå¤„ç†å°½ç®¡ä¸€ä¸ªäº‹åŠ¡ä¸­å¯èƒ½å­˜åœ¨å¤šç§ç±»å‹çš„ undo æ—¥å¿—ï¼Œä½†åœ¨å¹¶å‘ç¯å¢ƒä¸­ï¼Œä¸åŒçš„å›æ»šä»»åŠ¡å¯èƒ½ç”±ä¸åŒçš„ç³»ç»Ÿè¿›ç¨‹æˆ–çº¿ç¨‹å¤„ç†ã€‚ä¾‹å¦‚ï¼ŒæŸäº›æƒ…å†µä¸‹ç³»ç»Ÿå¯èƒ½å¹¶è¡Œåœ°å¤„ç† insert undo log å’Œ update undo logã€‚åˆ†å¼€å­˜å‚¨å¯ä»¥å‡å°‘é”çš„ç«äº‰å’Œç®¡ç†çš„å¤æ‚æ€§ï¼Œæé«˜å¹¶å‘å¤„ç†çš„æ•ˆç‡ã€‚ ç©ºé—´å’Œæ€§èƒ½ç®¡ç† ç®€åŒ–ç©ºé—´å›æ”¶ï¼šåœ¨äº‹åŠ¡æäº¤åï¼Œinsert undo log å¯ä»¥ç«‹å³è¢«ä¸¢å¼ƒå’Œå›æ”¶ï¼Œå› ä¸ºæ’å…¥æ“ä½œç”Ÿæˆçš„è®°å½•ä¸€æ—¦æäº¤å³è§†ä¸ºæœ‰æ•ˆã€‚è€Œ update undo log å¯èƒ½éœ€è¦è¢«ä¿ç•™ä»¥æ”¯æŒå…¶ä»–äº‹åŠ¡çš„ä¸€è‡´æ€§è¯»ï¼ˆç”±äº MVCCï¼‰ã€‚åˆ†å¼€å­˜å‚¨ä½¿å¾—ç©ºé—´ç®¡ç†æ›´ä¸ºé«˜æ•ˆï¼Œå› ä¸ºå¯ä»¥é’ˆå¯¹æ€§åœ°å¤„ç†å’Œå›æ”¶æ—¥å¿—ç©ºé—´ã€‚ ä¼˜åŒ–è¯»å–æ€§èƒ½ï¼šåœ¨äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå°¤å…¶æ˜¯åœ¨ä¸€äº›åªæ¶‰åŠåˆ°ç‰¹å®šç±»å‹æ“ä½œçš„æŸ¥è¯¢æˆ–å›æ»šæ“ä½œä¸­ï¼Œåˆ†å¼€å­˜å‚¨å¯ä»¥ä¼˜åŒ–æ—¥å¿—çš„è¯»å–æ€§èƒ½ï¼Œå› ä¸ºç³»ç»Ÿå¯ä»¥ç›´æ¥å®šä½åˆ°ç›¸å…³ç±»å‹çš„æ—¥å¿—é¡µã€‚ æ—¥å¿—ç»´æŠ¤çš„ç®€åŒ– åˆ†å¼€å­˜å‚¨æœ‰åŠ©äºç®€åŒ–æ—¥å¿—ç»´æŠ¤å’Œæ—¥å¿—ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ç³»ç»Ÿå¯ä»¥æ›´å®¹æ˜“åœ°è¿½è¸ªå’Œç®¡ç†ä¸åŒç±»å‹æ—¥å¿—çš„ç”Ÿæˆã€ä½¿ç”¨å’Œæ¸…ç†å‘¨æœŸã€‚ 2.2 undo page é“¾è¡¨åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå¤šæ¡ undo logã€‚ å¦‚æœä¸€ä¸ª undo page å¡«æ»¡äº†ï¼Œäº‹åŠ¡ä¼šå‘ç³»ç»Ÿç”³è¯·æ–°çš„undo page,å¹¶å°†å…¶é€šè¿‡é“¾è¡¨ï¼ˆé€šå¸¸æ˜¯ä½¿ç”¨ç±»ä¼¼äºå‰é©±ï¼ˆpreviousï¼‰å’Œåç»§ï¼ˆnextï¼‰æŒ‡é’ˆçš„æœºåˆ¶ï¼‰è¿æ¥èµ·æ¥ã€‚ å‰é¢æåˆ°è¿‡ï¼Œä¸€ä¸ª undo page ä¸èƒ½æ··åˆå­˜å‚¨ä¸èƒ½ç±»å‹çš„é“¾æ¥ï¼Œ æ‰€ä»¥å¯¹äºä¸€ä¸ªäº‹åŠ¡å®ƒå¯ä»¥æœ‰insert undo page å’Œupdate undo page ä¸¤ä¸ªé“¾è¡¨ã€‚ æ¯ä¸ªäº‹åŠ¡éƒ½ä¼šåˆ†é…å•ç‹¬çš„é¡µé¢é“¾è¡¨ã€‚ ä¸‹é¢ç®€å•ä»‹ç»ä¸‹é“¾è¡¨ä¸­ç¬¬ä¸€ä¸ª undo page file header å¦‚å‰é¢ä»‹ç»ï¼Œä¼šæœ‰ä¸€ä¸ªå­—æ®µæ¥æ ‡è¯†è¯¥page æ˜¯undo page, ç”¨æ¥å­˜å‚¨undo logã€‚ undo page header ä¼šè®°å½•è¯¥é¡µé¢å­˜å‚¨çš„undo log ç±»å‹ï¼Œ insert or update undo log segment header , ä¼šè®°å½•è¯¥é“¾è¡¨æ‰€å±çš„segment undo log header ,ç†è®ºä¸Šï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½ä¼šåˆ†é…è‡ªå·±çš„é¡µé¢é“¾è¡¨ï¼Œ ä½†å¦‚æœä¸€ä¸ªäº‹åŠ¡äº§ç”Ÿçš„undo logå¾ˆå°‘ï¼Œé‚£ä¹ˆè¿™ä¸ªé¡µé¢é“¾è¡¨å°±æœ‰å¯èƒ½è¢«é‡ç”¨ã€‚æ‰€ä»¥å®é™…ä¸Šä¸€ä¸ªé¡µé¢é“¾è¡¨ä¸­å®é™…å¯èƒ½å­˜å‚¨å¤šä¸ªäº‹åŠ¡çš„undo log, undo log header ä¸­è®°å½•äº†ä¸åŒäº‹åŠ¡é—´æ—¥å¿—çš„åˆ†éš”ä¿¡æ¯ã€‚ 2.3 å›æ»šæ®µInnoDBé»˜è®¤åˆ›å»º128ä¸ªå›æ»šæ®µï¼ˆRollback Segmentsï¼‰ï¼Œç”¨äºç®¡ç†undoæ—¥å¿—ã€‚ å…ƒæ•°æ®å­˜å‚¨ï¼š æ¯ä¸ªå›æ»šæ®µçš„å…ƒæ•°æ®å­˜å‚¨åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ç¬¬5å·é¡µé¢ä¸­ã€‚ Slotç»“æ„ï¼šæ¯ä¸ªå›æ»šæ®µåŒ…å«1024ä¸ªslotï¼Œæ¯ä¸ªslotå¯ä»¥æ˜ å°„åˆ°ä¸€ä¸ªUndoé¡µã€‚ äº‹åŠ¡ä¸å›æ»šæ®µçš„å…³è”ï¼š äº‹åŠ¡ä¼šåœ¨éœ€è¦çš„æ—¶å€™åˆ†é…ä¸€ä¸ªå›æ»šæ®µã€‚ è½®è¯¢ç­–ç•¥ï¼š InnoDBä½¿ç”¨è½®è¯¢æ–¹å¼å°†å›æ»šæ®µåˆ†é…ç»™æ–°äº‹åŠ¡ï¼Œä»¥å®ç°è´Ÿè½½å‡è¡¡ã€‚ 2.4 Undoé¡µé“¾è¡¨çš„å½¢æˆä¸ç»´æŠ¤ äº‹åŠ¡å¼€å§‹ï¼š æ–°çš„äº‹åŠ¡å¼€å§‹æ—¶ï¼Œä¼šåˆ†é…ä¸€ä¸ªæ’å…¥æ®µå’Œä¸€ä¸ªæ›´æ–°æ®µã€‚ åœ¨åˆ†é…çš„å›æ»šæ®µå¤´é¡µä¸­ï¼Œåˆå§‹åŒ–undoé¡µé“¾è¡¨çš„å¤´æŒ‡é’ˆå’Œå°¾æŒ‡é’ˆã€‚ æŸ¥æ‰¾å¯ç”¨çš„Slotï¼š äº‹åŠ¡åœ¨å¼€å§‹å†™å…¥undoæ—¥å¿—æ—¶ï¼Œä¼šé¦–å…ˆæŸ¥æ‰¾ä¸€ä¸ªå¯ç”¨çš„slotï¼Œå¹¶åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„undoé¡µé“¾è¡¨ã€‚ åˆ†é…æ–°çš„Undoé¡µï¼š åˆ†é…æ–°çš„undoé¡µï¼Œå°†å…¶æ·»åŠ åˆ°undoé¡µé“¾è¡¨çš„æœ«å°¾ã€‚ å¦‚æœè¿™æ˜¯é“¾è¡¨çš„ç¬¬ä¸€ä¸ªundoé¡µï¼Œå›æ»šæ®µå¤´é¡µçš„firstæŒ‡é’ˆå’ŒlastæŒ‡é’ˆä¼šåŒæ—¶æŒ‡å‘è¯¥é¡µã€‚ ç»´æŠ¤Undoé¡µé“¾è¡¨ï¼š å½“undoé¡µé“¾è¡¨ä¸­çš„æœ€åä¸€ä¸ªundoé¡µå·²æ»¡æ—¶ï¼Œåˆ†é…ä¸€ä¸ªæ–°çš„undoé¡µå¹¶é“¾æ¥åˆ°é“¾è¡¨çš„æœ«å°¾ã€‚ å›æ»šæ®µå¤´é¡µçš„lastæŒ‡é’ˆä¼šæŒ‡å‘æ–°åˆ†é…çš„undoé¡µã€‚ æ–°undoé¡µçš„prevæŒ‡é’ˆæŒ‡å‘é“¾è¡¨çš„å‰ä¸€ä¸ªundoé¡µï¼Œå½¢æˆé“¾è¡¨ç»“æ„ã€‚ 3 è¡Œè®°å½•å¦‚ä½•ä¸undo log å…³è” -roll_pointer roll_pointer æ˜¯å­˜å‚¨åœ¨æ¯ä¸ªè¡Œè®°å½•ä¸­çš„ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥è¡Œè®°å½•ç›¸å…³çš„æœ€è¿‘ä¸€æ¬¡undo log è®°å½•ã€‚ æ³¨æ„è¿™ä¸ªundo è®°å½•æŒ‡çš„æ˜¯å…·ä½“çš„ undo logï¼Œè€Œä¸æ˜¯æ•´ä¸ªé¡µé¢é“¾è¡¨ã€‚ å½“è¡Œè®°å½•è¢«ä¿®æ”¹ï¼ˆåŒ…æ‹¬æ›´æ–°ã€åˆ é™¤æˆ–ä½œä¸ºå¤šæ­¥æ“ä½œçš„ä¸€éƒ¨åˆ†çš„æ’å…¥ï¼‰æ—¶ï¼ŒInnoDB é¦–å…ˆä¼šåœ¨ undo æ—¥å¿—ä¸­å†™å…¥ä¸€æ¡è®°å½•ï¼Œè¿™æ¡è®°å½•åŒ…å«äº†è¡Œä¿®æ”¹å‰çš„æ•°æ®ï¼Œå’Œè¡Œè®°å½•ä¸­çš„çš„roll_pointer, InnoDB æ›´æ–°è¡Œè®°å½•ä¸­çš„ roll_pointerï¼Œä½¿å…¶æŒ‡å‘æ–°å†™å…¥çš„ undo æ—¥å¿—è®°å½•ã€‚å¦‚æœè¿™ä¸ªè¡Œå†æ¬¡è¢«ä¿®æ”¹ï¼Œæ–°çš„ undo æ—¥å¿—å°†è¢«å†™å…¥ï¼Œroll_pointer ä¼šæ›´æ–°ä¸ºæŒ‡å‘è¿™æ¡æ–°çš„è®°å½•ã€‚æ–°çš„undo æ—¥å¿—ä¸­ä¼šè®°å½•ä¹‹å‰çš„roll_pointer 4. ä¸€æ¡è®°å½•çš„ç‰ˆæœ¬é“¾å¦‚ä½•å½¢æˆInnoDB é€šè¿‡ roll_ptr æŠŠæ¯ä¸€è¡Œçš„å†å²ç‰ˆæœ¬ä¸²è”åœ¨ä¸€èµ· è¡Œè®°å½•ä¸­æœ‰roll_pointer, update æ“ä½œä¸­TRX_UNDO_UPD_EXIST_REC å’Œ TRX_UNDO_DEL_MARK_REC ç±»å‹çš„undo log ä¸­ï¼Œä¹Ÿæœ‰roll_pointer,é€šè¿‡è¿™äº›roll_pointer, å¯ä»¥å½¢æˆä¸€æ¡è¡Œè®°å½•çš„ç‰ˆæœ¬é“¾ã€‚ insert æ“ä½œä¸­ï¼Œå¯¹åº”çš„undo logæ²¡æœ‰roll_pointer å±æ€§ï¼Œå› ä¸ºinsert æ“ä½œå°±æ˜¯ä¸€ä¸ªè¡Œè®°å½•çš„åˆå§‹ç‰ˆæœ¬ï¼Œæ²¡æœ‰æ¯”å®ƒæ›´æ—©çš„æ“ä½œäº†ã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªé€šè¿‡roll_pointer ç»„æˆçš„ç‰ˆæœ¬é“¾ï¼Œæ¯ä¸ªundo log è¿›è¡Œäº†å†…å®¹çœç•¥ä»¥å±•ç¤ºé“¾æ¥çš„é‡ç‚¹å†…å®¹ 5. undo log çš„æŒä¹…åŒ–undoæ—¥å¿—åˆ·ç›˜æ—¶æœºçš„å‚æ•°ï¼Œä½†é€šè¿‡æ§åˆ¶Redoæ—¥å¿—ã€è„é¡µåˆ·æ–°å’ŒPurgeçº¿ç¨‹çš„å‚æ•°ï¼Œå¯ä»¥é—´æ¥å½±å“undoæ—¥å¿—çš„åˆ·ç›˜ç­–ç•¥ã€‚ WALæŠ€æœ¯åœ¨æ•°æ®å®é™…ä¿®æ”¹å‰ï¼Œå…ˆå°†undoæ—¥å¿—æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚ åˆ·ç›˜æ—¶æœºï¼š äº‹åŠ¡æäº¤ï¼š å½“äº‹åŠ¡æäº¤æ—¶ï¼Œç›¸å…³çš„undoæ—¥å¿—ä¼šè¢«å†™å…¥ç£ç›˜ã€‚ è„é¡µåˆ·ç›˜ï¼š åœ¨InnoDBå°†è„é¡µï¼ˆdirty pageï¼‰å†™å…¥ç£ç›˜ä¹‹å‰ï¼Œé¦–å…ˆä¼šç¡®ä¿æ‰€æœ‰ç›¸å…³çš„undoæ—¥å¿—å·²ç»è¢«æŒä¹…åŒ–ã€‚ Redoæ—¥å¿—åŒæ­¥ï¼š å½“ä¸€ä¸ªRedoæ—¥å¿—è¢«åŒæ­¥åˆ°ç£ç›˜æ—¶ï¼Œæ‰€æœ‰ç›¸å…³çš„undoæ—¥å¿—ä¹Ÿå¿…é¡»è¢«åŒæ­¥ã€‚ 6 åŸºäºundo log çš„å›æ»šæ“ä½œInnoDBä¸­çš„äº‹åŠ¡ å¯èƒ½ä¼šç”±ç”¨æˆ·ä¸»åŠ¨è§¦å‘Rollbackï¼› ä¹Ÿå¯èƒ½å› ä¸ºé‡åˆ°æ­»é”å¼‚å¸¸Rollbackï¼› æˆ–è€…å‘ç”ŸCrashï¼Œé‡å¯åå¯¹æœªæäº¤çš„äº‹åŠ¡å›æ»šã€‚6.1. ç”¨æˆ·/åº”ç”¨ç¨‹åºä¸»åŠ¨å›æ»š åå‘éå†ï¼ˆstart of recordï¼‰å½“å‰äº‹åŠ¡çš„undoæ—¥å¿—é“¾è¡¨ï¼ŒæŒ‰é€†åºæ¢å¤æ¯ä¸ªæ›´æ”¹ã€‚ æ’å…¥æ“ä½œï¼š åœ¨æ•°æ®é¡µä¸­åˆ é™¤å·²æ’å…¥çš„è®°å½•ã€‚ åˆ é™¤æ“ä½œï¼š æ¢å¤å·²åˆ é™¤çš„è®°å½•ã€‚ æ›´æ–°æ“ä½œï¼š æ¢å¤æ›´æ–°å‰çš„è®°å½•ã€‚ æ¯ä¸ªæ“ä½œæ¢å¤å®Œæˆåï¼Œä»undoæ—¥å¿—é“¾è¡¨ä¸­ç§»é™¤ç›¸åº”çš„undoæ—¥å¿—è®°å½•ã€‚ 6.2. æ­»é”å¼‚å¸¸å›æ»šInnoDBé€šè¿‡æ­»é”æ£€æµ‹ç®—æ³•å‘ç°ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡ä¹‹é—´çš„é”ç­‰å¾…ï¼Œå½¢æˆæ­»é”ï¼Œ,é€‰æ‹©æœ€å°ä»£ä»·ï¼Œå³æŒæœ‰é”èµ„æºæœ€å°‘çš„äº‹åŠ¡åŠ¡è¿›è¡Œå›æ»šã€‚ ä¸ä¸»åŠ¨å›æ»šç±»ä¼¼ï¼Œéå†å½“å‰äº‹åŠ¡çš„undoæ—¥å¿—é“¾è¡¨ï¼ŒæŒ‰é€†åºæ¢å¤æ¯ä¸ªæ›´æ”¹ã€‚ 6.3 å´©æºƒæ¢å¤MySQLæœåŠ¡å™¨æˆ–æ“ä½œç³»ç»Ÿå´©æºƒåï¼ŒInnoDBé€šè¿‡Undoæ—¥å¿—ä¸Redoæ—¥å¿—ç»“åˆï¼Œç¡®ä¿å´©æºƒæ—¶æ•°æ®é¡µçš„çŠ¶æ€æ¢å¤åˆ°ä¸€è‡´çš„çŠ¶æ€ï¼Œ undoæ—¥å¿—ç”¨æ¥ å›æ»šæœªæäº¤çš„äº‹åŠ¡ã€‚ 7 undo log çš„æ¸…ç†äº‹åŠ¡æäº¤åï¼Œç›¸å…³çš„Undoæ—¥å¿—è®°å½•ä»éœ€ä¿ç•™ä¸€æ®µæ—¶é—´ä»¥æ”¯æŒå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰ 7.1 Purge çº¿ç¨‹InnoDB é€šè¿‡ä¸€ä¸ªåå°çº¿ç¨‹ç§°ä¸º Purgeï¼Œæ¥æ¸…ç†ä¸å†éœ€è¦çš„ undo logã€‚ è§¦å‘æ¡ä»¶ï¼šPurge è¿›ç¨‹ä¼šå®šæœŸæ£€æŸ¥é‚£äº›å·²æäº¤äº‹åŠ¡çš„ undo logã€‚å®ƒä¼šç¡®å®šè¿™äº› undo log æ˜¯å¦è¿˜è¢«å…¶ä»–æ´»è·ƒäº‹åŠ¡ä½œä¸º MVCC çš„ä¸€éƒ¨åˆ†æ‰€éœ€ã€‚ åˆ é™¤æ“ä½œï¼šå¦‚æœä¸€ä¸ª undo log è®°å½•ä¸å†è¢«ä»»ä½•äº‹åŠ¡æ‰€éœ€è¦ï¼ŒPurge è¿›ç¨‹ä¼šå°†å…¶ä» undo è¡¨ç©ºé—´ä¸­åˆ é™¤ï¼Œé‡Šæ”¾ç›¸å…³èµ„æºã€‚ undo log çš„æ¸…ç†æœºåˆ¶æ˜¯åŒºåˆ†æ“ä½œç±»å‹çš„ã€‚ 7.2 Insert Undo LogInsert undo log ä¸»è¦è®°å½•æ’å…¥æ“ä½œçš„ä¿¡æ¯ã€‚å› ä¸ºæ’å…¥æ“ä½œä»…ä»…æ·»åŠ æ–°çš„è®°å½•ï¼Œä¸æ¶‰åŠå·²å­˜åœ¨æ•°æ®çš„ä¿®æ”¹ï¼Œæ‰€ä»¥è¿™ç§ç±»å‹çš„ undo log ä¸»è¦ç”¨äºåœ¨äº‹åŠ¡å¤±è´¥æ—¶æ’¤é”€æ’å…¥æ“ä½œã€‚ æ¸…ç†æ—¶æœºï¼šå½“ä¸€ä¸ªäº‹åŠ¡è¿›è¡Œæ’å…¥æ“ä½œå¹¶æˆåŠŸæäº¤åï¼Œç›¸åº”çš„ insert undo log ç«‹å³å˜å¾—æ— ç”¨ï¼Œå› ä¸ºæ’å…¥çš„æ•°æ®å·²ç»è¢«ç¡®è®¤å¹¶ä¸éœ€è¦å†è¢«æ’¤é”€ã€‚æ­¤æ—¶ï¼Œè¿™äº› undo log å¯ä»¥è¢«å®‰å…¨åœ°æ¸…ç†æ‰ï¼Œå› ä¸ºå®ƒä»¬ä¸å†è¢«ä»»ä½•äº‹åŠ¡æ‰€éœ€ã€‚ æ¸…ç†è¿‡ç¨‹ï¼šPurge çº¿ç¨‹ä¼šæ£€æµ‹åˆ°è¿™äº› insert undo log ä¸å·²æäº¤çš„äº‹åŠ¡å…³è”ï¼Œå¹¶å°†å®ƒä»¬æ ‡è®°ä¸ºå¯æ¸…ç†ã€‚ç„¶åï¼Œè¿™äº› log ä¼šä» undo è¡¨ç©ºé—´ä¸­åˆ é™¤ï¼Œç›¸å…³çš„ç£ç›˜ç©ºé—´å¾—ä»¥å›æ”¶ã€‚ 7.3 Update Undo LogUpdate undo log è®°å½•äº†å¯¹ç°æœ‰æ•°æ®çš„ä¿®æ”¹ï¼ˆåŒ…æ‹¬æ›´æ–°å’Œåˆ é™¤æ“ä½œï¼‰ã€‚è¿™äº›è®°å½•å¯¹äºäº‹åŠ¡å›æ»šå’Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰è‡³å…³é‡è¦ã€‚ æ¸…ç†æ—¶æœºï¼šä¸ insert undo log ä¸åŒï¼Œå³ä½¿ç›¸å…³äº‹åŠ¡å·²ç»æäº¤ï¼Œupdate undo log ä¹Ÿä¸èƒ½ç«‹å³è¢«æ¸…ç†ã€‚è¿™æ˜¯å› ä¸ºåœ¨ InnoDB ä¸­å®ç° MVCC æ—¶ï¼Œå…¶ä»–å¹¶å‘äº‹åŠ¡å¯èƒ½éœ€è¦è®¿é—®è¿™äº› log ä¸­çš„æ—§æ•°æ®ç‰ˆæœ¬æ¥ç»´æŒä¸€è‡´æ€§è¯»ã€‚ æ¸…ç†è¿‡ç¨‹ï¼šPurge çº¿ç¨‹ä¼šå‘¨æœŸæ€§åœ°æ£€æŸ¥ update undo logã€‚åªæœ‰å½“è¿™äº› log è®°å½•ä¸å†è¢«ä»»ä½•å…¶ä»–æ´»è·ƒäº‹åŠ¡æ‰€éœ€æ—¶ï¼ˆå³æ²¡æœ‰æ›´æ—©çš„è¯»è§†å›¾éœ€è¦è¿™äº›æ•°æ®ï¼‰ï¼Œå®ƒä»¬æ‰ä¼šè¢«æ ‡è®°ä¸ºå¯æ¸…ç†ã€‚ç„¶åï¼ŒPurge æ“ä½œä¼šé€æ­¥ä» undo è¡¨ç©ºé—´ä¸­åˆ é™¤è¿™äº›è®°å½•ã€‚ 7.4 é•¿äº‹åŠ¡å¯¹undo log æ¸…ç†çš„å½±å“é•¿äº‹åŠ¡æ„å‘³ç€ç³»ç»Ÿé‡Œé¢ä¼šå­˜åœ¨å¾ˆè€çš„äº‹åŠ¡è§†å›¾ã€‚ç”±äºè¿™äº›äº‹åŠ¡éšæ—¶å¯èƒ½è®¿é—®æ•°æ®åº“é‡Œé¢çš„ä»»ä½•æ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªäº‹åŠ¡æäº¤ä¹‹å‰ï¼Œæ•°æ®åº“é‡Œé¢å®ƒå¯èƒ½ç”¨åˆ°çš„å›æ»šè®°å½•éƒ½å¿…é¡»ä¿ç•™ï¼Œè¿™å°±ä¼šå¯¼è‡´å¤§é‡å ç”¨å­˜å‚¨ç©ºé—´ã€‚ ç›¸å…³æ–‡ç« Intro to äº‹åŠ¡Intro to InnoDB äº‹åŠ¡InnoDBäº‹åŠ¡-éš”ç¦»æ€§çš„å®ç°,MVCC &amp; é”InnoDBäº‹åŠ¡-æŒä¹…æ€§çš„å®ç°,binglog &amp; redo log&amp;undo log","tags":["MySQL","äº‹åŠ¡"]},{"title":"Intro to InnoDBäº‹åŠ¡","path":"/9cd551f5/","content":"åœ¨Intro to äº‹åŠ¡ä¸­ä»‹ç»è¿‡ï¼Œ ä¸€è‡´æ€§æ˜¯äº‹åŠ¡çš„æ ¸å¿ƒç‰¹å¾ï¼Œæˆ–è€…è¯´æœ€ç»ˆç›®çš„ï¼ŒåŸå­æ€§ã€éš”ç¦»æ€§å’ŒæŒä¹…æ€§éƒ½æ˜¯å®ç°ä¸€è‡´æ€§çš„æ‰‹æ®µã€‚ æ‰€ä»¥åœ¨ä»‹ç»InnoDB äº‹åŠ¡æ—¶ï¼Œä¸»è¦ä»‹ç»AID ç‰¹æ€§çš„å®ç°InnoDBäº‹åŠ¡-åŸå­æ€§çš„å®ç°ï¼Œ undo logInnoDBäº‹åŠ¡-éš”ç¦»æ€§çš„å®ç°, MVCC &amp; é”InnoDBäº‹åŠ¡-æŒä¹…æ€§çš„å®ç°ï¼Œ binglog &amp; redo log&amp;undo log åœ¨å…·ä½“çœ‹InnoDB äº‹åŠ¡å®ç°AID ç‰¹æ€§ä¹‹å‰ï¼Œå¯ä»¥å…ˆçœ‹ä»¥ä¸‹è¿™äº›å‰ç½®çŸ¥è¯† 1. InnoDB æ•°æ®ç®¡ç†1.1 Pagepage æ˜¯ InnoDB å­˜å‚¨æ•°æ®çš„åŸºæœ¬å•ä½ï¼Œä¹Ÿæ˜¯æ•°æ®åœ¨ç£ç›˜å’Œå†…å­˜ä¹‹é—´äº¤æ¢çš„æœ€å°å•ä½ã€‚æ¯ä¸ªé¡µé€šå¸¸çš„å¤§å°ä¸º 16KBé’ˆå¯¹ä¸åŒçš„æ•°æ®æœ‰ä¸åŒçš„Pageç±»å‹è¿›è¡Œå­˜å‚¨ï¼Œå¦‚index page ç´¢å¼•é¡µï¼Œ undo page ç­‰ File Header ä¸­ æœ‰fil_page_type æ¥æ ‡è¯†è¯¥é¡µçš„ç±»å‹ File Trailer ç”¨æ¥æ ¡éªŒé¡µé¢æ•°æ®æ˜¯å¦å®Œæˆ 1.2 åŒºï¼ˆextentï¼‰ä¸ºäº†æ›´å¥½åœ°ç®¡ç†page, InnoDBå¼•å…¥äº†åŒºçš„æ¦‚å¿µï¼Œ è¿ç»­çš„64ä¸ªpage æ˜¯ä¸€ä¸ªåŒºï¼Œå¤§å°é»˜è®¤æ˜¯1MBã€‚ å¯ä»¥è®¤ä¸ºextent æ˜¯ä¸€ä¸ªç‰©ç†ä¸Šæ¦‚å¿µ ä¸€ä¸ªåŒºï¼ˆExtentï¼‰æ˜¯ç”±è¿ç»­çš„é¡µç»„æˆçš„æ•°æ®å—ï¼Œæ¯ä¸ªåŒºåŒ…å« 64 ä¸ªè¿ç»­çš„é¡µï¼Œå› æ­¤æ¯ä¸ªåŒºçš„å¤§å°ä¸º 1MB ï¼ˆ16KB * 64ï¼‰ã€‚ä½¿ç”¨åŒºçš„ç›®çš„æ˜¯ä¸ºäº†ä¼˜åŒ–ç£ç›˜ç©ºé—´çš„åˆ†é…å’Œç®¡ç†ï¼Œé€šè¿‡æ‰¹é‡å¤„ç†è¿ç»­çš„é¡µ,å‡å°‘éšæœºIOæ¥æé«˜æ•°æ®å­˜å–æ•ˆç‡ã€‚ 1.3 æ®µ ï¼ˆsegment ï¼‰InnoDB ä¸­çš„æ®µï¼ˆSegmentï¼‰ä½œä¸ºä¸€ä¸ªé€»è¾‘ç»“æ„ï¼Œèµ·ç€å°†æ•°æ®åº“çš„é«˜å±‚é€»è¾‘ç»“æ„ï¼ˆå¦‚è¡¨å’Œç´¢å¼•ï¼‰ä¸ä½å±‚ç‰©ç†å­˜å‚¨ç»“æ„ï¼ˆå¦‚é¡µå’ŒåŒºï¼‰è¿æ¥èµ·æ¥çš„æ¡¥æ¢ä½œç”¨ã€‚ ä»¥ä¸‹æ˜¯å‡ ä¸ªè¯¦ç»†çš„ä¾‹å­ï¼Œé€šè¿‡è¿™äº›ä¾‹å­å¯ä»¥æ›´å¥½åœ°ç†è§£æ®µæ˜¯å¦‚ä½•åœ¨æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­å‘æŒ¥ä½œç”¨çš„ã€‚ 1.3.1 æ•°æ®è¡¨æ®µå‡è®¾æ‚¨åœ¨æ•°æ®åº“ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°è¡¨ï¼Œè¿™ä¸ªè¡¨å°†éœ€è¦å­˜å‚¨æ•°æ®è¡Œã€‚InnoDB ä¼šä¸ºè¿™ä¸ªè¡¨åˆ›å»ºä¸€ä¸ªæ•°æ®æ®µï¼š é€»è¾‘å±‚é¢ï¼šåœ¨é€»è¾‘å±‚é¢ï¼Œè¿™ä¸ªæ•°æ®æ®µä»£è¡¨äº†è¡¨ä¸­æ‰€æœ‰æ•°æ®è¡Œçš„é›†åˆã€‚ ç‰©ç†å±‚é¢ï¼šç‰©ç†ä¸Šï¼Œè¿™ä¸ªæ•°æ®æ®µå¼€å§‹æ—¶å¯èƒ½åªåŒ…å«å‡ ä¸ªåŒºï¼Œæ¯ä¸ªåŒºç”± 64 ä¸ªè¿ç»­çš„é¡µç»„æˆã€‚éšç€è¡¨ä¸­æ•°æ®çš„å¢åŠ ï¼Œæ®µå¯ä»¥åŠ¨æ€åœ°åˆ†é…æ›´å¤šçš„åŒºæ¥å­˜å‚¨æ›´å¤šçš„æ•°æ®é¡µã€‚ æ“ä½œï¼šå½“ä½ æ‰§è¡Œ INSERT æ“ä½œå‘è¡¨ä¸­æ·»åŠ æ•°æ®æ—¶ï¼ŒInnoDB å°†åœ¨è¿™ä¸ªæ•°æ®æ®µä¸­æ‰¾åˆ°é€‚å½“çš„é¡µæ¥å­˜å‚¨æ–°çš„è¡Œã€‚å¦‚æœå¿…è¦çš„é¡µä¸å­˜åœ¨æˆ–é¡µå·²æ»¡ï¼Œæ®µç®¡ç†é€»è¾‘å°†è¯·æ±‚åˆ†é…æ–°çš„åŒºï¼Œå¹¶ç»§ç»­æ•°æ®æ’å…¥ã€‚ 1.3.2 ç´¢å¼•æ®µå½“ä½ ä¸ºè¡¨åˆ›å»ºä¸€ä¸ªç´¢å¼•æ—¶ï¼Œæ— è®ºæ˜¯ä¸»é”®ç´¢å¼•è¿˜æ˜¯è¾…åŠ©ç´¢å¼•ï¼ŒInnoDB éƒ½ä¼šä¸ºæ¯ä¸ªç´¢å¼•åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ç´¢å¼•æ®µï¼š é€»è¾‘å±‚é¢ï¼šç´¢å¼•æ®µé€»è¾‘ä¸Šè¡¨ç¤ºç´¢å¼•çš„ç»“æ„ï¼Œè¿™åŒ…æ‹¬ç»´æŠ¤é”®å€¼å’ŒæŒ‡å‘è¡¨ä¸­å¯¹åº”è¡Œçš„æŒ‡é’ˆã€‚ ç‰©ç†å±‚é¢ï¼šç‰©ç†ä¸Šï¼Œç´¢å¼•æ®µå­˜å‚¨ç´¢å¼•æ ‘ï¼ˆB-treeï¼‰çš„ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹ï¼ˆæˆ–é¡µï¼‰åŒ…å«ç´¢å¼•é”®å’ŒæŒ‡å‘è¡Œçš„æŒ‡é’ˆã€‚éšç€ç´¢å¼•çš„å¢é•¿ï¼Œå¯èƒ½éœ€è¦æ›´å¤šçš„é¡µå’ŒåŒºæ¥æ‰©å±•ç´¢å¼•æ ‘ã€‚ æ“ä½œï¼šè¿›è¡ŒæŸ¥è¯¢ä¼˜åŒ–æ—¶ï¼Œå¦‚æ‰§è¡ŒåŸºäºç´¢å¼•çš„æŸ¥æ‰¾ï¼ŒInnoDB é€šè¿‡ç´¢å¼•æ®µå¿«é€Ÿè®¿é—®ç›¸å…³é¡µï¼Œæœ‰æ•ˆåœ°å®šä½åˆ°æ•°æ®è¡Œã€‚ 1.3.3 Undo æ—¥å¿—æ®µUndo æ—¥å¿—ä¹Ÿæ˜¯ä½¿ç”¨æ®µæ¥ç®¡ç†çš„ï¼Œæ¯å½“æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œä¿®æ”¹å‰çš„æ•°æ®å°†å­˜å‚¨åœ¨ undo æ—¥å¿—æ®µä¸­ï¼š é€»è¾‘å±‚é¢ï¼šé€»è¾‘ä¸Šï¼Œundo æ—¥å¿—æ®µä¿å­˜äº†æ•°æ®ä¿®æ”¹å‰çš„çŠ¶æ€ï¼Œæ”¯æŒäº‹åŠ¡çš„å›æ»šæ“ä½œã€‚ ç‰©ç†å±‚é¢ï¼šç‰©ç†ä¸Šï¼Œundo æ—¥å¿—æ®µç”±ä¸€ç³»åˆ—çš„é¡µç»„æˆï¼Œè¿™äº›é¡µæŒ‰éœ€åˆ†é…ï¼Œå¹¶åœ¨äº‹åŠ¡å›æ»šæ—¶æä¾›å¿…è¦çš„å†å²æ•°æ®ã€‚ æ“ä½œï¼šå¦‚æœäº‹åŠ¡å¤±è´¥æˆ–æ‰§è¡Œ ROLLBACK å‘½ä»¤ï¼ŒInnoDB é€šè¿‡è®¿é—® undo æ—¥å¿—æ®µä¸­çš„è®°å½•æ¥æ¢å¤æ•°æ®åˆ°å…¶åŸå§‹çŠ¶æ€ã€‚ 1.4 è¡¨ç©ºé—´ï¼ˆTablespaceï¼‰è¡¨ç©ºé—´æ˜¯ InnoDB æ•°æ®å­˜å‚¨çš„æœ€é«˜å±‚çº§ï¼Œå®ƒå¯ä»¥åŒ…å«å¤šä¸ªæ®µã€‚è¡¨ç©ºé—´æ˜¯ç£ç›˜ä¸Šçš„ç‰©ç†æ–‡ä»¶ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå†…éƒ¨ç»„ç»‡ç€æ•°æ®åº“çš„æ•°æ®å’Œç´¢å¼•ã€‚InnoDB é»˜è®¤æœ‰ä¸€ä¸ªä¸»è¡¨ç©ºé—´ï¼Œå³ ibdata æ–‡ä»¶ï¼Œå®ƒåŒ…å«äº†ç³»ç»Ÿæ•°æ®ã€æ•°æ®å­—å…¸ã€undo æ—¥å¿—ç­‰ã€‚æ­¤å¤–ï¼ŒInnoDB è¿˜æ”¯æŒæ¯ä¸ªè¡¨ä½¿ç”¨å•ç‹¬çš„æ–‡ä»¶ä½œä¸ºç‹¬ç«‹è¡¨ç©ºé—´ï¼ˆfile-per-tableï¼‰ï¼Œè¿™æœ‰åŠ©äºæ•°æ®åº“çš„æ‰©å±•å’Œç®¡ç†ã€‚ 2.è¡Œè®°å½•æ ¼å¼æ•°æ®è¡¨ä¸­çš„è¡Œå­˜æ”¾åœ¨ æ•°æ®page ä¸­ï¼Œ ä»¥compact è¡Œæ ¼å¼ä¸ºä¾‹ï¼Œ æ¯ä¸€æ¡æ•°æ®è®°å½•çš„å­˜å‚¨æ ¼å¼å¦‚ä¸‹ï¼Œ å…¶ä¸­çœŸå®æ•°æ®éƒ¨åˆ†ï¼Œé™¤äº†æ•°æ®è¡¨ä¸­å®šä¹‰çš„åˆ—ä¹‹å¤–ï¼ŒInnoDB ä¼šé»˜è®¤ä¸ºæ¯æ¡è®°å½•æ·»åŠ éšè—åˆ— åˆ—å æ˜¯å¦å¿…é¡» å æ®ç©ºé—´ æè¿° row_id å¦ 6 å­—èŠ‚ è¡ŒIDï¼Œå”¯ä¸€æ ‡è¯†ä¸€æ¡è®°å½• trx_id æ˜¯ 6 å­—èŠ‚ äº‹åŠ¡ID roll_pointer æ˜¯ 7 å­—èŠ‚ å›æ»šæŒ‡é’ˆ roll_pointer æ˜¯å­˜å‚¨åœ¨æ¯ä¸ªè¡Œè®°å½•ä¸­çš„ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥è¡Œè®°å½•ç›¸å…³çš„æœ€è¿‘ä¸€æ¬¡undo log è®°å½•ã€‚trx_id æ˜¯ InnoDB å­˜å‚¨å¼•æ“å†…éƒ¨ç”¨æ¥å”¯ä¸€æ ‡è¯†æ¯ä¸ªäº‹åŠ¡çš„æ ‡è¯†ç¬¦ï¼Œå®ƒè®°å½•äº†æœ€è¿‘ä¿®æ”¹è¯¥è®°å½•çš„äº‹åŠ¡ã€‚ 3. InnoDB äº‹åŠ¡trx_idtrx_id æ˜¯ InnoDB å­˜å‚¨å¼•æ“å†…éƒ¨ç”¨æ¥å”¯ä¸€æ ‡è¯†æ¯ä¸ªäº‹åŠ¡çš„æ ‡è¯†ç¬¦ã€‚è¿™ä¸ªäº‹åŠ¡IDæ˜¯ä¸€ä¸ªé€’å¢çš„æ•°å­—ï¼Œç”± InnoDB å†…éƒ¨è‡ªåŠ¨ç”Ÿæˆå’Œç®¡ç†ã€‚ trx_id å­˜å‚¨åœ¨è¡Œè®°å½•çš„éšè—åˆ—ä¸­ã€‚ MySQLserver å±‚ä¹Ÿæœ‰ä¸€ä¸ªäº‹åŠ¡å”¯ä¸€æ ‡è¯†å«XIDã€‚ InnoDB å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª max_trx_id å…¨å±€å˜é‡ï¼Œæ¯æ¬¡éœ€è¦ç”³è¯·ä¸€ä¸ªæ–°çš„ trx_id æ—¶ï¼Œå°±è·å¾— max_trx_id çš„å½“å‰å€¼ï¼Œç„¶åå¹¶å°† max_trx_id åŠ  1ã€‚ åŠŸèƒ½å’Œä½œç”¨ äº‹åŠ¡çš„å”¯ä¸€æ ‡è¯†ï¼štrx_id ä¸º InnoDB æä¾›äº†ä¸€ç§æ–¹å¼æ¥å”¯ä¸€åœ°è¯†åˆ«å’Œè·Ÿè¸ªæ¯ä¸ªæ´»åŠ¨çš„æˆ–å·²å®Œæˆçš„äº‹åŠ¡ã€‚ å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰ï¼šåœ¨ InnoDB çš„ MVCC å®ç°ä¸­ï¼Œtrx_id è¢«ç”¨æ¥æ ‡è®°æ¯æ¡è®°å½•çš„ç‰ˆæœ¬ï¼Œä»¥æ­¤æ¥æ”¯æŒäº‹åŠ¡çš„éš”ç¦»çº§åˆ«ã€‚ä¸åŒäº‹åŠ¡çœ‹åˆ°çš„æ•°æ®è§†å›¾ä¾èµ–äºè®°å½•çš„ trx_id ä¸äº‹åŠ¡çš„ trx_id æ¯”è¾ƒã€‚ å›æ»šå’Œæ¢å¤ï¼šåœ¨äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¦‚æœéœ€è¦å›æ»šï¼ŒInnoDB é€šè¿‡ trx_id æ¥ç¡®å®šå“ªäº›æ›´æ”¹éœ€è¦è¢«æ’¤é”€ã€‚æ­¤å¤–ï¼Œåœ¨ç³»ç»Ÿå´©æºƒåçš„æ¢å¤è¿‡ç¨‹ä¸­ï¼Œtrx_id ä¹Ÿè¢«ç”¨æ¥é‡å»ºæ´»è·ƒäº‹åŠ¡çš„çŠ¶æ€ã€‚","tags":["MySQL","äº‹åŠ¡"]},{"title":"Intro to äº‹åŠ¡","path":"/5b064db6/","content":"1. ä»€ä¹ˆæ˜¯äº‹åŠ¡äº‹åŠ¡ï¼ˆTransactionï¼‰çš„æ¦‚å¿µèµ·æºäºæ•°æ®åº“é¢†åŸŸï¼Œæœ€æ—©ç”±ç¾å›½è®¡ç®—æœºç§‘å­¦å®¶ E. F. Codd åœ¨å…¶å…³äºå…³ç³»æ•°æ®åº“ï¼ˆRelational Databaseï¼‰çš„è®ºæ–‡ä¸­æå‡ºã€‚ ä»–æå‡ºäº† ACIDï¼ˆåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§å’ŒæŒä¹…æ€§ï¼‰å±æ€§ï¼Œè¿™äº›å±æ€§æˆä¸ºäº‹åŠ¡çš„æ ¸å¿ƒç‰¹å¾ã€‚ åœ¨ä»Šå¤©çš„è½¯ä»¶å¼€å‘ä¸­ï¼Œäº‹åŠ¡çš„æ¦‚å¿µå·²ä¸ä»…ä»…åº”ç”¨äºæ•°æ®åº“é¢†åŸŸï¼Œè¿˜æ‹“å±•åˆ°äº†ä¸šåŠ¡å¼€å‘çš„å„ä¸ªé¢†åŸŸï¼ŒåŒ…æ‹¬ä½†ä¸é™äºæ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ã€‚ 1.1 ACID ç‰¹æ€§ åŸå­æ€§(Atomicity): ä¿è¯äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨ä¸å‘ç”Ÿï¼Œæœ‰åŠ©äºå¤„ç†ç³»ç»Ÿé”™è¯¯æˆ–æ•…éšœæ—¶çš„æ•°æ®æ¢å¤ï¼Œç¡®ä¿äº‹åŠ¡æ‰§è¡Œçš„å®Œæ•´æ€§ã€‚ ä¸€è‡´æ€§(Consistency)ï¼šç³»ç»Ÿä»ä¸€ä¸ªæ­£ç¡®æ€è½¬ç§»åˆ°å¦ä¸€ä¸ªæ­£ç¡®æ€ï¼Œç”±åº”ç”¨é€šè¿‡ AID æ¥ä¿è¯ï¼Œå¯ä»¥è¯´æ˜¯äº‹åŠ¡çš„æ ¸å¿ƒç‰¹æ€§ éš”ç¦»æ€§(Isolation): å¤„ç†å¹¶å‘äº‹åŠ¡å¸¦æ¥çš„å„ç§é—®é¢˜ï¼Œç¡®ä¿æ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„æ˜¯ä¸€è‡´çš„æ•°æ®è§†å›¾ï¼Œé˜²æ­¢äº¤å‰äº‹åŠ¡çš„å¹²æ‰°ã€‚ æŒä¹…æ€§(Durability): ç¡®ä¿äº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå…¶ç»“æœå°±å°±ä¼šè¢«æŒä¹…åŒ–ï¼Œè¿™ä¿è¯äº†æ•°æ®çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚ å®šä¹‰æœ¬èº«ä¸å†èµ˜è¿°ï¼Œè¿™é‡Œé‡ç‚¹å¼ºè°ƒä¸€ç‚¹ï¼šä¸€è‡´æ€§æ˜¯äº‹åŠ¡çš„æ ¸å¿ƒç‰¹å¾ï¼Œæˆ–è€…è¯´æœ€ç»ˆç›®çš„ã€‚åŸå­æ€§ã€éš”ç¦»æ€§å’ŒæŒä¹…æ€§éƒ½æ˜¯å®ç°ä¸€è‡´æ€§çš„æ‰‹æ®µï¼Œå› æ­¤è¿™ 4 ä¸ªç‰¹æ€§å¹¶ä¸æ˜¯å¹¶åˆ—å…³ç³»ã€‚ 2. äº‹åŠ¡çš„åˆ†ç±»ä¸‹é¢å°†æŠŠäº‹åŠ¡æŒ‰ç…§æœåŠ¡å’Œæ•°æ®æºæ•°é‡è¿›è¡Œåˆ†ç±»ï¼Œè¿™ç§åˆ†ç±»æœ‰åŠ©äºç†è§£äº‹åŠ¡ç®¡ç†çš„å¤æ‚æ€§ä»¥åŠåœ¨ä¸åŒåœºæ™¯ä¸‹çš„è®¾è®¡å’Œå®ç°ã€‚ 2.1 æœ¬åœ°äº‹åŠ¡-å•æœåŠ¡å•æ•°æ®æºäº‹åŠ¡åœ¨å®é™…ä¸šåŠ¡å¼€å‘ä¸­ï¼Œå•ä¸ªæœåŠ¡æ“ä½œå•ä¸ªæ•°æ®æºçš„äº‹åŠ¡è¢«å½’ç±»ä¸ºæœ¬åœ°äº‹åŠ¡ã€‚è¿™ç§äº‹åŠ¡ç±»å‹æ˜¯æœ€ç®€å•çš„ï¼Œå› ä¸ºå®ƒç›´æ¥ä¾èµ–äºæ•°æ®åº“æœ¬èº«çš„äº‹åŠ¡èƒ½åŠ›æ¥å®Œæˆï¼Œåº”ç”¨æ— éœ€è¿›è¡Œé¢å¤–æ“ä½œ ç¤ºä¾‹ï¼šåº“å­˜æœåŠ¡ï¼šå½“ç”¨æˆ·ä¸‹å•æ—¶ï¼Œåº“å­˜æœåŠ¡è´Ÿè´£æ£€æŸ¥å’Œæ›´æ–°å•†å“åº“å­˜ã€‚è¿™ä¸ªæœåŠ¡å¯èƒ½åªä¸ä¸€ä¸ªåº“å­˜æ•°æ®åº“äº¤äº’ï¼Œè¿›è¡Œå‡åº“å­˜çš„æ“ä½œã€‚å¦‚æœåº“å­˜è¶³å¤Ÿï¼Œäº‹åŠ¡æäº¤ï¼Œå¦åˆ™å›æ»šã€‚è¿™ä¸ªæ“ä½œåªæ¶‰åŠåº“å­˜æ•°æ®åº“ï¼Œå› æ­¤æ˜¯ä¸€ä¸ªå…¸å‹çš„æœ¬åœ°äº‹åŠ¡ã€‚ 2. 2 åˆ†å¸ƒå¼äº‹åŠ¡åˆ†å¸ƒå¼äº‹åŠ¡å¯ä»¥ä»è·¨å¤šä¸ªæ•°æ®æºçš„äº‹åŠ¡å’Œè·¨å¤šä¸ªæœåŠ¡çš„äº‹åŠ¡ä¸¤ä¸ªè§’åº¦ç†è§£ã€‚å®ƒæ—¢å¯ä»¥æ˜¯å¤šä¸ªæ•°æ®åº“å®ä¾‹ä¹‹é—´çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¹Ÿå¯ä»¥æ˜¯è·¨ä¸åŒä¸­é—´ä»¶çš„ä¸šåŠ¡å±‚é¢åˆ†å¸ƒå¼äº‹åŠ¡ã€‚ 2.2.1 å•æœåŠ¡å¤šæ•°æ®æºè¿™ç§æƒ…å†µé€šå¸¸å‘ç”Ÿåœ¨å•ä¸ªåº”ç”¨æˆ–æœåŠ¡éœ€è¦åŒæ—¶æ“ä½œå¤šä¸ªæ•°æ®åº“æˆ–å­˜å‚¨ç³»ç»Ÿã€‚ ä¾‹å¦‚ï¼Œä¸€ä¸ªç”µå­å•†åŠ¡åº”ç”¨å¯èƒ½éœ€è¦åœ¨å¤„ç†è®¢å•çš„åŒæ—¶ï¼Œåœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­æ›´æ–°åº“å­˜ä¿¡æ¯ï¼Œåœ¨å¦ä¸€ä¸ªæ•°æ®åº“ä¸­æ›´æ–°ç”¨æˆ·è´¦æˆ·ä¿¡æ¯ã€‚è¿™è¦æ±‚äº‹åŠ¡ç®¡ç†æœºåˆ¶èƒ½å¤Ÿè·¨è¶Šè¿™äº›æ•°æ®åº“ï¼Œç¡®ä¿æ‰€æœ‰æ•°æ®åº“æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨å¦‚XAåè®®è¿™æ ·çš„åˆ†å¸ƒå¼äº‹åŠ¡åè®®ï¼Œé€šè¿‡2PCç­‰æœºåˆ¶æ¥åè°ƒå’Œç®¡ç†è·¨å¤šä¸ªæ•°æ®æºçš„äº‹åŠ¡ã€‚ 2.2.2 å¤šæœåŠ¡å¤šæ•°æ®æºéšç€å¾®æœåŠ¡æ¶æ„çš„å‘å±•ï¼Œå•ä¸ªä¸šåŠ¡æ“ä½œå¾€å¾€éœ€è¦å¤šä¸ªå¾®æœåŠ¡åä½œå®Œæˆï¼Œè€Œè¿™äº›æœåŠ¡å¯èƒ½å„è‡ªä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“ã€‚ä¾‹å¦‚ï¼Œåœ¨ç”µå•†ä¸‹å•è¿‡ç¨‹ä¸­ï¼Œè®¢å•æœåŠ¡ã€åº“å­˜æœåŠ¡ã€è´¦åŠ¡æœåŠ¡ã€ç‰©æµæœåŠ¡å’Œä¼˜æƒ æœåŠ¡éœ€è¦ååŒå¤„ç†åŒä¸€ä¸šåŠ¡è¯·æ±‚ï¼Œå¹¶è¿›è¡Œäº¤äº’å’Œæ•°æ®æ›´æ–°ã€‚ åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡çš„ç®¡ç†æ¯”å•ä¸ªæœåŠ¡åœºæ™¯æ›´ä¸ºå¤æ‚ï¼Œå› ä¸ºå®ƒä¸ä»…æ¶‰åŠæ•°æ®ä¸€è‡´æ€§ï¼Œè¿˜æ¶‰åŠç½‘ç»œè°ƒç”¨çš„å¯é æ€§å’ŒæœåŠ¡é—´çš„åè°ƒã€‚è¿™ç±»åˆ†å¸ƒå¼äº‹åŠ¡é€šå¸¸å¯ä»¥é€šè¿‡å¯é æ¶ˆæ¯é˜Ÿåˆ—ã€TCC å’Œ SAGA ç­‰æ¨¡å¼æ¥å®ç°ã€‚ 2.3 å…±äº«äº‹åŠ¡-å¤šæœåŠ¡å•æ•°æ®æºåœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œé€šå¸¸ä¸å…è®¸å¤šæœåŠ¡å…±äº«åŒä¸€æ•°æ®æºã€‚ç†æƒ³çš„å¾®æœåŠ¡æ¶æ„æ˜¯æ¯ä¸ªå¾®æœåŠ¡éƒ½æœ‰å…¶ä¸“å±æ•°æ®åº“ï¼ˆå³æœåŠ¡ä¸æ•°æ®æºä¸€ä¸€å¯¹åº”ï¼‰ï¼Œè¿™ç§è®¾è®¡è¢«ç§°ä¸ºæ•°æ®åº“éš”ç¦»ã€‚ å› æ­¤ï¼Œæœ¬æ–‡åŠæœ¬ç³»åˆ—ä¸ä¼šæ¶‰åŠè¯¥ç±»å‹äº‹åŠ¡ã€‚ 3. ä¸¤ç§åˆ†å¸ƒå¼äº‹åŠ¡çš„åŒºåˆ«åœ¨äº‹åŠ¡åˆ†ç±»ä¸­ï¼Œå•æœåŠ¡å¤šæ•°æ®æº å’Œ å¤šæœåŠ¡å¤šæ•°æ®æº éƒ½è¢«å½’ç±»ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œé‚£ä¹ˆè¿™ä¸¤ç§åˆ†å¸ƒå¼äº‹åŠ¡æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ é¦–å…ˆï¼Œå•æœåŠ¡å¤šæ•°æ®æºäº‹åŠ¡æ˜¯å¤šä¸ªæ•°æ®åº“å®ä¾‹ä¹‹é—´çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œ ä¹Ÿè¢«ç§°ä¸ºå…¨å±€äº‹åŠ¡ã€‚å½“å®ƒè¢«ç§°ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œè¿™é‡Œçš„â€œåˆ†å¸ƒå¼â€æ˜¯ç›¸å¯¹äºæ•°æ®æºè€Œè¨€çš„ï¼Œå¹¶ä¸æ¶‰åŠæœåŠ¡ã€‚ è€Œå¤šæœåŠ¡å¤šæ•°æ®æºäº‹åŠ¡æ˜¯è·¨ä¸åŒä¸­é—´ä»¶çš„ä¸šåŠ¡å±‚é¢åˆ†å¸ƒå¼äº‹åŠ¡ã€‚ è¿™ä¸¤ç§åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€ä¸ªé‡è¦åŒºåˆ«åœ¨äºä¸€è‡´æ€§çš„å®ç°æ–¹å¼ä¸åŒï¼š å•æœåŠ¡å¤šæ•°æ®æºäº‹åŠ¡é€šå¸¸å¯ä»¥è¿½æ±‚ å¼ºä¸€è‡´æ€§ã€‚ å¤šæœåŠ¡å¤šæ•°æ®æºäº‹åŠ¡ç”±äºå…¶å¤æ‚æ€§å’Œåˆ†å¸ƒå¼ç‰¹æ€§ï¼Œé€šå¸¸åªèƒ½è¿½æ±‚ æœ€ç»ˆä¸€è‡´æ€§ã€‚ ä¸‹é¢å°†è¯¦ç»†è§£é‡Šè¿™ä¸¤ç§æƒ…å†µåŠå…¶åŸå› ã€‚ 3.1 å•æœåŠ¡å¤šæ•°æ®æº ä¸ å¼ºä¸€è‡´æ€§åœ¨å•æœåŠ¡å¤šæ•°æ®æºçš„åœºæ™¯ä¸­ï¼Œå°½ç®¡æ¶‰åŠå¤šä¸ªæ•°æ®æºï¼Œä½†æ‰€æœ‰æ“ä½œéƒ½ç”±ä¸€ä¸ªå•ä¸€æœåŠ¡æ§åˆ¶ã€‚è¿™ç§é…ç½®å…è®¸ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰ç­‰ä¼ ç»Ÿçš„åˆ†å¸ƒå¼äº‹åŠ¡åè®®æ¥ç¡®ä¿å¼ºä¸€è‡´æ€§ï¼Œå³åœ¨ä»»ä½•æ—¶åˆ»ï¼Œæ‰€æœ‰æ•°æ®æºéƒ½èƒ½åæ˜ å‡ºç›¸åŒçš„äº‹åŠ¡çŠ¶æ€ã€‚ ä¸ºä»€ä¹ˆå¯ä»¥å®ç°å¼ºä¸€è‡´æ€§ï¼š é›†ä¸­å¼åè°ƒï¼šå•ä¸ªæœåŠ¡å¯ä»¥ä½œä¸ºäº‹åŠ¡çš„ä¸­å¤®åè°ƒè€…ï¼Œç®¡ç†æ‰€æœ‰æ•°æ®æºçš„äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚ é”å®šèµ„æºï¼šäº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­å¯ä»¥åœ¨å„ä¸ªæ•°æ®æºä¸Šé”å®šå¿…è¦çš„èµ„æºï¼Œç›´åˆ°äº‹åŠ¡å®Œæˆï¼Œç¡®ä¿äº‹åŠ¡çš„åŸå­æ€§å’Œä¸€è‡´æ€§ã€‚ åŒæ­¥æ›´æ–°ï¼šæ‰€æœ‰æ•°æ®æºçš„æ›´æ–°æ“ä½œå¯ä»¥åŒæ­¥è¿›è¡Œï¼Œç¡®ä¿åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œæ‰€æœ‰çš„å˜æ›´éƒ½èƒ½ä¸€æ¬¡æ€§åæ˜ å‡ºæ¥ã€‚ 3.2 å¤šæœåŠ¡å¤šæ•°æ®æº ä¸ æœ€ç»ˆä¸€è‡´æ€§å¤šæœåŠ¡å¤šæ•°æ®æºäº‹åŠ¡æ¶‰åŠå¤šä¸ªç‹¬ç«‹çš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡å¯èƒ½ç®¡ç†è‡ªå·±çš„æ•°æ®æºã€‚åœ¨è¿™ç§æ¶æ„ä¸‹ï¼Œå®ç°å¼ºä¸€è‡´æ€§å˜å¾—éå¸¸å¤æ‚å’Œæˆæœ¬é«˜æ˜‚ï¼Œå› æ­¤é€šå¸¸é‡‡ç”¨æœ€ç»ˆä¸€è‡´æ€§æ¨¡å‹ã€‚ ä¸ºä»€ä¹ˆé€šå¸¸åªèƒ½å®ç°æœ€ç»ˆä¸€è‡´æ€§ï¼š æœåŠ¡è‡ªæ²»ï¼šæ¯ä¸ªæœåŠ¡éƒ½æ˜¯è‡ªæ²»çš„ï¼Œç‹¬ç«‹ç®¡ç†è‡ªå·±çš„æ•°æ®æºï¼Œå®ƒä»¬ä¹‹é—´çš„é€šä¿¡å¯èƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½ç«‹å³åæ˜ å…¶ä»–æœåŠ¡çš„çŠ¶æ€å˜æ›´ã€‚ å¤æ‚çš„åè°ƒæœºåˆ¶ï¼šéœ€è¦è·¨æœåŠ¡åè°ƒå¤æ‚çš„äº‹åŠ¡å¯èƒ½æ¶‰åŠç½‘ç»œå»¶è¿Ÿå’ŒæœåŠ¡é—´é€šä¿¡å¤±è´¥ï¼Œä½¿å¾—åŒæ­¥æ›´æ–°æ‰€æœ‰æ•°æ®æºå˜å¾—ä¸åˆ‡å®é™…ã€‚ ä½¿ç”¨è¡¥å¿äº‹åŠ¡ï¼šå¤šæœåŠ¡äº‹åŠ¡å¸¸é‡‡ç”¨å¦‚SAGAç­‰æ¨¡å¼ï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„æœ¬åœ°äº‹åŠ¡å’Œè¡¥å¿äº‹åŠ¡æ¥å¤„ç†ä¸šåŠ¡æµç¨‹ï¼Œæ¯ä¸ªäº‹åŠ¡ç‹¬ç«‹æäº¤ï¼Œä»…é€šè¿‡è¡¥å¿æœºåˆ¶æ¥æ’¤é”€é”™è¯¯æ“ä½œï¼Œé€æ­¥è¾¾åˆ°æ•°æ®çš„ä¸€è‡´æ€§ã€‚ 4. å¼ºä¸€è‡´æ€§ vs æœ€ç»ˆä¸€è‡´æ€§4.1 ä¸€è‡´æ€§çš„åˆ†ç±»4.1.1 å¼ºä¸€è‡´æ€§ï¼ˆStrong Consistencyï¼‰å¼ºä¸€è‡´æ€§æ„å‘³ç€ç³»ç»Ÿåœ¨æ›´æ–°æ•°æ®åï¼Œä»»ä½•éšåçš„è®¿é—®éƒ½å°†ç«‹å³çœ‹åˆ°è¿™ä¸€æ›´æ–°ã€‚åœ¨å¼ºä¸€è‡´æ€§æ¨¡å‹ä¸­ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„æ•°æ®åœ¨ä»»ä½•æ—¶é—´ç‚¹éƒ½æ˜¯ä¸€è‡´çš„ã€‚è¿™é€šå¸¸è¦æ±‚åœ¨æ•°æ®æ›´æ–°è¿‡ç¨‹ä¸­è¿›è¡Œä¸¥æ ¼çš„åè°ƒï¼Œç¡®ä¿æ‰€æœ‰å‰¯æœ¬åœ¨ç»§ç»­æ“ä½œå‰éƒ½åŒæ­¥æ›´æ–°ã€‚ ä¼˜ç‚¹ï¼š æ•°æ®ä¸€è‡´æ€§å’Œç”¨æˆ·ä½“éªŒæœ€ä¸ºç†æƒ³ã€‚ æ˜“äºç†è§£å’Œä½¿ç”¨ï¼Œå› ä¸ºå®ƒæ¨¡æ‹Ÿäº†å•ä¸ªç³»ç»Ÿçš„è¡Œä¸ºã€‚ ç¼ºç‚¹ï¼š å¯èƒ½ä¸¥é‡å½±å“ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œæ€§èƒ½ï¼Œå°¤å…¶åœ¨ç½‘ç»œå»¶è¿Ÿè¾ƒé«˜çš„æƒ…å†µä¸‹ã€‚ åœ¨ CAP å®šç†ä¸­ï¼Œé€šå¸¸éœ€è¦åœ¨é‡åˆ°ç½‘ç»œåˆ†åŒºæ—¶ç‰ºç‰²å¯ç”¨æ€§ã€‚4.1.2 çº¿æ€§ä¸€è‡´æ€§ï¼ˆLinearizabilityï¼‰ çº¿æ€§ä¸€è‡´æ€§æ˜¯å¼ºä¸€è‡´æ€§çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œå®ƒä¸ä»…ä¿è¯æ‰€æœ‰èŠ‚ç‚¹çœ‹åˆ°ç›¸åŒçš„æ•°æ®ï¼Œè¿˜è¦æ±‚ç³»ç»Ÿè¡¨ç°å¾—å°±åƒæ‰€æœ‰æ“ä½œéƒ½æ˜¯é¡ºåºå‘ç”Ÿçš„ã€‚è¿™æ„å‘³ç€å¦‚æœæ“ä½œAåœ¨æ“ä½œBä¹‹å‰å®Œæˆï¼Œé‚£ä¹ˆç³»ç»Ÿä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½åº”è¯¥é¦–å…ˆçœ‹åˆ°Açš„ç»“æœï¼Œç„¶åæ˜¯Bçš„ç»“æœã€‚ä¼˜ç‚¹ï¼š æä¾›äº†å¼ºä¸€è‡´æ€§çš„æœ€é«˜æ ‡å‡†ï¼Œé€‚ç”¨äºéœ€è¦ä¸¥æ ¼æ•°æ®é¡ºåºçš„åº”ç”¨ã€‚ ç®€åŒ–äº†ç³»ç»Ÿçš„ç¼–ç¨‹æ¨¡å‹ã€‚ç¼ºç‚¹ï¼š å¯¹ç³»ç»Ÿæ€§èƒ½å’Œå¯ç”¨æ€§çš„å½±å“æ¯”ä¸€èˆ¬çš„å¼ºä¸€è‡´æ€§è¿˜è¦å¤§ã€‚ 4.1.3 å¼±ä¸€è‡´æ€§ï¼ˆWeak Consistencyï¼‰å¼±ä¸€è‡´æ€§ä¸ä¿è¯åœ¨æ•°æ®æ›´æ–°åç«‹å³åæ˜ è¿™ä¸€å˜åŒ–ã€‚åœ¨æ›´æ–°æ“ä½œå’Œå…¶å½±å“è¢«æ‰€æœ‰ç”¨æˆ·è§‚å¯Ÿåˆ°ä¹‹é—´ï¼Œå­˜åœ¨ä¸€ä¸ªä¸ç¡®å®šçš„æ—¶é—´çª—å£ã€‚è¿™ç§æ¨¡å‹é€šå¸¸ç”¨äºå¯¹å®æ—¶ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„ç³»ç»Ÿã€‚ä¼˜ç‚¹ï¼š æé«˜äº†ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œæ€§èƒ½ã€‚ åœ¨å¤„ç†é«˜å¹¶å‘æ“ä½œæ—¶æ›´åŠ æœ‰æ•ˆã€‚ç¼ºç‚¹ï¼š ç”¨æˆ·å¯èƒ½ä¼šè¯»åˆ°æ—§æ•°æ®ã€‚ åº”ç”¨é€»è¾‘å¯èƒ½éœ€è¦å¤„ç†æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚4.1.4 æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual Consistencyï¼‰ æœ€ç»ˆä¸€è‡´æ€§ä¿è¯ï¼Œåœ¨æ²¡æœ‰æ–°çš„æ›´æ–°çš„æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„æ•°æ®å‰¯æœ¬æœ€ç»ˆå°†ä¼šæ˜¯ä¸€è‡´çš„ã€‚ç³»ç»Ÿä¸ä¿è¯è¾¾åˆ°ä¸€è‡´çŠ¶æ€çš„å…·ä½“æ—¶é—´ã€‚ä¼˜ç‚¹ï¼š é«˜åº¦å¯ç”¨å’Œå¯æ‰©å±•ã€‚ é€‚ç”¨äºåˆ†å¸ƒå¹¿æ³›çš„ç³»ç»Ÿï¼Œå¯ä»¥å®¹å¿æ•°æ®åœ¨çŸ­æ—¶é—´å†…çš„ä¸ä¸€è‡´ã€‚ç¼ºç‚¹ï¼š åº”ç”¨éœ€è¦èƒ½å¤Ÿå¤„ç†æ•°æ®ä¸€æ®µæ—¶é—´å†…çš„ä¸ä¸€è‡´ã€‚ å¼€å‘è€…éœ€è¦è®¾è®¡æœ‰æ•ˆçš„æ•°æ®åŒæ­¥å’Œå†²çªè§£å†³ç­–ç•¥ã€‚4.2 CAP ä¸ ACIDçš„å¾®å¦™å¹³è¡¡-åˆ†å¸ƒå¼ç³»ç»Ÿåªèƒ½è¿½æ±‚æœ€ç»ˆä¸€è‡´æ€§ æ ¹æ® CAP å®šç†ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰å’Œåˆ†åŒºå®¹å¿æ€§ï¼ˆPartition Toleranceï¼‰ä¸‰ä¸ªå±æ€§ï¼Œæœ€å¤šåªèƒ½æ»¡è¶³å…¶ä¸­ä¸¤ä¸ªï¼Œå¿…é¡»ç‰ºç‰²ä¸€ä¸ªã€‚ ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šåœ¨ä»»ä½•æ—¶åˆ»ï¼Œä»»ä½•åˆ†å¸ƒå¼èŠ‚ç‚¹ä¸­çœ‹åˆ°çš„æ•°æ®éƒ½ä¿æŒä¸€è‡´ã€‚ å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ï¼šç³»ç»Ÿèƒ½å¤Ÿä¸é—´æ–­åœ°æä¾›æœåŠ¡çš„èƒ½åŠ›ã€‚ åˆ†åŒºå®¹å¿æ€§ï¼ˆPartition Toleranceï¼‰ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå½“éƒ¨åˆ†èŠ‚ç‚¹å› ç½‘ç»œåŸå› å¤±è”ï¼ˆå³å½¢æˆâ€œç½‘ç»œåˆ†åŒºâ€ï¼‰æ—¶ï¼Œç³»ç»Ÿä»èƒ½æ­£ç¡®æä¾›æœåŠ¡çš„èƒ½åŠ›ã€‚ 4.2.1 ä¸ºä»€ä¹ˆè¯´ åˆ†å¸ƒå¼ç³»ç»Ÿ å¿…é¡»æ¥å— åˆ†åŒºå®¹å¿æ€§ç†è§£ä¸ºä»€ä¹ˆåˆ†åŒºå®¹å¿æ€§åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¿…ç„¶å­˜åœ¨ï¼Œéœ€è¦ä»åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºæœ¬æ„æˆå’Œç½‘ç»œé€šä¿¡çš„ä¸å¯é æ€§ä¸¤ä¸ªè§’åº¦æ¢è®¨ã€‚ åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºæœ¬æ„æˆ åˆ†å¸ƒå¼ç³»ç»Ÿç”±å¤šä¸ªç›¸äº’åä½œçš„ç‹¬ç«‹ç»„ä»¶ç»„æˆï¼Œè¿™äº›ç»„ä»¶å¯èƒ½ä½äºç‰©ç†ä¸Šåˆ†æ•£çš„ä¸åŒä½ç½®ã€‚è¯¥æ¶æ„çš„ä¸»è¦ä¼˜åŠ¿æ˜¯æé«˜ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€å®¹é”™æ€§å’Œèµ„æºåˆ©ç”¨ç‡ã€‚ç„¶è€Œï¼Œè¿™ä¹Ÿæ„å‘³ç€ç³»ç»Ÿçš„å„ä¸ªéƒ¨åˆ†å¿…é¡»é€šè¿‡ç½‘ç»œé€šä¿¡ã€‚ ç½‘ç»œé€šä¿¡çš„ä¸å¯é æ€§ ç½‘ç»œæœ¬èº«å­˜åœ¨ä¸å¯é æ€§ï¼Œå¯èƒ½å› å¤šç§åŸå› å¯¼è‡´é€šä¿¡å¤±è´¥ï¼š ç½‘ç»œæ•…éšœï¼šç½‘ç»œè®¾å¤‡æˆ–è¿æ¥å¯èƒ½å‡ºç°æ•…éšœï¼Œå¦‚è·¯ç”±å™¨æ•…éšœã€è¿æ¥æ–­å¼€ç­‰ã€‚ ç½‘ç»œå»¶è¿Ÿï¼šæ¶ˆæ¯åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­å¯èƒ½é­é‡ä¸å¯é¢„æµ‹çš„å»¶è¿Ÿã€‚ å¸¦å®½é™åˆ¶ï¼šç½‘ç»œçš„å¸¦å®½é™åˆ¶å¯èƒ½å¯¼è‡´æ•°æ®åŒ…å»¶è¿Ÿåˆ°è¾¾æˆ–ä¸¢å¤±ã€‚ ç½‘ç»œå®‰å…¨ï¼šç½‘ç»œæ”»å‡»ï¼ˆå¦‚åˆ†å¸ƒå¼æ‹’ç»æœåŠ¡æ”»å‡»ï¼ŒDDoSï¼‰å¯èƒ½å¯¼è‡´ç½‘ç»œéƒ¨åˆ†æˆ–å®Œå…¨ä¸å¯ç”¨ã€‚ å¦‚æœä¸€ä¸ªç³»ç»Ÿè®¾è®¡é€‰æ‹©ä¸æ¥å—ç½‘ç»œåˆ†åŒºï¼Œé‚£ä¹ˆä¸€æ—¦ç½‘ç»œåˆ†åŒºå‘ç”Ÿï¼Œç³»ç»Ÿå°†æ— æ³•æ­£å¸¸å·¥ä½œï¼Œè¿™åœ¨å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ä¸­æ˜¯ä¸å¯æ¥å—çš„ã€‚ å› æ­¤ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œåˆ†åŒºå®¹å¿æ€§ï¼ˆPartition Toleranceï¼‰æ˜¯å¿…ç„¶å­˜åœ¨çš„ç‰¹æ€§ã€‚ åŸºäºåˆ†åŒºå®¹å¿æ€§å¿…é¡»æ»¡è¶³çš„ç°çŠ¶ä»¥åŠ CAP ç†è®ºï¼Œç³»ç»Ÿåªèƒ½åœ¨ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ä¹‹é—´åšå‡ºé€‰æ‹©ã€‚é€šå¸¸ï¼Œç³»ç»Ÿä¼šé€‰æ‹©é«˜å¯ç”¨æ€§ï¼Œå¼ºä¸€è‡´æ€§å› æ­¤è¢«ç‰ºç‰²ï¼Œç³»ç»Ÿåªèƒ½è¿½æ±‚æœ€ç»ˆä¸€è‡´æ€§ã€‚ 5. ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„å„ç§åè®®5.1 DTP æ¨¡å‹å’Œ XA è§„èŒƒ5.1.1 DTP æ¨¡å‹DTPï¼ˆDistributed Transaction Processingï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ï¼‰æ¨¡å‹æ˜¯ç”± X/Openï¼ˆåæ¥çš„ Open Groupï¼‰æå‡ºçš„ä¸€ç§åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ¶æ„æ¨¡å‹ã€‚å®ƒå®šä¹‰äº†ä¸€å¥—æ ‡å‡†ï¼Œä½¿å¾—ä¸åŒå‚å•†çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ç³»ç»Ÿèƒ½å¤Ÿäº’æ“ä½œã€‚ åœ¨æ ‡å‡†çš„ DTP æ¨¡å‹ä¸­ï¼Œå®šä¹‰äº†ä»¥ä¸‹å››ä¸ªä¸»è¦ç»„ä»¶ï¼š Application Programï¼ˆAPï¼Œåº”ç”¨ç¨‹åºï¼‰ï¼š å‘èµ·åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸»ä½“ï¼Œç”±æœ€ç»ˆç”¨æˆ·æˆ–å¼€å‘è€…ç¼–å†™ã€‚ é€šè¿‡è°ƒç”¨äº‹åŠ¡ç®¡ç†å™¨çš„æ¥å£ï¼ˆä¾‹å¦‚ TX æ¥å£ï¼‰å¼€å§‹ã€æäº¤æˆ–å›æ»šäº‹åŠ¡ã€‚ åº”ç”¨ç¨‹åºä¸äº‹åŠ¡ç®¡ç†å™¨å’Œèµ„æºç®¡ç†å™¨äº¤äº’ã€‚ Transaction Managerï¼ˆTMï¼Œäº‹åŠ¡ç®¡ç†å™¨ï¼‰ï¼š è´Ÿè´£ç®¡ç†åˆ†å¸ƒå¼äº‹åŠ¡çš„å¼€å§‹ã€æäº¤å’Œå›æ»šç­‰æ“ä½œã€‚ ç»´æŠ¤äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼‰åè°ƒæ‰€æœ‰å‚ä¸çš„èµ„æºç®¡ç†å™¨ã€‚ æä¾›å¯¹å¤–çš„ TX æ¥å£ä¾›åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œå¹¶é€šè¿‡ XA æ¥å£ä¸èµ„æºç®¡ç†å™¨äº¤äº’ã€‚ Resource Managerï¼ˆRMï¼Œèµ„æºç®¡ç†å™¨ï¼‰ï¼š è´Ÿè´£ç®¡ç†å’Œæ§åˆ¶å¯¹ç‰¹å®šèµ„æºçš„è®¿é—®ï¼Œä¾‹å¦‚æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆDBMSï¼‰ã€æ–‡ä»¶ç³»ç»Ÿã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ã€‚ æ¥æ”¶äº‹åŠ¡ç®¡ç†å™¨çš„è¯·æ±‚ä»¥è¿›è¡Œèµ„æºæ“ä½œï¼Œå¹¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚ å®ç° XA æ¥å£ä¸äº‹åŠ¡ç®¡ç†å™¨é€šä¿¡ã€‚ Communication Resource Managerï¼ˆCRMï¼Œé€šä¿¡èµ„æºç®¡ç†å™¨ï¼‰ï¼š å¯é€‰ç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†ä¸å¤–éƒ¨ç³»ç»Ÿçš„é€šä¿¡èµ„æºã€‚ åœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­åè°ƒå’ŒåŒæ­¥äº‹åŠ¡çŠ¶æ€ï¼Œç¡®ä¿è·¨ç³»ç»Ÿçš„äº‹åŠ¡ä¸€è‡´æ€§ã€‚ ç®¡ç†è·¨ç½‘ç»œçš„äº‹åŠ¡ä¼ æ’­ï¼Œç¡®ä¿åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„äº‹åŠ¡å¤„ç†ä¸€è‡´æ€§ã€‚ ä¸»è¦æ¥å£ï¼š TX æ¥å£ï¼š åº”ç”¨ç¨‹åº AP ä¸äº‹åŠ¡ç®¡ç†å™¨ TM ä¹‹é—´çš„æ¡¥æ¢ï¼Œè´Ÿè´£äº‹åŠ¡çš„å¼€å§‹ã€æäº¤å’Œå›æ»šç­‰æ“ä½œã€‚ ä¾‹å¦‚ï¼Œåœ¨ Java EE ä¸­ï¼ŒTX æ¥å£é€šå¸¸å¯¹åº” javax.transaction.UserTransactionã€‚ XA æ¥å£ï¼š äº‹åŠ¡ç®¡ç†å™¨ TM ä¸èµ„æºç®¡ç†å™¨ RM ä¹‹é—´çš„æ¥å£ï¼Œåè°ƒèµ„æºç®¡ç†å™¨åœ¨ä¸¤é˜¶æ®µæäº¤åè®®ä¸­çš„æ“ä½œã€‚ å¸¸è§çš„ XA æ¥å£æ–¹æ³•åŒ…æ‹¬ xa_openã€xa_startã€xa_endã€xa_prepareã€xa_commitã€xa_rollback ç­‰ã€‚ CRM æ¥å£ï¼š äº‹åŠ¡ç®¡ç†å™¨ä¸é€šä¿¡èµ„æºç®¡ç†å™¨ä¹‹é—´çš„æ¥å£ï¼Œç¡®ä¿åˆ†å¸ƒå¼äº‹åŠ¡åœ¨ç½‘ç»œé€šä¿¡ä¸­ä¿æŒä¸€è‡´æ€§ã€‚ æ²¡æœ‰æ˜ç¡®çš„æ ‡å‡†æ¥å£ï¼Œç”±å„ç³»ç»Ÿå‚å•†è‡ªè¡Œå®ç°ã€‚ 5.1.2 XAè§„èŒƒXA è§„èŒƒæ˜¯ X/Open ç»„ç»‡åœ¨ DTPï¼ˆDistributed Transaction Processingï¼‰æ¨¡å‹ä¸­å®šä¹‰çš„ï¼Œç”¨äºæè¿°äº‹åŠ¡ç®¡ç†å™¨ï¼ˆTMï¼‰å’Œèµ„æºç®¡ç†å™¨ï¼ˆRMï¼‰ä¹‹é—´äº¤äº’çš„æ¥å£æ ‡å‡†ã€‚ æ¥å£æ ‡å‡†ï¼šXA è§„èŒƒå®šä¹‰äº†ä¸€å¥—æ ‡å‡†æ¥å£ï¼ŒåŒ…æ‹¬ xa_startã€xa_endã€xa_prepareã€xa_commitã€xa_rollback ç­‰ã€‚ 2PC åè®®ï¼šXA æ¥å£å®ç°äº†ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼‰ï¼Œä»¥ç¡®ä¿åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚ 5.1.3 XA äº‹åŠ¡XAäº‹åŠ¡æ˜¯ä¸€ç§åˆ†å¸ƒå¼äº‹åŠ¡ã€‚é€šè¿‡ä¸¤é˜¶æ®µæäº¤åè®®å’ŒXAæ¥å£æ ‡å‡†ï¼Œäº‹åŠ¡ç®¡ç†å™¨å’Œèµ„æºç®¡ç†å™¨èƒ½å¤Ÿå¯é åœ°ååŒå·¥ä½œï¼Œå®ç°è·¨ç³»ç»Ÿçš„äº‹åŠ¡å¤„ç†ï¼Œç¡®ä¿å¤šä¸ªç‹¬ç«‹èµ„æºçš„ä¸€è‡´æ€§ã€‚ å®é™…åº”ç”¨ æ•°æ®åº“ç³»ç»Ÿï¼š å¤§å¤šæ•°ä¸»æµæ•°æ®åº“ç³»ç»Ÿéƒ½æ”¯æŒXAäº‹åŠ¡ï¼Œå¦‚Oracleã€MySQLã€DB2ã€SQL Serverç­‰ã€‚ é€šè¿‡å®ç°XAæ¥å£ï¼Œæ•°æ®åº“å¯ä»¥å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡å¹¶ä¸äº‹åŠ¡ç®¡ç†å™¨ååŒå·¥ä½œã€‚ æ¶ˆæ¯ä¸­é—´ä»¶ï¼š ä¸€äº›æ¶ˆæ¯é˜Ÿåˆ—å’Œæ¶ˆæ¯ä¸­é—´ä»¶ä¹Ÿæ”¯æŒXAäº‹åŠ¡ï¼Œå¦‚IBM MQã€ActiveMQç­‰ã€‚ èƒ½å¤Ÿç¡®ä¿æ¶ˆæ¯å‘é€ä¸å…¶ä»–èµ„æºæ“ä½œçš„ä¸€è‡´æ€§ã€‚ Java EEç¯å¢ƒï¼š åœ¨Java EEåº”ç”¨ç¨‹åºä¸­ï¼Œjavax.transaction.UserTransactionå’Œjavax.transaction.TransactionManageræ¥å£æä¾›äº†å¯¹XAäº‹åŠ¡çš„æ”¯æŒã€‚5.2 ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰ ä¸¤é˜¶æ®µæäº¤æ˜¯ä¸€ç§å…·ä½“çš„äº‹åŠ¡åè®®ï¼Œç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­åè°ƒå¤šä¸ªäº‹åŠ¡å‚ä¸è€…çš„è¡Œä¸ºï¼Œä»¥ç¡®ä¿äº‹åŠ¡çš„åŸå­æ€§ã€‚å®ƒåŒ…å«ä»¥ä¸‹ä¸¤ä¸ªé˜¶æ®µï¼š å‡†å¤‡é˜¶æ®µï¼šåè°ƒè€…è¯¢é—®æ‰€æœ‰å‚ä¸è€…ï¼Œæ˜¯å¦å‡†å¤‡å¥½æäº¤äº‹åŠ¡ã€‚ æäº¤/å›æ»šé˜¶æ®µï¼šåŸºäºå„å‚ä¸è€…çš„ç­”å¤å’Œè¶…æ—¶æƒ…å†µï¼Œåè°ƒè€…å†³å®šæ˜¯å¦å…¨å±€æäº¤æˆ–å›æ»šï¼Œ åªæœ‰å…¨éƒ¨å‚ä¸è€…å›ç­”äº†prepared æ‰ä¼šcommit; è‹¥æœ‰ä¸€ä¸ªå‚ä¸è€…å›ç­”å’Œnon-prepared æˆ–è€…è¶…æ—¶æœªå›ç­”ï¼Œåˆ™rollback 5.2.1 åè°ƒè€…å®•æœºï¼šå•ç‚¹é—®é¢˜ï¼Œå‚ä¸è€…é˜»å¡åœ¨2PCä¸­ï¼Œä¸€ä¸ªé‡è¦ç‰¹ç‚¹æ˜¯å‚ä¸è€…ç¼ºä¹è¶…æ—¶æœºåˆ¶ã€‚å› æ­¤ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µç»“æŸåï¼Œä»–ä»¬å¿…é¡»åŸåœ°ç­‰å¾…åè°ƒè€…çš„ç¬¬äºŒé˜¶æ®µæŒ‡ä»¤ã€‚ä¸€æ—¦åè°ƒè€…å®•æœºï¼Œæ‰€æœ‰å‚ä¸è€…éƒ½ä¼šå—åˆ°å½±å“ã€‚å¦‚æœåè°ƒè€…é•¿æ—¶é—´æœªæ¢å¤æˆ–æœªå‘é€æ­£å¸¸çš„æäº¤æˆ–å›æ»šæŒ‡ä»¤ï¼Œæ‰€æœ‰å‚ä¸è€…éƒ½å°†è¢«é˜»å¡ã€‚ ä¸ºä½•å‚ä¸è€…ç¼ºä¹è¶…æ—¶å¤„ç†æœºåˆ¶å‘¢ï¼Ÿå› ä¸ºè¿™å¯èƒ½å¼•å‘æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚å½“å‚ä¸è€…è¿Ÿè¿Ÿæœªæ”¶åˆ°æäº¤æˆ–å›æ»šæŒ‡ä»¤æ—¶ï¼Œæ— è®ºå…¶é»˜è®¤ä¸ºæäº¤è¿˜æ˜¯å›æ»šï¼Œéƒ½å¯èƒ½å¯¼è‡´å…¨å±€æ•°æ®ä¸ä¸€è‡´ã€‚ è¿™ä¹Ÿç»™äº†æˆ‘ä»¬ä¸šåŠ¡å¼€å‘ä¸€äº›å¯ç¤ºï¼šåœ¨ä»»ä½•ä¸ç¡®å®šæƒ…å†µä¸‹ï¼Œéƒ½ä¸åº”éšæ„æŒ‡å®šé»˜è®¤æ“ä½œï¼Œæœ€ä½³åšæ³•æ˜¯å¯åŠ¨è­¦æŠ¥ï¼Œè®©äººå·¥ä»‹å…¥å¤„ç†ã€‚ 5.2.2 å›æ»šæ€§èƒ½å·®æ‰€æœ‰çš„æ“ä½œéƒ½å·²ç»å®Œæˆï¼Œå›æ»šéœ€è¦å…¨éƒ¨æ¨ç¿»ã€‚ 5.2.3 ä¸€è‡´æ€§é—®é¢˜5.2.4.1 åè°ƒè€…å®•æœºå¦‚ä¸Šé¢å•ç‚¹é—®é¢˜ä¸­æè¿°ï¼Œåè°ƒè€…å®•æœºåï¼Œç”±äºå‚ä¸è€…æ²¡æœ‰è¶…æ—¶å¤„ç†æœºåˆ¶ï¼Œä¼šä¸€ç›´é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°åè°ƒè€…å®•æœºæ¢å¤åï¼Œ æ ¹æ®æŒä¹…åŒ–çš„æ•°æ®åˆ¤æ–­è¯¥äº‹åŠ¡çŠ¶æ€ï¼Œè¿›è€Œå‘é€commit æˆ–è€… rollback ï¼Œ æ‰€ä»¥åœ¨åè°ƒè€…å®•æœºæ¢å¤å‰ åè°ƒè€…å’Œå‚ä¸è€…çš„æ•°æ®æ˜¯ä¸ä¸€è‡´çš„ 5.2.3.2 å‚ä¸è€…å®•æœºå¦‚æœå‚ä¸è€…æ”¶åˆ°commitåï¼Œå®•æœºäº†ã€‚æ­¤æ—¶æ•°æ®ä¹Ÿæ˜¯ä¸ä¸€è‡´çš„å‚ä¸è€…å®•æœºæ¢å¤åï¼Œå¯ä»¥æ£€æŸ¥è‡ªå·±çš„æŒä¹…åŒ–ä¿¡æ¯ï¼Œæ¥åˆ¤æ–­äº‹åŠ¡çš„çŠ¶æ€ã€‚ 5.2.3.3 ç½‘ç»œé—®é¢˜æœ‰çš„å‚ä¸è€…æ”¶åˆ°äº†commit,æœ‰çš„å‚ä¸è€…æ”¶ä¸åˆ°ï¼›å‚ä¸è€…çš„ack æ¶ˆæ¯ï¼Œåè°ƒè€…æœ‰çš„æ”¶åˆ°äº†ï¼Œæœ‰çš„æ²¡æ”¶åˆ°ã€‚å…¶ä¸­å‚ä¸è€…æ”¶ä¸åˆ°ç¬¬äºŒé˜¶æ®µçš„æ¶ˆæ¯ï¼Œè‡ªç„¶ä¸ä¼šæœ‰ack, è¡¨ç°ä¸Šä¹Ÿæ˜¯åè°ƒè€…æ”¶ä¸åˆ°ackã€‚è¿™é‡Œçš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ åè°ƒè€…è¶…æ—¶å¤„ç†æœºåˆ¶-é‡è¯•ï¼Œåœ¨é‡è¯•æˆåŠŸä¹‹å‰ï¼Œæ•°æ®æ˜¯ä¸ä¸€è‡´çš„ã€‚ 5.2.4 æ¢³ç†ä¸‹ DTPã€XAã€2PC ä¹‹é—´çš„å…³ç³»DTPï¼ˆDistributed Transaction Processingï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ï¼‰æ¨¡å‹æ˜¯ç”±X/Openï¼ˆåæ¥çš„Open Groupï¼‰æå‡ºçš„ä¸€ç§åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†çš„ä½“ç³»ç»“æ„æ¨¡å‹ã€‚å®ƒå®šä¹‰äº†ä¸€å¥—æ ‡å‡†ï¼Œä½¿å¾—ä¸åŒå‚å•†çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ç³»ç»Ÿèƒ½å¤Ÿäº’æ“ä½œã€‚ XAè§„èŒƒæ˜¯X/Openç»„ç»‡ åœ¨DTPï¼ˆDistributed Transaction Processingï¼‰æ¨¡å‹ä¸­å®šä¹‰çš„ï¼Œç”¨äºæè¿°äº‹åŠ¡ç®¡ç†å™¨ï¼ˆTMï¼‰å’Œèµ„æºç®¡ç†å™¨ï¼ˆRMï¼‰ä¹‹é—´çš„äº¤äº’çš„æ¥å£æ ‡å‡†ã€‚ XA è§„èŒƒåŸºäº2PC å®ç°ã€‚ ä½†æ˜¯ 2PCåè®®æ˜¯ä¸€ç§é€šç”¨çš„äº‹åŠ¡æäº¤åè®®ï¼Œå¯ä»¥åœ¨ä»»ä½•å®ç°ä¸­ä½¿ç”¨ã€‚é™¤äº†XAè§„èŒƒï¼Œ2PCåè®®è¿˜å¯ä»¥ç”¨äºå…¶ä»–äº‹åŠ¡ç®¡ç†åè®®å’Œæ¡†æ¶ï¼Œå¦‚ï¼š Seataï¼šé˜¿é‡Œå·´å·´å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼Œæä¾›å…¨å±€äº‹åŠ¡ç®¡ç†æœåŠ¡ï¼Œæ”¯æŒ2PCä½†ä¸ç›´æ¥ä½¿ç”¨XAæ¥å£ã€‚ Atomikosï¼šæ”¯æŒä¸¤é˜¶æ®µæäº¤åè®®çš„ç‹¬ç«‹äº‹åŠ¡ç®¡ç†å™¨ã€‚ Bitronixï¼šå¦ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡ç®¡ç†å™¨ï¼Œä¹Ÿæ”¯æŒ2PCåè®®ã€‚ åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¯ä»¥ç›´æ¥åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­å®ç°ç®€åŒ–ç‰ˆçš„2PCåè®®ï¼Œè€Œæ— éœ€éµå¾ªXAè§„èŒƒã€‚ 5.3 ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰3PC çš„3ä¸ªé˜¶æ®µï¼Œ CanCommit PreCommit DoCommit 3PC ç›¸æ¯”2PC çš„å˜åŒ– 3PCæäº¤æŠŠ2PCçš„prepare é˜¶æ®µç»†åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ç§°ä¸º CanCommitã€PreCommit å‚ä¸è€…å¢åŠ äº†è¶…æ—¶å¤„ç†æœºåˆ¶ï¼Œè¶…æ—¶é»˜è®¤ä¼šæäº¤äº‹åŠ¡ 3PC çš„æå‡ºæ˜¯ä¸ºäº†æ”¹è¿›2PC å­˜åœ¨çš„é—®é¢˜ 5.3.1 CanCommit ä¼˜åŒ–å›æ»šæ“ä½œæ€§èƒ½æ–°å¢çš„ CanCommit æ˜¯ä¸€ä¸ªè¯¢é—®é˜¶æ®µï¼Œåè°ƒè€…è®©æ¯ä¸ªå‚ä¸çš„æ•°æ®åº“æ ¹æ®è‡ªèº«çŠ¶æ€ï¼Œè¯„ä¼°è¯¥äº‹åŠ¡æ˜¯å¦æœ‰å¯èƒ½é¡ºåˆ©å®Œæˆã€‚è¿™å¯ä»¥è§£å†³æé«˜precommit é˜¶æ®µçš„æˆåŠŸç‡ï¼Œä¸‡ä¸€å¤±è´¥äº†ï¼Œå›æ»šæ“ä½œä¹Ÿæ¯”è¾ƒè½»ï¼Œå› ä¸ºè¿˜æ²¡å¼€å§‹åšå®è´¨æ€§çš„æ“ä½œ ä½†æ˜¯è¿™é‡Œè¦æ³¨æ„ä¸€ä¸ªæ€§èƒ½é—®é¢˜ï¼Œåœ¨äº‹åŠ¡éœ€è¦å›æ»šçš„åœºæ™¯ä¸­ï¼Œä¸‰æ®µå¼çš„æ€§èƒ½é€šå¸¸è¦æ¯”ä¸¤æ®µå¼å¥½å¾ˆå¤šï¼Œä½†åœ¨äº‹åŠ¡èƒ½å¤Ÿæ­£å¸¸æäº¤çš„åœºæ™¯ä¸­ï¼Œä¸¤æ®µå¼å’Œä¸‰æ®µå¼æäº¤çš„æ€§èƒ½éƒ½å¾ˆå·®ï¼Œä¸‰æ®µå¼å› ä¸ºå¤šäº†ä¸€æ¬¡è¯¢é—®ï¼Œæ€§èƒ½è¿˜è¦æ›´å·®ä¸€äº›ã€‚ 5.3.2 è§£å†³åè°ƒè€…å•ç‚¹é—®é¢˜é€šè¿‡å¢åŠ å‚ä¸è€…è¶…æ—¶å¤„ç†æœºåˆ¶ï¼Œé»˜è®¤ä¼šæäº¤äº‹åŠ¡ï¼Œç›¸å½“äºè§£å†³äº†åè°ƒè€…å®•æœºå‚ä¸è€…é˜»å¡ç­‰å¾…çš„å•ç‚¹é—®é¢˜ 5.3.3 åŠ é‡æ•°æ®ä¸€è‡´æ€§é—®é¢˜åœ¨2PCä¸­å·²ç»è®¨è®ºè¿‡,ä¸ºä»€ä¹ˆ2PCå‚ä¸è€…æ²¡æœ‰è¶…æ—¶å¤„ç†æœºåˆ¶ï¼Ÿå› ä¸ºè¶…æ—¶å¤„ç†æœºåˆ¶å¯èƒ½å¼•å‘æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œå½“ å‚ä¸è€…è¿Ÿè¿Ÿæ”¶ä¸åˆ°commit or rollback æŒ‡ä»¤æ—¶ï¼Œ å‚ä¸è€…ä¸è®ºæ˜¯ é»˜è®¤æäº¤ è¿˜æ˜¯é»˜è®¤å›æ»šï¼Œéƒ½æœ‰å¯èƒ½å¯¼è‡´å…¨å±€æ•°æ®ä¸ä¸€è‡´ã€‚ 3PC å¢åŠ äº†è¶…æ—¶æœºåˆ¶ï¼Œ ä¼šé»˜è®¤æäº¤äº‹åŠ¡ï¼Œè¿™ä¼šåŠ é‡æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ 5.4 TCCï¼ˆTry-Confirm/Cancelï¼‰TCCæ˜¯ä¸€ç§åº”ç”¨å±‚äº‹åŠ¡åè®®ï¼Œå®ƒåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šTryï¼ˆå°è¯•ï¼‰ã€Confirmï¼ˆç¡®è®¤ï¼‰ã€Cancelï¼ˆå–æ¶ˆï¼‰ã€‚åœ¨Tryé˜¶æ®µï¼Œæ¯ä¸ªå‚ä¸è€…å°è¯•æ‰§è¡Œäº‹åŠ¡å¹¶é”å®šå¿…è¦èµ„æºï¼›åœ¨Confirmé˜¶æ®µï¼Œå¦‚æœæ‰€æœ‰å‚ä¸è€…çš„Tryæ“ä½œéƒ½æˆåŠŸï¼Œé‚£ä¹ˆæ‰§è¡ŒConfirmæ“ä½œæäº¤äº‹åŠ¡ï¼›å¦‚æœä»»ä½•Tryå¤±è´¥ï¼Œåˆ™æ‰§è¡ŒCancelæ“ä½œå›æ»šäº‹åŠ¡ã€‚TCCé€‚ç”¨äºä¸šåŠ¡é€»è¾‘å¤æ‚ï¼Œéœ€è¦é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡ã€‚ ä¸ªäººè®¤ä¸ºï¼ŒTCCå¯ä»¥è¢«ç†è§£ä¸ºæ˜¯2PCçš„ä¸€ç§å˜ä½“ï¼Œå…·æœ‰ä¸¤é˜¶æ®µçš„ç»“æ„ï¼Œä½†å®ƒåœ¨å®æ–½å’Œæ“ä½œä¸Šæ›´é€‚åˆå¤„ç†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å’Œæé«˜ç³»ç»Ÿçš„çµæ´»æ€§ä¸æ•ˆç‡ã€‚ 5.5 å¯é æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨å¯é æ¶ˆæ¯é˜Ÿåˆ—æ¥è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜æ˜¯ä¸€ç§è¢«ç§°ä¸ºâ€œæœ€ç»ˆä¸€è‡´æ€§â€çš„ç­–ç•¥ï¼Œå®ƒé€šè¿‡å¼‚æ­¥æ¶ˆæ¯ä¼ é€’çš„æ–¹å¼ï¼Œç¡®ä¿åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªæœåŠ¡ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€‚ ä½¿ç”¨å¯é æ¶ˆæ¯é˜Ÿåˆ—è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ¸å¿ƒæ€æƒ³åœ¨äºï¼š å¼‚æ­¥ä¸æœ€ç»ˆä¸€è‡´æ€§ï¼šé€šè¿‡å¼‚æ­¥çš„æ–¹å¼å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¹¶ç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§ã€‚ å¯é æ¶ˆæ¯ä¼ é€’ï¼šç¡®ä¿æ¶ˆæ¯ä¼ é€’çš„å¯é æ€§ï¼ŒåŒ…æ‹¬é‡è¯•æœºåˆ¶ã€å¹‚ç­‰å¤„ç†ç­‰ã€‚ 5.6 SAGASAGAæ˜¯ä¸€ç§å°†é•¿æœŸäº‹åŠ¡åˆ†è§£ä¸ºä¸€ç³»åˆ—è¾ƒå°çš„ã€ç‹¬ç«‹çš„å­äº‹åŠ¡çš„æ–¹æ³•ã€‚æ¯ä¸ªå­äº‹åŠ¡éƒ½å¯ä»¥å•ç‹¬æäº¤æˆ–å›æ»šã€‚å¦‚æœæŸä¸ªå­äº‹åŠ¡å¤±è´¥ï¼ŒSAGAé€šè¿‡æ‰§è¡Œè¡¥å¿äº‹åŠ¡ï¼ˆå³é€†æ“ä½œï¼‰æ¥æ¢å¤ä¹‹å‰çš„çŠ¶æ€ã€‚SAGAé™ä½äº†èµ„æºé”å®šçš„æ—¶é—´ï¼Œé€‚ç”¨äºå¾®æœåŠ¡æ¶æ„ä¸­çš„äº‹åŠ¡ç®¡ç†ã€‚ å‚è€ƒæ–‡ç« ã€Šå‘¨å¿—æ˜çš„è½¯ä»¶æ¶æ„è¯¾ã€‹https://www.51cto.com/article/648668.html","tags":["äº‹åŠ¡"]},{"title":"ä½¿ç”¨github page+hexo åˆ›å»ºä¸ªäººç½‘ç«™","path":"/5fe6baa/","content":"å…³äºä½¿ç”¨ github page + hexo åˆ›å»ºä¸ªäººç½‘ç«™ï¼Œ hexoå®˜ç½‘ä¸Šçš„æ­¥éª¤å·²ç»éå¸¸è¯¦ç»†ï¼Œç½‘ä¸Šä¹Ÿæœ‰éå¸¸å¤šç›¸å…³çš„æ–‡ç« ï¼Œ æ‰€ä»¥åŸºç¡€æ­¥éª¤å°±ä¸å†™äº†ã€‚ è¿™é‡Œè®°å½•ä¸€äº›ä¸ªæ€§åŒ–è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ã€‚ 1. TOC é”šç‚¹å¤±æ•ˆæ–‡ç« ç›®å½•æ­£å¸¸ç”Ÿæˆäº†ï¼Œä½†æ˜¯ç‚¹å‡»ç›®å½•æ— æ³•è·³è½¬åˆ°æ–‡ç« å¯¹åº”ä½ç½®ã€‚è§£å†³åŠæ³•ç‚¹è¿™é‡ŒæŸ¥çœ‹ 2. æ–‡ç« çš„çŸ­é“¾æ¥ç”Ÿæˆhexo æ–‡ç« æ ‡é¢˜é»˜è®¤çš„æ ¼å¼æ˜¯:year/:month/:day/:title/,è¿™ä¸ªæ ¼å¼çš„æ ‡é¢˜åœ¨æˆ‘çœ‹æ¥æœ‰2ä¸ªä¸»è¦é—®é¢˜ å¤ªé•¿ï¼Œå¯ä»¥è€ƒè™‘åªå–é»˜è®¤æ ¼å¼ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå¦‚:title/ æ˜“å˜åŒ–ï¼Œ å†™æ–‡ç« æ—¶æœ‰å¯èƒ½ä¼šä¿®æ”¹æ ‡é¢˜,æ‰€ä»¥æ–‡ç« çš„urlå°±ä¼šå‘ç”Ÿå˜åŒ–ã€‚ url ä¸€æ—¦å‘ç”Ÿå˜åŒ–å°±ä¼šå¯¹ç½‘ç«™æ’åäº§ç”Ÿè´Ÿé¢å½±å“ ç»¼ä¸Šï¼Œæˆ‘å¸Œæœ›æ¯ç¯‡æ–‡ç« éƒ½æœ‰ä¸€ä¸ª å›ºå®šä¸”çŸ­çš„ urlã€‚ hexo-abbrlink:create one and only link for every post for hexo æ’ä»¶å¯ä»¥å®ç°è¯¥åŠŸèƒ½ï¼Œ å®ƒæ ¹æ®æ–‡ç« æ ‡é¢˜å’Œåˆ›å»ºæ—¶é—´ä¸ºæ–‡ç« ç”Ÿæˆä¸€ä¸ªabbrlinkï¼Œ å¦‚æœæ–‡ç« å·²ç»æœ‰è¯¥å±æ€§åˆ™ä¸ä¼šé‡å¤ç”Ÿæˆã€‚ 3. custom domain æ¶ˆå¤±è®°åœ¨github pages é…ç½®äº†custom domain ï¼Œä½†æ˜¯æˆ‘å‘ç°æ¯æ¬¡deployæ–°å†…å®¹åï¼Œé…ç½®å¥½çš„custom domain éƒ½ä¼šæ¶ˆå¤±ï¼Œç»è¿‡æ’æŸ¥å‘ç°æ˜¯ç¼ºå¤±æ¥ CNAMEæ–‡ä»¶ã€‚ 3.1 CNAMEæ˜¯ä»€ä¹ˆCNAMEï¼ˆCanonical Nameï¼‰è®°å½•æ˜¯ä¸€ç§DNSï¼ˆDomain Name Systemï¼‰è®°å½•ç±»å‹ï¼Œç”¨äºå°†ä¸€ä¸ªåŸŸååˆ«åæ˜ å°„åˆ°å¦ä¸€ä¸ªçœŸæ­£çš„åŸŸåã€‚å®ƒçš„ä½œç”¨æ˜¯ç®€åŒ–åŸŸåç®¡ç†ã€å®ç°è´Ÿè½½å‡è¡¡ã€æ”¯æŒCDNé›†æˆç­‰ã€‚CNAMEè®°å½•çš„å·¥ä½œæµç¨‹åŒ…æ‹¬DNSæŸ¥è¯¢ã€é€’å½’æŸ¥è¯¢ã€æƒå¨DNSæœåŠ¡å™¨å“åº”å’ŒIPåœ°å€è¿”å›ç­‰æ­¥éª¤ã€‚é€šè¿‡æ­£ç¡®é…ç½®CNAMEè®°å½•ï¼Œå¯ä»¥æœ‰æ•ˆç®¡ç†å’Œä¼˜åŒ–ç½‘ç«™çš„åŸŸåè§£æã€‚ 3.2 CNAMEè®°å½•çš„ä½œç”¨ åŸŸåé‡å®šå‘ï¼šå…è®¸å¤šä¸ªåŸŸåæŒ‡å‘åŒä¸€ä¸ªç›®æ ‡åŸŸåï¼Œç®€åŒ–äº†åŸŸåç®¡ç†ã€‚ä¾‹å¦‚ï¼Œå°†www.example.comå’Œblog.example.coméƒ½æŒ‡å‘example.comã€‚ è´Ÿè½½å‡è¡¡ï¼šé€šè¿‡CNAMEè®°å½•å¯ä»¥å°†æµé‡åˆ†å¸ƒåˆ°ä¸åŒçš„æœåŠ¡å™¨ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚ å†…å®¹åˆ†å‘ç½‘ç»œï¼ˆCDNï¼‰é›†æˆï¼šCDNæä¾›å•†é€šå¸¸è¦æ±‚å°†ç”¨æˆ·çš„å­åŸŸåï¼ˆå¦‚cdn.example.comï¼‰CNAMEåˆ°ä»–ä»¬çš„CDNåŸŸåï¼ˆå¦‚cdn.provider.comï¼‰ï¼Œä»¥ä¾¿è¿›è¡Œæµé‡ç®¡ç†å’Œå†…å®¹åˆ†å‘ã€‚ 3.3 CNAMEè®°å½•çš„å·¥ä½œæµç¨‹CNAMEè®°å½•çš„å·¥ä½œæµç¨‹å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªä¸»è¦é˜¶æ®µï¼šè§£æCNAMEè®°å½•æœ¬èº«å’Œè§£æCNAMEè®°å½•æŒ‡å‘çš„ç›®æ ‡åŸŸåï¼Œç›´åˆ°æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªIPåœ°å€ã€‚ DNSæŸ¥è¯¢å¼€å§‹ï¼šç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­è¾“å…¥åŸŸåï¼Œå¦‚www.example.comï¼Œå¹¶å‘é€DNSæŸ¥è¯¢è¯·æ±‚ã€‚ é€’å½’DNSæœåŠ¡å™¨å¤„ç†è¯·æ±‚ï¼šç”¨æˆ·çš„è®¡ç®—æœºå‘é€’å½’DNSæœåŠ¡å™¨ï¼ˆé€šå¸¸ç”±ISPæä¾›ï¼‰å‘é€è¯·æ±‚ã€‚é€’å½’DNSæœåŠ¡å™¨æŸ¥è¯¢æ ¹DNSæœåŠ¡å™¨ï¼Œè·å–é¡¶çº§åŸŸåæœåŠ¡å™¨ï¼ˆå¦‚.comçš„æœåŠ¡å™¨ï¼‰çš„ä¿¡æ¯ã€‚ é€’å½’æŸ¥è¯¢è¿‡ç¨‹ï¼šé€’å½’DNSæœåŠ¡å™¨æŸ¥è¯¢é¡¶çº§åŸŸåæœåŠ¡å™¨ï¼Œè·å–è¯¥åŸŸçš„æƒå¨DNSæœåŠ¡å™¨ä¿¡æ¯ï¼ˆå¦‚example.comçš„DNSæœåŠ¡å™¨ï¼‰ã€‚é€’å½’DNSæœåŠ¡å™¨æ¥ç€æŸ¥è¯¢æƒå¨DNSæœåŠ¡å™¨ã€‚ æƒå¨DNSæœåŠ¡å™¨å“åº”ï¼šæƒå¨DNSæœåŠ¡å™¨æŸ¥æ‰¾www.example.comçš„DNSè®°å½•ã€‚å¦‚æœwww.example.comæœ‰ä¸€ä¸ªCNAMEè®°å½•æŒ‡å‘example.comï¼Œæƒå¨DNSæœåŠ¡å™¨è¿”å›è¿™ä¸ªCNAMEè®°å½•ã€‚ CNAMEè§£æï¼šé€’å½’DNSæœåŠ¡å™¨æ¥æ”¶åˆ°CNAMEè®°å½•åï¼Œå†æ¬¡è¿›è¡ŒDNSæŸ¥è¯¢ï¼Œä»¥è§£æCNAMEè®°å½•æŒ‡å‘çš„ç›®æ ‡åŸŸåexample.comã€‚é€’å½’DNSæœåŠ¡å™¨æœ€ç»ˆè·å–ç›®æ ‡åŸŸåexample.comçš„Aè®°å½•ï¼ˆIPåœ°å€ï¼‰ã€‚ è¿”å›IPåœ°å€ï¼šé€’å½’DNSæœåŠ¡å™¨å°†ç›®æ ‡åŸŸåexample.comçš„Aè®°å½•è¿”å›ç»™ç”¨æˆ·çš„è®¡ç®—æœºã€‚ç”¨æˆ·çš„è®¡ç®—æœºä½¿ç”¨è¯¥IPåœ°å€ä¸ç›®æ ‡æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼ŒåŠ è½½ç½‘ç«™å†…å®¹ã€‚3.4 Hexo ä¸­CNAME æ–‡ä»¶çš„ä½œç”¨ å½“ä½ ä½¿ç”¨è‡ªå®šä¹‰åŸŸåè€Œä¸æ˜¯username.github.ioæ¥è®¿é—®ç½‘ç«™æ—¶ï¼Œéœ€è¦åœ¨åœ¨sourceç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶CNAME æ–‡ä»¶ï¼Œå¹¶å†™å…¥è‡ªå®šä¹‰åŸŸå CNAMEæ–‡ä»¶çš„å­˜åœ¨å’Œå†…å®¹ä¼šå‘ŠçŸ¥GitHub Pagesä½ å¸Œæœ›é€šè¿‡å“ªä¸ªè‡ªå®šä¹‰åŸŸåè®¿é—®ä½ çš„ç½‘ç«™ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„è‡ªå®šä¹‰åŸŸåæ˜¯www.example.comï¼Œä½ éœ€è¦åœ¨CNAMEæ–‡ä»¶ä¸­å†™å…¥www.example.comã€‚ 4. æ•°å­¦å…¬å¼çš„æ”¯æŒå¯å‚è€ƒ åœ¨ä»»æ„çš„hexoä¸»é¢˜æ”¯æŒæ•°å­¦å…¬å¼"},{"title":"chatGPTæ˜¯å¦‚ä½•è¢«è®­ç»ƒå‡ºæ¥çš„","path":"/8cb014c5/","content":"æœ¬æ–‡å†…å®¹åŸºäº Andrej Karpathy çš„è§†é¢‘ State of GPTï¼Œå¹¶åŠ å…¥äº†ä¸ªäººç†è§£ï¼Œè¿›è¡Œæ€»ç»“ã€‚ è¯¥éƒ¨åˆ†çš„ä¸»é¢˜æ˜¯how to train your GPT assistantsï¼Œ åœ¨chatGPT çš„è¯­å¢ƒä¸­ï¼ŒAssistant ç‰¹æŒ‡èƒ½å›ç­”é—®é¢˜ï¼ŒåƒåŠ©æ‰‹ä¸€æ ·å¯ä»¥å¸®æˆ‘ä»¬åšå¾ˆå¤šäº‹ã€‚ 0. GPTè®­ç»ƒçš„å››ä¸ªé˜¶æ®µ ç›®å‰æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨åˆ°çš„chatGPT éƒ½æ˜¯RLFH æ¨¡å‹ï¼Œè¯¥æ¨¡å‹çš„è®­ç»ƒå¯ä»¥åˆ†ä¸º3ä¸ªé˜¶æ®µ pretraining é¢„è®­ç»ƒ Supervised finetuning ç›‘ç£å¾®è°ƒ Reinforcement Learning from Human Feedbackï¼Œ åŒ…æ‹¬reward modeling å’ŒReinforcement Learningï¼Œ å› ä¸ºreward modeling ä¸èƒ½ç‹¬ç«‹èµ·ä½œç”¨ï¼Œä¹Ÿä¸èƒ½ç‹¬ç«‹éƒ¨ç½²ï¼Œå¿…é¡»Reinforcement Learningç»“åˆä½¿ç”¨ï¼Œæ‰€ä»¥æŠŠå®ƒä»¬å½’ç±»ä¸ºä¸€ä¸ªé˜¶æ®µã€‚ åœ¨ä»¥ä¸Šæ¯ä¸ªé˜¶æ®µä¸­ï¼Œéƒ½æœ‰å„è‡ªè®­ç»ƒéœ€è¦çš„æ•°æ®é›†ã€ç®—æ³•ã€å’Œè®­ç»ƒè¾“å‡ºç»“æœ 1. pre-training é¢„è®­ç»ƒpre-trainin é¢„è®­ç»ƒé˜¶æ®µæ˜¯ä¸€åˆ‡çš„èµ·ç‚¹ï¼Œå®ƒéœ€è¦æœ€å¤šçš„æ•°æ®ï¼Œæœ€å¤šçš„è®¡ç®—èµ„æºGPUï¼Œæœ€é•¿çš„è®­ç»ƒæ—¶é—´ã€‚ æ€»çš„ç‰¹ç‚¹å¦‚ä¸‹ å¤§è§„æ¨¡æ•°æ®ï¼šé¢„è®­ç»ƒä½¿ç”¨çš„å¤§è§„æ¨¡æ•°æ®é›†åŒ…å«äº†æ¥è‡ªäº’è”ç½‘çš„å„ç§æ–‡æœ¬ï¼Œè¿™äº›æ•°æ®é›†è§„æ¨¡åºå¤§ï¼Œé€šå¸¸åŒ…å«æ•°åäº¿ç”šè‡³æ•°ç™¾äº¿ä¸ªtokenã€‚ æ— ç›‘ç£å­¦ä¹ ï¼šé¢„è®­ç»ƒé€šå¸¸é‡‡ç”¨æ— ç›‘ç£å­¦ä¹ æ–¹æ³•ï¼Œå³ä¸éœ€è¦äººä¸ºæ ‡æ³¨çš„æ•°æ®ã€‚æ¨¡å‹é€šè¿‡é¢„æµ‹æ–‡æœ¬ä¸­çš„ä¸‹ä¸€è¯ï¼ˆæˆ–ä¸‹ä¸€ä¸ªtokenï¼‰æ¥å­¦ä¹ è¯­è¨€ç»“æ„å’Œæ¨¡å¼ã€‚ é€šç”¨æ€§ï¼šé¢„è®­ç»ƒæ¨¡å‹å…·æœ‰é€šç”¨æ€§ï¼Œå› ä¸ºå®ƒå¹¶æ²¡æœ‰é’ˆå¯¹ç‰¹å®šä»»åŠ¡è¿›è¡Œä¼˜åŒ–ï¼Œè€Œæ˜¯å¹¿æ³›åœ°å­¦ä¹ å„ç§è¯­è¨€æ¨¡å¼ã€‚è¿™ç§é€šç”¨æ€§ä½¿å¾—æ¨¡å‹å¯ä»¥é€‚åº”å¤šç§ä¸‹æ¸¸ä»»åŠ¡ã€‚1.1 Dataset é¢„è®­ç»ƒä½¿ç”¨çš„å¤§è§„æ¨¡æ•°æ®é›†åŒ…å«äº†æ¥è‡ªäº’è”ç½‘çš„å„ç§æ–‡æœ¬ï¼Œè¿™äº›æ•°æ®é›†è§„æ¨¡åºå¤§ï¼Œä¸è¿‡ç›®å‰chatGPT æ²¡æœ‰å…¬å¼€å…·ä½“çš„æ•°æ®ï¼Œ ä¸Šå›¾æ˜¯meta å¼€æºçš„LLaMAçš„è®­ç»ƒæ•°æ®é›† 67.0%çš„Common Crawlï¼Œä¹Ÿå°±æ˜¯å¸¸è§„ç½‘ç»œçˆ¬å–çš„æ•°æ®é›†ï¼Œè¿™éƒ¨åˆ†æ•°æ®é›†çš„ç‰¹ç‚¹æ˜¯å†…å®¹æ¶‰åŠçš„ç±»å‹å¾ˆå…¨é¢ï¼Œä½†æ˜¯å› ä¸ºå†…å®¹å¯èƒ½æ˜¯ä»»ä½•äººå†™çš„ï¼Œè´¨é‡ä¸€èˆ¬åä½ï¼Œä¹Ÿä¼šåŒ…å«å¤§é‡ä¸ç›¸å…³ï¼Œä¾‹å¦‚å¹¿å‘Šã€å¯¼èˆªæ¡ã€ç‰ˆæƒå£°æ˜ç­‰ã€‚ 15.0%æ˜¯C4æ•°æ®é›† (Colossal Clean Crawled Corpus, â€œåºå¤§çš„æ¸…æ´è¯­æ–™åº“â€)ï¼Œè¿™ä¸ªæ•°æ®é›†åŒ…å«äº†å¤§é‡çš„ç½‘é¡µæ–‡æœ¬ï¼Œè¿™äº›æ–‡æœ¬å·²ç»è¿‡æ¸…ç†ï¼Œç§»é™¤äº†å¹¿å‘Šã€é‡å¤å†…å®¹ã€éè‹±è¯­æ–‡æœ¬ã€å’Œå…¶ä»–ä¸é€‚åˆè®­ç»ƒçš„å…ƒç´ ã€‚è¿™ä¸ªæ•°æ®é›†çš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªå¤§è§„æ¨¡ã€é«˜è´¨é‡ã€å¤šæ ·æ€§å¼ºçš„è‹±è¯­æ–‡æœ¬æ•°æ®é›†ï¼Œä»¥æ”¯æŒè‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ã€‚å°½ç®¡C4ç»è¿‡æ¸…ç†ï¼Œä½†ä»ç„¶åŒ…å«äº†æ¥è‡ªäº’è”ç½‘çš„å„ç§æ–‡æœ¬ï¼Œå› æ­¤å¯èƒ½åŒ…å«ä¸€äº›è´¨é‡ä¸é«˜çš„ä¿¡æ¯çš„ä¿¡æ¯ã€‚ å‰©ä½™18%çš„è®­ç»ƒæ•°æ®æ¥æºä¸»è¦æ˜¯æ¥è‡ªGithubã€ç»´åŸºç™¾ç§‘ã€ä¹¦ç±ã€Arxivè®ºæ–‡ã€äº¤æ˜“æ‰€ç­‰ï¼Œ å¯ä»¥è®¤ä¸ºæ˜¯é«˜è´¨é‡çš„æ•°æ®ã€‚ è¿™äº›è®­ç»ƒæ•°æ®æœ‰ä»¥ä¸‹ç‰¹ç‚¹ è§„æ¨¡åºå¤§ï¼šè®­ç»ƒæ•°æ®çš„æ•°é‡éå¸¸å¤§ï¼ŒåŒ…å«æ•°åäº¿æ¡æ–‡æœ¬è®°å½•ã€‚è¿™ç§å¤§è§„æ¨¡çš„æ•°æ®é‡å¸®åŠ©æ¨¡å‹å­¦ä¼šè¯­è¨€çš„å¤æ‚æ€§å’Œç»†å¾®å·®åˆ«ã€‚ å¤šæ ·æ€§ï¼šè®­ç»ƒæ•°æ®æ¶µç›–äº†å¹¿æ³›çš„ä¸»é¢˜å’Œé¢†åŸŸï¼ŒåŒ…æ‹¬ç§‘å­¦ã€è‰ºæœ¯ã€å†å²ã€æ–‡å­¦ã€æŠ€æœ¯ã€æ—¥å¸¸ç”Ÿæ´»ç­‰ã€‚è¿™ç§å¤šæ ·æ€§ä½¿å¾—æ¨¡å‹èƒ½å¤Ÿåº”å¯¹å„ç§ç±»å‹çš„é—®é¢˜å’Œå¯¹è¯ã€‚ å¹¿æ³›è¦†ç›–ï¼šæ¶µç›–äº†ä»åŸºç¡€çŸ¥è¯†åˆ°ä¸“ä¸šçŸ¥è¯†çš„å¹¿æ³›èŒƒå›´ï¼Œä½¿å¾—æ¨¡å‹åœ¨å›ç­”é—®é¢˜æ—¶æ—¢èƒ½å¤„ç†ç®€å•çš„æ—¥å¸¸é—®é¢˜ï¼Œä¹Ÿèƒ½åº”å¯¹å¤æ‚çš„ä¸“ä¸šé—®é¢˜ã€‚ . å¼€æ”¾è·å–ï¼šæ‰€æœ‰æ•°æ®éƒ½æ¥è‡ªå…¬å¼€å¯è·å–çš„èµ„æºï¼Œæ²¡æœ‰ä½¿ç”¨ç§äººæˆ–å—ä¿æŠ¤çš„æ•°æ®ï¼Œç¡®ä¿äº†æ•°æ®çš„åˆæ³•æ€§å’Œé“å¾·æ€§ã€‚ æ ¹æ®ä»¥ä¸Šç‰¹ç‚¹ï¼Œå¯ä»¥æ€»ç»“è®¤ä¸ºåƒchatGPT è¿™æ ·çš„LLM, å­¦ä¹ äº†äººç±»åœ¨äº’è”ç½‘ä¸Šå‘è¡¨è¿‡æ‰€æœ‰çŸ¥è¯†ã€‚ä¸è¿‡ç”±äºé«˜è´¨é‡çš„æ•°æ®åªå 18%ï¼Œ å¦‚æœä½ æƒ³è·å–é«˜è´¨é‡çš„å›ç­”ï¼Œæ‰€ä»¥ä½ éœ€è¦ä¸€äº›chatGPT æ²Ÿé€šçš„æŠ€å·§ï¼Œ å³prompt æŠ€å·§ï¼Œæ‰èƒ½è·å–é«˜è´¨é‡çš„å›ç­”ã€‚ 1.2 preprocess dataset-Tokenizationé’ˆå¯¹ä»äº’è”ç½‘ä¸Šè·å–åˆ°çš„å¤§é‡æ•°æ®ï¼ŒchatGPT å¹¶ä¸æ˜¯ç›´æ¥æ‹¿æ¥è®­ç»ƒï¼Œè€Œæ˜¯è¦ç»è¿‡tokenization æ ‡è®°åŒ–ï¼Œå°†æ–‡æœ¬è½¬æ¢æˆæ¨¡å‹å¯ä»¥ç†è§£çš„æ•´æ•°åºåˆ—ã€‚ 1.2.1 ä»€ä¹ˆæ˜¯Tokenizationï¼ŸTokenizationæ˜¯å°†æ–‡æœ¬æ‹†åˆ†æˆè¾ƒå°çš„å•å…ƒï¼ˆç§°ä¸ºtokensï¼‰çš„è¿‡ç¨‹ã€‚è¿™äº›tokenså¯ä»¥æ˜¯å•è¯ã€å­è¯ã€å­—ç¬¦æˆ–å…¶ä»–æ–‡æœ¬ç‰‡æ®µï¼Œï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°ç‰¹å®šçš„æ ‡è®°æˆ–æ•´æ•°çš„è¿‡ç¨‹ã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒGPT å¹¶ä¸æ˜¯ç›´æ¥ä½¿ç”¨ä»äº’è”ç½‘ä¸Šè·å–çš„åŸå§‹æ•°æ®è¿›è¡Œè®­ç»ƒï¼Œ è€Œæ˜¯å…ˆè®²æ•°æ®åˆ†è§£æˆtoken,å†å°†token è½¬åŒ–æˆæ•´æ•°æ•°åˆ—ã€‚æœ€ç»ˆè¿›å…¥åˆ°ç¥ç»ç½‘ç»œ/Transformer è¿›è¡Œè®­ç»ƒçš„æ˜¯è¿™äº›æ•´æ•°æ•°åˆ—ã€‚ ä»¥ä¸‹Tokenizationçš„æ­¥éª¤ï¼š æ–‡æœ¬æ¸…ç†ï¼šåœ¨è¿›è¡ŒTokenizationä¹‹å‰ï¼Œæ–‡æœ¬å¯èƒ½éœ€è¦æ¸…ç†ï¼Œæ¯”å¦‚å»æ‰å¤šä½™çš„ç©ºæ ¼ã€æ ‡ç‚¹ç¬¦å·çš„å¤„ç†ç­‰ã€‚è¿™ä¸€æ­¥éª¤è§†å…·ä½“åº”ç”¨è€Œå®šã€‚ æ‹†åˆ†æ–‡æœ¬ï¼šå°†æ–‡æœ¬æ‹†åˆ†æˆtokensã€‚ä¾‹å¦‚ï¼Œå¯¹äºå¥å­â€œChatGPT is great.â€ï¼Œå¯ä»¥æ‹†åˆ†ä¸ºâ€œChatGPTâ€ã€â€œisâ€å’Œâ€œgreatâ€ã€‚ å­è¯çº§åˆ«çš„Tokenizationï¼šç°ä»£è¯­è¨€æ¨¡å‹ï¼ˆå¦‚GPT-3ï¼‰é€šå¸¸ä½¿ç”¨å­è¯ï¼ˆsubwordï¼‰çº§åˆ«çš„Tokenizationï¼Œå¦‚Byte Pair Encodingï¼ˆBPEï¼‰æˆ–WordPieceã€‚è¿™äº›æ–¹æ³•å¯ä»¥å°†ç½•è§è¯åˆ†è§£ä¸ºæ›´å¸¸è§çš„å­è¯ç‰‡æ®µã€‚ä¾‹å¦‚ï¼Œå•è¯â€œunhappinessâ€å¯ä»¥åˆ†è§£ä¸ºâ€œunâ€ã€â€œhappinessâ€æˆ–è¿›ä¸€æ­¥åˆ†è§£ä¸ºâ€œunâ€ã€â€œhappiâ€ã€â€œnessâ€ã€‚ åˆ†é…å”¯ä¸€IDï¼šæ¯ä¸ªtokenè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„æ•´æ•°IDï¼Œæ¨¡å‹å†…éƒ¨ä½¿ç”¨è¿™äº›IDè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨æ–‡æœ¬ã€‚ä¾‹å¦‚ï¼Œâ€œChatGPTâ€å¯èƒ½è¢«åˆ†é…ID 12345ï¼Œâ€œisâ€è¢«åˆ†é…ID 6789ï¼Œä¾æ­¤ç±»æ¨ã€‚ 1.2.2ä»€ä¹ˆæ˜¯tokentoken åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰ä¸­æ‰®æ¼”ç€æ ¸å¿ƒè§’è‰²ï¼Œå°¤å…¶æ˜¯åœ¨è®­ç»ƒåƒChatGPTè¿™æ ·çš„å¤§å‹è¯­è¨€æ¨¡å‹æ—¶ï¼Œtokenæ˜¯æ¨¡å‹è®­ç»ƒå’Œç”Ÿæˆæ–‡æœ¬çš„åŸºæœ¬å•ä½ã€‚ åœ¨è‹±è¯­é¢„æ–™ä¸­ï¼Œå®ƒå¯ä»¥æ˜¯æ˜¯ä¸€ä¸ªè¯ã€ä¹Ÿå¯ä»¥æ˜¯ä¸€éƒ¨åˆ†è¯ã€æˆ–è€…ä¸€ä¸ªå­—ç¬¦ï¼ˆè™½ç„¶æ¼”è®²ä¸­ç¤ºä¾‹å¯¹token çš„ä¸¾ä¾‹åŸºæœ¬æ˜¯éƒ½æ˜¯å®Œæ•´çš„å•è¯ï¼‰ é‚£ä¹ˆè¿™é‡Œå°±è¦æ€è€ƒï¼Œä¸ºä»€ä¹ˆä¸ç”¨å®Œæ•´çš„å•è¯è®­ç»ƒå‘¢ï¼Œæ—¢ç®€å•åˆç›´æ¥ã€‚ è¯æ±‡è¡¨å¤§å°å’Œç¨€ç–æ€§é—®é¢˜ä½¿ç”¨å®Œæ•´å•è¯è¿›è¡Œè®­ç»ƒçš„ä¸€ä¸ªä¸»è¦é—®é¢˜æ˜¯è¯æ±‡è¡¨çš„å¤§å°ã€‚è‹±è¯­å’Œå…¶ä»–è¯­è¨€ä¸­çš„è¯æ±‡é‡éå¸¸åºå¤§ï¼Œå°¤å…¶æ˜¯å½“è€ƒè™‘åˆ°æ–°è¯ã€ä¸“æœ‰åè¯ã€ä¸åŒçš„è¯å½¢å˜åŒ–ï¼ˆå¦‚å¤æ•°å½¢å¼ã€æ—¶æ€ç­‰ï¼‰æ—¶ï¼Œè¯æ±‡è¡¨çš„è§„æ¨¡å¯èƒ½ä¼šå˜å¾—éå¸¸å¤§ã€‚ å¤§è¯æ±‡è¡¨é—®é¢˜ï¼šä¸€ä¸ªåºå¤§çš„è¯æ±‡è¡¨æ„å‘³ç€æ¨¡å‹éœ€è¦å¤„ç†æ›´å¤šçš„å•è¯ï¼Œè¿™ä¸ä»…å¢åŠ äº†æ¨¡å‹çš„å¤æ‚æ€§ï¼Œè¿˜ä¼šæ˜¾è‘—å¢åŠ è®­ç»ƒå’Œè¿è¡Œæ¨¡å‹æ‰€éœ€çš„èµ„æºï¼ˆå¦‚å†…å­˜å’Œè®¡ç®—æ—¶é—´ï¼‰ã€‚ ç¨€ç–æ€§é—®é¢˜ï¼šå½“è¯æ±‡è¡¨å¾ˆå¤§æ—¶ï¼Œå¾ˆå¤šå•è¯åœ¨è®­ç»ƒæ•°æ®ä¸­å‡ºç°çš„é¢‘ç‡å¯èƒ½éå¸¸ä½ï¼Œå¯¼è‡´æ•°æ®ç¨€ç–ã€‚ç¨€ç–æ€§é—®é¢˜ä¼šé™ä½æ¨¡å‹å¯¹è¿™äº›å•è¯çš„å­¦ä¹ æ•ˆç‡ï¼Œå½±å“æ¨¡å‹çš„æ€§èƒ½å’Œæ³›åŒ–èƒ½åŠ›ã€‚ å¤„ç†æœªçŸ¥è¯æ±‡çš„èƒ½åŠ›ç›´æ¥ä½¿ç”¨å®Œæ•´å•è¯è¿›è¡Œè®­ç»ƒé¢ä¸´çš„å¦ä¸€ä¸ªæŒ‘æˆ˜æ˜¯å¦‚ä½•å¤„ç†è®­ç»ƒæ•°æ®ä¸­æœªå‡ºç°è¿‡çš„å•è¯ï¼ˆå³æœªçŸ¥è¯æ±‡æˆ–OOVé—®é¢˜ï¼‰ã€‚ æœªçŸ¥è¯æ±‡ï¼ˆOOVï¼‰é—®é¢˜ï¼šåœ¨æ–°çš„æ–‡æœ¬ä¸­ç»å¸¸ä¼šå‡ºç°è®­ç»ƒæ•°æ®ä¸­æœªè§è¿‡çš„å•è¯ã€‚å¦‚æœæ¨¡å‹åªå­¦ä¹ åˆ°äº†å®Œæ•´å•è¯ï¼Œé‚£ä¹ˆå®ƒå¾ˆéš¾å¤„ç†è¿™äº›æœªçŸ¥è¯æ±‡ã€‚ æ³›åŒ–èƒ½åŠ›ï¼šé€šè¿‡ä½¿ç”¨å­è¯ï¼ˆå¦‚è¯å¹²ã€å‰ç¼€ã€åç¼€ç­‰ï¼‰æˆ–æ›´å°çš„å•å…ƒï¼Œæ¨¡å‹å¯ä»¥æ›´å¥½åœ°æ³›åŒ–åˆ°æœªè§è¿‡çš„å•è¯ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡è¯†åˆ«â€œun-â€å’Œâ€œ-ableâ€è¿™æ ·çš„å‰åç¼€ï¼Œæ¨¡å‹å¯ä»¥æ¨æ–­å‡ºâ€œunbelievableâ€ç­‰å•è¯çš„å«ä¹‰ï¼Œå³ä½¿è¿™ä¸ªè¯åœ¨è®­ç»ƒæ•°æ®ä¸­æ²¡æœ‰ç›´æ¥å‡ºç°è¿‡ã€‚ è®­ç»ƒæ•ˆç‡å’Œè®¡ç®—èµ„æºåˆ†è¯è¿˜å¯ä»¥å¸®åŠ©æé«˜è®­ç»ƒæ•ˆç‡å’Œå‡å°‘å¯¹è®¡ç®—èµ„æºçš„éœ€æ±‚ã€‚ å‡å°‘å‚æ•°æ•°é‡ï¼šè¾ƒå°çš„è¯æ±‡è¡¨å¯ä»¥å‡å°‘æ¨¡å‹çš„å‚æ•°æ•°é‡ï¼Œé™ä½è¿‡æ‹Ÿåˆçš„é£é™©ï¼ŒåŒæ—¶æé«˜æ¨¡å‹çš„è®­ç»ƒé€Ÿåº¦å’Œæ¨ç†é€Ÿåº¦ã€‚ å†…å­˜å’Œå­˜å‚¨ä¼˜åŒ–ï¼šä½¿ç”¨æ›´å°çš„è¯æ±‡è¡¨æ„å‘³ç€å¯ä»¥æ›´é«˜æ•ˆåœ°ä½¿ç”¨å†…å­˜å’Œå­˜å‚¨èµ„æºï¼Œå°¤å…¶æ˜¯åœ¨åµŒå…¥å±‚ä¸­ã€‚ é€‚åº”å¤šæ ·åŒ–çš„è¯­è¨€ç°è±¡è¯­è¨€ä¸­å­˜åœ¨å¤§é‡çš„å˜ä½“å’Œåˆ›æ–°ï¼Œç›´æ¥ä½¿ç”¨å®Œæ•´å•è¯å¯èƒ½éš¾ä»¥é€‚åº”è¿™äº›å˜åŒ–ã€‚ è¯å½¢å˜åŒ–ï¼šåœ¨è®¸å¤šè¯­è¨€ä¸­ï¼Œå•è¯å¯ä»¥æœ‰å¤šç§å½¢å¼ã€‚ä½¿ç”¨åŸºäºè§„åˆ™æˆ–ç»Ÿè®¡çš„åˆ†è¯æ–¹æ³•å¯ä»¥å¸®åŠ©æ¨¡å‹ç†è§£ä¸åŒè¯å½¢ä¹‹é—´çš„å…³è”ï¼Œæé«˜æ¨¡å‹å¯¹è¯­è¨€å˜åŒ–çš„é€‚åº”èƒ½åŠ›ã€‚ æ–°è¯åˆ›é€ å’Œç½‘ç»œè¯­è¨€ï¼šæ–°è¯å’Œç½‘ç»œæµè¡Œè¯­çš„å‡ºç°æ˜¯å¸¸æ€ã€‚åˆ†è¯ç³»ç»Ÿå¯ä»¥é€šè¿‡æ›´æ–°è¯åº“æˆ–è°ƒæ•´åˆ†è¯ç®—æ³•æ¥é€‚åº”è¿™äº›å˜åŒ–ã€‚ 1.3 Unsupervised Learning-æ— ç›‘ç£å­¦ä¹ é¢„è®­ç»ƒé‡‡ç”¨æ— ç›‘ç£å­¦ä¹ æ–¹æ³•ï¼Œå³ä¸éœ€è¦äººä¸ºæ ‡æ³¨çš„æ•°æ®ã€‚æ¨¡å‹é€šè¿‡é¢„æµ‹æ–‡æœ¬ä¸­çš„ä¸‹ä¸€è¯ï¼ˆæˆ–ä¸‹ä¸€ä¸ªtokenï¼‰æ¥å­¦ä¹ è¯­è¨€ç»“æ„å’Œæ¨¡å¼ã€‚ æ•°æ®ä¼šä»¥æ‰¹æ¬¡ä¸ºå•ä½ï¼Œ è¾“å…¥åˆ°Transformerä¸­è¿›è¡Œè®­ç»ƒï¼Œå…¶è®­ç»ƒè¿‡ç¨‹å°±æ˜¯ä¸æ–­è®©æ¨¡å‹æ ¹æ®å‰é¢å·²ç»çš„å†…å®¹ï¼ˆé»„è‰²éƒ¨åˆ†ï¼‰ï¼Œå»çŒœæµ‹å½“å‰token(ç»¿è‰²éƒ¨åˆ†)çš„ä¸‹ä¸€ä¸ªè¯æ˜¯ä»€ä¹ˆï¼ˆçº¢è‰²éƒ¨åˆ†ï¼‰ï¼Œ å¦‚æœçŒœæµ‹çš„ç»“æœå’Œå®é™…æƒ…å†µä¸ä¸€è‡´ï¼Œåˆ™è¦è°ƒæ•´æ¨¡å‹ï¼Œç›´è‡³ç»“æœä¸€è‡´ã€‚ çŒœæµ‹çš„è¿‡ç¨‹æ˜¯åŸºäºæ¦‚ç‡è¿›è¡Œçš„ã€‚ å¦‚æœçŒœé”™äº†ï¼Œé‚£è·ç¦»æ­£ç¡®ç­”æ¡ˆåˆå¤šè¿œï¼Œè¿™å°±æ˜¯æŸå¤±å‡½æ•°çš„æ¦‚å¿µã€‚ä½æŸå¤±æ„å‘³ç€æ›´é«˜çš„é¢„æµ‹æ­£ç¡®æ¦‚ç‡ 1.3 base modelé¢„è®­ç»ƒå®Œæˆåä¼šå¾—åˆ°ä¸€ä¸ªbase model ï¼Œå› ä¸ºå®ƒå¹¶æ²¡æœ‰é’ˆå¯¹ç‰¹å®šä»»åŠ¡è¿›è¡Œä¼˜åŒ–ï¼Œè€Œæ˜¯å¹¿æ³›åœ°å­¦ä¹ å„ç§è¯­è¨€æ¨¡å¼ã€‚è¿™ç§é€šç”¨æ€§ä½¿å¾—æ¨¡å‹å¯ä»¥é€‚åº”å¤šç§ä¸‹æ¸¸ä»»åŠ¡ã€‚ 1.3.1 base model are not assistantè¿™å¥è¯çš„å«ä¹‰æ˜¯base model å¹¶ä¸èƒ½å›ç­”é—®é¢˜ã€‚é¢„è®­ç»ƒé˜¶æ®µå¾—åˆ°çš„base model åªæ˜¯ä¸€ä¸ªæ–‡æ¡£ç”Ÿæˆå™¨ï¼Œ åªä¼šæ ¹æ®ä½ è¾“å…¥çš„å†…å®¹å»é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯ï¼Œå¹¶ä¸ä¼šå›ç­”ä½ çš„é—®é¢˜ï¼Œæ‰€ä»¥è¿˜èµ·ä¸åˆ°assistant åŠ©æ‰‹ çš„ä½œç”¨ã€‚ å¦‚å›¾ä¸­ï¼Œbase model å¹¶ä¸ä¼šæŒ‰ç…§ä½ çš„è¦æ±‚å†™è¯—ï¼ŒçŸ¥è¯†ç”Ÿæˆç›¸ä¼¼çš„å†…å®¹ã€‚ what is the capital of France? å†ä¾‹å¦‚é’ˆå¯¹ä»¥ä¸Šé—®é¢˜ï¼Œbase model å¹¶ä¸ä¼šå›ç­”é—®é¢˜ï¼Œç»™å‡ºâ€œParisâ€, è€Œæ˜¯ä¼šç»­å†™å†…å®¹ï¼Œ ç»™å‡ºä»¥ä¸‹å¯èƒ½çš„ç­”æ¡ˆwhat is Franceâ€™s largest city?what is Franceâ€™s population?what is the currency of France? 1.4 å¦‚ä½•è®© base model å›ç­”é—®é¢˜1.4.1 few-shot LearningFew-shot Learningï¼šæŒ‡çš„ä¸€ç§åœ¨ç»™æ¨¡å‹æä¾›å°‘é‡ç¤ºä¾‹çš„æƒ…å†µä¸‹è®©å…¶å­¦ä¹ æ–°ä»»åŠ¡çš„æ–¹æ³•ã€‚Few-shot å¯ä»¥åˆ†ä¸ºé›¶æ ·æœ¬å­¦ä¹ ï¼ˆzero-shot learningï¼‰ã€ä¸€æ ·æœ¬å­¦ä¹ ï¼ˆone-shot learningï¼‰å’Œå°æ ·æœ¬å­¦ä¹ ï¼ˆfew-shot learningï¼‰ã€‚åŸç†ï¼šæ¨¡å‹åœ¨å¤§è§„æ¨¡è¯­æ–™ä¸Šè¿›è¡Œé¢„è®­ç»ƒï¼Œå­¦åˆ°äº†å¹¿æ³›çš„è¯­è¨€çŸ¥è¯†å’ŒåŸºæœ¬ä»»åŠ¡èƒ½åŠ›ã€‚åœ¨æ–°ä»»åŠ¡ä¸Šï¼Œé€šè¿‡æä¾›å°‘é‡çš„ç¤ºä¾‹ï¼ˆè¾“å…¥-è¾“å‡ºå¯¹ï¼‰ï¼Œæ¨¡å‹å¯ä»¥ä»ä¸­æ¨æ–­å‡ºè¯¥ä»»åŠ¡çš„æ¨¡å¼å’Œè¦æ±‚ã€‚ few-shot ä¹‹æ‰€ä»¥èµ·ä½œç”¨ï¼Œæ˜¯æŠŠé—®é¢˜ä¼ªè£…æˆäº†ä¸€ä¸ªæ–‡æ¡£ä¸­ç¼ºå¤±çš„å†…å®¹ï¼Œè®©base model é€šè¿‡å®Œæˆæ–‡æ¡£çš„èƒ½åŠ›æŠŠå®ƒè¡¥å…¨ã€‚ä½†æ˜¯è¿™ä¸€è¿‡ç¨‹éå¸¸ä¸ç¨³å®šï¼Œ åœ¨å®è·µä¸­æ€»ä½“æ•ˆæœä¸€èˆ¬ã€‚ 1.4.2 Supervised finetuningæŒ‡åœ¨base model çš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨å¸¦æœ‰æ ‡ç­¾çš„æ•°æ®é›†å¯¹æ¨¡å‹è¿›è¡Œè¿›ä¸€æ­¥è®­ç»ƒï¼Œä»¥æé«˜å…¶åœ¨ç‰¹å®šä»»åŠ¡ä¸Šçš„è¡¨ç°ã€‚ 1.4.3 few-shot vs Supervised finetuning Few-shot Learningï¼š ä¼˜ç‚¹ï¼šæ— éœ€å¤§é‡æ ‡æ³¨æ•°æ®ï¼Œé€‚åº”æ–°ä»»åŠ¡å¿«é€Ÿã€‚ ç¼ºç‚¹ï¼šåœ¨ä»»åŠ¡å¤æ‚æˆ–ç¤ºä¾‹è¾ƒå°‘æ—¶ï¼Œæ•ˆæœå¯èƒ½ä¸å¦‚ç›‘ç£å¾®è°ƒã€‚ ç›‘ç£å¾®è°ƒï¼š ä¼˜ç‚¹ï¼šåœ¨æœ‰è¶³å¤Ÿæ ‡æ³¨æ•°æ®æ—¶ï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡æ¨¡å‹æ€§èƒ½ã€‚ ç¼ºç‚¹ï¼šéœ€è¦å¤§é‡æ ‡æ³¨æ•°æ®ï¼Œæˆæœ¬è¾ƒé«˜ã€‚ 2. Supervised finetuning stage å¾®è°ƒæŒ‡åœ¨base model çš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨å¸¦æœ‰æ ‡ç­¾çš„æ•°æ®é›†å¯¹æ¨¡å‹è¿›è¡Œè¿›ä¸€æ­¥è®­ç»ƒï¼Œä»¥æé«˜å…¶åœ¨ç‰¹å®šä»»åŠ¡ä¸Šçš„è¡¨ç°ã€‚ 2.1 Datasetç›¸æ¯”pre-training é¢„è®­ç»ƒé˜¶æ®µï¼ŒSupervised finetuning ç›‘ç£å¾®è°ƒé˜¶æ®µä½¿ç”¨å°‘é‡ä½†é«˜è´¨é‡çš„æ•°æ®é›†ã€‚è¿™äº›æ•°æ®é›†åŒ…å«äº†æˆå¯¹çš„è¾“å…¥å’ŒæœŸæœ›è¾“å‡ºï¼Œä¾‹å¦‚é—®é¢˜ä¸ç­”æ¡ˆï¼ˆQ&amp;Aï¼‰ã€å‘½ä»¤ä¸å“åº”ã€æˆ–è€…å…¶ä»–ç›¸å…³ä»»åŠ¡çš„é…å¯¹ã€‚è¿™äº›æ•°æ®é€šå¸¸é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å¾—ï¼š äººå·¥æ ‡æ³¨ï¼šé›‡ä½£æ ‡æ³¨äººå‘˜æ ¹æ®é¢„è®¾çš„æŒ‡å¯¼æ–‡æ¡£ï¼ˆlabeling documentationï¼‰æ¥åˆ›å»ºæ•°æ®ã€‚æ ‡æ³¨äººå‘˜å¯èƒ½ä¼šæ ¹æ®ç»™å®šçš„æŒ‡ä»¤ç¼–å†™é—®é¢˜çš„ç­”æ¡ˆï¼Œæˆ–è€…è¯„ä¼°å’Œé€‰æ‹©æ¨¡å‹ç”Ÿæˆçš„å€™é€‰å›ç­”ã€‚ ä¼—åŒ…å¹³å°ï¼šä½¿ç”¨ä¼—åŒ…æœåŠ¡ï¼ˆå¦‚Amazon Mechanical Turkï¼‰æ¥æ”¶é›†å’Œæ ‡æ³¨æ•°æ®ã€‚è¿™ç§æ–¹å¼å¯ä»¥å¿«é€Ÿä¸”æˆæœ¬ç›¸å¯¹è¾ƒä½åœ°è·å¾—å¤§é‡æ ‡æ³¨æ•°æ® åˆä½œä¼™ä¼´ï¼šä¸å­¦æœ¯æœºæ„ã€ç ”ç©¶ç»„ç»‡æˆ–å…¶ä»–å…¬å¸åˆä½œï¼Œå…±äº«æˆ–å…±åŒåˆ›å»ºæ•°æ®é›†ã€‚ 2.2 SFT modelSFT model å·²ç»æ˜¯ä¸€ä¸ªå¯ä»¥å›ç­”é—®é¢˜çš„assistant 2.4 Pre-training vs fine tuning ä»¥ä¸‹æ˜¯é¢„è®­ç»ƒï¼ˆPre-trainingï¼‰å’Œå¾®è°ƒï¼ˆFine-tuningï¼‰ä¸¤ä¸ªé˜¶æ®µçš„å¯¹æ¯”è¡¨æ ¼ï¼Œä»ç›®æ ‡ã€æ•°æ®é›†ã€è¿‡ç¨‹ã€æˆæœ¬å’Œè¿­ä»£ä¸æ”¹è¿›äº”ä¸ªæ–¹é¢è¿›è¡Œæ€»ç»“ï¼š ç‰¹å¾ é¢„è®­ç»ƒï¼ˆPre-trainingï¼‰ å¾®è°ƒï¼ˆFine-tuningï¼‰ ç›®æ ‡ å­¦ä¹ å¹¿æ³›çš„è¯­è¨€çŸ¥è¯†å’Œäº’è”ç½‘ä¿¡æ¯ï¼Œä¸ä¸“æ³¨äºç‰¹å®šä»»åŠ¡ã€‚ è°ƒæ•´é¢„è®­ç»ƒæ¨¡å‹ä»¥é€‚åº”ç‰¹å®šä»»åŠ¡æˆ–åº”ç”¨åœºæ™¯ã€‚ æ•°æ®é›† æ¥è‡ªäº’è”ç½‘çš„å¤§è§„æ¨¡ã€å¤šæ ·åŒ–æ–‡æœ¬æ•°æ®ï¼Œå¯èƒ½åŒ…å«å¤šç§è¯­è¨€å’Œä¸»é¢˜ã€‚ è¾ƒå°ä½†é«˜è´¨é‡çš„ç‰¹å®šä»»åŠ¡ç›¸å…³æ•°æ®é›†ï¼Œå¦‚é—®ç­”å¯¹ã€æ ‡æ³¨æ–‡æœ¬ç­‰ã€‚ è¿‡ç¨‹ é€šè¿‡é¢„æµ‹æ–‡æœ¬åºåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªè¯è¿›è¡Œè®­ç»ƒï¼Œä½¿ç”¨å¤§è§„æ¨¡æ•°æ®é›†è¿›è¡Œå¹¿æ³›å­¦ä¹ ã€‚ åœ¨é¢„è®­ç»ƒæ¨¡å‹çš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨ç‰¹å®šä»»åŠ¡çš„æ•°æ®é›†è¿›è¡Œé¢å¤–è®­ç»ƒã€‚ æˆæœ¬ é«˜ï¼Œéœ€è¦å¤§é‡è®¡ç®—èµ„æºï¼ˆå¦‚GPUé›†ç¾¤ï¼‰å’Œæ—¶é—´ï¼Œæˆæœ¬å¯èƒ½é«˜è¾¾æ•°ç™¾ä¸‡è‡³æ•°åäº¿ç¾å…ƒã€‚ ç›¸å¯¹è¾ƒä½ï¼Œä¸»è¦æ¶‰åŠæ•°æ®æ ‡æ³¨å’Œæ¨¡å‹è°ƒæ•´ï¼Œè®¡ç®—èµ„æºéœ€æ±‚è¾ƒå°ã€‚ è¿­ä»£å’Œæ”¹è¿› é€šå¸¸åœ¨å¤§å‹å…¬å¸æˆ–ç ”ç©¶æœºæ„ä¸­è¿›è¡Œï¼Œå¯èƒ½æ¯å¹´æˆ–å‡ ä¸ªæœˆè¿›è¡Œä¸€æ¬¡ï¼Œå–å†³äºèµ„æºå’Œéœ€æ±‚ã€‚ å¯ä»¥é¢‘ç¹è¿›è¡Œï¼Œæ ¹æ®æ¨¡å‹è¡¨ç°å’Œç”¨æˆ·åé¦ˆä¸æ–­ä¼˜åŒ–æ¨¡å‹ã€‚ 3. RLHFReinforcement Learning from Human Feedbackæ ¹æ®äººç±»åé¦ˆè¿›è¡Œå¼ºåŒ–å­¦ä¹ è¿™ä¸ªé˜¶æ®µåŒ…å«ä¸¤ä¸ªæ­¥éª¤ï¼Œ Reward Modeling Reinforcement Learning3. 1 Reward Modeling 3.1.1 Dataset- comparisons ç›¸åŒçš„prompt, SFT model ä¼šç»™å‡ºä¸åŒç‰ˆæœ¬çš„å›ç­”ï¼Œå³å¤šä¸ªå€™é€‰ç­”æ¡ˆã€‚ç›®å‰æˆ‘ä»¬åœ¨ä½¿ç”¨ äººç±»è¯„ä¼°è€…ä¼šå¯¹è¿™äº›å€™é€‰å›ç­”è¿›è¡Œæ¯”è¾ƒæ‰“åˆ†æ’åï¼Œå¹¶é€‰æ‹©ä»–ä»¬è®¤ä¸ºæœ€åˆé€‚æˆ–æœ€å‡†ç¡®çš„å›ç­”ã€‚ æ¨¡å‹ä¼šæ ¹æ®è¿™äº›æ¯”è¾ƒç»“æœè¿›è¡Œå­¦ä¹ ï¼Œä»¥ä¾¿å¯¹å…¶ä»–é—®é¢˜çš„å¤šä¸ªå€™é€‰ç­”æ¡ˆçš„å¥½åè¿›è¡Œé¢„æµ‹ 3.1.2 RM Training ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œ æç¤ºè¯+ ç»“æœ+ äººç±»è¯„ä¼°è€…åé¦ˆä½œä¸ºå…³è”åœ¨ä¸€èµ·çš„æ•°æ®åˆè¢«æ‰“åŒ…åˆ°batchä¸­è¿›è¡Œè®­ç»ƒï¼Œ å¦‚å›¾ï¼Œå¯ä»¥ç†è§£æˆä¸€ä¸ªç›¸åŒçš„æç¤ºè¯prompt æœ‰3ä¸ªä¸åŒç‰ˆæœ¬çš„å›ç­”ï¼Œå¯¹åº”çš„3ä¸ªä¸åŒçš„reward(å¯ä»¥ç†è§£æˆæ˜¯åˆ†æ•°)ï¼Œ è®­ç»ƒåæ¨¡å‹å°±å¯ä»¥é’ˆå¯¹ä¸€ä¸ªprompt çš„å›ç­”é¢„æµ‹å‡ºä¸€ä¸ªäººç±»è¯„ä¼°è€…çš„æ‰“åˆ†ã€‚ æ‰€ä»¥è¿™ä¸ªé˜¶æ®µçš„ç›®çš„å°±æ˜¯æ„å»ºä¸€ä¸ªreward model å­¦ä¹ äººç±»æ‰“åˆ†çš„è§„å¾‹ï¼Œä»¥æ¥é¢„æµ‹ä¸€ä¸ªå›ç­”å¯èƒ½ä¼šè·å¾—çš„äººç±»è¯„åˆ†ã€‚ ç”±äºreward modelåªæ˜¯å­¦ä¹ äº†äººç±»æ‰“åˆ†çš„è§„å¾‹ï¼Œæ‰€ä»¥å¦‚æœå•ç‹¬ä½¿ç”¨Reward Model è¿›è¡Œæ‰“åˆ†å¹¶ä¸ä¼šä¿ƒè¿›æ¨¡å‹ç”Ÿæˆæ›´å¥½çš„ç­”æ¡ˆ ï¼Œ å®ƒéœ€è¦å’ŒReinforcement Learning å¼ºåŒ–å­¦ä¹ ç»“åˆä½¿ç”¨æ‰èƒ½èµ·ä½œç”¨ 3.2 Reinforcement Learningæœ‰äº†reward model åï¼Œå°±å¯ä»¥å¯¹æ¨¡å‹çš„å›ç­”è¿›è¡Œæ‰“åˆ†ã€‚å¯¹äºåˆ†æ•°é«˜çš„å›ç­”ï¼Œè¦æé«˜å…¶å‡ºç°çš„æ¦‚ç‡ï¼Œå¦‚æ­¤ä¸æ–­è¿­ä»£ï¼Œå°½å¯èƒ½ç”Ÿæˆè·å¾—æ›´é«˜åˆ†çš„å›ç­”ã€‚","tags":["AI","chatGPT"]},{"title":"Intro to chatGPT,ä»Gã€Pã€Tçš„å«ä¹‰è§£é‡ŠchatGPT","path":"/60dfe914/","content":"ChatGPTæ˜¯ç”±OpenAIå¼€å‘çš„ï¼Œä¸€ä¸ªèƒ½å¤Ÿç†è§£å’Œç”Ÿæˆè‡ªç„¶è¯­è¨€çš„äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰æ¨¡å‹ï¼Œå¯ä»¥å’Œç”¨æˆ·è¿›è¡Œäº’åŠ¨å¹¶ç”Ÿæˆç±»ä¼¼äººç±»çš„å¯¹è¯ã€‚ 1. chatGPT çš„å‘å±•å†ç¨‹ChatGPTæ¨¡å‹çš„å‘å±•å†ç¨‹æ˜¯ä¸€ä¸ªä¸æ–­æ¼”è¿›å’Œæ”¹è¿›çš„è¿‡ç¨‹ã€‚ä»¥ä¸‹æ˜¯å…³é”®çš„æ—¶é—´èŠ‚ç‚¹å’Œå‘å±•é˜¶æ®µï¼š GPT-1ï¼ˆ2018å¹´6æœˆï¼‰ï¼šOpenAIå‘å¸ƒäº†é¦–ä¸ªç”Ÿæˆé¢„è®­ç»ƒå˜æ¢å™¨æ¨¡å‹ï¼ˆGenerative Pre-trained Transformerï¼ŒGPT-1ï¼‰ã€‚è¯¥æ¨¡å‹åŸºäºTransformeræ¶æ„ï¼Œä½¿ç”¨æ— ç›‘ç£å­¦ä¹ æ–¹æ³•åœ¨å¤§è§„æ¨¡æ–‡æœ¬è¯­æ–™ä¸Šè¿›è¡Œé¢„è®­ç»ƒï¼Œç„¶ååœ¨ç‰¹å®šä»»åŠ¡ä¸Šè¿›è¡Œå¾®è°ƒï¼ˆFine-tuningï¼‰ã€‚ æ¶æ„ï¼š12å±‚Transformerè§£ç å™¨ï¼Œå‚æ•°é‡çº¦ä¸º1.17äº¿ã€‚ åˆ›æ–°ç‚¹ï¼šå¼•å…¥æ— ç›‘ç£é¢„è®­ç»ƒå’Œæœ‰ç›‘ç£å¾®è°ƒç›¸ç»“åˆçš„è®­ç»ƒæ–¹æ³•ï¼Œåœ¨å¤šä¸ªNLPä»»åŠ¡ä¸Šè¡¨ç°ä¼˜å¼‚ã€‚ GPT-2ï¼ˆ2019å¹´2æœˆï¼‰ï¼šOpenAIå‘å¸ƒäº†GPT-2ï¼Œæ¨¡å‹è§„æ¨¡å’Œèƒ½åŠ›å¤§å¹…æå‡ã€‚æœ€åˆç”±äºæ‹…å¿ƒæ¨¡å‹è¢«æ»¥ç”¨ï¼ŒOpenAIä»…å‘å¸ƒäº†éƒ¨åˆ†å‚æ•°çš„æ¨¡å‹ï¼Œåäº2019å¹´11æœˆå‘å¸ƒäº†å®Œæ•´æ¨¡å‹ã€‚ æ¶æ„ï¼šæœ€å¤§ç‰ˆæœ¬æœ‰48å±‚ï¼Œå‚æ•°é‡è¾¾15äº¿ã€‚ åˆ›æ–°ç‚¹ï¼šæ˜¾è‘—æé«˜äº†æ¨¡å‹çš„ç”Ÿæˆè´¨é‡å’Œè¿è´¯æ€§ï¼Œåœ¨æ–‡æœ¬ç”Ÿæˆã€ç¿»è¯‘ã€é—®ç­”ç­‰ä»»åŠ¡ä¸Šè¡¨ç°å‡ºè‰²ã€‚ GPT-3ï¼ˆ2020å¹´6æœˆï¼‰ï¼šæ˜¯å½“æ—¶æœ€å¤§å’Œæœ€å¼ºå¤§çš„è¯­è¨€æ¨¡å‹ï¼ŒåŒ…å«1750äº¿å‚æ•°ã€‚ æ¶æ„ï¼š1750äº¿å‚æ•°ï¼Œ96å±‚ï¼Œé‡‡ç”¨æ›´å¤§è§„æ¨¡çš„æ•°æ®è¿›è¡Œè®­ç»ƒã€‚ åˆ›æ–°ç‚¹ï¼šé€šè¿‡è¶…å¤§è§„æ¨¡é¢„è®­ç»ƒå’Œå°‘é‡ç¤ºä¾‹ï¼ˆFew-shot Learningï¼‰ï¼Œåœ¨æ— éœ€å¾®è°ƒçš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½åœ¨å¤šä¸ªä»»åŠ¡ä¸Šå–å¾—æƒŠäººçš„æ•ˆæœã€‚ GPT-3.5ï¼ˆ2021å¹´11æœˆï¼‰ï¼š æ˜¯GPT-3çš„æ”¹è¿›ç‰ˆæœ¬ï¼Œæ¨¡å‹å‚æ•°è¾¾åˆ°2000äº¿ï¼Œåˆ©ç”¨äººç±»åé¦ˆè¿›è¡Œå¼ºåŒ–å­¦ä¹ ï¼Œè¿›ä¸€æ­¥æå‡æ¨¡å‹çš„äº¤äº’èƒ½åŠ›ã€‚ å¢å¼ºäº†å¤„ç†å¤æ‚å¯¹è¯å’Œå¤šè½®å¯¹è¯çš„èƒ½åŠ›ã€‚ GPT-4ï¼ˆ2023å¹´2æœˆï¼‰ï¼š å°šæœªå…¬å¼€å…·ä½“å‚æ•°ï¼Œä½†æ¨æµ‹è¿œè¶…GPT-3.5ï¼Œæ”¯æŒå¤šæ¨¡æ€è¾“å…¥å’Œè¾“å‡º æä¾›äº†æ›´é«˜æ°´å¹³çš„è‡ªç„¶è¯­è¨€ç†è§£å’Œç”Ÿæˆèƒ½åŠ›ï¼Œæ”¯æŒå¤šæ¨¡æ€è¾“å…¥ä¸è¾“å‡º GPT-4o(2024å¹´5æœˆ) å·¥ç¨‹èƒ½åŠ›å¤§å¹…æå‡ï¼Œ ä½“ç°åœ¨ç›¸åº”é€Ÿåº¦æ›´å¿«ï¼Œä¸”å¼€å§‹èƒ½ç†è§£è¯­éŸ³è¯­è°ƒ ChatGPTæ¨¡å‹çš„å‘å±•ä¸ä»…ä»…æ˜¯å‚æ•°çš„å¢åŠ ï¼Œæ›´æ˜¯ç®—æ³•ä¼˜åŒ–ã€æ•°æ®å¤šæ ·åŒ–å’Œå¯¹ç”¨æˆ·åé¦ˆçš„æŒç»­æ”¹è¿›ã€‚ ç›®å‰æˆ‘ä»¬ä½¿ç”¨çš„chatGPT åGPT-3.5ã€GPT-4ã€GPT-4o ä¸‰ä¸ªç‰ˆæœ¬å¯é€‰ã€‚ 2. Gã€Pã€Tåˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€GPT æ˜¯ Generative Pre-trained Transformer çš„ç¼©å†™ã€‚ä»¥ä¸‹å†…å®¹å°†é‡ç‚¹ä»‹ç»Gã€Pã€T ä¸‰ä¸ªå­—æ¯å„è‡ªçš„å«ä¹‰ï¼Œä»¥æ­¤æ¥æ›´å¥½å¾—ç†è§£chatGPT æ˜¯ä»€ä¹ˆã€‚ 2.1 Generative ç”Ÿæˆå¼ChatGPTæ˜¯ä¸€ä¸ªGenerative AI, å³ç”Ÿæˆå¼AIã€‚ AI ä½œä¸ºä¸€ä¸ªæ€»ç§°ï¼Œå…¶å®åŒ…å«éå¸¸å¤šå…·ä½“çš„ç±»å‹ï¼Œ ChatGPT æ‰€å±çš„Generative AI æ˜¯å…¶ä¸­ä¸€ä¸ªå­ç±»ã€‚ æ—¥å¸¸ç”Ÿæ´»ä¸­ä¼šç”¨åˆ°çš„siriã€å°åº¦ã€å°çˆ±ã€è¯†åˆ«å›¾ç‰‡ä¸­åŠ¨ç‰©æ˜¯å°çŒ«ã€åŒ»é™¢çš„ä¸“å®¶è¯Šæ–­ç³»ç»Ÿã€å’Œä½ å›½é™…è±¡æ£‹å¯¹æˆ˜çš„æœºå™¨äººï¼Œè¿™äº›éƒ½æ˜¯AI ã€‚ ä½†æ˜¯è¿™äº›AI éƒ½æ˜¯è§„åˆ™é©±åŠ¨çš„ç³»ç»Ÿï¼Œåªèƒ½æ ¹æ®é¢„è®¾è§„åˆ™è¿›è¡Œå›ç­”ï¼Œä¸€æ—¦è¶…å‡ºé¢„è®¾èŒƒå›´ï¼Œå°±ä¼šè¡¨ç°çš„äººå·¥æ™ºéšœã€‚ chatGPTä½œä¸ºä¸€ä¸ªGenerative AI, å…¶æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯æ ¹æ®è¾“å…¥ç”Ÿæˆæ–°å†…å®¹ã€‚å®ƒä¸ä»…èƒ½å›ç­”é—®é¢˜ï¼Œè¿˜èƒ½è¿›è¡Œåˆ›æ„å†™ä½œã€æ•…äº‹ç”Ÿæˆã€è¯—æ­Œåˆ›ä½œç­‰å¤šç§ä»»åŠ¡ã€‚ Generative AI ä¹Ÿæœ‰è‡ªå·±å…·ä½“çš„åˆ†ç±» Natural language generationchatGPT å°±æ˜¯ NLG, å¯ä»¥è¯´æ˜¯ç›®å‰æœ€è‘—åçš„AI åº”ç”¨ text to imageæ ¹æ®æ–‡å­—ç”Ÿæˆå›¾ç‰‡ Midjourney DALL-E Stable Diffusion Generative Adversarial Networks (GANs)ç”Ÿæˆå¯¹æŠ—ç½‘ç»œï¼Œå…¶æ ¸å¿ƒæ˜¯ä¸¤ä¸ªç›¸äº’å¯¹æŠ—çš„ç½‘ç»œï¼šç”Ÿæˆå™¨ï¼ˆGeneratorï¼‰å’Œåˆ¤åˆ«å™¨ï¼ˆDiscriminatorï¼‰ã€‚è¿™ä¸¤ä¸ªç½‘ç»œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ç›¸äº’ç«äº‰ï¼Œä»è€Œä¸æ–­æå‡è‡ªèº«çš„æ€§èƒ½ã€‚ ç”Ÿæˆå™¨ï¼ˆGeneratorï¼‰ - è¿™ä¸ªç½‘ç»œçš„ä»»åŠ¡æ˜¯æ•æ‰è®­ç»ƒæ•°æ®çš„åˆ†å¸ƒï¼Œå¹¶ç”Ÿæˆå°½å¯èƒ½æ¥è¿‘çœŸå®æ•°æ®çš„æ–°æ•°æ®ã€‚ç”Ÿæˆå™¨æ¥å—ä¸€ä¸ªéšæœºå™ªå£°å‘é‡ä½œä¸ºè¾“å…¥ï¼Œé€šè¿‡è¿™ä¸ªå™ªå£°å‘é‡æ„é€ å‡ºæ–°çš„æ•°æ®å®ä¾‹ã€‚ åˆ¤åˆ«å™¨ï¼ˆDiscriminatorï¼‰ - åˆ¤åˆ«å™¨çš„ä»»åŠ¡æ˜¯åŒºåˆ†è¾“å…¥ç»™å®ƒçš„æ•°æ®æ˜¯æ¥è‡ªè®­ç»ƒé›†ï¼ˆå³çœŸå®æ•°æ®ï¼‰è¿˜æ˜¯ç”Ÿæˆå™¨ç”Ÿæˆçš„å‡æ•°æ®ã€‚åŸºæœ¬ä¸Šï¼Œåˆ¤åˆ«å™¨æ˜¯ä¸€ä¸ªäºŒåˆ†ç±»æ¨¡å‹ï¼Œè¾“å‡ºä¸€ä¸ªæ ‡é‡è¡¨ç¤ºè¾“å…¥æ•°æ®æ˜¯çœŸå®æ•°æ®çš„æ¦‚ç‡ã€‚è¿™ä¸¤ä¸ªæ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è¿›è¡Œå¯¹æŠ—ã€‚ç”Ÿæˆå™¨è¯•å›¾äº§ç”Ÿè¶Šæ¥è¶ŠçœŸå®çš„æ•°æ®ä»¥â€œæ¬ºéª—â€åˆ¤åˆ«å™¨ï¼Œè€Œåˆ¤åˆ«å™¨åˆ™è¯•å›¾å˜å¾—æ›´å¥½åœ°åŒºåˆ†çœŸå‡æ•°æ®ã€‚é€šè¿‡è¿™ç§å¯¹æŠ—è¿‡ç¨‹ï¼Œç”Ÿæˆå™¨å­¦ä¼šç”Ÿæˆé«˜è´¨é‡çš„æ•°æ®ã€‚ VAEså¯ç”¨äºå¼‚å¸¸æ£€æµ‹ï¼Œæ–¹æ³•æ˜¯åœ¨æ­£å¸¸æ•°æ®çš„æ•°æ®é›†ä¸Šè®­ç»ƒæ¨¡å‹ï¼Œç„¶åä½¿ç”¨ç»è¿‡è®­ç»ƒçš„æ¨¡å‹æ¥è¯†åˆ«åç¦»æ­£å¸¸æ•°æ®çš„å®ä¾‹ã€‚è¿™å¯ç”¨äºæ£€æµ‹å„ç§æƒ…å†µä¸‹çš„å¼‚å¸¸æƒ…å†µï¼Œä¾‹å¦‚å‘ç°é‡‘èäº¤æ˜“ä¸­çš„æ¬ºè¯ˆè¡Œä¸ºã€å‘ç°åˆ¶é€ ä¸­çš„ç¼ºé™·æˆ–å‘ç°ç½‘ç»œä¸­çš„å®‰å…¨æ¼æ´ã€‚ä¾‹å¦‚ï¼ŒUber åœ¨å…¶é‡‘èäº¤æ˜“ä¸­ä½¿ç”¨ VAE è¿›è¡Œå¼‚å¸¸æ£€æµ‹ï¼Œä»¥æ£€æµ‹æ¬ºè¯ˆè¡Œä¸ºã€‚ 2.2 Pre-trained é¢„è®­ç»ƒé¢„è®­ç»ƒ æ˜¯chatGPTè®­ç»ƒ çš„ç¬¬ä¸€ä¸ªé˜¶æ®µã€‚ chatGPT çš„ è®­ç»ƒå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µ pre-training supervised fine-tuning reward modeling reinforcement learning å…¶ä¸­pre-trainingæ˜¯ç¬¬ä¸€ä¸ªé˜¶æ®µ, åœ¨é¢„è®­ç»ƒé˜¶æ®µä½¿ç”¨çš„æ•°æ®é›†é€šå¸¸æ˜¯ä»äº’è”ç½‘ä¸Šæ”¶é›†çš„å¤§é‡æ–‡æœ¬ï¼Œè¿™äº›æ–‡æœ¬å¯èƒ½åŒ…å«å¤šç§è¯­è¨€ã€ä¸»é¢˜å’Œæ ¼å¼ã€‚ é¢„è®­ç»ƒçš„ç›®æ ‡æ˜¯è®©æ¨¡å‹åœ¨å¤§é‡çš„æ–‡æœ¬æ•°æ®ä¸Šè¿›è¡Œäº†å¹¿æ³›çš„è®­ç»ƒå­¦ä¹ äº†è¯­è¨€çš„ç»“æ„ã€è¯­æ³•ä»¥åŠå¤§é‡çš„çŸ¥è¯†ã€‚å­¦ä¹ ç»“æŸåï¼Œ é¢„è®­ç»ƒ é˜¶æ®µä¼šäº§å‡ºä¸€ä¸ªbase model, base model å¯ä»¥æ ¹æ® ç”¨æˆ·çš„è¾“å…¥ï¼Œ å»ç»­å†™æ–‡æœ¬ï¼Œ æ³¨æ„ï¼Œ è¿™ä¸ªé˜¶æ®µçš„chatGPT è¿˜ä¸èƒ½å›ç­”ä½ çš„é—®é¢˜ã€‚ é’ˆå¯¹ä»¥ä¸‹é—®é¢˜è¾“å…¥ï¼Œï¼Œæ¯”å¦‚ï¼Œ å®ƒåªèƒ½ç»™å‡ºè¿™æ ·çš„å›ç­”ã€‚what is the capital of China? base model å¹¶ä¸ä¼šå›ç­”é—®é¢˜ï¼Œç»™å‡ºâ€œbeijingâ€, è€Œæ˜¯ä¼šç»­å†™å†…å®¹ï¼Œ ç»™å‡ºä»¥ä¸‹å¯èƒ½çš„ç­”æ¡ˆ what is Chinaâ€™s largest city?what is Chinaâ€™s population?what is the currency of China? å¦‚æœæƒ³è®©æ¨¡å‹â€œç†è§£â€äººç±»çš„é—®é¢˜å¹¶è¿›è¡Œå›ç­”ï¼Œ è¿˜éœ€è¦è¿›è¡Œç¬¬äºŒé˜¶æ®µçš„è®­ç»ƒ supervised fine-tuningã€‚ 2.3 TransformerChatGPTçš„æ ¸å¿ƒæŠ€æœ¯æ˜¯Transformeræ¶æ„ï¼Œè¿™æ˜¯ä¸€ç§æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œæ“…é•¿å¤„ç†åºåˆ—æ•°æ®ã€‚Transformeré€šè¿‡è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆself-attention mechanismï¼‰æ¥æ•æ‰è¾“å…¥æ–‡æœ¬ä¸­çš„é‡è¦ç‰¹å¾å’Œä¸Šä¸‹æ–‡å…³ç³»ã€‚è¿™ç§æ¶æ„ä½¿å¾—æ¨¡å‹åœ¨å¤„ç†é•¿æ–‡æœ¬å’Œå¤æ‚ä¸Šä¸‹æ–‡æ—¶ï¼Œèƒ½å¤Ÿä¿æŒè¾ƒé«˜çš„å‡†ç¡®æ€§å’Œè¿è´¯æ€§ã€‚ è¦ç†è§£Transformeråœ¨ChatGPTä¸­çš„åº”ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„ç±»æ¯”æ¥è¯´æ˜ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œä½ åœ¨è¯»ä¸€æœ¬ä¹¦ï¼Œå¹¶è¯•å›¾ç†è§£æ¯ä¸€æ®µçš„æ„æ€ã€‚ä½ çš„å¤§è„‘ä¸ä»…ä»…æ˜¯é€å­—é€å¥åœ°é˜…è¯»ï¼Œè¿˜ä¼šç»“åˆå‰åçš„å†…å®¹ï¼Œç†è§£æ•´æ®µçš„æ„ä¹‰ã€‚Transformeråœ¨ChatGPTä¸­çš„ä½œç”¨å°±åƒä½ å¤§è„‘çš„è¿™ç§ç†è§£æœºåˆ¶ã€‚ 3. chatGPT ä½¿ç”¨åœºæ™¯å‘æŒ¥ä½ çš„æƒ³è±¡ï¼Œèƒ½ç”¨çš„å…·ä½“åœºæ™¯æ˜¯åœ¨å¤ªå¤šäº†ã€‚åé¢è¿™é‡Œä¼šé™†ç»­è¡¥å……æˆ‘ä½¿ç”¨çš„åœºæ™¯","tags":["AI","chatGPT"]},{"title":"GPTså¼€å‘-Best English Nameï¼Œä½ æ‰¾åˆ°æœ€åˆé€‚ã€æœ€æ»¡æ„çš„è‹±æ–‡å","path":"/209fa7d3/","content":"æœ€è¿‘å¼€å‘äº†ä¸€ä¸ªç”¨æ¥å–è‹±æ–‡åçš„GPTs Best English Nameã€‚ä½œä¸ºGPTs å¼€å‘è€…ï¼Œè™½ç„¶ç¦»openai ç»™æˆ‘å‘é’±è¿˜è¿œç€å‘¢ï¼Œä½†æ˜¯æ²¡å…³ç³»ï¼Œæˆ‘å¯ä»¥è‡ªå·±å…ˆç”¨GPTs å˜ç°ï¼Œè™½ç„¶å˜ç°çš„é’±è¿˜åªå¤Ÿcover ä¸€ä¸ªæœˆplus çš„è´¹ç”¨ã€‚ Best English Name æ˜¯ä»€ä¹ˆ Best English Name æ˜¯ä¸€ä¸ªèµ·ååŠ©æ‰‹ï¼Œå®ƒå¯ä»¥å¸®åŠ©ä½ æ‰¾åˆ°æ°”è´¨ç›¸ç¬¦ä¸”æ»¡è¶³å„ç§è¦æ±‚çš„è‹±æ–‡åï¼Œå¹¶ä¸”ä¼šå¯¹è‹±æ–‡åæœ‰è¯¦ç»†ä¸”æ·±å…¥çš„è§£é‡Šï¼Œè®©ä½ å……åˆ†äº†è§£è‡ªå·±çš„è‹±æ–‡åã€‚è¿™ä¸ªæ°”è´¨å¯ä»¥æ˜¯ä½ é€šè¿‡å›¾ç‰‡ä¸Šä¼ å‘Šè¯‰chatGPT, ä¹Ÿå¯ä»¥è‡ªå·±æè¿°ç»™chatGPT,åŒæ—¶ä½ ä¹Ÿå¯ä»¥æœ‰å…¶ä»–å®šåˆ¶åŒ–è¦æ±‚ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº å’Œä¸­æ–‡è¯»éŸ³/æ‹¼å†™ç±»ä¼¼ ç‰¹å®šé•¿åº¦ ç‰¹å®šå¼€å¤´å­—æ¯ å¥³æ€§åŒ–/ä¸­æ€§åŒ–/ç”·æ€§åŒ– MBTI æˆ‘ä¸ºä»€ä¹ˆè¦å¼€å‘Best English Nameæˆ‘çš„ç—›ç‚¹æœ¬äººåœ¨å·¥ä½œã€ç”Ÿæ´»ä¸­å‡æœ‰éœ€è¦ç”¨åˆ°è‹±æ–‡åçš„åœºæ™¯ï¼Œ è®°å¾—ç¬¬ä¸€æ¬¡éœ€è¦å–è‹±æ–‡åæ˜¯å…¥èŒæ–°å…¬å¸ï¼Œæˆ‘èŠ±äº†ä¸€ä¸‹åˆçš„æ—¶é—´åœ¨è±†ç“£ä¸Šç¿»æ‰¾æ›¾ç»çœ‹è¿‡çš„è‹±æ–‡å½±è§†å‰§ï¼Œè¯•å›¾æ‰¾åˆ°ä¸€ä¸ªå–œæ¬¢çš„è‹±æ–‡åï¼Œ ä½†æœ€åé€‰å®šçš„åå­—æ€»è®©æˆ‘è§‰å¾—â€œè¿™ä¸æ˜¯æˆ‘â€ã€‚ æˆ‘è‡ªå·±åœ¨ç¡®å®šè‹±æ–‡åçš„è¿‡ç¨‹ä¸­ï¼Œæœ‰è¿™æ ·çš„æ‹…å¿§ è¿™ä¸ªåå­—å¬èµ·æ¥éå¸¸â€œä¸åƒæˆ‘â€ è¿™ä¸ªåå­—é€‚åˆå¥³ç”Ÿå— è¿™ä¸ªåå­—åœ¨è‹±è¯­å›½å®¶å¥‡æ€ªå—ï¼Œä¼šä¸ä¼šæ ¹æœ¬å°±æ²¡äººèµ·è¿™ä¸ªåå­— è¿™ä¸ªåå­—ä¼šä¸ä¼šå¤ªå¤§ä¼—åŒ–äº†ï¼Œä¼šä¸ä¼šæœ‰ç‚¹è¿‡æ—¶äº† è¿™ä¸ªåå­—ä¼šä¸ä¼šæœ‰ä»€ä¹ˆä¸å¥½çš„å¯“æ„ï¼Œåˆ°æ—¶å€™å¼•èµ·ä¸å¿…è¦çš„è¯¯ä¼š åŒæ—¶æˆ‘å¯¹é‚£ä¸ªæˆ‘å°†è¦å–œæ¬¢ä¸”é€‚åˆçš„è‹±æ–‡åä¹Ÿæœ‰ä¸€å®šçš„è¦æ±‚ æˆ‘å¸Œæœ›è¿™ä¸ªè‹±æ–‡åä¸­æ€§åŒ–ä¸€ç‚¹ æˆ‘å¸Œæœ›æˆ‘çš„åå­—ä»¥A å¼€å¤´ æˆ‘å¸Œæœ›è¿™ä¸ªåå­—æœ‰ç¾å¥½çš„å¯“æ„ä¸”æˆ‘èƒ½å¤Ÿäº†è§£è¿™ä¸ªç¾å¥½çš„å¯“æ„ï¼Œè¿™æ ·å½“åˆ«äººé—®æˆ‘ä¸ºä»€ä¹ˆå–è¿™ä¸ªåå­—çš„æ—¶å€™ï¼Œæˆ‘å°±å¯ä»¥æ¸…æ¥šåœ°å‘ta ä»‹ç»æˆ‘çš„åå­— å¼€å§‹ä½¿ç”¨chatGPT åï¼Œ æˆ‘å‘ç°å®ƒå¯ä»¥å¾ˆå¥½çš„æä¾›ä¸€äº›æ»¡è¶³æˆ‘è¦æ±‚çš„è‹±æ–‡åï¼ŒåŒæ—¶è§„é¿æ‰æˆ‘çš„æ‹…å¿§ã€‚ ç—›ç‚¹çš„å¤§ä¼—åŒ–åœ¨å°çº¢ä¹¦é—²é€›æ—¶ï¼Œæˆ‘å‘ç°æœ‰å¾ˆå¤šäººéƒ½åœ¨ä¸ºé€‰æ‹©ä¸€ä¸ªè‹±æ–‡åå›°æ‰°ï¼Œ ta ä»¬é€šå¸¸ä¼šå‘å‡ºä¸€å¼ ç…§ç‰‡è®©ç½‘å‹æ ¹æ®ç¬¬ä¸€çœ¼å°è±¡å¸®å¿™èµ·åï¼Œæœ‰æ—¶å€™ä¼šæœ‰ä¸€äº›é¢å¤–çš„éœ€æ±‚ã€‚ åŒæ—¶æˆ‘è¿˜å‘ç°æœ‰å¾ˆå¤šäººç»å¸¸å‘ç½‘å‹è¯¢é—®è‡ªå·±çš„è‹±æ–‡åæ˜¯ä»€ä¹ˆæ„æ€ã€‚ æˆ‘è®¤ä¸ºè¿™ä¸¤ç§æƒ…å†µå’Œæˆ‘èµ·åå­—æ—¶é‡åˆ°çš„é—®é¢˜æ˜¯ä¸€æ ·çš„ï¼ŒchatGPT èƒ½å¸®åŠ©æˆ‘æ‰¾åˆ°æ»¡æ„çš„è‹±æ–‡åï¼Œé‚£ä¹ˆå®ƒä¹Ÿå¯ä»¥å¸®åŠ©å…¶ä»–äººæ‰¾åˆ°æ»¡æ„çš„è‹±æ–‡åï¼Œ æ‰€ä»¥æˆ‘æŠŠè‡ªå·±å–è‹±æ–‡çš„è¿‡ç¨‹åšæˆäº†ä¸€ä¸ªå¯å¤ç”¨çš„GPTs, å¸Œæœ›å¯ä»¥å¸®åŠ©æ›´å¤šäººæ‰¾åˆ°æ»¡æ„é€‚åˆçš„è‹±æ–‡å GPTs çš„å·¥ç¨‹å¼€å‘ä¸€ä¸ªä¸æ‡’çš„GPTså›ç­”è¯¦ç»†æ·±å…¥ã€‚ ä¸€ä¸ªæŠ—æ”»å‡»çš„GPTsä¸ä¼šæ³„æ¼è¯¥GPTs çš„instruction","tags":["AI","chatGPT"]},{"title":"Intro to AI","path":"/81fcff81/","content":"åœ¨å­¦ä¹ AI è¿‡ç¨‹ä¸­ï¼Œå‘ç°ä¸“ä¸šåè¯ç›¸å½“å¤šï¼Œåˆå­¦è€…å¯èƒ½ä¼šæ„Ÿåˆ°è€Œæ··ä¹±ï¼Œæ‰€ä»¥æœ¬ç¯‡å†…å®¹æ˜¯å¯¹è¯¥é¢†åŸŸå†…çš„ä¸€äº›â€œå¤§è¯â€è¿›è¡Œç®€å•ä»‹ç»ï¼Œ åšä¸€äº›æ¦‚å¿µæ‰«ç›²ï¼Œ ä»¥ä¿è¯åœ¨æ¥ä¸‹æ¥çš„å­¦ä¹ ä¸­å¿ƒä¸­æœ‰æ¡†æ¶ã€‚ æ­£å¼å†…å®¹ä¼šæŒ‰ç…§ä¸‹å›¾æ¡†æ¶ä»‹ç» 1. äººå·¥æ™ºèƒ½ (Artificial Intelligence)äººå·¥æ™ºèƒ½ï¼ˆArtificial Intelligenceï¼Œç®€ç§°AIï¼‰æ˜¯ä¸€é—¨ç ”ç©¶å’Œå¼€å‘ç”¨äºæ¨¡æ‹Ÿã€æ‰©å±•å’Œæ‰©å±•äººç±»æ™ºèƒ½çš„ç†è®ºã€æ–¹æ³•ã€æŠ€æœ¯åŠåº”ç”¨ç³»ç»Ÿçš„ç§‘å­¦æŠ€æœ¯ã€‚ ç®€å•æ¥è¯´ï¼ŒAIæŒ‡çš„æ˜¯ä½¿è®¡ç®—æœºç³»ç»Ÿèƒ½å¤Ÿæ‰§è¡Œé€šå¸¸éœ€è¦äººç±»æ™ºèƒ½æ‰èƒ½å®Œæˆçš„ä»»åŠ¡ã€‚è¿™äº›ä»»åŠ¡åŒ…æ‹¬å­¦ä¹ ã€æ¨ç†ã€è§£å†³é—®é¢˜ã€æ„ŸçŸ¥ã€è¯­è¨€ç†è§£å’Œç”Ÿæˆç­‰ã€‚ äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰çš„å‘å±•å†å²å¯ä»¥è¿½æº¯åˆ°20ä¸–çºªä¸­æœŸï¼Œå®ƒçš„å‘å±•ç»å†äº†å¤šä¸ªé‡è¦é˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µéƒ½æœ‰å…¶ç‹¬ç‰¹çš„ç‰¹ç‚¹å’Œé‡Œç¨‹ç¢‘äº‹ä»¶ã€‚ä¸‹é¢æ¥ç®€å•ä»‹ç»å…¶å‘å±•å†ç¨‹ 1.1 æ—©æœŸé˜¶æ®µï¼šåŸºç¡€ç†è®ºå’Œåˆæ­¥æ¢ç´¢ï¼ˆ1950s-1960sï¼‰1956å¹´è¾¾ç‰¹èŒ…æ–¯ä¼šè®®ï¼šAIæ­£å¼è¯ç”Ÿã€‚1956 å¹´ï¼ŒJohn McCarthyã€Marvin Minskyã€Allen Newell å’Œ Herbert A. Simon ç­‰ç ”ç©¶è€…åœ¨è¾¾ç‰¹èŒ…æ–¯ä¼šè®®ä¸Šé¦–æ¬¡æå‡ºäº†â€œäººå·¥æ™ºèƒ½â€è¿™ä¸€æœ¯è¯­ï¼Œæ ‡å¿—ç€AIç ”ç©¶æ­£å¼æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„å­¦ç§‘ã€‚ 1950å¹´ä»£æœ«ï¼šè‰¾ä¼¦Â·å›¾çµæå‡ºäº†â€œå›¾çµæµ‹è¯•â€ï¼Œæˆä¸ºåˆ¤æ–­æœºå™¨æ˜¯å¦å…·å¤‡æ™ºèƒ½çš„åŸºå‡†ã€‚ è¿™ä¸€æ—¶æœŸï¼Œç”±äºæŠ€æœ¯å’Œç¡¬ä»¶çš„é™åˆ¶ï¼Œæ—©æœŸçš„AIç³»ç»Ÿä¸»è¦å…³æ³¨äºç®€å•ä»»åŠ¡çš„è‡ªåŠ¨åŒ–ï¼Œå¦‚è±¡æ£‹å’Œè·³æ£‹æ¸¸æˆã€‚ä¾‹å¦‚ï¼ŒIBM çš„ Deep Blue å’Œ MIT AI Lab çš„ MacHack VI ç­‰ç³»ç»Ÿåœ¨è±¡æ£‹æ¸¸æˆä¸­å–å¾—äº†æ˜¾è‘—çš„æˆå°±ã€‚è¿™äº›ç³»ç»Ÿè™½ç„¶åœ¨å¤„ç†å¤æ‚æ¨¡å¼æ–¹é¢å—é™ï¼Œä½†å®ƒä»¬çš„æˆåŠŸå±•ç¤ºäº†AIåœ¨è§„åˆ™æ¸…æ™°ã€é™å®šç¯å¢ƒä¸­çš„æ½œåŠ›ã€‚ 1.2 ä¸“å®¶ç³»ç»Ÿä¸æœºå™¨å­¦ä¹ ï¼ˆ1970s-1990sï¼‰1970å¹´ä»£ï¼šä¸“å®¶ç³»ç»Ÿï¼ˆExpert Systemsï¼‰å¼€å§‹å…´èµ·ï¼Œå¦‚MYCINç”¨äºåŒ»ç–—è¯Šæ–­ï¼ŒDENDRALç”¨äºåŒ–å­¦åˆ†æã€‚è¿™äº›ç³»ç»Ÿèƒ½å¤Ÿå‚¨å­˜ã€è§£é‡Šå’Œæ¨ç†çŸ¥è¯†,å¯ä»¥ç”¨æ¥è§£å†³ç‰¹å®šé¢†åŸŸçš„é—®é¢˜ã€‚ 1980sï¼šåå‘ä¼ æ’­ç®—æ³•ï¼ˆBackpropagationï¼‰çš„æå‡ºä½¿ç¥ç»ç½‘ç»œé‡æ–°å—åˆ°å…³æ³¨ã€‚å°½ç®¡è®¡ç®—èƒ½åŠ›ä»æœ‰é™ï¼Œä½†ç†è®ºå’Œæ–¹æ³•ä¸Šçš„çªç ´ä¸ºæœªæ¥çš„å‘å±•å¥ å®šäº†åŸºç¡€ã€‚ 1990s: éšç€æ›´å¤šçš„æ•°æ®å¯ç”¨å’Œè®¡ç®—èƒ½åŠ›çš„å¢åŠ ï¼Œæœºå™¨å­¦ä¹ æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯åŸºäºç»Ÿè®¡çš„æ–¹æ³•å¼€å§‹ä¸»å¯¼AIç ”ç©¶ã€‚æ”¯æŒå‘é‡æœºå’Œéšæœºæ£®æ—ç­‰æŠ€æœ¯çš„å‘å±•ï¼Œä¸ºAIåœ¨å›¾åƒè¯†åˆ«ã€è‡ªç„¶è¯­è¨€å¤„ç†å’Œå…¶ä»–å¤æ‚æ¨¡å¼è¯†åˆ«ä»»åŠ¡ä¸­çš„åº”ç”¨æ‰“å¼€äº†æ–°çš„å¯èƒ½æ€§ã€‚ 1.3 ç°ä»£AIï¼šå¤§æ•°æ®ä¸æ·±åº¦å­¦ä¹ æ—¶ä»£ï¼ˆ2000s-è‡³ä»Šï¼‰ è®¡ç®—èƒ½åŠ›å’Œæ•°æ®çš„æå‡ï¼š 2000sï¼šäº’è”ç½‘å’Œå¤§æ•°æ®çš„å‘å±•ï¼Œä¸ºAIæä¾›äº†å¤§é‡è®­ç»ƒæ•°æ®ã€‚è®¡ç®—èƒ½åŠ›çš„æå‡ï¼Œç‰¹åˆ«æ˜¯GPUçš„ä½¿ç”¨ï¼Œä½¿å¾—å¤æ‚çš„æ¨¡å‹è®­ç»ƒæˆä¸ºå¯èƒ½ã€‚ æ·±åº¦å­¦ä¹ çš„å´›èµ·ï¼š 2010sï¼šæ·±åº¦å­¦ä¹ ï¼ˆDeep Learningï¼‰åœ¨å›¾åƒè¯†åˆ«ã€è¯­éŸ³è¯†åˆ«ã€è‡ªç„¶è¯­è¨€å¤„ç†ç­‰é¢†åŸŸå–å¾—çªç ´ã€‚AlexNetåœ¨2012å¹´ImageNetç«èµ›ä¸­çš„æˆåŠŸï¼Œæ ‡å¿—ç€æ·±åº¦å­¦ä¹ çš„é‡å¤§èƒœåˆ©ã€‚ å¹¿æ³›åº”ç”¨ï¼š 2010s-è‡³ä»Šï¼šAIåœ¨è‡ªåŠ¨é©¾é©¶ã€åŒ»ç–—è¯Šæ–­ã€é‡‘èåˆ†æã€æ™ºèƒ½å®¢æœç­‰é¢†åŸŸå¾—åˆ°å¹¿æ³›åº”ç”¨ã€‚2016å¹´ï¼ŒAlphaGoå‡»è´¥å›´æ£‹å† å†›æä¸–çŸ³ï¼Œå±•ç¤ºäº†AIåœ¨å¤æ‚åšå¼ˆä¸­çš„å¼ºå¤§èƒ½åŠ›ã€‚ è‡ªç„¶è¯­è¨€å¤„ç†ï¼šGPT-3ç­‰å¤§å‹è¯­è¨€æ¨¡å‹çš„æ¨å‡ºï¼Œä½¿å¾—AIèƒ½å¤Ÿç”Ÿæˆé€¼çœŸçš„è‡ªç„¶è¯­è¨€æ–‡æœ¬ï¼Œåº”ç”¨äºç¿»è¯‘ã€å¯¹è¯ç³»ç»Ÿã€å†…å®¹åˆ›ä½œç­‰å¤šä¸ªé¢†åŸŸã€‚ 2. æœºå™¨å­¦ä¹  ä¸ æ·±åº¦å­¦ä¹ æœºå™¨å­¦ä¹ ï¼ˆMachine Learningï¼‰å’Œæ·±åº¦å­¦ä¹ ï¼ˆDeep Learningï¼‰æ˜¯ç°ä»£äººå·¥æ™ºèƒ½ï¼ˆArtificial Intelligenceï¼‰é¢†åŸŸçš„æ ¸å¿ƒæŠ€æœ¯ã€‚å®ƒä»¬çš„å‘å±•æå¤§åœ°æ¨åŠ¨äº†ä»å›¾åƒè¯†åˆ«åˆ°è‡ªç„¶è¯­è¨€å¤„ç†çš„å„ç§åº”ç”¨ã€‚ 2.1 æœºå™¨å­¦ä¹ ï¼ˆMachine Learningï¼‰æœºå™¨å­¦ä¹ æ˜¯ä¸€ç§ä½¿è®¡ç®—æœºèƒ½å¤Ÿé€šè¿‡ç»éªŒè‡ªåŠ¨æ”¹è¿›çš„æŠ€æœ¯ã€‚å®ƒä¾èµ–äºç®—æ³•å’Œç»Ÿè®¡æ¨¡å‹ï¼Œä½¿å¾—è®¡ç®—æœºç³»ç»Ÿå¯ä»¥è¯†åˆ«æ•°æ®ä¸­çš„æ¨¡å¼å¹¶åšå‡ºå†³ç­–ï¼Œæ— éœ€æ˜ç¡®ç¼–ç¨‹ã€‚ ä¸»è¦ç±»åˆ«ï¼š ç›‘ç£å­¦ä¹ ï¼ˆSupervised Learningï¼‰ï¼šæ¨¡å‹åœ¨å¸¦æœ‰æ ‡ç­¾çš„æ•°æ®é›†ä¸Šè¿›è¡Œè®­ç»ƒï¼Œå­¦ä¹ è¾“å…¥ä¸è¾“å‡ºä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚åº”ç”¨åŒ…æ‹¬åˆ†ç±»ï¼ˆClassificationï¼‰å’Œå›å½’ï¼ˆRegressionï¼‰ã€‚ æ— ç›‘ç£å­¦ä¹ ï¼ˆUnsupervised Learningï¼‰ï¼šæ¨¡å‹åœ¨æ²¡æœ‰æ ‡ç­¾çš„æ•°æ®é›†ä¸Šå·¥ä½œï¼Œç›®æ ‡æ˜¯å‘ç°æ•°æ®çš„å†…åœ¨ç»“æ„ã€‚å¸¸è§çš„ä»»åŠ¡æœ‰èšç±»ï¼ˆClusteringï¼‰å’Œé™ç»´ï¼ˆDimensionality Reductionï¼‰ã€‚ åŠç›‘ç£å­¦ä¹ ï¼ˆSemi-supervised Learningï¼‰ï¼šä½¿ç”¨éƒ¨åˆ†æ ‡è®°çš„æ•°æ®è¿›è¡Œè®­ç»ƒï¼Œç»“åˆç›‘ç£å­¦ä¹ å’Œæ— ç›‘ç£å­¦ä¹ çš„ç‰¹ç‚¹ã€‚ å¼ºåŒ–å­¦ä¹ ï¼ˆReinforcement Learningï¼‰ï¼šæ¨¡å‹é€šè¿‡ä¸ç¯å¢ƒçš„äº¤äº’å­¦ä¹ ç­–ç•¥ï¼Œç›®æ ‡æ˜¯æœ€å¤§åŒ–æŸç§æ•°å€¼å¥–åŠ±ï¼ˆRewardï¼‰ã€‚ 2.2 æ·±åº¦å­¦ä¹ ï¼ˆDeep Learningï¼‰æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ ä¸­çš„ä¸€ä¸ªå­é›†ï¼Œå®ƒä½¿ç”¨ç§°ä¸ºäººå·¥ç¥ç»ç½‘ç»œï¼ˆArtificial Neural Networksï¼‰çš„æ¨¡å‹ï¼Œç‰¹åˆ«æ˜¯å…·æœ‰å¤šä¸ªå±‚ï¼ˆLayersï¼‰çš„æ·±å±‚ç½‘ç»œï¼Œä»¥å­¦ä¹ æ•°æ®çš„é«˜çº§æŠ½è±¡ç‰¹å¾ã€‚ æ ¸å¿ƒæ¦‚å¿µï¼š ç¥ç»ç½‘ç»œï¼ˆNeural Networksï¼‰ï¼šä¸€ä¸ªç”±èŠ‚ç‚¹ï¼ˆæˆ–ç§°ä¸ºç¥ç»å…ƒï¼ŒNeuronsï¼‰ç»„æˆçš„ç½‘ç»œï¼ŒèŠ‚ç‚¹åœ¨å±‚ä¸­ç»„ç»‡å¹¶é€šè¿‡æ¿€æ´»å‡½æ•°ï¼ˆActivation Functionsï¼‰å¤„ç†ä¿¡æ¯ã€‚ å·ç§¯ç¥ç»ç½‘ç»œï¼ˆConvolutional Neural Networks, CNNsï¼‰ï¼šç‰¹åˆ«é€‚åˆå¤„ç†å›¾åƒæ•°æ®ã€‚ å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Networks, RNNsï¼‰ï¼šä¼˜ç§€çš„å¤„ç†åºåˆ—æ•°æ®å¦‚æ—¶é—´åºåˆ—æˆ–è‡ªç„¶è¯­è¨€çš„å·¥å…·ã€‚ é•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼ˆLong Short-Term Memory, LSTMï¼‰å’Œé—¨æ§å¾ªç¯å•å…ƒï¼ˆGated Recurrent Units, GRUï¼‰ï¼šæ˜¯RNNçš„å˜ä½“ï¼Œè§£å†³äº†ä¼ ç»ŸRNNé•¿æœŸä¾èµ–é—®é¢˜ã€‚ Transformerï¼šä¸€ç§åŸºäºè‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-attention Mechanismï¼‰çš„æ¶æ„ï¼Œå¹¿æ³›ç”¨äºè‡ªç„¶è¯­è¨€å¤„ç†é¢†åŸŸã€‚ 2.3 åŒºåˆ«ä¸è”ç³»è”ç³»ï¼š æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œåˆ©ç”¨å¤æ‚çš„ç¥ç»ç½‘ç»œç»“æ„æ¥è§£å†³å¹¿æ³›çš„é—®é¢˜ã€‚ ä¸¤è€…éƒ½ä¾èµ–æ•°æ®æ¥å­¦ä¹ ï¼Œå¹¶é€šè¿‡è¿­ä»£è¿‡ç¨‹æ”¹è¿›æ¨¡å‹æ€§èƒ½ã€‚ åŒºåˆ«ï¼š æœºå™¨å­¦ä¹ åŒ…æ‹¬ä¸€ç³»åˆ—ä¸ä»…é™äºç¥ç»ç½‘ç»œçš„æŠ€æœ¯å’Œæ–¹æ³•ã€‚ æ·±åº¦å­¦ä¹ é€šå¸¸éœ€è¦æ›´å¤§é‡çš„æ•°æ®å’Œæ›´å¼ºçš„è®¡ç®—èƒ½åŠ›ã€‚ 3. ç¥ç»ç½‘ç»œ (Neural Networks)ç¥ç»ç½‘ç»œæ˜¯å®ç°AI çš„ä¸€ç§æŠ€æœ¯æ‰‹æ®µï¼Œä¸€ç§å¹¿æ³›ç”¨äºæœºå™¨å­¦ä¹ ï¼ˆMachine Learningï¼‰å’Œæ·±åº¦å­¦ä¹ ï¼ˆDeep Learningï¼‰é¢†åŸŸçš„è®¡ç®—æ¨¡å‹/ç®—æ³•æ¶æ„ã€‚ å®ƒå—åˆ°äººç±»å¤§è„‘ç¥ç»å…ƒï¼ˆNeuronsï¼‰å’Œå®ƒä»¬çš„äº’åŠ¨æ–¹å¼çš„å¯å‘ï¼Œå®ƒç”±å¤šä¸ªå±‚ï¼ˆLayersï¼‰ç»„æˆï¼Œæ¯å±‚åŒ…å«å¤šä¸ªç¥ç»å…ƒï¼Œè¿™äº›ç¥ç»å…ƒé€šè¿‡æƒé‡ï¼ˆWeightsï¼‰è¿æ¥ä¼ é€’ä¿¡æ¯ã€‚ ç¥ç»ç½‘ç»œçš„è®­ç»ƒè¿‡ç¨‹åŸºäºæœºå™¨å­¦ä¹ çš„åŸºæœ¬å‰æï¼Œå³èƒ½å¤Ÿä»æ•°æ®ä¸­å­¦ä¹ ã€‚é€šè¿‡å‘ç½‘ç»œæä¾›å¤§é‡çš„æ•°æ®æ ·æœ¬ï¼ˆåŒ…æ‹¬è¾“å…¥å’ŒæœŸæœ›çš„è¾“å‡ºï¼‰ï¼Œç¥ç»ç½‘ç»œå¯ä»¥å­¦ä¹ åˆ°å¦‚ä½•æ˜ å°„è¾“å…¥åˆ°è¾“å‡ºï¼Œè¿™ç§èƒ½åŠ›æ˜¯é€šè¿‡è°ƒæ•´å†…éƒ¨ç»“æ„ï¼ˆå³æƒé‡ï¼‰æ¥å®ç°çš„ã€‚ è¿™ä¸€å­¦ä¹ è¿‡ç¨‹ä½¿ç”¨äº†æœºå™¨å­¦ä¹ ä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå¦‚æŸå¤±å‡½æ•°ï¼ˆLoss Functionsï¼‰ã€æ¢¯åº¦ä¸‹é™ï¼ˆGradient Descentï¼‰å’Œåå‘ä¼ æ’­ç®—æ³•ï¼ˆBackpropagation Algorithmsï¼‰ã€‚è¿™äº›éƒ½æ˜¯æœºå™¨å­¦ä¹ é¢†åŸŸçš„åŸºæœ¬å·¥å…·ï¼Œç”¨äºè®­ç»ƒæ¨¡å‹ä»¥æ”¹è¿›å…¶æ€§èƒ½ã€‚ 4. TransformerTransformerï¼ˆå˜æ¢å™¨ï¼‰æ˜¯ä¸€ç§é©å‘½æ€§çš„ç¥ç»ç½‘ç»œæ¶æ„ï¼Œå®ƒåœ¨è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNatural Language Processing, NLPï¼‰å’Œå…¶ä»–åºåˆ—å»ºæ¨¡ä»»åŠ¡ä¸­å–å¾—äº†æ˜¾è‘—çš„æˆå°±ã€‚Transformer æœ€åˆç”± Vaswani ç­‰äººåœ¨ 2017 å¹´çš„è®ºæ–‡ â€œAttention Is All You Needâ€ ä¸­æå‡ºï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å®Œå…¨ä¾é æ³¨æ„åŠ›æœºåˆ¶ï¼ˆattention mechanismsï¼‰ï¼Œæ‘’å¼ƒäº†ä¹‹å‰å¸¸ç”¨çš„å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Networks, RNNsï¼‰å’Œå·ç§¯ç¥ç»ç½‘ç»œï¼ˆConvolutional Neural Networks, CNNsï¼‰ä¸­çš„ç»“æ„ã€‚ 5. NLPè‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNatural Language Processingï¼Œç®€ç§°NLPï¼‰æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äºè®©è®¡ç®—æœºç†è§£ã€è§£é‡Šå’Œç”Ÿæˆäººç±»è¯­è¨€ã€‚å®ƒç»“åˆäº†è®¡ç®—æœºç§‘å­¦ã€äººå·¥æ™ºèƒ½å’Œè¯­è¨€å­¦çš„çŸ¥è¯†ä¸æŠ€æœ¯ï¼Œç”¨äºå¤„ç†å’Œåˆ†æå¤§é‡çš„è‡ªç„¶è¯­è¨€æ•°æ®ã€‚ NLPä½¿ç”¨å„ç§æŠ€æœ¯æ¥å¤„ç†å’Œç†è§£è¯­è¨€ã€‚è¿™äº›æ–¹æ³•ä»è§„åˆ™åŸºç¡€çš„æ–¹æ³•åˆ°åŸºäºæœºå™¨å­¦ä¹ çš„æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯æ·±åº¦å­¦ä¹ ï¼Œéƒ½æœ‰æ¶µç›–ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ·±åº¦å­¦ä¹ åœ¨NLPä¸­å˜å¾—è¶Šæ¥è¶Šé‡è¦ï¼Œå› ä¸ºå®ƒèƒ½å¤Ÿåœ¨å¤„ç†è‡ªç„¶è¯­è¨€çš„å¤æ‚æ€§æ–¹é¢æä¾›æ˜¾è‘—çš„æ”¹è¿›ã€‚ ä¼ ç»Ÿæ–¹æ³•ï¼š åŸºäºè§„åˆ™çš„ç³»ç»Ÿï¼šä½¿ç”¨é¢„å®šä¹‰çš„è¯­è¨€è§„åˆ™æ¥è§£é‡Šæ–‡æœ¬ã€‚ ç»Ÿè®¡æ¨¡å‹ï¼šåŸºäºå¤§é‡è¯­æ–™åº“æ•°æ®ï¼Œä½¿ç”¨ç»Ÿè®¡æ–¹æ³•æ¨æ–­å’Œé¢„æµ‹ã€‚ ç°ä»£æ–¹æ³• ç¥ç»ç½‘ç»œï¼šä½¿ç”¨å¤šå±‚ç¥ç»ç½‘ç»œæ¨¡å‹å¤„ç†è¯­è¨€ä»»åŠ¡ï¼Œå¦‚å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰ã€é•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼ˆLSTMï¼‰å’Œæœ€è¿‘çš„å˜æ¢å™¨æ¨¡å‹ï¼ˆå¦‚BERTã€GPTï¼‰ã€‚ NLPæŠ€æœ¯è¢«å¹¿æ³›åº”ç”¨äºå„ç§ç°å®ä¸–ç•Œçš„åœºæ™¯å’Œäº§å“ä¸­ï¼Œä¾‹å¦‚ï¼š èŠå¤©æœºå™¨äººå’Œè™šæ‹ŸåŠ©æ‰‹ï¼ˆå¦‚Appleçš„Siriã€Google Assistantã€Amazon Alexaï¼‰ã€‚ æ–‡æœ¬åˆ†æå·¥å…·ï¼Œå¸®åŠ©ä¼ä¸šç›‘æµ‹å’Œåˆ†æç¤¾äº¤åª’ä½“ä¸Šçš„æ¶ˆè´¹è€…æƒ…ç»ªã€‚ ç”µå­é‚®ä»¶è¿‡æ»¤å’Œååƒåœ¾é‚®ä»¶æŠ€æœ¯ã€‚ è¯­éŸ³åˆ°æ–‡æœ¬æœåŠ¡ï¼Œå¦‚åœ¨æ³•åº­è®°å½•æˆ–åŒ»ç–—è®°å½•ç³»ç»Ÿä¸­è‡ªåŠ¨è½¬å½•å£è¿°å†…å®¹ã€‚ 5. LLMLLMï¼ˆLarge Language Modelsï¼Œå¤§å‹è¯­è¨€æ¨¡å‹ï¼‰æ˜¯è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNatural Language Processing, NLPï¼‰é¢†åŸŸçš„ä¸€ç§å…ˆè¿›æŠ€æœ¯ï¼Œä¸»è¦ä¾èµ–äºæ·±åº¦å­¦ä¹ ï¼ˆDeep Learningï¼‰æŠ€æœ¯ï¼Œç‰¹åˆ«æ˜¯åŸºäº Transformer æ¶æ„çš„ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚è¿™äº›æ¨¡å‹å› å…¶è§„æ¨¡åºå¤§å’Œåœ¨å¤šç§è¯­è¨€ä»»åŠ¡ä¸Šçš„å‡ºè‰²è¡¨ç°è€Œå¾—åã€‚ LM æ˜¯è®¾è®¡ç”¨æ¥ç†è§£ã€ç”Ÿæˆã€ç¿»è¯‘ã€æ‘˜è¦ç­‰å¤„ç†æ–‡æœ¬çš„å¤§è§„æ¨¡ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚å®ƒä»¬é€šå¸¸åŒ…å«æ•°åäº¿è‡³æ•°ä¸‡äº¿ä¸ªå‚æ•°ï¼Œå¹¶åœ¨å¤§é‡å¤šæ ·åŒ–çš„æ–‡æœ¬æ•°æ®ä¸Šè¿›è¡Œè®­ç»ƒï¼Œä»¥å­¦ä¹ è¯­è¨€çš„æ·±å±‚æ¬¡ç»“æ„å’Œè¯­ä¹‰ã€‚æ ¸å¿ƒç»„ä»¶ Transformer æ¶æ„ï¼ˆTransformer Architectureï¼‰ï¼š LLM å¤šä½¿ç”¨åŸºäº Transformer çš„æ¨¡å‹ï¼Œè¿™ç§æ¨¡å‹ä¾é è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-Attention Mechanismï¼‰æ¥å¤„ç†æ–‡æœ¬æ•°æ®ï¼Œä¼˜äºä¼ ç»Ÿçš„å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Networks, RNNsï¼‰æˆ–å·ç§¯ç¥ç»ç½‘ç»œï¼ˆConvolutional Neural Networks, CNNsï¼‰ã€‚ é¢„è®­ç»ƒä¸å¾®è°ƒï¼ˆPre-training and Fine-tuningï¼‰ï¼š é¢„è®­ç»ƒï¼ˆPre-trainingï¼‰ï¼šåœ¨å¤§è§„æ¨¡æœªæ ‡è®°æ•°æ®ä¸Šè¿›è¡Œï¼Œæ¨¡å‹å­¦ä¹ è¯­è¨€çš„é€šç”¨ç‰¹å¾ã€‚ å¾®è°ƒï¼ˆFine-tuningï¼‰ï¼šåœ¨ç‰¹å®šä»»åŠ¡çš„è¾ƒå°æ ‡è®°æ•°æ®é›†ä¸Šè¿›è¡Œï¼Œè°ƒæ•´æ¨¡å‹ä»¥é€‚åº”å…·ä½“åº”ç”¨ã€‚ è‡ªç›‘ç£å­¦ä¹ ï¼ˆSelf-supervised Learningï¼‰ï¼š LLM é€šå¸¸é€šè¿‡è‡ªç›‘ç£å­¦ä¹ é¢„è®­ç»ƒï¼Œè¿™æ„å‘³ç€å®ƒä»¬ä½¿ç”¨è¾“å…¥æ•°æ®çš„ä¸åŒéƒ¨åˆ†ä½œä¸ºè‡ªå·±çš„ç›‘ç£ä¿¡å·ï¼Œä¾‹å¦‚ï¼Œé¢„æµ‹æ–‡æœ¬ä¸­è¢«é®è”½ï¼ˆMaskedï¼‰çš„å•è¯ã€‚","tags":["AI","chatGPT"]},{"title":"TrustMessage-åŸºäº2PC+MySQL+æ³›åŒ–è°ƒç”¨å®ç°çš„å¯é æ¶ˆæ¯ä¸­å¿ƒ","path":"/99d433fa/","content":"0. é¡¹ç›®ç»“æ„ä»‹ç» Module Description trustmessage-mysql åŸºäº2PC+MySQLè¡¨å®ç°çš„å¯é æ¶ˆæ¯ä¸­å¿ƒï¼Œä¸šåŠ¡æ“ä½œ+æ¶ˆæ¯è¡¨æ“ä½œå‡å­˜åœ¨äºåŒä¸€ä¸ªé¡¹ç›®ä¸­ turstmessage-middleware å¯é æ¶ˆæ¯ä¸­å¿ƒä¸­é—´ä»¶ï¼ŒåŸºäºRPCæ¥å£æäº¤æ¶ˆæ¯+2PC+MySQL è¡¨å®ç° turstmessage-middlewareapi å¯é æ¶ˆæ¯ä¸­å¿ƒä¸­é—´ä»¶ï¼Œ å›æŸ¥æ¥å£å®šä¹‰ Turstmessage-middlewareclient å¯é æ¶ˆæ¯ä¸­å¿ƒä¸­é—´ä»¶ï¼Œ æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œæä¾›äº†HTTPå›æŸ¥æ¥å£ã€Dubboæ³›åŒ–å›æŸ¥æ¥å£çš„ç¤ºä¾‹ ä»¥ä¸‹æ˜¯é¡¹ç›®æ­£å¼ä»‹ç»ã€‚ åœ¨ä¸šåŠ¡å¤„ç†ä¸­ï¼Œç»å¸¸ä¼šæœ‰é‡è¦ä½†æ²¡é‚£ä¹ˆç´§æ€¥çš„æ•°æ®éœ€è¦åŒæ­¥ç»™ä¸‹æ¸¸ï¼Œæ¯”å¦‚ è®¢å•ä¾§å®Œæˆæ¶ˆæ¯åç»™ä¼˜æƒ ä¾§å‘ä¸€ä¸ªæ¶ˆæ¯ï¼Œä¼˜æƒ ä¾§åšä¸€ä¸ªå•å‘å¯¹è´¦çš„åŠŸèƒ½ï¼Œç¡®ä¿åˆ¸è¢«æ­£ç¡®æ ¸é”€ åœ¨è¿™ç§åœºæ™¯ä¸­ï¼Œéœ€è¦æŠŠæœ¬åœ°ä¸šåŠ¡æ“ä½œ + æ¶ˆæ¯å‘é€å½“æˆä¸€ä¸ªäº‹åŠ¡å¤„ç†ï¼Œå³æ»¡è¶³åŸå­æ€§ï¼Œ ä¸€èˆ¬å¸¸è§çš„è§£å†³æ–¹æ¡ˆä¼šæœ‰ä¸¤ç§ æœ¬åœ°äº‹åŠ¡+æœ¬åœ°æ¶ˆæ¯è¡¨ RocketMQ æœ¬é¡¹ç›®å°†ä»æœ¬åœ°äº‹åŠ¡+æœ¬åœ°æ¶ˆæ¯è¡¨ å‡ºå‘ï¼Œ ä¸€æ­¥æ­¥æ¢è®¨å¦‚ä½•ç”¨ MySQL å®ç°ä¸€ä¸ªæ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡çš„å¯é æ¶ˆæ¯ä¸­å¿ƒï¼Œå³TrustMessageã€‚ é¡¹ç›®githubé“¾æ¥ï¼Œç‚¹å‡»å¯æŸ¥çœ‹ä»£ç  1. æœ¬åœ°äº‹åŠ¡+ æœ¬åœ°æ¶ˆæ¯è¡¨ç”±äºSpring çš„äº‹åŠ¡æœºåˆ¶åªä¿è¯æ•°æ®åº“æ“ä½œçš„åŸå­æ€§ï¼Œæ‰€ä»¥å½“æ¶‰åŠåˆ° æ•°æ®åº“çš„ä¸šåŠ¡æ“ä½œ å’Œ å…¶ä»–ä¸­é—´ä»¶å¦‚kafkaæ“ä½œ å…·æœ‰åŸå­æ€§çš„æ—¶å€™ï¼Œå°±è¦ç”¨å…¶ä»–çš„æ–¹æ¡ˆæ¥ä¿è¯ã€‚ æœ¬åœ°äº‹åŠ¡+ æœ¬åœ°æ¶ˆæ¯è¡¨ è¿™ç§æ–¹æ¡ˆæ˜¯æŠŠ éœ€è¦å‘é€çš„æ¶ˆæ¯ä½œä¸ºæ•°æ®åº“æ“ä½œçš„ä¸€éƒ¨åˆ†ï¼Œä¿å­˜åˆ°æ•°æ®åº“ä¸­çš„ä¸€ä¸ªè¡¨é‡Œï¼Œç„¶åé€šè¿‡å¦å¤–çš„é€»è¾‘ï¼Œå°†æ¶ˆæ¯çš„çœŸæ­£å‘é€ ç¨åå¼‚æ­¥è¿›è¡Œï¼Œæ¯”å¦‚ç”¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡å°†æ¶ˆæ¯å¼‚æ­¥å‘é€åˆ°Kafkaã€‚ è¿™ç§æ–¹æ³•ç¡®ä¿äº†æ•°æ®åº“æ“ä½œå’Œæ¶ˆæ¯å‘é€åœ¨é€»è¾‘è¯­ä¹‰ä¸Šçš„åŸå­æ€§ï¼Œå› ä¸ºå®ƒä»¬éƒ½åœ¨åŒä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ä¸­å¤„ç†ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œè¿™ç§æ–¹æ¡ˆçš„å®æ—¶æ€§æ˜¯æ¯”è¾ƒå·®çš„ï¼Œæ‰€ä»¥ä½ éœ€è¦åˆ¤æ–­çš„ä¸šåŠ¡åœºæ™¯åœºæ™¯æ˜¯å¦èƒ½å¤Ÿå®¹å¿è¿™æ ·çš„å¼‚æ­¥æ“ä½œã€‚ 1.1 ä¸šåŠ¡æµç¨‹ ä»¥ä¸Šæµç¨‹ä¸­ï¼Œåœ¨æœ¬åœ°äº‹åŠ¡æäº¤åï¼Œæœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡è½®è¯¢æ¶ˆæ¯è¡¨å°†éœ€è¦å‘é€çš„æ¶ˆæ¯æ¶ˆæ¯å‘é€å‡ºå»ã€‚æœ‰4ä¸ªç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ äº‹åŠ¡æäº¤åäº†ï¼Œæ¶ˆæ¯å‘é€å¤±è´¥ï¼Œ å®šæ—¶ä»»åŠ¡çš„é‡è¯•æœºåˆ¶ï¼Œä¼šæ‰¾å‡ºè¿™æ¡æ¶ˆæ¯è¿›è¡Œå¼‚æ­¥è¡¥å‘ äº‹åŠ¡æäº¤åäº†ï¼Œæ¶ˆæ¯å‘é€æˆåŠŸï¼Œä½†æ˜¯æ¶ˆæ¯çŠ¶æ€ä¿®æ”¹çŠ¶æ€ï¼Œ å®šæ—¶ä»»åŠ¡ä¼šæ‰¾å‡ºè¿™æ¡å†æ¬¡å‘é€ é‡è¯•å¼‚æ­¥è¡¥å‘è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ¶ˆæ¯ä¾ç„¶å‘é€å¤±è´¥ï¼Œé‚£ä¹ˆä¼šç»§ç»­é‡è¯•è¡¥å‘ é‡è¯•å¼‚æ­¥è¡¥å‘è¿‡ç¨‹ä¸­ï¼Œæ¶ˆæ¯å‘é€æˆåŠŸï¼Œä½†æ˜¯æ•°æ®åº“æ¶ˆæ¯å·²å‘é€çŠ¶æ€ä¿®æ”¹å¤±è´¥ï¼Œé‚£ä¹ˆå®šæ—¶ä»»åŠ¡åˆä¼šå†æ¬¡æ‰¾åˆ°è¿™æ¡æ¶ˆæ¯å†å‘ä¸€é ä»¥ä¸Š 2å’Œ4 å‡ä¼šé¢ä¸´æ¶ˆæ¯é‡å¤çš„æƒ…å†µï¼Œ ä¸ªäººè®¤ä¸ºåœ¨ä¸šåŠ¡å¸¸è§ä¸­æ¶ˆæ¯é‡å¤æ˜¯ä¸€ç§å¯æ¥å—çš„æƒ…å†µï¼Œæœ‰æ—¶å€™ä¸šåŠ¡è‡ªå·±ç”šè‡³ä¼šæ¶ˆæ¯é‡æ”¾ï¼Œ æ‰€ä»¥æ¶ˆæ¯æ¶ˆè´¹è€…åšå¥½å¹‚ç­‰é€»è¾‘å°±å¯ä»¥äº†ã€‚ 1.2 æ¶ˆæ¯å‘é€é‡è¯•æ¬¡æ•°æ¶ˆæ¯å‘é€ä¸èƒ½æ— é™æ¬¡é‡è¯• æµªè´¹èµ„æºï¼Œé‡è¯•äº†é‚£ä¹ˆå¤šæ¬¡éƒ½æœªæˆåŠŸï¼Œå¯èƒ½æ˜¯é€»è¾‘å‡ºç°é—®é¢˜äº†æˆ–è€…å®•æœºäº†ï¼Œèµ¶ç´§å»æŸ¥é—®é¢˜å§ ä¸Šä¸‹æ¸¸ä¸šåŠ¡æ•°æ®è¿Ÿè¿Ÿæ— æ³•è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ ï¼Œ æœ¬èº«æˆ‘ä»¬ä½¿ç”¨æ¶ˆæ¯å…¶ç»ˆæç›®çš„å°±æ˜¯ä¸ºäº†è®©ç³»ç»Ÿæ•°æ®è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ï¼Œ å¦‚æœä¸€ç›´æ— é™åˆ¶å‘é€ï¼Œè¿™ä¸ªç›®çš„æ˜¯æ— æ³•è¾¾åˆ°çš„, æ‰€ä»¥èµ¶ç´§åœä¸‹å»æŸ¥é—®é¢˜å§ åŸºäºä»¥ä¸Šä¸¤ä¸ªè€ƒè™‘ï¼Œç³»ç»Ÿå¯¹äºé‡è¯•éƒ½åº”è¯¥æœ‰ä¸ªæ¬¡æ•°é™åˆ¶ï¼Œè¾¾åˆ°æ¬¡æ•°é™åˆ¶åå°±åº”è¯¥å‘Šè­¦è®©äººå·¥ä»‹å…¥å¤„ç†ã€‚ 1.3 æ¶ˆæ¯è¡¨è®¾è®¡åœ¨æœ¬åœ°äº‹åŠ¡+ æœ¬åœ°æ¶ˆæ¯è¡¨ æ–¹æ¡ˆä¸­ï¼Œå…¶æ¶ˆæ¯è¡¨çš„è®¾è®¡ä¸€èˆ¬å¦‚ä¸‹ï¼Œ 1234567891011CREATE TABLE message (\tid bigint unsigned NOT NULL AUTO_INCREMENT,\tmessage text COMMENT &#x27;æ¶ˆæ¯å†…å®¹&#x27;,\tsend_status INT DEFAULT 0 COMMENT &#x27;0-æŠ•é€’ä¸­ 1-æŠ•é€’æˆåŠŸ 2-æŠ•é€’å¤±è´¥&#x27;,\tsend_try_count INT DEFAULT 0 COMMENT &#x27;commit æ¶ˆæ¯å‘é€ å½“å‰é‡è¯•æ¬¡æ•°&#x27;,\tsend_next_retry_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;æ¶ˆæ¯å‘é€ ä¸‹æ¬¡é‡è¯•æ—¶é—´&#x27;,\tcreate_time DATETIME DEFAULT CURRENT_TIMESTAMP,\tupdate_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\tPRIMARY KEY (id),\tUNIQUE INDEX idx_messageKey(message_key)) ENGINE=InnoDB; 2. å¦‚æœæ¶ˆæ¯è¡¨å’Œä¸šåŠ¡è¡¨æ“ä½œæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ä½†æ˜¯å¦‚æœä¿è¯ä¸äº†è¿™ä¸¤ä¸ªè¡¨ä¸åœ¨åŒä¸€ä¸ªåº“ /æ•°æ®åº“å®ä¾‹ä¸­ï¼Œé‚£å°±ä¼šåœ¨ä¸šåŠ¡æ“ä½œå’Œæ¶ˆæ¯è¡¨å†™å…¥ä¸¤ä¸ªæ“ä½œä¸­é‡åˆ°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚è¿™åœ¨åˆ†åº“åˆ†è¡¨çš„ä¸šåŠ¡ä¸­æ˜¯å¾ˆå®¹æ˜“å‡ºç°çš„æƒ…å†µã€‚ é’ˆå¯¹å¯¹åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¸¸è§çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ 2PCã€3PCã€TCCã€SAGAã€‚ æ¥ä¸‹æ¥å°†è®²è§£ä»¥ 2PC+MySQLæ¶ˆæ¯è¡¨ å®ç°çš„å¯é æ¶ˆæ¯ä¸­å¿ƒ 2.1 ä¸šåŠ¡æµç¨‹ä»¥MySQLæ¶ˆæ¯è¡¨+ 2PC æ¥å®ç°å¯é æ¶ˆæ¯ä¸­å¿ƒï¼Œ å…¶æ•´ä½“å®ç°æµç¨‹å¦‚ä¸‹ 2.2 æ¶ˆæ¯å¯è§æ€§æ¶ˆæ¯å¯è§æ€§ï¼Œ åœ¨æ¶‰åŠåˆ†å¸ƒå¼äº‹åŠ¡çš„åœºæ™¯ä¸­ï¼Œæ¶ˆæ¯å¢åŠ äº†ä¸€ä¸ªå¯è§æ€§æ¦‚å¿µï¼Œ è¿™æ˜¯å› ä¸ºåœ¨å¼•å…¥2PC åï¼Œå†™å…¥æ¶ˆæ¯è¡¨çš„æ¶ˆæ¯ä¸å†åƒæœ¬åœ°äº‹åŠ¡+æœ¬åœ°æ¶ˆæ¯è¡¨ä¸€æ ·å†™å…¥å³å¯è§ï¼Œå¿…é¡»æ˜¯commitåæ‰å¯¹æ¶ˆè´¹è€…å¯è§ï¼Œ æ‰€ä»¥åœ¨æ•°æ®è¡¨çš„è®¾è®¡ä¸­éœ€è¦å¢åŠ ä¸€ä¸ªçŠ¶æ€å­—æ®µæ¥ç»´æŠ¤æ¶ˆæ¯å¯è§æ€§ã€‚1message_status INT COMMENT &#x27;æ¶ˆæ¯çŠ¶æ€ 1-prepare 2-commit 3-rollback 4-unknown&#x27;, å…¶çŠ¶æ€æµè½¬å¦‚å›¾æ‰€ç¤º 2.3 å¦‚æœä¸šåŠ¡æ‰§è¡Œæ¶ˆæ¯commit or rollback å¤±è´¥æ€ä¹ˆåŠ-æ¶ˆæ¯å›æŸ¥å¦‚æµç¨‹å›¾ä¸­æ‰€ç¤ºï¼Œåœ¨2PC é˜¶æ®µï¼Œæ‹¿åˆ°ä¸šåŠ¡æ‰§è¡Œç»“æœä¿®æ”¹æ¶ˆæ¯çŠ¶æ€å¤±è´¥æœ‰å¯èƒ½æ˜¯å¤±è´¥ã€‚ ä¸€ä¸ªæ“ä½œæ‰§è¡Œå¤±è´¥åï¼Œä¸€ç§å¸¸è§çš„è§£å†³æ–¹æ¡ˆæ–¹æ¡ˆå°±æ˜¯é‡è¯•ï¼Œå°½æœ€å¤§åŠªåŠ›äº¤ä»˜ã€‚ ä½†æ˜¯å¯¹äºä¸šåŠ¡å¤„ç†æ¥è®²ï¼Œä¸€èˆ¬æœ‰è¶…æ—¶æ—¶é—´çš„é™åˆ¶ï¼Œå› ä¸ºè¿™ç§åŒæ­¥é‡è¯•å¯èƒ½å¹¶ä¸é€‚ç”¨ï¼Œå³ä½¿å¯ä»¥ï¼Œä¸€èˆ¬é‡è¯•æ¬¡æ•°éƒ½ä¼šé™å®šåœ¨3æ¬¡ã€‚ é™¤äº†åŒæ­¥é‡è¯•ï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ¡ˆå°±æ˜¯ æ¶ˆæ¯å›æŸ¥ï¼Œæˆ‘ä¸ªäººç†è§£è¿™ç›¸å½“äºä¸€ç§å¼‚æ­¥é‡è¯•ã€‚ åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæ¶ˆæ¯å›æŸ¥æŒ‡çš„å°±æ˜¯å¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡å»å…¨è¡¨æ‰«æï¼Œæ‰¾å‡ºinsertä¸€å®šæ—¶é—´åï¼Œå…¶çŠ¶æ€ä»ç„¶æ˜¯ prepareçš„æ¶ˆæ¯ ï¼Œé€šè¿‡ä¸šåŠ¡é€»è¾‘åˆ¤æ–­è¯¥æ¡æ¶ˆæ¯æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ or å¤±è´¥ï¼Œå¯¹åº”åœ°æŠŠæ¶ˆæ¯çŠ¶æ€æ›´æ”¹ä¸º commit or rollbackã€‚ ä¸ºäº†è¿›è¡Œæ¶ˆæ¯å›æŸ¥ï¼Œè‚¯å®šè¦æœ‰ä¸€ä¸ªä¸šåŠ¡å”¯ä¸€æ ‡è¯†æ¥è¯†åˆ«è¯¥æ¡æ¶ˆæ¯éœ€è¦å¯¹åº”ä¸šåŠ¡æ•°æ®ï¼Œä»è€Œåˆ¤æ–­å¯¹åº”ä¸šåŠ¡æ˜¯å¦æ‰§è¡Œå®Œæˆã€‚1message_key VARCHAR(255) COMMENT &#x27;æ¶ˆæ¯å”¯ä¸€é”®ï¼Œç”¨äºåšå›æŸ¥çš„æ ‡è¯†&#x27;, 2.4 æ¶ˆæ¯å›æŸ¥ä¸èƒ½æ— é™æ¬¡ æµªè´¹èµ„æºï¼Œå›æŸ¥äº†è¿™ä¹ˆå¤šæ¬¡çš„éƒ½æ²¡æ‹¿åˆ°ç»“æœï¼Œä¸€ç§å¯èƒ½å°±æ˜¯ä¸šåŠ¡é€»è¾‘å‡ºç°é—®é¢˜äº†ï¼Œé€‚å¯è€Œæ­¢èµ¶ç´§å»æŸ¥é—®é¢˜å§ ç³»ç»Ÿæ•°æ®è¿Ÿè¿Ÿæ— æ³•è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ ï¼Œ æœ¬èº«æˆ‘ä»¬ä½¿ç”¨æ¶ˆæ¯å…¶ç»ˆæç›®çš„å°±æ˜¯ä¸ºäº†è®©ç³»ç»Ÿæ•°æ®è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ï¼Œ å¦‚æœä¸€ç›´æ— é™åˆ¶æŸ¥è¯¢ï¼Œè¿™ä¸ªç›®çš„æ˜¯æ— æ³•è¾¾åˆ°çš„, æ‰€ä»¥èµ¶ç´§åœä¸‹å»æŸ¥é—®é¢˜å§ æ‰€æœ‰æ¶ˆæ¯å›æŸ¥åº”è¯¥æœ‰ä¸ªæ¬¡æ•°é™åˆ¶ï¼Œ è¿™å°±æ˜¯è¡¨ä¸­ä»¥ä¸‹ä¸¤ä¸ªå­—æ®µçš„ä½œç”¨12verify_try_count INT COMMENT &#x27;æ¶ˆæ¯çŠ¶æ€å›æŸ¥ ä¸‹æ¬¡é‡è¯•æ¬¡æ•°&#x27;, verify_next_retry_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;æ¶ˆæ¯çŠ¶æ€å›æŸ¥ ä¸‹æ¬¡é‡è¯•æ—¶é—´ 1-æœªå‘é€ 2-å·²å‘é€&#x27;, 2.5 æ¶ˆæ¯å›æŸ¥æ¬¡æ•°è¾¾åˆ°ä¸Šé™æ€ä¹ˆåŠæœ‰ä¸¤ç§å‚è€ƒæ–¹æ¡ˆ é»˜è®¤ä¿®æ”¹æ¶ˆæ¯çŠ¶æ€ä¸ºcommit æˆ–è€… rollbackï¼Œ å°†æ¶ˆæ¯çŠ¶æ€ç½®ä¸ºå›æŸ¥å¤±è´¥çŠ¶æ€ ï¼Œ å‘Šè­¦äººå·¥ä»‹å…¥å¤„ç† é»˜è®¤ä¿®æ”¹æ¶ˆæ¯çŠ¶æ€ä¸ºcommit æˆ–è€… rollback è¿™ä¸ªæ–¹æ¡ˆï¼Œä¸€ä¸ªæœ€å¤§çš„é—®é¢˜å°±æ˜¯é’ˆå¯¹çŠ¶æ€ä¸ç¡®å®šçš„æ¶ˆæ¯ï¼Œä¸è®ºå°†å…¶é»˜è®¤ä¿®æ”¹ä¸ºé‚£ç§çŠ¶æ€ï¼Œ éƒ½æ˜¯æœ‰å¯èƒ½å¼•èµ·ä¸šåŠ¡ä¸Šä¸‹æ¸¸æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚ ä¸€æ—¦ä¸Šä¸‹æ¸¸æ•°æ®äº§ç”Ÿäº†æ•°æ®ä¸ä¸€è‡´æ€§ï¼Œå¿…ç„¶å¯¼è‡´å¾ˆé•¿çš„æ’æŸ¥é“¾è·¯å’Œå¤§é‡çš„æ•°æ®ä¿®å¤å·¥ä½œã€‚ æ‰€ä»¥æœ¬é¡¹ç›®ä¸­æˆ‘é€‰æ‹©ç¬¬äºŒç§æ–¹æ¡ˆï¼Œæ¶ˆæ¯å›æŸ¥è¾¾åˆ°ä¸Šé™åç›´æ¥å‘Šè­¦ï¼Œè®©æ¶ˆæ¯ç”Ÿäº§è€…è¿™ä¸€æ–¹äººå·¥ä»‹å…¥å¤„ç†ã€‚ æ­¤å¤„è¯´æ˜ä¸€ä¸‹ï¼Œè¿™ç§æ–¹æ¡ˆå½“ç„¶ä¹Ÿä¼šæœ‰æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå› ä¸ºä¸‹æ¸¸ä¸šåŠ¡å§‹ç»ˆè¿˜æœªæ‹¿åˆ°æ¶ˆæ¯ä¿®æ”¹è‡ªå·±çš„çŠ¶æ€ï¼Œä½†æ˜¯ç›¸æ¯”æ‹¿åˆ°äº†éšæœºç¡®å®šçš„çš„çŠ¶æ€ å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´æ€§ï¼Œæ­¤æ—¶é—®é¢˜è¿˜è¢«æ§åˆ¶åœ¨æ¶ˆæ¯ç”Ÿäº§è€…è¿™ä¸€ç¯ï¼Œé—®é¢˜æ’æŸ¥ä¼šç›¸å¯¹ç®€å•ã€‚ 2.6 æ¶ˆæ¯å‘é€é‡è¯•ä¸æœ¬åœ°äº‹åŠ¡+æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆä¸€è‡´ 2.7 æ¶ˆæ¯è¡¨è®¾è®¡123456789101112131415CREATE TABLE message (\tid bigint unsigned NOT NULL AUTO_INCREMENT,\tmessage_key VARCHAR(255) COMMENT &#x27;æ¶ˆæ¯å”¯ä¸€é”®ï¼Œç”¨äºåšå›æŸ¥çš„æ ‡è¯†&#x27;,\tmessage text COMMENT &#x27;æ¶ˆæ¯å†…å®¹&#x27;,\tmessage_status INT DEFAULT 1 COMMENT &#x27;æ¶ˆæ¯çŠ¶æ€ 1-prepare 2-commit 3-rollback 4-unknown&#x27;,\tverify_try_count INT DEFAULT 0 COMMENT &#x27;æ¶ˆæ¯çŠ¶æ€å›æŸ¥ å½“å‰é‡è¯•æ¬¡æ•°&#x27;,\tverify_next_retry_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;æ¶ˆæ¯çŠ¶æ€å›æŸ¥ ä¸‹æ¬¡é‡è¯•æ—¶é—´&#x27;,\tsend_status INT DEFAULT 0 COMMENT &#x27;0-æŠ•é€’ä¸­ 1-æŠ•é€’æˆåŠŸ 2-æŠ•é€’å¤±è´¥&#x27;,\tsend_try_count INT DEFAULT 0 COMMENT &#x27;commit æ¶ˆæ¯å‘é€ å½“å‰é‡è¯•æ¬¡æ•°&#x27;,\tsend_next_retry_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;æ¶ˆæ¯å‘é€ ä¸‹æ¬¡é‡è¯•æ—¶é—´&#x27;,\tcreate_time DATETIME DEFAULT CURRENT_TIMESTAMP,\tupdate_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\tPRIMARY KEY (id),\tUNIQUE INDEX idx_messageKey(message_key)) ENGINE=InnoDB; 2.8 æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯é’ˆå¯¹å¯è§ï¼Œ å³å·²ç»commit çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…è¯¥å¦‚ä½•è·å–åˆ°æ¶ˆæ¯æ¶ˆè´¹å‘¢ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆ æ¶ˆæ¯è€…ç›´æ¥æŸ¥è¯¢æ¶ˆæ¯è¡¨ æ¶ˆè´¹è€…ä»æ¶ˆæ¯é˜Ÿåˆ—é˜Ÿåˆ—æ¶ˆè´¹ 2.8.1 æ¶ˆæ¯è€…è½®è®­æ¶ˆæ¯è¡¨è¿™ç§æ–¹æ¡ˆæœ€å¤§çš„é—®é¢˜å°±æ˜¯ï¼Œåœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œä¸Šä¸‹æ¸¸ä¸¤ä¸ªä¸åŒçš„æœåŠ¡ æ“ä½œ åŒä¸€ä¸ªæ•°æ®è¡¨ æ˜¯ä¸€ä¸ªä¸åˆç†ä¸”ä¸æ¨èçš„åšæ³•ã€‚ 2.8.2 æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹å’Œæœ¬åœ°äº‹åŠ¡+æœ¬åœ°æ¶ˆæ¯è¡¨ä¸€æ ·ï¼Œå·²ç»commit çš„æ¶ˆæ¯å¯ä»¥ç”±ä¸€ä¸ªå®šæ—¶ä»»åŠ¡è½®è®­å‘é€åˆ°ä¸šåŠ¡åˆ›å»ºçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¾›è®¢é˜…çš„æ¶ˆè´¹è€…æ¶ˆè´¹å‘é€è¿‡ç¨‹ä¹Ÿå¯ä»¥æœ‰ä¸€ä¸ªé‡è¯•çš„è¿‡ç¨‹ã€‚ 3. å¦‚æœè¿™æ˜¯ä¸€ä¸ªå…¬å…±ä¸­é—´ä»¶-åŸºäºRPC æ¥å£å®ç°çš„å¯é æ¶ˆæ¯ä¸­å¿ƒä»¥ä¸Šè®¨è®ºçš„æ–¹æ¡ˆï¼Œ éƒ½æ˜¯åŸºäºæ¶ˆæ¯è¡¨é€»è¾‘å’Œä¸šåŠ¡é€»è¾‘åŒä¸€ä¸ªæœåŠ¡ä¸­ï¼Œ å¦‚æœæŠŠè¯¥åŠŸèƒ½åšæˆä¸€ä¸ªå…¬å…±ä¸­é—´ä»¶ï¼Œé‚£ä¹ˆåœ¨æŠ€æœ¯æ–¹æ¡ˆä¸Šä¼šç•¥æœ‰å˜åŒ–ã€‚ ä¸­é—´ä»¶éœ€è¦æä¾›çš„åŠŸèƒ½ ä¸¤é˜¶æ®µæäº¤åŠŸèƒ½ å›æŸ¥åŠŸèƒ½ æ¶ˆæ¯è½¬å‘ ä»¥ä¸Š3ä¸ªåŠŸèƒ½å’Œä¸Šä¸€ç§æ–¹æ¡ˆæ²¡æœ‰æœ¬è´¨ä¸Šçš„åŒºåˆ«ï¼Œ åªæ˜¯åŸºäºä¸€ä¸ªä¸­é—´ä»¶çš„å®šä½ï¼Œæ”¯æŒè¿™3ç§åŠŸèƒ½éœ€è¦æ›´å¤šçš„å°è£…ä¸æ•°æ®ä¿¡æ¯ã€‚ 3.1 ä¸šåŠ¡æµç¨‹ 3.2 ä¸¤é˜¶æ®µæäº¤åŠŸèƒ½æä¾›3ä¸ªRPC æ¥å£ï¼Œ prepareï¼Œ commit, rollback, æ¥å£åº•å±‚å°è£…å¯¹æ•°æ®è¡¨çš„æ“ä½œ 3.3 æ¶ˆæ¯å”¯ä¸€æ€§å½“ä½œä¸ºä¸€ä¸ªå…¬å…±ä¸­é—´ä»¶ï¼Œæ¥å—å¤šä¸ªä¸šåŠ¡æ•°æ®çš„æ—¶å€™ï¼Œæ¶ˆæ¯çš„å”¯ä¸€æ€§åº”è¯¥æœ‰ä¸šåŠ¡æ ‡è¯† + æ¶ˆæ¯æ ‡è¯†å…±åŒç¡®å®šï¼Œå³bizId + messageKey 3.4 å›æŸ¥åŠŸèƒ½ç›¸æ¯”äºç›´æ¥åœ¨ä¸šåŠ¡æœåŠ¡é‡Œé›†æˆå¯é æ¶ˆæ¯çš„åŠŸèƒ½æ—¶ï¼Œå¯ä»¥ç®€å•ç›´æ¥çš„åœ¨æœåŠ¡å†…éƒ¨æŸ¥è¯¢ï¼Œå½“ä½œä¸ºå…¬å…±ä¸­é—´ä»¶æ—¶ï¼Œ åªèƒ½é€šè¿‡æœåŠ¡é—´è°ƒç”¨å®Œæˆï¼ŒæœåŠ¡é—´è°ƒç”¨æœ‰ä¸¤ç§å½¢å¼ HTTP RPC ä¸ºäº†å¢åŠ å¯ç»´æŠ¤æ€§å’Œæ‹“å±•å‹ï¼Œ æ— è®ºæ˜¯å“ªç§å½¢å¼ï¼Œä¸­é—´ä»¶éƒ½åº”è¯¥å®šä¹‰å¥½è°ƒç”¨çš„æ ¼å¼ï¼Œè®©æ¶ˆæ¯ç”Ÿäº§è€…æŒ‰ç…§ç»Ÿä¸€æ ¼å¼æä¾›å›æŸ¥æ¥å£ã€‚ è¿™ä¸ªæ ¼å¼åŒ…æ‹¬ æ¥å£å®šä¹‰ æ¥å£å…¥å‚ æ¥å£è¿”å›å€¼ å…¶ä¸­æ¥å£å®šä¹‰ä¿¡æ¯éœ€è¦ç”Ÿäº§æ¶ˆæ¯æ—¶æä¾› åœ¨å®ç°æ¶ˆæ¯ç”Ÿäº§è€…æŒ‰ç…§ç»Ÿä¸€æ ¼å¼æä¾›å›æŸ¥æ¥å£ è¿™ä¸€ç‚¹æ˜¯ï¼ŒHTTPæ¥å£çš„å›æŸ¥ç›¸å¯¹ç®€å•ï¼Œ å¦‚æœRPC æ¥å£ï¼Œ è¦æ³¨æ„ä½¿ç”¨æ³›åŒ–è°ƒç”¨ã€‚ æœ¬é¡¹ç›®å®ç°äº†HTTP æ¥å£çš„å›æŸ¥å’Œ Dubbo åè®®çš„æ³›åŒ–è°ƒç”¨å›æŸ¥ HTTPæ¥å£æ ¼å¼ä¸º1http://127.0.0.1:8082/verifyMessage?bizID=1&amp;messageKey=key1 Dubbo RPC æ¥å£å®šä¹‰ä¸º12345public interface VerifyMessageService &#123; // æ¶ˆæ¯å›æŸ¥æ¥å£ int verifyMessage(Integer bizID,String messageKey); &#125; 3.5 æ¶ˆæ¯è½¬å‘åœ¨ä¸€ä¸ªå…¬å…±ä¸­é—´ä»¶é‡Œå®ç°æ¶ˆæ¯è½¬å‘ï¼Œå¿…ç„¶ä¹Ÿéœ€è¦ç”Ÿäº§æ¶ˆæ¯æ—¶æä¾›è¿™éƒ¨åˆ†ä¿¡æ¯12forward_topic VARCHAR(255) COMMENT &#x27;ä¸šåŠ¡è½¬å‘topic&#x27;, forward_key VARCHAR(255) COMMENT &#x27;ä¸šåŠ¡è½¬å‘æŒ‡å®škey&#x27;, 3.6 æ¶ˆæ¯è¡¨è®¾è®¡12345678910111213141516171819CREATE TABLE message (\tid bigint unsigned NOT NULL AUTO_INCREMENT, biz_id INT NOT NULL COMMENT &#x27;ä¸šåŠ¡ID&#x27;, message_key VARCHAR(255) COMMENT &#x27;æ¶ˆæ¯å”¯ä¸€é”®ï¼Œç”¨äºåšå›æŸ¥çš„æ ‡è¯†&#x27;,\tmessage text COMMENT &#x27;æ¶ˆæ¯å†…å®¹&#x27;,\tmessage_status INT DEFAULT 1 COMMENT &#x27;æ¶ˆæ¯çŠ¶æ€ 1-prepare 2-commit 3-rollback 4-verify fail&#x27;, forward_topic VARCHAR(255) NOT NULL COMMENT &#x27;ä¸šåŠ¡è½¬å‘topic&#x27;,\tforward_key VARCHAR(255) COMMENT &#x27;ä¸šåŠ¡è½¬å‘æŒ‡å®škey&#x27;, verify_info VARCHAR(2000) COMMENT &#x27;å›æŸ¥ä¿¡æ¯&#x27;,\tverify_try_count INT DEFAULT 0 COMMENT &#x27;æ¶ˆæ¯çŠ¶æ€å›æŸ¥ å½“å‰é‡è¯•æ¬¡æ•°&#x27;,\tverify_next_retry_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;æ¶ˆæ¯çŠ¶æ€å›æŸ¥ ä¸‹æ¬¡é‡è¯•æ—¶é—´&#x27;,\tsend_status INT DEFAULT 0 COMMENT &#x27;0-æŠ•é€’ä¸­ 1-æŠ•é€’æˆåŠŸ 2-æŠ•é€’å¤±è´¥&#x27;,\tsend_try_count INT DEFAULT 0 COMMENT &#x27;commitæ¶ˆæ¯å‘é€ å½“å‰é‡è¯•æ¬¡æ•°&#x27;,\tsend_next_retry_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;æ¶ˆæ¯å‘é€ ä¸‹æ¬¡é‡è¯•æ—¶é—´&#x27;,\tcreate_time DATETIME DEFAULT CURRENT_TIMESTAMP,\tupdate_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\tPRIMARY KEY (id),\tUNIQUE INDEX idx_message_key_biz_id (message_key, biz_id)) ENGINE=InnoDB; 4. åŸºäºkafka æäº¤æ¶ˆæ¯å®ç°çš„å¯é äº‹ä»¶ä¸­å¿ƒåœ¨å®ç°æ¶ˆæ¯å›æŸ¥çš„å¯é æ¶ˆæ¯ä¸­å¿ƒæ–¹æ¡ˆä¸­ï¼Œå¦å¤–ä¸€ç§å¸¸è§çš„æ–¹æ¡ˆæ˜¯ ä¸šåŠ¡ä»£ç ç›´æ¥æŠŠæ¶ˆæ¯æäº¤ç»™kafka, ç„¶åä¸­é—´ä»¶æ¶ˆè´¹æ¶ˆæ¯å¹¶æŒä¹…åŒ–é“æ•°æ®åº“ä¸­ï¼Œç­‰å¾…æ¶ˆæ¯æäº¤commit æˆ–è€…rollback , æ²¡æœ‰çš„è¯å°±è¿›è¡Œå›æŸ¥ã€‚å¦‚ä¸‹å›¾ï¼Œå›¾ç‰‡æºè‡ªæå®¢æ—¶é—´ä¸“æ  æˆ‘è®¤ä¸ºä¸¤ç§æŠ€æœ¯æ–¹æ¡ˆæ²¡æœ‰æœ¬è´¨çš„åŒºåˆ«ï¼Œ å…¶å·®å¼‚åªæ˜¯æ¶ˆæ¯çš„prepare ã€commitã€rollback çš„æäº¤æ˜¯ç”±RPC æ¥å£å®Œæˆè¿˜æ˜¯ç”±æ¶ˆæ¯ç”Ÿäº§æ¶ˆè´¹å®Œæˆï¼Œ å…¶ä»–å›æŸ¥çš„é€»è¾‘ã€å‘é€é€»è¾‘ã€ä»¥åŠéœ€è¦çš„ä¿¡æ¯åŸºæœ¬æ— å·®å¼‚ã€‚ ä¸è¿‡åœ¨ä½¿ç”¨Kafka æäº¤æ—¶ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§éœ€è¦è€ƒè™‘ 4.1 ä¸­é—´ä»¶å¦‚ä½•è¯†åˆ«ä¸€æ¡æ¶ˆæ¯æ˜¯äº‹åŠ¡æ¶ˆæ¯ Topicå‘½åçº¦å®š ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯é€šè¿‡Topicå‘½åæ¥åŒºåˆ†ã€‚ä¾‹å¦‚ï¼Œæ‰€æœ‰éœ€è¦æ”¯æŒå›æŸ¥çš„Topicå¯ä»¥éµå¾ªä¸€ä¸ªç‰¹å®šçš„å‘½åæ¨¡å¼ï¼Œå¦‚æ·»åŠ å‰ç¼€æˆ–åç¼€ï¼ˆä¾‹å¦‚ï¼Œreplayable-myTopicï¼‰ã€‚è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯ç®€å•æ˜“å®æ–½ï¼Œä½†ç¼ºç‚¹æ˜¯çµæ´»æ€§è¾ƒä½ï¼Œä¸”å¯¹ç°æœ‰ç³»ç»Ÿå¯èƒ½éœ€è¦æ›´å¤šçš„æ”¹åŠ¨ã€‚ ç‰¹å®šä¸»é¢˜æˆ–åˆ†åŒº å°†éœ€è¦å›æŸ¥çš„æ¶ˆæ¯å‘é€åˆ°Kafkaçš„ç‰¹å®šä¸»é¢˜æˆ–åˆ†åŒºä¸­ã€‚è¿™æ ·ï¼Œä¸­é—´ä»¶åªéœ€ç›‘å¬è¿™ä¸ªç‰¹å®šçš„ä¸»é¢˜æˆ–åˆ†åŒºæ¥å¤„ç†éœ€è¦å›æŸ¥çš„æ¶ˆæ¯ã€‚è¿™ç§æ–¹æ³•è¦æ±‚ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯æ—¶çŸ¥é“å“ªäº›æ¶ˆæ¯éœ€è¦å›æŸ¥ï¼Œå¹¶æ®æ­¤å‘é€åˆ°æ­£ç¡®çš„ä¸»é¢˜æˆ–åˆ†åŒºã€‚ Topicé…ç½®å±æ€§ Kafkaå…è®¸ä¸ºæ¯ä¸ªTopicè®¾ç½®è‡ªå®šä¹‰é…ç½®å±æ€§ã€‚å¯ä»¥å¼•å…¥ä¸€ä¸ªè‡ªå®šä¹‰å±æ€§ï¼ˆå¦‚replayable=trueï¼‰æ¥æ ‡è¯†ä¸€ä¸ªTopicéœ€è¦æ”¯æŒæ¶ˆæ¯å›æŸ¥ã€‚è¿™ç§æ–¹å¼æ¯”å‘½åçº¦å®šæ›´ä¸ºçµæ´»å’Œéšè”½ï¼Œä½†è¦æ±‚åº”ç”¨å±‚å’Œæ¶ˆæ¯ç”Ÿäº§è€…éµå¾ªè¿™ä¸€çº¦å®šï¼Œå¹¶ä¸”éœ€è¦åœ¨åº”ç”¨å±‚å®ç°é€»è¾‘æ¥å¤„ç†è¿™äº›å±æ€§ã€‚ æ¶ˆæ¯å…ƒæ•°æ®æ ‡è®° åœ¨æ¶ˆæ¯å‘é€æ—¶ï¼Œå¯ä»¥åœ¨æ¶ˆæ¯çš„å…ƒæ•°æ®ï¼ˆMetadataï¼‰ä¸­æ·»åŠ ç‰¹å®šçš„æ ‡è®°æˆ–å­—æ®µæ¥æŒ‡ç¤ºè¿™æ¡æ¶ˆæ¯éœ€è¦è¿›è¡Œå›æŸ¥ã€‚ è®¾è®¡è€ƒè™‘ï¼š æ€§èƒ½ï¼šç¡®å®šè¿™äº›æ–¹æ³•ä¸­å“ªä¸€ç§å¯¹ç”Ÿäº§å’Œæ¶ˆè´¹çš„æ€§èƒ½å½±å“æœ€å°ã€‚ æ˜“ç”¨æ€§ï¼šé€‰æ‹©æ˜“äºå®æ–½å’Œç»´æŠ¤çš„æ–¹æ³•ã€‚ çµæ´»æ€§ï¼šè¯„ä¼°æ˜¯å¦éœ€è¦å¯¹å•ä¸ªæ¶ˆæ¯è¿›è¡Œæ ‡è®°ï¼Œè¿˜æ˜¯ä»¥Topicä¸ºå•ä½è¿›è¡ŒåŒºåˆ†ã€‚ 4.2 å¦‚ä½•è¯†åˆ«æ¶ˆæ¯ç±»å‹ã€è½¬å‘ä¿¡æ¯ã€å›æŸ¥ä¿¡æ¯æ¶ˆæ¯ç±»å‹åŒ…æ‹¬ prepareã€commitã€rollbackè½¬å‘ä¿¡æ¯,éœ€è¦è½¬å‘è‡³çš„çœŸæ­£ä¸šåŠ¡tpoicã€ å¦‚æœéœ€è¦æŒ‡å®šåˆ†åŒºçš„è¯è¿˜åŒ…æ‹¬keyä¿¡æ¯å›æŸ¥ä¿¡æ¯ï¼ŒåŒ…æ‹¬å›æŸ¥æ–¹å¼å¦‚HTTPã€RPC, å›æŸ¥åœ°å€ï¼Œå›æŸ¥æ¥å£ç­‰ ä½¿ç”¨Kafkaæ¶ˆæ¯å¤´ ä¼˜ç‚¹ï¼š ä¿æŒäº†æ¶ˆæ¯ä½“çš„çº¯å‡€å’Œç‹¬ç«‹æ€§ã€‚ çµæ´»æ€§é«˜ï¼Œæ˜“äºæ·»åŠ æˆ–ä¿®æ”¹é¢å¤–çš„æ§åˆ¶ä¿¡æ¯å’Œå…ƒæ•°æ®ã€‚ æ€§èƒ½è€ƒè™‘ï¼Œå¯¹äºå°åˆ°ä¸­ç­‰å¤§å°çš„æ¶ˆæ¯ï¼Œä½¿ç”¨æ¶ˆæ¯å¤´çš„æ€§èƒ½å¼€é”€ç›¸å¯¹è¾ƒå°ç¼ºç‚¹ï¼š æ–°ç‰ˆæœ¬ä¾èµ–ï¼šè¾ƒæ—§ç‰ˆæœ¬çš„Kafkaå®¢æˆ·ç«¯å¯èƒ½ä¸æ”¯æŒæ¶ˆæ¯å¤´åŠŸèƒ½ï¼Œè¿™è¦æ±‚ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä½¿ç”¨æ”¯æŒæ¶ˆæ¯å¤´çš„Kafkaç‰ˆæœ¬ã€‚ é¢å¤–å¤„ç†ï¼šæ¶ˆè´¹è€…éœ€è¦é¢å¤–çš„æ­¥éª¤æ¥è¯»å–å’Œè§£ææ¶ˆæ¯å¤´ã€‚ é¢„å…ˆå®šä¹‰æ¶ˆæ¯æ ¼å¼ ä¼˜ç‚¹ï¼š ç›´æ¥ä¸”ç®€å•ï¼Œæ˜“äºå®ç°ã€‚ ä¸ä¾èµ–Kafkaç‰¹å®šçš„åŠŸèƒ½ï¼Œå…·æœ‰è¾ƒå¥½çš„å…¼å®¹æ€§ã€‚ç¼ºç‚¹ï¼š å¢åŠ äº†æ¶ˆæ¯ä½“çš„å¤§å°ã€‚ éœ€è¦åœ¨æ¶ˆè´¹ç«¯è¿›è¡Œæ¶ˆæ¯è§£æï¼Œç•¥å¾®å¢åŠ äº†å¤„ç†çš„å¤æ‚æ€§ã€‚ æœ¬é¡¹ç›®ä»¥æŒ‡å®štopic+é¢„å®šä¹‰æ¶ˆæ¯æ ¼å¼çš„æ–¹å¼ç®€å•å®ç°äº†æ¶ˆæ¯çš„æäº¤ï¼Œæ¶ˆæ¯æ ¼å¼å¦‚ä¸‹ï¼Œ å¤§å®¶å¯ä»¥å‚è€ƒã€‚12345678910111213141516171819202122232425262728package com.example.trustmessage.middlewareapi.common;public class MiddlewareMessage &#123; // è¦ç»™åˆ°ä¸šåŠ¡æ–¹çš„çœŸæ­£æ¶ˆæ¯ private String message; private int bizID; // ç”¨äºæ¶ˆæ¯å›æŸ¥çš„ä¸šåŠ¡å”¯ä¸€æ ‡è¯† private String messageKey; private int messageStatus; private String forwardTopic; // å‘ä¸šåŠ¡æ–¹è½¬å‘æ—¶éœ€è¦æŒ‡å®šçš„keyï¼Œæ²¡æœ‰åˆ™è¯´æ˜æŒ‰ç…§kafka é»˜è®¤åˆ†åŒºç­–ç•¥è¿›è¡Œåˆ†åŒº private String forwardKey; private VerifyInfo verifyInfo; public static class VerifyInfo &#123; private int protocolType; // 1-http, 2-rpc-dubbo private String registryProtocol; private String registryAddress; private String url; private String version; &#125; &#125; 5. åŸºäºRPCæ¥å£ vs åŸºäºKafkaæäº¤åŸºäºä¸¤ç§ä¸åŒæ¶ˆæ¯æäº¤æ–¹å¼å®ç°çš„ä¸­é—´ä»¶ï¼Œ å°†ä»ä»¥ä¸‹ä¸¤æ–¹é¢è¿›è¡Œæ¯”è¾ƒ æ¶ˆæ¯çš„é¡ºåºæ€§ æµé‡å¢åŠ åæ‰©å®¹ 5.1 æ¶ˆæ¯çš„é¡ºåºæ€§ä½¿ç”¨ä¸­é—´ä»¶å›æŸ¥æœºåˆ¶ï¼Œç”±äºç½‘ç»œåŸå› ï¼Œæœ‰å¯èƒ½å‡ºç° æŸæ¡ä¸šåŠ¡çš„commit or rollback æ¶ˆæ¯æ¯”prepare å…ˆåˆ°è¾¾ä¸­é—´ä»¶ï¼Œé¢å¯¹è¿™ç§æƒ…å†µ,commit or rollbackçš„å¤„ç†é€»è¾‘æ˜¯éœ€è¦æŠ¥é”™çš„ï¼Œclient åªèƒ½é‡è¯•æˆ–è€…ç­‰å¾…å›æŸ¥æœºåˆ¶æ›´æ–°æ¶ˆæ¯çŠ¶æ€ ä½†æ˜¯ç”±äºkafka å¯ä»¥åœ¨ä¸€ä¸ªåˆ†åŒºå†…çš„ä¿è¯æ¶ˆæ¯çš„æœ‰åºæ€§ï¼Œæ‰€ä»¥åŸºäºKafkaæäº¤çš„æ–¹æ¡ˆå¯ä»¥æœ‰ä¸€ç§ä¼˜é›…çš„æ–¹å¼ä¿è¯prepareæ¶ˆæ¯å’Œcommit/rollback æ¶ˆæ¯çš„æœ‰åºæ€§ã€‚ è§£å†³æ–¹æ¡ˆå¾ˆç®€å•ï¼Œç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯æŒ‰ç…§ä¸šåŠ¡ å”¯ä¸€æ ‡è¯†æŒ‡å®škey ,å³æŒ‡å®šç›®æ ‡åˆ†åŒºå³å¯ã€‚ 5.2 æµé‡å¢åŠ åæ‰©å®¹ä»¥ä¸‹æ¯”è¾ƒåŸºäºåœ¨ä»£ç å±‚é¢å·²ç»åšå¥½åˆ†åº“åˆ†è¡¨ã€å¼‚æ­¥å¤„ç†ã€æ‰¹é‡å¤„ç†ã€cache ç­‰æ€§èƒ½ä¼˜åŒ–çš„åŸºç¡€ä¸Š å‡è®¾å·²ç»åˆ†åº“åˆ†è¡¨ï¼Œæ•°æ®åº“å¤„ç†ä¸æ˜¯ç“¶é¢ˆä¸‡ä¸€æµé‡æ¿€å¢ï¼ŒåŸºäºKafkaæäº¤çš„æ–¹æ¡ˆ å¯èƒ½ä¼šäº§ç”Ÿäº§ç”Ÿå¿…é¡»è¦å¤„ç†çš„æ¶ˆæ¯ç§¯å‹ï¼Œé’ˆå¯¹æ¶ˆæ¯ç§¯å‹å¸¸è§çš„è§£å†³æ–¹æ¡ˆä¸­ å¢åŠ æ¶ˆè´¹è€…æ•°é‡ï¼Œä¸è¿‡ä¸€èˆ¬æ¥è®²ï¼Œçº¿ä¸Šç”Ÿäº§ç¯å¢ƒéƒ½ä¼šå·²ç»æŠŠæ¶ˆè´¹è€…æ•°é‡å’Œåˆ†åŒºæ•°é‡è®¾ç½®æˆä¸€æ ·çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ¡ˆæ— æ³•å‘æŒ¥åŠŸèƒ½ å¢åŠ åˆ†åŒºæ•°é‡ï¼Œå‡è®¾å…¬å¸çš„å·¥ä½œæµç¨‹é‡Œå…è®¸å¢åŠ ï¼Œå¦‚æœä½¿ç”¨åœºæ™¯å¯¹æ¶ˆæ¯é¡ºåºæ€§æœ‰è¦æ±‚ï¼Œä½ åˆè¦è€ƒè™‘æ–°å¢åˆ†åŒºåå¯¹æ¶ˆæ¯é¡ºåºæ€§çš„å½±å“ æ–°å»ºä¸€ä¸ªæ›´å¤šåˆ†åŒºçš„topic, æ¶‰åŠåˆ°ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…çš„ä»£ç å˜æ›´ æ¶ˆè´¹è€…æ€§èƒ½ä¼˜åŒ–ï¼Œ æ¯”å¦‚å¼‚æ­¥å¤„ç†ã€æ‰¹é‡å¤„ç†ï¼Œ ä½†æ˜¯å¦‚æœé¡¹ç›®å·²ç»åšå¥½è¿™äº›æªæ–½ï¼Œé¢å¯¹æ¶ˆæ¯ç§¯å‹ï¼Œåªèƒ½å›åˆ°ä¸‹é¢3ç§æ–¹å¼ ç»¼åˆä»¥ä¸Šï¼Œæˆ‘ä¸ªäººè®¤ä¸ºåŸºäºRPCæ¥å£çš„æ–¹æ¡ˆå¯ä»¥ç”¨è‡ªåŠ¨æ‰©å®¹ç­–ç•¥ç›´æ¥åº”å¯¹ï¼Œ ç®€å•ç›´æ¥ä¼˜é›…ã€‚ 6. ä½œä¸ºä¸­é—´ä»¶çš„æŠ€æœ¯è®¾è®¡6.1 æ€§èƒ½æå‡ çº¿ç¨‹æ± å¼‚æ­¥å¤„ç† cache å­˜å‚¨å›æŸ¥æ¥å£ åŸºäºbizID + messageKey çš„åˆ†åº“åˆ†è¡¨ 6.2 å¹‚ç­‰æ€§ prepare æ¶ˆæ¯çš„å¹‚ç­‰æ€§ï¼Œ å”¯ä¸€ç´¢å¼•","tags":["äº‹åŠ¡"]},{"title":"æ·±å…¥è§£æbloom filterçš„åŸç†ä¸å®ç°","path":"/b4fa673f/","content":"0.ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šç”¨åˆ°bloom filter ç¼“å­˜ç©¿é€ çˆ¬è™«é‡å¤ URL æ£€æµ‹ï¼Œ é¿å…çˆ¬è™«è¿‡ç¨‹å½¢æˆç¯ å‡è®¾æœ‰ 10 äº¿æ¡æ‰‹æœºå·ï¼Œç„¶ååˆ¤æ–­æŸæ¡æ‰‹æœºå·æ˜¯å¦åœ¨åˆ—è¡¨å†… å”¯ä¸€æ˜µç§°åˆ¤æ–­ è¿™äº›åœºæ™¯å¯ä»¥ç”¨ä»€ä¹ˆæ–¹å¼è§£å†³ hashmap, hashset MySQLï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœæ•°æ®é‡ä¸å¤§ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨ mysql å­˜å‚¨ã€‚å°†æ‰€æœ‰æ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“ï¼Œç„¶åæ¯æ¬¡å»åº“é‡ŒæŸ¥è¯¢åˆ¤æ–­æ˜¯å¦å­˜åœ¨ã€‚ä½†æ˜¯å¦‚æœæ•°æ®é‡å¤ªå¤§ï¼Œè¶…è¿‡åƒä¸‡ï¼Œmysql æŸ¥è¯¢æ•ˆç‡æ˜¯å¾ˆä½çš„ï¼Œç‰¹åˆ«æ¶ˆè€—æ€§èƒ½ã€‚ bitmap bloom filter 1.bloom filter æ˜¯ä»€ä¹ˆï¼Ÿå¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ç§æ¦‚ç‡æ€§æ•°æ®ç»“æ„ï¼Œå®ƒæä¾›äº†ä¸€ç§ç©ºé—´æ•ˆç‡æé«˜çš„æ–¹æ³•æ¥æµ‹è¯•ä¸€ä¸ªå…ƒç´ æ˜¯å¦å±äºä¸€ä¸ªé›†åˆã€‚ å…¶åŸºæœ¬åŸç†æ˜¯ä½¿ç”¨å¤šä¸ªä¸åŒçš„å“ˆå¸Œå‡½æ•°å¯¹å…ƒç´ è¿›è¡Œå“ˆå¸Œï¼Œç„¶åå°†å¾—åˆ°çš„å“ˆå¸Œå€¼å¯¹åº”åˆ°ä½æ•°ç»„ä¸Šã€‚ä¸€ä¸ªå…ƒç´ è¢«åŠ å…¥åˆ°é›†åˆä¸­ï¼Œé‚£ä¹ˆæ‰€æœ‰å“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºçš„ä½ç½®éƒ½ä¼šè¢«ç½®ä¸º1ã€‚æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­æ—¶ï¼Œä½¿ç”¨è¿™äº›å“ˆå¸Œå‡½æ•°è®¡ç®—å“ˆå¸Œå€¼ï¼Œå¹¶æ£€æŸ¥å¯¹åº”çš„ä½æ˜¯å¦éƒ½æ˜¯1ã€‚å¦‚æœéƒ½æ˜¯1ï¼Œé‚£ä¹ˆå…ƒç´ å¯èƒ½å­˜åœ¨äºé›†åˆä¸­ï¼›å¦‚æœä»»ä½•ä¸€ä¸ªä½ä¸æ˜¯1ï¼Œé‚£ä¹ˆå…ƒç´ è‚¯å®šä¸åœ¨é›†åˆä¸­ã€‚ å…¶ä¸»è¦ç‰¹ç‚¹æ˜¯ï¼š é«˜ç©ºé—´æ•ˆç‡ï¼šç›¸æ¯”äºä¼ ç»Ÿçš„é›†åˆæ•°æ®ç»“æ„ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ä½¿ç”¨æå°‘çš„ç©ºé—´æ¥å¤„ç†å¤§é‡æ•°æ®ã€‚ è¯¯æŠ¥ç‡/å‡é˜³ï¼šå¸ƒéš†è¿‡æ»¤å™¨æœ‰ä¸€å®šçš„è¯¯æŠ¥æ¦‚ç‡ï¼Œè¿™æ„å‘³ç€å®ƒå¯èƒ½ä¼šé”™è¯¯åœ°è®¤ä¸ºæŸä¸ªä¸åœ¨é›†åˆä¸­çš„å…ƒç´ å­˜åœ¨äºé›†åˆä¸­ã€‚ é›¶æ¼æŠ¥ç‡ï¼šä¸ä¼šé—æ¼é›†åˆä¸­çœŸæ­£å­˜åœ¨çš„å…ƒç´  ä¸å¯åˆ é™¤ï¼šæ ‡å‡†çš„å¸ƒéš†è¿‡æ»¤å™¨ä¸æ”¯æŒä»é›†åˆä¸­åˆ é™¤å…ƒç´ ï¼Œå°½ç®¡å­˜åœ¨å˜ç§ï¼ˆå¦‚è®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ï¼‰æ”¯æŒè¿™ä¸€æ“ä½œã€‚ å¤šå“ˆå¸Œå‡½æ•°ï¼šå¸ƒéš†è¿‡æ»¤å™¨é€šè¿‡å¤šä¸ªå“ˆå¸Œå‡½æ•°æ¥å‡å°‘è¯¯æŠ¥ç‡ï¼Œæ¯ä¸ªå…ƒç´ è¢«å¤šä¸ªå“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°ä½æ•°ç»„çš„å¤šä¸ªä½ç½®ã€‚ 1.1 ä¸ºä»€ä¹ˆç©ºé—´æ•ˆç‡é«˜bloom filter é‡‡ç”¨ ä½æ•°ç»„ï¼ˆbit arrayï¼‰ä½œä¸ºæ ¸å¿ƒçš„æ•°æ®ç»“æ„ã€‚ ä½æ•°ç»„æ˜¯ä¸€ä¸ªéå¸¸ç´§å‡‘çš„æ•°æ®ç»“æ„ï¼Œå®ƒå¯ä»¥æœ‰æ•ˆåœ°è¡¨ç¤ºå¤§é‡çš„å¸ƒå°”å€¼ï¼ˆtrueæˆ–falseï¼‰ï¼Œæ¯ä¸ªå€¼åªå ç”¨ä¸€ä¸ªä½ï¼ˆbitï¼‰ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æ›´ä¼ ç»Ÿçš„æ•°æ®ç±»å‹ä¼šå ç”¨æ›´å¤šçš„ç©ºé—´ã€‚ æ¯”å¦‚åœ¨çˆ¬è™«åœºæ™¯ä¸­ï¼Œå‡è®¾æœ‰1äº¿ä¸ªURLï¼Œæ¯ä¸ªURLç®—4å­—èŠ‚, å¦‚æœç”¨hashmap å®ç°ï¼Œä¸€ä¸ªURLæ‰€å ç©ºé—´è‡³å°‘4bytes;å¦‚æœç”¨ä½æ•°ç»„å®ç°ï¼Œæ¯ä¸ªURL æ‰€å çš„ç©ºé—´ä»…1bitï¼Œç©ºé—´æ•ˆç‡æå‡äº†32å€ï¼ˆå­˜å‚¨ç©ºé—´ä¸è€ƒè™‘è¯¯åˆ¤ç‡çš„å‰æä¸‹ï¼‰ã€‚ä¸å¯è°“ä¸é«˜æ•ˆã€‚ 1.2 ä¸ºä»€ä¹ˆä¼šæœ‰è¯¯æŠ¥ç‡/å‡é˜³æ—¢ç„¶ç”¨åˆ°äº†å“ˆå¸Œå‡½æ•°ï¼Œè‚¯å®šä¼šé‡åˆ°å“ˆå¸Œå†²çªã€‚æ‰€ä»¥ä¸€ä¸ªå…ƒç´ å¯¹åº” çš„n ä¸ªä½ç½®ï¼Œ å¯èƒ½å› ä¸ºå…¶ä»–å…ƒç´ çš„å“ˆå¸Œå†²çª è€Œå¯¼è‡´åˆ¤æ–­æ—¶å‘ç°ç­‰äº1ï¼Œ ä»è€Œäº§ç”Ÿå‡é˜³ç°è±¡ã€‚ 1.3 è¯¯æŠ¥å¦‚ä½•è§£å†³å‡é˜³é—®é¢˜æ— æ³•è¢«é¿å…ï¼Œåªèƒ½å°½å¯èƒ½å‡å°‘ã€‚ å‡å°‘çš„é€”å¾„æ˜¯é€‰æ‹©åˆé€‚çš„å“ˆå¸Œå‡½æ•°ä»¥åŠæŒ‡å®šåˆé€‚çš„ç©ºé—´å¤§å° 1.4 ä¸ºä»€ä¹ˆéœ€è¦å¤šä¸ªå“ˆå¸Œå‡½æ•°å¸ƒéš†è¿‡æ»¤å™¨çš„è®¾è®¡ä½¿ç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°æ¥è§£å†³å•ä¸ªå“ˆå¸Œå‡½æ•°å¯èƒ½å¸¦æ¥çš„å±€é™æ€§ï¼Œæé«˜å…¶æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚å…·ä½“æ¥è¯´ï¼Œä½¿ç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°çš„åŸå› åŒ…æ‹¬ï¼š é™ä½è¯¯æŠ¥ç‡ é€šè¿‡ä½¿ç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°ç‹¬ç«‹åœ°æ˜ å°„æ¯ä¸ªå…ƒç´ åˆ°ä½æ•°ç»„ä¸­çš„å¤šä¸ªä½ç½®ï¼Œå¹¶åœ¨æ‰€æœ‰è¿™äº›ä½ç½®ä¸Šæ ‡è®°ä¸º1ï¼Œå¯ä»¥æ˜¾è‘—é™ä½ä¸åŒå…ƒç´ æ˜ å°„åˆ°ç›¸åŒä½ç½®ï¼ˆå³äº§ç”Ÿå†²çªï¼‰çš„æ¦‚ç‡ï¼Œä»è€Œé™ä½è¯¯æŠ¥ç‡ å‡åŒ€åˆ†å¸ƒ å¤šä¸ªå“ˆå¸Œå‡½æ•°å¯ä»¥å°†å…ƒç´ æ›´å‡åŒ€åœ°åˆ†å¸ƒåœ¨ä½æ•°ç»„ä¸Šï¼Œå‡å°‘äº†é›†ä¸­å†²çªçš„å¯èƒ½æ€§ã€‚å¦‚æœåªä½¿ç”¨ä¸€ä¸ªå“ˆå¸Œå‡½æ•°ï¼Œå³ä½¿å…¶åˆ†å¸ƒæ€§è´¨è‰¯å¥½ï¼Œä¹Ÿéš¾ä»¥ä¿è¯å¯¹äºæ‰€æœ‰å¯èƒ½çš„è¾“å…¥é›†åˆéƒ½èƒ½ä¿æŒè‰¯å¥½çš„å‡åŒ€æ€§ã€‚å¤šä¸ªå“ˆå¸Œå‡½æ•°çš„ç»„åˆï¼Œå¦‚æœè®¾è®¡å¾—å½“ï¼Œå¯ä»¥ç›¸äº’è¡¥å¿ï¼Œå®ç°æ›´ä¸ºå‡åŒ€çš„åˆ†å¸ƒã€‚ 1.5 ä¸ºä»€ä¹ˆæ•°æ®ä¸å¯åˆ é™¤åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå…ƒç´ çš„å­˜åœ¨æ˜¯é€šè¿‡å¤šä¸ªä½çš„â€œ1â€çŠ¶æ€æ¥è¡¨ç¤ºçš„ï¼Œè€Œå°†è¿™äº›ä½é‡ç½®ä¸ºâ€œ0â€å¯èƒ½ä¼šé”™è¯¯åœ°å½±å“å…¶ä»–å…ƒç´ çš„å­˜åœ¨æ£€æµ‹ã€‚ å¦‚æœéœ€è¦æ”¯æŒåˆ é™¤ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ å˜ä½“Bloom Filterï¼Œ å¦‚cuckoo filter 2. bitmap å’Œ bloom filter çš„åŒºåˆ«Bitmapï¼ˆä½å›¾ï¼‰å’Œå¸ƒéš†è¿‡æ»¤å™¨éƒ½æ˜¯ä½¿ç”¨ç©ºé—´æ•ˆç‡é«˜çš„æ•°æ®ç»“æ„ï¼Œå®ƒä»¬é€šè¿‡åˆ©ç”¨ä½æ“ä½œæ¥å®ç°å­˜å‚¨å’ŒæŸ¥è¯¢ï¼Œä½†å®ƒä»¬çš„è®¾è®¡ç›®çš„å’Œåº”ç”¨åœºæ™¯æœ‰æ‰€ä¸åŒã€‚ 2.1 Bitmapï¼ˆä½å›¾ï¼‰ä½å›¾æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œç”¨äºé«˜æ•ˆåœ°å­˜å‚¨å’ŒæŸ¥è¯¢çŠ¶æ€ä¿¡æ¯ã€‚åœ¨ä½å›¾ä¸­ï¼Œæ¯ä¸ªå…ƒç´ çš„å­˜åœ¨æˆ–çŠ¶æ€æ˜¯ç”±å•ç‹¬çš„ä½æ¥è¡¨ç¤ºçš„ï¼Œå³ä½¿ç”¨1ä½äºŒè¿›åˆ¶æ•°ï¼ˆ0æˆ–1ï¼‰æ¥è¡¨ç¤ºæ¯ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨æˆ–æŸç§ç‰¹å®šçŠ¶æ€ã€‚ ä¸»è¦ç‰¹ç‚¹å’Œç”¨é€”ï¼š ç®€å•ç›´æ¥ï¼šé€‚ç”¨äºéœ€è¦è¿½è¸ªå¤§é‡å…ƒç´ ï¼ˆå¦‚æ•´æ•°ï¼‰å­˜åœ¨ä¸å¦çš„åœºæ™¯ã€‚ ç©ºé—´æ•ˆç‡ï¼šå¯¹äºå¤§è§„æ¨¡æ•°æ®é›†ï¼Œä½å›¾ä½¿ç”¨çš„ç©ºé—´è¿œå°äºä¼ ç»Ÿçš„æ•°æ®ç»“æ„ï¼ˆå¦‚æ•°ç»„æˆ–åˆ—è¡¨ï¼‰ã€‚ éšæœºè®¿é—®ï¼šå¯ä»¥éå¸¸å¿«é€Ÿåœ°æ£€æŸ¥ä»»ä½•ä¸€ä¸ªå…ƒç´ çš„å­˜åœ¨ä¸å¦æˆ–çŠ¶æ€ã€‚ å›ºå®šå¤§å°ï¼šä½å›¾çš„å¤§å°åœ¨åˆ›å»ºæ—¶ç”±æœ€å¤§å…ƒç´ å€¼å†³å®šï¼Œå› æ­¤å…¶ç©ºé—´æ•ˆç‡ä¾èµ–äºæ•°æ®çš„åˆ†å¸ƒã€‚ BitMap çš„å®ç°java BitSetredis setbitã€getbit 2.2 åŒºåˆ« ç”¨é€”ï¼šä½å›¾ä¸»è¦ç”¨äºç²¾ç¡®è¡¨ç¤ºä¸€ä¸ªå¤§å‹æ•°æ®é›†ä¸­å…ƒç´ çš„å­˜åœ¨ä¸å¦æˆ–çŠ¶æ€ä¿¡æ¯ï¼Œè€Œå¸ƒéš†è¿‡æ»¤å™¨ç”¨äºä»¥æå°çš„ç©ºé—´æˆæœ¬åˆ¤æ–­å…ƒç´ æ˜¯å¦å¯èƒ½å­˜åœ¨äºé›†åˆä¸­ã€‚ é”™è¯¯ç‡ï¼šä½å›¾æä¾›äº†100%å‡†ç¡®çš„ç»“æœï¼ˆå‡è®¾è¶³å¤Ÿçš„ç©ºé—´æ¥è¡¨ç¤ºæ‰€æœ‰å…ƒç´ ï¼‰ï¼Œè€Œå¸ƒéš†è¿‡æ»¤å™¨å…è®¸ä¸€å®šçš„è¯¯æŠ¥ç‡ã€‚ æ“ä½œï¼šä½å›¾æ”¯æŒæ·»åŠ ã€æŸ¥è¯¢å’Œåˆ é™¤ï¼ˆé€šè¿‡ä½åè½¬ï¼‰æ“ä½œï¼Œè€Œæ ‡å‡†å¸ƒéš†è¿‡æ»¤å™¨ä¸æ”¯æŒåˆ é™¤æ“ä½œã€‚ ç©ºé—´æ•ˆç‡ä¸æ•°æ®è§„æ¨¡ï¼šå¸ƒéš†è¿‡æ»¤å™¨åœ¨è¡¨ç¤ºå¤§å‹é›†åˆæˆå‘˜èµ„æ ¼æ—¶é€šå¸¸æ¯”ä½å›¾æ›´åŠ ç©ºé—´æ•ˆç‡ï¼Œå°¤å…¶æ˜¯å½“å…ƒç´ èŒƒå›´éå¸¸å¤§ä½†å®é™…å…ƒç´ æ•°é‡ç›¸å¯¹è¾ƒå°‘æ—¶ã€‚ æ€»ä¹‹ï¼Œä½å›¾å’Œå¸ƒéš†è¿‡æ»¤å™¨å„æœ‰ä¼˜åŠ¿å’Œåº”ç”¨åœºæ™¯ï¼Œé€‰æ‹©å“ªç§æ•°æ®ç»“æ„å–å†³äºå…·ä½“éœ€æ±‚ï¼ŒåŒ…æ‹¬å¯¹ç©ºé—´æ•ˆç‡ã€å‡†ç¡®ç‡å’Œæ“ä½œç±»å‹çš„è¦æ±‚ã€‚ 3. å•æœºç‰ˆæœ¬Guava Cache æºç è§£æ3.1 create1234567public static &lt;T&gt; BloomFilter&lt;T&gt; create(Funnel&lt;T&gt; funnel, int expectedInsertions /* n */, double falsePositiveProbability) &#123; int numBits = optimalNumOfBits(expectedInsertions, falsePositiveProbability); int numHashFunctions = optimalNumOfHashFunctions(expectedInsertions, numBits); return new BloomFilter&lt;T&gt;(new BitArray(numBits), numHashFunctions, funnel, BloomFilterStrategies.MURMUR128_MITZ_32); &#125; 3.1.1 å‚æ•°è§£é‡Š funnelï¼šFunnelç±»å‹çš„å‚æ•°ï¼Œç”¨äºå°†ä»»æ„ç±»å‹çš„æ•°æ®è½¬åŒ–æˆå¸ƒéš†è¿‡æ»¤å™¨å†…éƒ¨ä½¿ç”¨çš„ä¸€ç§å½¢å¼ã€‚Funnelå®šä¹‰äº†å¦‚ä½•æŠŠå¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶æµï¼Œç„¶åå¸ƒéš†è¿‡æ»¤å™¨ä½¿ç”¨è¿™ä¸ªäºŒè¿›åˆ¶æµæ¥è®¡ç®—å…ƒç´ çš„å“ˆå¸Œå€¼ã€‚ expectedInsertionsï¼šè¿™ä¸ªå‚æ•°æŒ‡å®šäº†é¢„æœŸè¦æ’å…¥å¸ƒéš†è¿‡æ»¤å™¨çš„å…ƒç´ æ•°é‡ã€‚è¿™ä¸ªæ•°å€¼æ˜¯ä¸ºäº†ä¼˜åŒ–å¸ƒéš†è¿‡æ»¤å™¨å†…éƒ¨æ•°æ®ç»“æ„çš„å¤§å°ã€‚ falsePositiveProbabilityï¼ˆfalse positive probabilityï¼‰ï¼šè¯¯åˆ¤ç‡ã€‚è¿™æ˜¯æŒ‡ä¸€ä¸ªä¸å­˜åœ¨é›†åˆä¸­çš„å…ƒç´ è¢«åˆ¤æ–­ä¸ºå­˜åœ¨çš„æ¦‚ç‡ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œéšç€å®é™…æ’å…¥æ•°é‡çš„å¢åŠ ï¼Œå®é™…çš„è¯¯åˆ¤ç‡å¯èƒ½ä¼šä¸Šå‡ã€‚ 3.1.2 optimalNumOfBits123static int optimalNumOfBits(int expectedInsertions, double falsePositiveProbability) &#123; return (int) (-n * Math.log(p) / LN2_SQUARED); &#125; optimalNumOfBitsé€šè¿‡è®¡ç®—,å¯ä»¥å¾—åˆ°ä¸€ä¸ªåœ¨æ»¡è¶³ç‰¹å®šå‡é˜³æ€§ç‡ï¼ˆfalsePositiveProbabilityï¼‰è¦æ±‚ä¸‹ï¼Œå¯¹äºç»™å®šæ•°é‡çš„å…ƒç´ é¢„æœŸæ’å…¥é‡ï¼ˆexpectedInsertionsï¼‰ï¼Œæ‰€éœ€çš„æœ€å°‘ä½æ•°ã€‚è¿™ä½¿å¾—å¸ƒéš†è¿‡æ»¤å™¨èƒ½å¤Ÿåœ¨ä¿è¯è¯¯åˆ¤ç‡çš„å‰æä¸‹ï¼Œä½¿ç”¨æœ€å°‘çš„ç©ºé—´ã€‚è¿™ç§è®¡ç®—å¯¹äºè®¾è®¡é«˜æ•ˆä¸”ç©ºé—´èŠ‚çº¦çš„å¸ƒéš†è¿‡æ»¤å™¨è‡³å…³é‡è¦ 3.1.3 è®¡ç®—é€»è¾‘optimalNumOfBitså‡½æ•°çš„è®¡ç®—åŸºäºä»¥ä¸‹å…¬å¼ï¼Œè¿™ä¸ªå…¬å¼å¯ä»¥ä»å¸ƒéš†è¿‡æ»¤å™¨çš„ç†è®ºè¯¯åˆ¤ç‡å…¬å¼æ¨å¯¼è€Œæ¥ï¼š m æ˜¯ä½æ•°ç»„çš„é•¿åº¦ï¼ˆå³å‡½æ•°çš„è¿”å›å€¼ï¼‰ã€‚ n æ˜¯expectedInsertionsï¼Œå³é¢„æœŸçš„æ’å…¥æ•°é‡ã€‚ p æ˜¯falsePositiveProbabilityï¼Œå³æœŸæœ›çš„å‡é˜³æ€§æ¦‚ç‡ã€‚ lnâ¡2 è¡¨ç¤ºè‡ªç„¶å¯¹æ•°ã€‚è¿™ä¸ªå…¬å¼åˆ©ç”¨äº†å¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯åˆ¤ç‡ç‰¹æ€§ï¼Œé€šè¿‡æŒ‡å®šçš„å‡é˜³æ€§ç‡å’Œé¢„æœŸæ’å…¥æ•°é‡æ¥è®¡ç®—å‡ºä¸€ä¸ªæœ€ä¼˜çš„ä½æ•°ç»„é•¿åº¦ã€‚è¿™ä¸ªé•¿åº¦èƒ½å¤Ÿåœ¨æ»¡è¶³è¯¯åˆ¤ç‡è¦æ±‚çš„åŒæ—¶ï¼Œå°½å¯èƒ½åœ°å‡å°å¸ƒéš†è¿‡æ»¤å™¨æ‰€éœ€çš„ç©ºé—´ã€‚ 3.1.4 å®ç°æ³¨æ„å®é™…å®ç°æ—¶ï¼Œå¯èƒ½è¿˜éœ€è¦å¯¹è®¡ç®—ç»“æœè¿›è¡Œå–æ•´å¤„ç†ï¼Œå¹¶ç¡®ä¿ç»“æœæ˜¯ä¸€ä¸ªæ­£æ•´æ•°ã€‚æ­¤å¤–ï¼Œå®ç°å¯èƒ½è¿˜ä¼šè€ƒè™‘åˆ°æ€§èƒ½å’Œå­˜å‚¨æ•ˆç‡çš„å¹³è¡¡ï¼Œæ¯”å¦‚é€šè¿‡é™åˆ¶ä½æ•°ç»„çš„é•¿åº¦ä¸º2çš„å¹‚ç­‰ã€‚ 3.1.5 optimalNumOfHashFunctions123static int optimalNumOfHashFunctions(int n, int m) &#123; return Math.max(1, (int) Math.round(m / n * LN2)); &#125; optimalNumOfHashFunctions(expectedInsertions, numBits)è¿™ä¸ªå‡½æ•°ç”¨äºè®¡ç®—ç»™å®šæ¡ä»¶ä¸‹å¸ƒéš†è¿‡æ»¤å™¨çš„æœ€ä¼˜å“ˆå¸Œå‡½æ•°æ•°é‡ã€‚è¿™ä¸ªè®¡ç®—åŸºäºé¢„æœŸè¦æ’å…¥çš„å…ƒç´ æ•°é‡ï¼ˆexpectedInsertionsï¼‰å’Œå¸ƒéš†è¿‡æ»¤å™¨å†…éƒ¨ä½æ•°ç»„çš„å¤§å°ï¼ˆnumBitsï¼‰ã€‚ç›®çš„æ˜¯ä¸ºäº†å¹³è¡¡ç©ºé—´ä½¿ç”¨å’Œè¯¯åˆ¤ç‡ï¼Œç¡®ä¿å¸ƒéš†è¿‡æ»¤å™¨åœ¨ç»™å®šæ¡ä»¶ä¸‹å·¥ä½œå¾—æœ€æœ‰æ•ˆç‡ã€‚ è®¡ç®—é€»è¾‘ å¸ƒéš†è¿‡æ»¤å™¨çš„æ•ˆç‡å’Œè¯¯åˆ¤ç‡ä¸ä½¿ç”¨çš„å“ˆå¸Œå‡½æ•°æ•°é‡æœ‰å¾ˆå¤§å…³ç³»ã€‚å¤ªå°‘çš„å“ˆå¸Œå‡½æ•°ä¼šå¢åŠ ç¢°æ’çš„æ¦‚ç‡ï¼Œå¯¼è‡´è¯¯åˆ¤ç‡å‡é«˜ï¼›è€Œå¤ªå¤šçš„å“ˆå¸Œå‡½æ•°åˆä¼šå¯¼è‡´ä½æ•°ç»„å¿«é€Ÿå¡«æ»¡ï¼ŒåŒæ ·å¢åŠ è¯¯åˆ¤ç‡ï¼ŒåŒæ—¶è¿˜ä¼šå¢åŠ è®¡ç®—çš„å¼€é”€ã€‚ æœ€ä¼˜å“ˆå¸Œå‡½æ•°æ•°é‡çš„è®¡ç®—å…¬å¼æ˜¯ï¼šè¿™ä¸ªå…¬å¼åŸºäºä»¥ä¸‹åŸç†ï¼šç»™å®šä¸€ä¸ªå›ºå®šå¤§å°çš„ä½æ•°ç»„ï¼Œå­˜åœ¨ä¸€ä¸ªæœ€ä¼˜çš„å“ˆå¸Œå‡½æ•°æ•°é‡ï¼Œå¯ä»¥æœ€å°åŒ–ç»™å®šå…ƒç´ æ•°é‡æ¡ä»¶ä¸‹çš„è¯¯åˆ¤ç‡ã€‚è¿™ä¸ªæœ€ä¼˜æ•°é‡ç›´æ¥å…³è”äºä½æ•°ç»„çš„å¤§å°å’Œè¦å¤„ç†çš„å…ƒç´ æ•°é‡ã€‚ å…¶ä¸­ï¼š k æ˜¯æœ€ä¼˜çš„å“ˆå¸Œå‡½æ•°æ•°é‡ï¼Œ m æ˜¯ä½æ•°ç»„çš„å¤§å°ï¼ˆnumBitsï¼‰ï¼Œ n æ˜¯é¢„æœŸæ’å…¥çš„å…ƒç´ æ•°é‡ï¼ˆexpectedInsertionsï¼‰ï¼Œ lnâ¡(2) æ˜¯è‡ªç„¶å¯¹æ•°2çš„å€¼ï¼Œå¤§çº¦ç­‰äº0.693ã€‚ 3.1.6 new BitArray(numBits)Guava cache bloom filter åœ¨å®ç°ä½æ•°ç»„æ˜¯é‡‡ç”¨åˆ›å»ºlong[] + ä½ç§»æ“ä½œ 1234567891011121314151617181920212223242526static class BitArray &#123; final long[] data; BitArray(int bits) &#123; this(new long[IntMath.divide(bits, 64, RoundingMode.CEILING)]); &#125; // Used by serialization BitArray(long[] data) &#123; checkArgument(data.length &gt; 0, &quot;data length is zero!&quot;); this.data = data; &#125; void set(int index) &#123; data[index &gt;&gt; 6] |= (1L &lt;&lt; index); &#125; boolean get(int index) &#123; return (data[index &gt;&gt; 6] &amp; (1L &lt;&lt; index)) != 0; &#125; /** Number of bits */ int size() &#123; return data.length * Long.SIZE; &#125; &#125; 3.2 put12345678910111213141516MURMUR128_MITZ_32() &#123; @Override public &lt;T&gt; void put(T object, Funnel&lt;? super T&gt; funnel, int numHashFunctions, BitArray bits) &#123; // TODO(user): when the murmur&#x27;s shortcuts are implemented, update this code long hash64 = Hashing.murmur3_128().newHasher().putObject(object, funnel).hash().asLong(); int hash1 = (int) hash64; int hash2 = (int) (hash64 &gt;&gt;&gt; 32); for (int i = 1; i &lt;= numHashFunctions; i++) &#123; int nextHash = hash1 + i * hash2; if (nextHash &lt; 0) &#123; nextHash = ~nextHash; &#125; // up to here, the code is identical with the next method bits.set(nextHash % bits.size()); &#125; &#125; é¦–å…ˆï¼Œè¿™è¡Œä»£ç ä½¿ç”¨MurmurHash3ç®—æ³•ç”Ÿæˆä¸€ä¸ª128ä½çš„å“ˆå¸Œå€¼ï¼Œç„¶åå°†å…¶è½¬æ¢æˆä¸€ä¸ªlongç±»å‹çš„æ•°å€¼hash64ã€‚ funnelæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œç”¨äºå°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµï¼Œä»¥ä¾¿å“ˆå¸Œå‡½æ•°å¯ä»¥å¤„ç†ã€‚ hash64å®é™…ä¸ŠåŒ…å«ä¸¤ä¸ª32ä½çš„å“ˆå¸Œå€¼ï¼Œå®ƒä»¬å¯ä»¥ä»hash64çš„é«˜32ä½å’Œä½32ä½åˆ†åˆ«æå–ã€‚ä»hash64ä¸­æå–ä¸¤ä¸ª32ä½çš„å“ˆå¸Œå€¼hash1å’Œhash2ã€‚hash1æ˜¯ä½32ä½ï¼Œhash2æ˜¯é«˜32ä½ã€‚ æ¥ä¸‹æ¥ï¼Œä»£ç éå†ä»1åˆ°numHashFunctionsï¼ˆå¸ƒéš†è¿‡æ»¤å™¨è¦æ±‚çš„å“ˆå¸Œå‡½æ•°æ•°é‡ï¼‰ï¼Œæ¯æ¬¡å¾ªç¯è®¡ç®—ä¸€ä¸ªæ–°çš„å“ˆå¸Œå€¼nextHashã€‚è¿™ä¸ªæ–°çš„å“ˆå¸Œå€¼æ˜¯é€šè¿‡hash1 + i * hash2è®¡ç®—å¾—åˆ°çš„ï¼Œå…¶ä¸­iæ˜¯å½“å‰çš„è¿­ä»£æ¬¡æ•°ã€‚ å¦‚æœnextHashä¸ºè´Ÿæ•°ï¼Œé€šè¿‡ä½å–åæ“ä½œï¼ˆ~nextHashï¼‰å°†å…¶è½¬æ¢ä¸ºæ­£æ•°ï¼Œä»¥ä¿è¯èƒ½å¤Ÿæ­£ç¡®åœ°æ˜ å°„åˆ°ä½æ•°ç»„çš„ç´¢å¼•ä¸Šã€‚ æœ€åï¼Œä½¿ç”¨nextHash % bits.size()è®¡ç®—å¾—åˆ°çš„ç´¢å¼•å€¼åœ¨ä½æ•°ç»„ï¼ˆBitArrayï¼‰ä¸­å¯¹åº”çš„ä½ç½®ä¸Šè®¾ç½®ä½ã€‚bits.size()è¿”å›ä½æ•°ç»„çš„å¤§å°ï¼Œè¿™ç¡®ä¿äº†è®¡ç®—å¾—åˆ°çš„ç´¢å¼•å€¼ä¸ä¼šè¶…å‡ºä½æ•°ç»„çš„èŒƒå›´ã€‚ 3.2.1 å“ˆå¸Œå‡½æ•°Guava cache é‡‡ç”¨äº†éåŠ å¯†çš„å•å‘æ•£åˆ—å‡½æ•°Murmur3.MurmurHash ç”±Austin Applebyè®¾è®¡ï¼Œå› å…¶é«˜æ€§èƒ½å’Œè‰¯å¥½çš„åˆ†å¸ƒç‰¹æ€§è€Œå¹¿æ³›åº”ç”¨ã€‚MurmurHashæœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œå¦‚MurmurHash2ã€MurmurHash3ç­‰ã€‚ æ ¹æ®æœ€å¼€å§‹å¯¹bloom filter çš„å®šä¹‰ï¼Œå®ƒéœ€è¦å¤šä¸ªå“ˆå¸Œå‡½æ•°å¯¹æ•°æ®è¿›è¡Œå“ˆå¸Œæ˜ å°„ï¼Œ ä½†Guava Cache bloom filter å®ç°ä¸­å…¶å®æ²¡æœ‰ä½¿ç”¨å¤šä¸ªä¸åŒçš„å“ˆå¸Œå‡½æ•°ï¼Œè€Œæ˜¯é‡‡ç”¨äº†ä¸€ç§å«åšâ€œåŒå“ˆå¸ŒæŠ€æœ¯â€çš„æ–¹æ³•ã€‚ â€œåŒå“ˆå¸ŒæŠ€æœ¯â€çš„åŸºæœ¬æ€æƒ³æ˜¯åˆ©ç”¨ä¸¤ä¸ªå“ˆå¸Œå‡½æ•°h1(x)å’Œh2(x)ç”Ÿæˆä»»æ„æ•°é‡çš„å“ˆå¸Œå€¼ï¼Œå¯¹äºç¬¬iä¸ªå“ˆå¸Œä½ç½®ï¼Œä½¿ç”¨h1(x) + i*h2(x)çš„æ–¹å¼æ¥ç”Ÿæˆã€‚è¿™ç§æ–¹æ³•åªéœ€è¦ä¸¤æ¬¡å“ˆå¸Œæ“ä½œï¼Œå°±å¯ä»¥æ¨¡æ‹Ÿå‡ºå¤šä¸ªå“ˆå¸Œå‡½æ•°çš„æ•ˆæœï¼Œä¸”ç”Ÿæˆçš„å“ˆå¸Œåºåˆ—å…·æœ‰å¾ˆå¥½çš„å‡åŒ€åˆ†å¸ƒæ€§ï¼Œæ—¢ä¿è¯äº†å¸ƒéš†è¿‡æ»¤å™¨çš„æ•ˆç‡ï¼Œåˆé¿å…äº†å¯»æ‰¾å¤šä¸ªå¥½çš„å“ˆå¸Œå‡½æ•°çš„å¤æ‚æ€§ï¼Œæ˜¯ä¸€ç§åœ¨å®é™…åº”ç”¨ä¸­éå¸¸å®ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚ æ•ˆç‡å’Œå¤æ‚æ€§å…·ä½“æŒ‡ æ€§èƒ½å’Œæ•ˆç‡ï¼šä½¿ç”¨å•ä¸ªå“ˆå¸Œå‡½æ•°åé€šè¿‡ç®—æ³•å˜æ¢ç”Ÿæˆå¤šä¸ªå“ˆå¸Œå€¼ï¼Œå¯ä»¥å¤§å¤§å‡å°‘è®¡ç®—çš„å¤æ‚åº¦å’Œæ—¶é—´ã€‚å¤šä¸ªç‹¬ç«‹çš„å“ˆå¸Œå‡½æ•°æ„å‘³ç€æ¯ä¸ªå…ƒç´ éƒ½éœ€è¦è¢«å¤šæ¬¡ç‹¬ç«‹å“ˆå¸Œï¼Œè¿™ä¼šå¢åŠ è®¡ç®—æˆæœ¬å’Œæ—¶é—´ã€‚é€šè¿‡ä½¿ç”¨å•ä¸ªå“ˆå¸Œå‡½æ•°å¹¶é€šè¿‡æ•°å­¦æ–¹æ³•æ´¾ç”Ÿå‡ºå¤šä¸ªä¼ªéšæœºçš„å“ˆå¸Œå€¼ï¼Œå¯ä»¥åœ¨ä¿æŒå¸ƒéš†è¿‡æ»¤å™¨é”™è¯¯ç‡ä¸å˜çš„å‰æä¸‹ï¼Œæ˜¾è‘—æé«˜æ•ˆç‡ã€‚ ç®€åŒ–å®ç°ï¼šå¤šä¸ªä¸åŒçš„å“ˆå¸Œå‡½æ•°éš¾ä»¥é€‰å–ï¼Œè€Œä¸”è¿˜éœ€ä¿è¯å®ƒä»¬ç›¸äº’ä¹‹é—´çš„ç‹¬ç«‹æ€§å’Œåˆ†å¸ƒçš„å‡åŒ€æ€§ï¼Œè¿™åœ¨å®è·µä¸­æ˜¯éå¸¸æŒ‘æˆ˜æ€§çš„ã€‚ 3.3 mightContainså’Œput å¤„ç†è¿‡ç¨‹ä¿æŒä¸€è‡´ 3.4 guava cache è¯¯æŠ¥ç‡-ä½æ•°ç»„é•¿åº¦å›ºå®šåœ¨ä½¿ç”¨Guavaçš„å¸ƒéš†è¿‡æ»¤å™¨æ—¶ï¼Œé¢„å…ˆä¼°è®¡å°†è¦æ’å…¥çš„æ•°æ®é‡éå¸¸é‡è¦ã€‚å¸ƒéš†è¿‡æ»¤å™¨åœ¨åˆ›å»ºæ—¶ä¼šæ ¹æ®è¿™ä¸ªé¢„ä¼°çš„æ•°æ®é‡å’ŒæŒ‡å®šçš„è¯¯åˆ¤ç‡æ¥å†³å®šä½æ•°ç»„çš„å¤§å°å’Œä½¿ç”¨çš„å“ˆå¸Œå‡½æ•°æ•°é‡ã€‚è¿™äº›å‚æ•°å…±åŒå†³å®šäº†å¸ƒéš†è¿‡æ»¤å™¨çš„æ€§èƒ½å’Œå‡†ç¡®æ€§ã€‚ å¦‚æœå®é™…æ’å…¥çš„å…ƒç´ æ•°é‡è¶…è¿‡äº†æœ€åˆçš„é¢„ä¼°ï¼Œè¿‡æ»¤å™¨çš„å®é™…è¯¯åˆ¤ç‡ä¼šé«˜äºé¢„æœŸçš„è¯¯åˆ¤ç‡ã€‚è¿™æ˜¯å› ä¸ºå½“ä½æ•°ç»„å˜å¾—è¿‡äºé¥±å’Œæ—¶ï¼Œä¸åŒå…ƒç´ çš„å“ˆå¸Œå€¼æ›´æœ‰å¯èƒ½æ˜ å°„åˆ°å·²ç»è¢«è®¾ç½®ä¸º1çš„ä½ä¸Šï¼Œä»è€Œå¢åŠ äº†è¯¯åˆ¤çš„å‡ ç‡ã€‚ Guavaçš„æ–‡æ¡£æ˜ç¡®æŒ‡å‡ºäº†è¿™ä¸€ç‚¹ï¼Œå¼ºè°ƒåœ¨åˆ›å»ºå¸ƒéš†è¿‡æ»¤å™¨æ—¶åº”è¯¥å‡†ç¡®é¢„ä¼°å…ƒç´ æ•°é‡ï¼Œå¹¶è€ƒè™‘åˆ°è¿™ä¸€ç‚¹åœ¨å…¶APIè®¾è®¡ä¸­ã€‚BloomFilter.create()æ–¹æ³•å…è®¸å¼€å‘è€…åœ¨åˆ›å»ºè¿‡æ»¤å™¨æ—¶æŒ‡å®šé¢„æœŸæ’å…¥çš„å…ƒç´ æ•°é‡å’Œå¯æ¥å—çš„è¯¯åˆ¤ç‡ã€‚ https://guava.dev/releases/20.0/api/docs/com/google/common/hash/BloomFilter.html ä¸ºäº†ä¿è¯å¸ƒéš†è¿‡æ»¤å™¨çš„æ•ˆæœï¼Œåº”è¯¥æ ¹æ®å®é™…ä½¿ç”¨åœºæ™¯ä»”ç»†ä¼°ç®—å…ƒç´ æ•°é‡ã€‚å¦‚æœé¢„è®¡æ•°æ®é‡å­˜åœ¨ä¸ç¡®å®šæ€§ï¼Œå»ºè®®é¢„ä¼°ä¸€ä¸ªä¸Šé™ï¼Œæˆ–è€…åœ¨å®é™…å…ƒç´ æ•°é‡è¶…è¿‡é¢„ä¼°æ—¶é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„å¸ƒéš†è¿‡æ»¤å™¨ã€‚è¿™å½“ç„¶ä¼šå¸¦æ¥é¢å¤–çš„æˆæœ¬ï¼Œå› æ­¤åœ¨è®¾è®¡åˆæœŸåšå‡ºå‡†ç¡®ä¼°è®¡éå¸¸å…³é”®ã€‚ æ€»ç»“æ¥è¯´ï¼Œæ­£ç¡®ä¼°è®¡å°†è¦å¤„ç†çš„æ•°æ®é‡å¯¹äºä½¿ç”¨Guavaå¸ƒéš†è¿‡æ»¤å™¨æ¥è¯´æ˜¯éå¸¸é‡è¦çš„ã€‚å¦‚æœå®é™…æ•°æ®é‡è¶…è¿‡äº†é¢„ä¼°ï¼Œå°†ä¼šå¯¼è‡´é«˜äºé¢„æœŸçš„è¯¯åˆ¤ç‡ï¼Œå¯èƒ½å½±å“åˆ°åº”ç”¨çš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚ 4. åˆ†å¸ƒå¼ Redis bloom filter1BF.RESERVE &#123;key&#125; &#123;error_rate&#125; &#123;capacity&#125; [EXPANSION expansion] [NONSCALING] 4.1 å‚æ•°è§£é‡Š4.1.1 EXPANSION expansionBF.RESERVEå‘½ä»¤æ˜¯RedisBloomæ¨¡å—ä¸­ç”¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„å¸ƒéš†è¿‡æ»¤å™¨çš„å‘½ä»¤ã€‚è¿™ä¸ªå‘½ä»¤å…è®¸ç”¨æˆ·é¢„å…ˆä¸ºå¸ƒéš†è¿‡æ»¤å™¨æŒ‡å®šå‚æ•°ï¼Œä»¥ä¾¿åœ¨æ’å…¥å…ƒç´ ä¹‹å‰å°±ç¡®å®šå…¶å¤§å°å’Œå…¶ä»–é‡è¦çš„è¡Œä¸ºç‰¹æ€§ã€‚ä»¥ä¸‹æ˜¯BF.RESERVEå‘½ä»¤å„ä¸ªå‚æ•°çš„å«ä¹‰ï¼š &#123;key&#125;ï¼šè¿™æ˜¯å°†è¦åˆ›å»ºçš„å¸ƒéš†è¿‡æ»¤å™¨çš„åç§°æˆ–é”®å€¼ã€‚åœ¨Redisä¸­ï¼Œæ¯ä¸ªæ•°æ®ç»“æ„éƒ½é€šè¿‡ä¸€ä¸ªå”¯ä¸€çš„é”®æ¥æ ‡è¯†å’Œè®¿é—®ã€‚ &#123;error_rate&#125;ï¼šé¢„æœŸçš„è¯¯æŠ¥ç‡ã€‚è¿™æ˜¯ä¸€ä¸ª0åˆ°1ä¹‹é—´çš„æµ®ç‚¹æ•°ï¼Œè¡¨ç¤ºå…è®¸çš„è¯¯åˆ¤æ¦‚ç‡çš„ä¸Šé™ã€‚è¯¯æŠ¥ç‡è¶Šä½ï¼Œå¸ƒéš†è¿‡æ»¤å™¨æ‰€éœ€çš„ç©ºé—´å°±è¶Šå¤§ã€‚ &#123;capacity&#125;ï¼šå¸ƒéš†è¿‡æ»¤å™¨é¢„æœŸè¦å­˜å‚¨çš„å…ƒç´ çš„æ•°é‡ã€‚è¿™ä¸ªæ•°å€¼ç”¨äºåœ¨ä¿æŒè¯¯æŠ¥ç‡ä¸å˜çš„æƒ…å†µä¸‹ï¼Œé¢„å…ˆè®¡ç®—å¸ƒéš†è¿‡æ»¤å™¨æ‰€éœ€çš„æœ€å°å¤§å°ã€‚ [EXPANSION expansion]ï¼ˆå¯é€‰ï¼‰ï¼šè¿™ä¸ªå¯é€‰å‚æ•°ç”¨äºæŒ‡å®šå½“å¸ƒéš†è¿‡æ»¤å™¨çš„å®¹é‡ä¸è¶³ä»¥å®¹çº³æ›´å¤šå…ƒç´ æ—¶ï¼Œè‡ªåŠ¨æ‰©å±•çš„è¡Œä¸ºã€‚expansionæ˜¯ä¸€ä¸ªå¤§äº1çš„æ•´æ•°ï¼Œè¡¨ç¤ºæ¯æ¬¡æ‰©å±•å¢åŠ çš„æ¯”ä¾‹æˆ–å®¹é‡ã€‚å¦‚æœæœªæŒ‡å®šï¼Œå¸ƒéš†è¿‡æ»¤å™¨å¯èƒ½ä¼šä½¿ç”¨é»˜è®¤çš„æ‰©å±•ç­–ç•¥ã€‚ [NONSCALING]ï¼ˆå¯é€‰ï¼‰ï¼šè¿™ä¸ªå¯é€‰æ ‡å¿—ç”¨æ¥æŒ‡ç¤ºåˆ›å»ºçš„å¸ƒéš†è¿‡æ»¤å™¨ä¸åº”è‡ªåŠ¨æ‰©å±•ã€‚è¿™æ„å‘³ç€ä¸€æ—¦è¾¾åˆ°å…¶å®¹é‡ä¸Šé™ï¼Œå°±ä¸ä¼šå°è¯•æ‰©å¤§è¿‡æ»¤å™¨ä»¥å®¹çº³æ›´å¤šçš„å…ƒç´ ã€‚è¿™é€šå¸¸ç”¨äºé‚£äº›å¯¹ç©ºé—´ä½¿ç”¨æœ‰ä¸¥æ ¼é™åˆ¶çš„åº”ç”¨åœºæ™¯ã€‚ ä½œç”¨ï¼šè¿™ä¸ªå‚æ•°ç”¨äºè®¾ç½®å¸ƒéš†è¿‡æ»¤å™¨åœ¨è¾¾åˆ°å®¹é‡é™åˆ¶å¹¶éœ€è¦æ‰©å±•æ—¶ï¼Œæ–°åˆ›å»ºçš„å¸ƒéš†è¿‡æ»¤å™¨å±‚çš„å¤§å°ã€‚expansionçš„å€¼å†³å®šäº†æ–°å±‚çš„å®¹é‡æ˜¯å‰ä¸€å±‚å®¹é‡çš„å¤šå°‘å€ã€‚è¿™æ˜¯ä¸€ç§è‡ªåŠ¨æ‰©å±•å¸ƒéš†è¿‡æ»¤å™¨å®¹é‡çš„æœºåˆ¶ï¼Œä»¥é€‚åº”ä¸æ–­å¢é•¿çš„å…ƒç´ æ•°é‡ï¼ŒåŒæ—¶æ§åˆ¶è¯¯æŠ¥ç‡ã€‚ åœºæ™¯ï¼šé€‚ç”¨äºé‚£äº›å…ƒç´ æ•°é‡ä¸ç¡®å®šæˆ–å¯èƒ½ä¼šè¶…å‡ºåˆå§‹è®¾å®šå®¹é‡çš„åœºåˆã€‚é€šè¿‡é€‚å½“è®¾ç½®expansionå‚æ•°ï¼Œå¯ä»¥åœ¨ç»´æŒè¯¯æŠ¥ç‡çš„åŒæ—¶åŠ¨æ€å¢åŠ å¸ƒéš†è¿‡æ»¤å™¨çš„å®¹é‡ã€‚ ä¸¾ä¾‹ï¼šå¦‚æœè®¾ç½®[EXPANSION 2]ï¼Œé‚£ä¹ˆæ¯æ¬¡æ‰©å±•æ—¶ï¼Œæ–°çš„å¸ƒéš†è¿‡æ»¤å™¨å±‚çš„å®¹é‡å°†æ˜¯å‰ä¸€å±‚çš„ä¸¤å€ã€‚ 4.1.2 NONSCALING ä½œç”¨ï¼šæŒ‡å®šåˆ›å»ºçš„å¸ƒéš†è¿‡æ»¤å™¨ä¸ºéæ‰©å±•å‹ï¼ˆNon-scalingï¼‰ã€‚å³ï¼Œä¸€æ—¦åˆ›å»ºï¼Œå¸ƒéš†è¿‡æ»¤å™¨çš„å®¹é‡å›ºå®šï¼Œä¸ä¼šæ ¹æ®å…ƒç´ çš„å¢åŠ è€Œè‡ªåŠ¨å¢åŠ æ–°çš„å±‚ã€‚è¿™æ„å‘³ç€æ‰€æœ‰å…ƒç´ éƒ½å°†è¢«æ·»åŠ åˆ°è¿™ä¸ªå›ºå®šå¤§å°çš„å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œä¸ç®¡å…¶å®¹é‡æ˜¯å¦å·²æ»¡ã€‚ åœºæ™¯ï¼šé€‚ç”¨äºå…ƒç´ æ•°é‡é¢„å…ˆå·²çŸ¥ä¸”ä¸ä¼šè¶…å‡ºåˆå§‹è®¾å®šå®¹é‡çš„åœºåˆã€‚è¿™ç§æ–¹å¼å¯ä»¥é¿å…å› ä¸ºæ‰©å±•è€Œå¯èƒ½å¸¦æ¥çš„é¢å¤–å†…å­˜ä½¿ç”¨ï¼Œä½†è¦æ±‚ç”¨æˆ·å¿…é¡»æ›´å‡†ç¡®åœ°é¢„ä¼°æ‰€éœ€çš„å®¹é‡å’Œè¯¯æŠ¥ç‡ã€‚ æ³¨æ„ï¼šå½“ä½¿ç”¨[NONSCALING]å‚æ•°æ—¶ï¼Œ[EXPANSION expansion]å‚æ•°å°†æ— æ•ˆï¼Œå› ä¸ºéæ‰©å±•å‹çš„å¸ƒéš†è¿‡æ»¤å™¨ä¸ä¼šè¿›è¡Œä»»ä½•æ‰©å±•æ“ä½œã€‚ 4.2 å¯æ‹“å±•ç‰¹æ€§æ˜¯å¦‚ä½•å®ç°redis å¯æ‰©å±•å¸ƒéš†è¿‡æ»¤(Scalable Bloom Filters)å¯ä»¥ç†è§£æˆæ˜¯ç”±å¤šä¸ªä½æ•°ç»„/å­è¿‡æ»¤å™¨ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨å®ä¾‹ï¼‰é“¾æ¥åœ¨ä¸€èµ·å½¢æˆçš„é“¾è¡¨(SBChain)ã€‚ æ¯ä¸ªå­è¿‡æ»¤å™¨éƒ½æœ‰å…¶è‡ªå·±çš„å®¹é‡å’Œè¯¯æŠ¥ç‡è®¾ç½®ã€‚å½“å‰çš„å­è¿‡æ»¤å™¨è¾¾åˆ°å®¹é‡é™åˆ¶æ—¶ï¼Œå°±ä¼šåŠ¨æ€åœ°æ·»åŠ ä¸€ä¸ªæ–°çš„å­è¿‡æ»¤å™¨ã€‚ è¿™ç§æ–¹æ³•çš„å…³é”®ä¼˜åŠ¿æ˜¯ï¼Œå®ƒå¯ä»¥åœ¨ä¸æ–­å¢åŠ å…ƒç´ çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åœ°æ‰©å±•æ€»å®¹é‡ï¼ŒåŒæ—¶æ§åˆ¶æ•´ä½“è¯¯æŠ¥ç‡ã€‚ ç„¶è€Œï¼Œè¿™ç§åŠ¨æ€æ‰©å±•çš„èƒ½åŠ›ä¹Ÿæ„å‘³ç€æŸ¥è¯¢æ“ä½œå¯èƒ½éœ€è¦éå†é“¾è¡¨ä¸­çš„å¤šä¸ªå¸ƒéš†è¿‡æ»¤å™¨å®ä¾‹ï¼Œè¿™å¯èƒ½ä¼šå¯¹æ€§èƒ½äº§ç”Ÿä¸€å®šå½±å“ã€‚ redis bloom filter çš„æ•´ä½“ä¸Šçš„åŸºæœ¬é€»è¾‘ï¼Œæ¯”å¦‚ä½æ•°ç»„çš„å¤§å°ã€é€‰æ‹©çš„å“ˆå¸Œå‡½æ•°ã€å“ˆå¸Œå‡½æ•°çš„æ•°é‡ã€å¤šä¸ªå“ˆå¸Œå‡½æ•°çš„æ¨¡æ‹Ÿä¸Guava cache bloom filteråŸºæœ¬ä¿æŒä¸€è‡´ï¼Œ æ¥ä¸‹æ¥åªé‡ç‚¹åˆ†æå…¶å¯æ‹“å±•æ€§æ˜¯å¦‚ä½•å®ç°çš„ 4.2.1 bloom ç»“æ„ä½“123456789101112131415bloom.hstruct bloom &#123; uint32_t hashes; uint8_t force64; uint8_t n2; uint64_t entries; double error; double bpe; unsigned char *bf; uint64_t bytes; uint64_t bits; &#125;; è¿™ä¸ªstruct bloomå®šä¹‰äº†ä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨çš„åŸºæœ¬æ•°æ®ç»“æ„ï¼Œç”¨äºåœ¨RedisBloomæ¨¡å—ä¸­è¡¨ç¤ºä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨å®ä¾‹ã€‚ä¸‹é¢æ˜¯å¯¹å„ä¸ªæˆå‘˜å˜é‡çš„è¯¦ç»†è§£é‡Šï¼š uint32_t hashes;ï¼šè¿™è¡¨ç¤ºå¸ƒéš†è¿‡æ»¤å™¨ä½¿ç”¨çš„å“ˆå¸Œå‡½æ•°çš„æ•°é‡ã€‚åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå…ƒç´ çš„å­˜åœ¨æ˜¯é€šè¿‡å¤šä¸ªå“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°ä½æ•°ç»„çš„ä¸åŒä½ç½®æ¥è¡¨ç¤ºçš„ã€‚å› æ­¤ï¼Œå“ˆå¸Œå‡½æ•°çš„æ•°é‡ç›´æ¥å½±å“å¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯åˆ¤ç‡å’Œæ•ˆç‡ã€‚ uint8_t force64;ï¼šè¿™æ˜¯ä¸€ä¸ªæ ‡å¿—ä½ï¼Œç”¨äºæŒ‡ç¤ºæ˜¯å¦å¼ºåˆ¶ä½¿ç”¨64ä½å“ˆå¸Œå‡½æ•°ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸ºäº†ä¿è¯åœ¨ä¸åŒå¹³å°ä¸Šçš„ä¸€è‡´æ€§å’Œæ€§èƒ½ï¼Œå¯èƒ½éœ€è¦å¼ºåˆ¶ä½¿ç”¨64ä½å“ˆå¸Œå‡½æ•°ã€‚ uint8_t n2;ï¼šè¿™ä¸ªæˆå‘˜å¯èƒ½ç”¨äºè¡¨ç¤ºä¸ä½æ•°ç»„å¤§å°ç›¸å…³çš„ä¸€ä¸ªå‚æ•°ï¼Œå…·ä½“å«ä¹‰å–å†³äºå®ç°ç»†èŠ‚ã€‚åœ¨ä¸€äº›å¸ƒéš†è¿‡æ»¤å™¨çš„å®ç°ä¸­ï¼Œè¿™ä¸ªå‚æ•°å¯èƒ½ä¸ä½æ•°ç»„å¤§å°ä¸º2çš„å¹‚æ¬¡æ–¹æœ‰å…³ã€‚ uint64_t entries;ï¼šè¿™è¡¨ç¤ºé¢„æœŸå­˜å‚¨åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„å…ƒç´ æ•°é‡ã€‚è¿™ä¸ªæ•°å€¼å¯¹äºè®¡ç®—ä½æ•°ç»„çš„å¤§å°å’Œå“ˆå¸Œå‡½æ•°æ•°é‡éå¸¸é‡è¦ã€‚ double error;ï¼šè¿™æ˜¯é¢„æœŸçš„è¯¯åˆ¤ç‡ï¼ˆfalse positive rateï¼‰ï¼Œæ˜¯è®¾è®¡å¸ƒéš†è¿‡æ»¤å™¨æ—¶çš„ä¸€ä¸ªå…³é”®å‚æ•°ã€‚è¯¯åˆ¤ç‡è¶Šä½ï¼Œæ‰€éœ€çš„ä½æ•°ç»„å¤§å°å’Œå“ˆå¸Œå‡½æ•°æ•°é‡å°±è¶Šå¤šã€‚ double bpe;ï¼šè¿™è¡¨ç¤ºæ¯ä¸ªå…ƒç´ å¹³å‡å ç”¨çš„ä½æ•°ï¼ˆBits Per Entryï¼‰ã€‚è¿™ä¸ªå€¼æ˜¯æ ¹æ®é¢„æœŸçš„è¯¯åˆ¤ç‡å’Œå…ƒç´ æ•°é‡è®¡ç®—å¾—å‡ºçš„ï¼Œç”¨äºç¡®å®šä½æ•°ç»„çš„å¤§å°ã€‚ unsigned char *bf;ï¼šè¿™æ˜¯ä¸€ä¸ªæŒ‡å‘ä½æ•°ç»„çš„æŒ‡é’ˆã€‚ä½æ•°ç»„æ˜¯å¸ƒéš†è¿‡æ»¤å™¨çš„æ ¸å¿ƒï¼Œç”¨äºå­˜å‚¨å…ƒç´ çš„å“ˆå¸Œå€¼æ˜ å°„ã€‚unsigned charç±»å‹è¢«ç”¨æ¥è¡¨ç¤ºä½æ•°ç»„ï¼Œæ¯ä¸ªå­—èŠ‚åŒ…å«8ä½ã€‚ uint64_t bytes;ï¼šè¿™è¡¨ç¤ºä½æ•°ç»„å ç”¨çš„å­—èŠ‚æ•°ã€‚ç”±äºä½æ•°ç»„æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½è¿›è¡Œåˆ†é…çš„ï¼Œå› æ­¤è¿™ä¸ªæ•°å€¼è¡¨ç¤ºæ•´ä¸ªä½æ•°ç»„çš„å¤§å°ã€‚ uint64_t bits;ï¼šè¿™è¡¨ç¤ºä½æ•°ç»„ä¸­çš„ä½æ•°ã€‚è¿™ä¸ªæ•°å€¼æ˜¯æ ¹æ®entriesã€errorå’Œbpeè®¡ç®—å¾—å‡ºçš„ï¼Œå†³å®šäº†å¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥æœ‰æ•ˆå­˜å‚¨çš„å…ƒç´ æ•°é‡å’Œè¯¯åˆ¤ç‡ã€‚ 4.2.2 SBLinkç»“æ„ä½“123456sb.h/** Single link inside a scalable bloom filter */ typedef struct SBLink &#123; struct bloom inner; //&lt; Inner structure size_t size; // &lt; Number of items in the link &#125; SBLink; SBLinkä»£è¡¨äº†å¯æ‰©å±•å¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„å•ä¸ªé“¾æ¥ï¼Œå³å•ä¸ªå¸ƒéš†è¿‡æ»¤å™¨å®ä¾‹ã€‚ struct bloom inner;ï¼šè¿™æ˜¯ä¸€ä¸ªåµŒå¥—çš„ç»“æ„ä½“ï¼Œè¡¨ç¤ºå•ä¸ªå¸ƒéš†è¿‡æ»¤å™¨çš„å†…éƒ¨ç»“æ„ã€‚è¿™ä¸ªinnerç»“æ„ä½“å¯èƒ½åŒ…å«äº†å®ç°å¸ƒéš†è¿‡æ»¤å™¨æ‰€éœ€çš„æ‰€æœ‰æ•°æ®ï¼Œå¦‚ä½æ•°ç»„ã€å“ˆå¸Œå‡½æ•°æ•°é‡ç­‰ã€‚ size_t size;ï¼šè¡¨ç¤ºå½“å‰é“¾æ¥ï¼ˆå³å•ä¸ªå¸ƒéš†è¿‡æ»¤å™¨å®ä¾‹ï¼‰ä¸­çš„å…ƒç´ æ•°é‡ã€‚è¿™æ˜¯ä¸ºäº†å¿«é€Ÿè®¿é—®å•ä¸ªè¿‡æ»¤å™¨å†…å…ƒç´ çš„æ•°é‡ï¼Œè€Œæ— éœ€éå†æ•´ä¸ªä½æ•°ç»„ã€‚ 4.2.3 SBChainç»“æ„ä½“123456789sb.h /** A chain of one or more bloom filters */ typedef struct SBChain &#123; SBLink *filters; //&lt; Current filter size_t size; //&lt; Total number of items in all filters size_t nfilters; //&lt; Number of links in chain unsigned options; //&lt; Options passed directly to bloom_init unsigned growth; &#125; SBChain; SBChainä»£è¡¨äº†ä¸€ç³»åˆ—ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªï¼‰SBLinkç»“æ„ä½“çš„é“¾è¡¨ï¼Œæ„æˆäº†ä¸€ä¸ªå¯æ‰©å±•çš„å¸ƒéš†è¿‡æ»¤å™¨ã€‚ SBLink *filters;ï¼šè¿™æ˜¯ä¸€ä¸ªæŒ‡å‘SBLinkæ•°ç»„çš„æŒ‡é’ˆï¼Œè¡¨ç¤ºå½“å‰æ‰€æœ‰çš„è¿‡æ»¤å™¨é“¾ã€‚æ¯ä¸ªSBLinkä»£è¡¨é“¾ä¸­çš„ä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨å®ä¾‹ã€‚ size_t size;ï¼šè¡¨ç¤ºæ‰€æœ‰è¿‡æ»¤å™¨ä¸­å…ƒç´ çš„æ€»æ•°é‡ã€‚è¿™ä¸ªæ•°å­—æ˜¯æ‰€æœ‰å•ä¸ªSBLinkä¸­sizeæˆå‘˜çš„æ€»å’Œã€‚ size_t nfilters;ï¼šè¡¨ç¤ºé“¾ä¸­SBLinkå®ä¾‹çš„æ•°é‡ï¼Œå³å½“å‰æœ‰å¤šå°‘ä¸ªå¸ƒéš†è¿‡æ»¤å™¨è¢«é“¾æ¥åœ¨ä¸€èµ·ã€‚ unsigned options;ï¼šè¿™æ˜¯ä¼ é€’ç»™æ¯ä¸ªå¸ƒéš†è¿‡æ»¤å™¨åˆå§‹åŒ–å‡½æ•°bloom_initçš„é€‰é¡¹ã€‚è¿™äº›é€‰é¡¹å¯èƒ½æ§åˆ¶å¦‚å¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯æŠ¥ç‡ã€æ˜¯å¦è‡ªåŠ¨æ‰©å±•ç­‰è¡Œä¸ºã€‚ unsigned growth;ï¼šè¿™ä¸ªæˆå‘˜å˜é‡æ§åˆ¶é“¾çš„å¢é•¿è¡Œä¸ºã€‚å®ƒå¯èƒ½æŒ‡å®šå½“å½“å‰çš„å¸ƒéš†è¿‡æ»¤å™¨å¡«æ»¡æ—¶ï¼Œå¦‚ä½•å¢åŠ æ–°çš„SBLinkå®ä¾‹ï¼Œä¾‹å¦‚ï¼Œå¢åŠ çš„å¤§å°æˆ–æ¯”ä¾‹ç­‰ã€‚ 4.3 å¯æ‰©å±•bloom filterçš„å·¥ä½œæµç¨‹ åˆå§‹åŒ–ï¼šå½“åˆ›å»ºä¸€ä¸ªæ–°çš„å¯æ‰©å±•å¸ƒéš†è¿‡æ»¤å™¨æ—¶ï¼Œä¼šæŒ‡å®šåˆå§‹å®¹é‡ã€è¯¯æŠ¥ç‡ç­‰å‚æ•°ã€‚åŸºäºè¿™äº›å‚æ•°ï¼Œåˆ›å»ºç¬¬ä¸€ä¸ªå­è¿‡æ»¤å™¨ã€‚ æ·»åŠ å…ƒç´ ï¼šå‘å¸ƒéš†è¿‡æ»¤å™¨æ·»åŠ å…ƒç´ æ—¶ï¼Œä¼šä»å½“å‰å­è¿‡æ»¤å™¨å¼€å§‹å°è¯•æ·»åŠ ã€‚å¦‚æœå½“å‰å­è¿‡æ»¤å™¨å·²æ»¡ï¼ˆå³è¾¾åˆ°äº†å…¶å®¹é‡é™åˆ¶ï¼‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿‡æ»¤å™¨ï¼Œå¹¶åœ¨æ–°çš„å­è¿‡æ»¤å™¨ä¸­æ·»åŠ å…ƒç´ ã€‚æ¯ä¸ªæ–°æ·»åŠ çš„å­è¿‡æ»¤å™¨éƒ½å¯ä»¥æ ¹æ®é…ç½®çš„è§„åˆ™è°ƒæ•´å¤§å°å’Œè¯¯æŠ¥ç‡ï¼Œä»¥é€‚åº”ä¸æ–­å¢åŠ çš„å…ƒç´ ã€‚ æ£€æŸ¥å…ƒç´ ï¼šæ£€æŸ¥ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨æ—¶ï¼Œéœ€è¦æŸ¥è¯¢æ‰€æœ‰çš„å­è¿‡æ»¤å™¨ã€‚å¦‚æœä»»ä½•å­è¿‡æ»¤å™¨è¡¨ç¤ºå…ƒç´ å¯èƒ½å­˜åœ¨ï¼ˆå³å¯¹åº”çš„ä½éƒ½ä¸º1ï¼‰ï¼Œåˆ™è®¤ä¸ºå…ƒç´ å¯èƒ½å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚è™½ç„¶å¯æ‰©å±•å¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥åŠ¨æ€å¢åŠ å®¹é‡ï¼Œä½†æŸ¥è¯¢æ“ä½œçš„æˆæœ¬éšä¹‹å¢åŠ ï¼Œå› ä¸ºå¯èƒ½éœ€è¦æ£€æŸ¥å¤šä¸ªå¸ƒéš†è¿‡æ»¤å™¨å®ä¾‹ã€‚ å‚æ•°è°ƒæ•´ï¼šéšç€å­è¿‡æ»¤å™¨çš„å¢åŠ ï¼Œæ¯ä¸ªæ–°çš„å­è¿‡æ»¤å™¨é€šå¸¸ä¼šæœ‰æ›´å¤§çš„å®¹é‡ã€‚è¿™æ˜¯é€šè¿‡è°ƒæ•´å¦‚æ¯”ç‰¹æ•°ã€å“ˆå¸Œå‡½æ•°æ•°é‡ç­‰å‚æ•°æ¥å®ç°çš„ã€‚è¿™ç§æ–¹æ³•æ—¨åœ¨å¹³è¡¡è¯¯æŠ¥ç‡å’Œå†…å­˜ä½¿ç”¨ï¼Œå³ä½¿åœ¨ä¸æ–­æ·»åŠ å…ƒç´ çš„æƒ…å†µä¸‹ä¹Ÿèƒ½ç»´æŒç›¸å¯¹ç¨³å®šçš„è¯¯æŠ¥ç‡ã€‚ 5. å¯åˆ é™¤ bloom filter5.1 å“ªäº›åœºæ™¯ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨æ—¶éœ€è¦åˆ é™¤ä»¥ä¸Šï¼Œ guava å’Œ redis çš„bloom filter éƒ½æ²¡æœ‰å®ç°åˆ é™¤åŠŸèƒ½ï¼Œä¸èƒ½åˆ é™¤çš„åŸå› å·²ç»è§£é‡Šè¿‡ï¼Œå…ƒç´ çš„å­˜åœ¨æ˜¯é€šè¿‡å¤šä¸ªä½çš„â€œ1â€çŠ¶æ€æ¥è¡¨ç¤ºçš„ï¼Œè€Œå°†è¿™äº›ä½é‡ç½®ä¸ºâ€œ0â€å¯èƒ½ä¼šé”™è¯¯åœ°å½±å“å…¶ä»–å…ƒç´ çš„å­˜åœ¨æ£€æµ‹ã€‚ ä½†æ˜¯åœ¨æŸäº›åœºæ™¯è¿˜æ˜¯éœ€è¦åˆ é™¤ï¼Œæ¯”å¦‚ï¼ŒæŸ¥çœ‹ä¸€å¼ ä¼˜æƒ åˆ¸æ˜¯å¦å·²è¢«ä½¿ç”¨ï¼Ÿåˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰å­˜åœ¨ä½†è¿˜æœªè¢«ä½¿ç”¨ä¼˜æƒ åˆ¸çš„filterã€‚æ¯æ¬¡æ ¡éªŒæ—¶ å¦‚æœå¦ï¼Œåˆ™ä¼˜æƒ åˆ¸ä¸å­˜åœ¨ã€‚ å¦‚æœæ˜¯ï¼Œåˆ™ä¼˜æƒ åˆ¸æœ‰æ•ˆã€‚æ£€æŸ¥ä¸»æ•°æ®åº“ã€‚å¦‚æœæœ‰æ•ˆï¼Œåˆ™ä½¿ç”¨åä» Cuckoo è¿‡æ»¤å™¨ä¸­åˆ é™¤ã€‚ 5.2 å®ç°åˆ é™¤å¸ƒéš†è¿‡æ»¤å™¨çš„æ€è·¯5.2.1 è®¡æ•°å‹å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆCounting Bloom Filterï¼‰è¿™æ˜¯æœ€ç›´æ¥çš„æ–¹æ³•ä¹‹ä¸€ï¼Œå®ƒé€šè¿‡ä¸ºæ¯ä¸ªä½ä½¿ç”¨ä¸€ä¸ªè®¡æ•°å™¨è€Œä¸æ˜¯ç®€å•çš„å¸ƒå°”æ ‡è®°æ¥å®ç°ã€‚å½“æ’å…¥ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå®ƒç»è¿‡å¤šä¸ªå“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°å¤šä¸ªè®¡æ•°å™¨ä¸Šï¼Œå¹¶å°†è¿™äº›è®¡æ•°å™¨çš„å€¼å¢åŠ ã€‚ç›¸åº”åœ°ï¼Œåˆ é™¤ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œè¿™äº›è®¡æ•°å™¨çš„å€¼ä¼šè¢«å‡å°‘ã€‚å¦‚æœä»»ä½•è®¡æ•°å™¨çš„å€¼è¾¾åˆ°é›¶ï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰ä»»ä½•å…ƒç´ æ˜ å°„åˆ°è¿™ä¸ªä½ä¸Šã€‚è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯éœ€è¦æ›´å¤šçš„ç©ºé—´æ¥å­˜å‚¨è®¡æ•°å™¨ã€‚ 5.2.2 åŒå¸ƒéš†è¿‡æ»¤å™¨è¿™ç§æ–¹æ³•æ¶‰åŠåˆ°ä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼šä¸€ä¸ªç”¨äºæ·»åŠ æ“ä½œï¼Œå¦ä¸€ä¸ªç”¨äºåˆ é™¤æ“ä½œã€‚å½“æ·»åŠ ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå®ƒè¢«æ·»åŠ åˆ°ç¬¬ä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼›å½“åˆ é™¤ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œè¯¥å…ƒç´ è¢«æ·»åŠ åˆ°ç¬¬äºŒä¸ªå¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨æ—¶ï¼Œå¦‚æœå®ƒåœ¨ç¬¬ä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨ä¸­å¹¶ä¸”ä¸åœ¨ç¬¬äºŒä¸ªå¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œåˆ™è®¤ä¸ºè¯¥å…ƒç´ å­˜åœ¨ã€‚è¿™ç§æ–¹æ³•çš„é—®é¢˜æ˜¯è¯¯æŠ¥ç‡ä¼šå¢åŠ ï¼Œå› ä¸ºåˆ é™¤è¿‡æ»¤å™¨ä¸­çš„å…ƒç´ ä¹Ÿå¯èƒ½é”™è¯¯åœ°é˜»æ­¢å¯¹å®é™…å­˜åœ¨äºé›†åˆä¸­çš„å…ƒç´ çš„æ­£ç¡®åˆ¤æ–­ã€‚ 5.2.3 d-left è®¡æ•°å“ˆå¸Œd-leftè®¡æ•°å“ˆå¸Œæ˜¯ä¸€ç§é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå®ƒå°†å…ƒç´ æ˜ å°„åˆ°å›ºå®šæ•°é‡çš„æ¡¶ä¸­ï¼Œå¹¶åœ¨æ¯ä¸ªæ¡¶å†…ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ã€‚è¿™ç§æ–¹æ³•å¯ä»¥å®ç°å¿«é€Ÿçš„æ’å…¥ã€æŸ¥è¯¢å’Œåˆ é™¤æ“ä½œï¼Œå¹¶ä¸”ç›¸æ¯”äºè®¡æ•°å‹å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå®ƒå¯ä»¥æ›´æœ‰æ•ˆåœ°åˆ©ç”¨ç©ºé—´ã€‚ä¸è¿‡ï¼Œå®ç°èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä¸”å½“æ¡¶å¡«æ»¡æ—¶æ€§èƒ½ä¼šä¸‹é™ã€‚ 5.2.4 å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼ˆCuckoo Filterï¼‰å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨æ˜¯å¦ä¸€ç§æ”¯æŒåˆ é™¤æ“ä½œçš„å¸ƒéš†è¿‡æ»¤å™¨å˜ç§ï¼Œå®ƒåŸºäºå¸ƒè°·é¸Ÿå“ˆå¸Œå’Œéƒ¨åˆ†é”®å­˜å‚¨ã€‚æ¯ä¸ªå…ƒç´ é€šè¿‡å“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªä½ç½®ï¼Œå¹¶å­˜å‚¨å…¶â€œæŒ‡çº¹â€ã€‚æ’å…¥ã€æŸ¥è¯¢å’Œåˆ é™¤æ“ä½œéƒ½åŸºäºè¿™äº›æŒ‡çº¹ã€‚å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ç›¸æ¯”è®¡æ•°å‹å¸ƒéš†è¿‡æ»¤å™¨åœ¨ç©ºé—´æ•ˆç‡ä¸Šæœ‰æ‰€æé«˜ï¼Œä¸”æ”¯æŒåˆ é™¤æ“ä½œï¼Œä½†åœ¨æç«¯æƒ…å†µä¸‹å¯èƒ½éœ€è¦é‡å»ºè¿‡æ»¤å™¨ã€‚ æ€»ä½“ä¸Šå¯ä»¥çœ‹å‡ºå¯åˆ é™¤bloom filter çš„å®ç°éƒ½æ˜¯éœ€è¦é¢å¤–çš„ç©ºé—´å»å­˜å‚¨é¢å¤–çš„ä¿¡æ¯ï¼Œ é‚£ä¹ˆå…¶å®ç°æ–¹å¼çš„å¥½åçš„è¯„åˆ¤æ ‡å‡†å°±æ˜¯ é¢å¤–ç©ºé—´çš„å¤§å°ã€æ€§èƒ½ ä»¥åŠå¯¹è¯¯æŠ¥ç‡çš„å½±å“ã€‚ ä»¥ä¸‹æ˜¯ä¸€å¼ è¡¨æ ¼ï¼Œæ€»ç»“äº†å‡ ç§æ”¯æŒåˆ é™¤æ“ä½œçš„å¸ƒéš†è¿‡æ»¤å™¨å˜ä½“çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼š è¿‡æ»¤å™¨ç±»å‹ ä¼˜ç‚¹ ç¼ºç‚¹ è®¡æ•°å‹å¸ƒéš†è¿‡æ»¤å™¨ - ç›´æ¥æ”¯æŒåˆ é™¤æ“ä½œ- å®ç°ç›¸å¯¹ç®€å• - æ›´å¤šç©ºé—´éœ€æ±‚- è®¡æ•°å™¨æº¢å‡ºé—®é¢˜ åŒå¸ƒéš†è¿‡æ»¤å™¨ - å®ç°ç®€å•- é€šè¿‡é¢å¤–å¸ƒéš†è¿‡æ»¤å™¨è·Ÿè¸ªåˆ é™¤æ“ä½œ - å¢åŠ ç©ºé—´éœ€æ±‚- è¯¯åˆ¤ç‡å¢åŠ  å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ - é«˜æ•ˆçš„æ’å…¥ã€åˆ é™¤å’ŒæŸ¥è¯¢- ç©ºé—´æ•ˆç‡é«˜ - å®ç°å¤æ‚- è´Ÿè½½å› å­é«˜æ—¶æ€§èƒ½å¯èƒ½ä¸‹é™ d-leftè®¡æ•°å“ˆå¸Œè¿‡æ»¤å™¨ - é«˜ç©ºé—´æ•ˆç‡- æ€§èƒ½ä¼˜äºä¼ ç»Ÿè®¡æ•°å‹å¸ƒéš†è¿‡æ»¤å™¨ - å®ç°å¤æ‚ï¼Œéœ€è¦ç²¾å¿ƒè®¾è®¡ å¦‚æœåº”ç”¨å¯¹ç©ºé—´æ•ˆç‡è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œä¸”éœ€è¦é¢‘ç¹è¿›è¡Œåˆ é™¤æ“ä½œï¼Œè®¡æ•°å‹å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ä¸ªç®€å•æœ‰æ•ˆçš„é€‰æ‹©ã€‚ å¯¹äºéœ€è¦æœ€å°åŒ–è¯¯æŠ¥ç‡è€Œä¸”å¯¹ç©ºé—´æœ‰ä¸€å®šè¦æ±‚çš„åº”ç”¨ï¼Œå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨æä¾›äº†ä¸€ä¸ªè¾ƒå¥½çš„å¹³è¡¡ç‚¹ã€‚ åœ¨éœ€è¦æè‡´ç©ºé—´æ•ˆç‡ä¸”èƒ½å¤Ÿæ¥å—å®ç°å¤æ‚åº¦çš„é«˜æ€§èƒ½åº”ç”¨åœºæ™¯ä¸­ï¼Œd-left è®¡æ•°å“ˆå¸Œè¿‡æ»¤å™¨å¯èƒ½æ˜¯æœ€ä½³é€‰æ‹©ã€‚ å…³äºç©ºé—´çš„ä½¿ç”¨ï¼Œæœ‰å¦‚ä¸‹æ¯”å¯¹æ•ˆæœ redis å®ç°äº†cuckoo å˜ä½“bloom filterï¼Œ ä¸‹é¢æ¥è®²ä¸€ä¸‹ cuckoo filter çš„åŸç† 6. Cuckoo FilterCuckoo Filter è®ºæ–‡ the basic unit of the cuckoo hash tables used for our cuckoo filters is called an entry. Each entry stores one fingerprint. The hash table consists of an array of buckets, where a bucket can have multiple entries. åœ¨Cuckoo Filter ä¸­ï¼Œæœ€åŸºæœ¬çš„å­˜å‚¨å•å…ƒæ˜¯entry, æ¯ä¸ªå•å…ƒå­˜å‚¨ä¸€ä¸ª fingerprintã€‚cuckoo hashing å“ˆå¸Œè¡¨ç”±ä¸€ç»„æ¡¶ï¼ˆbucketsï¼‰ç»„æˆï¼Œæ¯ä¸ªæ¡¶å¯ä»¥åŒ…å«å¤šä¸ªæ¡ç›®ï¼ˆentriesï¼‰ã€‚ Cuckoo Filterçš„å…³é”®ç‰¹æ€§ åŒå“ˆå¸Œå‡½æ•°ï¼šå¯¹äºä»»ä½•ä¸€ä¸ªç»™å®šçš„é”®ï¼ŒCuckoo Hashingä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„å“ˆå¸Œå‡½æ•° h1 å’Œ h2 æ¥è®¡ç®—ä¸¤ä¸ªå€™é€‰æ¡¶çš„ä½ç½®ã€‚è¿™ä¸¤ä¸ªä½ç½®æ˜¯é”®å¯èƒ½è¢«å­˜å‚¨çš„åœ°æ–¹ã€‚ æŒ‡çº¹å­˜å‚¨ï¼šä¸ä¼ ç»Ÿçš„å“ˆå¸Œè¡¨ä¸åŒï¼ŒCuckoo Hashingä¸å­˜å‚¨å®Œæ•´çš„é”®ï¼Œè€Œæ˜¯å­˜å‚¨é”®çš„æŒ‡çº¹ã€‚è¿™å…è®¸åœ¨ä¸ç‰ºç‰²å¤ªå¤šç©ºé—´æ•ˆç‡çš„æƒ…å†µä¸‹è¿›è¡Œé«˜æ•ˆçš„æŸ¥æ‰¾å’Œåˆ é™¤æ“ä½œã€‚ åŠ¨æ€æ’å…¥ï¼šå½“æ’å…¥ä¸€ä¸ªæ–°é”®æ—¶ï¼Œå¦‚æœå€™é€‰æ¡¶ä¸­æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼ŒCuckoo Hashingä¼šé€šè¿‡ä¸€ç³»åˆ—ç½®æ¢æ“ä½œæ¥ä¸ºæ–°é”®è…¾å‡ºç©ºé—´ã€‚è¿™æ¶‰åŠåˆ°å°†ç°æœ‰çš„æŒ‡çº¹ç§»åŠ¨åˆ°å®ƒä»¬çš„æ›¿ä»£ä½ç½®ï¼Œä»è€Œä¸ºæ–°é”®è…¾å‡ºç©ºé—´ã€‚å·²å ç”¨ä½ç½®çš„å…ƒç´ ä¼šè¢«ç§»åŠ¨åˆ°å…¶å®ƒå“ˆå¸Œå‡½æ•°ç¡®å®šçš„ä½ç½®ï¼Œå¯èƒ½å¯¼è‡´ä¸€ä¸ªè¿é”çš„é‡æ–°æ”¾ç½®è¿‡ç¨‹ã€‚è¿™ä¸ªç®—æ³•çš„åå­—æ¥æºäºå¸ƒè°·é¸Ÿï¼Œå› ä¸ºå¸ƒè°·é¸Ÿä¼šå°†è‡ªå·±çš„è›‹æ”¾å…¥å…¶ä»–é¸Ÿç±»çš„å·¢ä¸­ï¼Œè¿«ä½¿å…¶ä»–é¸Ÿç±»çš„è›‹è¢«ç§»ä½æˆ–ä¸¢å¼ƒã€‚ æŸ¥æ‰¾æ“ä½œï¼šç»™å®šä¸€ä¸ªé”®ï¼ŒCuckoo Hashingé€šè¿‡æ£€æŸ¥ä¸¤ä¸ªå€™é€‰æ¡¶ä¸­çš„æŒ‡çº¹æ¥ç¡®å®šé”®æ˜¯å¦å­˜åœ¨äºè¡¨ä¸­ã€‚å¦‚æœä»»ä¸€æ¡¶ä¸­å­˜åœ¨åŒ¹é…çš„æŒ‡çº¹ï¼Œåˆ™è®¤ä¸ºé”®å­˜åœ¨äºè¡¨ä¸­ã€‚ åˆ é™¤æ“ä½œï¼šåˆ é™¤æ“ä½œç›¸å¯¹ç®€å•ï¼ŒCuckoo Hashingæ£€æŸ¥ä¸¤ä¸ªå€™é€‰æ¡¶ï¼Œå¦‚æœæ‰¾åˆ°åŒ¹é…çš„æŒ‡çº¹ï¼Œåˆ™ç§»é™¤è¯¥æŒ‡çº¹ã€‚è¿™ç§åˆ é™¤æ–¹æ³•ä¸ä¼šå½±å“å…¶ä»–é”®çš„å­˜å‚¨ä½ç½®ã€‚ é«˜ç©ºé—´æ•ˆç‡ï¼šCuckoo Hashingé€šè¿‡å­˜å‚¨æŒ‡çº¹è€Œä¸æ˜¯å®Œæ•´çš„é”®æ¥ä¼˜åŒ–ç©ºé—´ä½¿ç”¨ï¼ŒåŒæ—¶ä¿æŒè¾ƒé«˜çš„è¡¨å ç”¨ç‡ï¼Œä»è€Œå®ç°é«˜ç©ºé—´æ•ˆç‡ã€‚ 6.1 fingerprintâ€œfingerprintâ€æ˜¯å­˜å‚¨åœ¨Cuckoo Filterä¸­çš„æ•°æ®ã€‚ï¼Œä¸€ä¸ªå“ˆå¸Œå‡½æ•°å¤„ç†æ•°æ®åå¾—åˆ°çš„å“ˆå¸Œä¸²ã€‚ 6.2 Partial-Key Cuckoo HashingA cuckoo filter is a compact variant of a cuckoo hash table that stores only fingerprints-a bit string derived from the item using a hash functionã€‚ åœ¨cuckoo filter ä¸­ï¼Œå“ˆå¸Œè¡¨ä¸­å­˜å‚¨çš„æ•°æ®å‘ç”Ÿäº†å˜åŒ–ï¼Œç”±åŸå§‹æ•°æ®å˜æˆäº†fingerprintã€‚æ³¨æ„è¿™é‡Œçš„ï¼ˆbasic/standardï¼‰ cuckoo hash tablesæŒ‡çš„æ˜¯å­˜å‚¨åŸå§‹æ•°æ®çš„åšæ³•ã€‚ partial-key cuckoo hashing æ˜¯ä¸€ç§ä»…ä½¿ç”¨æŒ‡çº¹ï¼Œè€Œä¸éœ€è¦åŸå§‹æ•°æ®å°±å¯ä»¥åœ¨ç½®æ¢æ“ä½œä¸­æ¥ç¡®å®šå…ƒç´ å­˜å‚¨ä½ç½®çš„å“ˆå¸ŒæŠ€æœ¯ã€‚ç”±äºä»…å­˜å‚¨fingerprint æ¯”å­˜å‚¨åŸå§‹æ•°æ®æ‰€å å†…å­˜ç©ºé—´å°ï¼Œæ‰€ä»¥ Partial-Key Cuckoo Hashingä¸ºä¼˜åŒ–Cuckoo Filterçš„ç©ºé—´æ•ˆç‡å’Œæ“ä½œæ€§èƒ½è€Œè®¾è®¡ã€‚ å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼ŒPartial-Key Cuckoo Hashingä½¿ç”¨ä¸¤ä¸ªå“ˆå¸Œå‡½æ•° h1 å’Œ h2 æ¥è®¡ç®—ä¸¤ä¸ªå€™é€‰æ¡¶ä½ç½®ã€‚ç¬¬ä¸€ä¸ªå“ˆå¸Œå‡½æ•° h1 ç›´æ¥ä½œç”¨äºå…ƒç´ çš„æŒ‡çº¹ï¼Œè€Œç¬¬äºŒä¸ªå“ˆå¸Œå‡½æ•° h2 åˆ™æ˜¯ h1 ä¸æŒ‡çº¹çš„å“ˆå¸Œå€¼çš„å¼‚æˆ–ï¼ˆXORï¼‰ç»“æœã€‚è¿™ç§XORçš„å¤„ç†ç»“æœ å¯ä»¥æ ¹æ®å…¶ä¸­ä»»æ„ä¸€ä¸ªå·²çŸ¥çš„å€™é€‰æ¡¶ä½ç½®ï¼ˆiï¼‰è®¡ç®—å‡ºå¦å¤–ä¸€ä¸ªå€™é€‰æ¡¶ä½ç½®ï¼ˆjï¼‰j = i XOR fingerprint 6.3 Insert cuckoo å“ˆå¸Œçš„æ’å…¥è¿‡ç¨‹ï¼š è®¡ç®—å…ƒç´ çš„æŒ‡çº¹ã€‚ ç¡®å®šä¸¤ä¸ªå€™é€‰æ¡¶ä½ç½® i1 å’Œ i2ã€‚ å¦‚æœ i1 æˆ– i2 æœ‰ç©ºé—²æ¡ç›®ï¼Œåˆ™å°†æŒ‡çº¹æ’å…¥åˆ°è¯¥æ¡ç›®ä¸­ã€‚ å¦‚æœä¸¤ä¸ªæ¡¶éƒ½æ»¡ï¼Œåˆ™é€‰æ‹©ä¸€ä¸ªæ¡¶ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªæ¡ç›®å¹¶å°†å…¶æŒ‡çº¹ä¸æ–°å…ƒç´ çš„æŒ‡çº¹äº¤æ¢ã€‚ Partial-Key Cuckoo Hashing ï¼Œæ›´æ–°å€™é€‰æ¡¶ä½ç½® i ä¸º i XOR æŒ‡çº¹çš„å“ˆå¸Œå€¼ã€‚ å¦‚æœæ‰¾åˆ°ç©ºé—²æ¡ç›®ï¼Œåˆ™æ’å…¥æŒ‡çº¹ï¼›å¦åˆ™ç»§ç»­ç½®æ¢è¿‡ç¨‹ï¼Œç›´åˆ°æ‰¾åˆ°ç©ºé—²æ¡ç›®æˆ–è¾¾åˆ°æœ€å¤§ç½®æ¢æ¬¡æ•°ã€‚ 6.4 Lookup 6.5 Delete ä¸ºä»€ä¹ˆcuckoo filter å¯ä»¥åˆ é™¤å…ƒç´ ä½†æ˜¯åˆä¸å½±å“å…¶ä»–å…ƒç´ çš„åˆ¤æ–­ï¼Œ å…¶å®å°±æ˜¯æ¯ä¸ªentry åªå­˜å‚¨äº†ä¸€ä¸ªå…ƒç´ çš„ä¿¡æ¯ï¼Œåˆ é™¤åè‡ªç„¶ä¸ä¼šå½±å“å…¶ä»–å…ƒç´ çš„åˆ¤æ–­ã€‚ 6.6 ç©ºé—´ä¼˜åŒ–Cuckoo Filterè¿›è¡Œç©ºé—´ä¼˜åŒ–ï¼ˆSPACE OPTIMIZATIONSï¼‰çš„æ–¹æ³•ä¸»è¦æ¶‰åŠå¯¹å“ˆå¸Œè¡¨å‚æ•°çš„é€‰æ‹©å’Œé…ç½®ï¼Œä»¥åŠå¯¹æ¡¶ï¼ˆbucketsï¼‰çš„ç¼–ç ç­–ç•¥ã€‚ä»¥ä¸‹æ˜¯è®ºæ–‡ä¸­æåˆ°çš„ä¸€äº›å…³é”®çš„ç©ºé—´ä¼˜åŒ–ç­–ç•¥ï¼š é€‰æ‹©åˆé€‚çš„æ¡¶å¤§å°ï¼ˆBucket Sizeï¼‰ï¼š æ¡¶å¤§å°ï¼ˆbï¼‰å¯¹Cuckoo Filterçš„ç©ºé—´æ•ˆç‡æœ‰æ˜¾è‘—å½±å“ã€‚è¾ƒå¤§çš„æ¡¶å¯ä»¥æé«˜å“ˆå¸Œè¡¨çš„å ç”¨ç‡ï¼ˆÎ±ï¼‰ï¼Œä½†åŒæ—¶ä¹Ÿéœ€è¦æ›´é•¿çš„æŒ‡çº¹æ¥ç»´æŒç›¸åŒçš„è¯¯æŠ¥ç‡ã€‚ è®ºæ–‡ä¸­é€šè¿‡å®éªŒç¡®å®šäº†å¯¹äºä¸åŒçš„ç›®æ ‡è¯¯æŠ¥ç‡ï¼ˆÏµï¼‰ï¼Œæœ€ä¼˜çš„æ¡¶å¤§å°æ˜¯ä¸åŒçš„ã€‚ä¾‹å¦‚ï¼Œå½“è¯¯æŠ¥ç‡å¤§äº0.002æ—¶ï¼Œæ¯ä¸ªæ¡¶æœ‰2ä¸ªæ¡ç›®å¯èƒ½æ¯”4ä¸ªæ¡ç›®æ›´æœ‰æ•ˆï¼›è€Œå½“è¯¯æŠ¥ç‡é™ä½åˆ°0.00001è‡³0.002æ—¶ï¼Œæ¯ä¸ªæ¡¶æœ‰4ä¸ªæ¡ç›®å¯ä»¥æœ€å°åŒ–ç©ºé—´ä½¿ç”¨ã€‚ åŠæ’åºæ¡¶ç¼–ç ï¼ˆSemi-Sorting Bucketsï¼‰ï¼š å¯¹äºæ¯ä¸ªæ¡¶ä¸­çš„æŒ‡çº¹è¿›è¡Œæ’åºï¼Œç„¶åä½¿ç”¨ä¸€ä¸ªé¢„å…ˆè®¡ç®—å¥½çš„è¡¨æ¥ç¼–ç è¿™äº›æ’åºåçš„æŒ‡çº¹åºåˆ—ã€‚ç”±äºæ¡¶å†…æŒ‡çº¹çš„é¡ºåºä¸å½±å“æŸ¥è¯¢ç»“æœï¼Œè¿™ç§æ–¹æ³•å¯ä»¥é€šè¿‡ç´¢å¼•æ¥èŠ‚çœç©ºé—´ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ¯ä¸ªæ¡¶æœ‰4ä¸ªæŒ‡çº¹ï¼Œæ¯ä¸ªæŒ‡çº¹æ˜¯4æ¯”ç‰¹é•¿ï¼Œé‚£ä¹ˆæœªå‹ç¼©çš„æ¡¶å°†å ç”¨16æ¯”ç‰¹ã€‚é€šè¿‡æ’åºå’Œç¼–ç ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ª12æ¯”ç‰¹çš„ç´¢å¼•æ¥ä»£æ›¿åŸæ¥çš„16æ¯”ç‰¹æ¡¶ï¼Œå› ä¸ºå¯ä»¥é¢„å…ˆè®¡ç®—å‡ºæ‰€æœ‰å¯èƒ½çš„æ¡¶å€¼ï¼ˆä¾‹å¦‚ï¼Œ3876ç§ï¼‰ï¼Œå¹¶å°†æ¯ä¸ªæ¡¶è¡¨ç¤ºä¸ºä¸€ä¸ªç´¢å¼•ï¼Œä»è€ŒèŠ‚çœ1æ¯”ç‰¹æ¯ä¸ªæŒ‡çº¹ã€‚ å¹³è¡¡æ¡¶çš„è´Ÿè½½ï¼ˆBalancing Bucket Loadsï¼‰ï¼š é€šè¿‡åˆç†é…ç½®å“ˆå¸Œå‡½æ•°å’Œæ¡¶å¤§å°ï¼Œå¯ä»¥å‡å°‘å“ˆå¸Œè¡¨ä¸­çš„å†²çªå’Œç©ºæ¡¶ï¼Œä»è€Œæé«˜ç©ºé—´åˆ©ç”¨ç‡ã€‚ è®ºæ–‡ä¸­æåˆ°ï¼Œé€šè¿‡é€‚å½“çš„é…ç½®ï¼ŒCuckoo Filterå¯ä»¥ä»¥é«˜æ¦‚ç‡è¾¾åˆ°95%çš„è¡¨ç©ºé—´å ç”¨ç‡ã€‚ æŒ‡çº¹é•¿åº¦çš„ä¼˜åŒ–ï¼š æŒ‡çº¹é•¿åº¦ï¼ˆfï¼‰ä¸æ¡¶å¤§å°å’Œç›®æ ‡è¯¯æŠ¥ç‡æœ‰å…³ã€‚é€šè¿‡è°ƒæ•´æŒ‡çº¹é•¿åº¦ï¼Œå¯ä»¥åœ¨ä¿æŒç›®æ ‡è¯¯æŠ¥ç‡çš„åŒæ—¶ï¼Œä¼˜åŒ–ç©ºé—´ä½¿ç”¨ã€‚ è®ºæ–‡ä¸­çš„åˆ†æè¡¨æ˜ï¼Œå¯¹äºå®é™…åº”ç”¨ä¸­çš„é›†åˆå¤§å°ï¼Œè¾ƒçŸ­çš„æŒ‡çº¹ï¼ˆä¾‹å¦‚6æ¯”ç‰¹æˆ–æ›´é•¿ï¼‰é€šå¸¸è¶³ä»¥ç¡®ä¿å“ˆå¸Œè¡¨çš„é«˜åˆ©ç”¨ç‡ã€‚ é€šè¿‡è¿™äº›ç©ºé—´ä¼˜åŒ–ç­–ç•¥ï¼ŒCuckoo Filterèƒ½å¤Ÿåœ¨ä¿æŒé«˜æ•ˆåŠ¨æ€æ“ä½œçš„åŒæ—¶ï¼Œå®ç°ç´§å‡‘çš„æ•°æ®å­˜å‚¨ã€‚è¿™äº›ä¼˜åŒ–ä½¿å¾—Cuckoo Filteråœ¨å¾ˆå¤šå®é™…åº”ç”¨ä¸­æ¯”ä¼ ç»Ÿçš„Bloom Filterå’ŒCounting Bloom Filteræ›´åŠ ç©ºé—´é«˜æ•ˆ 6.7 Redis cuckoo filterredis å®ç°äº† cuckoo filter ï¼ŒåŸºæœ¬å®ç°é€»è¾‘å’Œè®ºæ–‡ä¸­è¡¨ç°ä¸€è‡´ï¼Œæœ‰å…´è¶£å¤§å®¶å¯ä»¥è‡ªå·±å»çœ‹ä¸€ä¸‹ 7. è‡ªå·±å¦‚ä½•å®ç°ä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨åŸºäºä»¥ä¸Šå¯¹3ç§bloom filterçš„åˆ†æï¼Œå¯ä»¥æ€»ç»“å‡ºè‡ªå·±å®ç°bloom filteræ—¶éœ€è¦è€ƒè™‘çš„å› ç´ æœ¬é¡¹ç›®ä»£ç å¯ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ 7.1 ä½æ•°ç»„çš„å®ç°é¦–å…ˆå‚è€ƒBitSetã€‚BitSetç±»æ˜¯Javaæ ‡å‡†åº“ä¸­æä¾›çš„ä¸€ä¸ªç”¨äºå¤„ç†ä½æ•°ç»„çš„ç±»ï¼ŒåŸºæœ¬å¯ä»¥è®¤ä¸ºæ˜¯bitmap åœ¨Java çš„ä¸­çš„å®ç°ï¼Œå…¶åŸç†æ˜¯æ˜¯long[] æ•°ç»„+ ä½æ“ä½œã€‚åœ¨è‡ªå·±å®ç°å¸ƒéš†è¿‡æ»¤å™¨æ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨BitSet ï¼Œ ä¹Ÿå¯ä»¥åƒguava cache ä¸€æ ·ï¼Œè‡ªå·±ç”¨long[] + ä½æ“ä½œè‡ªå·±å°è£…ä¸€ä¸ªbitarrayï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨çš„BitSetã€‚ 7.2 ä½æ•°ç»„çš„å¤§å°åœ¨ç®€å•çš„è‡ªå·±å®ç°çš„ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥ç›´æ¥æŒ‡å®šbitarray å¤§å°ã€‚ ä½†åœ¨å®é™…çº¿ä¸Šç”Ÿäº§ç¯å¢ƒä¸­å¯ç”¨çš„bloom filter å®ç°ï¼Œä¸€èˆ¬éƒ½æ˜¯æ ¹æ®é¢„æœŸæ’å…¥çš„æ•°æ®é‡ å’Œ å¯æ¥å—çš„è¯¯æŠ¥ç‡ä¸¤ä¸ªæ•°å­—é€šè¿‡ ä¸€ä¸ªæ•°å­¦å…¬å¼ç®—å‡ºçš„ï¼Œè€Œä¸æ˜¯ç›´æ¥ç”¨é¢„æœŸæ’å…¥çš„æ•°æ®é‡ã€‚ åŒæ—¶æˆ‘ä»¬åœ¨çº¿ä¸Šç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨æ—¶ï¼Œæ ¹æ®ä¸šåŠ¡ç‰¹æ€§å’Œæµé‡å»ä¼°ç®—é¢„æœŸæ’å…¥çš„æ•°æ®é‡ å’Œè¡¡é‡ å¯æ¥å—çš„è¯¯æŠ¥ç‡ ä¹Ÿæ˜¯éå¸¸é‡è¦çš„æ­¥éª¤ã€‚ å¦‚æœä¼°ç®—æ•°æ®é‡æ¯”å®é™…å€¼å¤§å¾ˆå¤šï¼Œå°±ä¼šæµªè´¹å†…å­˜ç©ºé—´ã€‚å¦‚æœä¼°ç®—æ•°æ®é‡æ¯”å®é™…å€¼å°å¾ˆå¤šï¼Œé‚£ä¹ˆè¯¯æŠ¥ç‡å¾ˆå¯èƒ½å°±æ— æ³•æ§åˆ¶åœ¨å¯æ¥å—çš„èŒƒå›´å†…ã€‚ guava cache bloom filter ä½æ•°ç»„å¤§å°ä¸€æ—¦ç¡®å®šæ—¶æ— æ³•ä¿®æ”¹çš„ï¼Œæ‰€ä»¥å®é™…æ•°æ®é‡å¦‚æœè¿‡å¤§ï¼Œé‚£ä¹ˆè¯¯æŠ¥ç‡è‚¯å®šä¼šä¸Šå‡ redis bloom filter ä½æ•°ç»„å¤§å°å¯ä»¥scale, ä½†æ˜¯åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨çš„è¿™ä¸ªæ­¥éª¤æ€§èƒ½ä¼šå—åˆ°å½±å“ 7.3 ç”¨å“ªä¸ªå“ˆå¸Œå‡½æ•°è¿™ä¸ªå“ˆå¸Œå‡½æ•°åœ¨å¯†ç å­¦ä¸­å«åšå•å‘æ•£åˆ—å‡½æ•°ã€‚å•å‘æ•£åˆ—å‡½æ•°æœ‰ä¸¤ç±»åŠ å¯†ä¸éåŠ å¯†æ•£åˆ—ï¼Œå…¶ä¸»è¦åŒºåˆ«å¦‚ä¸‹ã€‚ 7.3.1 åŠ å¯†æ•£åˆ—å‡½æ•°è®¾è®¡ç”¨äºåŠ å¯†åº”ç”¨ï¼Œå¼ºè°ƒå®‰å…¨æ€§ã€‚å®ƒä»¬éœ€è¦å…·å¤‡ä¸€å®šçš„æ€§è´¨ï¼Œå¦‚æŠ—ç¢°æ’ï¼ˆä¸¤ä¸ªä¸åŒçš„è¾“å…¥ä¸åº”è¯¥äº§ç”ŸåŒä¸€ä¸ªè¾“å‡ºï¼‰ã€éšè—æ€§ï¼ˆæ— æ³•ä»è¾“å‡ºæ¨æ–­ä»»ä½•ä¿¡æ¯å…³äºè¾“å…¥ï¼‰å’ŒæŠ—ç¯¡æ”¹ï¼ˆå¯¹è¾“å…¥çš„å¾®å°å˜åŒ–ä¼šåœ¨è¾“å‡ºä¸­äº§ç”Ÿä¸å¯é¢„æµ‹çš„ã€å¤§çš„å˜åŒ–ï¼‰ã€‚ SHAå®¶æ—ï¼ˆSHA-1ã€SHA-256ã€SHA-512ç­‰ï¼‰ï¼šå®‰å…¨å“ˆå¸Œç®—æ³•ï¼ˆSecure Hash Algorithmï¼‰å®¶æ—ï¼Œå¹¿æ³›ç”¨äºåŠ å¯†ã€æ•°æ®å®Œæ•´æ€§æ ¡éªŒå’Œæ•°å­—ç­¾åç­‰å®‰å…¨ç›¸å…³çš„åº”ç”¨ã€‚ MD5ï¼šæ¶ˆæ¯æ‘˜è¦ç®—æ³•5ï¼ˆMessage Digest Algorithm 5ï¼‰ï¼Œå°½ç®¡å› ä¸ºå®‰å…¨æ€§é—®é¢˜ä¸å†æ¨èç”¨äºåŠ å¯†å®‰å…¨é¢†åŸŸï¼Œä½†åœ¨ä¸€äº›éå®‰å…¨æ€§è¦æ±‚çš„åœºåˆä»ç„¶å¯ä»¥è§åˆ°å…¶èº«å½±ã€‚ RIPEMDï¼šä¸€ç³»åˆ—çš„åŠ å¯†å“ˆå¸Œå‡½æ•°ï¼ŒåŒ…æ‹¬RIPEMD-160ã€RIPEMD-256å’ŒRIPEMD-320ï¼Œå…¶ä¸­RIPEMD-160è®¾è®¡ç”¨äºæ›¿ä»£MD5å’ŒSHA-1ã€‚-7.3.2 éåŠ å¯†æ•£åˆ—å‡½æ•°è®¾è®¡é‡ç‚¹æ˜¯é«˜æ•ˆç‡å’Œå‡åŒ€åˆ†å¸ƒçš„è¾“å‡ºï¼Œä»¥æ”¯æŒå¿«é€Ÿæ•°æ®æ£€ç´¢ã€æ•°æ®åˆ†å¸ƒå¹³è¡¡ç­‰ï¼Œè€Œä¸æ˜¯å®‰å…¨æ€§ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå…è®¸å­˜åœ¨ç¢°æ’ï¼Œä½†ç¢°æ’çš„æ¦‚ç‡è¦å°½å¯èƒ½ä½ã€‚ å¸¸è§çš„éåŠ å¯†å•å‘æ•£åˆ—å‡½æ•°ï¼š MurmurHashï¼šç”±Austin Applebyè®¾è®¡ï¼Œå› å…¶é«˜æ€§èƒ½å’Œè‰¯å¥½çš„åˆ†å¸ƒç‰¹æ€§è€Œå¹¿æ³›åº”ç”¨ã€‚MurmurHashæœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œå¦‚MurmurHash2ã€MurmurHash3ç­‰ã€‚ CityHashï¼šç”±Googleå¼€å‘ï¼Œä¸“ä¸ºå“ˆå¸Œå­—ç¬¦ä¸²æ•°æ®è®¾è®¡ï¼Œé€‚ç”¨äºæ„å»ºå“ˆå¸Œè¡¨ç­‰æ•°æ®ç»“æ„ã€‚åç»­Googleåˆæ¨å‡ºäº†FarmHashï¼Œä½œä¸ºCityHashçš„æ”¹è¿›ç‰ˆï¼Œæä¾›æ›´å¥½çš„æ€§èƒ½å’Œæ›´å¹¿çš„é€‚ç”¨èŒƒå›´ã€‚ xxHashï¼šæ˜¯ä¸€ç§éå¸¸å¿«çš„å“ˆå¸Œç®—æ³•ï¼Œæä¾›äº†æé«˜çš„æ•°æ®å¤„ç†é€Ÿåº¦ï¼ŒåŒæ—¶ä¿æŒäº†è‰¯å¥½çš„æ•£åˆ—åˆ†å¸ƒç‰¹æ€§ï¼Œé€‚ç”¨äºéœ€è¦å¿«é€Ÿæ•£åˆ—å¤§é‡æ•°æ®çš„åœºæ™¯ã€‚ Jenkinså“ˆå¸Œå‡½æ•°ï¼ˆå¦‚ä¸€è‡´æ€§å“ˆå¸Œï¼‰ï¼šBob Jenkinsæ‰€è®¾è®¡çš„ä¸€ç³»åˆ—å“ˆå¸Œå‡½æ•°ï¼ŒåŒ…æ‹¬lookup3ã€SpookyHashç­‰ï¼Œå®ƒä»¬å¹¿æ³›ç”¨äºè½¯ä»¶å¼€å‘ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦å¿«é€Ÿä¸”åˆ†å¸ƒå‡åŒ€çš„å“ˆå¸Œç®—æ³•çš„åœºåˆã€‚ FNVï¼ˆFowler-Noll-Voï¼‰ï¼šæ˜¯ä¸€ç³»åˆ—è®¾è®¡ç®€å•ã€æ€§èƒ½è‰¯å¥½çš„å“ˆå¸Œå‡½æ•°ï¼Œç‰¹åˆ«é€‚åˆäºæ•£åˆ—å•ä¸ªæ–‡æœ¬å­—ç¬¦ä¸²ã€‚FNV-1å’ŒFNV-1aæ˜¯ä¸¤ä¸ªæœ€è‘—åçš„å˜ç§ã€‚ åœ¨ä»¥ä¸Šåˆ†æåŸç†åˆ†æä¸­ï¼Œguava cacheå’ŒRedis éƒ½æ˜¯ç”¨äº†MurmurHashå¦‚æœæˆ‘ä»¬è‡ªå·±ä¹Ÿæƒ³è¦ç”¨MurmurHashï¼Œç›®å‰Javaå¹¶æ²¡æœ‰æä¾›å®ç°ï¼Œå¯ä»¥å¼•å…¥guava cache åŒ…ä½¿ç”¨MurmurHashã€‚ 7.4 ç”¨å¤šå°‘ä¸ªå“ˆå¸Œå‡½æ•°å‰é¢è¯´è¿‡ç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°å¯ä»¥å‡å°‘è¯¯æŠ¥ç‡ï¼Œé‚£ä¹ˆåˆ°åº•è¦ç”¨å¤šå°‘ä¸ªå“ˆå¸Œå‡½æ•°å‘¢ï¼Œ è¿™ä¹Ÿæ˜¯å¯ä»¥é€šè¿‡ é¢„æœŸæ’å…¥çš„æ•°æ®é‡+ å¯æ¥å—çš„è¯¯æŠ¥ç‡ é€šè¿‡å›ºå®šçš„æ•°å­¦å…¬å¼è®¡ç®—å¾—å‡ºã€‚åŒæ—¶å¤šä¸ªå“ˆå¸Œç»“æœå¯ä»¥é€šè¿‡åƒGuava cacheä¸€æ ·ï¼Œç”¨åŒå“ˆå¸ŒæŠ€æœ¯æ¨¡æ‹Ÿå¾—åˆ°ã€‚","tags":["Programming"]},{"title":"Spring AOP  æ³¨è§£æ–¹å¼åŸç†è¯¦è§£","path":"/4316da89/","content":"æœ¬æ–‡å°†ä»AnnotationAwareAspectJAutoProxyCreatorå¼€å§‹ï¼Œä»‹ç»AOP çš„å®ç° å’Œ ä»£ç†å¯¹è±¡çš„äº§ç”Ÿ Beançš„AOPåŠ¨æ€ä»£ç†åˆ›å»ºæ—¶åœ¨åˆå§‹åŒ–ä¹‹åé€šè¿‡å›è°ƒpostProcessAfterInitializationåç½®å¤„ç†å™¨è¿›è¡Œçš„ï¼Œä½†æ˜¯å‡ºç°å¾ªç¯ä¾èµ–çš„Beanå¦‚æœä½¿ç”¨äº†AOPï¼Œ é‚£å°±éœ€è¦åœ¨getEarlyBeanReference()æ–¹æ³•åˆ›å»ºåŠ¨æ€ä»£ç†ï¼Œå°†ç”Ÿæˆçš„ä»£ç†Beanæ”¾åœ¨äºŒçº§ç¼“å­˜æå‰æ›å…‰å‡ºæ¥ï¼Œ æœ¬æ–‡åŸºäº Spring AOP å®è·µ å’Œ Spring AOP XMLé…ç½®æ–¹å¼åŸç†è¯¦è§£, æ¥ç»§ç»­è®²è§£ åŸºäºæ³¨è§£æ–¹å¼å®ç°AOP è‡ªåŠ¨ä»£ç†çš„åŸç†ã€‚ åœ¨ Spring AOP å®è·µä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬æ¢è®¨äº†é€šè¿‡åœ¨XMLé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ProxyFactoryBeanæ¥é…ç½®ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œå¹¶åœ¨éœ€è¦æ—¶æ‰‹åŠ¨è·å–ä»£ç†å¯¹è±¡ä»¥å®ç°AOPåŠŸèƒ½ã€‚ ç„¶è€Œï¼Œåœ¨å¤§å‹ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™ç§é…ç½®æ–¹å¼æ˜¾å¾—ç¹çä¸”ä¸åˆ‡å®é™…ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒSpringæä¾›äº†ä¸€ç§åŸºäºAbstractAutoProxyCreatorçš„è‡ªåŠ¨ä»£ç†æœºåˆ¶ï¼Œä½¿å¾—æˆ‘ä»¬æ— éœ€ä¸ºæ¯ä¸ªBeanæ‰‹åŠ¨é…ç½®ProxyFactoryBeanã€‚AbstractAutoProxyCreatoré€šè¿‡è‡ªåŠ¨æ£€æµ‹Beançš„ç±»å‹å’Œç›¸åº”çš„åˆ‡é¢ï¼ˆAspectï¼‰æ¥åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä»è€Œç®€åŒ–äº†é…ç½®è¿‡ç¨‹ã€‚ æ³¨è§£æ–¹å¼çš„è‡ªåŠ¨ä»£ç†æœºåˆ¶åˆ™æ˜¯ä½¿ç”¨AbstractAutoProxyCreatorçš„å­ç±»AnnotationAwareAspectJAutoProxyCreatoræ¥å®ç°çš„ã€‚ å¦‚æœä½ å·²ç»äº†è§£äº† Spring bean å®ä¾‹åŒ– Spring IOC å®¹å™¨å¯åŠ¨è¿‡ç¨‹æ‹“å±•ç‚¹ Spring AOP å®è·µ Spring AOP XMLé…ç½®æ–¹å¼åŸç†è¯¦è§£ é‚£ä¹ˆç°åœ¨æ¥ç†è§£æ³¨è§£æ–¹å¼çš„è‡ªåŠ¨ä»£ç†æœºåˆ¶å…¶å®å·²ç»æ¯”è¾ƒå®¹æ˜“äº†ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä»¥ä¸€ä¸ªSpring Booté¡¹ç›®ä¸ºç¤ºä¾‹ï¼Œæ¢è®¨AnnotationAwareAspectJAutoProxyCreator å®ç°è‡ªåŠ¨ä»£ç†çš„åŸç†ã€‚ 0. ç¤ºä¾‹ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657@Servicepublic class UserService &#123; public void createUser(String username) &#123; // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† System.out.println(&quot;Creating user: &quot; + username); &#125; public void deleteUser(String username) &#123; // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† System.out.println(&quot;Deleting user: &quot; + username); &#125;&#125;@Aspect@Componentpublic class LoggingAspect &#123; //å®šä¹‰ä¸€ä¸ªåŒ¹é…userServiceä¸­æ‰€æœ‰æ–¹æ³•çš„åˆ‡ç‚¹è¡¨è¾¾å¼ @Pointcut(&quot;execution(* com.example.codingInAction.service.UserService.*(..))&quot;) public void userServiceAllMethod() &#123; &#125; // åœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œçš„é€šçŸ¥ @Before(&quot;userServiceAllMethod()&quot;) public void logBefore(JoinPoint joinPoint) &#123; System.out.println(&quot;Before method: &quot; + joinPoint.getSignature().getName()); &#125; // åœ¨æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œçš„é€šçŸ¥ @After(&quot;userServiceAllMethod()&quot;) public void logAfter(JoinPoint joinPoint) &#123; System.out.println(&quot;After method: &quot; + joinPoint.getSignature().getName()); &#125; // å®šä¹‰ä¸€ä¸ªåªåŒ¹é… UserService.createUser æ–¹æ³•çš„åˆ‡ç‚¹è¡¨è¾¾å¼ @Around(&quot;execution(* com.example.codingInAction.service.UserService.createUser(..))&quot;) public Object logAround(ProceedingJoinPoint joinPoint) throws Throwable &#123; long startTime = System.currentTimeMillis(); System.out.println(joinPoint.getSignature().getName() + &quot; æ–¹æ³•å¼€å§‹æ‰§è¡Œ&quot;); Object result = joinPoint.proceed(); // æ‰§è¡Œç›®æ ‡æ–¹æ³• long endTime = System.currentTimeMillis(); System.out.println(joinPoint.getSignature().getName() + &quot; æ–¹æ³•æ‰§è¡Œæ—¶é—´: &quot; + (endTime - startTime) + &quot;ms&quot;); return result; &#125;&#125;@SpringBootApplicationpublic class CodingInActionApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(CodingInActionApplication.class, args); &#125;&#125; 1. AnnotationAwareAspectJAutoProxyCreator ç»§æ‰¿ã€å®ç°å…³ç³»è§£æAnnotationAwareAspectJAutoProxyCreatoræ˜¯Spring AOPå®ç°çš„æ ¸å¿ƒç±»ä¹‹ä¸€ç”¨äºåœ¨Springå®¹å™¨ä¸­æ‰«æå’Œå¤„ç†å¸¦æœ‰@Aspectæ³¨è§£çš„beanã€‚ AnnotationAwareAspectJAutoProxyCreator ç»§æ‰¿å…³ç³»è¾ƒä¸ºå¤æ‚ï¼Œå®ƒæ˜¯å¤šä¸ªç±»å’Œæ¥å£çš„ç»„åˆä½“ï¼Œä¸»è¦ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š 1.1 BeanPostProcessoråœ¨ Spring IOC å®¹å™¨å¯åŠ¨è¿‡ç¨‹æ‹“å±•ç‚¹ä¸€æ–‡ä¸­ï¼Œå·²ç»è¯¦ç»†è®²è§£è¿‡BeanPostProcessorçš„ä½œç”¨ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ï¼Œç›´æ¥æ¥çœ‹å®ƒçš„3ä¸ªå­ç±» 1.1.1 InstantiationAwareBeanPostProcessor å›¾ä¸­ç½®ç°çš„2ä¸ªæ–¹æ³•ï¼Œæ˜¯ç»§æ‰¿è‡ªBeanPostProcessorçš„2ä¸ªæ–¹æ³• InstantiationAwareBeanPostProcessorè‡ªæœ‰çš„3ä¸ªæ–¹æ³•ä¸­æœ‰2ä¸ªæ–¹æ³•åç§°å’ŒBeanPostProcessorä¸­æ–¹å¼åç§°ç›¸åŒï¼Œä½†æ˜¯å…¥å‚å’Œè¿”å›å€¼ç•¥æœ‰ä¸åŒ postProcessBeforeInstantiation1234@Nullable default Object postProcessBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName) throws BeansException &#123; return null; &#125; åœ¨bean çš„å®ä¾‹åŒ–ä¹‹å‰ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå…¶é€»è¾‘å­˜åœ¨äºä¸‹é¢ä»£ç ä¸­resolveBeforeInstantiationæ–¹æ³•ä¸­ã€‚ è¿™ä¸ªæ–¹æ³•å¯ä»¥è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œæ¥æ›¿ä»£ Bean çš„é»˜è®¤å®ä¾‹åŒ–è¿‡ç¨‹ã€‚ä½†é€šå¸¸æƒ…å†µä¸‹ï¼Œä»£ç†å¯¹è±¡æ˜¯åœ¨ Bean å®ä¾‹åŒ–ä¹‹ååˆ›å»ºçš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¸€èˆ¬è¿”å› nullã€‚ 123456789@Override protected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException &#123;\tObject bean = resolveBeforeInstantiation(beanName, mbdToUse); if (bean != null) &#123; return bean; &#125;\tObject beanInstance = doCreateBean(beanName, mbdToUse, args);&#125; postProcessAfterInstantiationåœ¨ bean createä¹‹åï¼Œpopulateä¹‹å‰è°ƒç”¨ã€‚è¿”å› true è¡¨ç¤ºå…è®¸å±æ€§æ³¨å…¥ï¼Œè¿”å› false åˆ™è·³è¿‡å±æ€§æ³¨å…¥ã€‚ 123default boolean postProcessAfterInstantiation(Object bean, String beanName) throws BeansException &#123; return true; &#125; postProcessPropertiesåœ¨populate å±æ€§æ³¨å…¥è¿‡ç¨‹ä¸­è°ƒç”¨ï¼Œå¯ä»¥å¯¹å±æ€§å€¼è¿›è¡Œæ£€æŸ¥æˆ–ä¿®æ”¹ã€‚12345@Nullable default PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName) throws BeansException &#123; return null; &#125; 1.1.2 SmartInstantiationAwareBeanPostProcessorSmartInstantiationAwareBeanPostProcessor æ˜¯ Spring æ¡†æ¶ä¸­çš„ä¸€ä¸ªæ¥å£ï¼Œå®ƒæ‰©å±•äº† InstantiationAwareBeanPostProcessor æ¥å£ï¼Œæä¾›äº†æ›´ç»†ç²’åº¦çš„æ§åˆ¶å’Œé¢å¤–çš„é’©å­æ–¹æ³•æ¥ä»‹å…¥ Spring Bean çš„å®ä¾‹åŒ–è¿‡ç¨‹ã€‚è¿™ä¸ªæ¥å£ä¸»è¦ç”¨äºåœ¨ Bean createä¹‹å‰ã€createä¹‹åã€populateä¹‹å‰ã€populateä¹‹åç­‰å¤šä¸ªé˜¶æ®µæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ï¼Œä»è€Œå®ç°æ›´åŠ å¤æ‚å’Œçµæ´»çš„ Bean åˆå§‹åŒ–æ§åˆ¶ã€‚ predictBeanTypeåœ¨å®é™…åˆ›å»º Bean å®ä¾‹ä¹‹å‰é¢„æµ‹å…¶ç±»å‹ã€‚è¿™å¯¹äºæå‰æ£€æµ‹æŸäº›ç±»å‹ç›¸å…³çš„å…ƒæ•°æ®å¾ˆæœ‰ç”¨ã€‚123default Class&lt;?&gt; predictBeanType(Class&lt;?&gt; beanClass, String beanName) throws BeansException &#123; return null; &#125; determineCandidateConstructorsç¡®å®šè¦ç”¨äºåˆ›å»º Bean å®ä¾‹çš„å€™é€‰æ„é€ å‡½æ•°ã€‚å…è®¸è‡ªå®šä¹‰é€‰æ‹©ç”¨äºå®ä¾‹åŒ– Bean çš„æ„é€ å‡½æ•°ã€‚ 12345default Constructor&lt;?&gt;[] determineCandidateConstructors(Class&lt;?&gt; beanClass, String beanName) throws BeansException &#123; return null; &#125; getEarlyBeanReferenceå…è®¸åœ¨ Bean å®ä¾‹åŒ–ä¹‹å‰æå‰æš´éœ² Bean çš„å¼•ç”¨ã€‚é€šå¸¸ç”¨äºè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ 123default Object getEarlyBeanReference(Object bean, String beanName) throws BeansException &#123; return bean; &#125; 1.2 AbstractAutoProxyCreatorAbstractAutoProxyCreator æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒç»§æ‰¿è‡ª ProxyProcessorSupport å¹¶å®ç°äº† SmartInstantiationAwareBeanPostProcessor å’Œ BeanFactoryAware æ¥å£ã€‚è¿™äº›æ¥å£å’Œç±»æä¾›äº†åˆ›å»ºä»£ç†å¯¹è±¡å’Œä¸ Spring å®¹å™¨é›†æˆçš„åŸºç¡€åŠŸèƒ½ã€‚ å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯è‡ªåŠ¨ä¸º Spring å®¹å™¨ä¸­çš„ bean åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä»¥ä¾¿åœ¨è¿™äº› bean çš„æ–¹æ³•è°ƒç”¨æ—¶æ’å…¥æ¨ªåˆ‡å…³æ³¨ç‚¹çš„é€»è¾‘ã€‚å…·ä½“æ¥è¯´ï¼ŒAbstractAutoProxyCreator çš„åŠŸèƒ½åŒ…æ‹¬ï¼š æ‰«æå’Œç­›é€‰ beanï¼šåœ¨ Spring å®¹å™¨åˆå§‹åŒ–æ—¶ï¼Œæ‰«ææ‰€æœ‰ beanï¼Œæ ¹æ®é…ç½®çš„åˆ‡ç‚¹ç­›é€‰å‡ºéœ€è¦å¢å¼ºçš„ beanã€‚ åˆ›å»ºä»£ç†å¯¹è±¡ï¼šä¸ºç¬¦åˆæ¡ä»¶çš„ bean åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡å¯ä»¥æ˜¯ JDK åŠ¨æ€ä»£ç†æˆ– CGLIB ä»£ç†ã€‚ æ³¨å†Œä»£ç†å¯¹è±¡ï¼šå°†åˆ›å»ºçš„ä»£ç†å¯¹è±¡æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ï¼Œæ›¿æ¢åŸå§‹çš„ beanã€‚ å¤„ç†ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼šå®ç° BeanPostProcessor æ¥å£ä¸­çš„ postProcessBeforeInitialization å’Œ postProcessAfterInitialization æ–¹æ³•ï¼Œåœ¨ bean åˆå§‹åŒ–å‰åæ‰§è¡Œä»£ç†é€»è¾‘ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051public abstract class AbstractAutoProxyCreator extends ProxyProcessorSupport implements SmartInstantiationAwareBeanPostProcessor, BeanFactoryAware &#123; /** * Convenience constant for subclasses: Return value for &quot;do not proxy&quot;. * @see #getAdvicesAndAdvisorsForBean */ @Nullable protected static final Object[] DO_NOT_PROXY = null; /** * Convenience constant for subclasses: Return value for * &quot;proxy without additional interceptors, just the common ones&quot;. * @see #getAdvicesAndAdvisorsForBean */ protected static final Object[] PROXY_WITHOUT_ADDITIONAL_INTERCEPTORS = new Object[0]; /** Logger available to subclasses. */ protected final Log logger = LogFactory.getLog(getClass()); /** Default is global AdvisorAdapterRegistry. */ private AdvisorAdapterRegistry advisorAdapterRegistry = GlobalAdvisorAdapterRegistry.getInstance(); /** * Indicates whether or not the proxy should be frozen. Overridden from super * to prevent the configuration from becoming frozen too early. */ private boolean freezeProxy = false; /** Default is no common interceptors. */ private String[] interceptorNames = new String[0]; private boolean applyCommonInterceptorsFirst = true; @Nullable private TargetSourceCreator[] customTargetSourceCreators; @Nullable private BeanFactory beanFactory; private final Set&lt;String&gt; targetSourcedBeans = Collections.newSetFromMap(new ConcurrentHashMap&lt;&gt;(16)); private final Map&lt;Object, Object&gt; earlyProxyReferences = new ConcurrentHashMap&lt;&gt;(16); private final Map&lt;Object, Class&lt;?&gt;&gt; proxyTypes = new ConcurrentHashMap&lt;&gt;(16); // ä¿å­˜å·²ç»å¤„ç†è¿‡çš„beanä¿¡æ¯ã€‚è¿™ä¸ªæ˜ å°„ç”¨äºä¿å­˜beanå®ä¾‹åˆ°å¸ƒå°”å€¼çš„æ˜ å°„ï¼ŒæŒ‡ç¤ºè¿™äº›beanæ˜¯å¦å·²ç»è¢«ä»£ç†æˆ–ä¸éœ€è¦ä»£ç†ã€‚ç¼“å­˜è¿™äº›ä¿¡æ¯å¯ä»¥æé«˜æ€§èƒ½ï¼Œé¿å…é‡å¤å¤„ç†ã€‚private final Map&lt;Object, Boolean&gt; advisedBeans = new ConcurrentHashMap&lt;&gt;(256);&#125; ä¸‹é¢æ¥åˆ†æä¸€ä¸‹AbstractAutoProxyCreator çš„å…·ä½“å­ç±» 1.2.1 AbstractAdvisorAutoProxyCreator ä½œç”¨ï¼šè¿™ä¸ªç±»æ˜¯ AbstractAutoProxyCreator çš„ç›´æ¥å­ç±»ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯è‡ªåŠ¨ä¸º Spring Bean åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå¹¶å°†é…ç½®çš„åˆ‡é¢ï¼ˆadviceï¼‰åº”ç”¨åˆ°è¿™äº›ä»£ç†å¯¹è±¡ä¸Šã€‚ å·¥ä½œåŸç†ï¼šå®ƒæ‰«æ Spring å®¹å™¨ä¸­çš„æ‰€æœ‰ Advisorï¼ˆä¸€ä¸ª Advisor åŒ…å«ä¸€ä¸ª Advice å’Œä¸€ä¸ª Pointcutï¼‰ï¼Œå¹¶æ ¹æ® Pointcut çš„åŒ¹é…è§„åˆ™ï¼Œè‡ªåŠ¨ä¸ºåŒ¹é…çš„ Bean åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå¹¶åº”ç”¨å¯¹åº”çš„ Adviceã€‚ 1.2.2 AspectJAwareAdvisorAutoProxyCreatorä½œç”¨ï¼šè¿™ä¸ªç±»æ˜¯ AbstractAdvisorAutoProxyCreator çš„å­ç±»ï¼Œä¸»è¦ç”¨äºå¤„ç†åŸºäº AspectJ æ–¹å¼çš„ AOP é…ç½®ã€‚å·¥ä½œåŸç†ï¼šå®ƒå’Œ AnnotationAwareAspectJAutoProxyCreator ç±»ä¼¼ï¼Œä½†ä¸»è¦ç”¨äºå¤„ç†é€šè¿‡ XML é…ç½®æ–‡ä»¶æˆ–å…¶ä»–éæ³¨è§£æ–¹å¼é…ç½®çš„ AspectJ åˆ‡é¢ã€‚ 1.2.3 AnnotationAwareAspectJAutoProxyCreator ä½œç”¨ï¼šè¿™ä¸ªç±»æ˜¯ AspectJAwareAdvisorAutoProxyCreator çš„å­ç±»ï¼Œå®ƒåœ¨ AbstractAdvisorAutoProxyCreator çš„åŸºç¡€ä¸Šå¢åŠ äº†å¯¹ AspectJ æ³¨è§£çš„æ”¯æŒã€‚ å·¥ä½œåŸç†ï¼šå®ƒä¸ä»…æ‰«æå®¹å™¨ä¸­çš„ Advisorï¼Œè¿˜æ‰«æä½¿ç”¨äº† AspectJ æ³¨è§£ï¼ˆå¦‚ @Aspectã€@Beforeã€@After ç­‰ï¼‰çš„ Beanï¼Œå¹¶å°†è¿™äº›æ³¨è§£é…ç½®çš„åˆ‡é¢åº”ç”¨åˆ°åŒ¹é…çš„ Bean ä¸Šã€‚ 2. è‡ªåŠ¨ä»£ç†å·¥ä½œæµç¨‹2.1 AnnotationAwareAspectJAutoProxyCreatorçš„å®ä¾‹åŒ–æˆ‘ä»¬å·²ç»çŸ¥é“AnnotationAwareAspectJAutoProxyCreatorå…¶æœ¬è´¨ä¸€ä¸ªBeanPostProcessor åœ¨ [Spring IOC å®¹å™¨å¯åŠ¨è¿‡ç¨‹æ‹“å±•ç‚¹](obsidian://open?vault=Documents&amp;file=second-brain%2F1-tech%2FSpring%20%E5%AE%B6%E6%97%8F%2Fnew%2F3-%20Spring%20%E6%8B%93%E5%B1%95%E7%82%B9) ä¸€æ–‡ä¸­ï¼Œå·²ç»è¯¦ç»†ä»‹ç»è¿‡ ä¸€ä¸ªBeanPostProcessor` çš„å®ä¾‹åŒ–æˆ–è€…æ³¨å†Œè¿‡ç¨‹ï¼Œæ˜¯åœ¨åœ¨registerBeanPostProcessorsæµç¨‹ä¸­12345678910111213141516AbstractApplicationContext.java@Override public void refresh() throws BeansException, IllegalStateException &#123;\t// 1. åˆ›å»ºbeanFactory ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();\t// 2.Invoke factory processors registered as beans in the context. invokeBeanFactoryPostProcessors(beanFactory); // 3.Register bean processors that intercept bean creation. registerBeanPostProcessors(beanFactory);\t// 4. beançš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œä¾èµ–å…³ç³»çš„è£…é…\tfinishBeanFactoryInitialization(beanFactory);&#125; å±•å¼€registerBeanPostProcessors çœ‹ä¸€ä¸‹1234567891011121314151617181920212223PostProcessorRegistrationDelegate.javapublic static void registerBeanPostProcessors( ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) &#123;\tbeanFactory.addBeanPostProcessor(new BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));&#125;AbstractBeanFactory.javapublic void addBeanPostProcessor(BeanPostProcessor beanPostProcessor) &#123; // Remove from old position, if any this.beanPostProcessors.remove(beanPostProcessor); // Track whether it is instantiation/destruction aware if (beanPostProcessor instanceof InstantiationAwareBeanPostProcessor) &#123; this.hasInstantiationAwareBeanPostProcessors = true; &#125; if (beanPostProcessor instanceof DestructionAwareBeanPostProcessor) &#123; this.hasDestructionAwareBeanPostProcessors = true; &#125; // Add to end of list this.beanPostProcessors.add(beanPostProcessor); &#125; 2.1.1 hasInstantiationAwareBeanPostProcessorsæ ¹æ®ä¸Šé¢çš„ç»§æ‰¿ä¾èµ–ç»“æ„ï¼Œå¯ä»¥çœ‹å‡ºAnnotationAwareAspectJAutoProxyCreator å®ç°äº† InstantiationAwareBeanPostProcessor ï¼Œæ‰€ä»¥hasInstantiationAwareBeanPostProcessorsä¼šè¢«è®¾ç½®ä¸ºtrue çŠ¶æ€æ ‡è®°: å½“Springå®¹å™¨åˆå§‹åŒ–æ—¶ï¼Œä¼šæ‰«æå¹¶æ³¨å†Œæ‰€æœ‰çš„BeanPostProcessorï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶å€™è®¾ç½®è¿™ä¸ªå˜é‡çš„å€¼ã€‚å¦‚æœå®¹å™¨ä¸­æ³¨å†Œäº†è‡³å°‘ä¸€ä¸ªInstantiationAwareBeanPostProcessorï¼Œè¿™ä¸ªå˜é‡ä¼šè¢«è®¾ç½®ä¸ºtrueã€‚ç”¨äºå†³å®šæ˜¯å¦æ‰§è¡ŒæŸäº›ç‰¹å®šçš„å¤„ç†é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œåœ¨å®ä¾‹åŒ–beanä¹‹å‰ï¼ŒSpringå®¹å™¨ä¼šæ£€æŸ¥è¿™ä¸ªå˜é‡ä»¥å†³å®šæ˜¯å¦éœ€è¦è°ƒç”¨InstantiationAwareBeanPostProcessorçš„postProcessBeforeInstantiationæ–¹æ³•ã€‚ æ€§èƒ½æå‡ï¼šå¦‚æœæ²¡æœ‰æ³¨å†Œä»»ä½•InstantiationAwareBeanPostProcessorï¼Œåˆ™å¯ä»¥è·³è¿‡ä¸€äº›ä¸å¿…è¦çš„æ£€æŸ¥å’Œè°ƒç”¨ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚ 2.2 ä»£ç†å¯¹è±¡çš„ç”Ÿæˆæ—¶æœº- init é˜¶æ®µä¸šåŠ¡bean ä»£ç†å¯¹è±¡çš„ç”Ÿæˆæ—¶æœºï¼Œä¹Ÿå¯ä»¥ç†è§£æˆæ˜¯AnnotationAwareAspectJAutoProxyCreator çš„ä»‹å…¥ bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸ºä¸šåŠ¡beanç”Ÿæˆä»£ç†å¯¹è±¡çš„æ—¶æœºã€‚ åœ¨ Spring bean å®ä¾‹åŒ–ä¸€æ–‡ä¸­ï¼Œå·²ç»ä»‹ç»è¿‡ï¼ŒBeanPostProcessor æ˜¯åœ¨bean å®ä¾‹åŒ–çš„init é˜¶æ®µï¼Œé€šè¿‡ postProcessAfterInitialization æ–¹æ³•æ¥ä»‹å…¥æ™®é€šbean çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸ºå…¶ç”Ÿæˆä»£ç†å¯¹è±¡çš„ 123456789101112131415161718192021222324252627public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory implements AutowireCapableBeanFactory &#123;\tprotected Object initializeBean(String beanName, Object bean, @Nullable RootBeanDefinition mbd) &#123; invokeAwareMethods(beanName, bean); applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); invokeInitMethods(beanName, wrappedBean, mbd); applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); &#125; @Override public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) throws BeansException &#123; Object result = existingBean; for (BeanPostProcessor processor : getBeanPostProcessors()) &#123; Object current = processor.postProcessAfterInitialization(result, beanName); if (current == null) &#123; return result; &#125; result = current; &#125; return result; &#125;&#125; å½“é‡åˆ°AnnotationAwareAspectJAutoProxyCreatoræ—¶ï¼Œ ä¼šè¿›è¡Œå…¶postProcessAfterInitializationæ–¹æ³•ï¼Œå¼€å§‹æ‰§è¡Œä»£ç†å¯¹è±¡ç”Ÿæˆçš„é€»è¾‘ï¼Œä¸‹å›¾debug å›¾ç‰‡ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ç›¸å…³ä¿¡æ¯ï¼Œ ä»¥åŠå®é™…è¿›å…¥åˆ°çš„æ˜¯AnnotationAwareAspectJAutoProxyCreatorçš„çˆ¶ç±»ï¼ŒAbstractAutoProxyCreator 2.3 wrapIfNecessaryåœ¨SpringBoot é¡¹ç›®å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰çš„ä¸šåŠ¡bean å®ä¾‹åŒ–è¿‡ç¨‹ä¸­éƒ½åœ¨åœ¨initializeBean é˜¶æ®µè¿›å…¥AnnotationAwareAspectJAutoProxyCreator.postProcessAfterInitialization æ–¹æ³•ï¼Œåªè¦è¿™ä¸ªæ‹“å±•ç‚¹å­˜åœ¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„beanéƒ½ä¼šè¿›è¡Œæ˜¯å¦ä»£ç†çš„åˆ¤æ–­ï¼Œåªæ˜¯æœ‰çš„ä¸éœ€è¦ç›´æ¥è¿”å›åŸbeanå³å¯ï¼Œæœ‰çš„éœ€è¦å°±è¡Œè¿›è¡Œä»£ç†å¯¹è±¡çš„ç”Ÿæˆå¹¶è¿”å› 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253public abstract class AbstractAutoProxyCreator extends ProxyProcessorSupport implements SmartInstantiationAwareBeanPostProcessor, BeanFactoryAware &#123; @Override public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) &#123; if (bean != null) &#123; Object cacheKey = getCacheKey(bean.getClass(), beanName); if (this.earlyProxyReferences.remove(cacheKey) != bean) &#123; return wrapIfNecessary(bean, beanName, cacheKey); &#125; &#125; return bean; &#125; // ç”¨äºä¸ºBeanåˆ›å»ºä»£ç†å¯¹è±¡ä»¥å®ç°AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰çš„åŠŸèƒ½\tprotected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123; // æ£€æŸ¥Beanåç§°æ˜¯å¦éç©ºä¸”æ˜¯å¦å·²ç»åœ¨targetSourcedBeansé›†åˆä¸­ã€‚ // å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œè¯´æ˜è¿™ä¸ªBeanä¸éœ€è¦ä»£ç†ï¼Œç›´æ¥è¿”å›åŸå§‹Beanã€‚ if (StringUtils.hasLength(beanName) &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123; return bean; &#125; // ä»advisedBeansç¼“å­˜ä¸­æ£€æŸ¥æ˜¯å¦å·²ç»è®°å½•äº†è¯¥Beanä¸éœ€è¦ä»£ç†,å³ç¼“å­˜ä¸­å­˜åœ¨ä¸”å€¼ä¸ºBoolean.FALSEï¼Œç›´æ¥è¿”å›åŸå§‹Beanã€‚ if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123; return bean; &#125; // æ£€æŸ¥Beanæ˜¯å¦æ˜¯Springçš„åŸºç¡€è®¾æ–½ç±»ï¼Œæ¯”å¦‚Adviceã€Advisorç­‰ // æ£€æŸ¥æ˜¯å¦åº”è¯¥è·³è¿‡ä»£ç†è¯¥Bean if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123; // å¦‚æœæ»¡è¶³ä»¥ä¸Šæ¡ä»¶ï¼Œè®°å½•è¯¥Beanä¸éœ€è¦ä»£ç†å¹¶è¿”å›åŸå§‹Beanï¼Œçœ‹åˆå‡ºç°äº†ç¼“å­˜ç”¨äºæå‡æ€§èƒ½ this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean; &#125; // Create proxy if we have advice. // è·å–å¯ä»¥ç”¨åœ¨è¯¥bean ä¸Šçš„å¢å¼º Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null); if (specificInterceptors != DO_NOT_PROXY) &#123; // å¦‚æœæ²¡æœ‰éœ€è¦ç”¨åœ¨è¯¥beançš„Advice, this.advisedBeans.put(cacheKey, Boolean.TRUE); // åˆ›å»ºè¯¥beançš„ä»£ç†å¯¹è±¡å¹¶è®°å½• Object proxy = createProxy( bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean)); this.proxyTypes.put(cacheKey, proxy.getClass()); return proxy; &#125; // å¦‚æœæ²¡æœ‰éœ€è¦ç”¨åœ¨è¯¥beançš„Advice, è®°å½•è¯¥beanä¸éœ€è¦ä»£ç†ç›´æ¥è¿”å›å³å¯ this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean;\t&#125; &#125; wrapIfNecessaryæ–¹æ³•çš„é‡ç‚¹é€»è¾‘çœ‹2æ­¥ getAdvicesAndAdvisorsForBean ä¸ºå½“å‰ç±»å¯»æ‰¾å¯ç”¨çš„å¢å¼º createProxy å¦‚æœæ‰¾åˆ°äº†å¯ç”¨çš„å¢å¼ºï¼Œåˆ™åˆ›å»ºä»£ç†å¯¹è±¡2.4 getAdvicesAndAdvisorsForBeanä¸ºå½“å‰ç±»å¯»æ‰¾å¯ç”¨çš„å¢å¼º 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public abstract class AbstractAdvisorAutoProxyCreator extends AbstractAutoProxyCreator &#123; @Override\t@Nullable\tprotected Object[] getAdvicesAndAdvisorsForBean( Class&lt;?&gt; beanClass, String beanName, @Nullable TargetSource targetSource) &#123; List&lt;Advisor&gt; advisors = findEligibleAdvisors(beanClass, beanName); if (advisors.isEmpty()) &#123; return DO_NOT_PROXY; &#125; return advisors.toArray();\t&#125; protected List&lt;Advisor&gt; findEligibleAdvisors(Class&lt;?&gt; beanClass, String beanName) &#123; // å…ˆæ‰¾å‡ºå½“å‰Spring å®¹å™¨ä¸­å­˜åœ¨çš„æ‰€æœ‰Advisor List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors(); // æ ¹æ®Advisor æ‰¾å‡ºå¯ä»¥ç”¨åœ¨å½“å‰beanä¸Šçš„å¢å¼º List&lt;Advisor&gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName); extendAdvisors(eligibleAdvisors); if (!eligibleAdvisors.isEmpty()) &#123; eligibleAdvisors = sortAdvisors(eligibleAdvisors); &#125; return eligibleAdvisors;\t&#125; // æ‰¾å‡ºå½“å‰Spring å®¹å™¨ä¸­å­˜åœ¨çš„æ‰€æœ‰Advisor protected List&lt;Advisor&gt; findCandidateAdvisors() &#123; Assert.state(this.advisorRetrievalHelper != null, &quot;No BeanFactoryAdvisorRetrievalHelper available&quot;); return this.advisorRetrievalHelper.findAdvisorBeans();\t&#125; // æ ¹æ®Advisor æ‰¾å‡ºå¯ä»¥ç”¨åœ¨å½“å‰beanä¸Šçš„å¢å¼º protected List&lt;Advisor&gt; findAdvisorsThatCanApply( List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; beanClass, String beanName) &#123; ProxyCreationContext.setCurrentProxiedBeanName(beanName); try &#123; return AopUtils.findAdvisorsThatCanApply(candidateAdvisors, beanClass); &#125; finally &#123; ProxyCreationContext.setCurrentProxiedBeanName(null); &#125;\t&#125;&#125; æœ€ç»ˆå¾—åˆ°å½“å‰ç±»å¯ç”¨çš„bean, ä»£ç†é€»è¾‘æŒºæ·±çš„ æ‰¾åˆ°å½“å‰Spring å®¹å™¨ä¸­æ‰€æœ‰çš„Advisor æ‰¾åˆ°å¯ä»¥ç”¨åœ¨å½“å‰ç±»çš„Advisor ï¼šå¯¹æ‰¾åˆ°çš„æ‰€æœ‰çš„Advisorå¾ªç¯åˆ¤æ–­æ˜¯å¦å¯ä»¥ç”¨åœ¨å½“å‰ç±»ä¸Š æˆ‘ä»¬é‡ç‚¹çœ‹ç¬¬äºŒæ­¥ï¼ŒfindAdvisorsThatCanApply è¿™ä¸ªæ–¹æ³• 2.4.1 findAdvisorsThatCanApply-&gt;canApplyåœ¨ä¸€ç»„å€™é€‰çš„Advisorä¸­ï¼Œæ‰¾å‡ºå¯ä»¥åº”ç”¨äºæŒ‡å®šç±»çš„Advisorã€‚12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182public abstract class AopUtils &#123; public static List&lt;Advisor&gt; findAdvisorsThatCanApply(List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; clazz) &#123; if (candidateAdvisors.isEmpty()) &#123; return candidateAdvisors; &#125; List&lt;Advisor&gt; eligibleAdvisors = new ArrayList&lt;&gt;(); // å…ˆå¤„ç† IntroductionAdvisor for (Advisor candidate : candidateAdvisors) &#123; if (candidate instanceof IntroductionAdvisor &amp;&amp; canApply(candidate, clazz)) &#123; eligibleAdvisors.add(candidate); &#125; &#125; boolean hasIntroductions = !eligibleAdvisors.isEmpty(); // å†å¤„ç†å…¶ä»–ç±»å‹çš„Advisor for (Advisor candidate : candidateAdvisors) &#123; if (candidate instanceof IntroductionAdvisor) &#123; // already processed continue; &#125; if (canApply(candidate, clazz, hasIntroductions)) &#123; eligibleAdvisors.add(candidate); &#125; &#125; return eligibleAdvisors;\t&#125; // å¯¹äºIntroductionAdvisorï¼ŒcanApply(candidate, clazz)æœ€ç»ˆä¹Ÿæ˜¯ä½¿ç”¨è¿™ä¸ªæ–¹æ³• public static boolean canApply(Advisor advisor, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123; if (advisor instanceof IntroductionAdvisor) &#123; return ((IntroductionAdvisor) advisor).getClassFilter().matches(targetClass); &#125; else if (advisor instanceof PointcutAdvisor) &#123; PointcutAdvisor pca = (PointcutAdvisor) advisor; return canApply(pca.getPointcut(), targetClass, hasIntroductions); &#125; else &#123; // It doesn&#x27;t have a pointcut so we assume it applies. return true; &#125;\t&#125; // è¿™é‡Œæ˜¯çœŸæ­£çš„è¿‡æ»¤é€»è¾‘ï¼Œ å…ˆåŒ¹é…ç±»ï¼Œå†åŒ¹é…æ–¹æ³• public static boolean canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123; Assert.notNull(pc, &quot;Pointcut must not be null&quot;); if (!pc.getClassFilter().matches(targetClass)) &#123; return false; &#125; MethodMatcher methodMatcher = pc.getMethodMatcher(); if (methodMatcher == MethodMatcher.TRUE) &#123; // No need to iterate the methods if we&#x27;re matching any method anyway... return true; &#125; IntroductionAwareMethodMatcher introductionAwareMethodMatcher = null; if (methodMatcher instanceof IntroductionAwareMethodMatcher) &#123; introductionAwareMethodMatcher = (IntroductionAwareMethodMatcher) methodMatcher; &#125; Set&lt;Class&lt;?&gt;&gt; classes = new LinkedHashSet&lt;&gt;(); if (!Proxy.isProxyClass(targetClass)) &#123; classes.add(ClassUtils.getUserClass(targetClass)); &#125; classes.addAll(ClassUtils.getAllInterfacesForClassAsSet(targetClass)); for (Class&lt;?&gt; clazz : classes) &#123; Method[] methods = ReflectionUtils.getAllDeclaredMethods(clazz); for (Method method : methods) &#123; if (introductionAwareMethodMatcher != null ? introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions) : methodMatcher.matches(method, targetClass)) &#123; return true; &#125; &#125; &#125; return false;\t&#125;&#125; æ•´ä½“é€»è¾‘ å…ˆæŠŠAdvisor åˆ†æˆä¸¤ç±»ï¼ŒIntroductionAdvisor å’Œå…¶ä»–Advisor, å…ˆæ£€æŸ¥å’Œå¤„ç†IntroductionAdvisorçš„ä¸»è¦åŸå› æ˜¯å®ƒä»¬å¯¹ç›®æ ‡ç±»ç»“æ„çš„å½±å“è¾ƒå¤§ï¼Œé€šè¿‡å¼•å…¥æ–°çš„æ¥å£å’ŒåŠŸèƒ½ï¼Œæ”¹å˜äº†ç›®æ ‡ç±»çš„å½¢æ€ã€‚å› æ­¤ï¼Œåœ¨å¤„ç†å…¶ä»–å¸¸è§„Advisorä¹‹å‰ï¼Œç¡®ä¿IntroductionAdvisorå·²ç»è¢«æ­£ç¡®åº”ç”¨ å¯¹Advidor ä¾æ¬¡è¿›è¡Œç±»åŒ¹é…ã€æ–¹æ³•åŒ¹é…ï¼Œ çœ‹æ˜¯å¦ç¬¦åˆåˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œåœ¨ä»¥ä¸‹æ–¹æ³•ä¸­å…·ä½“å®ç° 1canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions) è§‚å¯Ÿè¿™ä¸ªæ–¹æ³•çš„è¿‡æ»¤é€»è¾‘ï¼Œ å…¶å®å’Œæ‰‹åŠ¨é…ç½®æ–¹å¼ä¸­getInterceptorsAndDynamicInterceptionAdviceæ–¹æ³•çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯é€šè¿‡å®ç°PointcutåŒ¹é…ç±»ï¼Œä»¥åŠMethodMatcher åŒ¹é…æ–¹æ³•å®ç°ï¼Œ åªä¸è¿‡åœ¨æ‰‹åŠ¨é…ç½®æ–¹å¼ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ˜¾ç¤ºå†™æ˜ç±»å»è‡ªå®šä¹‰å®ç° Pointcutã€MethodMatcher ï¼Œä½†æ˜¯åœ¨è‡ªåŠ¨ä»£ç†çš„æ³¨è§£æ–¹å¼ä¸­ï¼Œ Spring ä¼šè‡ªåŠ¨æŒ‰ç…§æˆ‘ä»¬ç»™å‡ºçš„åˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œè‡ªåŠ¨å®ç°è¿™ä¸€åŠŸèƒ½ 2.5 createProxy12345public class ProxyFactory extends ProxyCreatorSupport &#123;\tpublic Object getProxy(@Nullable ClassLoader classLoader) &#123; return createAopProxy().getProxy(classLoader); &#125;&#125; é€»è¾‘ä»è¿™é‡Œå¼€å§‹å°±å’Œ Spring AOP æ³¨è§£æ–¹å¼åŸç†è¯¦è§£ä¸­å¼€å§‹å®Œå…¨é‡åˆäº†ï¼Œå°±ä¸å†èµ˜è¿° createAopProxyï¼š ç¡®å®šåŠ¨æ€ä»£ç†çš„ç±»å‹ï¼Œ JDK åŠ¨æ€ä»£ç† or CGlib, åˆ¤æ–­çš„é€»è¾‘ä¹Ÿéå¸¸ç®€å•ï¼Œå¯ä»¥ç®€å•è®¤ä¸ºå°±æ˜¯æœ‰æ²¡æœ‰å®ç°æ¥å£ å®ç°äº†æ¥å£ï¼Œç”¨JDK åŠ¨æ€ä»£ç† æ²¡æœ‰å®ç°æ¥å£ï¼Œç”¨CGlib åŠ¨æ€ä»£ç† getProxyï¼šæ ¹æ®ç¡®å®šçš„åŠ¨æ€ä»£ç†ï¼Œåˆ›å»ºtarget çš„ä»£ç†å¯¹è±¡ æœ€ç»ˆç»™userService ç”Ÿæˆäº†ä¸€ä¸ªCglib åŠ¨æ€ä»£ç†å¯¹è±¡ 2.6 æ–¹æ³•æ‰§è¡Œå’Œ Spring AOP æ³¨è§£æ–¹å¼åŸç†è¯¦è§£ä¸­å¼€å§‹å®Œå…¨é‡åˆäº†ï¼Œå°±ä¸å†èµ˜è¿° 3. ä»£ç†å¯¹è±¡çš„è·å–æ–¹å¼å¯¹æ¯”æ‰‹åŠ¨é…ç½®æ–¹å¼ä½¿ç”¨ProxyFactoryBean, ä¸ä»‹å…¥beanåˆ°ç”Ÿå‘½å‘¨æœŸï¼Œè€Œæ˜¯åœ¨å®ä¾‹åŒ–å®Œæˆåé€šè¿‡getObjectForBeanInstance å®Œæˆä»£ç†å¯¹è±¡çš„ç”Ÿæˆ æ³¨è§£æ–¹å¼çš„è‡ªåŠ¨ä»£ç†æœºåˆ¶ï¼Œä»‹å…¥bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œåœ¨init é˜¶æ®µï¼Œé€šè¿‡BeanPostProcessor.postProcessAfterInitializationè·å–ä»£ç†å¯¹è±¡ã€‚ ä½†æ˜¯ä¸è®ºå“ªç§æ–¹å¼ï¼Œ åº•å±‚åˆ¤æ–­ä½¿ç”¨å“ªç§ä»£ç†ï¼Œå¢å¼ºç»‡å…¥çš„é€»è¾‘ã€ä»¥åŠæ–¹æ³•çš„æ‰§è¡Œå‡æ˜¯ä½¿ç”¨åŒä¸€å¥—ä»£ç å®Œå…¨ç›¸åŒçš„é€»è¾‘","tags":["java","Spring"]},{"title":"Spring AOP XMLé…ç½®æ–¹å¼åŸç†è¯¦è§£","path":"/a10675df/","content":"ProxyFactoryBeanå¯¹åº”XML æ‰‹åŠ¨é…ç½®æ–¹å¼ï¼Œ æœ¬æ–‡å°†åŸºäºä»¥ä¸‹demoä»£ç åˆ†æ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public class UserService &#123; public void createUser(String username) &#123; // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† System.out.println(&quot;Creating user: &quot; + username); &#125; public void deleteUser(String username) &#123; // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† System.out.println(&quot;Deleting user: &quot; + username); &#125;&#125;// å®šä¹‰ä¸€ä¸ªå‰ç½®å¢å¼ºpublic class LoggingBeforeAdvice implements MethodBeforeAdvice &#123; @Override public void before(Method method, Object[] args, Object target) throws Throwable &#123; System.out.println(&quot;Before method: &quot; + method.getName()); &#125;&#125;// å®šä¹‰ä¸€ä¸ªåç½®å¢å¼ºpublic class LoggingAfterAdvice implements AfterReturningAdvice &#123; @Override public void afterReturning(Object returnValue, Method method, Object[] args, Object target) throws Throwable &#123; System.out.println(&quot;After method: &quot; + method.getName()); &#125;&#125;// å®šä¹‰ä¸€ä¸ª ç¯ç»•å¢å¼ºpublic class LoggingMethodInterceptor implements MethodInterceptor &#123; @Override public Object invoke(MethodInvocation invocation) throws Throwable &#123; // æ–¹æ³•æ‰§è¡Œå‰é€»è¾‘ long startTime = System.currentTimeMillis(); System.out.println(invocation.getMethod().getName()+ &quot; æ–¹æ³•å¼€å§‹æ‰§è¡Œ&quot;); // é€šè¿‡åå°„æ‰§è¡Œç›®æ ‡æ–¹æ³• Object result = invocation.proceed(); // æ–¹æ³•æ‰§è¡Œåé€»è¾‘ //System.out.println(&quot;After method: &quot; + invocation.getMethod().getName()); long endTime = System.currentTimeMillis(); System.out.println(invocation.getMethod().getName()+ &quot;æ–¹æ³•æ‰§è¡Œæ—¶é—´: &quot; + (endTime - startTime) + &quot;ms&quot;); return result; &#125;&#125; 1234567891011121314151617181920212223242526272829303132333435363738&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt; &lt;!-- å®šä¹‰ä¸šåŠ¡ç±»çš„ Bean --&gt; &lt;bean id=&quot;userService&quot; class=&quot;com.example.codingInAction.service.UserService&quot;/&gt; &lt;!-- å®šä¹‰ å‰ç½®å¢å¼º --&gt; &lt;bean id=&quot;loggingBeforeAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingBeforeAdvice&quot;/&gt; &lt;!-- å®šä¹‰ åç½®å¢å¼º --&gt; &lt;bean id=&quot;loggingAfterAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingAfterAdvice&quot;/&gt; &lt;!-- å®šä¹‰ ç¯ç»•å¢å¼º --&gt; &lt;bean id=&quot;loggingMethodInterceptor&quot; class=&quot;com.example.codingInAction.aop.LoggingMethodInterceptor&quot;/&gt; &lt;!-- ä½¿ç”¨ ProxyFactoryBean é…ç½®ä»£ç†å¯¹è±¡ --&gt; &lt;bean id=&quot;userServiceProxy&quot; class=&quot;org.springframework.aop.framework.ProxyFactoryBean&quot;&gt; &lt;!-- ç›®æ ‡å¯¹è±¡ --&gt; &lt;property name=&quot;target&quot; ref=&quot;userService&quot;/&gt; &lt;!-- æ‹¦æˆªå™¨ --&gt; &lt;property name=&quot;interceptorNames&quot;&gt; &lt;list&gt; &lt;value&gt;loggingMethodInterceptor&lt;/value&gt; &lt;value&gt;loggingBeforeAdvice&lt;/value&gt; &lt;value&gt;loggingAfterAdvice&lt;/value&gt; &lt;/list&gt; &lt;/property&gt; &lt;!-- å¼ºåˆ¶ä½¿ç”¨CGLIBä»£ç† --&gt; &lt;property name=&quot;proxyTargetClass&quot; value=&quot;true&quot;/&gt; &lt;/bean&gt;&lt;/beans&gt; ä»å¯åŠ¨å…¥å£å¼€å§‹åˆ†æ 1234567891011121314public class CodingInActionApplication&#123; public static void main(String[] args) &#123; ApplicationContext context = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); // è·å–ä»£ç†å¯¹è±¡ UserService userService = (UserService) context.getBean(&quot;userServiceProxy&quot;); // è°ƒç”¨æ–¹æ³•ï¼Œè§‚å¯Ÿ AOP åˆ‡é¢çš„æ•ˆæœ userService.createUser(&quot;john&quot;); userService.deleteUser(&quot;john&quot;); &#125;&#125; 1 ProxyFactoryBean å®ä¾‹åŒ–1new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;) è¯¥è¡Œä»£ç å¯¹åº”Spring IOC å®¹å™¨çš„å¯åŠ¨è¿‡ç¨‹ å¦‚å›¾ä¸­æ‰€ç¤ºï¼Œåº”ç”¨ä¸Šä¸‹æ–‡å¯åŠ¨åï¼ŒIOC å®¹å™¨ beanFactory éœ€è¦åˆå§‹åŒ–5ä¸ªbeanï¼Œ éƒ½æ˜¯åœ¨XML æ–‡ä»¶ä¸­å®šä¹‰çš„æ•°æ®ï¼Œå…¶å®å‰4ä¸ªéƒ½æ˜¯æˆ‘ä»¬éå¸¸ç†Ÿæ‚‰çš„æ™®é€šä¸šåŠ¡beanã€‚ userServiceProxy æ˜¯é…ç½®çš„ProxyFactoryBean, å½“å®ä¾‹åŒ–userServiceProxyæ—¶ï¼Œä¸å¸¸è§å…­å±‚ç•¥æœ‰ä¸åŒ,ä¸»è¦æ˜¯ä»¥ä¸‹2ç‚¹ 1.1 isFactoryBeanuserServiceProxyä¼šåœ¨isFactoryBean åˆ¤æ–­ä¸­ç»“æœä¸ºtrue, éœ€è¦åŠ ä¸ŠFactoryBean å‰ç¼€ &amp; åæ‰å¼€å§‹è¿›è¡Œå®ä¾‹åŒ–ï¼Œ åœ¨ ç†è§£ Spring FacrotyBean,å·²ç»æåˆ°FactoryBeanä¹Ÿæ˜¯ä¸€ä¸ªbean , æ‰€ä»¥åœ¨IOC å®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šè¿›è¡Œå®ä¾‹åŒ– é’ˆå¯¹ä¸€ä¸ªfactoryBean ä½¿ç”¨ getBean(&quot;&amp;beanName&quot;) å¯ä»¥è·å– FactoryBean å®ä¾‹æœ¬èº«ï¼Œè€Œä¸æ˜¯ FactoryBean åˆ›å»ºçš„å¯¹è±¡ã€‚ ä½¿ç”¨ getBean(&quot;beanName&quot;) åˆ™è·å–ç”± FactoryBean åˆ›å»ºçš„å¯¹è±¡ã€‚ åŸºäºä»¥ä¸Š2ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ï¼Œåœ¨IOC å®¹å™¨å¯åŠ¨ï¼Œå®ä¾‹åŒ–beançš„è¿‡ç¨‹ä¸­ï¼Œ ç»è¿‡getBean(â€œ&amp;userServiceProxyâ€)ï¼Œ æœ€ç»ˆæ”¾å…¥IOC å®¹å™¨ä¸­çš„userServiceProxy è¿™ä¸ªå·¥å‚bean æœ¬èº«ã€‚ 1.2 getObjectForBeanInstanceè¿›å…¥æˆ‘ä»¬åº”è¯¥éå¸¸ç†Ÿæ‚‰çš„getBean æµç¨‹ è¿™æ˜¯IOC å®¹å™¨åœ¨è¿›è¡Œbean çš„åˆå§‹åŒ–æµç¨‹ï¼Œå¯¹äºuserServiceProxy è¿™ä¸ªbean æ¥è®²ï¼Œæ­¤æ—¶ä¸‰çº§ç¼“å­˜ä¸­è‚¯å®šä¸å­˜åœ¨å®ƒçš„ç¼“å­˜ï¼Œ æ‰€ä»¥ä¼šè¿›å…¥åˆ°ä»¥ä¸‹å•ä¾‹bean çš„åˆ›å»ºæµç¨‹ï¼Œåˆ›å»ºæµç¨‹å°±ä¸è¿›å»ç»†çœ‹äº†ï¼Œå¯ä»¥å»å‚è€ƒæ–‡ç«  Spring bean å®ä¾‹åŒ– æœ€åè¿›å…¥åœ¨ Spring bean å®ä¾‹åŒ–ä¸€æ–‡ä¸­é‡ç‚¹è®²è¿‡çš„ç”¨äºå¤„ç†FactoryBean çš„getObjectForBeanInstance æ–¹æ³•ï¼Œ getBean æ–¹æ³•ä¼ å…¥çš„å‚æ•°name æ˜¯&amp;userServiceProxyï¼Œ è¯´æ˜ç»è¿‡getObjectForBeanInstance æ–¹æ³•å¤„ç†åï¼Œæœ€ç»ˆè¿”å›äº†FactoryBean æœ¬èº«ï¼Œ åœ¨è¿™æ¬¡debug è¿‡ç¨‹ä¸­ï¼Œå³æ˜¯ProxyFactoryBean 2 getBean-è·å–ä»£ç†å¯¹è±¡Spring IOC å®¹å™¨å¯åŠ¨å®Œæˆåï¼Œå°±å¯ä»¥ä»å®¹å™¨ä¸­è·å–éœ€è¦çš„bean äº† 1UserService userService = (UserService) context.getBean(&quot;userServiceProxy&quot;); ç”±äºuserServiceProxy æ˜¯FactoryBean, ç°åœ¨æ‰§è¡ŒgetBean(&quot;beanName&quot;) è¯´æ˜æˆ‘ä»¬è¦è·å–ç”±å®ƒåˆ›å»ºçš„å¯¹è±¡äº†ã€‚ä¸‹é¢è·Ÿç€ä»£ç è¿›è¡Œç®€å•åˆ†æã€‚ 2.1 getObjectForBeanInstanceè¿›å…¥æºç ï¼Œå†æ¬¡æ¥åˆ°getBean æµç¨‹ï¼Œ æ­¤æ—¶getSingleton,ä¸€çº§ç¼“å­˜ä¸­å·²ç»æœ‰äº†IOC å®¹å™¨å¯åŠ¨è¿‡ç¨‹çš„ä¸­åˆ›å»ºçš„å®ä¾‹ï¼Œ ç›´æ¥è·å–å³å¯ã€‚å†æ¬¡è¿›å…¥getObjectForBeanInstance æ–¹æ³• 2.2 FactoryBean.getObjectåœ¨getObjectForBeanInstance æ–¹æ³•ä¸­ï¼Œé€æ¸æ·±å…¥æœ€ç»ˆä¼šè¿›å…¥åˆ°ProxyFactoryBean é‡å†™çš„getObject æ–¹æ³•ï¼ˆgetObject æ˜¯æ¥å£FactoryBean ä¸­å®šä¹‰çš„æ–¹æ³•è¿˜è®°å¾—å—ï¼‰ åˆ†æProxyFactoryBean.getObject() ,ä¸»è¦ä»£ç å¯ä»¥åˆ†æˆ2ä¸ªæ­¥éª¤ 123456789101112131415161718192021222324252627282930313233343536public class ProxyFactoryBean extends ProxyCreatorSupport implements FactoryBean&lt;Object&gt;, BeanClassLoaderAware, BeanFactoryAware &#123; public Object getObject() throws BeansException &#123; initializeAdvisorChain(); if (isSingleton()) &#123; return getSingletonInstance(); &#125; else &#123; if (this.targetName == null) &#123; logger.info(&quot;Using non-singleton proxies with singleton targets is often undesirable. &quot; + &quot;Enable prototype proxies by setting the &#x27;targetName&#x27; property.&quot;); &#125; return newPrototypeInstance(); &#125; &#125; private synchronized Object getSingletonInstance() &#123; if (this.singletonInstance == null) &#123; this.targetSource = freshTargetSource(); if (this.autodetectInterfaces &amp;&amp; getProxiedInterfaces().length == 0 &amp;&amp; !isProxyTargetClass()) &#123; // Rely on AOP infrastructure to tell us what interfaces to proxy. Class&lt;?&gt; targetClass = getTargetClass(); if (targetClass == null) &#123; throw new FactoryBeanNotInitializedException(&quot;Cannot determine target class for proxy&quot;); &#125; setInterfaces(ClassUtils.getAllInterfacesForClass(targetClass, this.proxyClassLoader)); &#125; // Initialize the shared singleton instance. super.setFrozen(this.freezeProxy); this.singletonInstance = getProxy(createAopProxy()); &#125; return this.singletonInstance;\t&#125;&#125; 2.3 initializeAdvisorChainè¯¥æ–¹æ³•çš„ä¸»è¦é€»è¾‘æ˜¯æ ¹æ®é…ç½®çš„interceptorNamesåˆå§‹åŒ–AdvisorChainï¼Œç¡®ä¿åœ¨æ‰§è¡Œåˆ‡é¢é€»è¾‘æ—¶ï¼Œæ‰€æœ‰çš„Advisorå’ŒInterceptoréƒ½å·²æ­£ç¡®é…ç½®å’Œåˆå§‹åŒ–ã€‚ AdvisorChain å°±æ˜¯ä¸€ä¸ªListæ•°æ®ç»“æ„ï¼Œå­˜å‚¨æ ¹æ®interceptorName è·å–å¯¹åº”å®ä¾‹1advice = this.beanFactory.getBean(name); å¯¹äºå•ä¾‹beanæ¥è®²ï¼Œå°±æ˜¯ä»å‰é¢å¯åŠ¨å®Œæˆçš„IOC å®¹å™¨ä¸­ï¼Œæ ¹æ®name é€šè¿‡getBean æ–¹æ³•å–å‡ºå¯¹åº”çš„å®ä¾‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859private synchronized void initializeAdvisorChain() throws AopConfigException, BeansException &#123;\t// æ£€æŸ¥Advisor Chainæ˜¯å¦å·²ç»åˆå§‹åŒ–\t// å¦‚æœadvisorChainInitializedæ ‡å¿—å·²ç»ä¸ºtrueï¼Œè¡¨ç¤ºAdvisor Chainå·²ç»åˆå§‹åŒ–è¿‡äº†ï¼Œæ–¹æ³•ç›´æ¥è¿”å›ï¼Œä¸å†è¿›è¡Œåˆå§‹åŒ–ã€‚\tif (this.advisorChainInitialized) &#123; return;\t&#125;\t// æ£€æŸ¥Interceptoråç§°åˆ—è¡¨æ˜¯å¦ä¸ºç©ºã€‚å¦‚æœinterceptorNamesä¸ºç©ºï¼Œåˆ™è·³è¿‡åˆå§‹åŒ–ã€‚\tif (!ObjectUtils.isEmpty(this.interceptorNames)) &#123; if (this.beanFactory == null) &#123; throw new IllegalStateException(&quot;No BeanFactory available anymore (probably due to serialization) &quot; + &quot;- cannot resolve interceptor names &quot; + Arrays.asList(this.interceptorNames)); &#125; // Globals can&#x27;t be last unless we specified a targetSource using the property... // æ£€æŸ¥interceptorNamesæ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ æ˜¯å¦ä»¥GLOBAL_SUFFIXç»“å°¾ã€‚ // å¦‚æœæ˜¯Globalç±»å‹ï¼Œå¹¶ä¸”targetNameä¸ºnullä¸”targetSourceä¸ºEMPTY_TARGET_SOURCEï¼Œ // åˆ™æŠ›å‡ºAopConfigExceptionå¼‚å¸¸ï¼Œè¡¨ç¤ºåœ¨Global Interceptorä¹‹åéœ€è¦ä¸€ä¸ªç›®æ ‡ã€‚ if (this.interceptorNames[this.interceptorNames.length - 1].endsWith(GLOBAL_SUFFIX) &amp;&amp; this.targetName == null &amp;&amp; this.targetSource == EMPTY_TARGET_SOURCE) &#123; throw new AopConfigException(&quot;Target required after globals&quot;); &#125; // Materialize interceptor chain from bean names. for (String name : this.interceptorNames) &#123; // å¦‚æœåç§°ä»¥GLOBAL_SUFFIXç»“å°¾ï¼š if (name.endsWith(GLOBAL_SUFFIX)) &#123; // æ£€æŸ¥beanFactoryæ˜¯å¦ä¸ºListableBeanFactoryç±»å‹ã€‚å¦‚æœä¸æ˜¯ï¼ŒæŠ›å‡ºAopConfigExceptionå¼‚å¸¸ã€‚ if (!(this.beanFactory instanceof ListableBeanFactory)) &#123; throw new AopConfigException( &quot;Can only use global advisors or interceptors with a ListableBeanFactory&quot;); &#125; // å¦‚æœæ˜¯ListableBeanFactoryç±»å‹ï¼Œ åˆ™å°†å…¨å±€Advisoræ·»åŠ åˆ°Advisor Chainä¸­ã€‚ addGlobalAdvisors((ListableBeanFactory) this.beanFactory, name.substring(0, name.length() - GLOBAL_SUFFIX.length())); &#125; else &#123; // å¦‚æœåç§°ä¸æ˜¯ä»¥GLOBAL_SUFFIXç»“å°¾ Object advice; // æ ¹æ®åç§°æ£€æŸ¥Beanæ˜¯å•ä¾‹ï¼ˆsingletonï¼‰è¿˜æ˜¯åŸå‹ï¼ˆprototypeï¼‰ã€‚ if (this.singleton || this.beanFactory.isSingleton(name)) &#123; // å¦‚æœæ˜¯å•ä¾‹æˆ–this.singletonä¸ºtrueï¼Œåˆ™ä»beanFactoryä¸­è·å–å®é™…çš„adviceå®ä¾‹ // æ³¨æ„ï¼Œæ­¤æ—¶IOC å®¹å™¨å·²ç»å¯åŠ¨å®Œæˆï¼Œ getBeanä¼šä»ä¸‰å±‚ç¼“å­˜ä¸­è·å–å®ä¾‹è¿”å› advice = this.beanFactory.getBean(name); &#125; else &#123; // å¦‚æœæ˜¯åŸå‹ï¼ˆprototypeï¼‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªå¯¹è±¡ advice = new PrototypePlaceholderAdvisor(name); &#125; // å°†adviceæ·»åŠ åˆ°Advisor Chainä¸­ã€‚ addAdvisorOnChainCreation(advice); &#125; &#125;\t&#125;\tthis.advisorChainInitialized = true;&#125; 2.4 getSingletonInstance1234567891011121314public class ProxyFactoryBean extends ProxyCreatorSupport implements FactoryBean&lt;Object&gt;, BeanClassLoaderAware, BeanFactoryAware &#123; private synchronized Object getSingletonInstance() &#123; this.singletonInstance = getProxy(createAopProxy()); return this.singletonInstance;\t&#125;\t// æ ¹æ®ç¡®å®šçš„åŠ¨æ€ä»£ç†ï¼Œåˆ›å»ºtarget çš„ä»£ç†å¯¹è±¡\tprotected Object getProxy(AopProxy aopProxy) &#123; return aopProxy.getProxy(this.proxyClassLoader); &#125;&#125; é‡è¦çš„é€»è¾‘åªæœ‰2ç‚¹ createAopProxyï¼š ç¡®å®šåŠ¨æ€ä»£ç†çš„ç±»å‹ï¼Œ JDK åŠ¨æ€ä»£ç† or CGlib, åˆ¤æ–­çš„é€»è¾‘ä¹Ÿéå¸¸ç®€å•ï¼Œå¯ä»¥ç®€å•è®¤ä¸ºå°±æ˜¯æœ‰æ²¡æœ‰å®ç°æ¥å£ å®ç°äº†æ¥å£ï¼Œç”¨JDK åŠ¨æ€ä»£ç† æ²¡æœ‰å®ç°æ¥å£ï¼Œç”¨CGlib åŠ¨æ€ä»£ç† getProxyï¼šæ ¹æ®ç¡®å®šçš„åŠ¨æ€ä»£ç†ï¼Œåˆ›å»ºtarget çš„ä»£ç†å¯¹è±¡ 2.4.1 createAopProxyç¡®å®šåŠ¨æ€ä»£ç†çš„ç±»å‹ï¼Œ JDK åŠ¨æ€ä»£ç† or CGlib åŠ¨æ€ä»£ç† å…³äºåŠ¨æ€ä»£ç†ï¼Œå¯ä»¥ç‚¹å‡»é˜…è¯»Java åŠ¨æ€ä»£ç†1234567891011121314151617181920212223242526272829303132333435public class ProxyCreatorSupport extends AdvisedSupport &#123; protected final synchronized AopProxy createAopProxy() &#123; if (!this.active) &#123; activate(); &#125; return getAopProxyFactory().createAopProxy(this);\t&#125;&#125;// ç¡®å®šåŠ¨æ€ä»£ç†çš„ç±»å‹public class DefaultAopProxyFactory implements AopProxyFactory, Serializable &#123;\t@Override\tpublic AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException &#123; if (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123; Class&lt;?&gt; targetClass = config.getTargetClass(); if (targetClass == null) &#123; throw new AopConfigException(&quot;TargetSource cannot determine target class: &quot; + &quot;Either an interface or a target is required for proxy creation.&quot;); &#125; // åˆ¤æ–­ç›®æ ‡ç±»æ˜¯å¦æ˜¯æ¥å£ã€‚å¦‚æœæ˜¯æ¥å£ï¼Œä½¿ç”¨JDKåŠ¨æ€ä»£ç†ã€‚ // å¦‚æœæ˜¯ä»£ç†ç±»ï¼Œä¹Ÿä½¿ç”¨JDKåŠ¨æ€ä»£ç†ã€‚ if (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) &#123; return new JdkDynamicAopProxy(config); &#125; // å¦‚æœç›®æ ‡ç±»æ—¢ä¸æ˜¯æ¥å£ï¼Œä¹Ÿä¸æ˜¯ä»£ç†ç±»ï¼Œåˆ™ä½¿ç”¨CGLIBä»£ç†ã€‚ return new ObjenesisCglibAopProxy(config); &#125; else &#123; return new JdkDynamicAopProxy(config); &#125; &#125;&#125; ä¼ è¿›æ¥çš„config å°±æ˜¯å°±æ˜¯userServiceProxy è¿™ä¸ªProxyFactoryBean, é‡Œé¢æœ‰å„ç§ä¿¡æ¯,å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯å¸®åŠ©åˆ¤æ–­åŠ¨æ€ä»£ç†çš„ç±»å‹ã€‚ 2.4.2 getProxyadvised æŒ‡çš„å°±æ˜¯å‰é¢ç¤ºä¾‹ä»£ç ä¸­é…ç½®çš„ProxyFactoryBean , å®ƒçš„targetSource æ˜¯ è¦è¢«ä»£ç†çš„userService 3. CglibAopProxy123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123class CglibAopProxy implements AopProxy, Serializable &#123; @Override\tpublic Object getProxy(@Nullable ClassLoader classLoader) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Creating CGLIB proxy: &quot; + this.advised.getTargetSource()); &#125; try &#123; // è·å–ç›®æ ‡ç±»çš„ Class å¯¹è±¡ï¼Œ å¹¶å°†å…¶è®¾ç½®ä¸ºä»£ç†ç±»çš„çˆ¶ç±»ï¼Œå› ä¸ºcglibä»£ç†æ˜¯é€šè¿‡ç”Ÿæˆå­ç±»çš„æ–¹å¼å®ç°çš„ Class&lt;?&gt; rootClass = this.advised.getTargetClass(); Assert.state(rootClass != null, &quot;Target class must be available for creating a CGLIB proxy&quot;); Class&lt;?&gt; proxySuperClass = rootClass; // æ£€æŸ¥rootClassçš„åç§°æ˜¯å¦åŒ…å«CGLIBçš„ç±»åˆ†éš”ç¬¦ &quot;$$&quot;ï¼Œ$$é€šå¸¸ç”¨æ¥åˆ†éš”åŸå§‹ç±»åå’Œé™„åŠ çš„ä»£ç†ç±»ä¿¡æ¯ // å¦‚æœåŒ…å«ï¼Œè¯´æ˜ rootClass è¿˜æœ‰å®ƒçš„çˆ¶ç±»ï¼Œè¦æŠŠproxySuperClass è®¾ç½®ä¸ºè¿™ä¸ªçˆ¶ç±» if (rootClass.getName().contains(ClassUtils.CGLIB_CLASS_SEPARATOR)) &#123; proxySuperClass = rootClass.getSuperclass(); Class&lt;?&gt;[] additionalInterfaces = rootClass.getInterfaces(); for (Class&lt;?&gt; additionalInterface : additionalInterfaces) &#123; // è·å–ç›®æ ‡ç±»å®ç°çš„æ‰€æœ‰æ¥å£ï¼Œå¹¶å°†è¿™äº›æ¥å£æ·»åŠ åˆ°advisedå¯¹è±¡ä¸­ã€‚ this.advised.addInterface(additionalInterface); &#125; &#125; // Validate the class, writing log messages as necessary. // éªŒè¯ä»£ç†è¶…ç±»æ˜¯å¦åˆæ³• validateClassIfNecessary(proxySuperClass, classLoader); // Configure CGLIB Enhancer... // åˆ›å»ºEnhancerå®ä¾‹ï¼Œç”¨äºç”Ÿæˆä»£ç†ç±»ã€‚ Enhancer enhancer = createEnhancer(); // å¦‚æœä¼ å…¥äº†classLoaderï¼Œåˆ™å°†å…¶è®¾ç½®ä¸ºEnhancerçš„ç±»åŠ è½½å™¨ã€‚ if (classLoader != null) &#123; enhancer.setClassLoader(classLoader); // å¦‚æœç±»åŠ è½½å™¨æ˜¯SmartClassLoaderçš„å®ä¾‹ï¼Œå¹¶ä¸”ä»£ç†ç±»çš„è¶…ç±»æ˜¯å¯é‡è½½çš„ï¼Œåˆ™ç¦ç”¨ç¼“å­˜ if (classLoader instanceof SmartClassLoader &amp;&amp; ((SmartClassLoader) classLoader).isClassReloadable(proxySuperClass)) &#123; enhancer.setUseCache(false); &#125; &#125; // è®¾ç½®ä»£ç†ç±»çš„çˆ¶ç±» enhancer.setSuperclass(proxySuperClass); // è®¾ç½®ä»£ç†ç±»å®ç°çš„æ¥å£ enhancer.setInterfaces(AopProxyUtils.completeProxiedInterfaces(this.advised)); // è®¾ç½®å‘½åç­–ç•¥ï¼Œç¡®ä¿ç”Ÿæˆçš„ä»£ç†ç±»æœ‰åˆé€‚çš„åç§° enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE); // è®¾ç½®ç”Ÿæˆç­–ç•¥ï¼Œä½¿ç”¨ClassLoaderAwareGeneratorStrategyæ¥å¤„ç†ç±»åŠ è½½å™¨ã€‚ enhancer.setStrategy(new ClassLoaderAwareGeneratorStrategy(classLoader)); // è·å–ç”¨äºä»£ç†çš„æ–¹æ³•å›è°ƒï¼Œ å›è°ƒå¿…é¡»å®ç°MethodInterceptoræ¥å£ Callback[] callbacks = getCallbacks(rootClass); // åˆ›å»ºä¸€ä¸ªä¸å›è°ƒæ•°ç»„é•¿åº¦ç›¸åŒçš„ç±»å‹æ•°ç»„ã€‚å°†æ¯ä¸ªå›è°ƒçš„ç±»å‹æ·»åŠ åˆ°ç±»å‹æ•°ç»„ä¸­ã€‚ Class&lt;?&gt;[] types = new Class&lt;?&gt;[callbacks.length]; for (int x = 0; x &lt; types.length; x++) &#123; types[x] = callbacks[x].getClass(); &#125; // fixedInterceptorMap only populated at this point, after getCallbacks call above // è®¾ç½®å›è°ƒè¿‡æ»¤å™¨ï¼ŒæŒ‡å®šå“ªä¸ªå›è°ƒåº”è¯¥ç”¨äºå“ªä¸ªæ–¹æ³•ã€‚ enhancer.setCallbackFilter(new ProxyCallbackFilter( this.advised.getConfigurationOnlyCopy(), this.fixedInterceptorMap, this.fixedInterceptorOffset)); enhancer.setCallbackTypes(types); // Generate the proxy class and create a proxy instance. return createProxyClassAndInstance(enhancer, callbacks); &#125; catch (CodeGenerationException | IllegalArgumentException ex) &#123; throw new AopConfigException(&quot;Could not generate CGLIB subclass of &quot; + this.advised.getTargetClass() + &quot;: Common causes of this problem include using a final class or a non-visible class&quot;, ex); &#125; catch (Throwable ex) &#123; // TargetSource.getTarget() failed throw new AopConfigException(&quot;Unexpected AOP exception&quot;, ex); &#125;\t&#125;&#125;class ObjenesisCglibAopProxy extends CglibAopProxy &#123; @Override\tprotected Object createProxyClassAndInstance(Enhancer enhancer, Callback[] callbacks) &#123; // è·å–ä»£ç†ç±»çš„Class å¯¹è±¡ Class&lt;?&gt; proxyClass = enhancer.createClass(); Object proxyInstance = null; // æ£€æŸ¥æ˜¯å¦å€¼å¾—å°è¯•ä½¿ç”¨Objenesisã€‚ if (objenesis.isWorthTrying()) &#123; try &#123; // å¦‚æœå€¼å¾—å°è¯•ï¼Œåˆ™å°è¯•ä½¿ç”¨Objenesiså®ä¾‹åŒ–ä»£ç†å¯¹è±¡ proxyInstance = objenesis.newInstance(proxyClass, enhancer.getUseCache()); &#125; catch (Throwable ex) &#123; logger.debug(&quot;Unable to instantiate proxy using Objenesis, &quot; + &quot;falling back to regular proxy construction&quot;, ex); &#125; &#125; // å¦‚æœproxyInstanceä»ç„¶æ˜¯nullï¼Œåˆ™ä½¿ç”¨å¸¸è§„æ–¹å¼é€šè¿‡é»˜è®¤æ„é€ å‡½æ•°å®ä¾‹åŒ–ä»£ç†å¯¹è±¡ if (proxyInstance == null) &#123; // Regular instantiation via default constructor... try &#123; // è·å–ä»£ç†ç±»çš„æ„é€ å‡½æ•°ï¼Œæ ¹æ®æ˜¯å¦æœ‰æ„é€ å‚æ•°å†³å®šä½¿ç”¨å“ªä¸ªæ„é€ å‡½æ•° Constructor&lt;?&gt; ctor = (this.constructorArgs != null ? proxyClass.getDeclaredConstructor(this.constructorArgTypes) : proxyClass.getDeclaredConstructor()); // è®¾ç½®æ„é€ å‡½æ•°å¯è®¿é—®ï¼Œ private æ„é€ å‡½æ•°æ˜¯ä¸å¯è®¿é—®çš„ ReflectionUtils.makeAccessible(ctor); // ä½¿ç”¨æ„é€ å‡½æ•°å®ä¾‹åŒ–ä»£ç†å¯¹è±¡ proxyInstance = (this.constructorArgs != null ? ctor.newInstance(this.constructorArgs) : ctor.newInstance()); &#125; catch (Throwable ex) &#123; throw new AopConfigException(&quot;Unable to instantiate proxy using Objenesis, &quot; + &quot;and regular proxy instantiation via default constructor fails as well&quot;, ex); &#125; &#125; // è®¾ç½®å›è°ƒç”¨ ((Factory) proxyInstance).setCallbacks(callbacks); return proxyInstance;\t&#125; &#125; 3.1 getProxy-enhancerEnhancer` ç±»ç”¨äºç”Ÿæˆä¸€ä¸ªç›®æ ‡ç±»çš„å­ç±»ï¼ˆå³ä»£ç†ç±»ï¼‰ï¼Œå¹¶é€šè¿‡åœ¨ä»£ç†ç±»ä¸­æ‹¦æˆªæ–¹æ³•è°ƒç”¨æ¥å®ç°åŠ¨æ€ä»£ç†ã€‚è¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬æŒ‡å®šè¦ä»£ç†çš„ç›®æ ‡ç±»ã€è®¾ç½®å›è°ƒã€ç”Ÿæˆä»£ç†ç±»ç­‰æ­¥éª¤ã€‚ 3.1 ObjenesisCglibAopProxyä»ä»£ç createAOPProxy ä»£ç ä¸­å¯ä»¥çœ‹å‡ºä¸­å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæ˜¯cglib åŠ¨æ€ï¼Œæœ€ç»ˆè¿”å›çš„æ˜¯ObjenesisCglibAopProxyï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›çš„CglibAopProxy åœ¨Spring AOPæ¡†æ¶ä¸­ï¼ŒCglibAopProxyå’ŒObjenesisCglibAopProxyéƒ½ç”¨äºåˆ›å»ºCGLIBä»£ç† å®ä¾‹åŒ–æ–¹å¼ CglibAopProxy: ç›´æ¥ä½¿ç”¨CGLIBåº“çš„Enhancerç±»æ¥åˆ›å»ºä»£ç†ç±»ï¼Œé€šå¸¸ä¼šè°ƒç”¨ç›®æ ‡ç±»çš„æ„é€ å‡½æ•°ã€‚ ObjenesisCglibAopProxy: åˆ©ç”¨Objenesisåº“æ¥å®ä¾‹åŒ–ä»£ç†å¯¹è±¡ï¼Œé¿å…äº†ç›´æ¥è°ƒç”¨ç›®æ ‡ç±»çš„æ„é€ å‡½æ•°ï¼Œæä¾›äº†ä¸€ç§æ›´çµæ´»çš„å®ä¾‹åŒ–æ–¹å¼ã€‚ åº”ç”¨åœºæ™¯ CglibAopProxy: é€‚ç”¨äºä¸€èˆ¬çš„CGLIBä»£ç†åœºæ™¯ï¼Œå½“ç›®æ ‡ç±»çš„æ„é€ å‡½æ•°æ²¡æœ‰ç‰¹æ®Šè¦æ±‚æ—¶ï¼Œæ˜¯Spring AOPçš„é»˜è®¤é€‰æ‹©ã€‚ ObjenesisCglibAopProxy: é€‚ç”¨äºéœ€è¦åœ¨ä¸è°ƒç”¨æ„é€ å‡½æ•°çš„æƒ…å†µä¸‹åˆ›å»ºä»£ç†çš„åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯å½“ç›®æ ‡ç±»çš„æ„é€ å‡½æ•°è¾ƒä¸ºå¤æ‚æˆ–æœ‰ç‰¹æ®Šé™åˆ¶æ—¶ï¼Œæä¾›äº†ä¸€ç§æ›´çµæ´»çš„è§£å†³æ–¹æ¡ˆã€‚ 3.2 getCallbacks-è‡ªåŠ¨å®ç° MethodInterceptoråœ¨Java åŠ¨æ€ä»£ç†, CGLIB åŠ¨æ€ä»£ç†éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ‰‹åŠ¨å®ç°äº†ä¸€ä¸ªMethodInterceptor, å¹¶è®¾ç½®ä¸ºäº†enhancer çš„callback1234567891011121314151617181920212223public class HelloWorldInterceptor implements MethodInterceptor &#123; @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable &#123; System.out.println(&quot;Before method: &quot; + method.getName()); Object result = proxy.invokeSuper(obj, args); System.out.println(&quot;After method: &quot; + method.getName()); return result; &#125; &#125;public class CglibDynamicProxyDemo &#123; public static void main(String[] args) &#123; Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(HelloWorldImpl.class); enhancer.setCallback(new HelloWorldInterceptor()); HelloWorld proxy = (HelloWorld) enhancer.create(); proxy.sayHello(); proxy.sayBye(); &#125; &#125; ä½†æ˜¯åœ¨æ­¤æ¬¡XML é…ç½®å½¢å¼çš„AOP ä¸­ï¼Œ æˆ‘ä»¬å¹¶æ²¡æœ‰æ‰‹åŠ¨å®ç°MethodInceptor çš„é€»è¾‘ã€‚ MethodInceptor çš„ å®ç° ç”±CglibAopProxy èƒŒåå¸®æˆ‘ä»¬å·å·åšäº†ï¼Œ å®ç°çš„é€»è¾‘è¿™è¡Œä»£ç ä¸­ï¼Œ è¿›å»çœ‹ä¸‹1Callback[] callbacks = getCallbacks(rootClass); 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849private Callback[] getCallbacks(Class&lt;?&gt; rootClass) throws Exception &#123; // Parameters used for optimization choices... // æ˜¯å¦éœ€è¦å…¬å¼€ä»£ç†å¯¹è±¡ã€‚ boolean exposeProxy = this.advised.isExposeProxy(); // ä»£ç†é…ç½®æ˜¯å¦è¢«å†»ç»“ã€‚ boolean isFrozen = this.advised.isFrozen(); // ç›®æ ‡æºæ˜¯å¦æ˜¯é™æ€çš„ï¼ˆå³ç›®æ ‡å¯¹è±¡åœ¨åˆ›å»ºæ—¶å·²ç»ç¡®å®šï¼Œä¸ä¼šå˜åŒ–ï¼‰ã€‚ boolean isStatic = this.advised.getTargetSource().isStatic(); // Choose an &quot;aop&quot; interceptor (used for AOP calls). // åˆ›å»ºä¸€ä¸ªDynamicAdvisedInterceptorå®ä¾‹ï¼Œç”¨äºå¤„ç†AOPè°ƒç”¨ã€‚è¿™æ˜¯ä¸»è¦çš„AOPæ‹¦æˆªå™¨ã€‚ Callback aopInterceptor = new DynamicAdvisedInterceptor(this.advised); // Choose a &quot;straight to target&quot; interceptor. (used for calls that are // unadvised but can return this). May be required to expose the proxy. Callback targetInterceptor; if (exposeProxy) &#123; targetInterceptor = (isStatic ? new StaticUnadvisedExposedInterceptor(this.advised.getTargetSource().getTarget()) : new DynamicUnadvisedExposedInterceptor(this.advised.getTargetSource())); &#125; else &#123; targetInterceptor = (isStatic ? new StaticUnadvisedInterceptor(this.advised.getTargetSource().getTarget()) : new DynamicUnadvisedInterceptor(this.advised.getTargetSource())); Callback targetDispatcher = (isStatic ? new StaticDispatcher(this.advised.getTargetSource().getTarget()) : new SerializableNoOp()); Callback[] mainCallbacks = new Callback[] &#123; aopInterceptor, // for normal advice å¤„ç†å¸¸è§„çš„AOPå¢å¼ºã€‚ // ä¼˜åŒ–æƒ…å†µä¸‹ç›´æ¥è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ã€‚ targetInterceptor, // invoke target without considering advice, if optimized // å¯¹äºæ²¡æœ‰å¢å¼ºçš„æ–¹æ³•ï¼Œä»€ä¹ˆä¹Ÿä¸åšã€‚ new SerializableNoOp(), // no override for methods mapped to this // ç›´æ¥è°ƒç”¨é™æ€ç›®æ ‡çš„æ–¹æ³•ã€‚ targetDispatcher, // ä»£ç†é…ç½®çš„è°ƒåº¦å™¨ã€‚ this.advisedDispatcher, // å¤„ç†equalsæ–¹æ³•çš„æ‹¦æˆªå™¨ã€‚ new EqualsInterceptor(this.advised), // å¤„ç†equalsæ–¹æ³•çš„æ‹¦æˆªå™¨ã€‚ new HashCodeInterceptor(this.advised) &#125;; Callback[] callbacks; return callbacks;\t&#125; çœç•¥äº†éƒ¨åˆ†ä»£ç åªçœ‹é‡ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆè¿”å›çš„callback æ•°ç»„ä¸­åŒ…å«6ä¸ªæ•°æ®ï¼Œæå‰çœ‹ä¸‹åˆ›å»ºå®Œæˆçš„userService å®ä¾‹debug ä¿¡æ¯ï¼Œ callback ä¿¡æ¯å’Œä»£ç ä¸­çš„æ•°æ®æ˜¯å¯ä»¥ä¸€ä¸€å¯¹åº”ä¸Šçš„ userServiceä»£ç†ç±»çš„åç§°æ˜¯UserService$$EnhancerBySpringCGLIB$$7a3b35bbï¼Œå…¶ä¸­ï¼š UserServiceæ˜¯åŸå§‹ç›®æ ‡ç±»ã€‚ $$$EnhancerBySpringCGLIB$$$è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªç”±Spring CGLIBç”Ÿæˆçš„å¢å¼ºç±»ã€‚ 7a3b35bbæ˜¯ä¸€ä¸ªå“ˆå¸Œå€¼æˆ–æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„ä»£ç†å®ä¾‹ã€‚ CGLIB$BOUND = trueè¿™æ˜¯CGLIBç”Ÿæˆçš„ä»£ç†ç±»çš„ä¸€ä¸ªå†…éƒ¨å­—æ®µï¼Œé€šå¸¸ç”¨äºæŒ‡ç¤ºä»£ç†æ˜¯å¦å·²ç»ç»‘å®šåˆ°å…¶ç›®æ ‡ç±»ã€‚ CGLIB$CALLBACK_0 1CGLIB$CALLBACK_0 = &#123;CglibAopProxy$DynamicAdvisedInterceptor@3005&#125; CGLIB$CALLBACK_0æ˜¯ä»£ç†ç±»çš„å›è°ƒæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå›è°ƒã€‚å®ƒæ˜¯ä¸€ä¸ªCglibAopProxy$DynamicAdvisedInterceptorå¯¹è±¡ã€‚åœ¨CGLIBä»£ç†ä¸­ï¼Œå›è°ƒï¼ˆCallbackï¼‰ç”¨äºæ‹¦æˆªæ–¹æ³•è°ƒç”¨å¹¶åº”ç”¨å¢å¼ºé€»è¾‘ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹callback æ•°ç»„ä¸­çš„å„ä¸ªæ•°æ® 3.3 MethodInceptor åœ¨CglibAopProxyçš„å®ç° 123public interface MethodInterceptor extends Callback &#123; Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable;&#125; åœ¨intercept æ–¹æ³•ä¸­ å¯ä»¥å®ç°æ‹¦æˆªé€»è¾‘ æˆªå›¾ä¸­å‡ºç°çš„Interceptor å‡æ˜¯MethodInterceptor åœ¨CglibAopProxy ä¸­çš„å®ç°ï¼Œå‡å·²ç§æœ‰ç±»çš„å½¢å¼å­˜åœ¨ï¼Œä¸‹é¢é‡ç‚¹åˆ†æä¸€ä¸‹DynamicAdvisedInterceptorï¼Œå¸¸è§„çš„AOP å¢å¼ºé€»è¾‘çš„ç»‡å…¥å‡æ˜¯ç”±å®ƒå®ç°ã€‚ 3. 4 æ–¹æ³•æ‰§è¡Œ-interceptç»è¿‡getProxyè·å–Cglib åŠ¨æ€ä»£ç†å¯¹è±¡åï¼Œ å°†é€šè¿‡ä»£ç†å¯¹è±¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘12userService.createUser(&quot;john&quot;); userService.deleteUser(&quot;john&quot;); ä¸‹é¢å°†è·Ÿéšdebug ä¿¡æ¯æ¥åˆ†æ ä»£ç†å¯¹è±¡æ–¹æ³•çš„æ‰§è¡Œ æ‰§è¡ŒuserService.createUser(&quot;john&quot;); ä»£ç ä¼šæ¥åˆ°CglibAopProxyä¸­DynamicAdvisedInterceptor çš„intercept æ–¹æ³•ï¼Œ ï¼ˆtodoå›å»çœ‹ä¸‹è¿™ä¸ªintercept æ˜¯ä»€ä¹ˆæ—¶å€™ç”Ÿæˆçš„ï¼‰ 3.4.1 DynamicAdvisedInterceptorè¿›å…¥createUser æ–¹æ³•åï¼Œæ¥åˆ°DynamicAdvisedInterceptor.intercept() æ–¹æ³• DynamicAdvisedInterceptorä¸­çš„interceptæ–¹æ³•æ˜¯Spring AOPæ¡†æ¶ä¸­ç”¨äºå¤„ç†ä»£ç†å¯¹è±¡æ–¹æ³•è°ƒç”¨çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚å®ƒä¸»è¦è´Ÿè´£æ‹¦æˆªä»£ç†å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ï¼Œåº”ç”¨ç›¸åº”çš„å¢å¼ºé€»è¾‘ï¼Œå¹¶æœ€ç»ˆè°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566private static class DynamicAdvisedInterceptor implements MethodInterceptor, Serializable &#123; private final AdvisedSupport advised; public DynamicAdvisedInterceptor(AdvisedSupport advised) &#123; this.advised = advised; &#125; @Override @Nullable public Object intercept(Object proxy, Method method, Object[] args, MethodProxy methodProxy) throws Throwable &#123; Object oldProxy = null; boolean setProxyContext = false; Object target = null; TargetSource targetSource = this.advised.getTargetSource(); try &#123; if (this.advised.exposeProxy) &#123; // Make invocation available if necessary. oldProxy = AopContext.setCurrentProxy(proxy); setProxyContext = true; &#125; // Get as late as possible to minimize the time we &quot;own&quot; the target, in case it comes from a pool... target = targetSource.getTarget(); Class&lt;?&gt; targetClass = (target != null ? target.getClass() : null); // è·å–é€‚ç”¨äºå½“å‰ç±»å½“å‰æ–¹æ³•çš„å¢å¼ºï¼Œè¿˜è®°å¾—â€œç­›é€‰æ¡ä»¶â€å— List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass); Object retVal; // å¦‚æœæ‹¦æˆªå™¨é“¾ä¸ºç©ºå¹¶ä¸”æ–¹æ³•æ˜¯publicçš„,ç›´æ¥é€šè¿‡methodProxyè°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ã€‚ if (chain.isEmpty() &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123; Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args); retVal = methodProxy.invoke(target, argsToUse); &#125; else &#123; // We need to create a method invocation... // åˆ›å»ºä¸€ä¸ªCglibMethodInvocationå¯¹è±¡å¹¶è°ƒç”¨å…¶proceedæ–¹æ³•ï¼Œæ‰§è¡Œæ‹¦æˆªå™¨é“¾ä¸­çš„æ‰€æœ‰æ‹¦æˆªå™¨é€»è¾‘ã€‚ retVal = new CglibMethodInvocation(proxy, target, method, args, targetClass, chain, methodProxy).proceed(); &#125; retVal = processReturnType(proxy, target, method, retVal); return retVal; &#125; finally &#123; if (target != null &amp;&amp; !targetSource.isStatic()) &#123; targetSource.releaseTarget(target); &#125; if (setProxyContext) &#123; // Restore old proxy. AopContext.setCurrentProxy(oldProxy); &#125; &#125; &#125; @Override public boolean equals(@Nullable Object other) &#123; return (this == other || (other instanceof DynamicAdvisedInterceptor &amp;&amp; this.advised.equals(((DynamicAdvisedInterceptor) other).advised))); &#125; /** * CGLIB uses this to drive proxy creation. */ @Override public int hashCode() &#123; return this.advised.hashCode(); &#125;\t&#125; DynamicAdvisedInterceptor.interceptæ–¹æ³•ä¸­ï¼Œæœ€ç»ˆé€šè¿‡proceed æ–¹æ³•å®ç°å¢å¼ºç»‡å…¥å’Œçˆ¶ç±»æ–¹æ³•çš„è°ƒç”¨ 3.4.2 getInterceptorsAndDynamicInterceptionAdviceæ—¢ç„¶è¦æ‰§è¡Œæ–¹æ³•ï¼Œé‚£è‚¯å®šè¦ç­›é€‰å‡ºå¯ä»¥åº”ç”¨åœ¨è¯¥ç±»è¯¥æ–¹æ³•ä¸Šçš„å¢å¼ºï¼Œ åœ¨åˆé€‚çš„ä½ç½®ä¸Šç»‡å…¥å¢å¼ºå¹¶æ‰§è¡Œå®é™…çš„ä¸šåŠ¡é€»è¾‘ã€‚é‚£ä¹ˆå¦‚ä½•ç­›é€‰å‡ºå¯ç”¨åœ¨å½“å‰ç±»å½“å‰æ–¹æ³•ä¸Šçš„Adviceï¼Œ è¿›å…¥ä»£ç çœ‹ä¸€ä¸‹ createUser çœ‹å›¾ä¸­é«˜äº®çš„66è¡Œä»£ç ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨è‡ªå®šä¹‰çš„ LoggingAdvisorã€LoggingPointcuté‡å†™çš„æ–¹æ³•12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public class LoggingAdvisor implements PointcutAdvisor &#123; @Override public Pointcut getPointcut() &#123; return new LoggingPointcut(); &#125; @Override public Advice getAdvice() &#123; return new LoggingMethodInterceptor(); &#125; @Override public boolean isPerInstance() &#123; return true; &#125; &#125;public class LoggingPointcut implements Pointcut &#123; @Override public ClassFilter getClassFilter() &#123; return clazz -&gt; clazz == UserService.class; &#125; @Override public MethodMatcher getMethodMatcher() &#123; return new MethodMatcher() &#123; @Override public boolean matches(Method method, Class&lt;?&gt; targetClass) &#123; if (method.getName().equals(&quot;createUser&quot;)) &#123; return true; &#125; return false; &#125; @Override public boolean isRuntime() &#123; return true; &#125; @Override public boolean matches(Method method, Class&lt;?&gt; targetClass, Object... args) &#123; if (method.getName().equals(&quot;createUser&quot;)) &#123; return true; &#125; return false; &#125; &#125;; &#125;&#125; æœ€ç»ˆå¯ä»¥ç”¨åœ¨UserService.createUser ä¸Šçš„advice æœ‰3ä¸ª ä¸€ä¸ªè‡ªå®šä¹‰çš„LoggingAdvisor 2ä¸ªç›´æ¥å®šä¹‰çš„Advice, LoggingBeforeAdviceã€LoggingAfterAdviceï¼Œ å®ƒä»¬ä¼šè¢«å¤„ç†æˆDefaulrPointcutAdvisor, é»˜è®¤å¯¹æ‰€æœ‰ç±»çš„æ‰€æœ‰æ–¹æ³•å‡æœ‰æ•ˆ deleteUserå½“æ‰§è¡Œdeleteæ–¹æ³•æ˜¯ï¼Œç¬¦åˆæ¡ä»¶çš„interceptor åªæœ‰2ä¸ª ç¼“å­˜çš„åº”ç”¨é’ˆå¯¹æ¯ä¸ªæ–¹æ³•å¯ç”¨çš„advice åˆ—è¡¨ï¼Œ è¿™é‡Œä½¿ç”¨äº†ç¼“å­˜æ¥æå‡æ€§èƒ½12345678910public List&lt;Object&gt; getInterceptorsAndDynamicInterceptionAdvice(Method method, @Nullable Class&lt;?&gt; targetClass) &#123; MethodCacheKey cacheKey = new MethodCacheKey(method); List&lt;Object&gt; cached = this.methodCache.get(cacheKey); if (cached == null) &#123; cached = this.advisorChainFactory.getInterceptorsAndDynamicInterceptionAdvice( this, method, targetClass); this.methodCache.put(cacheKey, cached); &#125; return cached; &#125; 3.4.3 ReflectiveMethodInvocation.proceedçŸ¥é“äº†è¦æ‰§è¡Œçš„æ–¹æ³•ï¼Œä¹ŸçŸ¥é“äº†éœ€è¦åº”ç”¨åœ¨è¯¥æ–¹æ³•ä¸Šçš„å¢å¼ºï¼Œä¸‹é¢å°±å¯ä»¥çœŸæ­£å°†å¢å¼ºåº”ç”¨åœ¨æ–¹æ³•åˆé€‚çš„ä½ç½®å¹¶æ‰§è¡Œæ–¹æ³•äº† 123456789101112131415161718192021222324252627public class ReflectiveMethodInvocation implements ProxyMethodInvocation, Cloneable &#123;\tpublic Object proceed() throws Throwable &#123; // We start with an index of -1 and increment early. // æ£€æŸ¥å½“å‰æ‹¦æˆªå™¨ç´¢å¼•æ˜¯å¦å·²ç»åˆ°è¾¾æ‹¦æˆªå™¨é“¾çš„æœ«å°¾ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨invokeJoinpointæ–¹æ³•ï¼Œç›´æ¥æ‰§è¡Œç›®æ ‡æ–¹æ³•ã€‚ if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1) &#123; return invokeJoinpoint(); &#125; // å¢åŠ å½“å‰æ‹¦æˆªå™¨ç´¢å¼•ï¼Œå¹¶è·å–ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨æˆ–å¢å¼ºé€»è¾‘å¯¹è±¡ Object interceptorOrInterceptionAdvice = this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex); if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher) &#123; InterceptorAndDynamicMethodMatcher dm = (InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice; Class&lt;?&gt; targetClass = (this.targetClass != null ? this.targetClass : this.method.getDeclaringClass()); if (dm.methodMatcher.matches(this.method, targetClass, this.arguments)) &#123; return dm.interceptor.invoke(this); &#125; else &#123; return proceed(); &#125; &#125; else &#123; return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this); &#125;\t&#125;&#125; è¿™æ®µä»£ç ä¸­å¹¶æ²¡æœ‰ä½¿ç”¨for å¾ªç¯æ¥æ‰§è¡Œå¤šä¸ªAdvice, è€Œæ˜¯ä½¿ç”¨é€’å½’è°ƒç”¨çš„æ–¹å¼å®Œæˆå¤šä¸ªadvice çš„ç»‡å…¥ é€šè¿‡advice ä¸­çš„proceed æ–¹æ³•çš„é€’å½’è°ƒç”¨ï¼Œå®ç°å¯¹å¤šä¸ªinterceptor çš„å¾ªç¯åº”ç”¨ã€‚ ä¸Šå›¾ä¸­debug ä¿¡æ¯å¯ä»¥çœ‹åˆ°3ä¸ªadviceçš„é€’å½’è°ƒç”¨æ ˆã€‚ å¤šä¸ªadvice çš„æ‰§è¡Œé¡ºåºä»¥XMLæ–‡ä»¶ä¸­çš„é…ç½®é¡ºåºä¸ºå‡† å…ˆæ‰§è¡ŒLoggingAdvior ä¸­å®šä¹‰çš„LoggingMethodInterceptor è¿›å…¥invokeæ–¹æ³•åï¼Œ å›è¿›å…¥ç¬¬ä¸€æ¬¡é€’å½’è°ƒç”¨proceed å†æ¬¡è¿›å…¥ReflectiveMethodInvocation.proceed æ–¹æ³•ï¼Œå½“å‰éœ€è¦æ‰§è¡Œçš„advice æ˜¯LoggingBeforeAdvice æ‰§è¡ŒLoggingBeforeAdviceinvoke , æ‰§è¡Œå®šä¹‰å¥½çš„before é€»è¾‘ã€‚å®šä¹‰å¥½çš„before é€»è¾‘æ‰§è¡Œå®Œæˆåï¼Œå†æ¬¡è¿›å…¥ReflectiveMethodInvocation.proceedï¼Œ æ‰§è¡ŒafterAdvice å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ˜¯å…ˆæ‰§è¡Œproceed, æ‰§è¡Œå®Œæˆåå†æ‰§è¡Œåç½®å¢å¼ºçš„é€»è¾‘ï¼Œç¬¦åˆé¢„æœŸå‘€ã€‚ å†æ¬¡è¿›å…¥ReflectiveMethodInvocation.proceedï¼Œå¯ä»¥çœ‹åˆ°advice å·²ç»å…¨éƒ¨æ‰§è¡Œäº†ï¼Œå¯ä»¥å»è°ƒç”¨è¿æ¥ç‚¹ joinpoint ,å³å®é™…çš„ä¸šåŠ¡æ–¹æ³•äº† åé¢ä¸€å±‚å±‚å‡ºæ ˆå°†Advice çš„å…¨éƒ¨æ‰§è¡Œå®Œæˆå³å¯ã€‚ 4. JdkDynamicAopProxyå¦‚æœæƒ³è¦ä½¿ç”¨JDK åŠ¨æ€ä»£ç†æ¥å®ç°ï¼Œéœ€è¦ä¿®æ”¹ä¸‹ä»£ç ï¼Œæ¶‰åŠåˆ°çš„ä»£ç ä¿®æ”¹åå¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839public interface UserI &#123; void createUser(String username); void deleteUser(String username); &#125;public class UserService implements UserI &#123; @Override public void createUser(String username) &#123; // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† System.out.println(&quot;Creating user: &quot; + username); &#125; @Override public void deleteUser(String username) &#123; // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† System.out.println(&quot;Deleting user: &quot; + username); &#125;&#125;public class CodingInActionApplication &#123; public static void main(String[] args) &#123; ApplicationContext context = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); UserI userService = (UserI) context.getBean(&quot;userServiceProxy&quot;); // è°ƒç”¨æ–¹æ³•ï¼Œè§‚å¯Ÿ AOP åˆ‡é¢çš„æ•ˆæœ userService.createUser(&quot;john&quot;); userService.deleteUser(&quot;john&quot;); &#125;&#125; XML æ–‡ä»¶ä¿®æ”¹å¦‚ä¸‹1234567891011121314151617181920212223242526272829303132&lt;bean id=&quot;userService&quot; class=&quot;com.example.codingInAction.service.UserService&quot;/&gt; &lt;!-- å®šä¹‰ å‰ç½®å¢å¼º--&gt; &lt;bean id=&quot;loggingBeforeAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingBeforeAdvice&quot;/&gt; &lt;!-- å®šä¹‰ åç½®å¢å¼º --&gt; &lt;bean id=&quot;loggingAfterAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingAfterAdvice&quot;/&gt; &lt;!-- å®šä¹‰ ç¯ç»•å¢å¼º --&gt; &lt;bean id=&quot;loggingAdvisor&quot; class=&quot;com.example.codingInAction.aop.LoggingAdvisor&quot;/&gt; &lt;bean id=&quot;userServiceProxy&quot; class=&quot;org.springframework.aop.framework.ProxyFactoryBean&quot;&gt; &lt;!-- ç›®æ ‡å¯¹è±¡ --&gt; &lt;property name=&quot;target&quot; ref=&quot;userService&quot;/&gt; &lt;!-- æŒ‡å®šä½¿ç”¨çš„æ¥å£ --&gt; &lt;property name=&quot;proxyInterfaces&quot;&gt; &lt;list&gt; &lt;value&gt;com.example.codingInAction.service.UserI&lt;/value&gt; &lt;/list&gt; &lt;/property&gt; &lt;!-- æ‹¦æˆªå™¨ --&gt; &lt;property name=&quot;interceptorNames&quot;&gt; &lt;list&gt; &lt;value&gt;loggingAdvisor&lt;/value&gt; &lt;value&gt;loggingBeforeAdvice&lt;/value&gt; &lt;value&gt;loggingAfterAdvice&lt;/value&gt; &lt;/list&gt; &lt;/property&gt; &lt;!-- å¼ºåˆ¶ä½¿ç”¨JDKåŠ¨æ€ä»£ç† --&gt; &lt;property name=&quot;proxyTargetClass&quot; value=&quot;false&quot;/&gt; &lt;/bean&gt; 4.1 getProxy-Proxyé€šè¿‡Proxyç±»ï¼Œåˆ©ç”¨åå°„åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œæ•´ä½“æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥å‚è€ƒJava åŠ¨æ€ä»£ç†ä¸­å¯¹Proxy ç±»çš„ä»‹ç»ï¼Œè¿™é‡Œä¸å†èµ˜è¿° 123456789101112final class JdkDynamicAopProxy implements AopProxy, InvocationHandler, Serializable &#123;\t@Override\tpublic Object getProxy(@Nullable ClassLoader classLoader) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Creating JDK dynamic proxy: &quot; + this.advised.getTargetSource()); &#125; Class&lt;?&gt;[] proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(this.advised, true); findDefinedEqualsAndHashCodeMethods(proxiedInterfaces); return Proxy.newProxyInstance(classLoader, proxiedInterfaces, this);\t&#125; &#125; 4.2 InvocationHandler çš„å®ç°è§‚å¯ŸJdkDynamicAopProxy è¿™ä¸ªç±»çš„å®šä¹‰ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»æœ¬èº«å°±å®ç°äº†InvocationHandler1final class JdkDynamicAopProxy implements AopProxy, InvocationHandler, Serializable &#123;&#125; åœ¨Java åŠ¨æ€ä»£ç†ä¸­è¯´åˆ°ï¼Œé€šè¿‡Proxy ç±»è·å–äº†ä¸€ä¸ªå‚æ•°ä¸ºInvocationHandler çš„æ„é€ å‡½æ•°åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå¹¶å°†è‡ªå®šä¹‰çš„InvocationHandler ä¼ è¿›å» è§‚å¯ŸJdkDynamicAopProxy åˆ›å»ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ï¼Œéµå¾ªè¿™ä¸€åŸåˆ™ï¼Œä¸”ä¼ è¿›å…¥çš„å‚æ•°å°±æ˜¯JdkDynamicAopProxy æœ¬èº«ã€‚ 4.2 æ–¹æ³•æ‰§è¡Œinvokeåœ¨å‰é¢è¯´åˆ°ï¼ŒJdkDynamicAopProxy å®ç°äº†InvocationHandler ï¼Œ æ ¹æ®åœ¨Java åŠ¨æ€ä»£ç†ä¸­å­¦ä¹ çš„æºç ï¼Œå¯¹äºJDK åŠ¨æ€ä»£ç†ï¼Œå½“æ‰§è¡Œä»£ç†å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œä¼šè¿›å…¥è‡ªå®šä¹‰çš„InvocationHandler çš„invoke æ–¹æ³•ã€‚ æ‰€ä»¥è¿™é‡Œå°±æ˜¯è¿›å…¥åˆ°JdkDynamicAopProxy.invoke æ–¹æ³•ä¸­ invoke é€»è¾‘å’ŒCGLIB åŠ¨æ€ä»£ç†ä¸­çš„intercept æ–¹æ³•ï¼Œæ•´ä½“é€»è¾‘å·®ä¸å¤š, åªä¿ç•™é‡ç‚¹é€»è¾‘æ¥çœ‹ä¸€ä¸‹ ç­›é€‰å½“å‰ç±»å½“å‰æ–¹æ³•å¯ç”¨çš„å¢å¼º é€šè¿‡ReflectiveMethodInvocation.proceed æ‰§è¡Œå¢å¼ºé€»è¾‘å’Œç›®æ ‡ç±»æ–¹æ³• 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051final class JdkDynamicAopProxy implements AopProxy, InvocationHandler, Serializable &#123;\tpublic Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; // Get the interception chain for this method. List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass); if (chain.isEmpty()) &#123; Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args); retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse); &#125; else &#123; // We need to create a method invocation... MethodInvocation invocation = new ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain); // Proceed to the joinpoint through the interceptor chain. retVal = invocation.proceed(); &#125; // Massage return value if necessary. Class&lt;?&gt; returnType = method.getReturnType(); if (retVal != null &amp;&amp; retVal == target &amp;&amp; returnType != Object.class &amp;&amp; returnType.isInstance(proxy) &amp;&amp; !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) &#123; retVal = proxy; &#125; else if (retVal == null &amp;&amp; returnType != Void.TYPE &amp;&amp; returnType.isPrimitive()) &#123; throw new AopInvocationException( &quot;Null return value from advice does not match primitive return type for: &quot; + method); &#125; return retVal; &#125; finally &#123; if (target != null &amp;&amp; !targetSource.isStatic()) &#123; // Must have come from TargetSource. targetSource.releaseTarget(target); &#125; if (setProxyContext) &#123; // Restore old proxy. AopContext.setCurrentProxy(oldProxy); &#125; &#125;\t&#125;&#125; getInterceptorsAndDynamicInterceptionAdviceå’ŒCGLIB ä¸­æ˜¯åŒä¸€ä¸ªæ–¹æ³• ReflectiveMethodInvocation.proceedå’ŒCGLIB ä¸­æ˜¯åŒä¸€ä¸ªæ–¹æ³•","tags":["java","Spring"]},{"title":"Spring AOP  å®è·µ","path":"/62ebaa0e/","content":"1. ä¸ºä»€ä¹ˆéœ€è¦AOPå…³äºæ¶ˆé™¤é‡å¤ä»£ç ï¼Œå®šä¹‰å…¬å…±çˆ¶ç±»ä½¿ç”¨ç»§æ‰¿çš„æ–¹å¼å®ç°æ˜¯ä¸€ç§å¸¸è§çš„æ€è·¯ã€‚ä½†æ˜¯ä¾‹å¦‚æ€§èƒ½ç›‘æ§ã€äº‹åŠ¡ç®¡ç†ï¼Œè¿™ç±»é‡å¤ä»£ç çš„ç‰¹ç‚¹æ˜¯å’Œä¸šåŠ¡ä»£ç ç´§å¯†ç»“åˆåœ¨ä¸€èµ·ï¼Œæ— æ³•é€šè¿‡ç»§æ‰¿çš„æ–¹å¼è§£å†³ã€‚ æ¯”å¦‚åœ¨ç¨‹åºè¿è¡Œä¸­ï¼Œæƒ³è®¡ç®—æ¯ä¸ªæ–¹æ³•çš„è¡Œæ—¶é—´, å°±æ²¡æœ‰åŠæ³•é€šè¿‡ç»§æ‰¿çš„æ–¹å¼å»æ¶ˆé™¤è¿™ç±»é‡å¤ä»£ç  12345678910111213141516171819202122public class UserService &#123; public void createUser(String username) &#123; long startTime = System.currentTimeMillis(); // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† System.out.println(&quot;Creating user: &quot; + username); long endTime = System.currentTimeMillis(); System.out.println(&quot;createUseræ–¹æ³•æ‰§è¡Œæ—¶é—´: &quot; + (endTime - startTime) + &quot;ms&quot;); &#125; public void deleteUser(String username) &#123; long startTime = System.currentTimeMillis(); // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† System.out.println(&quot;Deleting user: &quot; + username); long endTime = System.currentTimeMillis(); System.out.println(&quot;deleteUseræ–¹æ³•æ‰§è¡Œæ—¶é—´: &quot; + (endTime - startTime) + &quot;ms&quot;); &#125;&#125; AOP å°±æ˜¯è§£å†³è¿™ç±»é‡å¤çš„æ–¹å¼ã€‚ AOPæ˜¯Aspect Oriented Programingçš„ç®€ç§°ï¼Œ é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚ åœ¨AOPä¸­ï¼Œå°†é‡å¤æ€§ä»£ç æŠ½å–å‡ºæ¥æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œä½†å¦‚ä½•å°†è¿™äº›ç‹¬ç«‹çš„é€»è¾‘èåˆåˆ°ä¸šåŠ¡é€»è¾‘ä¸­å®Œæˆå’ŒåŸæ¥ä¸€æ ·çš„ä¸šåŠ¡æ“ä½œï¼Œè¿™æ‰æ˜¯äº‹æƒ…çš„å…³é”®ï¼Œä¹Ÿæ­£æ˜¯AOPè¦è§£å†³çš„ä¸»è¦é—®é¢˜ã€‚ æœ¬æ–‡å°†å…ˆä»‹ç»Spring ä¸­å„ç§ä½¿ç”¨AOPçš„æ–¹æ³•ï¼Œä½œä¸ºåé¢ä»‹ç»åŸç†çš„å‰ç½®çŸ¥è¯†ã€‚ 2. æ‰‹åŠ¨é…ç½®ä»£ç† - ProxyFactoryBean12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public class UserService &#123; public void createUser(String username) &#123; // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† System.out.println(&quot;Creating user: &quot; + username); &#125; public void deleteUser(String username) &#123; // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç† System.out.println(&quot;Deleting user: &quot; + username); &#125;&#125;// å®šä¹‰ä¸€ä¸ªå‰ç½®å¢å¼ºpublic class LoggingBeforeAdvice implements MethodBeforeAdvice &#123; @Override public void before(Method method, Object[] args, Object target) throws Throwable &#123; System.out.println(&quot;Before method: &quot; + method.getName()); &#125;&#125;// å®šä¹‰ä¸€ä¸ªåç½®å¢å¼ºpublic class LoggingAfterAdvice implements AfterReturningAdvice &#123; @Override public void afterReturning(Object returnValue, Method method, Object[] args, Object target) throws Throwable &#123; System.out.println(&quot;After method: &quot; + method.getName()); &#125;&#125;// å®šä¹‰ä¸€ä¸ª ç¯ç»•å¢å¼ºpublic class LoggingMethodInterceptor implements MethodInterceptor &#123; @Override public Object invoke(MethodInvocation invocation) throws Throwable &#123; // æ–¹æ³•æ‰§è¡Œå‰é€»è¾‘ long startTime = System.currentTimeMillis(); System.out.println(invocation.getMethod().getName()+ &quot; æ–¹æ³•å¼€å§‹æ‰§è¡Œ&quot;); // é€šè¿‡åå°„æ‰§è¡Œç›®æ ‡æ–¹æ³• Object result = invocation.proceed(); // æ–¹æ³•æ‰§è¡Œåé€»è¾‘ //System.out.println(&quot;After method: &quot; + invocation.getMethod().getName()); long endTime = System.currentTimeMillis(); System.out.println(invocation.getMethod().getName()+ &quot;æ–¹æ³•æ‰§è¡Œæ—¶é—´: &quot; + (endTime - startTime) + &quot;ms&quot;); return result; &#125;&#125; applicationContext.xml é…ç½®å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt; &lt;!-- å®šä¹‰ä¸šåŠ¡ç±»çš„ Bean --&gt; &lt;bean id=&quot;userService&quot; class=&quot;com.example.codingInAction.service.UserService&quot;/&gt; &lt;!-- å®šä¹‰ å‰ç½®å¢å¼º --&gt; &lt;bean id=&quot;loggingBeforeAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingBeforeAdvice&quot;/&gt; &lt;!-- å®šä¹‰ åç½®å¢å¼º --&gt; &lt;bean id=&quot;loggingAfterAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingAfterAdvice&quot;/&gt; &lt;!-- å®šä¹‰ ç¯ç»•å¢å¼º --&gt; &lt;bean id=&quot;loggingMethodInterceptor&quot; class=&quot;com.example.codingInAction.aop.LoggingMethodInterceptor&quot;/&gt; &lt;!-- ä½¿ç”¨ ProxyFactoryBean é…ç½®ä»£ç†å¯¹è±¡ --&gt; &lt;bean id=&quot;userServiceProxy&quot; class=&quot;org.springframework.aop.framework.ProxyFactoryBean&quot;&gt; &lt;!-- ç›®æ ‡å¯¹è±¡ --&gt; &lt;property name=&quot;target&quot; ref=&quot;userService&quot;/&gt; &lt;!-- æ‹¦æˆªå™¨ --&gt; &lt;property name=&quot;interceptorNames&quot;&gt; &lt;list&gt; &lt;value&gt;loggingMethodInterceptor&lt;/value&gt; &lt;value&gt;loggingBeforeAdvice&lt;/value&gt; &lt;value&gt;loggingAfterAdvice&lt;/value&gt; &lt;/list&gt; &lt;/property&gt; &lt;!-- å¼ºåˆ¶ä½¿ç”¨CGLIBä»£ç† --&gt; &lt;property name=&quot;proxyTargetClass&quot; value=&quot;true&quot;/&gt; &lt;/bean&gt;&lt;/beans&gt; è¿è¡Œç¨‹åºå¯åŠ¨ä»£ç ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹æˆªå›¾ 1234567891011121314public class CodingInActionApplication&#123; public static void main(String[] args) &#123; ApplicationContext context = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); // è·å–ä»£ç†å¯¹è±¡ UserService userService = (UserService) context.getBean(&quot;userServiceProxy&quot;); // è°ƒç”¨æ–¹æ³•ï¼Œè§‚å¯Ÿ AOP åˆ‡é¢çš„æ•ˆæœ userService.createUser(&quot;john&quot;); userService.deleteUser(&quot;john&quot;); &#125;&#125; ä»¥ä¸Šxml ä¸­çš„é…ç½®å¯ä»¥ç­‰ä»·æ›¿æ¢æˆå¦‚ä¸‹ä»£ç ï¼Œè¿è¡Œç»“æœæ˜¯ä¸€è‡´çš„ 123456789101112131415161718192021class UserServiceTest &#123; @Test void createUser() &#123; UserService target = new UserService(); BeforeAdvice beforeAdvice = new LoggingBeforeAdvice(); AfterReturningAdvice afterAdvice = new LoggingAfterAdvice(); MethodInterceptor methodInterceptor = new LoggingMethodInterceptor(); ProxyFactory proxyFactory = new ProxyFactory(); proxyFactory.setTarget(target); proxyFactory.addAdvice(methodInterceptor); proxyFactory.addAdvice(beforeAdvice); proxyFactory.addAdvice(afterAdvice); UserService proxy = (UserService) proxyFactory.getProxy(); proxy.createUser(&quot;john&quot;); proxy.deleteUser(&quot;john&quot;); &#125; é€šè¿‡ä»¥ä¸Šä»£ç æ¥ç®€å•ä»‹ç»ä¸€ä¸‹AOP ä¸­çš„ä¸“ä¸šæœ¯è¯­ 2.1 è¿æ¥ç‚¹ï¼ˆJoinpointï¼‰è¿æ¥ç‚¹æ˜¯ç¨‹åºæ‰§è¡Œä¸­çš„æŸä¸ªç‰¹å®šç‚¹ã€‚Spring AOPä¸­çš„è¿æ¥ç‚¹é€šå¸¸æ˜¯æ–¹æ³•çš„æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œåœ¨UserServiceç±»ä¸­ï¼ŒcreateUseræ–¹æ³•çš„æ‰§è¡Œå°±æ˜¯ä¸€ä¸ªè¿æ¥ç‚¹ã€‚è¿æ¥ç‚¹å¯ä»¥æ˜¯ç±»åˆå§‹åŒ–ã€å­—æ®µè®¿é—®ã€æ–¹æ³•è°ƒç”¨ç­‰ã€‚ åœ¨UserServiceç±»ä¸­ï¼Œæ–¹æ³•createUserçš„æ‰§è¡Œæ˜¯ä¸€ä¸ªè¿æ¥ç‚¹ã€‚ 123public void createUser(String username) &#123; System.out.println(&quot;Creating user: &quot; + username);&#125; 2.2 å¢å¼ºï¼ˆAdviceï¼‰é€šçŸ¥æ˜¯å›´ç»•è¿æ¥ç‚¹æ‰§è¡Œçš„ä»£ç ã€‚Spring AOPæ”¯æŒäº”ç§ç±»å‹çš„é€šçŸ¥ï¼š å‰ç½®å¢å¼ºï¼ˆBefore Adviceï¼‰ï¼šåœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œã€‚ åç½®å¢å¼ºï¼ˆAfter Returning Adviceï¼‰ï¼šåœ¨æ–¹æ³•æˆåŠŸæ‰§è¡Œä¹‹åæ‰§è¡Œã€‚ å¼‚å¸¸å¢å¼ºï¼ˆAfter Throwing Adviceï¼‰ï¼šåœ¨æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åæ‰§è¡Œã€‚ æœ€ç»ˆå¢å¼ºï¼ˆAfter (finally) Adviceï¼‰ï¼šåœ¨æ–¹æ³•æ‰§è¡Œä¹‹åï¼Œæ— è®ºæ˜¯å¦æŠ›å‡ºå¼‚å¸¸éƒ½ä¼šæ‰§è¡Œã€‚ ç¯ç»•å¢å¼ºï¼ˆAround Adviceï¼‰ï¼šåœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰å’Œä¹‹åæ‰§è¡Œã€‚ åœ¨å‰é¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œå°±åˆ†åˆ«å®šä¹‰äº†å‰ç½®å¢å¼ºã€åç½®å¢å¼ºå’Œç¯ç»•å¢å¼º 2.3 å¦‚ä½•å°†Advice ç»‡å…¥æŸäº›ç±»çš„æŸäº›ç‰¹å®šçš„æ–¹æ³•åœ¨å‰é¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæœ‰è¿æ¥ç‚¹ joinpoint å’Œ å¢å¼º Adviceï¼Œçœ‹è¿è¡Œç»“æœæˆ‘ä»¬å¯èƒ½æ³¨æ„åˆ°ä¸€ä¸ªé—®é¢˜ï¼šAdvice å¢å¼ºè¢«é»˜è®¤ç»‡å…¥(weaving)äº†ç›®æ ‡ç±»(target)çš„æ‰€æœ‰æ–¹æ³•ä¸­ï¼Œå³interceptorNames ä¸­é…ç½®çš„æ‹¦æˆªå™¨ä¼šå¯¹ç›®æ ‡å¯¹è±¡userServiceä¸­æ‰€æœ‰æ–¹æ³•èµ·ä½œç”¨ï¼Œè¿™æ˜¯ å› ä¸ºæ²¡æœ‰å®šä¹‰å…·ä½“çš„ Pointcut æ¥é™åˆ¶æ‹¦æˆªèŒƒå›´ã€‚ 12345678910111213141516&lt;!-- ä½¿ç”¨ ProxyFactoryBean é…ç½®ä»£ç†å¯¹è±¡ --&gt; &lt;bean id=&quot;userServiceProxy&quot; class=&quot;org.springframework.aop.framework.ProxyFactoryBean&quot;&gt; &lt;!-- ç›®æ ‡å¯¹è±¡ --&gt; &lt;property name=&quot;target&quot; ref=&quot;userService&quot;/&gt; &lt;!-- æ‹¦æˆªå™¨ --&gt; &lt;property name=&quot;interceptorNames&quot;&gt; &lt;list&gt; &lt;value&gt;loggingMethodInterceptor&lt;/value&gt; &lt;value&gt;loggingBeforeAdvice&lt;/value&gt; &lt;value&gt;loggingAfterAdvice&lt;/value&gt; &lt;/list&gt; &lt;/property&gt; &lt;!-- å¼ºåˆ¶ä½¿ç”¨CGLIBä»£ç† --&gt; &lt;property name=&quot;proxyTargetClass&quot; value=&quot;true&quot;/&gt; &lt;/bean&gt; ä¸ºäº†æ›´åŠ çµæ´»,æ›´æœ‰é€‰æ‹©åœ°å°†å¢å¼º ç»‡å…¥æŸäº›ç±»çš„æŸäº›ç‰¹å®šçš„æ–¹æ³•ä¸­ ï¼Œå¯ä»¥å®šä¹‰ Pointcut å’Œ Advisorã€‚è¿™æ ·å¯ä»¥æ˜ç¡®åœ°æŒ‡å®šåœ¨å“ªäº›è¿æ¥ç‚¹ joinpoint ä¸Šåº”ç”¨Advice å¢å¼ºã€‚ 2.3.1 Pointcut -æ¥å£å®ç°Pointcut æœ‰ä¸åŒçš„å®ç°æ–¹å¼å¯ä»¥æ˜¯é€šè¿‡Pointcutæ¥å£ å®ç°ï¼Œä¹Ÿå¯ä»¥æ˜¯åˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œè¿™ä¸€èŠ‚å†…å®¹å…ˆä»‹ç»æ¥å£å®ç°æ–¹å¼ï¼Œ åé¢è‡ªåŠ¨ä»£ç†æœºåˆ¶éƒ¨åˆ†å†ä»‹ç»è¡¨è¾¾å¼æ–¹å¼ã€‚ Springé€šè¿‡org.springframework.aop.Pointcutæ¥å£æè¿°åˆ‡ç‚¹, Pointcut ç”±ClassFilterå’ŒMethodMatcheræ„æˆï¼Œå®ƒé€šè¿‡ClassFilterå®šä½åˆ°æŸäº›ç‰¹å®šç±»ä¸Šï¼Œé€šè¿‡MethodMatcherå®šä½åˆ°æŸäº›ç‰¹å®šæ–¹æ³•ä¸Šï¼Œè¿™æ ·Pointcutå°±æ‹¥æœ‰äº†æè¿°æŸäº›ç±»çš„æŸäº›ç‰¹å®šæ–¹æ³•çš„èƒ½åŠ›ã€‚ 123456789101112131415161718192021public interface Pointcut &#123;\t/** * Return the ClassFilter for this pointcut. * @return the ClassFilter (never &#123;@code null&#125;) */\tClassFilter getClassFilter();\t/** * Return the MethodMatcher for this pointcut. * @return the MethodMatcher (never &#123;@code null&#125;) */\tMethodMatcher getMethodMatcher();\t/** * Canonical Pointcut instance that always matches. */\tPointcut TRUE = TruePointcut.INSTANCE;&#125; æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªpointcut åŒ¹é…UserServiceä¸­çš„createæ–¹æ³•ã€‚ 12345678910111213141516171819202122232425262728293031323334public class LoggingPointcut implements Pointcut &#123; @Override public ClassFilter getClassFilter() &#123; return clazz -&gt; clazz == UserService.class; &#125; @Override public MethodMatcher getMethodMatcher() &#123; return new MethodMatcher() &#123; @Override public boolean matches(Method method, Class&lt;?&gt; targetClass) &#123; if (method.getName().equals(&quot;createUser&quot;)) &#123; return true; &#125; return false; &#125; @Override public boolean isRuntime() &#123; return true; &#125; @Override public boolean matches(Method method, Class&lt;?&gt; targetClass, Object... args) &#123; if (method.getName().equals(&quot;createUser&quot;)) &#123; return true; &#125; return false; &#125; &#125;; &#125;&#125; é€šè¿‡æ•°æ®åº“æŸ¥è¯¢çš„æ¦‚å¿µï¼Œå¯ä»¥è¿™æ ·æ¥ç†è§£ä»¥ä¸Šjoinpointã€Adviceã€pointcut 3ä¸ªæ¦‚å¿µã€‚ è¿æ¥ç‚¹ç›¸å½“äºæ•°æ®åº“ä¸­çš„è®°å½•ï¼Œè€Œåˆ‡ç‚¹ç›¸å½“äºæŸ¥è¯¢æ¡ä»¶ã€‚åˆ‡ç‚¹å’Œè¿æ¥ç‚¹ä¸æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œä¸€ä¸ªåˆ‡ç‚¹å¯ä»¥åŒ¹é…å¤šä¸ªè¿æ¥ç‚¹ã€‚ æ ¹æ®æ¯ä¸ªæŸ¥è¯¢æ¡ä»¶ (åˆ‡ç‚¹ pointcut) æ‰¾åˆ°å¯¹åº”è®°å½•(è¿æ¥ç‚¹ Joinpoint )åï¼Œå¯¹è®°å½•æ‰§è¡Œçš„æ“ä½œï¼Œç›¸å½“äºå¢å¼ºAdvice 2.3.2 Advisor åˆ‡é¢Advisoræ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µ,å®ƒå°†åˆ‡ç‚¹ï¼ˆPointcutï¼‰å’Œå¢å¼ºï¼ˆAdviceï¼‰ç»“åˆèµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªåˆ‡é¢ï¼ˆAspectï¼‰ã€‚AdvisoråŒ…å«ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼š Pointcutï¼šå®šä¹‰åœ¨å“ªäº›è¿æ¥ç‚¹ï¼ˆé€šå¸¸æ˜¯æ–¹æ³•æ‰§è¡Œï¼‰ä¸Šåº”ç”¨é€šçŸ¥ã€‚ Adviceï¼šå®šä¹‰åœ¨è¿æ¥ç‚¹ä¸Šæ‰§è¡Œçš„å…·ä½“æ“ä½œï¼Œå¯ä»¥æ˜¯åœ¨æ–¹æ³•æ‰§è¡Œå‰ã€åæˆ–ç¯ç»•æ–¹æ³•æ‰§è¡Œã€‚ åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æŠŠä¸Šé¢ä¾‹å­ä¸­çš„ç¯ç»•å¢å¼ºæ”¹æˆAdvisor çš„å½¢å¼ï¼Œä»¥ç»™å®ƒå¢åŠ â€œç­›é€‰æ¡ä»¶â€ pointcut 123456789101112131415public class LoggingAdvisor implements PointcutAdvisor &#123; @Override public Pointcut getPointcut() &#123; return new LoggingPointcut(); &#125; @Override public Advice getAdvice() &#123; return new LoggingMethodInterceptor(); &#125; @Override public boolean isPerInstance() &#123; return true; &#125;&#125; ä¿®æ”¹applicationContext.xml 1234567891011121314151617181920212223242526272829303132333435363738&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt; &lt;!-- ä»¥ä¸‹å†…å®¹æ˜¯ä½¿ç”¨ ProxyFactoryBean é…ç½®ä»£ç†å¯¹è±¡ï¼Œ ç”¨ Advisor å¢åŠ åˆ‡ç‚¹--&gt; &lt;!-- å®šä¹‰ä¸šåŠ¡ç±»çš„ Bean --&gt; &lt;bean id=&quot;userService&quot; class=&quot;com.example.codingInAction.service.UserService&quot;/&gt; &lt;!-- å®šä¹‰ å‰ç½®å¢å¼º--&gt; &lt;bean id=&quot;loggingBeforeAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingBeforeAdvice&quot;/&gt; &lt;!-- å®šä¹‰ åç½®å¢å¼º --&gt; &lt;bean id=&quot;loggingAfterAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingAfterAdvice&quot;/&gt; &lt;!-- å®šä¹‰ ç¯ç»•å¢å¼º --&gt; &lt;bean id=&quot;loggingAdvisor&quot; class=&quot;com.example.codingInAction.aop.LoggingAdvisor&quot;/&gt; &lt;bean id=&quot;userServiceProxy&quot; class=&quot;org.springframework.aop.framework.ProxyFactoryBean&quot;&gt; &lt;!-- ç›®æ ‡å¯¹è±¡ --&gt; &lt;property name=&quot;target&quot; ref=&quot;userService&quot;/&gt; &lt;!-- æ‹¦æˆªå™¨ --&gt; &lt;property name=&quot;interceptorNames&quot;&gt; &lt;list&gt; &lt;value&gt;loggingAdvisor&lt;/value&gt; &lt;value&gt;loggingBeforeAdvice&lt;/value&gt; &lt;value&gt;loggingAfterAdvice&lt;/value&gt; &lt;/list&gt; &lt;/property&gt; &lt;!-- å¼ºåˆ¶ä½¿ç”¨CGLIBä»£ç† --&gt; &lt;property name=&quot;proxyTargetClass&quot; value=&quot;true&quot;/&gt; &lt;/bean&gt;&lt;/beans&gt; è¿è¡Œå‰é¢ç›¸åŒçš„å¯åŠ¨ä»£ç ï¼Œå¯ä»¥å¾—åˆ°ç›¸åŒçš„è¿è¡Œç»“æœã€‚å¯ä»¥çœ‹åˆ°ï¼Œå¢åŠ äº†â€œç­›é€‰æ¡ä»¶â€çš„ç¯ç»•å¢å¼ºï¼Œå¦‚é¢„æœŸä¸€æ ·ï¼Œåªåœ¨createæ–¹æ³•ä¸Šå‘æŒ¥äº†ä½œç”¨ã€‚ åœ¨å‰é¢æ‰€æœ‰çš„ä¾‹å­ä¸­ï¼Œéƒ½æ˜¯é€šè¿‡ProxyFactoryBeanåˆ›å»ºç»‡å…¥åˆ‡é¢çš„ä»£ç†ï¼Œæ¯ä¸€ä¸ªéœ€è¦è¢«ä»£ç†çš„Beanéƒ½éœ€è¦ä½¿ç”¨ä¸€ä¸ªProxyFactoryBeanè¿›è¡Œé…ç½® CodingInActionApplication 3. è‡ªåŠ¨ä»£ç†æœºåˆ¶-AbstractAutoProxyCreatoråœ¨ä»¥ä¸Š AOP çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬æ¢è®¨äº†é€šè¿‡åœ¨XMLé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ProxyFactoryBeanæ¥é…ç½®ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œå¹¶åœ¨éœ€è¦æ—¶æ‰‹åŠ¨è·å–ä»£ç†å¯¹è±¡ä»¥å®ç°AOPåŠŸèƒ½ã€‚ ç„¶è€Œï¼Œåœ¨å¤§å‹ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™ç§é…ç½®æ–¹å¼æ˜¾å¾—ç¹çä¸”ä¸åˆ‡å®é™…ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒSpringæä¾›äº†ä¸€ç§åŸºäºAbstractAutoProxyCreatorçš„è‡ªåŠ¨ä»£ç†æœºåˆ¶ï¼Œä½¿å¾—æˆ‘ä»¬æ— éœ€ä¸ºæ¯ä¸ªBeanæ‰‹åŠ¨é…ç½®ProxyFactoryBeanã€‚AbstractAutoProxyCreatoré€šè¿‡è‡ªåŠ¨æ£€æµ‹Beançš„ç±»å‹å’Œç›¸åº”çš„åˆ‡é¢ï¼ˆAspectï¼‰æ¥åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä»è€Œç®€åŒ–äº†é…ç½®è¿‡ç¨‹ã€‚ AbstractAutoProxyCreator æœ‰å¾ˆå¤šå­ç±»ï¼Œä¸‹é¢å°†ä»‹ç»å„ä¸ªå­ç±»å¦‚ä½•é…ç½®å®Œæˆè‡ªåŠ¨ä»£ç†æœºåˆ¶ã€‚ 3.1 BeanNameAutoProxyCreatorä½¿ç”¨ BeanNameAutoProxyCreator åï¼Œä½ ä¸å†éœ€è¦æ‰‹åŠ¨é…ç½®å’Œè·å– userServiceProxy ä»£ç†å¯¹è±¡ã€‚Spring ä¼šè‡ªåŠ¨ä¸ºæŒ‡å®šçš„ Bean åˆ›å»ºä»£ç†å¯¹è±¡ã€‚ä½ åªéœ€è¦è·å–åŸå§‹çš„ userServiceï¼ŒSpring ä¼šè‡ªåŠ¨ä¸ºå®ƒåº”ç”¨å¢å¼ºã€‚ ä¿®æ”¹applicationContext.xml 1234567891011121314151617181920212223242526272829303132333435 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;&lt;!-- è‡ªåŠ¨ä»£ç†æœºåˆ¶ å¯ç”¨ BeanNameAutoProxyCreator --&gt; &lt;!-- å®šä¹‰ä¸šåŠ¡ç±»çš„ Bean --&gt; &lt;bean id=&quot;userService&quot; class=&quot;com.example.codingInAction.service.UserService&quot;/&gt; &lt;!-- å®šä¹‰ ç¯ç»•å¢å¼º --&gt; &lt;bean id=&quot;loggingAdvisor&quot; class=&quot;com.example.codingInAction.aop.LoggingAdvisor&quot;/&gt; &lt;!-- å®šä¹‰ å‰ç½®å¢å¼º--&gt; &lt;bean id=&quot;loggingBeforeAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingBeforeAdvice&quot;/&gt; &lt;!-- å®šä¹‰ åç½®å¢å¼º --&gt; &lt;bean id=&quot;loggingAfterAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingAfterAdvice&quot;/&gt; &lt;bean class=&quot;org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator&quot;&gt; &lt;property name=&quot;beanNames&quot;&gt; &lt;list&gt; &lt;value&gt;userService&lt;/value&gt; &lt;/list&gt; &lt;/property&gt; &lt;property name=&quot;interceptorNames&quot;&gt; &lt;list&gt; &lt;value&gt;loggingAdvisor&lt;/value&gt; &lt;value&gt;loggingBeforeAdvice&lt;/value&gt; &lt;value&gt;loggingAfterAdvice&lt;/value&gt; &lt;/list&gt; &lt;/property&gt; &lt;/bean&gt;&lt;/beans&gt; ä¿®æ”¹CodingInActionApplicationï¼Œä¸å†ä¸»åŠ¨è·å–ä»£ç†å¯¹è±¡ 1234567891011121314151617public class CodingInActionApplication &#123; public static void main(String[] args) &#123; ApplicationContext context = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); // æ‰‹åŠ¨é…ç½®å¹¶æ‰‹åŠ¨è·å–ä»£ç†Bean // UserService userService = (UserService) context.getBean(&quot;userServiceProxy&quot;); // è‡ªåŠ¨ä»£ç†æœºåˆ¶ UserService userService = (UserService) context.getBean(&quot;userService&quot;); // è°ƒç”¨æ–¹æ³•ï¼Œè§‚å¯Ÿ AOP åˆ‡é¢çš„æ•ˆæœ userService.createUser(&quot;john&quot;); userService.deleteUser(&quot;john&quot;); &#125;&#125; è¿è¡Œå¯åŠ¨ä»£ç ï¼Œå¯ä»¥å¾—åˆ°ç›¸åŒçš„è¿è¡Œç»“æœ 3.2 DefaultAdvisorAutoProxyCreatorDefaultAdvisorAutoProxyCreator ä½¿ç”¨ AbstractAdvisorAutoProxyCreator çš„å®ç°ç±» DefaultAdvisorAutoProxyCreator å®ç°è‡ªåŠ¨ä»£ç†æ—¶ DefaultAdvisorAutoProxyCreator æ˜¯ AbstractAdvisorAutoProxyCreator çš„å…·ä½“å®ç°ç±»ï¼Œå®ƒä¼šè‡ªåŠ¨æ‰«æ Spring å®¹å™¨ä¸­çš„æ‰€æœ‰ Beanï¼Œå¹¶åº”ç”¨ç¬¦åˆæ¡ä»¶çš„ Advisorã€‚ AbstractAdvisorAutoProxyCreator æ˜¯ AbstractAutoProxyCreator çš„ç›´æ¥å­ç±»ï¼Œå®ƒæ‰«æ Spring å®¹å™¨ä¸­çš„æ‰€æœ‰ Advisorï¼ˆä¸€ä¸ª Advisor åŒ…å«ä¸€ä¸ª Advice å’Œä¸€ä¸ª Pointcutï¼‰ï¼Œå¹¶æ ¹æ® Pointcut çš„åŒ¹é…è§„åˆ™ï¼Œè‡ªåŠ¨ä¸ºåŒ¹é…çš„ Bean åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå¹¶åº”ç”¨å¯¹åº”çš„ Adviceã€‚å®ç°ç±»ä¸ºDefaultAdvisorAutoProxyCreatorã€‚ æˆ‘ä»¬ç®€åŒ–ä¸‹ä»£ç ï¼Œåªä¿ç•™å®ç°äº†Advisor çš„ç¯ç»•å¢å¼ºæ¥çœ‹ä¸‹è¿è¡Œç»“æœ 1234567891011121314151617181920&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot; &lt;!-- å®šä¹‰ä¸šåŠ¡ç±»çš„ Bean --&gt; &lt;bean id=&quot;userService&quot; class=&quot;com.example.codingInAction.service.UserService&quot;/&gt; &lt;!-- å®šä¹‰ ç¯ç»•å¢å¼º --&gt; &lt;bean id=&quot;loggingAdvisor&quot; class=&quot;com.example.codingInAction.aop.LoggingAdvisor&quot;/&gt; &lt;!-- å¯ç”¨è‡ªåŠ¨ä»£ç† --&gt; &lt;bean class=&quot;org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator&quot;/&gt;&lt;/beans&gt; è¿è¡Œå’Œä¸Šé¢ä¸€æ ·çš„CodingInActionApplicationï¼Œ å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœ 3.3 åŸºäºAspectJ å®ç°çš„è‡ªåŠ¨ä»£ç†ç»ˆäºæ¥åˆ°æ—¥å¸¸å¼€å‘ä¸­ï¼Œ æœ€å¸¸è§çš„AOP é…ç½®æ–¹å¼äº†ï¼ŒåŸºäºAspectJ æ³¨è§£çš„æ–¹å¼ã€‚ ä»¥ä¸Šæåˆ°çš„æ‰€æœ‰AOP é…ç½®æ–¹å¼ä¸­ï¼Œä¸è®ºæ˜¯ä½¿ç”¨æ‰‹åŠ¨é…ç½®çš„ProxyFactoryBeanï¼Œè¿˜æ˜¯è‡ªåŠ¨ä»£ç†çš„BeanNameAutoProxyCreatorã€DefaultAdvisorAutoProxyCreatorï¼Œéƒ½éœ€è¦å®ç°Pointcutå’ŒAdviceæ¥å£æè¿°åˆ‡ç‚¹å’Œå¢å¼ºï¼Œå¹¶ç”¨Advisoræ•´åˆä¸¤è€…æè¿°åˆ‡é¢ã€‚ AspectJåˆ™é‡‡ç”¨æ³¨è§£æ¥æè¿°åˆ‡ç‚¹ã€å¢å¼ºï¼Œä¸¤è€…åªæ˜¯è¡¨è¿°æ–¹å¼ä¸åŒï¼Œæè¿°å†…å®¹çš„æœ¬è´¨æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œè¿™å°±å¥½æ¯”ä¸€ä¸ªç”¨ä¸­æ–‡ã€ä¸€ä¸ªç”¨è‹±æ–‡è®²è¿°åŒä¸€ä¸ªä¼Šç´¢å¯“è¨€ä¸€æ ·ã€‚ AspectJ æ˜¯ä¸€ä¸ªå¼ºå¤§çš„é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰æ¡†æ¶ï¼Œç‹¬ç«‹äº Spring ä½†å¯ä»¥æ— ç¼é›†æˆã€‚ AspectJAwareAdvisorAutoProxyCreatorAspectJAwareAdvisorAutoProxyCreatoræ˜¯ AbstractAdvisorAutoProxyCreator çš„å­ç±»ï¼Œä¸»è¦ç”¨äºå¤„ç†åŸºäº AspectJ æ–¹å¼çš„ AOP é…ç½®ã€‚ å®ƒå’Œ AnnotationAwareAspectJAutoProxyCreator ç±»ä¼¼ï¼Œä½†ä¸»è¦ç”¨äºå¤„ç†é€šè¿‡ XML é…ç½®æ–‡ä»¶æˆ–å…¶ä»–éæ³¨è§£æ–¹å¼é…ç½®çš„ AspectJ åˆ‡é¢ã€‚ AnnotationAwareAspectJAutoProxyCreatorAnnotationAwareAspectJAutoProxyCreatoræ˜¯ AspectJAwareAdvisorAutoProxyCreator çš„å­ç±»ï¼Œå®ƒåœ¨ AbstractAdvisorAutoProxyCreator çš„åŸºç¡€ä¸Šå¢åŠ äº†å¯¹ AspectJ æ³¨è§£çš„æ”¯æŒã€‚ AnnotationAwareAspectJAutoProxyCreator æ‰«æä½¿ç”¨äº† AspectJ æ³¨è§£ï¼ˆå¦‚ @Aspectã€@Beforeã€@After ç­‰ï¼‰çš„ Beanï¼Œå¹¶å°†è¿™äº›æ³¨è§£é…ç½®çš„åˆ‡é¢åº”ç”¨åˆ°åŒ¹é…çš„ Bean ä¸Šã€‚ pointcut -è¡¨è¾¾å¼å®ç°å®šä¹‰ä¸€ä¸ª LoggingAspect 1234567891011121314151617181920212223242526272829303132333435363738import org.aspectj.lang.ProceedingJoinPoint;import org.aspectj.lang.annotation.*;import org.aspectj.lang.JoinPoint;@Aspectpublic class LoggingAspect &#123; //å®šä¹‰ä¸€ä¸ªåŒ¹é…userServiceä¸­æ‰€æœ‰æ–¹æ³•çš„åˆ‡ç‚¹è¡¨è¾¾å¼ @Pointcut(&quot;execution(* com.example.codingInAction.service.UserService.*(..))&quot;) public void userServiceAllMethod() &#123; &#125; // åœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œçš„é€šçŸ¥ @Before(&quot;userServiceAllMethod()&quot;) public void logBefore(JoinPoint joinPoint) &#123; System.out.println(&quot;Before method: &quot; + joinPoint.getSignature().getName()); &#125; // åœ¨æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œçš„é€šçŸ¥ @After(&quot;userServiceAllMethod()&quot;) public void logAfter(JoinPoint joinPoint) &#123; System.out.println(&quot;After method: &quot; + joinPoint.getSignature().getName()); &#125; // å®šä¹‰ä¸€ä¸ªåªåŒ¹é… UserService.createUser æ–¹æ³•çš„åˆ‡ç‚¹è¡¨è¾¾å¼ @Around(&quot;execution(* com.example.codingInAction.service.UserService.createUser(..))&quot;) public Object logAround(ProceedingJoinPoint joinPoint) throws Throwable &#123; long startTime = System.currentTimeMillis(); System.out.println(joinPoint.getSignature().getName() + &quot; æ–¹æ³•å¼€å§‹æ‰§è¡Œ&quot;); Object result = joinPoint.proceed(); // æ‰§è¡Œç›®æ ‡æ–¹æ³• long endTime = System.currentTimeMillis(); System.out.println(joinPoint.getSignature().getName() + &quot; æ–¹æ³•æ‰§è¡Œæ—¶é—´: &quot; + (endTime - startTime) + &quot;ms&quot;); return result; &#125;&#125; å€Ÿä¸€å¼ æ¥æè¿°ä¸‹å„ä¸ªéƒ¨åˆ†çš„ä½¿ç”¨æ–¹å¼å’Œå«ä¹‰ ä¿®æ”¹applicationContext.xmlï¼Œå¹¶è¿è¡Œå¯åŠ¨ä»£ç ï¼Œè¿è¡Œç»“æœä¾ç„¶å’Œä¹‹å‰ä¿æŒä¸€è‡´ã€‚ 1234567891011121314151617181920212223&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt; &lt;!-- å¯ç”¨ AspectJ è‡ªåŠ¨ä»£ç† --&gt; &lt;aop:aspectj-autoproxy/&gt; &lt;!-- å®šä¹‰ä¸šåŠ¡ç±»çš„ Bean --&gt; &lt;bean id=&quot;userService&quot; class=&quot;com.example.codingInAction.service.UserService&quot;/&gt; &lt;!-- å®šä¹‰åˆ‡é¢çš„ Bean --&gt; &lt;bean id=&quot;loggingAspect&quot; class=&quot;com.example.codingInAction.aop.LoggingAspect&quot;/&gt;&lt;/beans&gt; 4. è‡ªåŠ¨ä»£ç†æœºåˆ¶-åŸºäºSchemaé…ç½®åˆ‡é¢å¦‚æœé¡¹ç›®ä¸èƒ½ä½¿ç”¨JDK 5.0ï¼Œé‚£ä¹ˆå°±æ— æ³•ä½¿ç”¨åŸºäº@AspectJæ³¨è§£çš„åˆ‡é¢äº†ã€‚ä½†æ˜¯ä½¿ç”¨AspectJåˆ‡ç‚¹è¡¨è¾¾å¼çš„å¤§é—¨ä¾æ—§å‘æˆ‘ä»¬æ•å¼€ç€ï¼Œå› ä¸ºSpringæä¾›äº†åŸºäºSchemaé…ç½®çš„æ–¹æ³•ï¼Œå®ƒå®Œå…¨å¯ä»¥æ›¿ä»£åŸºäº@AspectJæ³¨è§£å£°æ˜åˆ‡é¢çš„æ–¹å¼ã€‚ä¾ç„¶æ˜¯åšåŒä¸€ä»¶äº‹çš„ä¸¤ç§ä¸åŒè¡¨è¾¾å½¢å¼ åœ¨Springçš„XMLé…ç½®ä¸­ï¼Œ&lt;aop:config&gt;æ ‡ç­¾å¯ä»¥ç›´æ¥å®šä¹‰åˆ‡ç‚¹å’Œé€šçŸ¥ï¼Œå¹¶å°†å®ƒä»¬åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡ä¸Šã€‚è¿™ç§æ–¹å¼ç®€åŒ–äº†é…ç½®ï¼Œä¸éœ€è¦é¢å¤–çš„Javaç±»æ¥å®šä¹‰Pointcutå’ŒAdvisorã€‚ 12345678910111213141516171819202122232425262728293031323334353637&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt; &lt;!-- å®šä¹‰ä¸šåŠ¡ç±»çš„ Bean --&gt; &lt;bean id=&quot;userService&quot; class=&quot;com.example.codingInAction.service.UserService&quot;/&gt; &lt;!-- å®šä¹‰ å‰ç½®å¢å¼º--&gt; &lt;bean id=&quot;loggingBeforeAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingBeforeAdvice&quot;/&gt; &lt;!-- å®šä¹‰ åç½®å¢å¼º --&gt; &lt;bean id=&quot;loggingAfterAdvice&quot; class=&quot;com.example.codingInAction.aop.LoggingAfterAdvice&quot;/&gt; &lt;bean id=&quot;loggingMethodInterceptor&quot; class=&quot;com.example.codingInAction.aop.LoggingMethodInterceptor&quot;/&gt; &lt;!-- é…ç½®AOP --&gt; &lt;aop:config&gt; &lt;!-- å®šä¹‰åˆ‡ç‚¹ï¼ŒåŒ¹é… UserService ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³• --&gt; &lt;aop:pointcut id=&quot;userServiceMethods&quot; expression=&quot;execution(* com.example.codingInAction.service.UserService.*(..))&quot;/&gt; &lt;aop:pointcut id=&quot;userServiceCreateMethod&quot; expression=&quot;execution(* com.example.codingInAction.service.UserService.createUser(..))&quot;/&gt; &lt;!-- å®šä¹‰ advisorï¼Œå°† MethodInterceptor åº”ç”¨äºåˆ‡ç‚¹ --&gt; &lt;aop:advisor advice-ref=&quot;loggingMethodInterceptor&quot; pointcut-ref=&quot;userServiceCreateMethod&quot;/&gt; &lt;aop:advisor advice-ref=&quot;loggingBeforeAdvice&quot; pointcut-ref=&quot;userServiceMethods&quot;/&gt; &lt;aop:advisor advice-ref=&quot;loggingAfterAdvice&quot; pointcut-ref=&quot;userServiceMethods&quot;/&gt; &lt;/aop:config&gt;&lt;/beans&gt; 5. åˆ‡é¢ç±»å‹æ€»ç»“æ ¹æ®ä»¥ä¸Šä»£ç æ‰©å……å¹¶æ€»ç»“ä¸‹åˆ‡é¢ç±»å‹","tags":["java","Spring"]},{"title":"Spring bean å®ä¾‹åŒ–è¿‡ç¨‹","path":"/678b23b2/","content":"åœ¨Spring IOC å®¹å™¨ å’Œ Spring bean ä¸€æ–‡ä¸­ï¼Œä»‹ç»äº†Spring IOC å®¹å™¨å’Œbean ä¸€äº›ç›¸å…³åŸºç¡€çŸ¥è¯†ã€‚ Spring IOC å®¹å™¨çš„ä½œç”¨æ˜¯ ç®¡ç† Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ§åˆ¶ Bean çš„ä¾èµ–æ³¨å…¥ã€‚ æœ¬æ–‡å†…å®¹å°†å…·ä½“ä»‹ç»Spring IOC å®¹å™¨æ˜¯å¦‚ä½•ç®¡ç†bean çš„ç”Ÿå‘½å‘¨æœŸå’Œbean ä¹‹é—´çš„ä¾èµ–å…³ç³»çš„ã€‚ å…ˆæ¥çœ‹ä¸€å¼ æ•´ä½“æ¡†æ¶å›¾ è¯»å–Beané…ç½®ä¿¡æ¯ï¼šSpringå®¹å™¨é¦–å…ˆè¯»å–Beançš„é…ç½®ä¿¡æ¯ï¼Œè¿™äº›é…ç½®ä¿¡æ¯å¯ä»¥æ¥è‡ªXMLé…ç½®æ–‡ä»¶ã€Javaç±»ï¼ˆå¸¦æœ‰@Configurationæ³¨è§£ï¼‰æˆ–é€šè¿‡æ³¨è§£ï¼ˆå¦‚@Autowiredï¼‰çš„æ–¹å¼å®šä¹‰ã€‚ æ³¨å†ŒBeanå®šä¹‰ï¼šæ ¹æ®è¯»å–çš„é…ç½®ä¿¡æ¯ï¼ŒSpringå°†Beançš„å®šä¹‰ï¼ˆåŒ…æ‹¬ç±»åã€ä¾èµ–å…³ç³»ç­‰ï¼‰æ³¨å†Œåˆ°Beanå®šä¹‰æ³¨å†Œè¡¨ä¸­ã€‚ å®ä¾‹åŒ–Beanï¼šSpringæ ¹æ®Beanå®šä¹‰æ³¨å†Œè¡¨ä¸­çš„ä¿¡æ¯ï¼Œå®ä¾‹åŒ–ç›¸åº”çš„Beanã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šå¤„ç†ä¾èµ–æ³¨å…¥å’Œå¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚ ä½¿ç”¨Beanï¼šåº”ç”¨ç¨‹åºå¯ä»¥ä»Springå®¹å™¨ä¸­è·å–Beanå®ä¾‹å¹¶ä½¿ç”¨å®ƒä»¬ã€‚Springå®¹å™¨ä¼šæ ¹æ®éœ€è¦ä»Beanç¼“å­˜æ± ä¸­è¿”å›å·²ç»å®ä¾‹åŒ–å¹¶åˆå§‹åŒ–å¥½çš„Beanã€‚ ä»¥ä¸‹ä»£ç åˆ†æåŸºäºSpring boot 2.3.4 ç‰ˆæœ¬è¿›è¡Œåˆ†æã€‚ ç›´æ¥ä»æœåŠ¡å¯åŠ¨run æ–¹æ³•ï¼Œå¿«è¿›åˆ° refresh æ–¹æ³•çœ‹é‡ç‚¹ 123456public class CodingInActionApplication&#123; public static void main(String[] args) &#123; SpringApplication.run(CodingInActionApplication.class, args); &#125; &#125; 123456789AbstractApplicationContext.java@Override public void refresh() throws BeansException, IllegalStateException &#123;\t// 1. åˆ›å»ºbeanFactory ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();\t// 2. beançš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œä¾èµ–å…³ç³»çš„è£…é…\tfinishBeanFactoryInitialization(beanFactory);&#125; æœ¬æ–‡å°†é‡ç‚¹ä»‹ç»DefaultListableBeanFactory å’Œ finishBeanFactoryInitializationæ–¹æ³•ä¸­æ•´ä¸ªæµç¨‹ 1.bean å®¹å™¨-DefaultListableBeanFactoryAbstractApplicationContext.obtainFreshBeanFactory æ ¹æ®å‰é¢çš„å†…å®¹æˆ‘ä»¬çŸ¥é“ï¼Œ ApplicationContext æ˜¯é¢å‘åº”ç”¨çš„å®¹å™¨ï¼Œä½†åœ¨Spring æ¡†æ¶å±‚é¢ï¼ŒBeanFactoryæ‰æ˜¯IOC å®¹å™¨ã€‚ æ ¹æ®ä»£ç å¯çŸ¥ï¼Œåœ¨Spring boot çš„å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œ BeanFactoryä½¿ç”¨çš„æ˜¯DefaultListableBeanFactoryã€‚ å…ˆæ¥çœ‹ä¸‹ï¼Œ BeanFactoryä½œä¸ºSpring IOC å®¹å™¨,æœ‰å“ªäº›å˜é‡æ¥å®ç°åŠŸèƒ½123456789101112131415161718192021222324252627282930313233343536public class DefaultListableBeanFactory extends AbstractAutowireCapableBeanFactory implements ConfigurableListableBeanFactory, BeanDefinitionRegistry, Serializable &#123; /** Map of bean definition objects, keyed by bean name. */ //å­˜å‚¨æ‰€æœ‰æ³¨å†Œçš„beanå®šä¹‰,é”®æ˜¯beançš„åç§°ã€‚\tprivate final Map&lt;String, BeanDefinition&gt; beanDefinitionMap = new ConcurrentHashMap&lt;&gt;(256); /** Map from bean name to merged BeanDefinitionHolder. */ //ä»beanåç§°åˆ°åˆå¹¶çš„`BeanDefinitionHolder`çš„æ˜ å°„ã€‚åœ¨å¤„ç†beanå®šä¹‰ç»§æ‰¿å’Œåˆå¹¶æ—¶ï¼Œå­˜å‚¨åˆå¹¶åçš„beanå®šä¹‰ã€‚\tprivate final Map&lt;String, BeanDefinitionHolder&gt; mergedBeanDefinitionHolders = new ConcurrentHashMap&lt;&gt;(256); /** Map of singleton and non-singleton bean names, keyed by dependency type. */ //ä»ä¾èµ–ç±»å‹åˆ°å•ä¾‹å’Œéå•ä¾‹beanåç§°çš„æ˜ å°„ã€‚ç”¨äºæ ¹æ®ç±»å‹æŸ¥æ‰¾æ‰€æœ‰ç›¸å…³çš„beanåç§°ï¼ŒåŒ…æ‹¬å•ä¾‹å’Œéå•ä¾‹bean\tprivate final Map&lt;Class&lt;?&gt;, String[]&gt; allBeanNamesByType = new ConcurrentHashMap&lt;&gt;(64); /** Map of singleton-only bean names, keyed by dependency type. */ //- ä»ä¾èµ–ç±»å‹åˆ°å•ä¾‹beanåç§°çš„æ˜ å°„ã€‚ç”¨äºæ ¹æ®ç±»å‹æŸ¥æ‰¾æ‰€æœ‰å•ä¾‹beanåç§°ï¼Œä¾¿äºå•ä¾‹beançš„ç®¡ç†å’ŒæŸ¥æ‰¾ã€‚\tprivate final Map&lt;Class&lt;?&gt;, String[]&gt; singletonBeanNamesByType = new ConcurrentHashMap&lt;&gt;(64); /** List of bean definition names, in registration order. */ //æŒ‰æ³¨å†Œé¡ºåºå­˜å‚¨çš„beanå®šä¹‰åç§°åˆ—è¡¨ã€‚ç»´æŠ¤beanå®šä¹‰çš„æ³¨å†Œé¡ºåºï¼Œä¾¿äºæŒ‰é¡ºåºå¤„ç†beanå®šä¹‰ã€‚\tprivate volatile List&lt;String&gt; beanDefinitionNames = new ArrayList&lt;&gt;(256); /** List of names of manually registered singletons, in registration order. */ //æŒ‰æ³¨å†Œé¡ºåºå­˜å‚¨çš„æ‰‹åŠ¨æ³¨å†Œçš„å•ä¾‹åç§°é›†åˆã€‚å­˜å‚¨é€šè¿‡æ‰‹åŠ¨æ–¹å¼æ³¨å†Œçš„å•ä¾‹beanï¼Œä¾¿äºç®¡ç†å’ŒæŸ¥æ‰¾ã€‚\tprivate volatile Set&lt;String&gt; manualSingletonNames = new LinkedHashSet&lt;&gt;(16); /** Cached array of bean definition names in case of frozen configuration. */ @Nullable private volatile String[] frozenBeanDefinitionNames; /** Whether bean definition metadata may be cached for all beans. */ private volatile boolean configurationFrozen;&#125; ä»ä»¥ä¸ŠDefaultListableBeanFactory çš„å˜é‡å¯ä»¥çœ‹å‡ºï¼Œ ç»´æŠ¤äº†å„ç§ç»´åº¦çš„beanDefinition loadBeanDefinitionsæ˜¯å°†è§£æåçš„beanå®šä¹‰æŒ‰beanåç§° -&gt; beanå®šä¹‰çš„é€»è¾‘å­˜æ”¾åˆ°beanDefinitionMapè¿™ä¸ªConcurrentHashMapä¸­ã€‚ åŒæ—¶ï¼Œä¹Ÿä¼šæ›´æ–°å…¶ä»–å‡ ä¸ªé‡è¦çš„ConcurrentHashMapï¼Œå¦‚mergedBeanDefinitionHoldersã€allBeanNamesByTypeã€singletonBeanNamesByTypeï¼Œä»¥ä¾¿äºæ›´é«˜æ•ˆçš„beanç®¡ç†å’Œä¾èµ–è§£æã€‚ loadBeanDefinitionsæ–¹æ³•ä¸ä»…ä»…æ˜¯å­˜æ”¾beanå®šä¹‰ï¼Œè¿˜åŒ…æ‹¬è§£æã€éªŒè¯å’Œæ³¨å†Œå¤šä¸ªæ­¥éª¤ã€‚ beanDefinitionNamesåˆ—è¡¨ä¹Ÿä¼šåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è¢«æ›´æ–°ï¼Œä»¥ç»´æŠ¤beanå®šä¹‰çš„æ³¨å†Œé¡ºåºã€‚ ä¸‹é¢è¿›å…¥obtainFreshBeanFactoryè¿›è¡Œåˆ†æ12345AbstractApplicationContext.javaprotected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123; refreshBeanFactory(); return getBeanFactory(); &#125; 1.1 refreshBeanFactory12345678910111213141516171819AbstractRefreshableApplicationContext.java @Override protected final void refreshBeanFactory() throws BeansException &#123; if (hasBeanFactory()) &#123; destroyBeans(); closeBeanFactory(); &#125; try &#123; // 1. åˆ›å»ºbeanFactory DefaultListableBeanFactory beanFactory = createBeanFactory(); beanFactory.setSerializationId(getId()); customizeBeanFactory(beanFactory); // 2. è¯»å–Beané…ç½®ä¿¡æ¯, å¡«å……DefaultListableBeanFactoryä¸­å˜é‡ loadBeanDefinitions(beanFactory); this.beanFactory = beanFactory; &#125; catch (IOException ex) &#123; &#125; &#125; 1.1.1 loadBeanDefinitionså…·ä½“è¿‡ç¨‹å¾…è¡¥å…… ï¼šå¯ä»¥å‚è€ƒhttps://blog.csdn.net/andy_zhang2007/article/details/85381148 1.2 getBeanFactory12345678910AbstractRefreshableApplicationContext.java @Override public final ConfigurableListableBeanFactory getBeanFactory() &#123; DefaultListableBeanFactory beanFactory = this.beanFactory; if (beanFactory == null) &#123; throw new IllegalStateException(&quot;BeanFactory not initialized or already closed - &quot; + &quot;call &#x27;refresh&#x27; before accessing beans via the ApplicationContext&quot;); &#125; return beanFactory; &#125; 2. bean çš„ç”Ÿå‘½å‘¨æœŸåœ¨ finishBeanFactoryInitialization æ–¹æ³•ä¸­ï¼Œç®¡ç†çš„bean éƒ½æ˜¯ éæ‡’åŠ è½½å•ä¾‹bean123456789AbstractApplicationContext.java@Override public void refresh() throws BeansException, IllegalStateException &#123;\t// 1. åˆ›å»ºbeanFactory ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();\t// 2. beançš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œä¾èµ–å…³ç³»çš„è£…é…\tfinishBeanFactoryInitialization(beanFactory);&#125;åœ¨Springä¸­ï¼ŒBeançš„ç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬å‡ ä¸ªé‡è¦çš„é˜¶æ®µï¼š å®ä¾‹åŒ–ï¼ˆInstantiationï¼‰ï¼š Beanè¢«åˆ›å»ºï¼Œé€šè¿‡è°ƒç”¨æ„é€ æ–¹æ³•å®ä¾‹åŒ–ã€‚ å±æ€§æ³¨å…¥ï¼ˆProperty Populationï¼‰ï¼š Springé€šè¿‡ä¾èµ–æ³¨å…¥å°†Beançš„ä¾èµ–å…³ç³»æ³¨å…¥ã€‚ åˆå§‹åŒ–ï¼ˆInitializationï¼‰ï¼š åœ¨æ‰€æœ‰å±æ€§è¢«è®¾ç½®ä¹‹åï¼ŒSpringå¯ä»¥è°ƒç”¨å®šåˆ¶çš„åˆå§‹åŒ–æ–¹æ³•ã€‚ é”€æ¯ï¼ˆDestructionï¼‰ï¼š åœ¨Springå®¹å™¨å…³é—­ä¹‹å‰ï¼Œå¯ä»¥è°ƒç”¨å®šåˆ¶çš„é”€æ¯æ–¹æ³•ã€‚ 3. ä¸‰å±‚ç¼“å­˜ æ ¹æ®ä¸Šé¢çš„æ¡†æ¶å›¾å¯çŸ¥ï¼Œ å¯ä»¥çœ‹åˆ°å®ä¾‹åŒ–åbean ä¼šæ”¾åˆ°ç¼“å­˜ä¸­ã€‚ æ—¢ç„¶ä½¿ç”¨ç¼“å­˜ï¼Œå…¶ç»å…¸ä½¿ç”¨æ–¹å¼å¿…ç„¶æ˜¯â€œæœ‰å°±ç›´æ¥è·å–ï¼Œæ²¡æœ‰å°±åˆ›å»ºå¹¶å›å¡«ç¼“å­˜â€ï¼Œ bean ç¼“å­˜çš„ä½¿ç”¨è¿‡ç¨‹ä¹Ÿä¸ä¾‹å¤–ï¼Œ åŒæ ·éµå¾ªè¿™ä¸€æµç¨‹ ä¸è¿‡åœ¨Spring ä¸­ï¼Œ è¿™ä¸ªç¼“å­˜æ¯”è¾ƒç‰¹æ®Šçš„ä¸€ç‚¹æ˜¯ç”±3å±‚æœ¬åœ°ç¼“å­˜æ„æˆã€‚ æƒ³è¦äº†è§£ä¸‰å±‚ç¼“å­˜æœºåˆ¶ï¼Œé¦–å…ˆéœ€è¦äº†è§£å„å±‚ç¼“å­˜ä¸­å­˜æ”¾çš„å…·ä½“å†…å®¹ï¼Œä¸‹é¢æ¥åˆ†æä¸€ä¸‹ 1234567891011public class DefaultSingletonBeanRegistry extends SimpleAliasRegistry implements SingletonBeanRegistry /** Cache of singleton objects: bean name to bean instance. */ private final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256); /** Cache of singleton factories: bean name to ObjectFactory. */ private final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16); /** Cache of early singleton objects: bean name to bean instance. */ private final Map&lt;String, Object&gt; earlySingletonObjects = new ConcurrentHashMap&lt;&gt;(16);&#125; singletonObjectsï¼šå­˜æ”¾initå®Œæˆçš„å•ä¾‹beanï¼Œ æ­¤æ—¶çš„beanæ˜¯æˆç†Ÿå®Œæ•´ã€‚ earlySingletonObjectsï¼šå­˜å‚¨ç”±singletonFactoriesåˆ›å»ºçš„æ—©æœŸå¼•ç”¨,å³æå‰æš´éœ²çš„å¯¹è±¡ï¼ˆå·²ç»å®Œæˆinstantiationï¼Œä½†æ˜¯è¿˜æ²¡æœ‰populate ã€initï¼‰ã€‚ singletonFactoriesï¼šå­˜å‚¨ç”¨äºç”Ÿæˆæ—©æœŸå•ä¾‹beanå¼•ç”¨çš„å·¥å‚å¯¹è±¡ã€‚å½“ä¸€ä¸ªå•ä¾‹beanæ­£åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œè¿˜æ²¡æœ‰å®Œæˆinit é˜¶æ®µæ˜¯æ—¶ï¼ˆæ¯”å¦‚è¿˜æ²¡æœ‰æ³¨å…¥ä¾èµ–ï¼‰ï¼Œå°±ä¼šæš‚æ—¶å­˜å…¥è¿™ä¸ªç¼“å­˜ã€‚ earlySingletonObjects å’ŒsingletonFactories ä¸€èµ·å®Œæˆbean æ—©æœŸå¼•ç”¨çš„ç®¡ç†ï¼Œ æ—©æœŸå¼•ç”¨æ˜¯ä¸ºäº†è§£å†³bean çš„å¾ªç¯ä¾èµ–singletonObjectsã€earlySingletonObjectsä¸­çš„value æ˜¯Objectï¼Œå­˜æ”¾çš„ä¹Ÿå°±æ˜¯å®Œæ•´bean å¼•ç”¨ï¼Œå’Œæ—©æœŸbean å¼•ç”¨ã€‚ä¸‹é¢é‡ç‚¹åˆ†ææ¯”è¾ƒé™Œç”Ÿçš„singletonFactoriesã€‚ 3.1 å‡½æ•°å¼æ¥å£ ObjectFactoryè¦æƒ³singletonFactories å­˜æ”¾çš„å†…å®¹ï¼Œéœ€è¦å…ˆäº†è§£å‡½æ•°å¼æ¥å£ObjectFactory Java 8å¼•å…¥çš„å‡½æ•°å¼æ¥å£ï¼ˆFunctional Interfaceï¼‰æ¦‚å¿µï¼Œæ˜¯æŒ‡ä»…æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„æ¥å£ï¼ˆé™¤äº†Objectç±»çš„å…¬æœ‰æ–¹æ³•å¤–ï¼‰ã€‚è¿™ç§æ¥å£å…è®¸è¢«éšå¼è½¬æ¢ä¸ºLambdaè¡¨è¾¾å¼ã€‚java.lang.FunctionalInterfaceæ³¨è§£ç”¨äºæ ‡è®°ä¸€ä¸ªæ¥å£æ˜¯å‡½æ•°å¼æ¥å£ï¼Œè¿™ä¸ªæ³¨è§£ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†å®ƒå¯ä»¥å¸®åŠ©å¼€å‘è€…å’Œç¼–è¯‘å™¨éªŒè¯æ¥å£æ˜¯å¦æ»¡è¶³å‡½æ•°å¼æ¥å£çš„æ¡ä»¶ã€‚ Lambdaè¡¨è¾¾å¼å¯ä»¥ç”¨æ¥ç®€æ´åœ° implements å‡½æ•°å¼æ¥å£ã€‚ åœ¨è§£å†³å¾ªç¯ä¾èµ–æ—¶ç”¨åˆ°çš„singletonFactoriesï¼Œ å…¶value å°±æ˜¯ ObjectFactory12345@FunctionalInterface public interface ObjectFactory&lt;T&gt; &#123; T getObject() throws BeansException; &#125; 4.éæ‡’åŠ è½½çš„å•ä¾‹bean-getBeanSpring IOC å®¹å™¨ç°åœ¨æœ‰äº†bean çš„å®šä¹‰ä¿¡æ¯ï¼Œå°±å¯ä»¥æ­£å¼å¼€å§‹beançš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œä¾èµ–å…³ç³»çš„è£…é…äº†ã€‚ å®ä¾‹åŒ–beançš„å…¥å£å°±åœ¨å‰é¢æåˆ°çš„DefaultListableBeanFactoryä¸­ï¼Œ æ ¹æ®bean åç§°å¾ªç¯è·å–bean å®ä¾‹ ä»doGetBeançš„é€»è¾‘ä¸­å¯ä»¥çœ‹åˆ°å„ç§ä½œç”¨åŸŸçš„bean å…¶å®éƒ½åœ¨è¿™ä¸ªæ–¹æ³•ä¸­åˆ›å»ºï¼Œä¾‹å¦‚singleton(å•ä¾‹) ã€prototypeï¼ˆæ¯æ¬¡éƒ½åˆ›å»ºæ–°å®ä¾‹ï¼‰ï¼Œ å¹³æ—¶æˆ‘ä»¬ç»å¸¸æåˆ°çš„ä¸‰å±‚ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–ï¼Œå…¶å®æŒ‡çš„éƒ½æ˜¯éæ‡’åŠ è½½çš„å•ä¾‹bean ,ä½œç”¨åŸŸæ˜¯prototype çš„bean æ˜¯æ— æ³•ç”¨è¿™ç§æ–¹å¼è§£å†³å¾ªç¯ä¾èµ–çš„ã€‚çœ‹ä¸‹é¢çš„ä»£ç ï¼Œç”±äºä½œç”¨åŸŸæ˜¯prototype çš„bean å¹¶ä¸éœ€è¦ä¸‰å±‚ç¼“å­˜çš„å‚ä¸ï¼Œæ‰€ä»¥å°‘äº†å¯¹äºä¸‰å±‚ç¼“å­˜çš„ç®¡ç†ï¼Œ è°ƒç”¨è°ƒç ”åŒä¸€ä¸ªcreateBean åˆ›å»ºæ–°çš„å®ä¾‹ã€‚ æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬é‡ç‚¹è®²è§£å•ä¾‹bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œ å…¶ä»–ä½œç”¨åŸŸçš„bean è‡ªç„¶å°±æ‡‚äº†ã€‚ 123456789101112DefaultListableBeanFactory.java@Override public void preInstantiateSingletons() throws BeansException &#123;\tList&lt;String&gt; beanNames = new ArrayList&lt;&gt;(this.beanDefinitionNames);\tfor (String beanName : beanNames) &#123; if (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123; getBean(beanName); &#125;\t&#125;\t&#125; ä»¥ä¸‹çœç•¥äº†éƒ¨åˆ†ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114AbstractBeanFactory.javapublic Object getBean(String name) throws BeansException &#123; return doGetBean(name, null, null, false); &#125;protected &lt;T&gt; T doGetBean( String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object[] args, boolean typeCheckOnly) throws BeansException &#123; String beanName = transformedBeanName(name); Object bean; // å¯¹äºä¸€ä¸ªbean èµ°åˆ°è¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µ 1. bean çš„æ­£å¸¸åˆ›å»ºæµç¨‹ 2. å¾ªç¯ä¾èµ–çš„æƒ…å†µ // é’ˆå¯¹ bean çš„æ­£å¸¸åˆ›å»ºæµç¨‹ï¼Œ getSingleton çš„è¿”å›æ˜¯null // é’ˆå¯¹å¾ªç¯ä¾èµ–è§¦å‘çš„bean è·å–ï¼Œé€šè¿‡getSingletonå¯ä»¥è·å–åˆ°ç”±ä¸‰çº§ç¼“å­˜ç”Ÿæˆçš„äºŒçº§ç¼“å­˜ï¼Œæ—©æœŸå¼•ç”¨ï¼Œä»è€Œè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ã€‚ // å…ˆå°è¯•ä»ç¼“å­˜ä¸­è·å– Object sharedInstance = getSingleton(beanName); if (sharedInstance != null &amp;&amp; args == null) &#123; // ç¼“å­˜ä¸­å­˜åœ¨åˆ™ç›´æ¥è¿”å› bean = getObjectForBeanInstance(sharedInstance, name, beanName, null); &#125; else &#123; try &#123; RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); checkMergedBeanDefinition(mbd, beanName, args); // Guarantee initialization of beans that the current bean depends on. // åœ¨åˆ›å»ºæŸä¸ª Bean ä¹‹å‰ï¼Œå¿…é¡»å…ˆç¡®ä¿å®ƒæ‰€ä¾èµ–çš„æ‰€æœ‰å…¶ä»–Bean éƒ½å·²ç»åˆ›å»ºå¹¶åˆå§‹åŒ–ã€‚ String[] dependsOn = mbd.getDependsOn(); if (dependsOn != null) &#123; for (String dep : dependsOn) &#123; if (isDependent(beanName, dep)) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Circular depends-on relationship between &#x27;&quot; + beanName + &quot;&#x27; and &#x27;&quot; + dep + &quot;&#x27;&quot;); &#125; // æ³¨å†Œæ‰€æœ‰ä¾èµ–äºå½“å‰bean çš„bean ä¿¡æ¯ // è¯¥ä¿¡æ¯ä½¿ç”¨ Map&lt;String, Set&lt;String&gt;&gt; dependentBeanMap è®°å½• registerDependentBean(dep, beanName); try &#123; getBean(dep); &#125; catch (NoSuchBeanDefinitionException ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;&#x27;&quot; + beanName + &quot;&#x27; depends on missing bean &#x27;&quot; + dep + &quot;&#x27;&quot;, ex); &#125; &#125; &#125; // å•ä¾‹beançš„åˆ›å»ºï¼Œç¼“å­˜ä¸­æ²¡æœ‰åˆ™éœ€è¦åˆ›å»ºå¹¶å›å†™ç¼“å­˜ if (mbd.isSingleton()) &#123; // sharedInstance = getSingleton(beanName, () -&gt; &#123; try &#123; return createBean(beanName, mbd, args); &#125; catch (BeansException ex) &#123; destroySingleton(beanName); throw ex; &#125; &#125;); bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd); &#125; // Prototype æ˜¯ä½œç”¨åŸŸï¼Œä»£è¡¨æ¯æ¬¡è°ƒç”¨getBeanä»å®¹å™¨ä¸­è·å–å¯¹è±¡æ—¶ï¼Œéƒ½è¿”å›ä¸€ä¸ªæ–°çš„å®ä¾‹ // æ‰€ä»¥ å¯¹äºPrototypeä½œç”¨åŸŸï¼Œä¸ä¼šèµ°getSingleton ä½¿ç”¨3å±‚ç¼“å­˜çš„é€»è¾‘ï¼Œ ç›´æ¥è°ƒç”¨createBean ç”Ÿæˆæ–°çš„å®ä¾‹å³å¯ else if (mbd.isPrototype()) &#123; // It&#x27;s a prototype -&gt; create a new instance. Object prototypeInstance = null; try &#123; beforePrototypeCreation(beanName); prototypeInstance = createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd); &#125; else &#123; String scopeName = mbd.getScope(); if (!StringUtils.hasLength(scopeName)) &#123; throw new IllegalStateException(&quot;No scope name defined for bean Â´&quot; + beanName + &quot;&#x27;&quot;); &#125; Scope scope = this.scopes.get(scopeName); if (scope == null) &#123; throw new IllegalStateException(&quot;No Scope registered for scope name &#x27;&quot; + scopeName + &quot;&#x27;&quot;); &#125; try &#123; Object scopedInstance = scope.get(beanName, () -&gt; &#123; beforePrototypeCreation(beanName); try &#123; return createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; &#125;); bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd); &#125; catch (IllegalStateException ex) &#123; throw new BeanCreationException(beanName, &quot;Scope &#x27;&quot; + scopeName + &quot;&#x27; is not active for the current thread; consider &quot; + &quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;, ex); &#125; &#125; &#125; catch (BeansException ex) &#123; cleanupAfterBeanCreationFailure(beanName); throw ex; &#125; &#125; return (T) bean;\t&#125; å‡½æ•°getSingletonæœ‰å¤šä¸ªé‡è½½ç‰ˆæœ¬ï¼Œ åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­å°±æ¶‰åŠåˆ°2ä¸ª12345public Object getSingleton(String beanName) &#123; &#125;public Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123;&#125; 5. ä»ç¼“å­˜ä¸­è·å–bean-getSingletongetSingleton(String beanName) çš„ä½œç”¨æ˜¯ä»ç¼“å­˜ä¸­è·å–bean, å…¶å…·ä½“é€»è¾‘è¿˜æ¶‰åŠåˆ°getSingletonçš„ç¬¬3ä¸ªé‡è½½ç‰ˆæœ¬ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ 5.1 ç¼“å­˜ç®¡ç†123456789101112131415161718192021222324252627282930313233343536373839ä»£ç å‡åœ¨ DefaultSingletonBeanRegistry.java public Object getSingleton(String beanName) &#123; return getSingleton(beanName, true); &#125;@Nullable protected Object getSingleton(String beanName, boolean allowEarlyReference) &#123; // Quick check for existing instance without full singleton lock // é¦–å…ˆä» singletonObjectsï¼ˆå•ä¾‹ç¼“å­˜ï¼‰ä¸­å¿«é€Ÿè·å– Bean å®ä¾‹ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿”å›ã€‚ Object singletonObject = this.singletonObjects.get(beanName); // å¦‚æœåˆæ­¥æ£€æŸ¥æ²¡æœ‰æ‰¾åˆ°å®ä¾‹ï¼Œå¹¶ä¸”è¯¥å•ä¾‹å½“å‰æ­£åœ¨åˆ›å»ºä¸­ï¼Œåˆ™ä» earlySingletonObjectsï¼ˆæ—©æœŸå•ä¾‹ç¼“å­˜ï¼‰ä¸­æŸ¥æ‰¾ã€‚ if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123; singletonObject = this.earlySingletonObjects.get(beanName); if (singletonObject == null &amp;&amp; allowEarlyReference) &#123; //å¦‚æœä»æœªæ‰¾åˆ°å®ä¾‹ï¼Œå¹¶ä¸”å…è®¸æ—©æœŸå¼•ç”¨ï¼Œåˆ™è¿›å…¥åŒæ­¥å—ã€‚ //åœ¨åŒæ­¥å—å†…ï¼Œå†æ¬¡ä» singletonObjects å’Œ earlySingletonObjects ä¸­æ£€æŸ¥å®ä¾‹ã€‚ // è¿™æ˜¯ä¸ºäº†é¿å…åœ¨è¿›å…¥åŒæ­¥å—çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å…¶ä»–çº¿ç¨‹å·²ç»åˆ›å»ºäº†è¯¥å•ä¾‹å®ä¾‹ã€‚ synchronized (this.singletonObjects) &#123; // Consistent creation of early reference within full singleton lock singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null) &#123; singletonObject = this.earlySingletonObjects.get(beanName); if (singletonObject == null) &#123; ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName); //å¦‚æœä»æœªæ‰¾åˆ°å®ä¾‹ï¼Œåˆ™å°è¯•ä» singletonFactories ä¸­è·å–å•ä¾‹å·¥å‚ï¼Œ // å¹¶singletonFactoryåˆ›å»ºæ—©æœŸå¼•ç”¨ï¼Œå°†å…¶æ”¾å…¥ earlySingletonObjects ä¸­ï¼Œå¹¶ä» singletonFactories ä¸­ç§»é™¤ã€‚ if (singletonFactory != null) &#123; singletonObject = singletonFactory.getObject(); this.earlySingletonObjects.put(beanName, singletonObject); this.singletonFactories.remove(beanName); &#125; &#125; &#125; &#125; &#125; &#125; return singletonObject; &#125; 5.2 åŒé‡æ ¡éªŒé”åœ¨ç”¨java å®ç°å•ä¾‹æ¨¡å¼æ—¶ï¼Œä¸€ç§ç»å…¸çš„æ–¹å¼æ˜¯ï¼Œ åŒæ£€é”/åŒé‡æ ¡éªŒé”ï¼ˆDCLï¼Œå³ double-checked lockingï¼‰ ç¬¬ä¸€ä¸ªæ£€æŸ¥åœ¨è¿›å…¥åŒæ­¥å—ä¹‹å‰ï¼Œé¿å…äº†ä¸å¿…è¦çš„åŒæ­¥ã€‚ ç¬¬äºŒä¸ªæ£€æŸ¥åœ¨è¿›å…¥åŒæ­¥å—ä¹‹åï¼Œç¡®ä¿å®ä¾‹åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­æ­£ç¡®åˆå§‹åŒ–ã€‚ 123456789101112131415public class Singleton &#123; private static volatile Singleton instance; public static Singleton getInstance() &#123; if (instance == null) &#123; synchronized (Singleton.class) &#123; if (instance == null) &#123; instance = new Singleton(); &#125; &#125; &#125; return instance; &#125;&#125; åœ¨è¿™ä¸ªObject getSingleton(String beanName, boolean allowEarlyReference)æ–¹æ³•ä¸­ï¼ŒåŒæ ·ä½¿ç”¨äº† åŒé‡æ ¡éªŒé”æœºåˆ¶ï¼Œä½†å®ƒåŒ…å«æ›´å¤šçš„é€»è¾‘ä»¥å¤„ç† Spring æ¡†æ¶ä¸­çš„å…·ä½“éœ€æ±‚ï¼Œç‰¹åˆ«æ˜¯æ—©æœŸå•ä¾‹å¼•ç”¨å’Œå•ä¾‹å·¥å‚çš„å¤„ç†ã€‚ä¸¥æ ¼æ¥è¯´ï¼Œå®ƒä¸å®Œå…¨æ˜¯ç»å…¸çš„åŒé‡æ ¡éªŒé”æ¨¡å¼ï¼Œä½†å…¶æ€æƒ³æ˜¯ä¸€è‡´çš„ï¼Œå³é€šè¿‡ä¸¤æ¬¡æ£€æŸ¥ï¼ˆä¸€æ¬¡åœ¨åŒæ­¥å—å¤–ï¼Œä¸€æ¬¡åœ¨åŒæ­¥å—å†…ï¼‰æ¥ä¼˜åŒ–æ€§èƒ½å¹¶ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚ è¿™ç§è®¾è®¡åœ¨ Spring æ¡†æ¶ä¸­ç”¨äºç¡®ä¿ Bean çš„åˆ›å»ºæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒåŒæ—¶å°½å¯èƒ½å‡å°‘åŒæ­¥å¼€é”€ï¼Œä»¥æé«˜æ€§èƒ½ã€‚ 6.ç¼“å­˜ä¸­ä¸å­˜åœ¨åˆ™åˆ›å»º-getSingletonæ¥çœ‹doGetBean æ–¹æ³•ä¸­ï¼Œç¬¬2ä¸ªgetSingleton æ–¹æ³• 1234567891011121314151617181920212223protected &lt;T&gt; T doGetBean( String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object[] args, boolean typeCheckOnly) throws BeansException &#123; // ç¬¬ä¸€ä¸ªgetSingletonï¼šå°è¯•ä»ç¼“å­˜ä¸­è·å–\tObject sharedInstance = getSingleton(beanName); if (sharedInstance != null &amp;&amp; args == null) &#123; // ç¼“å­˜ä¸­å­˜åœ¨åˆ™ç›´æ¥è¿”å› bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);\t&#125;else&#123; // ç¬¬2ä¸ªgetSingletonï¼šç¼“å­˜ä¸­æ²¡æœ‰åˆ™éœ€è¦åˆ›å»ºå¹¶å›å†™ç¼“å­˜ sharedInstance = getSingleton(beanName, () -&gt; &#123; try &#123; return createBean(beanName, mbd, args); &#125;catch (BeansException ex) &#123; destroySingleton(beanName); throw ex; &#125; &#125;); bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);\t&#125;\treturn bean;&#125; 6.1 ObjectFactory çš„åŒ¿åç±»å®ç°-createBeanæŸ¥çœ‹è¿™ä¸ªgetSingletonæ–¹æ³•çš„å®Œæ•´å®šä¹‰ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ªå‚æ•°æ˜¯å‰é¢æåˆ°çš„å‡½æ•°å¼æ¥å£ObjectFactoryï¼Œ1public Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123;&#125; åœ¨ç¼“å­˜ä¸­ä¸å­˜åœ¨å°è¯•å»åˆ›å»ºbeanå®ä¾‹çš„é€»è¾‘ä¸­ï¼Œ ä¼ å…¥çš„å‚æ•°å¦‚ä¸‹ 1234567891011 // 2. å¦‚æœä¸€çº§ç¼“å­˜æ²¡æœ‰è·å–åˆ°ï¼Œ åˆ™ä½¿ç”¨å¦ä¸€ä¸ªgetSingleton é‡è½½å‡½æ•°ï¼Œå»åˆ›å»ºbean// è¿™é‡Œä¼ å…¥äº†ä¸€ä¸ªObjectFactoryçš„åŒ¿åå®ç°ç±»ï¼Œé‡Œé¢æ˜¯bean åˆ›å»ºçš„çœŸæ­£é€»è¾‘\tsharedInstance = getSingleton(beanName, () -&gt; &#123;\ttry &#123; return createBean(beanName, mbd, args);\t&#125;\tcatch (BeansException ex) &#123; destroySingleton(beanName); throw ex;\t&#125;&#125;); å¯ä»¥çœ‹åˆ°åœ¨ä¼ å…¥getSingletonçš„ç¬¬äºŒä¸ªå‚æ•°æ—¶ï¼Œä½¿ç”¨lambdaè¡¨è¾¾å¼ä¼ å…¥äº†ä¸€ä¸ªåŒ¿åç±»å®ç°ï¼Œè¯¥åŒ¿åç±»ä¸­çš„createBean åŒ…å«äº†å®ä¾‹åŒ–bean çš„é€»è¾‘ Javaç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å°†è¿™ä¸ªLambdaè¡¨è¾¾å¼è½¬æ¢æˆObjectFactoryæ¥å£çš„ä¸€ä¸ªåŒ¿åå®ç°ç±»ã€‚è¿™ä¸ªè¿‡ç¨‹å®Œå…¨æ˜¯è‡ªåŠ¨çš„ï¼ŒèƒŒåçš„è½¬æ¢å¯¹å¼€å‘è€…æ¥è¯´æ˜¯é€æ˜çš„ã€‚ è¿›å…¥è¯¥é‡è½½ç‰ˆæœ¬çœ‹ä¸€ä¸‹å…·ä½“é€»è¾‘ 123456789101112131415161718192021222324DefaultListableBeanFactory.javapublic Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123; //åŠ é”åŒæ­¥å— synchronized (this.singletonObjects) &#123; // ä»ä¸€çº§ç¼“å­˜ä¸­å°è¯•è·å–beanå®ä¾‹ Object singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null) &#123; //åˆ¤æ–­è¯¥bean æ˜¯å¦æ­£åœ¨åˆ›å»º //å¦‚æœå·²ç»æ­£åœ¨åˆ›å»ºäº†ï¼Œæ­¤æ¬¡åˆ›å»ºåŠ¨ä½œè¦æŠ¥é”™ beforeSingletonCreation(beanName); // è°ƒç”¨ObjectFactory.getObjectä¼šèµ°åˆ°ä¸Šé¢åŒ¿åç±»çš„å®ç°é€»è¾‘ï¼Œ å³ä¼šèµ°åˆ°createBeané€»è¾‘ singletonObject = singletonFactory.getObject(); newSingleton = true; if (newSingleton) &#123; // initå®Œæˆçš„beanï¼Œ æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜ï¼Œå¹¶ä»äºŒä¸‰çº§ç¼“å­˜ä¸­åˆ é™¤ addSingleton(beanName, singletonObject); &#125; //beanåˆ›å»ºå®Œæˆï¼Œä»singletonsCurrentlyInCreationåˆ é™¤ afterSingletonCreation(beanName); &#125; return singletonObject; &#125;\t&#125; 1singletonObject = singletonFactory.getObject(); å½“è¯¥getSingleton é€»è¾‘èµ°åˆ° ObjectFactory.getObjectæ—¶ï¼Œå®é™…ä¼šè°ƒç”¨åˆ°ä¼šèµ°åˆ°ä¸Šé¢åŒ¿åç±»çš„å®ç°é€»è¾‘ï¼Œ å³ä¼šèµ°åˆ°createBeané€»è¾‘, å³åœ¨getBean æ–¹æ³•ä¸­çš„åŒ¿åç±» 12345678sharedInstance = getSingleton(beanName, () -&gt; &#123; try &#123; return createBean(beanName, mbd, args); &#125;catch (BeansException ex) &#123; destroySingleton(beanName); throw ex; &#125; &#125;); è¿›å…¥createBeançœ‹ä¸€ä¸‹å…·ä½“é€»è¾‘ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122AbstractAutowireCapableBeanFactory.java protected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)&#123; Object beanInstance = doCreateBean(beanName, mbdToUse, args);&#125;protected Object doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException &#123; // Instantiate the bean. BeanWrapper instanceWrapper = null; if (mbd.isSingleton()) &#123; instanceWrapper = this.factoryBeanInstanceCache.remove(beanName); &#125; if (instanceWrapper == null) &#123; instanceWrapper = createBeanInstance(beanName, mbd, args); &#125; Object bean = instanceWrapper.getWrappedInstance(); Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass(); if (beanType != NullBean.class) &#123; mbd.resolvedTargetType = beanType; &#125; // Allow post-processors to modify the merged bean definition. //æ£€æŸ¥æ˜¯å¦å·²ç»å¯¹ Bean å®šä¹‰è¿›è¡Œäº†åå¤„ç†ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è°ƒç”¨ applyMergedBeanDefinitionPostProcessors æ–¹æ³•åº”ç”¨åå¤„ç†å™¨ã€‚ synchronized (mbd.postProcessingLock) &#123; if (!mbd.postProcessed) &#123; try &#123; applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Post-processing of merged bean definition failed&quot;, ex); &#125; mbd.postProcessed = true; &#125; &#125; // Eagerly cache singletons to be able to resolve circular references // even when triggered by lifecycle interfaces like BeanFactoryAware. boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName)); //å¦‚æœå…è®¸å¾ªç¯å¼•ç”¨ï¼Œå¹¶ä¸”å½“å‰ Bean æ˜¯å•ä¾‹ï¼Œåˆ™è°ƒç”¨ addSingletonFactory æ–¹æ³•ï¼Œæä¾›ä¸€ä¸ªå›è°ƒä»¥è·å–æ—©æœŸ Bean å¼•ç”¨ã€‚ if (earlySingletonExposure) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(&quot;Eagerly caching bean &#x27;&quot; + beanName + &quot;&#x27; to allow for resolving potential circular references&quot;); &#125; // æ·»åŠ ç¬¬3çº§ç¼“å­˜ï¼Œ æ­¤å¤„ç¬¬äºŒä¸ªå‚æ•°åˆæ˜¯ä¸€ä¸ªObjectFactoryçš„åŒ¿åç±»å®ç° addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean)); &#125; // Initialize the bean instance. Object exposedObject = bean; try &#123; populateBean(beanName, mbd, instanceWrapper); exposedObject = initializeBean(beanName, exposedObject, mbd); &#125; catch (Throwable ex) &#123; if (ex instanceof BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123; throw (BeanCreationException) ex; &#125; else &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Initialization of bean failed&quot;, ex); &#125; &#125; // éªŒè¯å¾ªç¯å¼•ç”¨çš„å¤„ç†è¿‡ç¨‹æ˜¯å¦æ­£ç¡® if (earlySingletonExposure) &#123; // å°è¯•è·å–æ—©æœŸå¼•ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—©æœŸå¼•ç”¨è‚¯å®šæ˜¯å› ä¸ºå¾ªç¯ä¾èµ–ï¼Œå…¶ä»–beanåœ¨getSingleton(beanName, true)ç”Ÿäº§å‡ºæ¥çš„ // å› ä¸ºè¯¥bean è‡ªå·±çš„ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œåªä¼šä¸»åŠ¨æ·»åŠ ä¸€çº§ã€ä¸‰çº§ç¼“å­˜ Object earlySingletonReference = getSingleton(beanName, false); if (earlySingletonReference != null) &#123; // è¡¨ç¤ºinitåï¼ŒBeanå®ä¾‹æœªè¢«ä»£ç†,åœ¨æœªä»£ç†çš„æƒ…å†µä¸‹ï¼ŒexposedObject å’Œ bean æ˜¯ç›¸åŒçš„å¼•ç”¨ // åŒæ—¶åœ¨ç†è®ºä¸Šï¼ŒgetSingleton(beanName, false)è·å–åˆ°çš„åº”è¯¥ä¹Ÿæ˜¯ç›¸åŒçš„å¼•ç”¨ã€‚ if (exposedObject == bean) &#123; // å¦‚æœå­˜åœ¨æ—©æœŸæš´éœ²çš„å•ä¾‹å¼•ç”¨ï¼Œå¹¶ä¸”exposedObjectæœªè¢«ä»£ç†ï¼Œå°†exposedObjectæ›¿æ¢ä¸ºæ—©æœŸæš´éœ²çš„å•ä¾‹å¼•ç”¨ã€‚ // ç†è®ºä¸Šä¸å­˜åœ¨ä»£ç†æ—¶ï¼ŒearlySingletonReference bean exposedObject ä¸‰è€…åº”è¯¥æ˜¯ç›¸åŒçš„ // exposedObject = earlySingletonReferenceè¿™ä¸€èµ‹å€¼æ“ä½œå³ä½¿åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹çœ‹ä¼¼å¤šä½™ï¼Œ // ä½†å®ƒç¡®ä¿äº†æ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹çš„ä¸€è‡´æ€§ï¼Œå°¤å…¶åœ¨å¤„ç†ä»£ç†å¯¹è±¡å’Œå¾ªç¯ä¾èµ–é—®é¢˜æ—¶ï¼Œä¿è¯äº†æœ€ç»ˆæš´éœ²çš„Beanå®ä¾‹æ˜¯æ­£ç¡®çš„ã€‚ // è¿™ç§è®¾è®¡æé«˜äº†ä»£ç çš„å¥å£®æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œç¡®ä¿äº†åœ¨å„ç§å¤æ‚åœºæ™¯ä¸‹çš„æ­£ç¡®æ€§ã€‚ exposedObject = earlySingletonReference; &#125; // å­˜åœ¨ä»£ç†æ“ä½œæ—¶ï¼Œè¦ç¡®ä¿ä¾èµ–å½“å‰bean çš„å…¶ä»–bean å¼•ç”¨åˆ°äº†æ­£ç¡®çš„ç‰ˆæœ¬ else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123; // è·å–æ‰€æœ‰ä¾èµ–å½“å‰Beançš„Beanåç§°ã€‚ String[] dependentBeans = getDependentBeans(beanName); Set&lt;String&gt; actualDependentBeans = new LinkedHashSet&lt;&gt;(dependentBeans.length); for (String dependentBean : dependentBeans) &#123; // å°è¯•ç§»é™¤åªä¸ºç±»å‹æ£€æŸ¥è€Œåˆ›å»ºçš„å•ä¾‹Beanã€‚å¦‚æœæˆåŠŸç§»é™¤ï¼Œè¡¨ç¤ºè¿™ä¸ªBeanåªæ˜¯ä¸ºç±»å‹æ£€æŸ¥è€Œåˆ›å»ºçš„ï¼Œä¸æ˜¯å®é™…ä½¿ç”¨çš„Beanã€‚ // é€šè¿‡è¿™ä¸ªå¾ªç¯ï¼ŒSpringä¼šè¿‡æ»¤æ‰é‚£äº›åªä¸ºç±»å‹æ£€æŸ¥è€Œåˆ›å»ºçš„Beanï¼Œä¿ç•™é‚£äº›å®é™…ä¾èµ–å½“å‰Beançš„Beanã€‚ if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123; actualDependentBeans.add(dependentBean); &#125; &#125; if (!actualDependentBeans.isEmpty()) &#123; // è¿™æ®µé€»è¾‘ç¡®ä¿åœ¨å¤„ç†å¾ªç¯ä¾èµ–æ—¶ï¼Œç¡®ä¿ä¾èµ–çš„Beanä½¿ç”¨çš„æ˜¯æœ€ç»ˆç‰ˆæœ¬çš„Beanï¼Œè€Œä¸æ˜¯ä¸­é—´çŠ¶æ€çš„åŸå§‹Beanã€‚ // å¦‚æœå­˜åœ¨å®é™…ä¾èµ–å½“å‰Beançš„Beanã€‚æŠ›å‡ºBeanCurrentlyInCreationExceptionå¼‚å¸¸ // å› ä¸ºè¿™æ„å‘³ç€æœ‰Beanåœ¨å¾ªç¯ä¾èµ–çš„è¿‡ç¨‹ä¸­ä½¿ç”¨äº†å½“å‰Beançš„åŸå§‹ç‰ˆæœ¬ï¼Œä½†æœ€ç»ˆå½“å‰Beanè¢«åŒ…è£…ï¼ˆå¦‚è¢«AOPä»£ç†ï¼‰ã€‚ // è¿™æ„å‘³ç€è¢«ä¾èµ–çš„Beanä½¿ç”¨çš„ä¸æ˜¯æœ€ç»ˆç‰ˆæœ¬çš„Beanï¼Œè¿™å¯èƒ½å¯¼è‡´ä¸€äº›é—®é¢˜ã€‚ throw new BeanCurrentlyInCreationException(beanName, &quot;Bean with name &#x27;&quot; + beanName + &quot;&#x27; has been injected into other beans [&quot; + StringUtils.collectionToCommaDelimitedString(actualDependentBeans) + &quot;] in its raw version as part of a circular reference, but has eventually been &quot; + &quot;wrapped. This means that said other beans do not use the final version of the &quot; + &quot;bean. This is often the result of over-eager type matching - consider using &quot; + &quot;&#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;); &#125; &#125; &#125; &#125; // Register bean as disposable. // å°†ä¸€ä¸ªBeanæ³¨å†Œä¸ºå¯é”€æ¯çš„ï¼ˆdisposableï¼‰ try &#123; registerDisposableBeanIfNecessary(beanName, bean, mbd); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Invalid destruction signature&quot;, ex); &#125; return exposedObject;\t&#125; 6.2 doCreateBean-createBeanInstanceä½¿ç”¨åå°„åˆ›å»ºbean å®ä¾‹,æ•´ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š è·å–ç±»çš„ Class å¯¹è±¡å®ä¾‹ æ ¹æ® Class å¯¹è±¡å®ä¾‹è·å– Constructor å¯¹è±¡ï¼Œ è¿™é‡Œé»˜è®¤ä½¿ç”¨æ— å‚æ„é€ å‡½æ•°ï¼Œ ç­‰å¾…åé¢çš„populate å¡«å……å±æ€§ ä½¿ç”¨ Constructor å¯¹è±¡çš„ newInstance æ–¹æ³•è·å–åå°„ç±»å¯¹è±¡1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768protected BeanWrapper createBeanInstance(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) &#123;\t// Make sure bean class is actually resolved at this point.\t// è·å–bean çš„Class å¯¹è±¡ï¼ŒClassæ˜¯é€šè¿‡åå°„åˆ›å»ºbean çš„åŸºç¡€\tClass&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);\t// æ£€æŸ¥ Bean ç±»æ˜¯å¦ä¸º publicï¼Œå¦‚æœä¸æ˜¯ä¸”ä¸å…è®¸é public è®¿é—®ï¼Œåˆ™æŠ›å‡º BeanCreationException å¼‚å¸¸ã€‚\tif (beanClass != null &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Bean class isn&#x27;t public, and non-public access not allowed: &quot; + beanClass.getName());\t&#125;\t// å¦‚æœ mbd é…ç½®äº†ä¸€ä¸ªå®ä¾‹æä¾›è€…ï¼ˆSupplierï¼‰ï¼Œåˆ™é€šè¿‡è¯¥Supplieråˆ›å»º Bean å®ä¾‹ã€‚\tSupplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();\tif (instanceSupplier != null) &#123; return obtainFromSupplier(instanceSupplier, beanName);\t&#125;\t// å¦‚æœé…ç½®äº†å·¥å‚æ–¹æ³•åï¼Œåˆ™é€šè¿‡å·¥å‚æ–¹æ³•åˆ›å»º Bean å®ä¾‹ã€‚\tif (mbd.getFactoryMethodName() != null) &#123; return instantiateUsingFactoryMethod(beanName, mbd, args);\t&#125;\t// Shortcut when re-creating the same bean...\t// æ ‡å¿—æ˜¯å¦å·²ç»è§£æäº†æ„é€ å‡½æ•°æˆ–å·¥å‚æ–¹æ³•ã€‚\tboolean resolved = false;\t//æ ‡å¿—æ˜¯å¦éœ€è¦è‡ªåŠ¨è£…é…ï¼Œ å³beanä¹‹é—´æ˜¯å¦æœ‰ä¾èµ–å…³ç³»\tboolean autowireNecessary = false;\t// åªæœ‰åœ¨æ²¡æœ‰ä¼ é€’æ„é€ å‡½æ•°å‚æ•°çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šè¿›è¡Œç¼“å­˜æ£€æŸ¥ã€‚è¿™æ˜¯å› ä¸ºå¦‚æœæœ‰å‚æ•°ä¼ å…¥ï¼Œå¿…ç„¶éœ€è¦é‡æ–°è§£ææ„é€ å‡½æ•°ã€‚\tif (args == null) &#123; //è¿›å…¥åŒæ­¥å—ï¼Œç¡®ä¿å¯¹ mbd çš„æ£€æŸ¥å’Œä¿®æ”¹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ synchronized (mbd.constructorArgumentLock) &#123; //æ£€æŸ¥ resolvedConstructorOrFactoryMethod æ˜¯å¦å·²ç»è¢«è§£æå¹¶ç¼“å­˜ã€‚ if (mbd.resolvedConstructorOrFactoryMethod != null) &#123; resolved = true; autowireNecessary = mbd.constructorArgumentsResolved; &#125; &#125;\t&#125;\t//å¦‚æœ resolved ä¸º trueï¼Œåˆ™è¡¨ç¤ºå·²ç»æœ‰ç¼“å­˜çš„æ„é€ å‡½æ•°\tif (resolved) &#123; //æ ¹æ® autowireNecessary çš„å€¼å†³å®šä½¿ç”¨å“ªç§æ–¹å¼åˆ›å»º Bean å®ä¾‹ //å¦‚æœéœ€è¦è‡ªåŠ¨è£…é…ï¼ˆautowireNecessary ä¸º trueï¼‰ï¼Œåˆ™è°ƒç”¨ autowireConstructor æ–¹æ³•ï¼Œé€šè¿‡è‡ªåŠ¨è£…é…çš„æ–¹å¼åˆ›å»º Bean å®ä¾‹ã€‚ if (autowireNecessary) &#123; return autowireConstructor(beanName, mbd, null, null); &#125; else &#123; //å¦‚æœä¸éœ€è¦è‡ªåŠ¨è£…é…ï¼Œåˆ™è°ƒç”¨ instantiateBean æ–¹æ³•ï¼Œä½¿ç”¨æ— å‚æ„é€ å‡½æ•°åˆ›å»º Bean å®ä¾‹ã€‚ return instantiateBean(beanName, mbd); &#125;\t&#125;\t// Candidate constructors for autowiring?\t// è°ƒç”¨ BeanPostProcessor ç¡®å®šå€™é€‰çš„æ„é€ å‡½æ•°ã€‚\tConstructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);\tif (ctors != null || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR || mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123; return autowireConstructor(beanName, mbd, ctors, args);\t&#125;\t// Preferred constructors for default construction?\tctors = mbd.getPreferredConstructors();\tif (ctors != null) &#123; return autowireConstructor(beanName, mbd, ctors, null);\t&#125;\t// No special handling: simply use no-arg constructor.\t// æ— å‚æ„é€ å‡½æ•°\treturn instantiateBean(beanName, mbd);&#125; 6.2.1 è·å–Classå¯¹è±¡åœ¨Spring å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œbean çš„å®ä¾‹åŒ–ç”¨åå°„æœºåˆ¶å®Œæˆã€‚ åå°„æœºåˆ¶çš„è¿è¡Œä¾èµ–äºClass å¯¹è±¡ã€‚åœ¨createBeanInstanceä»£ç ä¸­ï¼Œ è·å–Class å¯¹è±¡æœ‰ä¸¤ç§é€‰æ‹©ï¼Œ Class.forName ClassLoader.loadClass 6.2.2 instantiateBean-æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–beanæ¯”è¾ƒç®€å•ï¼Œæ€»ä½“æµç¨‹éµå¾ªå¸¸è§çš„åå°„è®²è§£ä¸­ï¼Œæœ€ç®€å•çš„é‚£ç§demo12constructorToUse = clazz.getDeclaredConstructor();ctor.newInstance(argsWithDefaultValues); 6.2.3 autowireConstructor-æ„é€ å‡½æ•°æ³¨å…¥å®ä¾‹åŒ–beanautowireConstructoræœ‰å¯èƒ½ä¼šé‡åˆ°å¾ªç¯ä¾èµ–ã€‚ æ„é€ å‡½æ•°æ³¨å…¥æ–¹å¼ä¸­ï¼Œbean å¿…é¡»å·²ç»å®ä¾‹åŒ–å®Œæˆï¼Œå› æ­¤ä¸‰å±‚ç¼“å­˜æœºåˆ¶ä¸­æå‰æš´éœ²çš„æ—©æœŸå¼•ç”¨æ˜¯å¦‚ä½•è§£å†³æ„é€ å‡½æ•°æ³¨å…¥å¼•å‘çš„å¾ªç¯ä¾èµ–çš„ã€‚ 6.3 earlySingletonExposurebean å·²ç»å®Œæˆäº†åˆæ­¥ å®ä¾‹åŒ–ï¼Œ è™½ç„¶è¿˜ä¸å®Œç¾ï¼ˆè¿˜æ²¡æœ‰è¿›è¡Œ ç¬¬äºŒæ­¥populateå’Œç¬¬ä¸‰æ­¥ initï¼‰ï¼Œä½†æ˜¯å·²ç»èƒ½è¢«äººè®¤å‡ºæ¥äº†ï¼ˆæ ¹æ®å¯¹è±¡å¼•ç”¨èƒ½å®šä½åˆ°å †ä¸­çš„å¯¹è±¡ï¼‰ï¼Œæ‰€ä»¥ Spring æ­¤æ—¶å°†è¿™ä¸ªå¯¹è±¡æå‰æ›å…‰å‡ºæ¥è®©å¤§å®¶è®¤è¯†ï¼Œè®©å¤§å®¶ä½¿ç”¨ã€‚ æå‰æš´éœ²å¼•ç”¨çš„é€»è¾‘ï¼Œæ˜¯æ·»åŠ ç¬¬3å±‚ç¼“å­˜ï¼Œ 1addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean)); ObjectFactory çš„åŒ¿åç±»å®ç°æ˜¯getEarlyBeanReferenceï¼Œ getEarlyBeanReference æ–¹æ³•ä¸­å¤„ç†äº†AOP ä»£ç†çš„æƒ…å†µï¼Œbean éœ€è¦è¢«AOP ä»£ç ï¼Œä¼šè¿”å›ä»£ç†å¯¹è±¡çš„å¼•ç”¨ã€‚ 6.4 doCreateBean- populateBeanåœ¨å±æ€§å¡«å……é˜¶æ®µï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šé‡åˆ°å¾ªç¯ä¾èµ–ã€‚è¿™ä¸€é˜¶æ®µçš„å¾ªç¯ä¾èµ–å¯ä»¥é€šè¿‡ä¸‰å±‚ç¼“å­˜æå‰æš´éœ²æ—©æœŸå¼•ç”¨è§£å†³ã€‚ 6.5 doCreateBean- initializeBeanåªç•™é‡ç‚¹ä»£ç ï¼Œbean çš„init æµç¨‹å¦‚ä¸‹ 12345678910protected Object initializeBean(String beanName, Object bean, @Nullable RootBeanDefinition mbd) &#123; invokeAwareMethods(beanName, bean); applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); invokeInitMethods(beanName, wrappedBean, mbd); applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); &#125; init è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°å¤šä¸ªæ‹“å±•ç‚¹ï¼Œå¦‚ Awareã€BeanPostProcessorï¼Œå…·ä½“å…³äºæ‹“å±•ç‚¹çš„ä»‹ç»ï¼Œå¯ä»¥é˜…è¯»Spring å¯åŠ¨è¿‡ç¨‹æ‹“å±•ç‚¹æ‹“å±•ç‚¹ 6.5.1 Aware-invokeAwareMethodsç‚¹å‡»æŸ¥çœ‹invokeAwareMethodsï¼Œ å…¶é€»è¾‘æ¶‰åŠåˆ°3ä¸ªAware æ¥å£ã€‚ Springæ¡†æ¶ä¸­ï¼ŒAwareæ¥å£çš„ä½œç”¨æ˜¯è®©beanèƒ½å¤Ÿæ‹¿åˆ°å¯¹Springå®¹å™¨ä¸­çš„å„ç§èµ„æºï¼Œä»è€Œå¢å¼ºbeançš„åŠŸèƒ½å’Œçµæ´»æ€§ã€‚ ä¸åŒçš„ Aware åŸºæœ¬éƒ½èƒ½å¤Ÿè§åçŸ¥æ„ï¼ŒAwareä¹‹å‰çš„åå­—å°±æ˜¯å¯ä»¥æ‹¿åˆ°ä»€ä¹ˆèµ„æºï¼Œä¾‹å¦‚BeanNameAwareå¯ä»¥æ‹¿åˆ°BeanNameï¼Œä»¥æ­¤ç±»æ¨ã€‚è°ƒç”¨æ—¶æœºéœ€è¦æ³¨æ„ï¼šæ‰€æœ‰çš„Awareæ–¹æ³•éƒ½æ˜¯åœ¨inité˜¶æ®µä¹‹å‰è°ƒç”¨çš„ 6.5.2 BeanPostProcessorapplyBeanPostProcessorsBeforeInitialization å’ŒapplyBeanPostProcessorsAfterInitialization æ˜¯BeanPostProcessor çš„æ¥å£å®ç°, åˆ†åˆ«åœ¨init å‰åè°ƒç”¨ï¼Œå¯ä»¥ä¿®æ”¹bean å®ä¾‹ï¼Œ Spring AOP å°±æ˜¯åŸºäºBeanPostProcessor å®ç°çš„ 1234567891011public interface BeanPostProcessor &#123;\t@Nullable default Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123; return bean; &#125; @Nullable default Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123; return bean; &#125;&#125; 6.5.3 invokeInitMethods - InitializingBean123456789101112protected void invokeInitMethods(String beanName, Object bean, @Nullable RootBeanDefinition mbd)&#123;\t((InitializingBean) bean).afterPropertiesSet();\tif (mbd != null &amp;&amp; bean.getClass() != NullBean.class) &#123; String initMethodName = mbd.getInitMethodName(); if (StringUtils.hasLength(initMethodName) &amp;&amp; !(isInitializingBean &amp;&amp; &quot;afterPropertiesSet&quot;.equals(initMethodName)) &amp;&amp; !mbd.isExternallyManagedInitMethod(initMethodName)) &#123; invokeCustomInitMethod(beanName, bean, mbd); &#125; &#125;&#125; InitializingBeanæ˜¯Springæ¡†æ¶ä¸­å®šä¹‰çš„ä¸€ä¸ªæ¥å£ï¼Œç”¨äºåœ¨beançš„æ‰€æœ‰å±æ€§è®¾ç½®å®Œæˆåæ‰§è¡Œè‡ªå®šä¹‰çš„init é€»è¾‘ã€‚å®ƒæ˜¯Springç”Ÿå‘½å‘¨æœŸå›è°ƒæœºåˆ¶çš„ä¸€éƒ¨åˆ†ï¼Œä½¿å¾—beanå¯ä»¥åœ¨å±æ€§æ³¨å…¥å®Œæˆåä½†åœ¨ä½¿ç”¨ä¹‹å‰æ‰§è¡Œä¸€äº›è‡ªå®šä¹‰çš„åˆå§‹åŒ–å·¥ä½œã€‚123public interface InitializingBean &#123; void afterPropertiesSet() throws Exception;&#125; å®ç°InitializingBeanæ¥å£çš„beanå¯ä»¥é€šè¿‡afterPropertiesSetæ–¹æ³•åœ¨Springå®¹å™¨å®Œæˆä¾èµ–æ³¨å…¥åä½†åœ¨ä½¿ç”¨beanä¹‹å‰æ‰§è¡Œä¸€äº›åˆå§‹åŒ–é€»è¾‘ã€‚å…¸å‹çš„ä½¿ç”¨åœºæ™¯åŒ…æ‹¬ï¼š æ£€æŸ¥ä¾èµ–å±æ€§ï¼šç¡®ä¿æ‰€æœ‰å¿…éœ€çš„å±æ€§å·²ç»è¢«è®¾ç½®ï¼Œå¹¶ä¸”æ»¡è¶³æŸäº›ä¸šåŠ¡çº¦æŸã€‚ æ‰§è¡Œåˆå§‹åŒ–æ“ä½œï¼šä¾‹å¦‚ï¼Œå»ºç«‹æ•°æ®åº“è¿æ¥ã€åŠ è½½é…ç½®æ–‡ä»¶ã€å¯åŠ¨è¾…åŠ©æœåŠ¡ç­‰ã€‚ å…¶ä»–åˆå§‹åŒ–é€»è¾‘ï¼šåœ¨beanè¢«ä½¿ç”¨ä¹‹å‰éœ€è¦å®Œæˆçš„ä»»ä½•å…¶ä»–å‡†å¤‡å·¥ä½œã€‚ @PostConstructæ³¨è§£é™¤äº†å®ç°InitializingBeanæ¥å£ï¼ŒSpringè¿˜æä¾›äº†ä¸€ä¸ªæ›´å¸¸ç”¨çš„æ³¨è§£@PostConstructï¼Œå¯ä»¥ç”¨äºåŒæ ·çš„åˆå§‹åŒ–ç›®çš„ã€‚@PostConstructæ˜¯Java EEçš„æ ‡å‡†æ³¨è§£ï¼Œé€šå¸¸æ›´ç®€æ´å¹¶ä¸”æ›´ç¬¦åˆæ³¨è§£é©±åŠ¨å¼€å‘çš„é£æ ¼ã€‚ ä½¿ç”¨@PostConstructæ³¨è§£çš„ç¤ºä¾‹ï¼š 1234567891011121314151617181920212223import javax.annotation.PostConstruct;import org.springframework.stereotype.Component;@Componentpublic class MyBeanWithPostConstruct &#123; private String someProperty; // Setter for dependency injection public void setSomeProperty(String someProperty) &#123; this.someProperty = someProperty; &#125; @PostConstruct public void init() &#123; // æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ if (this.someProperty == null) &#123; throw new IllegalArgumentException(&quot;Property &#x27;someProperty&#x27; is required&quot;); &#125; System.out.println(&quot;@PostConstruct: Properties have been set, someProperty=&quot; + this.someProperty); // å…¶ä»–åˆå§‹åŒ–ä»£ç ... &#125;&#125; InitializingBeanä¸@PostConstructçš„åŒºåˆ« å®ç°æ–¹å¼ï¼š InitializingBeanï¼šé€šè¿‡å®ç°æ¥å£çš„æ–¹æ³•æ¥å®šä¹‰åˆå§‹åŒ–é€»è¾‘ã€‚ @PostConstructï¼šé€šè¿‡åœ¨æ–¹æ³•ä¸Šä½¿ç”¨æ³¨è§£æ¥å®šä¹‰åˆå§‹åŒ–é€»è¾‘ã€‚ ä½¿ç”¨åœºæ™¯ï¼š InitializingBeanï¼šæ›´é€‚ç”¨äºéœ€è¦æ˜¾å¼å®ç°æ¥å£çš„åœºæ™¯ï¼Œé€šå¸¸åœ¨æ¡†æ¶æˆ–åº•å±‚ä»£ç ä¸­ä½¿ç”¨ã€‚ @PostConstructï¼šæ›´é€‚ç”¨äºåº”ç”¨å±‚ä»£ç ï¼Œæ›´åŠ ç®€æ´å’Œç›´è§‚ã€‚ çµæ´»æ€§ï¼š InitializingBeanï¼šå¿…é¡»å®ç°æ¥å£ï¼Œä¸æ”¯æŒå¤šä¸ªåˆå§‹åŒ–æ–¹æ³•ã€‚ @PostConstructï¼šå¯ä»¥åœ¨ç±»ä¸­å®šä¹‰å¤šä¸ªåˆå§‹åŒ–æ–¹æ³•ï¼ˆé€šè¿‡å¤šä¸ªæ³¨è§£ï¼‰ã€‚6.5.4 invokeCustomInitMethod è¿™é‡Œçš„init æŒ‡çš„æ˜¯åœ¨ XML é…ç½®æˆ– Java é…ç½®ä¸­æŒ‡å®šçš„è‡ªå®šä¹‰ init-method æ–¹æ³•ã€‚åœ¨ Spring æ¡†æ¶ä¸­ï¼Œå½“ä¸€ä¸ª Bean çš„ç”Ÿå‘½å‘¨æœŸåˆ°è¾¾åˆå§‹åŒ–é˜¶æ®µæ—¶ï¼Œå¦‚æœè¯¥ Bean é…ç½®äº†è‡ªå®šä¹‰çš„åˆå§‹åŒ–æ–¹æ³•ï¼ŒSpring å°†ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œã€‚åœ¨ XML é…ç½®ä¸­ï¼Œå¯ä»¥é€šè¿‡ init-method å±æ€§æŒ‡å®šä¸€ä¸ª Bean çš„è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š123&lt;bean id=&quot;exampleBean&quot; class=&quot;com.example.MyBean&quot; init-method=&quot;customInit&quot;&gt; &lt;!-- Bean å±æ€§é…ç½® --&gt;&lt;/bean&gt; åœ¨ Java é…ç½®ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ @Bean æ³¨è§£çš„ initMethod å±æ€§æ¥æŒ‡å®šè‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š12345678@Configurationpublic class AppConfig &#123; @Bean(initMethod = &quot;customInit&quot;) public MyBean exampleBean() &#123; return new MyBean(); &#125;&#125; invokeCustomInitMethod æ–¹æ³•çš„ä½œç”¨å°±æ˜¯åœ¨ Bean åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨åœ¨ XML æˆ– Java é…ç½®ä¸­æŒ‡å®šçš„è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•ã€‚ 6.5.5 æ‹“å±•ç‚¹æ‰§è¡Œé¡ºåºä»¥ä¸Šå†…å®¹ä¸­æåˆ°çš„æ‹“å±•ç‚¹ï¼Œå…¶æ‰§è¡Œé¡ºåºåœ¨ä»£ç ä¸­å·²ç»æœ‰æ¯”è¾ƒæ¸…æ™°çš„å±•ç¤ºï¼Œè¿™é‡Œå†å¼ºè°ƒä¸€ä¸‹ Aware BeanPostProcessorçš„postProcessBeforeInitialization`æ–¹æ³•ã€‚å¦‚æœæœ‰å¤šä¸ªBeanPostProcessorï¼Œä¼šæŒ‰é¡ºåºè°ƒç”¨å®ƒä»¬çš„postProcessBeforeInitializationæ–¹æ³•ã€‚(å…¶å®è¿™ä¸ªæ­¥éª¤ä¸­ä¹Ÿä¼šæœ‰ç›¸å…³Aware) ä½¿ç”¨@PostConstructæ³¨è§£çš„æ–¹æ³•ã€‚æ­¤æ—¶ï¼Œæ‰€æœ‰ä¾èµ–å·²ç»æ³¨å…¥å®Œæ¯•ï¼ŒBeanå·²ç»å®Œå…¨é…ç½®å¥½ï¼Œä½†è¿˜æ²¡æœ‰æ‰§è¡Œä»»ä½•è‡ªå®šä¹‰çš„åˆå§‹åŒ–æ–¹æ³•ã€‚ å®ç°InitializingBeanæ¥å£çš„afterPropertiesSetæ–¹æ³•ã€‚ åœ¨XMLé…ç½®æˆ–Javaé…ç½®ä¸­æŒ‡å®šçš„è‡ªå®šä¹‰init-methodæ–¹æ³•ã€‚ BeanPostProcessorçš„postProcessAfterInitializationæ–¹æ³•ã€‚å¦‚æœæœ‰å¤šä¸ªBeanPostProcessorï¼Œä¼šæŒ‰é¡ºåºè°ƒç”¨å®ƒä»¬çš„postProcessAfterInitializationæ–¹æ³• 6.6 ç¼“å­˜ç®¡ç†-addSingletonå½“é€šsingletonObject = singletonFactory.getObject() è·å¾—åˆ°bean åï¼Œéœ€è¦é‡æ–°ç®¡ç†3å±‚ç¼“å­˜ä¸­çš„æ•°æ® 123456789// initå®Œæˆçš„beanï¼Œ æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜ï¼Œå¹¶ä»äºŒä¸‰çº§ç¼“å­˜ä¸­åˆ é™¤protected void addSingleton(String beanName, Object singletonObject) &#123;\tsynchronized (this.singletonObjects) &#123; this.singletonObjects.put(beanName, singletonObject); this.singletonFactories.remove(beanName); this.earlySingletonObjects.remove(beanName); this.registeredSingletons.add(beanName);\t&#125;&#125; 7. å†çœ‹getBean-ä»2ç§è§†è§’å‡ºå‘åœ¨ç¬¬4å°èŠ‚doGetBean çš„æ³¨é‡Šä¸­å—äº†ï¼Œå¯¹äºä¸€ä¸ªbean è§¦å‘getBean çš„é€»è¾‘æœ‰2ä¸­æƒ…å†µ bean çš„æ­£å¸¸åˆ›å»ºæµç¨‹ ä¾èµ–æ³¨å…¥è§¦å‘çš„getBean å†çœ‹çœ‹ä¸‹getSinngleton çš„ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839ä»£ç å‡åœ¨ DefaultSingletonBeanRegistry.java public Object getSingleton(String beanName) &#123; return getSingleton(beanName, true); &#125;@Nullable protected Object getSingleton(String beanName, boolean allowEarlyReference) &#123; // Quick check for existing instance without full singleton lock // é¦–å…ˆä» singletonObjectsï¼ˆå•ä¾‹ç¼“å­˜ï¼‰ä¸­å¿«é€Ÿè·å– Bean å®ä¾‹ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿”å›ã€‚ Object singletonObject = this.singletonObjects.get(beanName); // å¦‚æœåˆæ­¥æ£€æŸ¥æ²¡æœ‰æ‰¾åˆ°å®ä¾‹ï¼Œå¹¶ä¸”è¯¥å•ä¾‹å½“å‰æ­£åœ¨åˆ›å»ºä¸­ï¼Œåˆ™ä» earlySingletonObjectsï¼ˆæ—©æœŸå•ä¾‹ç¼“å­˜ï¼‰ä¸­æŸ¥æ‰¾ã€‚ if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123; singletonObject = this.earlySingletonObjects.get(beanName); if (singletonObject == null &amp;&amp; allowEarlyReference) &#123; //å¦‚æœä»æœªæ‰¾åˆ°å®ä¾‹ï¼Œå¹¶ä¸”å…è®¸æ—©æœŸå¼•ç”¨ï¼Œåˆ™è¿›å…¥åŒæ­¥å—ã€‚ //åœ¨åŒæ­¥å—å†…ï¼Œå†æ¬¡ä» singletonObjects å’Œ earlySingletonObjects ä¸­æ£€æŸ¥å®ä¾‹ã€‚ // è¿™æ˜¯ä¸ºäº†é¿å…åœ¨è¿›å…¥åŒæ­¥å—çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å…¶ä»–çº¿ç¨‹å·²ç»åˆ›å»ºäº†è¯¥å•ä¾‹å®ä¾‹ã€‚ synchronized (this.singletonObjects) &#123; // Consistent creation of early reference within full singleton lock singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null) &#123; singletonObject = this.earlySingletonObjects.get(beanName); if (singletonObject == null) &#123; ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName); //å¦‚æœä»æœªæ‰¾åˆ°å®ä¾‹ï¼Œåˆ™å°è¯•ä» singletonFactories ä¸­è·å–å•ä¾‹å·¥å‚ï¼Œ // å¹¶singletonFactoryåˆ›å»ºæ—©æœŸå¼•ç”¨ï¼Œå°†å…¶æ”¾å…¥ earlySingletonObjects ä¸­ï¼Œå¹¶ä» singletonFactories ä¸­ç§»é™¤ã€‚ if (singletonFactory != null) &#123; singletonObject = singletonFactory.getObject(); this.earlySingletonObjects.put(beanName, singletonObject); this.singletonFactories.remove(beanName); &#125; &#125; &#125; &#125; &#125; &#125; return singletonObject; &#125; åœ¨æ­£å¸¸çš„åˆ›å»ºæµç¨‹ä¸­ï¼ŒgetSingleton(beanName, true)è¿”å›çš„é€šå¸¸æ˜¯nullï¼Œå› ä¸ºæ­¤æ—¶Beanå°šæœªåˆ›å»ºå®Œæ¯•ã€‚ åœ¨ä¾èµ–æ³¨å…¥çš„åœºæ™¯ä¸­ï¼Œé€šè¿‡getSingleton(beanName, true)å¯ä»¥é€šè¿‡3çº§ç¼“å­˜è·å–åˆ°äºŒçº§ç¼“å­˜ æ—©æœŸå¼•ç”¨ï¼Œä»è€Œè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ã€‚ å¯ä»¥çœ‹å‡ºåœ¨ä¸€ä¸ªbean çš„æ­£å¸¸åˆ›å»ºæµç¨‹ä¸­ï¼Œ åªä¼šè§¦å‘å¯¹ä¸€çº§ã€ä¸‰çº§ç¼“å­˜çš„æ“ä½œï¼Œ å¹¶ä¸ä¼šä¸»åŠ¨ç”Ÿæˆæ—©æœŸå¼•ç”¨ï¼Œ åªæœ‰åœ¨å¾ªç¯ä¾èµ–çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šè§¦å‘å¯¹2çº§ç¼“å­˜ã€‚ 8. getObjectForBeanInstanceç°åœ¨ä¸è®ºæ˜¯æ­£å¸¸çš„åˆ›å»ºæµç¨‹éœ€è¦createBeanï¼Œè¿˜æ˜¯ä¾èµ–æ³¨å…¥å¯ä»¥ç›´æ¥è·å–æ—©æœŸå¼•ç”¨ï¼Œè·å–åˆ°sharedInstance éƒ½æ²¡æœ‰ç›´æ¥è¿”å›ï¼Œè€Œæ˜¯ç»è¿‡getObjectForBeanInstance å¤„ç†åæ‰è¿”å›ã€‚123456789101112131415161718192021222324252627282930AbstractBeanFactory.javapublic Object getBean(String name) throws BeansException &#123; return doGetBean(name, null, null, false); &#125;// çœç•¥äº†éå¸¸å¤šä»£ç ï¼Œåªä¿ç•™äº†ç›¸å…³é€»è¾‘protected &lt;T&gt; T doGetBean( String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object[] args, boolean typeCheckOnly) throws BeansException &#123; // å°è¯•ä»ç¼“å­˜ä¸­è·å–\tObject sharedInstance = getSingleton(beanName); if (sharedInstance != null &amp;&amp; args == null) &#123; // ç¼“å­˜ä¸­å­˜åœ¨åˆ™ç›´æ¥è¿”å› bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);\t&#125;else&#123; // ç¼“å­˜ä¸­æ²¡æœ‰åˆ™éœ€è¦åˆ›å»ºå¹¶å›å†™ç¼“å­˜ sharedInstance = getSingleton(beanName, () -&gt; &#123; try &#123; return createBean(beanName, mbd, args); &#125;catch (BeansException ex) &#123; destroySingleton(beanName); throw ex; &#125; &#125;); bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);\t&#125;\treturn bean;&#125;åœ¨ Spring æ¡†æ¶ä¸­ï¼ŒgetObjectForBeanInstance æ–¹æ³•ç”¨äºå¤„ç†FactoryBean è¿™ç§ç‰¹æ®Šçš„bean ï¼Œä»¥ç¡®ä¿è¿”å›ç»™ç”¨æˆ·çš„æ˜¯æ­£ç¡®ç±»å‹å’ŒçŠ¶æ€çš„å¯¹è±¡ã€‚å…³äºç†è§£ Spring FacrotyBeanç®€å•æ¥è®²ï¼ŒFactoryBean ä¹Ÿæ˜¯ä¸€ä¸ªbean ï¼Œ ä½†æ˜¯é€šè¿‡å®ƒå¯ä»¥ç”Ÿäº§å‡ºå…¶ä»–beanã€‚ FactoryBeanæœ‰ä¸¤ç§ç”¨æ³• ä½¿ç”¨ getBean(&quot;&amp;beanName&quot;) å¯ä»¥è·å– FactoryBean å®ä¾‹æœ¬èº«ï¼Œè€Œä¸æ˜¯ FactoryBean åˆ›å»ºçš„å¯¹è±¡ã€‚ ä½¿ç”¨ getBean(&quot;beanName&quot;) åˆ™è·å–ç”± FactoryBean åˆ›å»ºçš„å¯¹è±¡ã€‚ getObjectForBeanInstanceçš„å­˜åœ¨å°±æ˜¯ä¸ºäº†å¤„ç†å¦‚æœä¸€ä¸ªbean æ˜¯FactoryBeanï¼Œé‚£åˆ°åº•æ˜¯è¿”å›FactoryBeanï¼Œè¿˜æ˜¯è¿”å›FactoryBean åˆ›å»ºçš„å¯¹è±¡ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253protected Object getObjectForBeanInstance( Object beanInstance, String name, String beanName, @Nullable RootBeanDefinition mbd) &#123; // æ£€æŸ¥ name æ˜¯å¦åŒ…å«ç‰¹æ®Šç¬¦å· &amp;ã€‚ // å¦‚æœåŒ…å«å°±è¡¨ç¤ºgetBeanéœ€è¦è¿”å›çš„æ˜¯FactoryBeanæœ¬èº«ã€‚è€Œä¸æ˜¯é€šè¿‡FactoryBeanåˆ›å»ºçš„å¯¹è±¡ã€‚ if (BeanFactoryUtils.isFactoryDereference(name)) &#123; //å¦‚æœ beanInstance æ˜¯ NullBean ç±»å‹ï¼Œç›´æ¥è¿”å›å®ƒã€‚ if (beanInstance instanceof NullBean) &#123; return beanInstance; &#125; //å¦‚æœä»name åˆ¤æ–­æ˜¯FactoryBeanï¼Œ ä½†æ˜¯instanceof åˆ¤æ–­ä¸æ˜¯ FactoryBean ç±»å‹ï¼ŒæŠ›å‡º BeanIsNotAFactoryException å¼‚å¸¸ã€‚ if (!(beanInstance instanceof FactoryBean)) &#123; throw new BeanIsNotAFactoryException(beanName, beanInstance.getClass()); &#125; //å¦‚æœæä¾›äº† mbdï¼Œå°† isFactoryBean è®¾ç½®ä¸º trueï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå·¥å‚ Beanã€‚ if (mbd != null) &#123; mbd.isFactoryBean = true; &#125; return beanInstance; &#125; // nameä¸ä»¥ &amp; å¼€å¤´ï¼Œ ä»£è¡¨getBean éœ€è¦çš„æ˜¯ æ™®é€šBean æˆ– é€šè¿‡FactoryBeanåˆ›å»ºçš„å¯¹è±¡ï¼š // å¦‚æœ beanInstance ä¸æ˜¯ FactoryBeanï¼Œè¯´æ˜å®ƒæ˜¯ä¸€ä¸ªæ™®é€šbean, ç›´æ¥è¿”å›å³å¯ã€‚ if (!(beanInstance instanceof FactoryBean)) &#123; return beanInstance; &#125; // ä»¥ä¸‹è¿‡ç¨‹æ˜¯é€šè¿‡FactoryBeanåˆ›å»ºå¯¹è±¡ Object object = null; //å¦‚æœæä¾›äº† mbdï¼Œå°† isFactoryBean è®¾ç½®ä¸º trueã€‚ if (mbd != null) &#123; mbd.isFactoryBean = true; &#125; else &#123; //å¦åˆ™ï¼Œè°ƒç”¨ getCachedObjectForFactoryBean(beanName) å°è¯•ä»ç¼“å­˜ä¸­è·å– FactoryBean åˆ›å»ºçš„å¯¹è±¡ã€‚ //æ²¡æœ‰ mbd/beandefinition çš„æƒ…å†µä¸‹ï¼Œæ— æ³•çŸ¥é“ FactoryBean çš„è¯¦ç»†ä¿¡æ¯ï¼Œåªèƒ½ä¾èµ–ç¼“å­˜,é€šè¿‡beanName å°è¯•è·å–FactoryBeanåˆ›å»ºçš„å¯¹è±¡ //è¿™ç§è®¾è®¡ç¡®ä¿äº†åœ¨ç¼ºå°‘ mbd å…ƒæ•°æ®æ—¶ï¼ŒSpring ä»èƒ½å¯é åœ°æä¾› Bean å®ä¾‹ï¼ŒåŒæ—¶æœ€å¤§é™åº¦åœ°åˆ©ç”¨ç¼“å­˜ä»¥æé«˜æ€§èƒ½ã€‚ object = getCachedObjectForFactoryBean(beanName); &#125; //å¦‚æœ object ä¸º nullï¼Œè¡¨ç¤ºç¼“å­˜ä¸­æ²¡æœ‰å¯¹è±¡ï¼Œéœ€è¦ä» FactoryBean è·å– if (object == null) &#123; // Return bean instance from factory. //å°† beanInstance è½¬æ¢ä¸º FactoryBean ç±»å‹ã€‚ FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) beanInstance; // Caches object obtained from FactoryBean if it is a singleton. // ç¼“å­˜ä¸­æ²¡æœ‰åˆ™è¦å°è¯•è·å–mbd if (mbd == null &amp;&amp; containsBeanDefinition(beanName)) &#123; mbd = getMergedLocalBeanDefinition(beanName); &#125; boolean synthetic = (mbd != null &amp;&amp; mbd.isSynthetic()); object = getObjectFromFactoryBean(factory, beanName, !synthetic); &#125; return object;\t&#125; 9. ä¸‰çº§ç¼“å­˜çš„è½¬æ¢æµç¨‹ ä¸€ä¸ªéæ‡’åŠ è½½çš„å•ä¾‹bean å®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼Œ åªä¼šä¸»åŠ¨å»æ·»åŠ ä¸€çº§ã€ä¸‰çº§ç¼“å­˜ï¼Œåªæœ‰å¾ªç¯ä¾èµ–æ‰ä¼šè§¦å‘äºŒçº§ç¼“å­˜ å¯¹äºä¸€ä¸ªbean ,ä¸è®ºæ˜¯å®Œæ•´å¼•ç”¨ï¼Œè¿˜æ˜¯æ—©æœŸå¼•ç”¨ï¼Œè¿˜æ˜¯ç”Ÿæˆæ—©æœŸå¼•ç”¨çš„ObjectFactoryï¼Œåœ¨åŒä¸€æ—¶åˆ»ï¼Œ åªä¼šå­˜åœ¨äºä¸€çº§ç¼“å­˜ä¸­ 9.1 ä¸ºä»€ä¹ˆéœ€è¦ç¬¬ä¸‰çº§ç¼“å­˜-addSingletonFactorydoCreateBean-&gt;addSingletonFactoryï¼Œ åœ¨create æ­¥éª¤åï¼Œ populate æ­¥éª¤å‰ ç¬¬ä¸‰çº§ç¼“å­˜çš„å­˜åœ¨ä¸»è¦æ˜¯ä¸ºäº†å¤„ç†ä»£ç†æœºåˆ¶ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä»£ç†å¯¹è±¡ä¼šåœ¨Beançš„inité˜¶æ®µç”Ÿæˆã€‚å¦‚æœåœ¨è§£å†³å¾ªç¯ä¾èµ–æ—¶æå‰æš´éœ²çš„å¼•ç”¨ä¸æ˜¯ä»£ç†å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œæ˜¯åŸå§‹å¯¹è±¡çš„å¼•ç”¨ï¼Œå³doCreateBeanä»£ç ä¸­ bean å’ŒexposedObject ä¸ä¸€è‡´123456BeanWrapper instanceWrapper = createBeanInstance(beanName, mbd, args);Object bean = instanceWrapper.getWrappedInstance();populateBean(beanName, mbd, instanceWrapper);Object exposedObject =initializeBean(beanName, exposedObject, mbd) ä½†æ˜¯å¦‚æœå¯ä»¥åœ¨å¾ªç¯ä¾èµ–çš„å¤„ç†ä¸­å¤„ç†ä¸­å°±ä¸ºbean ç”Ÿæˆä»£ç†å¯¹è±¡çš„å¼•ç”¨ï¼ˆå¦‚æœéœ€è¦ä»£ç†çš„è¯ï¼‰ï¼Œ é‚£ä¹ˆå°±å¯ä»¥å’Œinité˜¶æ®µäº§ç”Ÿçš„ä»£ç†å¼•ç”¨ä¿æŒä¸€è‡´äº†ã€‚è¿™ä¸ªåŠŸèƒ½æ˜¯é€šè¿‡getEarlyBeanReference æ¥å®Œæˆçš„å¦‚æœæ˜¯éœ€è¦ä»£ç†çš„å¯¹è±¡ï¼ŒgetEarlyBeanReferenceå°±ä¼šç”Ÿæˆå…¶ä»£ç†å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯åŸå¯¹è±¡çš„å¼•ç”¨ã€‚ åœ¨è§£å†³å¾ªç¯ä¾èµ–æå‰æš´éœ²å¼•ç”¨æ—¶ï¼Œå¦‚æœæå‰æš´éœ²çš„å¼•ç”¨ä¸æ˜¯å…¶ä»£ç†å¯¹è±¡çš„å¼•ç”¨çš„è¯ï¼Œå°±ä¼šäº§ç”Ÿæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚ 123456789101112addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));protected void addSingletonFactory(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123; Assert.notNull(singletonFactory, &quot;Singleton factory must not be null&quot;); synchronized (this.singletonObjects) &#123; if (!this.singletonObjects.containsKey(beanName)) &#123; this.singletonFactories.put(beanName, singletonFactory); this.earlySingletonObjects.remove(beanName); this.registeredSingletons.add(beanName); &#125; &#125;\t&#125; è¿™é‡Œåˆæœ‰ä¸€ä¸ªObjectFactoryçš„åŒ¿åå®ç°ç±»ï¼Œ ä¸”æ·»åŠ è¿›äº†ä¸‰çº§ç¼“å­˜singletonFactoriesä¸­ï¼Œ ä¸‹é¢æ¥å…·ä½“çœ‹ä¸‹getEarlyBeanReferenceå®ç°äº†ä»€ä¹ˆ getEarlyBeanReferenceç”±æ­¤å¯è§ï¼Œä¸‰çº§ç¼“å­˜ç”¨äºç”Ÿäº§äºŒçº§ç¼“å­˜ä¸­å­˜æ”¾çš„æ—©æœŸå¼•ç”¨ï¼Œå¦‚æœæ˜¯éœ€è¦ä»£ç†çš„å¯¹è±¡ï¼ŒgetEarlyBeanReferenceå°±ä¼šç”Ÿæˆå…¶ä»£ç†å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯åŸå¯¹è±¡çš„å¼•ç”¨ã€‚ ä¹‹æ‰€ä»¥éœ€è¦ä¸‰çº§ç¼“å­˜æ˜¯å› ä¸ºä»£ç†æœºåˆ¶çš„å­˜åœ¨ï¼Œ åœ¨æ•´ä¸ªbean çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œä¼šåœ¨init é˜¶æ®µç”Ÿæˆå…¶ä»£ç†å¯¹è±¡ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ï¼Œé‚£ä¹ˆåœ¨è§£å†³å¾ªç¯ä¾èµ–æå‰æš´éœ²å¼•ç”¨æ—¶ï¼Œå¦‚æœæå‰æš´éœ²çš„å¼•ç”¨ä¸æ˜¯å…¶ä»£ç†å¯¹è±¡çš„å¼•ç”¨çš„è¯ï¼Œå°±ä¼šäº§ç”Ÿæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µ 123456789protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) &#123;\tObject exposedObject = bean;\tif (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123; for (SmartInstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().smartInstantiationAware) &#123; exposedObject = bp.getEarlyBeanReference(exposedObject, beanName); &#125;\t&#125;\treturn exposedObject;&#125; 9.2 äºŒçº§ç¼“å­˜ 12345678910111213141516171819202122232425262728293031 protected Object getSingleton(String beanName, boolean allowEarlyReference) &#123; // Quick check for existing instance without full singleton lock Object singletonObject = this.singletonObjects.get(beanName); // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å®ä¾‹ä¸”è¯¥Beanæ­£åœ¨åˆ›å»ºä¸­ if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123; // ä»äºŒçº§ç¼“å­˜ä¸­è·å–æ—©æœŸå¼•ç”¨ singletonObject = this.earlySingletonObjects.get(beanName); // å¦‚æœäºŒçº§ç¼“å­˜ä¸­æ²¡æœ‰ä¸”å…è®¸æ—©æœŸå¼•ç”¨ if (singletonObject == null &amp;&amp; allowEarlyReference) &#123; // åœ¨å…¨å±€é”å†…ä¸€è‡´åœ°åˆ›å»ºæ—©æœŸå¼•ç”¨ synchronized (this.singletonObjects) &#123; // å†æ¬¡æ£€æŸ¥ä¸€çº§ç¼“å­˜ singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null) &#123; // å†æ¬¡æ£€æŸ¥äºŒçº§ç¼“å­˜ singletonObject = this.earlySingletonObjects.get(beanName); if (singletonObject == null) &#123; ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName); if (singletonFactory != null) &#123; // é€šè¿‡ä¸‰çº§ç¼“å­˜åˆ›å»ºæ—©æœŸå¼•ç”¨ singletonObject = singletonFactory.getObject(); // å°†æ—©æœŸå¼•ç”¨æ”¾å…¥äºŒçº§ç¼“å­˜ this.earlySingletonObjects.put(beanName, singletonObject); // ä»ä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤å·¥å‚ this.singletonFactories.remove(beanName); &#125; &#125; &#125; &#125; &#125; &#125; return singletonObject; &#125; 9.3 ä¸€çº§ç¼“å­˜getSingleton -&gt; addSingletonï¼Œåœ¨beançš„å®ä¾‹åŒ–å®Œæˆåï¼Œ ä¼šå°†å…¶å¼•ç”¨æ”¾å…¥ä¸€çº§ç¼“å­˜ï¼ŒåŒæ—¶åˆ é™¤2ã€3çº§ç¼“å­˜12345678protected void addSingleton(String beanName, Object singletonObject) &#123; synchronized (this.singletonObjects) &#123; this.singletonObjects.put(beanName, singletonObject); this.singletonFactories.remove(beanName); this.earlySingletonObjects.remove(beanName); this.registeredSingletons.add(beanName); &#125; &#125; 10. å¾ªç¯ä¾èµ–åœ¨Spring IOCå®¹å™¨ å’Œ Spring beanè®²è¿‡ï¼ŒBean ä¾èµ–å…³ç³»å£°æ˜æ–¹å¼æœ‰3ç§ åŸºäºæ„é€ å‡½æ•°çš„ä¾èµ–æ³¨å…¥ åŸºäº Setter æ–¹æ³• åŸºäºå­—æ®µ10.1 å¾ªç¯ä¾èµ–çš„äº§ç”Ÿ å¾ªç¯ä¾èµ–çš„äº§ç”ŸåŸºäºä¾èµ–å…³ç³»çš„3ç§å£°æ˜æ–¹å¼ï¼Œä¹Ÿå¯ä»¥åˆ†ä¸º3ç§ A çš„æ„é€ æ–¹æ³•ä¸­ä¾èµ–äº† B çš„å®ä¾‹å¯¹è±¡ï¼ŒåŒæ—¶ B çš„æ„é€ æ–¹æ³•ä¸­ä¾èµ–äº† A çš„å®ä¾‹å¯¹è±¡ A çš„æ„é€ æ–¹æ³•ä¸­ä¾èµ–äº† B çš„å®ä¾‹å¯¹è±¡ï¼ŒåŒæ—¶ B çš„æŸä¸ª field æˆ–è€… setter éœ€è¦ A çš„å®ä¾‹å¯¹è±¡ï¼Œä»¥åŠåä¹‹ A çš„æŸä¸ª field æˆ–è€… setter ä¾èµ–äº† B çš„å®ä¾‹å¯¹è±¡ï¼ŒåŒæ—¶ B çš„æŸä¸ª field æˆ–è€… setter ä¾èµ–äº† A çš„å®ä¾‹å¯¹è±¡ï¼Œä»¥åŠåä¹‹ Spring ä¸­ éæ‡’åŠ è½½çš„å•ä¾‹bean, åˆå§‹åŒ–è¿‡ç¨‹å¯ä»¥åˆ†ä¸º3ä¸ªæ­¥éª¤ï¼Œå¾ªç¯ä¾èµ–çš„æ­¥éª¤é›†ä¸­åœ¨ç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥ï¼š createBeanInstanceï¼Œ é€šè¿‡æ„é€ å‡½æ•°åˆ›å»ºå®ä¾‹ populateBeanï¼Œå¡«å……å±æ€§/ä¾èµ–æ³¨å…¥ initializeBeanï¼Œåˆå§‹åŒ–10.2 å¾ªç¯ä¾èµ–çš„è§£å†³-ä¸‰å±‚ç¼“å­˜ã€æå‰æš´éœ²å¼•ç”¨Spring å¾ªç¯ä¾èµ–çš„ç†è®ºä¾æ®å…¶å®æ˜¯ Java åŸºäºå¼•ç”¨ä¼ é€’ï¼Œå½“æˆ‘ä»¬è·å–åˆ°å¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œå¯¹è±¡çš„ field æˆ–è€…æˆ–å±æ€§æ˜¯å¯ä»¥å»¶åè®¾ç½®çš„ã€‚ä¸‰å±‚ç¼“å­˜ä¸­çš„äºŒã€ä¸‰çº§ç¼“å­˜æ¶‰åŠç”¨äºæå‰æš´éœ²å¼•ç”¨ï¼Œä»¥æ­¤è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ã€‚å…³äºä¸‰çº§ç¼“å­˜ï¼Œå…·ä½“å¯ä»¥çœ‹ä¸Šé¢çš„å†…å®¹ 10.3 å¾ªç¯ä¾èµ–çš„è§£å†³å‰æåœ¨3çº§ç¼“å­˜çš„æœºåˆ¶ä¸‹ï¼Œ ä»¥ä¸Šä¸‰ç§æƒ…å†µåªèƒ½è§£å†³2&amp;3ï¼Œ1æ— æ³•è§£å†³å› ä¸ºSpringå®¹å™¨èƒ½é¡ºåˆ©å®ä¾‹åŒ–ä»¥æ„é€ å‡½æ•°æ³¨å…¥æ–¹å¼é…ç½®çš„Beanæœ‰ä¸€ä¸ªå‰æï¼šBeanæ„é€ å‡½æ•°å…¥å‚å¼•ç”¨çš„å¯¹è±¡å¿…é¡»å·²ç»å‡†å¤‡å°±ç»ªï¼Œå³éœ€è¦å®Œæˆpopulateå’Œinit è¿™ä¸¤ä¸ªæ­¥éª¤ï¼Œä¸èƒ½åªæœ‰ä¸€ä¸ªå¼•ç”¨ï¼Œå› æ­¤æå‰æ›å…‰ä¹Ÿæ²¡ç”¨ã€‚ç”±äºè¿™ä¸ªæœºåˆ¶çš„é™åˆ¶ï¼Œå¦‚æœä¸¤ä¸ªBeanéƒ½é‡‡ç”¨æ„é€ å‡½æ•°æ³¨å…¥ï¼Œè€Œä¸”éƒ½é€šè¿‡æ„é€ å‡½æ•°å…¥å‚å¼•ç”¨å¯¹æ–¹ï¼Œå°±ä¼šå‘ç”Ÿç±»ä¼¼äºçº¿ç¨‹æ­»é”çš„å¾ªç¯ä¾èµ–é—®é¢˜ã€‚å°†æ„é€ å‡½æ•°æ³¨å…¥æ–¹å¼è°ƒæ•´ä¸ºå±æ€§æ³¨å…¥æ–¹å¼å°±å¯ä»¥äº†ã€‚","tags":["java","Spring"]},{"title":"Spring IOCå®¹å™¨ å’Œ Spring bean","path":"/50be4554/","content":"1. ä¸ºä»€ä¹ˆéœ€è¦IOCIOCæ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„ä¸€ç§è®¾è®¡åŸåˆ™ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†å¯¹è±¡çš„åˆ›å»ºå’Œä¾èµ–å…³ç³»çš„ç®¡ç†ä»åº”ç”¨ç¨‹åºä»£ç ä¸­è½¬ç§»åˆ°å¤–éƒ¨å®¹å™¨ã€‚åªéœ€åœ¨ä»£ç ä¸­å£°æ˜éœ€è¦çš„å¯¹è±¡æˆ–å®ä¾‹ï¼Œè€Œä¸éœ€è¦è‡ªå·±åˆ›å»ºå®ƒä»¬ã€‚IOCå®¹å™¨ä¼šæ ¹æ®è¿™äº›å£°æ˜è‡ªåŠ¨æ³¨å…¥æ‰€éœ€çš„å®ä¾‹ã€‚ä½¿ç”¨IOC æœ‰ä»¥ä¸‹å¥½å¤„ 1.1 è§£è€¦ä¸ç®€åŒ–ä»£ç åœ¨ä¼ ç»Ÿçš„ç¼–ç¨‹æ–¹å¼ä¸­ï¼Œç±»ä¸ç±»ä¹‹é—´çš„ä¾èµ–å…³ç³»å¾€å¾€æ˜¯é€šè¿‡ç›´æ¥å®ä¾‹åŒ–æ¥å®ç°çš„ã€‚ä¾‹å¦‚ï¼š1234567891011public class ServiceA &#123; private ServiceB serviceB; public ServiceA() &#123; this.serviceB = new ServiceB(); &#125; public void performAction() &#123; serviceB.doSomething(); &#125;&#125; åœ¨è¿™ç§æ–¹å¼ä¸­ï¼ŒServiceAç›´æ¥åˆ›å»ºäº†ServiceBçš„å®ä¾‹ï¼Œè¿™å¯¼è‡´äº†ä¸¤è€…ä¹‹é—´çš„å¼ºè€¦åˆã€‚å¦‚æœæˆ‘ä»¬éœ€è¦æ›´æ¢ServiceBçš„å®ç°æˆ–ä¿®æ”¹å…¶åˆ›å»ºé€»è¾‘ï¼Œå°±éœ€è¦ä¿®æ”¹ServiceAçš„ä»£ç ã€‚è¿™ä¸ä»…å¢åŠ äº†ç»´æŠ¤éš¾åº¦ï¼Œä¹Ÿè¿åäº†å¼€é—­åŸåˆ™ï¼ˆOpen/Closed Principleï¼‰ã€‚ é€šè¿‡IOCï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¾èµ–å…³ç³»çš„ç®¡ç†äº¤ç»™å®¹å™¨ï¼š12345678910111213@Componentpublic class ServiceA &#123; private final ServiceB serviceB; @Autowired public ServiceA(ServiceB serviceB) &#123; this.serviceB = serviceB; &#125; public void performAction() &#123; serviceB.doSomething(); &#125;&#125; åœ¨è¿™ç§æ–¹å¼ä¸­ï¼ŒServiceAä¸å†è´Ÿè´£åˆ›å»ºServiceBçš„å®ä¾‹ï¼Œè€Œæ˜¯å£°æ˜å®ƒéœ€è¦ä¸€ä¸ªServiceBçš„å®ä¾‹ã€‚IOCå®¹å™¨ä¼šè‡ªåŠ¨æ³¨å…¥ServiceBçš„å®ä¾‹ï¼Œä»è€Œå®ç°äº†è§£è€¦ã€‚ 1.2 æé«˜ä»£ç çš„å¯æµ‹è¯•æ€§ä¼ ç»Ÿæ–¹å¼ä¸­çš„å¼ºè€¦åˆä½¿å¾—å•å…ƒæµ‹è¯•å˜å¾—å›°éš¾ï¼Œå› ä¸ºæµ‹è¯•ServiceAæ—¶éœ€è¦å®é™…çš„ServiceBå®ä¾‹ã€‚è€Œé€šè¿‡IOCï¼Œä¾èµ–å…³ç³»ç”±å®¹å™¨ç®¡ç†ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°æ›¿æ¢ä¾èµ–å¯¹è±¡ä¸ºæ¨¡æ‹Ÿå¯¹è±¡ï¼ˆMock Objectï¼‰ï¼Œä»è€Œç®€åŒ–äº†æµ‹è¯•ï¼š1234567891011121314151617181920@RunWith(SpringJUnit4ClassRunner.class)@ContextConfiguration(classes = AppConfig.class)public class ServiceATest &#123; @Mock private ServiceB serviceB; @InjectMocks private ServiceA serviceA; @Test public void testPerformAction() &#123; // é…ç½®mockè¡Œä¸º when(serviceB.doSomething()).thenReturn(&quot;Mock Response&quot;); // è°ƒç”¨æ–¹æ³•å¹¶éªŒè¯ serviceA.performAction(); verify(serviceB).doSomething(); &#125;&#125;é€šè¿‡IOCå®¹å™¨ç®¡ç†ä¾èµ–å…³ç³»ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ›´å®¹æ˜“åœ°æ›¿æ¢å®é™…ä¾èµ–å¯¹è±¡ï¼Œä»è€Œæé«˜äº†æµ‹è¯•çš„ä¾¿æ·æ€§å’Œè¦†ç›–ç‡ã€‚ 1.3 é…ç½®ä¸ç®¡ç†çš„çµæ´»æ€§IOCå®¹å™¨é€šå¸¸æä¾›çµæ´»çš„é…ç½®æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡æ³¨è§£æˆ–é…ç½®æ–‡ä»¶æ¥ç®¡ç†ä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼Œåœ¨Springæ¡†æ¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨Javaé…ç½®ç±»æˆ–XMLé…ç½®æ–‡ä»¶æ¥å®šä¹‰ä¾èµ–å…³ç³»ï¼š 1.4 æ”¯æŒé«˜çº§åŠŸèƒ½é™¤äº†ä¾èµ–æ³¨å…¥ï¼Œç°ä»£IOCå®¹å™¨é€šå¸¸è¿˜æä¾›è¯¸å¦‚AOPï¼ˆAspect-Oriented Programmingï¼Œé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰ã€å£°æ˜å¼äº‹åŠ¡ç­‰é«˜çº§åŠŸèƒ½ã€‚è¿™äº›åŠŸèƒ½è¿›ä¸€æ­¥æé«˜äº†ä»£ç çš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ä¾‹å¦‚ï¼ŒAOPå¯ä»¥ç”¨äºå®ç°æ—¥å¿—è®°å½•ã€äº‹åŠ¡ç®¡ç†ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œè€Œæ— éœ€åœ¨ä¸šåŠ¡ä»£ç ä¸­æ·»åŠ ç›¸å…³é€»è¾‘ã€‚ 2. Spring IOC å®¹å™¨åˆ†ç±»Spring IOCå®¹å™¨çš„ä¸»è¦å®ç°æœ‰ä¸¤ç§ï¼šBeanFactoryå’ŒApplicationContextï¼Œå®ƒä»¬ä¹‹é—´æœ‰ä¸€å®šçš„å±‚æ¬¡å…³ç³»å’Œè”ç³»ã€‚ä»¥ä¸‹æ˜¯å¯¹è¿™äº›å®¹å™¨åŠå…¶è”ç³»çš„è¯¦ç»†è¯´æ˜ï¼š 2.1 Spring IOC å®¹å™¨çš„ä¸»è¦å®ç°1.1 BeanFactoryBeanFactoryæ˜¯Springæ¡†æ¶ä¸­æœ€åŸºç¡€çš„IOCå®¹å™¨ã€‚å®ƒæä¾›äº†åŸºæœ¬çš„ä¾èµ–æ³¨å…¥æœºåˆ¶ï¼Œè´Ÿè´£ç®¡ç†Beançš„å®ä¾‹åŒ–ã€é…ç½®å’Œç”Ÿå‘½å‘¨æœŸã€‚ 1.2 ApplicationContextApplicationContextæ˜¯åœ¨BeanFactoryåŸºç¡€ä¸Šæ‰©å±•çš„é«˜çº§å®¹å™¨ï¼Œæä¾›äº†æ›´å¤šé¢å‘åº”ç”¨çš„åŠŸèƒ½ï¼Œå®ƒè¿˜æä¾›äº†å›½é™…åŒ–æ”¯æŒå’Œæ¡†æ¶äº‹ä»¶ä½“ç³»ï¼Œæ›´æ˜“äºåˆ›å»ºå®é™…åº”ç”¨ã€‚ ä¸€èˆ¬ç§°BeanFactoryä¸ºIoCå®¹å™¨ï¼Œè€Œç§°ApplicationContextä¸ºåº”ç”¨ä¸Šä¸‹æ–‡ã€‚ä½†æœ‰æ—¶ä¸ºäº†è¡Œæ–‡æ–¹ä¾¿ï¼Œä¹Ÿå°†ApplicationContextç§°ä¸ºSpringå®¹å™¨ã€‚ 2.2 ApplicationContextçš„å…·ä½“å®ç°åŠå…¶åŠŸèƒ½ ClassPathXmlApplicationContextï¼šä»ç±»è·¯å¾„ä¸‹çš„XMLé…ç½®æ–‡ä»¶åŠ è½½ä¸Šä¸‹æ–‡ã€‚ FileSystemXmlApplicationContextï¼šä»æ–‡ä»¶ç³»ç»Ÿä¸­çš„XMLé…ç½®æ–‡ä»¶åŠ è½½ä¸Šä¸‹æ–‡ã€‚ AnnotationConfigApplicationContextï¼šä»Javaé…ç½®ç±»åŠ è½½ä¸Šä¸‹æ–‡ã€‚ 2.2.1 ClassPathXmlApplicationContextä»ç±»è·¯å¾„ä¸‹çš„XMLé…ç½®æ–‡ä»¶ä¸­åŠ è½½Springåº”ç”¨ä¸Šä¸‹æ–‡ã€‚ 12ApplicationContext context = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;);MyBean myBean = context.getBean(MyBean.class); 2.2.2 FileSystemXmlApplicationContextä»æ–‡ä»¶ç³»ç»Ÿä¸­çš„XMLé…ç½®æ–‡ä»¶ä¸­åŠ è½½Springåº”ç”¨ä¸Šä¸‹æ–‡ã€‚ 12ApplicationContext context = new FileSystemXmlApplicationContext(&quot;C:/config/applicationContext.xml&quot;);MyBean myBean = context.getBean(MyBean.class); 2.2.3 WebApplicationContextWebApplicationContext æ˜¯ Spring æ¡†æ¶ä¸­ä¸“ä¸º Web åº”ç”¨è®¾è®¡çš„åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œå®ƒæ‰©å±•äº† ApplicationContextï¼Œæä¾›äº†ä¸ Web ç¯å¢ƒç›¸å…³çš„ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚åœ¨ Spring MVC ä¸­ï¼ŒWebApplicationContext æ‰®æ¼”ç€å…³é”®è§’è‰²ï¼Œé€šè¿‡é…ç½®æ§åˆ¶å™¨ã€è§†å›¾è§£æå™¨ç­‰ç»„ä»¶ï¼Œç®¡ç† Web è¯·æ±‚çš„å¤„ç†æµç¨‹ï¼Œè®¿é—® ServletContextã€è·å– Web åº”ç”¨å‚æ•°ç­‰ ä¸ Servlet å…³è”ï¼šWebApplicationContext å¯ä»¥è®¿é—® ServletContextï¼Œä»è€Œèƒ½å¤Ÿè·å– Web åº”ç”¨çš„ç¯å¢ƒå‚æ•°ã€‚ æ”¯æŒå›½é™…åŒ–ï¼šé€šè¿‡ Web ç¯å¢ƒçš„ MessageSourceï¼Œæ”¯æŒå›½é™…åŒ–æ¶ˆæ¯èµ„æºçš„è·å–ã€‚ ä¸ Spring MVC é›†æˆï¼šWebApplicationContext æ˜¯ Spring MVC çš„æ ¸å¿ƒç»„ä»¶ï¼Œç”¨äºé…ç½®å’Œç®¡ç†æ§åˆ¶å™¨ã€è§†å›¾è§£æå™¨ç­‰ MVC ç»„ä»¶ã€‚ åœ¨ä¼ ç»ŸSpringåº”ç”¨ä¸­ï¼ŒWebApplicationContextç»å¸¸ä¸XMLé…ç½®ä¸€èµ·ä½¿ç”¨ï¼Œé€šè¿‡ContextLoaderListeneræˆ–ContextLoaderServletæ¥åˆå§‹åŒ–å’Œç®¡ç† 2.2.4 AnnotationConfigApplicationContextä»Javaé…ç½®ç±»ä¸­åŠ è½½Springåº”ç”¨ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒåŸºäºæ³¨è§£çš„é…ç½®ã€‚ 1234567891011@Configuration@ComponentScan(basePackages = &quot;com.example&quot;)public class AppConfig &#123; @Bean public MyBean myBean() &#123; return new MyBean(); &#125;&#125;ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);MyBean myBean = context.getBean(MyBean.class); 2.3 BeanFactoryä¸ApplicationContextçš„è”ç³»å¯¹äºä¸¤è€…çš„ç”¨é€”ï¼Œå¯ä»¥è¿›è¡Œç®€å•åˆ’åˆ†ï¼šBeanFactoryæ˜¯Springæ¡†æ¶çš„åŸºç¡€è®¾æ–½ï¼Œé¢å‘Springæœ¬èº«ï¼›ApplicationContexté¢å‘ä½¿ç”¨Springæ¡†æ¶çš„å¼€å‘è€…ï¼Œå‡ ä¹æ‰€æœ‰çš„åº”ç”¨åœºåˆéƒ½ç›´æ¥ä½¿ç”¨ApplicationContextè€Œéåº•å±‚çš„BeanFactoryã€‚ å±‚æ¬¡å…³ç³»ï¼š ApplicationContextç»§æ‰¿äº†BeanFactoryçš„æ‰€æœ‰åŠŸèƒ½ï¼ŒåŒæ—¶æ‰©å±•äº†è®¸å¤šé«˜çº§åŠŸèƒ½ã€‚ BeanFactoryæä¾›äº†åŸºç¡€çš„IOCå®¹å™¨åŠŸèƒ½ï¼Œè€ŒApplicationContextåœ¨å…¶åŸºç¡€ä¸Šæä¾›äº†æ›´ä¸°å¯Œçš„ä¼ä¸šçº§åŠŸèƒ½ã€‚ ä½¿ç”¨æ–¹å¼ï¼š åœ¨å®é™…å¼€å‘ä¸­ï¼Œé€šå¸¸ç›´æ¥ä½¿ç”¨ApplicationContextï¼Œå› ä¸ºå®ƒæä¾›äº†æ›´å¼ºå¤§çš„åŠŸèƒ½å’Œæ›´å‹å¥½çš„å¼€å‘ä½“éªŒã€‚ BeanFactoryæ›´å¤šåœ°ç”¨äºåº•å±‚æ¡†æ¶çš„å®ç°å’Œä¸€äº›ç‰¹æ®Šçš„èµ„æºå—é™åœºæ™¯ã€‚ åˆå§‹åŒ–æ–¹å¼ï¼š BeanFactoryçš„beanæ˜¯æ‡’åŠ è½½çš„ï¼Œåªæœ‰åœ¨ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ‰ä¼šè¢«åˆå§‹åŒ–ã€‚ ApplicationContextçš„beané»˜è®¤åœ¨å¯åŠ¨æ—¶å°±ä¼šè¢«å…¨éƒ¨åˆå§‹åŒ–ã€‚ 3. Spring IOC å®¹å™¨çš„å¯åŠ¨è¿‡ç¨‹3.1 XML é…ç½®ä¸‹ Spring å®¹å™¨çš„å¯åŠ¨è¿‡ç¨‹åœ¨Spring Webåº”ç”¨ä¸­ï¼ŒSpring IOCå®¹å™¨ï¼ˆWebApplicationContextï¼‰çš„å¯åŠ¨å’Œåˆå§‹åŒ–æ˜¯ç”±Webå®¹å™¨ï¼ˆå¦‚Tomcatã€Jettyç­‰ï¼‰é©±åŠ¨çš„ã€‚ 3.1.1 ContextLoaderListenerContextLoaderListeneræ˜¯Springæ¡†æ¶ä¸­çš„ä¸€ä¸ªç›‘å¬å™¨ï¼Œç”¨äºåœ¨Webå®¹å™¨å¯åŠ¨æ—¶åˆ›å»ºå¹¶å¯åŠ¨Springçš„åº”ç”¨ä¸Šä¸‹æ–‡WebApplicationContextã€‚å®ƒä¸»è¦è´Ÿè´£ï¼š åˆ›å»ºå¹¶å¯åŠ¨Springçš„åº”ç”¨ä¸Šä¸‹æ–‡WebApplicationContext ç®¡ç†Springçš„æ ¹ä¸Šä¸‹æ–‡ï¼ˆRoot ApplicationContextï¼‰,ä½¿å…¶åœ¨æ•´ä¸ªWebåº”ç”¨ä¸­å¯ç”¨ã€‚ åœ¨åº”ç”¨å…³é—­æ—¶ï¼ˆcontextDestroyedæ–¹æ³•ï¼‰é”€æ¯ä¸Šä¸‹æ–‡ï¼Œæ­£ç¡®å…³é—­Springä¸Šä¸‹æ–‡ï¼Œé‡Šæ”¾èµ„æºã€‚ 123456789101112&lt;web-app&gt; &lt;!-- é…ç½® Spring çš„ ContextLoaderListener --&gt; &lt;listener&gt; &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt; &lt;/listener&gt; &lt;!-- é…ç½® Spring çš„åº”ç”¨ä¸Šä¸‹æ–‡æ–‡ä»¶ä½ç½® --&gt; &lt;context-param&gt; &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt; &lt;param-value&gt;/WEB-INF/applicationContext.xml&lt;/param-value&gt; &lt;/context-param&gt;&lt;/web-app&gt; å½“Webå®¹å™¨ï¼ˆå¦‚Tomcatã€Jettyç­‰ï¼‰å¯åŠ¨æ—¶ï¼ŒContextLoaderListenerä¼šç›‘å¬åˆ°å®¹å™¨çš„å¯åŠ¨äº‹ä»¶ï¼Œéšåæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š è¯»å–contextConfigLocationå‚æ•°ï¼šContextLoaderListenerè¯»å–web.xmlä¸­çš„contextConfigLocationå‚æ•°ï¼Œè·å–Springé…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚ åŠ è½½Springé…ç½®æ–‡ä»¶ï¼šæ ¹æ®contextConfigLocationå‚æ•°æŒ‡å®šçš„ä½ç½®ï¼ŒåŠ è½½Springçš„é…ç½®æ–‡ä»¶ã€‚é€šå¸¸ï¼Œè¿™äº›æ–‡ä»¶æ˜¯XMLæ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ç±»å‹çš„é…ç½®æ–‡ä»¶ï¼Œå¦‚Javaé…ç½®ç±»ã€‚ åˆå§‹åŒ–WebApplicationContextï¼šåˆ›å»ºå¹¶åˆå§‹åŒ–WebApplicationContextï¼ŒåŠ è½½é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰beanå®šä¹‰ï¼Œå¹¶è¿›è¡Œä¾èµ–æ³¨å…¥å’Œåˆå§‹åŒ–ã€‚ æ³¨å†Œä¸Šä¸‹æ–‡ï¼šå°†åˆ›å»ºçš„WebApplicationContextæ³¨å†Œåˆ°ServletContextä¸­ï¼Œä½¿å…¶åœ¨æ•´ä¸ªWebåº”ç”¨ä¸­å¯ç”¨ã€‚å±æ€§åä¸ºWebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTEã€‚3.1.2 ContextLoaderServlet ContextLoaderServletæ˜¯Springæ¡†æ¶ä¸­çš„ä¸€ä¸ªServletï¼Œç”¨äºåœ¨Servletåˆå§‹åŒ–æ—¶å¯åŠ¨Springçš„WebApplicationContextã€‚ä¸ContextLoaderListenerç±»ä¼¼ï¼Œå®ƒè´Ÿè´£ï¼š åŠ è½½Springçš„åº”ç”¨ä¸Šä¸‹æ–‡ã€‚ ç®¡ç†Springçš„æ ¹ä¸Šä¸‹æ–‡ï¼ˆRoot ApplicationContextï¼‰ï¼Œä½¿å…¶åœ¨æ•´ä¸ªWebåº”ç”¨ä¸­å¯ç”¨ã€‚ åœ¨Servleté”€æ¯æ—¶ï¼Œæ­£ç¡®å…³é—­Springä¸Šä¸‹æ–‡ï¼Œé‡Šæ”¾èµ„æºã€‚ ä»¥ä¸‹æ˜¯åœ¨web.xmlä¸­é…ç½®ContextLoaderServletçš„ç¤ºä¾‹ï¼š1234567891011121314&lt;web-app&gt; &lt;!-- é…ç½® Spring çš„ ContextLoaderServlet --&gt; &lt;servlet&gt; &lt;servlet-name&gt;contextLoader&lt;/servlet-name&gt; &lt;servlet-class&gt;org.springframework.web.context.ContextLoaderServlet&lt;/servlet-class&gt; &lt;load-on-startup&gt;1&lt;/load-on-startup&gt; &lt;/servlet&gt; &lt;!-- é…ç½® Spring çš„åº”ç”¨ä¸Šä¸‹æ–‡æ–‡ä»¶ä½ç½® --&gt; &lt;context-param&gt; &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt; &lt;param-value&gt;/WEB-INF/applicationContext.xml&lt;/param-value&gt; &lt;/context-param&gt;&lt;/web-app&gt; å½“Webå®¹å™¨ï¼ˆå¦‚Tomcatã€Jettyç­‰ï¼‰å¯åŠ¨æ—¶ï¼ŒContextLoaderServletä¼šåœ¨Servletåˆå§‹åŒ–é˜¶æ®µæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š è¯»å–contextConfigLocationå‚æ•°ï¼šContextLoaderServletè¯»å–web.xmlä¸­çš„contextConfigLocationå‚æ•°ï¼Œè·å–Springé…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚ åŠ è½½Springé…ç½®æ–‡ä»¶ï¼šæ ¹æ®contextConfigLocationå‚æ•°æŒ‡å®šçš„ä½ç½®ï¼ŒåŠ è½½Springçš„é…ç½®æ–‡ä»¶ã€‚é€šå¸¸ï¼Œè¿™äº›æ–‡ä»¶æ˜¯XMLæ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ç±»å‹çš„é…ç½®æ–‡ä»¶ï¼Œå¦‚Javaé…ç½®ç±»ã€‚ åˆå§‹åŒ–WebApplicationContextï¼šåˆ›å»ºå¹¶åˆå§‹åŒ–WebApplicationContextï¼ŒåŠ è½½é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰beanå®šä¹‰ï¼Œå¹¶è¿›è¡Œä¾èµ–æ³¨å…¥å’Œåˆå§‹åŒ–ã€‚ æ³¨å†Œä¸Šä¸‹æ–‡ï¼šå°†åˆ›å»ºçš„WebApplicationContextæ³¨å†Œåˆ°ServletContextä¸­ï¼Œä½¿å…¶åœ¨æ•´ä¸ªWebåº”ç”¨ä¸­å¯ç”¨ã€‚ Servletç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šContextLoaderServletåœ¨initæ–¹æ³•ä¸­å¯åŠ¨Springä¸Šä¸‹æ–‡ï¼Œåœ¨destroyæ–¹æ³•ä¸­å…³é—­ä¸Šä¸‹æ–‡ã€‚3.1.3 ContextLoaderListener vs ContextLoaderServlet ContextLoaderListeneræ˜¯å¯åŠ¨Spring WebApplicationContextçš„æœ€å¸¸ç”¨æ–¹å¼ï¼Œé€‚ç”¨äºå¤§å¤šæ•°Webåº”ç”¨ã€‚ContextLoaderServletè¾ƒå°‘ä½¿ç”¨ï¼Œé€šå¸¸ç”¨äºéœ€è¦ç²¾ç»†æ§åˆ¶ä¸Šä¸‹æ–‡å¯åŠ¨é¡ºåºçš„ç‰¹æ®Šåœºæ™¯ã€‚ 3.2 Springbooté¡¹ç›® IOC å®¹å™¨çš„å¯åŠ¨è¿‡ç¨‹å¯¹äºWebåº”ç”¨ï¼ŒSpring Bootä½¿ç”¨AnnotationConfigServletWebServerApplicationContextä½œä¸ºApplicationContextã€‚è¿™æ˜¯AnnotationConfigApplicationContextçš„ä¸€ä¸ªæ´¾ç”Ÿç±»ï¼Œä¸“é—¨ç”¨äºWebåº”ç”¨ç¨‹åºã€‚ åˆ›å»ºSpringApplicationå®ä¾‹ æ ¹æ®åˆé€‚çš„åº”ç”¨ç±»å‹ç¡®å®šApplicationContextç±» åŠ è½½é…ç½®å’Œåˆå§‹åŒ– å¯åŠ¨åµŒå…¥å¼WebæœåŠ¡å™¨ï¼ˆå¦‚æœæ˜¯Webåº”ç”¨ï¼‰ Spring Boot åº”ç”¨çš„å¯åŠ¨è¿‡ç¨‹é€šå¸¸ä»ä¸€ä¸ªåŒ…å« main æ–¹æ³•çš„ç±»å¼€å§‹ï¼Œè¯¥ç±»ä½¿ç”¨äº† @SpringBootApplication æ³¨è§£ï¼š 123456@SpringBootApplicationpublic class MySpringBootApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(MySpringBootApplication.class, args); &#125;&#125; @SpringBootApplication æ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼ŒåŒ…å«äº†ä»¥ä¸‹ä¸‰ä¸ªæ³¨è§£ï¼š @SpringBootConfigurationï¼šæ ‡è¯†è¿™æ˜¯ä¸€ä¸ª Spring Boot é…ç½®ç±»ã€‚ @EnableAutoConfigurationï¼šå¯ç”¨ Spring Boot çš„è‡ªåŠ¨é…ç½®æœºåˆ¶ã€‚ @ComponentScanï¼šå¯ç”¨ç»„ä»¶æ‰«æï¼Œè‡ªåŠ¨å‘ç°å¹¶æ³¨å†Œè¢« @Componentã€@Serviceã€@Repositoryã€@Controller ç­‰æ³¨è§£æ ‡è¯†çš„ Spring Beanã€‚ SpringApplication.run æ–¹æ³•æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š å‡†å¤‡ç¯å¢ƒï¼šåˆ›å»ºå¹¶é…ç½® Environmentï¼ŒåŠ è½½åº”ç”¨é…ç½®æ–‡ä»¶ï¼ˆå¦‚ application.propertiesï¼‰ã€‚ åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡ï¼šåˆ›å»ºåˆé€‚çš„ ApplicationContext å®ä¾‹ï¼ˆå¦‚ AnnotationConfigServletWebServerApplicationContext ç”¨äº Web åº”ç”¨ï¼‰ã€‚ è‡ªåŠ¨é…ç½®ï¼šæ ¹æ®ç±»è·¯å¾„ä¸­çš„ä¾èµ–å’Œåº”ç”¨é…ç½®ï¼Œè‡ªåŠ¨é…ç½® Spring åº”ç”¨ç»„ä»¶ã€‚ åˆ·æ–°ä¸Šä¸‹æ–‡ï¼šåˆå§‹åŒ– Spring åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œæ‰«æå’Œæ³¨å†Œæ‰€æœ‰ Spring Beanã€‚ å¯åŠ¨åµŒå…¥å¼æœåŠ¡å™¨ï¼šå¦‚æœæ˜¯ Web åº”ç”¨ï¼Œå¯åŠ¨åµŒå…¥å¼ Web æœåŠ¡å™¨ï¼ˆå¦‚ Tomcatï¼‰ã€‚ è¿è¡Œåº”ç”¨ï¼šå¯åŠ¨åº”ç”¨å¹¶å¤„ç†æ‰€æœ‰å®šä¹‰çš„ CommandLineRunner å’Œ ApplicationRunner å®ç°ã€‚ 3.3 Spring Boot vs ä¼ ç»Ÿ Spring å¯åŠ¨æ–¹å¼3.3.1 é…ç½®ç®€åŒ– ä¼ ç»Ÿ Springï¼šé€šå¸¸éœ€è¦å¤§é‡çš„ XML é…ç½®æ–‡ä»¶æˆ– Java é…ç½®ç±»æ¥å®šä¹‰ Bean å’Œä¾èµ–å…³ç³»ã€‚ Spring Bootï¼šé€šè¿‡è‡ªåŠ¨é…ç½®å’Œçº¦å®šä¼˜äºé…ç½®ï¼Œæå¤§åœ°ç®€åŒ–äº†é…ç½®ï¼Œåªéœ€å°‘é‡é…ç½®æ–‡ä»¶æˆ–æ³¨è§£ã€‚3.3.2 åµŒå…¥å¼æœåŠ¡å™¨ ä¼ ç»Ÿ Springï¼šé€šå¸¸éœ€è¦åœ¨å¤–éƒ¨ Web æœåŠ¡å™¨ï¼ˆå¦‚ Tomcatï¼‰ä¸­éƒ¨ç½²åº”ç”¨ã€‚ Spring Bootï¼šæ”¯æŒåµŒå…¥å¼æœåŠ¡å™¨ï¼Œåº”ç”¨å¯ä»¥æ‰“åŒ…ä¸ºä¸€ä¸ªå¯æ‰§è¡Œçš„ JAR æ–‡ä»¶ï¼Œç›´æ¥è¿è¡Œã€‚ 3.3.3 å¯åŠ¨é€Ÿåº¦ ä¼ ç»Ÿ Springï¼šå¯åŠ¨è¿‡ç¨‹è¾ƒä¸ºç¹çï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®å’Œç®¡ç†è®¸å¤šç»„ä»¶ã€‚ Spring Bootï¼šå¯åŠ¨è¿‡ç¨‹é«˜åº¦è‡ªåŠ¨åŒ–ï¼Œå¯åŠ¨é€Ÿåº¦æ›´å¿«ï¼Œå¼€å‘ä½“éªŒæ›´å¥½ã€‚ Spring IOC å®¹å™¨ç®¡ç†ç€ Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ§åˆ¶ç€ Bean çš„ä¾èµ–æ³¨å…¥ã€‚ ä¸Šé¢ä»‹ç»å®Œäº†Spring IOC å®¹å™¨ï¼Œ ä¸‹é¢å°±æ¥ä»‹ç»ä¸€ä¸‹å®ƒç®¡ç†çš„ bean ä¸€äº›ç›¸å…³åŸºç¡€çŸ¥è¯†ã€‚ 4. Bean å®šä¹‰æ–¹å¼ä¸ç®¡æ˜¯XMLè¿˜æ˜¯æ³¨è§£ï¼Œå®ƒä»¬éƒ½æ˜¯è¡¨è¾¾Beanå®šä¹‰çš„è½½ä½“ï¼Œå…¶å®è´¨éƒ½æ˜¯ä¸ºSpring IOCå®¹å™¨æä¾›Beanå®šä¹‰çš„ä¿¡æ¯ 4.1 XML é…ç½®1234567891011&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt; &lt;bean id=&quot;myBean&quot; class=&quot;com.example.MyBean&quot;&gt; &lt;property name=&quot;property&quot; value=&quot;value&quot;/&gt; &lt;/bean&gt; &lt;/beans&gt; 4.2 åŸºäºæ³¨è§£çš„é…ç½®Springä»2.0å¼€å§‹å¼•å…¥åŸºäºæ³¨è§£çš„é…ç½®æ–¹å¼ï¼Œåœ¨3.1æ—¶å¾—åˆ°äº†è¿›ä¸€æ­¥çš„å®Œå–„ã€‚å¸¸è§çš„æ³¨è§£åŒ…æ‹¬ @Componentã€@Serviceã€@Repository å’Œ @Controllerï¼Œè¿™äº›æ³¨è§£å°†ç±»å£°æ˜ä¸º Spring ç®¡ç†çš„ Beanã€‚1234@Componentpublic class MyBean &#123; // class definition&#125; @Componentï¼šé€šç”¨æ³¨è§£ï¼Œé€‚ç”¨äºæ‰€æœ‰å±‚æ¬¡çš„ç±»ï¼Œç”¨äºå°†ç±»æ ‡è¯†ä¸º Spring å®¹å™¨ç®¡ç†çš„Beanã€‚åœ¨å®é™…å¼€å‘ä¸­ä¹Ÿå¯ä»¥é€‰æ‹©æ›´å…·ä½“çš„æ³¨è§£æ¥æ ‡è¯†ä¸åŒå±‚æ¬¡çš„ç»„ä»¶ @Repositoryï¼šæ•°æ®è®¿é—®å±‚ï¼Œç”¨äºå¯¹DAOå®ç°ç±»è¿›è¡Œæ ‡æ³¨ã€‚ @Serviceï¼šæ•°æ®è®¿é—®å±‚ï¼Œç”¨äºå¯¹Serviceå®ç°ç±»è¿›è¡Œæ ‡æ³¨ã€‚ @Controllerï¼šæ§åˆ¶å™¨å±‚ï¼Œç”¨äºå¯¹Controllerå®ç°ç±»è¿›è¡Œæ ‡æ³¨ã€‚ 4.3 åŸºäº Java ç±»çš„é…ç½® Java ConfigJava Config æ˜¯é€šè¿‡ä½¿ç”¨ @Configuration æ³¨è§£çš„ç±»æ¥å®šä¹‰ Spring å®¹å™¨çš„é…ç½®ã€‚è¿™æ ·çš„ç±»å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª @Bean æ³¨è§£çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•çš„è¿”å›å€¼ä¼šè¢« Spring å®¹å™¨æ³¨å†Œä¸º Beanã€‚ @Configuration ç±»æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ @Componentï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†å®šä¹‰ Beanã€‚ æ‰€ä»¥ä»»ä½•æ ‡æ³¨äº†@Configurationçš„ç±»ï¼Œæœ¬èº«ä¹Ÿç›¸å½“äºæ ‡æ³¨äº†@Componentï¼Œå³å®ƒä»¬å¯ä»¥åƒæ™®é€šçš„Beanä¸€æ ·è¢«æ³¨å…¥å…¶ä»–Beanä¸­ã€‚ 1234567891011import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;@Configurationpublic class AppConfig &#123; @Bean public MyService myService() &#123; return new MyServiceImpl(); &#125;&#125; ä½¿ç”¨ç¤ºä¾‹: é…ç½®æ•°æ®æºå’Œ JPAå¯¹äºæ•°æ®è®¿é—®å±‚ï¼Œå¯ä»¥é€šè¿‡ Java Config æ¥é…ç½®æ•°æ®æºï¼ˆDataSourceï¼‰ã€å®ä½“ç®¡ç†å™¨å·¥å‚ï¼ˆEntityManagerFactoryï¼‰å’Œäº‹åŠ¡ç®¡ç†å™¨ï¼ˆTransactionManagerï¼‰ã€‚ 12345678910111213141516171819202122232425262728293031323334353637import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.jdbc.datasource.DriverManagerDataSource;import org.springframework.orm.jpa.JpaTransactionManager;import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;import org.springframework.transaction.PlatformTransactionManager;import javax.persistence.EntityManagerFactory;import javax.sql.DataSource;@Configurationpublic class DataConfig &#123; @Bean public DataSource dataSource() &#123; DriverManagerDataSource dataSource = new DriverManagerDataSource(); dataSource.setDriverClassName(&quot;com.mysql.cj.jdbc.Driver&quot;); dataSource.setUrl(&quot;jdbc:mysql://localhost:3306/mydb&quot;); dataSource.setUsername(&quot;user&quot;); dataSource.setPassword(&quot;password&quot;); return dataSource; &#125; @Bean public LocalContainerEntityManagerFactoryBean entityManagerFactory(DataSource dataSource) &#123; LocalContainerEntityManagerFactoryBean em = new LocalContainerEntityManagerFactoryBean(); em.setDataSource(dataSource); em.setPackagesToScan(&quot;com.example.myapp.model&quot;); // Other JPA properties can be set here return em; &#125; @Bean public PlatformTransactionManager transactionManager(EntityManagerFactory emf) &#123; JpaTransactionManager transactionManager = new JpaTransactionManager(); transactionManager.setEntityManagerFactory(emf); return transactionManager; &#125;&#125; 5.Beanä¾èµ–å…³ç³»å£°æ˜æ–¹å¼Bean ä¹‹é—´çš„ä¾èµ–å…³ç³»å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è¿›è¡Œå£°æ˜å’Œç®¡ç†ï¼Œä»¥å®ç°ä¾èµ–æ³¨å…¥ï¼ˆDependency Injection, DIï¼‰ æ— è®ºæ˜¯ XML é…ç½®è¿˜æ˜¯åŸºäºæ³¨è§£çš„é…ç½®ï¼Œéƒ½å¯ä»¥å½’ç±»ä¸ºä»¥ä¸‹ä¸‰ç§ä¸»è¦çš„ä¾èµ–æ³¨å…¥æ–¹å¼ï¼šåŸºäºæ„é€ å‡½æ•°ã€åŸºäº Setter æ–¹æ³•å’ŒåŸºäºå­—æ®µ 5.1 åŸºäºæ„é€ å‡½æ•°çš„ä¾èµ–æ³¨å…¥æ„é€ å‡½æ•°æ³¨å…¥æ˜¯é€šè¿‡åœ¨æ„é€ å‡½æ•°ä¸­å£°æ˜ä¾èµ–æ¥è¿›è¡Œæ³¨å…¥çš„ï¼Œè¿™ç§æ–¹å¼æœ‰åŠ©äºç¡®ä¿ä¾èµ–å…³ç³»åœ¨å¯¹è±¡åˆ›å»ºæ—¶å°±å·²ç»å®Œå…¨æ»¡è¶³ã€‚ XML é…ç½®ï¼šé€šè¿‡ &lt;constructor-arg&gt; å…ƒç´ ã€‚ æ³¨è§£é…ç½®ï¼šé€šè¿‡åœ¨æ„é€ å‡½æ•°ä¸Šä½¿ç”¨ @Autowired æ³¨è§£ã€‚ 5.1.1 XML é…ç½®åœ¨ XML é…ç½®ä¸­ï¼Œé€šè¿‡ &lt;constructor-arg&gt; å…ƒç´ æ¥æŒ‡å®šæ„é€ å‡½æ•°å‚æ•°çš„ä¾èµ–æ³¨å…¥1234&lt;bean id=&quot;myRepository&quot; class=&quot;com.example.MyRepositoryImpl&quot; /&gt;&lt;bean id=&quot;myService&quot; class=&quot;com.example.MyService&quot;&gt; &lt;constructor-arg ref=&quot;myRepository&quot; /&gt;&lt;/bean&gt; 5.1.2 åŸºäºæ³¨è§£é…ç½®é€šè¿‡ @Autowired æ³¨è§£åœ¨æ„é€ å‡½æ•°ä¸Šæ ‡æ³¨ã€‚ 12345678910@Componentpublic class MyService &#123; private MyRepository myRepository; @Autowired public MyService(MyRepository myRepository) &#123; this.myRepository = myRepository; &#125; // Business methods&#125; 5.2 åŸºäº Setter æ–¹æ³•çš„DI XML é…ç½®ï¼šé€šè¿‡ &lt;property&gt; å…ƒç´ ã€‚ æ³¨è§£é…ç½®ï¼šé€šè¿‡åœ¨ Setter æ–¹æ³•ä¸Šä½¿ç”¨ @Autowired æ³¨è§£ã€‚5.2.1 XML é…ç½®é€šè¿‡ &lt;property&gt; å…ƒç´ æ¥é…ç½® Setter æ–¹æ³•æ³¨å…¥ã€‚12345&lt;bean id=&quot;myRepository&quot; class=&quot;com.example.MyRepositoryImpl&quot; /&gt;&lt;bean id=&quot;myService&quot; class=&quot;com.example.MyService&quot;&gt; &lt;property name=&quot;myRepository&quot; ref=&quot;myRepository&quot; /&gt;&lt;/bean&gt; 5.2.2 åŸºäºæ³¨è§£é…ç½®123456789@Componentpublic class MyService &#123; private MyRepository myRepository; @Autowired public void setMyRepository(MyRepository myRepository) &#123; this.myRepository = myRepository; &#125;&#125; 5.3 åŸºäºå­—æ®µçš„ä¾èµ–æ³¨å…¥å­—æ®µæ³¨å…¥æ˜¯ç›´æ¥åœ¨ç±»çš„å­—æ®µä¸Šä½¿ç”¨ @Autowired æ³¨è§£æ¥æ ‡è¯†ä¾èµ–ã€‚è¿™ç§æ–¹å¼æœ€ä¸ºç®€æ´ï¼Œä½†XML é…ç½®é€šå¸¸ä¸æ¨èè¿™ç§æ–¹å¼ 5.3.1 åŸºäºæ³¨è§£é…ç½®ç›´æ¥åœ¨å­—æ®µä¸Šä½¿ç”¨ @Autowired æ³¨è§£ 1234567@Componentpublic class MyService &#123; @Autowired private MyRepository myRepository; // Business methods&#125; 6. Bean æ‰«ææ— è®ºæ˜¯ä½¿ç”¨ XML é…ç½®è¿˜æ˜¯åŸºäºæ³¨è§£çš„æ–¹å¼ï¼Œå®šä¹‰å¥½çš„ Bean å’ŒBean ä¹‹é—´çš„ä¾èµ–å…³ç³»éƒ½éœ€è¦é€šè¿‡ Spring çš„æ‰«ææœºåˆ¶æ‰èƒ½è¢« Spring å®¹å™¨è¯†åˆ«å¹¶ç®¡ç†,ä»è€Œèµ·ä½œç”¨ã€‚Bean æ‰«æä¸»è¦é€šè¿‡ä¸¤ç§æ–¹å¼å®ç°ï¼šåŸºäº XML é…ç½®å’ŒåŸºäºæ³¨è§£çš„æ–¹å¼ã€‚ 6.1 åŸºäº XML çš„ Bean æ‰«æåœ¨ Spring æ—©æœŸç‰ˆæœ¬ä¸­ï¼ŒXML é…ç½®æ˜¯ä¸€ç§å¸¸è§çš„é…ç½®æ–¹å¼ï¼Œé€šè¿‡ XML æ–‡ä»¶æŒ‡å®š Bean æ‰«æè·¯å¾„æ¥å®ç°è‡ªåŠ¨å‘ç°å’Œæ³¨å†Œ Beanã€‚ 6.1.1 ä½¿ç”¨ &lt;context:component-scan&gt; å…ƒç´ XML é…ç½®æ–‡ä»¶ä¸­çš„ &lt;context:component-scan&gt; å…ƒç´ ç”¨äºæŒ‡å®šåŒ…è·¯å¾„ï¼ŒSpring å®¹å™¨ä¼šæ‰«æè¿™äº›åŒ…è·¯å¾„ä¸‹çš„ç±»ï¼Œå¹¶æ ¹æ®æ³¨è§£è‡ªåŠ¨æ³¨å†Œä¸º Beanã€‚123456789101112&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt; &lt;!-- æ‰«ææŒ‡å®šåŒ…è·¯å¾„ä¸‹çš„æ‰€æœ‰ç»„ä»¶ç±» --&gt; &lt;context:component-scan base-package=&quot;com.example&quot; /&gt;&lt;/beans&gt; åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ&lt;context:component-scan&gt; å…ƒç´ ä¼šæ‰«æ com.example åŒ…åŠå…¶å­åŒ…ä¸­çš„æ‰€æœ‰ç±»ï¼Œå¹¶è‡ªåŠ¨æ³¨å†Œå¸¦æœ‰ @Componentã€@Serviceã€@Repositoryã€@Controller ç­‰æ³¨è§£çš„ç±»ä¸º Spring Beanã€‚ 6.1.2 æŒ‡å®šå¤šä¸ªåŒ…è·¯å¾„å¯ä»¥é€šè¿‡é€—å·åˆ†éš”çš„æ–¹å¼æŒ‡å®šå¤šä¸ªåŒ…è·¯å¾„ã€‚1&lt;context:component-scan base-package=&quot;com.example, com.anotherexample&quot; /&gt; 6.2 åŸºäºæ³¨è§£çš„ Bean æ‰«æï¼ˆSpring Bootï¼‰Spring Boot é€šè¿‡è‡ªåŠ¨é…ç½®å’Œæ³¨è§£çš„æ–¹å¼ï¼Œç®€åŒ–äº† Bean æ‰«æçš„é…ç½®è¿‡ç¨‹ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œåªéœ€åœ¨ä¸»å¯åŠ¨ç±»ä¸Šæ·»åŠ ä¸€äº›æ³¨è§£ï¼Œå³å¯å®Œæˆ Bean æ‰«æçš„é…ç½®ã€‚ è‡ªå®šä¹‰æ‰«æçš„åŒ…è·¯å¾„ï¼Œå¹¶å¯ä»¥æ˜¾å¼ä½¿ç”¨ @ComponentScan æ³¨è§£ã€‚123456789101112import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;import org.springframework.context.annotation.ComponentScan;@SpringBootApplication@ComponentScan(basePackages = &quot;com.example&quot;)public class MyApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(MyApplication.class, args); &#125;&#125; å¦‚æœä¸æ˜¾ç¤ºä½¿ç”¨@ComponentScan ï¼Œå…¶å®@SpringBootApplicationæ³¨è§£ æ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼ŒåŒ…å«äº† @ComponentScanï¼Œä½†æ˜¯æ™ºæ…§é»˜è®¤ä¼šæ‰«æä¸»å¯åŠ¨ç±»æ‰€åœ¨åŒ…åŠå…¶å­åŒ…ä¸­çš„æ‰€æœ‰ç»„ä»¶ç±»ã€‚ åŒæ ·å¯ä»¥æŒ‡å®šå¤šä¸ªåŒ…è·¯å¾„ã€‚1@ComponentScan(basePackages = &#123;&quot;com.example&quot;, &quot;com.anotherexample&quot;&#125;)","tags":["Java","Spring"]},{"title":"JavaåŠ¨æ€ä»£ç†","path":"/abd111cb/","content":"å­¦ä¹ åŠ¨æ€ä»£ç†å‰ï¼Œå»ºè®®å…ˆå­¦ä¹ ä¸‹Java åå°„ åœ¨Javaä¸­ï¼ŒåŠ¨æ€ä»£ç†æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå®ƒå…è®¸åœ¨è¿è¡Œæ—¶åˆ›å»ºä»£ç†ç±»å’Œä»£ç†å¯¹è±¡ï¼Œä»è€Œåœ¨æ–¹æ³•è°ƒç”¨æ—¶åŠ¨æ€åœ°æ·»åŠ è¡Œä¸ºã€‚å¯ä»¥åœ¨ä¸ä¿®æ”¹ç›®æ ‡å¯¹è±¡ä»£ç çš„æƒ…å†µä¸‹ï¼Œä¸ºå¯¹è±¡æä¾›é¢å¤–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ—¥å¿—è®°å½•ã€äº‹åŠ¡ç®¡ç†ã€å®‰å…¨æ£€æŸ¥ç­‰ã€‚Java ä¸­æœ‰2ç§åŠ¨æ€ä»£ç†å®ç°ï¼Œ JDK åŠ¨æ€ä»£ç† CGLIB åŠ¨æ€ä»£ç†ä¸‹é¢å°†ä»å®é™…ä»£ç å‡ºå‘ï¼Œå¯¹å…¶å®ç°åŸç†è¿›è¡Œè§£é‡Š 1.JDK åŠ¨æ€ä»£ç†JDK åŠ¨æ€ä»£ç†æ˜¯ Java æ ‡å‡†åº“ä¸­æä¾›çš„ä¸€ç§ä»£ç†å®ç°æœºåˆ¶ï¼Œå®ƒä¸»è¦ä¾é  java.lang.reflect.Proxy ç±»å’Œ java.lang.reflect.InvocationHandler æ¥å£æ¥åˆ›å»ºå’Œç®¡ç†ä»£ç†å¯¹è±¡ã€‚ JDK åŠ¨æ€ä»£ç†åªèƒ½é€šè¿‡å®ç°æ¥å£çš„æ–¹å¼ç”Ÿæˆä»£ç†å¯¹è±¡ 1.1 ä»£ç ç¤ºä¾‹1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253public interface HelloWorld &#123; void sayHello(); void sayBye();&#125;public class HelloWorldImpl implements HelloWorld &#123; @Override public void sayHello() &#123; System.out.println(&quot;Hello, world!&quot;); &#125; @Override public void sayBye() &#123; System.out.println(&quot;Bye bye, world!&quot;); &#125;&#125;public class HelloWorldHandler implements InvocationHandler &#123; private Object target; public HelloWorldHandler(Object target) &#123; this.target = target; &#125; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; System.out.println(&quot;Before method: &quot; + method.getName()); Object result = method.invoke(target, args); System.out.println(&quot;After method: &quot; + method.getName()); return result; &#125;&#125;public class JdkDynamicProxyDemo &#123; public static void main(String[] args) &#123; HelloWorld helloWorld = new HelloWorldImpl(); HelloWorldHandler handler = new HelloWorldHandler(helloWorld); HelloWorld proxy = (HelloWorld) Proxy.newProxyInstance( helloWorld.getClass().getClassLoader(), helloWorld.getClass().getInterfaces(), handler); proxy.sayHello(); proxy.sayBye(); &#125;&#125; è¿è¡Œç»“æœå¦‚ä¸‹ æ¥ä¸‹æ¥è§£æProxyæºç  1.2 ç”Ÿæˆä»£ç†å¯¹è±¡-Proxy.newProxyInstance1234HelloWorld proxy = (HelloWorld) Proxy.newProxyInstance( helloWorld.getClass().getClassLoader(), helloWorld.getClass().getInterfaces(), handler); Proxy ç±» é€šè¿‡ç±»åŠ è½½å™¨å’Œæ¥å£é›†åˆåŠ¨æ€åœ°ç”Ÿæˆæˆ–æŸ¥æ‰¾ä»£ç†ç±»ï¼Œå¹¶ä½¿ç”¨æä¾›çš„InvocationHandleråˆ›å»ºä¸€ä¸ªæ–°çš„ä»£ç†å®ä¾‹ï¼Œ è¿›å…¥æºç çœ‹ä¸€ä¸‹ 1234567891011121314public class Proxy implements java.io.Serializable &#123; */ @CallerSensitive public static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h) &#123; Constructor&lt;?&gt; cons = getProxyConstructor(caller, loader, interfaces); return newProxyInstance(caller, cons, h); &#125;&#125; æˆ‘ä»¬å°†é‡ç‚¹åˆ†ænewProxyInstance è¿™ä¸ªæ–¹æ³•ï¼Œ è¿›å…¥æºç ï¼Œ è¯¥æ–¹æ³•ä¸»è¦æµç¨‹å¯ä»¥åˆ†ä¸º2ä¸ªæ­¥éª¤ï¼Œ éƒ½æ˜¯ä½¿ç”¨åå°„çš„å…¸å‹æ­¥éª¤ getProxyConstructor newProxyInstance 1.3 getProxyConstructorgetProxyConstructoræ˜¯ä¸€ä¸ªç§æœ‰æ–¹æ³•ï¼Œè´Ÿè´£è·å–æˆ–ç”Ÿæˆä»£ç†ç±»çš„æ„é€ å‡½æ•°ã€‚ 123456789101112131415161718192021222324252627282930public class Proxy implements java.io.Serializable &#123;\tprivate static Constructor&lt;?&gt; getProxyConstructor(Class&lt;?&gt; caller,ClassLoader loader,Class&lt;?&gt;... interfaces) &#123; // optimization for single interface if (interfaces.length == 1) &#123; Class&lt;?&gt; intf = interfaces[0]; if (caller != null) &#123; checkProxyAccess(caller, loader, intf); &#125; return proxyCache.sub(intf).computeIfAbsent( loader, (ld, clv) -&gt; new ProxyBuilder(ld, clv.key()).build() ); &#125; else &#123; // interfaces cloned final Class&lt;?&gt;[] intfsArray = interfaces.clone(); if (caller != null) &#123; checkProxyAccess(caller, loader, intfsArray); &#125; final List&lt;Class&lt;?&gt;&gt; intfs = Arrays.asList(intfsArray); return proxyCache.sub(intfs).computeIfAbsent( loader, (ld, clv) -&gt; new ProxyBuilder(ld, clv.key()).build() ); &#125; &#125;&#125; è·å–æ„é€ å‡½æ•°çš„è¿‡ç¨‹ï¼Œä½¿ç”¨åˆ°äº†ç¼“å­˜ä»¥æå‡æ€§èƒ½ è¿™é‡Œç›´æ¥è¿›å…¥build çœ‹æ–°åˆ›å»ºæµç¨‹ 12345678910111213141516Constructor&lt;?&gt; build() &#123; Class&lt;?&gt; proxyClass = defineProxyClass(module, interfaces); final Constructor&lt;?&gt; cons; try &#123; cons = proxyClass.getConstructor(constructorParams); &#125; catch (NoSuchMethodException e) &#123; throw new InternalError(e.toString(), e); &#125; AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() &#123; public Void run() &#123; cons.setAccessible(true); return null; &#125; &#125;); return cons; &#125; å•æ¥å£ä¼˜åŒ– å¤§å¤šæ•°å®é™…åº”ç”¨ä¸­ï¼Œä»£ç†é€šå¸¸åªéœ€è¦å®ç°ä¸€ä¸ªæ¥å£ï¼Œè¿™ç§æƒ…å†µæä¾›äº†ä¼˜åŒ–çš„æœºä¼šã€‚å•æ¥å£ä¼˜åŒ–çš„ä¸»è¦ç›®çš„æ˜¯å‡å°‘å¤„ç†æ—¶é—´å’Œç®€åŒ–ç”Ÿæˆä»£ç†ç±»çš„å¤æ‚åº¦ã€‚ checkProxyAccess: è¿™ä¸ªæ–¹æ³•æ£€æŸ¥è°ƒç”¨è€…æ˜¯å¦æœ‰æƒé™ä½¿ç”¨æŒ‡å®šçš„ç±»åŠ è½½å™¨åˆ›å»ºä»£ç†ã€‚è¿™æ˜¯ä¸€ä¸ªå®‰å…¨æ£€æŸ¥ï¼Œé˜²æ­¢å®‰å…¨æ¼æ´ã€‚ proxyCache.sub(intf).computeIfAbsent: è¿™æ˜¯ä¸€ä¸ªç¼“å­˜æœºåˆ¶ï¼Œå®ƒå°è¯•ä»ç¼“å­˜ä¸­è·å–ä»£ç†ç±»çš„æ„é€ å‡½æ•°ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨ProxyBuilderåˆ›å»ºä¸€ä¸ªæ–°çš„ä»£ç†ç±»ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ç¼“å­˜ä¸­ã€‚computeIfAbsentæ˜¯ä¸€ç§é«˜æ•ˆçš„ç¼“å­˜è®¿é—®æ¨¡å¼ï¼Œç¡®ä¿åªæœ‰åœ¨ç¼ºå°‘æ¡ç›®æ—¶æ‰æ„å»ºæ–°å€¼ã€‚ å¤šæ¥å£å¤„ç† å½“æœ‰å¤šä¸ªæ¥å£æ—¶ï¼Œæ–¹æ³•é¦–å…ˆå…‹éš†æ¥å£æ•°ç»„ï¼Œä»¥é¿å…ä¿®æ”¹åŸå§‹æ•°æ®ã€‚è¿™æ˜¯ä¸€ç§é˜²å¾¡æ€§ç¼–ç¨‹æŠ€å·§ï¼Œç¡®ä¿æ•°æ®çš„ä¸å¯å˜æ€§ã€‚ checkProxyAccessåŒæ ·æ‰§è¡Œï¼Œæ£€æŸ¥å®‰å…¨æƒé™ã€‚ ä½¿ç”¨å¤šæ¥å£çš„åˆ—è¡¨ä½œä¸ºç¼“å­˜é”®ï¼Œä¹Ÿé‡‡ç”¨computeIfAbsentæ–¹æ³•æ¥å°è¯•è·å–æˆ–åˆ›å»ºä»£ç†ç±»çš„æ„é€ å‡½æ•°ã€‚å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ç›¸åº”çš„æ„é€ å‡½æ•°ï¼Œä¼šè°ƒç”¨ProxyBuilderæ¥åŠ¨æ€ç”Ÿæˆä¸€ä¸ªæ–°çš„ä»£ç†ç±»ã€‚ 1.3.1 defineProxyClass -è·å–ä»£ç†ç±»çš„Classå¯¹è±¡1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283private static final class ProxyBuilder &#123; private static final Unsafe UNSAFE = Unsafe.getUnsafe(); // prefix for all proxy class names private static final String proxyClassNamePrefix = &quot;$Proxy&quot;; // next number to use for generation of unique proxy class names private static final AtomicLong nextUniqueNumber = new AtomicLong(); // a reverse cache of defined proxy classes private static final ClassLoaderValue&lt;Boolean&gt; reverseProxyCache = new ClassLoaderValue&lt;&gt;(); // interfaceséœ€è¦ä»£ç†çš„æ¥å£åˆ—è¡¨ private static Class&lt;?&gt; defineProxyClass(Module m, List&lt;Class&lt;?&gt;&gt; interfaces) &#123; // ä»£ç†ç±»çš„åŒ…åï¼Œåˆå§‹ä¸º nullã€‚ String proxyPkg = null; // ä»£ç†ç±»çš„è®¿é—®æ ‡å¿—ï¼Œåˆå§‹ä¸º PUBLIC | FINALã€‚ int accessFlags = Modifier.PUBLIC | Modifier.FINAL; // éå†æ¥å£åˆ—è¡¨ for (Class&lt;?&gt; intf : interfaces) &#123; int flags = intf.getModifiers(); // å¦‚æœæ¥å£ä¸æ˜¯publicï¼Œåˆ™è®¤ä¸ºæ˜¯åŒ…çº§ç§æœ‰çš„ã€‚å°† accessFlags è®¾ç½®ä¸º FINALï¼Œå¹¶è®°å½•åŒ…åã€‚ if (!Modifier.isPublic(flags)) &#123; accessFlags = Modifier.FINAL; // non-public, final String pkg = intf.getPackageName(); if (proxyPkg == null) &#123; proxyPkg = pkg; &#125; else if (!pkg.equals(proxyPkg)) &#123; // å¦‚æœæ‰€æœ‰épublicæ¥å£ä¸åœ¨åŒä¸€ä¸ªåŒ…ä¸­ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ throw new IllegalArgumentException( &quot;non-public interfaces from different packages&quot;); &#125; &#125; &#125; // ç¡®å®šä»£ç†ç±»çš„åŒ…å if (proxyPkg == null) &#123; // all proxy interfaces are public // PROXY_PACKAGE_PREFIX æ˜¯ â€œcom.sun.proxyâ€ proxyPkg = m.isNamed() ? PROXY_PACKAGE_PREFIX + &quot;.&quot; + m.getName() : PROXY_PACKAGE_PREFIX; &#125; else if (proxyPkg.isEmpty() &amp;&amp; m.isNamed()) &#123; throw new IllegalArgumentException( &quot;Unnamed package cannot be added to &quot; + m); &#125; if (m.isNamed()) &#123; if (!m.getDescriptor().packages().contains(proxyPkg)) &#123; throw new InternalError(proxyPkg + &quot; not exist in &quot; + m.getName()); &#125; &#125; /* * Choose a name for the proxy class to generate. */ // ä½¿ç”¨ä¸€ä¸ªå…¨å±€è®¡æ•°å™¨ç”Ÿæˆå”¯ä¸€çš„ä»£ç†ç±»åç§°ã€‚ long num = nextUniqueNumber.getAndIncrement(); String proxyName = proxyPkg.isEmpty() ? proxyClassNamePrefix + num : proxyPkg + &quot;.&quot; + proxyClassNamePrefix + num; // è·å–ç”¨äºåŠ è½½ä»£ç†ç±»çš„ç±»åŠ è½½å™¨ã€‚ ClassLoader loader = getLoader(m); trace(proxyName, m, loader, interfaces); /* * Generate the specified proxy class. */ // ä½¿ç”¨ ProxyGenerator ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç  byte[] proxyClassFile = ProxyGenerator.generateProxyClass( proxyName, interfaces.toArray(EMPTY_CLASS_ARRAY), accessFlags); try &#123; // å°†å­—èŠ‚ç è½¬æ¢ä¸º Class å¯¹è±¡å¹¶åŠ è½½åˆ° JVM ä¸­ Class&lt;?&gt; pc = UNSAFE.defineClass(proxyName, proxyClassFile, 0, proxyClassFile.length, loader, null); reverseProxyCache.sub(pc).putIfAbsent(loader, Boolean.TRUE); return pc; &#125; catch (ClassFormatError e) &#123; throw new IllegalArgumentException(e.toString()); &#125; &#125;&#125; 1.3.1.1 ä»£ç†ç±»åŒ…å-proxyPkgå…³äº proxyPkg çš„é€»è¾‘ï¼Œ ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼š å¦‚æœæœ‰åŒ…çº§ç§æœ‰æ¥å£ï¼šä»£ç†ç±»å¿…é¡»å®šä¹‰åœ¨è¿™äº›æ¥å£æ‰€åœ¨çš„åŒ…ä¸­ï¼Œä»¥ä¿è¯è®¿é—®æƒé™çš„ä¸€è‡´æ€§ã€‚å¦‚æœåŒ…çº§ç§æœ‰æ¥å£åˆ†å¸ƒåœ¨ä¸åŒçš„åŒ…ä¸­ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ å¦‚æœæ²¡æœ‰åŒ…çº§ç§æœ‰æ¥å£ï¼šå¦‚æœæ‰€æœ‰æ¥å£éƒ½æ˜¯å…¬å…±çš„ï¼ˆpublicï¼‰ï¼Œä»£ç†ç±»ä¼šé»˜è®¤å®šä¹‰åœ¨ com.sun.proxy åŒ…ä¸­ï¼Œæˆ–è€… com.sun.proxy.&lt;module_name&gt;ï¼ˆå¦‚æœæ¨¡å—è¢«å‘½åï¼‰ã€‚ è¿™ç§è®¾è®¡ç¡®ä¿äº†ä»£ç†ç±»ç”Ÿæˆæ—¶èƒ½å¤Ÿæ­£ç¡®å¤„ç†è®¿é—®æƒé™ï¼ŒåŒæ—¶æä¾›äº†ä¸€ä¸ªé»˜è®¤çš„å‘½åç©ºé—´ï¼ˆcom.sun.proxyï¼‰æ¥å­˜æ”¾å…¬å…±æ¥å£çš„ä»£ç†ç±»ã€‚ æ¥å£æƒé™çº§åˆ«åœ¨Javaä¸­ï¼Œç±»å’Œæ¥å£çš„æƒé™çº§åˆ«ä¸»è¦æœ‰ä»¥ä¸‹å››ç§ï¼ˆä½†æ¥å£åªä½¿ç”¨å…¶ä¸­ä¸¤ç§ public å’Œ Package-private ï¼‰ï¼š Publicï¼ˆå…¬å…±ï¼‰ï¼šä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è®¿é—®ã€‚ Protectedï¼ˆå—ä¿æŠ¤çš„ï¼‰ï¼šä¸èƒ½ç”¨äºé¡¶çº§ç±»æˆ–æ¥å£ï¼Œä»…ç”¨äºç±»çš„æˆå‘˜ï¼Œå…è®¸åŒåŒ…ä¸­çš„ç±»å’Œå­ç±»è®¿é—®ã€‚ Package-privateï¼ˆåŒ…çº§ç§æœ‰ï¼‰ï¼šå¦‚æœæ²¡æœ‰æŒ‡å®šè®¿é—®ä¿®é¥°ç¬¦ï¼Œè¡¨ç¤ºåªæœ‰åŒä¸€ä¸ªåŒ…ä¸­çš„ç±»å¯ä»¥è®¿é—®ã€‚ Privateï¼ˆç§æœ‰çš„ï¼‰ï¼šä¸èƒ½ç”¨äºé¡¶çº§ç±»æˆ–æ¥å£ï¼Œä»…ç”¨äºç±»çš„æˆå‘˜ï¼Œè¡¨ç¤ºåªæœ‰è¯¥ç±»æœ¬èº«å¯ä»¥è®¿é—®ã€‚ ä»£ç†ç±»å¿…é¡»èƒ½å¤Ÿè®¿é—®æ‰€æœ‰éœ€è¦ä»£ç†çš„æ¥å£ï¼Œæ‰èƒ½è¿›è¡Œå®ç°ã€‚ ç”Ÿæˆä»£ç†ç±»æ—¶ï¼Œå¦‚æœé‡åˆ°å¤šä¸ªépublicæ¥å£ï¼ˆåŒ…çº§ç§æœ‰æ¥å£ï¼‰ä½äºä¸åŒçš„åŒ…ä¸­ï¼Œä»£ç†ç±»å°†æ— æ³•åŒæ—¶è®¿é—®è¿™äº›æ¥å£ã€‚è¿™æ˜¯å› ä¸ºåŒ…çº§ç§æœ‰æ¥å£åªèƒ½åœ¨å®šä¹‰å®ƒä»¬çš„åŒ…å†…è®¿é—®ã€‚å› æ­¤ï¼Œå¿…é¡»ç¡®ä¿æ‰€æœ‰åŒ…çº§ç§æœ‰æ¥å£åœ¨åŒä¸€ä¸ªåŒ…ä¸­ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ åŒæ—¶å¦‚æœä»£ç†ç±»éœ€è¦å®ç°çš„æ¥å£ä¸­ï¼Œæœ‰åŒ…çº§ç§æœ‰ï¼ˆpackage-privateï¼‰æ¥å£ï¼Œé‚£ä¹ˆä»£ç†ç±»åº”è¯¥è¢«æ ‡è®°ä¸ºfinalï¼Œä¸èƒ½å†è¢«å…¶ä»–ç±»ç»§æ‰¿ã€‚ä»è€Œç¡®ä¿è¿™äº›åŒ…çº§ç§æœ‰æ¥å£çš„å®ç°ä¸ä¼šè¢«å…¶ä»–åŒ…ä¸­çš„ç±»ç»§æ‰¿å’Œä½¿ç”¨ï¼Œä»è€Œéµå¾ªä¸¥æ ¼çš„è®¿é—®æ§åˆ¶è§„åˆ™ã€‚ Modifier.PUBLIC | Modifier.FINALè¿™æ®µä»£ç è¡¨ç¤ºä¸€ä¸ªç»„åˆçš„è®¿é—®ä¿®é¥°ç¬¦ï¼Œå…¶ä¸­ | æ˜¯æŒ‰ä½æˆ–è¿ç®—ç¬¦ï¼Œå°†ä¸¤ä¸ªä¿®é¥°ç¬¦ç»„åˆåœ¨ä¸€èµ·ã€‚å…·ä½“æ¥è¯´ï¼š Modifier.PUBLICï¼šè¡¨ç¤ºå…¬å…±è®¿é—®ä¿®é¥°ç¬¦ï¼Œå€¼ä¸º 1ã€‚å…¬å…±ä¿®é¥°ç¬¦è¡¨ç¤ºè¯¥ç±»æˆ–æˆå‘˜å¯ä»¥è¢«ä»»ä½•å…¶ä»–ç±»è®¿é—®ã€‚ Modifier.FINALï¼šè¡¨ç¤ºæœ€ç»ˆä¿®é¥°ç¬¦ï¼Œå€¼ä¸º 16ã€‚æœ€ç»ˆä¿®é¥°ç¬¦è¡¨ç¤ºè¯¥ç±»ä¸èƒ½è¢«ç»§æ‰¿ï¼Œæˆ–è¯¥æ–¹æ³•ä¸èƒ½è¢«é‡å†™ï¼Œæˆ–è¯¥å­—æ®µçš„å€¼ä¸èƒ½è¢«æ›´æ”¹ã€‚ åœ¨å®šä¹‰ä»£ç†ç±»æ—¶ï¼Œé€šè¿‡æŒ‰ä½æˆ–è¿ç®—ç¬¦ |ï¼Œç»„åˆçš„ä¿®é¥°ç¬¦ Modifier.PUBLIC | Modifier.FINAL å¯ä»¥ç”¨äºç¡®ä¿ç”Ÿæˆçš„ä»£ç†ç±»æ˜¯å…¬å…±ä¸”ä¸å¯ç»§æ‰¿çš„ã€‚è¿™åœ¨åŠ¨æ€ä»£ç†ç”Ÿæˆè¿‡ç¨‹ä¸­éå¸¸é‡è¦ï¼Œç¡®ä¿ä»£ç†ç±»çš„æ­£ç¡®è®¿é—®çº§åˆ«å’Œä¸å¯å˜æ€§ã€‚ 1.3.1.2 ä»£ç†ç±»å…¨é™å®šå-proxyNameproxyName æŒ‡çš„æ˜¯ä»£ç†ç±»çš„å…¨é™å®šåï¼Œå…¨é™å®šååŒ…æ‹¬åŒ…åå’Œç±»åï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿ä»£ç†ç±»åœ¨ç±»åŠ è½½å™¨èŒƒå›´å†…çš„å”¯ä¸€æ€§ï¼Œå¹¶ä¸”ç¬¦åˆ Java ç±»å‘½åçš„è§„èŒƒã€‚ã€‚ æ ¹æ®ä»¥ä¸Šä»£ç ï¼Œå¯ä»¥çœ‹å‡ºå…¶ç”Ÿæˆé€»è¾‘ ç¡®å®šproxyPkg å…¨å±€è®¡æ•°å™¨ï¼ŒnextUniqueNumber æ˜¯ä¸€ä¸ªå…¨å±€çš„ AtomicLongï¼Œç”¨äºç”Ÿæˆå”¯ä¸€çš„æ•°å­—ã€‚getAndIncrement æ–¹æ³•ä¿è¯æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè¿”å›ä¸€ä¸ªå”¯ä¸€çš„æ•°å­—ï¼Œå¹¶å°†è®¡æ•°å™¨é€’å¢ã€‚ proxyPkgä¸ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼ŒproxyName é•¿è¿™æ ·ï¼Œ com.sun.proxy.Proxy0 æˆ– com.sun.proxy.module.Proxy0ï¼Œ å…¶ä¸­0å¯ä»¥æ›¿æ¢æˆé€’å¢çš„æ•°å­— 1.3.1.3 ä»£ç†ç±»å­—èŠ‚ç 1byte[] ProxyGenerator.generateProxyClass(String proxyName, Class&lt;?&gt;[] interfaces, int accessFlags) proxyNameï¼šä»£ç†ç±»çš„å…¨é™å®šå,å¦‚ com.sun.proxy.Proxy0ã€‚ interfacesï¼šä»£ç†ç±»éœ€è¦å®ç°çš„æ¥å£æ•°ç»„ã€‚ accessFlagsï¼šä»£ç†ç±»çš„è®¿é—®ä¿®é¥°ç¬¦, å¦‚ `Modifier.PUBLIC | Modifier.FINAL generateProxyClass æ–¹æ³•é€šè¿‡å­—èŠ‚ç ç”ŸæˆæŠ€æœ¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ä»£ç†ç±»çš„å­—èŠ‚ç  1.3.2 getConstructorè·å–ä»£ç†ç±»æ„é€ å‡½æ•°ï¼Œä¸”æ˜¯è·å–å‚æ•°ä¸ºInvocationHandler çš„æ„é€ å‡½æ•° 1.4 newProxyInstanceåœ¨åå°„ä¸­æŠ€æœ¯ä¸­ï¼Œç»å…¸çš„è·å–å®ä¾‹å¯¹è±¡çš„æ–¹æ³•å°±æ˜¯1cons.newInstance åœ¨å‰é¢çš„æ­¥éª¤ä¸­ï¼Œè·å–äº†å‚æ•°ä¸ºInvocationHandler çš„æ„é€ å‡½æ•° Constructor, é‚£ä¹ˆåœ¨å®ä¾‹åŒ–ä»£ç†å¯¹è±¡æ—¶ï¼Œ å°±éœ€è¦ä¼ å…¥ç±»å‹ä¸ºInvocationHandlerçš„å‚æ•°ï¼Œ è¿™é‡Œä¼ å…¥çš„æ˜¯å®ç°äº†InvocationHandler çš„HelloWorldHandlerã€‚ 1.5 æ‰§è¡Œä¸šåŠ¡ä»£ç 1proxy.sayHello(); è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œ ä¼šè¿›å…¥è‡ªå®šä¹‰çš„InvocationHandler çš„invoke æ–¹æ³•åœ¨invoke æ–¹æ³•ä¸­ï¼Œ å¯ä»¥æ·»åŠ è‡ªå®šä¹‰é€»è¾‘ï¼Œæ¯”å¦‚åœ¨AOP ä¸­ï¼Œå¯ä»¥æ·»åŠ å¢å¼º æ‰§è¡Œç›®æ ‡ç±»çš„çœŸæ­£æ–¹æ³• è‡³æ­¤ä»£ç†å¯¹è±¡å·²ç»ç”Ÿæˆï¼Œå¦‚æœç”¨ä¼ªä»£ç æ¥æè¿°è¿™ä¸ªä»£ç†å¯¹è±¡ 123456789101112131415161718192021222324252627public final class ProxyHelloWorld implements HelloWorld &#123; private final InvocationHandler handler; public ProxyHelloWorld(InvocationHandler handler) &#123; this.handler = handler; &#125; @Override public void sayHello() &#123; try &#123; Method method = HelloWorld.class.getMethod(&quot;sayHello&quot;) handler.invoke(this, method, null); &#125; catch (Throwable t) &#123; throw new RuntimeException(t); &#125; &#125; @Override public void sayBye() &#123; try &#123; Method method = HelloWorld.class.getMethod(&quot;sayBye&quot;); handler.invoke(this, method, null); &#125; catch (Throwable t) &#123; throw new RuntimeException(t); &#125; &#125;&#125; 1.6 åå°„åœ¨JDK åŠ¨æ€ä»£ç†ä¸­çš„åº”ç”¨æ ¹æ®ä»¥ä¸Šæºç å’Œç¤ºä¾‹ä»£ç†çš„åˆ†æï¼Œå¯ä»¥çœ‹åˆ° JDK åŠ¨æ€ä»£ç†å®Œå…¨åŸºäºåå°„è¿è¡Œã€‚ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š æ¥å£æ–¹æ³•çš„åŠ¨æ€å®ç°ï¼š é€šè¿‡ä½¿ç”¨Proxy.newProxyInstanceç”Ÿæˆçš„ä»£ç†ç±»ï¼Œå®é™…ä¸Šåœ¨å†…å­˜ä¸­åˆ›å»ºäº†ä¸€ä¸ªå®ç°äº†æŒ‡å®šæ¥å£çš„æ–°ç±»ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯å®Œå…¨åŠ¨æ€çš„ï¼Œåˆ©ç”¨åå°„æœºåˆ¶æŸ¥è¯¢æ¥å£æ–¹æ³•å¹¶åœ¨ä»£ç†ç±»ä¸­ç”Ÿæˆç›¸åº”çš„æ–¹æ³•å®ç°ã€‚ æ–¹æ³•è°ƒç”¨çš„æ‹¦æˆªï¼š InvocationHandlerçš„invokeæ–¹æ³•çš„å®ç°é€šå¸¸ä¼šä½¿ç”¨åå°„æ¥åŠ¨æ€è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ã€‚é€šè¿‡Methodå¯¹è±¡çš„invokeæ–¹æ³•ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶è°ƒç”¨ä»»ä½•å¯¹è±¡çš„ä»»æ„æ–¹æ³•ã€‚ ç±»å‹ä¿¡æ¯çš„åŠ¨æ€å¤„ç†ï¼š åå°„æœºåˆ¶å…è®¸åŠ¨æ€ä»£ç†åœ¨è¿è¡Œæ—¶æŸ¥è¯¢å…³äºç±»å’Œæ¥å£çš„å…ƒæ•°æ®ï¼ˆå¦‚æ–¹æ³•åã€å‚æ•°ç±»å‹ã€è¿”å›ç±»å‹ç­‰ï¼‰ï¼Œè¿™äº›ä¿¡æ¯å¯¹äºæ­£ç¡®è½¬å‘æ–¹æ³•è°ƒç”¨æ˜¯å¿…éœ€çš„ã€‚ 2. CGLIBåŠ¨æ€ä»£ç†CGLIBé€šè¿‡ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»æ¥å®ç°ä»£ç† å¯ä»¥ä»£ç†æ²¡æœ‰å®ç°æ¥å£çš„ç±»å’Œå®ç°äº†æ¥å£çš„ç±»ï¼Œ ç›¸æ¯”JDK åªèƒ½ä»£ç†å®ç°äº†æ¥å£çš„ç±»ï¼Œæœ‰è¾ƒå¼ºçš„çµæ´»æ€§ ä½†ä¸èƒ½ä»£ç†finalç±»å’Œfinalæ–¹æ³•ï¼Œå¹¶ä¸”æœ‰æ€§èƒ½å¼€é”€å’Œä¾èµ–CGLIBåº“çš„ç¼ºç‚¹ã€‚ 2.1 ä»£ç ç¤ºä¾‹123456789101112131415161718192021222324252627282930313233343536373839404142public interface HelloWorld &#123; void sayHello(); void sayBye(); &#125;public class HelloWorldImpl implements HelloWorld &#123; @Override public void sayHello() &#123; System.out.println(&quot;Hello, world!&quot;); &#125; @Override public void sayBye() &#123; System.out.println(&quot;Bye bye, world!&quot;); &#125; &#125;public class HelloWorldInterceptor implements MethodInterceptor &#123; @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable &#123; System.out.println(&quot;Before method: &quot; + method.getName()); Object result = proxy.invokeSuper(obj, args); System.out.println(&quot;After method: &quot; + method.getName()); return result; &#125; &#125;public class CglibDynamicProxyDemo &#123; public static void main(String[] args) &#123; Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(HelloWorldImpl.class); enhancer.setCallback(new HelloWorldInterceptor()); HelloWorld proxy = (HelloWorld) enhancer.create(); proxy.sayHello(); proxy.sayBye(); &#125; &#125; è¿è¡Œç»“æœå¦‚ä¸‹ 2.2 ç”Ÿæˆä»£ç†å¯¹è±¡ - EnhancerEnhancer ç±»ç”¨äºç”Ÿæˆä¸€ä¸ªç›®æ ‡ç±»çš„å­ç±»ï¼ˆå³ä»£ç†ç±»ï¼‰ï¼Œå¹¶é€šè¿‡åœ¨ä»£ç†ç±»ä¸­æ‹¦æˆªæ–¹æ³•è°ƒç”¨æ¥å®ç°åŠ¨æ€ä»£ç†ã€‚è¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬æŒ‡å®šè¦ä»£ç†çš„ç›®æ ‡ç±»ã€è®¾ç½®å›è°ƒã€ç”Ÿæˆä»£ç†ç±»ç­‰æ­¥éª¤ã€‚ 1public class Enhancer extends AbstractClassGenerator &#123;&#125; setSuperclass(Class&lt;?&gt; superclass)è®¾ç½®ä»£ç†ç±»çš„çˆ¶ç±»ï¼Œå³ç›®æ ‡ç±»ã€‚ä»£ç†ç±»å°†ç»§æ‰¿è¿™ä¸ªçˆ¶ç±»ï¼Œä»è€Œå¯ä»¥æ‹¦æˆªçˆ¶ç±»çš„æ–¹æ³•è°ƒç”¨ã€‚ setCallback(Callback callback)è®¾ç½®å›è°ƒï¼Œç”¨äºæ‹¦æˆªæ–¹æ³•è°ƒç”¨å¹¶å®šä¹‰æ‹¦æˆªé€»è¾‘ã€‚Callback æ˜¯ä¸€ä¸ªæ¥å£ï¼ŒMethodInterceptor æ˜¯å…¶å¸¸ç”¨çš„å®ç°ä¹‹ä¸€ã€‚ create()ç”Ÿæˆä»£ç†ç±»çš„å®ä¾‹ã€‚create æ–¹æ³•ä½¿ç”¨å…ˆå‰è®¾ç½®çš„çˆ¶ç±»å’Œå›è°ƒæ¥åŠ¨æ€åˆ›å»ºä»£ç†ç±»ã€‚ 2.3 MethodInterceptor1enhancer.setCallback(new HelloWorldInterceptor()); åœ¨enhancer ä¸­è®¾ç½®äº†callback ,ä¸‹é¢å…·ä½“è§£é‡Šä¸‹CallBack 123456789public class HelloWorldInterceptor implements MethodInterceptor &#123; @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable &#123; System.out.println(&quot;Before method: &quot; + method.getName()); Object result = proxy.invokeSuper(obj, args); System.out.println(&quot;After method: &quot; + method.getName()); return result; &#125; &#125; è‡ªå®šä¹‰çš„HelloWorldInterceptorå®ç°äº†MethodInterceptor. MethodInterceptor æ˜¯ Callback æ¥å£çš„ä¸€ä¸ªå®ç°ï¼Œå…¶æ ¸å¿ƒæ–¹æ³•æ˜¯ intercept,ç”¨äºå®šä¹‰æ–¹æ³•è°ƒç”¨æ—¶çš„æ‹¦æˆªé€»è¾‘, æ¯æ¬¡è°ƒç”¨ä»£ç†ç±»çš„æ–¹æ³•æ˜¯ï¼Œéƒ½ä¼šç»è¿‡è¿™ä¸ªintercept æ–¹æ³•å»è°ƒç”¨çˆ¶ç±»ä¸­çœŸæ­£çš„æ–¹æ³•ï¼Œ å…¶ä½œç”¨ç±»ä¼¼äºInvocationHandler.invoke 123public interface MethodInterceptor extends Callback &#123; Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable;&#125; objï¼šä»£ç†å¯¹è±¡æœ¬èº«ã€‚ Method methodï¼šè¢«æ‹¦æˆªçš„æ–¹æ³•å¯¹è±¡ï¼Œ å°±æ˜¯åå°„ä¸­çš„é‚£ä¸ªMethod argsï¼šæ–¹æ³•å‚æ•° MethodProxy proxyï¼šç”¨äºè°ƒç”¨çˆ¶ç±»æ–¹æ³•çš„ä»£ç†å¯¹è±¡ã€‚ å½“æ‰§è¡Œä»£ç†å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œ å…¶é€»è¾‘ä¼šè¿›å…¥åˆ°intercept æ–¹æ³•ä¸­ 2.4 MethodProxyMethodProxy ä¸»è¦ç”¨äºåœ¨æ–¹æ³•æ‹¦æˆªå™¨ï¼ˆMethodInterceptorï¼‰ä¸­ï¼Œé€šè¿‡è°ƒç”¨ä»£ç†ç±»çš„çˆ¶ç±»æ–¹æ³•æ¥å®ç°å¯¹ç›®æ ‡æ–¹æ³•çš„è°ƒç”¨ã€‚å®ƒç›¸æ¯”äºç›´æ¥ä½¿ç”¨åå°„è°ƒç”¨æ–¹æ³•æœ‰æ›´é«˜çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒé¿å…äº†åå°„è°ƒç”¨çš„å¼€é”€ï¼Œå…·æœ‰æ€§èƒ½ä¼˜åŠ¿ã€‚ å…·ä½“æ¥è¯´ï¼Œå®ƒåœ¨ä»£ç†ç±»çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè´Ÿè´£è°ƒç”¨ç›®æ ‡ç±»çš„æ–¹æ³•ï¼Œå®ç°äº†æ–¹æ³•è°ƒç”¨çš„æ‹¦æˆªå’Œå¢å¼ºã€‚ 2.3.1 createåœ¨ä»£ç†ç±»çš„ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼ŒCGLIB ä¼šä¸ºæ¯ä¸ªæ–¹æ³•åˆ›å»ºå¯¹åº”çš„ MethodProxy å¯¹è±¡ã€‚MethodProxy å¯¹è±¡å°è£…äº†ç›®æ ‡æ–¹æ³•çš„ä¿¡æ¯ï¼Œå¹¶ä¸”åœ¨è°ƒç”¨æ—¶å¯ä»¥ç›´æ¥è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼Œè€Œä¸éœ€è¦é€šè¿‡åå°„æœºåˆ¶ã€‚ ä¸ç›´æ¥ä½¿ç”¨åå°„è°ƒç”¨æ–¹æ³•ç›¸æ¯”ï¼ŒMethodProxy å…·æœ‰æ›´é«˜çš„æ€§èƒ½ã€‚å› ä¸º MethodProxy é€šè¿‡ç”Ÿæˆçš„å­—èŠ‚ç ç›´æ¥è°ƒç”¨ç›®æ ‡ç±»çš„æ–¹æ³•ï¼Œé¿å…äº†åå°„è°ƒç”¨çš„å¼€é”€ã€‚åå°„è°ƒç”¨æ–¹æ³•æ—¶ï¼Œéœ€è¦è¿›è¡Œä¸€ç³»åˆ—æ£€æŸ¥å’Œæ“ä½œï¼Œè€Œ MethodProxy å¯ä»¥åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ä¼˜åŒ–è¿™äº›æ“ä½œï¼Œä»è€Œæé«˜æ–¹æ³•è°ƒç”¨çš„æ•ˆç‡ã€‚ ç»“åˆdebug ä¿¡æ¯ï¼Œ è§£é‡ŠMethodProxy.create æ–¹æ³•ä¸­ï¼Œå„ä¸ªå‚æ•°çš„å«ä¹‰ c1ï¼šä»£ç†ç±»çš„çˆ¶ç±»ï¼Œå³ç›®æ ‡ç±» c2:ï¼šä»£ç†ç±» descï¼šç”¨äºæè¿°æ–¹æ³•çš„ç­¾åã€‚åœ¨å›¾ä¸­æ˜¾ç¤ºä¸º &quot;()V&quot;ï¼Œè¡¨ç¤ºæ–¹æ³•æ²¡æœ‰å‚æ•°ï¼Œè¿”å›å€¼ä¸º voidã€‚ name1ï¼šç›®æ ‡ç±»ä¸­éœ€è¦ä»£ç†çš„æ–¹æ³•å name2ï¼šä»£ç†ç±»ä¸­å¯¹åº”çš„ä»£ç†æ–¹æ³•åã€‚ 2.3.2 invokeSuper123456789101112public Object invokeSuper(Object obj, Object[] args) throws Throwable &#123; try &#123; // åˆå§‹åŒ– MethodProxy å¯¹è±¡ï¼Œç¡®ä¿ FastClass å·²åˆå§‹åŒ– init(); FastClassInfo fci = fastClassInfo; // é€šè¿‡ FastClass è°ƒç”¨çˆ¶ç±»æ–¹æ³• return fci.f2.invoke(fci.i2, obj, args); &#125; catch (InvocationTargetException e) &#123; throw e.getTargetException(); &#125; &#125; 2.5 enhancer.create()enhancer å®ä¾‹è®¾ç½®ä¸ºå¿…è¦ä¿¡æ¯åï¼Œå°±å¯ä»¥è°ƒç”¨create æ–¹æ³•åˆ›å»ºä»£ç†å¯¹è±¡äº† 123456789101112131415161718192021222324public class Enhancer extends AbstractClassGenerator &#123;\tpublic Object create() &#123; classOnly = false; argumentTypes = null; return createHelper(); &#125;\tprivate Object createHelper() &#123; preValidate(); // åˆ›å»ºäº†ä¸€ä¸ªå”¯ä¸€çš„é”® `key`ï¼Œç”¨äºæ ‡è¯†ç”Ÿæˆçš„ä»£ç†ç±» Object key = KEY_FACTORY.newInstance((superclass != null) ? superclass.getName() : null, ReflectUtils.getNames(interfaces), filter == ALL_ZERO ? null : new WeakCacheKey&lt;CallbackFilter&gt;(filter), callbackTypes, useFactory, interceptDuringConstruction, serialVersionUID); this.currentKey = key; Object result = super.create(key); return result;\t&#125;&#125; 2.4.1 AbstractClassGenerator.create12345678910111213141516171819202122232425262728293031323334353637383940414243abstract public class AbstractClassGenerator&lt;T&gt; implements ClassGenerator &#123;\tprotected Object create(Object key) &#123; try &#123; // è·å–ç”¨äºåŠ è½½ä»£ç†ç±»çš„ç±»åŠ è½½å™¨ // è¿™ä¸ªç±»åŠ è½½å™¨é€šå¸¸æ˜¯ç›®æ ‡ç±»çš„ç±»åŠ è½½å™¨ã€‚ ClassLoader loader = getClassLoader(); Map&lt;ClassLoader, ClassLoaderData&gt; cache = CACHE; //ä»ç¼“å­˜ä¸­è·å–ä¸å½“å‰ç±»åŠ è½½å™¨å¯¹åº”çš„ `ClassLoaderData` å¯¹è±¡ã€‚ ClassLoaderData data = cache.get(loader); if (data == null) &#123; // åŒé‡æ£€æŸ¥é”å®š synchronized (AbstractClassGenerator.class) &#123; cache = CACHE; data = cache.get(loader); if (data == null) &#123; // åˆ›å»ºæ–°æ•°æ®ï¼Œä½¿ç”¨ `WeakHashMap` ä½œä¸ºç¼“å­˜ï¼Œå…è®¸ç±»åŠ è½½å™¨è¢«åƒåœ¾å›æ”¶ã€‚ Map&lt;ClassLoader, ClassLoaderData&gt; newCache = new WeakHashMap&lt;ClassLoader, ClassLoaderData&gt;(cache); data = new ClassLoaderData(loader); newCache.put(loader, data); CACHE = newCache; &#125; &#125; &#125; this.key = key; // ä» `ClassLoaderData` å¯¹è±¡ä¸­è·å–æˆ–ç”Ÿæˆä»£ç†ç±»ã€‚ Object obj = data.get(this, getUseCache()); if (obj instanceof Class) &#123; return firstInstance((Class) obj); &#125; return nextInstance(obj); &#125; catch (RuntimeException | Error ex) &#123; throw ex; &#125; catch (Exception ex) &#123; throw new CodeGenerationException(ex); &#125;\t&#125;&#125; 2.6 æ‰§è¡Œä¸šåŠ¡ä»£ç 1proxy.sayHello(); æ‰§è¡Œä¸šåŠ¡ä»£ç ï¼Œ ä¼šè¿›å…¥è‡ªå®šä¹‰çš„HelloWorldInterceptor çš„ intercept æ–¹æ³•åœ¨ intercept æ–¹æ³•ä¸­ï¼Œ å¯ä»¥æ·»åŠ è‡ªå®šä¹‰é€»è¾‘ï¼Œæ¯”å¦‚åœ¨AOP ä¸­ï¼Œå¯ä»¥æ·»åŠ å¢å¼º æ‰§è¡Œç›®æ ‡ç±»çš„çœŸæ­£æ–¹æ³• ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ï¼Œå…¶ä¼ªä»£ç å¯ä»¥ç±»ä¼¼äº1234567891011121314151617181920212223242526272829303132333435363738public class HelloWorldImpl$$EnhancerByCGLIB$$abcdef12 extends HelloWorldImpl &#123; private MethodInterceptor callback; public HelloWorldImpl$$EnhancerByCGLIB$$(MethodInterceptor callback) &#123; this.callback = callback; &#125; @Override public void sayHello() &#123; try &#123; Method method = HelloWorldImpl.class.getMethod(&quot;sayHello&quot;); callback.intercept(this, method, null, MethodProxy.create(HelloWorldImpl.class, HelloWorldImpl$$EnhancerByCGLIB$$.class, &quot;()V&quot;, &quot;sayHello&quot;, &quot;CGLIB$sayHello$0&quot;)); &#125; catch (Throwable throwable) &#123; throwable.printStackTrace(); &#125; &#125; @Override public void sayBye() &#123; try &#123; Method method = HelloWorldImpl.class.getMethod(&quot;sayBye&quot;); callback.intercept(this, method, null, MethodProxy.create(HelloWorldImpl.class, HelloWorldImpl$$EnhancerByCGLIB$$.class, &quot;()V&quot;, &quot;sayBye&quot;, &quot;CGLIB$sayBye$0&quot;)); &#125; catch (Throwable throwable) &#123; throwable.printStackTrace(); &#125; &#125; // å†…éƒ¨æ–¹æ³•ç”¨äºå®é™…è°ƒç”¨çˆ¶ç±»æ–¹æ³• public void CGLIB$sayHello$0() &#123; super.sayHello(); &#125; public void CGLIB$sayBye$0() &#123; super.sayBye(); &#125;&#125; 2.7 ä»£ç†ç±»å‘½åè§„åˆ™åœ¨CGLIBç”Ÿæˆçš„ä»£ç†ç±»åç§°ä¸­ï¼Œ$$$$é€šå¸¸ç”¨æ¥åˆ†éš”åŸå§‹ç±»åå’Œé™„åŠ çš„ä»£ç†ç±»ä¿¡æ¯ã€‚è¿™ç§å‘½åçº¦å®šä½¿å¾—åœ¨è°ƒè¯•ã€æ—¥å¿—è®°å½•ä»¥åŠè¿è¡Œæ—¶åå°„æ“ä½œä¸­ï¼Œæ›´å®¹æ˜“è¯†åˆ«å’Œå¤„ç†ä»£ç†ç±»ã€‚1HelloWorldImpl$$EnhancerByCGLIB$$abcdef12 HelloWorldImpl æ˜¯åŸå§‹ç±»çš„åç§°ã€‚ $$$$ æ˜¯CGLIBçš„ç±»åˆ†éš”ç¬¦ã€‚ EnhancerByCGLIB è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªç”±CGLIBç”Ÿæˆçš„å¢å¼ºç±»ã€‚ abcdef12 æ˜¯ä¸€ä¸²éšæœºå­—ç¬¦æˆ–å“ˆå¸Œå€¼ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„ä»£ç†å®ä¾‹ã€‚ åˆ¤æ–­ç±»åæ˜¯å¦åŒ…å«$$$$ã€‚è¿™å¯ä»¥è¯†åˆ«å‡ºå½“å‰ç±»æ˜¯å¦æ˜¯CGLIBç”Ÿæˆçš„ä»£ç†ç±»ã€‚ 3 JDK vs CGLib3.1 å®ç°æœºåˆ¶JDKåŠ¨æ€ä»£ç† åŸºäºæ¥å£ï¼šJDK åŠ¨æ€ä»£ç†è¦æ±‚ç›®æ ‡ç±»å®ç°ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£ã€‚ä»£ç†ç±»å®ç°è¿™äº›æ¥å£ï¼Œå¹¶å°†æ–¹æ³•è°ƒç”¨å§”æ‰˜ç»™ InvocationHandlerã€‚ åå°„æœºåˆ¶ï¼šJDK åŠ¨æ€ä»£ç†ä½¿ç”¨åå°„æœºåˆ¶æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚é€šè¿‡ java.lang.reflect.Proxy ç±»å’Œ java.lang.reflect.InvocationHandler æ¥å£å®ç°ã€‚ å­—èŠ‚ç ç”Ÿæˆï¼šJDK åŠ¨æ€ä»£ç†ä½¿ç”¨ JVM è‡ªå¸¦çš„å­—èŠ‚ç ç”Ÿæˆå·¥å…·ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç ï¼Œä¸ä¾èµ–å¤–éƒ¨åº“ã€‚ CGLIBåŠ¨æ€ä»£ç† åŸºäºç»§æ‰¿ï¼šCGLIB åŠ¨æ€ä»£ç†é€šè¿‡ç»§æ‰¿ç›®æ ‡ç±»æ¥åˆ›å»ºä»£ç†ç±»ã€‚å› æ­¤ï¼Œå®ƒä¸è¦æ±‚ç›®æ ‡ç±»å®ç°æ¥å£ã€‚ å­—èŠ‚ç ç”Ÿæˆï¼šCGLIB ä½¿ç”¨ ASM åº“åœ¨è¿è¡Œæ—¶ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç ã€‚ä»£ç†ç±»ç»§æ‰¿ç›®æ ‡ç±»ï¼Œå¹¶é€šè¿‡æ–¹æ³•æ‹¦æˆªå™¨ï¼ˆMethodInterceptorï¼‰æ‹¦æˆªæ–¹æ³•è°ƒç”¨ã€‚ FastClass æœºåˆ¶ï¼šCGLIB æä¾› FastClass æœºåˆ¶ï¼Œé€šè¿‡ç´¢å¼•ç›´æ¥è°ƒç”¨æ–¹æ³•ï¼Œé¿å…äº†åå°„è°ƒç”¨çš„å¼€é”€ï¼Œæé«˜äº†æ€§èƒ½ã€‚ 3.2 é€‚ç”¨åœºæ™¯JDKåŠ¨æ€ä»£ç† é€‚ç”¨äºå®ç°äº†æ¥å£çš„ç±»ï¼šJDK åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†å®ç°äº†ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£çš„ç±»ã€‚ ç®€å•åœºæ™¯ï¼šé€‚ç”¨äºéœ€è¦ä»£ç†çš„ç±»å’Œæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œä¸”ç¬¦åˆæ¥å£çº¦æŸçš„åœºæ™¯ã€‚ CGLIBåŠ¨æ€ä»£ç† é€‚ç”¨äºæœªå®ç°æ¥å£çš„ç±»ï¼šCGLIB å¯ä»¥ä»£ç†æœªå®ç°æ¥å£çš„ç±»ï¼Œé€‚ç”¨èŒƒå›´æ›´å¹¿ã€‚ å¤æ‚åœºæ™¯ï¼šé€‚ç”¨äºéœ€è¦ä»£ç†çš„ç±»å’Œæ–¹æ³•è¾ƒå¤æ‚ï¼Œæˆ–è€…æ— æ³•ä¿®æ”¹ç›®æ ‡ç±»ä»¥å®ç°æ¥å£çš„åœºæ™¯ã€‚ 3.3 æ€§èƒ½æ¯”è¾ƒJDKåŠ¨æ€ä»£ç† åå°„å¼€é”€ï¼šç”±äºä½¿ç”¨åå°„æœºåˆ¶ï¼Œæ–¹æ³•è°ƒç”¨çš„æ€§èƒ½å¯èƒ½è¾ƒä½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§é‡è°ƒç”¨æ—¶ï¼Œåå°„å¼€é”€æ˜¾è‘—ã€‚ æ–¹æ³•è°ƒç”¨ï¼šæ¯æ¬¡æ–¹æ³•è°ƒç”¨éƒ½éœ€è¦é€šè¿‡ InvocationHandlerï¼Œå¯¼è‡´ä¸€å®šçš„æ€§èƒ½æŸå¤±ã€‚ CGLIBåŠ¨æ€ä»£ç† å­—èŠ‚ç ç”Ÿæˆï¼šé€šè¿‡ ASM åº“åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç ï¼Œæ€§èƒ½è¾ƒé«˜ã€‚ FastClass æœºåˆ¶ï¼šé€šè¿‡ FastClass æœºåˆ¶ï¼Œæ–¹æ³•è°ƒç”¨çš„æ€§èƒ½æ¥è¿‘äºç›´æ¥è°ƒç”¨ï¼Œè¿œé«˜äºåå°„è°ƒç”¨ã€‚ 3.4 å†…å­˜å¼€é”€JDKåŠ¨æ€ä»£ç† è¾ƒä½å†…å­˜å¼€é”€ï¼šç”±äºä»£ç†ç±»è¾ƒä¸ºç®€å•ï¼Œä¸”ä¸éœ€è¦ç”Ÿæˆé¢å¤–çš„å­—èŠ‚ç ï¼Œå†…å­˜å¼€é”€è¾ƒä½ã€‚ ç±»åŠ è½½å™¨ï¼šä»£ç†ç±»ç”± JVM ç”Ÿæˆå¹¶åŠ è½½ï¼Œä¸ä¾èµ–å¤–éƒ¨ç±»åŠ è½½å™¨ã€‚ CGLIBåŠ¨æ€ä»£ç† è¾ƒé«˜å†…å­˜å¼€é”€ï¼šéœ€è¦ç”Ÿæˆå’ŒåŠ è½½é¢å¤–çš„å­—èŠ‚ç ï¼Œå†…å­˜å¼€é”€è¾ƒé«˜ã€‚ ç±»åŠ è½½å™¨ï¼šç”Ÿæˆçš„ä»£ç†ç±»éœ€è¦é¢å¤–çš„ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½å’Œç®¡ç†ã€‚ 3.5 å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§JDKåŠ¨æ€ä»£ç† æ˜“äºç†è§£å’Œç»´æŠ¤ï¼šåŸºäºæ¥å£çš„ä»£ç†æ¨¡å¼è¾ƒä¸ºç®€å•ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤ã€‚ æ‰©å±•æ€§æœ‰é™ï¼šåªèƒ½ä»£ç†å®ç°äº†æ¥å£çš„ç±»ï¼Œå¯¹äºæœªå®ç°æ¥å£çš„ç±»ï¼Œéœ€è¦ä¿®æ”¹ç±»ç»“æ„ã€‚ CGLIBåŠ¨æ€ä»£ç† å¤æ‚åº¦è¾ƒé«˜ï¼šç”±äºæ¶‰åŠå­—èŠ‚ç ç”Ÿæˆå’Œæ–¹æ³•æ‹¦æˆªï¼Œç†è§£å’Œç»´æŠ¤è¾ƒä¸ºå¤æ‚ã€‚ é«˜æ‰©å±•æ€§ï¼šå¯ä»¥ä»£ç†æœªå®ç°æ¥å£çš„ç±»ï¼Œé€‚ç”¨èŒƒå›´æ›´å¹¿ï¼Œæ›´å…·æ‰©å±•æ€§ã€‚","tags":["Java"]},{"title":"Javaåå°„å®è·µä¸åŸç†","path":"/b381342a/","content":"åå°„ä½œä¸ºä¸€ç§é«˜çº§æŠ€æœ¯ï¼Œè™½ç„¶åœ¨ä¸šåŠ¡å¼€å‘ä¸­å¾ˆå°‘ç›´æ¥ç¼–å†™ç›¸å…³ä»£ç ï¼Œä½†å®é™…å­˜åœ¨äº Java å¼€å‘ä¸­çš„æ–¹æ–¹é¢é¢ã€‚ Spring Frameworkï¼š ä¾èµ–æ³¨å…¥ï¼šä½¿ç”¨åå°„å®ä¾‹åŒ–å¯¹è±¡ã€è®¾ç½®å±æ€§å’Œè°ƒç”¨æ–¹æ³•ï¼Œå®ç°IoCã€‚ AOPï¼šé€šè¿‡åå°„åœ¨æ–¹æ³•è°ƒç”¨å‰ååŠ¨æ€æ·»åŠ é€»è¾‘ï¼Œå¦‚æ—¥å¿—è®°å½•å’Œäº‹åŠ¡ç®¡ç†ã€‚ Hibernateï¼š å¯¹è±¡å…³ç³»æ˜ å°„ï¼ˆORMï¼‰ï¼šåˆ©ç”¨åå°„è¯»å–å’Œå†™å…¥å®ä½“ç±»å±æ€§ï¼Œå®ç°Javaå¯¹è±¡ä¸æ•°æ®åº“è¡¨çš„æ˜ å°„ã€‚ JUnitæµ‹è¯•æ¡†æ¶ï¼šä½¿ç”¨åå°„å‘ç°å’Œæ‰§è¡Œæµ‹è¯•æ–¹æ³•ï¼Œæ”¯æŒæ³¨è§£å®šä¹‰æµ‹è¯•ã€‚ Java æ ‡å‡†åº“ä¸­çš„åŠ¨æ€ä»£ç†ï¼š java.lang.reflect.Proxy ä½¿ç”¨åå°„åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå¹¶å°†æ–¹æ³•è°ƒç”¨å§”æ‰˜ç»™ InvocationHandlerã€‚ RPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰ï¼š åŠ¨æ€ä»£ç†å®ç°è¿œç¨‹æ¥å£ï¼Œä½¿æœ¬åœ°è°ƒç”¨åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹æœåŠ¡ã€‚ Java åºåˆ—åŒ–ï¼š åå°„è·å–å¯¹è±¡å­—æ®µåŠå…¶å€¼ï¼Œå°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµã€‚ JSON/XML è§£æåº“ï¼š å¦‚ Jacksonã€Gson å’Œ JAXBï¼Œä½¿ç”¨åå°„å°† JSON æˆ– XML æ•°æ®ä¸ Java å¯¹è±¡ç›¸äº’è½¬æ¢ã€‚ å¼€å‘å·¥å…·å’Œ IDEï¼šä½¿ç”¨åå°„æ£€æŸ¥å’Œæ“ä½œè¿è¡Œä¸­çš„åº”ç”¨ç¨‹åºï¼Œè·å–å¯¹è±¡ä¿¡æ¯ã€è°ƒç”¨æ–¹æ³•ç­‰ã€‚ 0. ä»€ä¹ˆæ˜¯åå°„åå°„æŒ‡çš„æ˜¯å…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°æ£€æŸ¥å’Œæ“ä½œç±»ã€æ–¹æ³•ã€å­—æ®µç­‰ã€‚é€šè¿‡åå°„ï¼Œç¨‹åºå¯ä»¥åœ¨è¿è¡Œæ—¶äº†è§£ä¸€ä¸ªç±»çš„ç»“æ„ï¼Œå¹¶ä¸”å¯ä»¥åˆ›å»ºå¯¹è±¡ã€è°ƒç”¨æ–¹æ³•ã€è®¿é—®å’Œä¿®æ”¹å­—æ®µç­‰ã€‚ å¦‚ä½•ç†è§£â€œåâ€â€œåâ€åœ¨åå°„ä¸­çš„å«ä¹‰å¯ä»¥ç†è§£ä¸ºâ€œåå‘æ“ä½œâ€æˆ–â€œåæŸ¥â€ã€‚ é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™ä»£ç æ—¶ä¼šæ˜¾å¼åœ°è°ƒç”¨æ–¹æ³•ã€è®¿é—®å­—æ®µæˆ–åˆ›å»ºå¯¹è±¡ï¼Œæ¯”å¦‚ï¼š12Person person = new Person();person.setName(&quot;Alice&quot;); è¿™æ˜¯æ­£å‘æ“ä½œï¼Œå³ç¨‹åºæ˜ç¡®çŸ¥é“è¦æ“ä½œçš„ç±»å’Œæ–¹æ³•ã€‚è¿™ç§æ–¹å¼ç§°ä¸ºç¼–è¯‘æ—¶ç»‘å®šï¼Œå› ä¸ºæ‰€æœ‰çš„ç±»å‹ã€æ–¹æ³•å’Œå˜é‡è°ƒç”¨åœ¨ç¼–å†™ä»£ç æ—¶å°±å·²ç¡®å®šï¼Œå¹¶åœ¨ç¼–è¯‘æœŸé—´å·²ç»å»ºç«‹äº†å®ƒä»¬çš„å…³è”ã€‚è¿™ç§æ–¹å¼ä¾èµ–äºé™æ€ç±»å‹æ£€æŸ¥ï¼Œèƒ½å¤Ÿåœ¨ç¼–è¯‘é˜¶æ®µæ•è·è®¸å¤šé”™è¯¯ï¼ŒåŒæ—¶ä¹Ÿæé«˜äº†ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€‚ è€Œåå°„åˆ™ç›¸å½“äºåå‘æ“ä½œï¼Œç¨‹åºåœ¨ç¼–å†™ä»£ç æ—¶å¹¶ä¸çŸ¥é“å…·ä½“çš„ç±»å’Œæ–¹æ³•ï¼ˆç¼–ç æ—¶åªæ˜¯ç»™å‡ºäº†â€œå­—é¢åç§°â€ï¼Œè€Œä¸æ˜¯å®é™…çš„ç±»å’Œæ–¹æ³•ï¼‰ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡åå°„æœºåˆ¶è·å–ç±»çš„ä¿¡æ¯å¹¶è¿›è¡Œæ“ä½œã€‚è¿™ç§æ–¹å¼ç§°ä¸ºè¿è¡Œæ—¶ç»‘å®šï¼Œå› ä¸ºä»£ç åœ¨è¿è¡Œæ—¶æ‰ç¡®å®šè¦è°ƒç”¨çš„å…·ä½“ç±»ã€æ–¹æ³•æˆ–å±æ€§ã€‚ 1234Class&lt;?&gt; clazz = Class.forName(&quot;Person&quot;);Object person = clazz.newInstance();Method setNameMethod = clazz.getMethod(&quot;setName&quot;, String.class);setNameMethod.invoke(person, &quot;Alice&quot;); åœ¨è¿™ä¸ªåå°„çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰åœ¨ä»£ç ä¸­ç›´æ¥è°ƒç”¨ Person ç±»æˆ–å…¶æ–¹æ³•ã€‚ç›¸åï¼Œæˆ‘ä»¬åœ¨è¿è¡Œæ—¶åŠ è½½äº†ç±»ï¼Œæ£€ç´¢äº†æ„é€ å‡½æ•°å’Œæ–¹æ³•ï¼Œå¹¶åŠ¨æ€åœ°è°ƒç”¨äº†å®ƒä»¬ã€‚ â€œåâ€ä¸â€œæ­£â€çš„å¯¹æ¯” æ€§èƒ½ï¼šæ­£å¸¸æ–¹æ³•ï¼ˆç¼–è¯‘æ—¶ç»‘å®šï¼‰é€šå¸¸æ€§èƒ½æ›´é«˜ï¼Œå› ä¸ºå®ƒä»¬åœ¨ç¼–è¯‘æ—¶å°±å·²ç»è§£å†³äº†å¤§éƒ¨åˆ†å¼•ç”¨é—®é¢˜ï¼›è€Œåå°„ï¼ˆè¿è¡Œæ—¶ç»‘å®šï¼‰åœ¨æŸ¥æ‰¾å’Œè°ƒç”¨è¿‡ç¨‹ä¸­éœ€è¦æ¶ˆè€—é¢å¤–çš„èµ„æºï¼Œæ€§èƒ½ç›¸å¯¹è¾ƒä½ã€‚ ç±»å‹å®‰å…¨ï¼šæ­£å¸¸æ–¹æ³•åœ¨ç¼–è¯‘æ—¶å°±èƒ½æ£€æŸ¥ç±»å‹å®‰å…¨æ€§ï¼Œè€Œåå°„åˆ™éœ€è¦ç¨‹åºå‘˜åœ¨è¿è¡Œæ—¶æ‰‹åŠ¨ç¡®ä¿ç±»å‹çš„æ­£ç¡®æ€§ï¼Œè¿™å¢åŠ äº†å‡ºé”™çš„é£é™©ã€‚ çµæ´»æ€§ï¼šåå°„æä¾›äº†æé«˜çš„çµæ´»æ€§ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å’Œæ“ä½œç±»ï¼Œè¿™åœ¨å¼€å‘é€šç”¨æ¡†æ¶æˆ–éœ€è¦å¤§é‡è¿è¡Œæ—¶ä¿¡æ¯çš„å¤æ‚ç³»ç»Ÿä¸­éå¸¸æœ‰ç”¨ã€‚ åå°„çš„å·¥ä½œåŸç†åå°„åŸºäºä¸¤éƒ¨åˆ†å†…å®¹å®ç° java.lang.Class ç±» java.lang.reflect åŒ…ä¸­çš„ç±»ï¼ˆå¦‚ Method, Field, Constructor ç­‰ï¼‰æ¥å®ç° 1. Class ç±»Classç±»ä¹Ÿæ˜¯ä¸€ä¸ªå®å®åœ¨åœ¨çš„ç±»ï¼Œå­˜åœ¨äºJDKçš„java.langåŒ…ä¸­ã€‚ 12345public final class Class&lt;T&gt; implements java.io.Serializable, GenericDeclaration, Type, AnnotatedElement &#123;&#125; Java ç¼–è¯‘å™¨å°† Java æºä»£ç ï¼ˆ.java æ–‡ä»¶ï¼‰ç¼–è¯‘å ï¼Œäº§ç”Ÿ.class æ–‡ä»¶ï¼Œ ä¿å­˜äº†ç±»çš„å­—èŠ‚ç åŠç›¸å…³çš„å…ƒæ•°æ®ã€‚ å½“ JVM è¿è¡ŒåŠ è½½ä¸€ä¸ªç±»æ—¶ï¼Œå®ƒä¼šè¯»å–ç›¸åº”çš„ .class æ–‡ä»¶ï¼Œå¹¶æ ¹æ®å­—èŠ‚ç ä¿¡æ¯ç”Ÿæˆä¸€ä¸ª Class å¯¹è±¡è¡¨ç¤ºè¯¥ç±»ã€‚ è¿™ä¸ª Class å¯¹è±¡æ˜¯ JVM å†…å­˜ä¸­çš„ä¸€ä¸ªè¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼ŒåŒ…å«äº†ç±»çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ç±»åã€ä¿®é¥°ç¬¦ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ã€çˆ¶ç±»ç­‰ã€‚ Class å¯¹è±¡åœ¨ JVM çš„æ–¹æ³•åŒºï¼ˆJava 8 åŠä¹‹å‰ï¼‰æˆ–å…ƒç©ºé—´ï¼ˆJava 8 åŠä¹‹åï¼‰ä¸­åˆ†é…å†…å­˜ï¼Œå­˜å‚¨ç±»çš„å…ƒæ•°æ®ã€‚ æ— è®ºåˆ›å»ºå¤šå°‘ä¸ªè¯¥ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œå®ƒä»¬éƒ½å…±äº«åŒä¸€ä¸ª Class å¯¹è±¡ã€‚ 1.1 .class æ–‡ä»¶çš„å†…å®¹.class æ–‡ä»¶åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š é­”æ•°ï¼ˆMagic Numberï¼‰ï¼šç”¨äºè¯†åˆ«æ–‡ä»¶æ ¼å¼ã€‚ ç‰ˆæœ¬ä¿¡æ¯ï¼šè¡¨ç¤ºç¼–è¯‘å™¨ç”Ÿæˆè¯¥ .class æ–‡ä»¶æ—¶ä½¿ç”¨çš„ JDK ç‰ˆæœ¬ã€‚ å¸¸é‡æ± ï¼ˆConstant Poolï¼‰ï¼šä¿å­˜å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚ è®¿é—®æ ‡å¿—ï¼ˆAccess Flagsï¼‰ï¼šæè¿°ç±»æˆ–æ¥å£çš„è®¿é—®çº§åˆ«å’Œå…¶ä»–å±æ€§ã€‚ ç±»ã€çˆ¶ç±»å’Œæ¥å£ä¿¡æ¯ï¼šåŒ…æ‹¬ç±»åã€çˆ¶ç±»åå’Œå®ç°çš„æ¥å£ã€‚ å­—æ®µï¼ˆFieldsï¼‰ï¼šç±»çš„å­—æ®µä¿¡æ¯ã€‚ æ–¹æ³•ï¼ˆMethodsï¼‰ï¼šç±»çš„æ–¹æ³•ä¿¡æ¯ã€‚ å±æ€§ï¼ˆAttributesï¼‰ï¼šç±»çš„å…¶ä»–å±æ€§ä¿¡æ¯ï¼Œå¦‚æ³¨è§£ã€æºæ–‡ä»¶ä¿¡æ¯ç­‰ã€‚ 1.2 Class å¯¹è±¡çš„ç”Ÿæˆæ—¶æœºå½“ JVM è¿è¡ŒåŠ è½½ä¸€ä¸ªç±»ï¼Œè¯»å–ç›¸åº”çš„ .class æ–‡ä»¶ æ—¶ï¼Œä¼šè¿›è¡Œä»¥ä¸‹æ­¥éª¤ï¼š åŠ è½½ï¼ˆLoadingï¼‰ï¼šé€šè¿‡ç±»åŠ è½½å™¨è¯»å– .class æ–‡ä»¶çš„å­—èŠ‚ç ã€‚ é“¾æ¥ï¼ˆLinkingï¼‰ï¼š éªŒè¯ï¼ˆVerificationï¼‰ï¼šç¡®ä¿å­—èŠ‚ç ç¬¦åˆ JVM è§„èŒƒï¼Œä¸ä¼šç ´å JVM çš„å®‰å…¨æ€§ã€‚ å‡†å¤‡ï¼ˆPreparationï¼‰ï¼šä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶å°†å…¶åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼ã€‚ è§£æï¼ˆResolutionï¼‰ï¼šå°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚ åˆå§‹åŒ–ï¼ˆInitializationï¼‰ï¼šæ‰§è¡Œç±»çš„é™æ€åˆå§‹åŒ–å—å’Œé™æ€å˜é‡çš„åˆå§‹åŒ–ã€‚ åœ¨è¿™äº›æ­¥éª¤å®Œæˆä¹‹åï¼ŒJVM ä¼šåœ¨å†…å­˜ä¸­åˆ›å»ºä¸€ä¸ª Class å¯¹è±¡æ¥è¡¨ç¤ºè¿™ä¸ªç±»ã€‚è¿™ä¸ª Class å¯¹è±¡åŒ…å«äº†ç±»çš„æ‰€æœ‰å…ƒæ•°æ®ï¼Œå¹¶ä¸”æ— è®ºåˆ›å»ºå¤šå°‘ä¸ªè¯¥ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œå®ƒä»¬éƒ½å…±äº«åŒä¸€ä¸ª Class å¯¹è±¡ã€‚ [[JVM#ç±»åŠ è½½-åŠ è½½ï¼Œç”ŸæˆClasså¯¹è±¡]] 1.3 Class å¯¹è±¡çš„å”¯ä¸€æ€§å¯¹äºåŒä¸€ä¸ªç±»ï¼Œæ— è®ºåˆ›å»ºå¤šå°‘ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå®ƒä»¬å…±äº«åŒä¸€ä¸ª Class å¯¹è±¡ã€‚ ç±»åŠ è½½å™¨åœ¨å†³å®š Class å¯¹è±¡çš„å”¯ä¸€æ€§ä¸Šèµ·ç€å…³é”®ä½œç”¨ã€‚å¦‚æœåŒä¸€ä¸ªç±»è¢«ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½ï¼Œé‚£ä¹ˆå®ƒä»¬ä¼šæœ‰ä¸åŒçš„ Class å¯¹è±¡ã€‚ æ¯”å¦‚åˆ›å»ºä¸€ä¸ªShapesç±»ï¼Œé‚£ä¹ˆï¼ŒJVMå°±ä¼šåˆ›å»ºä¸€ä¸ªShapeså¯¹åº”Classç±»çš„Classå¯¹è±¡ï¼Œæ— è®ºåˆ›å»ºå¤šå°‘ä¸ªå®ä¾‹å¯¹è±¡ï¼Œåœ¨JVMä¸­éƒ½åªæœ‰ä¸€ä¸ªClasså¯¹è±¡ã€‚ å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç éªŒè¯å”¯ä¸€æ€§ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public class ClassUniqueDemo &#123; public static void main(String[] args) &#123; // åˆ›å»ºå¤šä¸ªå®ä¾‹å¯¹è±¡ Person person1 = new Person(&quot;Alice&quot;, 30); Person person2 = new Person(&quot;Bob&quot;, 25); // è·å– Class å¯¹è±¡ Class&lt;?&gt; class1 = person1.getClass(); Class&lt;?&gt; class2 = person2.getClass(); Class&lt;?&gt; class3 = Person.class; // æ‰“å° Class å¯¹è±¡çš„å“ˆå¸Œç  System.out.println(&quot;class1: &quot; + class1.hashCode()); System.out.println(&quot;class2: &quot; + class2.hashCode()); System.out.println(&quot;class3: &quot; + class3.hashCode()); // éªŒè¯æ‰€æœ‰å®ä¾‹å¯¹è±¡çš„ Class å¯¹è±¡æ˜¯å¦ç›¸åŒ System.out.println(&quot;class1 == class2: &quot; + (class1 == class2)); System.out.println(&quot;class1 == class3: &quot; + (class1 == class3)); &#125;&#125;class Person &#123; private String name; private int age; public Person(String name, int age) &#123; this.name = name; this.age = age; &#125; public String getName() &#123; return name; &#125; public void setName(String name) &#123; this.name = name; &#125; public int getAge() &#123; return age; &#125; public void setAge(int age) &#123; this.age = age; &#125;&#125; 1.4 å…³äºClass çš„ä¸€ç‚¹æ€»ç»“åˆ°è¿™ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ä¸€ä¸‹å…³äºClass çš„ç›¸å…³ä¿¡æ¯ Classç±»æ˜¯Javaä¸­çš„ä¸€ç§ç±»ï¼Œä¸å…³é”®å­—classä¸åŒã€‚ Classå¯¹è±¡æ˜¯ç”±Javaè™šæ‹Ÿæœºï¼ˆJVMï¼‰åŠ è½½çš„ï¼Œå®ƒä»£è¡¨Javaä¸­çš„ç±»æˆ–æ¥å£ã€‚ æ¯ä¸ªé€šè¿‡classå…³é”®å­—å®šä¹‰çš„ç±»ï¼Œåœ¨ç¼–è¯‘åéƒ½ä¼šç”Ÿæˆä¸€ä¸ª.classæ–‡ä»¶ã€‚JVMåŠ è½½è¿™ä¸ª.classæ–‡ä»¶ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„Classå¯¹è±¡ã€‚ æ— è®ºä¸€ä¸ªç±»åˆ›å»ºäº†å¤šå°‘ä¸ªå®ä¾‹ï¼Œæ‰€æœ‰è¿™äº›å®ä¾‹éƒ½å…±äº«åŒä¸€ä¸ªClasså¯¹è±¡ã€‚è¿™æ˜¯å› ä¸ºClasså¯¹è±¡è¡¨ç¤ºç±»çš„å…ƒæ•°æ®ï¼Œå­˜å‚¨äº†ç±»çš„ç»“æ„ä¿¡æ¯ï¼Œè€Œå®ä¾‹åˆ™æ˜¯ç±»çš„å…·ä½“å®ç°ã€‚ Classç±»çš„æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œç¡®ä¿äº†Classå¯¹è±¡åªèƒ½ç”±JVMå†…éƒ¨åˆ›å»ºã€‚å¼€å‘è€…ä¸èƒ½ç›´æ¥é€šè¿‡æ„é€ å‡½æ•°åˆ›å»ºClasså¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡ç±»åŠ è½½æœºåˆ¶é—´æ¥åœ°è·å¾—Classå¯¹è±¡ã€‚ 2. ä½¿ç”¨åå°„è®¿é—®ç±»çš„å„ä¸ªç»„æˆéƒ¨åˆ†2.1 è·å–Class å¯¹è±¡è·å–ä¸€ä¸ªç±»çš„ Class å¯¹è±¡æœ‰4ç§ï¼Œ ä½†æ˜¯å‰3ç§æ›´å¸¸ç”¨ é€šè¿‡ç±»å 12Class&lt;?&gt; clazz = ClassName.class; é€šè¿‡å¯¹è±¡å®ä¾‹ï¼š 12Class&lt;?&gt; clazz = objectInstance.getClass(); forName å…¨é™å®šç±»åï¼š 1Class&lt;?&gt; clazz = Class.forName(&quot;com.example.ClassName&quot;); é€šè¿‡ ClassLoader è·å– Class å¯¹è±¡(Spring bean åˆ›å»ºè¿‡ç¨‹ä¸­ä¼šç”¨åˆ°è¿™ç§æ–¹å¼) 123ClassLoader classLoader = Thread.currentThread().getContextClassLoader();Class&lt;?&gt; clazz = classLoader.loadClass(&quot;com.example.MyClass&quot;); Class.forName vs ClassLoader.loadClass Class.forNameå’ŒClassLoader.loadClasséƒ½æ˜¯é€šè¿‡å…¨é™å®šåè·å–Classå¯¹è±¡çš„æ–¹æ³•ï¼Œä½†å®ƒä»¬åœ¨ç±»çš„åˆå§‹åŒ–è¡Œä¸ºã€ä½¿ç”¨åœºæ™¯å’ŒåŠ è½½å™¨é€‰æ‹©ä¸Šå­˜åœ¨æ˜¾è‘—åŒºåˆ«ï¼š ç±»çš„åˆå§‹åŒ–ï¼šClass.forNameé»˜è®¤ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–ï¼Œè€ŒClassLoader.loadClassé»˜è®¤ä¸ä¼šã€‚ ä½¿ç”¨åœºæ™¯ï¼šClass.forNameé€‚ç”¨äºç®€å•åœºæ™¯å’Œéœ€è¦è§¦å‘åˆå§‹åŒ–çš„æƒ…å†µï¼›ClassLoader.loadClassé€‚ç”¨äºéœ€è¦æ§åˆ¶ç±»åŠ è½½å™¨å’Œé¿å…ç±»åˆå§‹åŒ–çš„æƒ…å†µã€‚ åŠ è½½å™¨çš„é€‰æ‹©ï¼šClass.forNameä½¿ç”¨å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ClassLoaderï¼Œè€ŒClassLoader.loadClasså¯ä»¥æ˜¾å¼æŒ‡å®šClassLoaderã€‚ 2.2 è·å–æ„é€ å‡½æ•° ConstructorClass ç±»ä¸­æœ‰ä»¥ä¸‹4ä¸ªæ–¹æ³•æ¥è·å–æ„é€ å‡½æ•° getConstructors()ï¼šè·å–æ‰€æœ‰å…¬å…±/publicæ„é€ å‡½æ•°ã€‚ getConstructor(Class&lt;?&gt;... parameterTypes)ï¼šè·å–æŒ‡å®šå‚æ•°ç±»å‹çš„å…¬å…±æ„é€ å‡½æ•°ã€‚ getDeclaredConstructors()ï¼šè·å–æ‰€æœ‰å£°æ˜çš„æ„é€ å‡½æ•°ï¼ˆåŒ…æ‹¬å…¬å…±ã€ä¿æŠ¤ã€é»˜è®¤ï¼ˆåŒ…ï¼‰è®¿é—®å’Œç§æœ‰ï¼‰ã€‚ getDeclaredConstructor(Class&lt;?&gt;... parameterTypes)ï¼šè·å–æŒ‡å®šå‚æ•°ç±»å‹çš„å£°æ˜çš„æ„é€ å‡½æ•°ï¼ˆåŒ…æ‹¬å…¬å…±ã€ä¿æŠ¤ã€é»˜è®¤ï¼ˆåŒ…ï¼‰è®¿é—®å’Œç§æœ‰ï¼‰ã€‚ 2.2.1 constructor.newInstanceä½¿ç”¨æ„é€ å‡½æ•°è·å–å®ä¾‹åŒ–å¯¹è±¡ä»ä»¥ä¸Šä»£ç ç¤ºä¾‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä½¿ç”¨åå°„è·å–ä¸€ä¸ªå¯¹è±¡çš„æ­¥éª¤ï¼š 12Constructor&lt;?&gt; constructor = clazz.getConstructor();Object instance = constructor.newInstance(); 2.3 Method![ getMethods()ï¼šè·å–æ‰€æœ‰å…¬å…±æ–¹æ³•ï¼ŒåŒ…æ‹¬ç»§æ‰¿çš„æ–¹æ³•ã€‚ getMethod(String name, Class&lt;?&gt;... parameterTypes)ï¼šè·å–æŒ‡å®šåç§°å’Œå‚æ•°ç±»å‹çš„å…¬å…±æ–¹æ³•ï¼ŒåŒ…æ‹¬ç»§æ‰¿çš„æ–¹æ³•ã€‚ getDeclaredMethods()ï¼šè·å–æ‰€æœ‰å£°æ˜çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬å…¬å…±ã€ä¿æŠ¤ã€é»˜è®¤ï¼ˆåŒ…ï¼‰è®¿é—®å’Œç§æœ‰æ–¹æ³•ï¼Œä½†ä¸åŒ…æ‹¬ç»§æ‰¿çš„æ–¹æ³•ã€‚ getDeclaredMethod(String name, Class&lt;?&gt;... parameterTypes)ï¼šè·å–æŒ‡å®šåç§°å’Œå‚æ•°ç±»å‹çš„å£°æ˜çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬å…¬å…±ã€ä¿æŠ¤ã€é»˜è®¤ï¼ˆåŒ…ï¼‰è®¿é—®å’Œç§æœ‰æ–¹æ³•ï¼Œä½†ä¸åŒ…æ‹¬ç»§æ‰¿çš„æ–¹æ³•ã€‚ 2.4 Field getFields()ï¼šè·å–æ‰€æœ‰å…¬å…±å­—æ®µï¼ŒåŒ…æ‹¬ç»§æ‰¿çš„å…¬å…±å­—æ®µã€‚ getField(String name)ï¼šè·å–æŒ‡å®šåç§°çš„å…¬å…±å­—æ®µã€‚ getDeclaredFields()ï¼šè·å–æ‰€æœ‰å£°æ˜çš„å­—æ®µï¼ŒåŒ…æ‹¬å…¬å…±ã€ä¿æŠ¤ã€é»˜è®¤ï¼ˆåŒ…ï¼‰è®¿é—®å’Œç§æœ‰å­—æ®µï¼Œä½†ä¸åŒ…æ‹¬ç»§æ‰¿çš„å­—æ®µã€‚ getDeclaredField(String name)ï¼šè·å–æŒ‡å®šåç§°çš„å£°æ˜çš„å­—æ®µï¼ŒåŒ…æ‹¬å…¬å…±ã€ä¿æŠ¤ã€é»˜è®¤ï¼ˆåŒ…ï¼‰è®¿é—®å’Œç§æœ‰å­—æ®µï¼Œä½†ä¸åŒ…æ‹¬ç»§æ‰¿çš„å­—æ®µã€‚ 2.5 getInterfaces1public Class&lt;?&gt;[] getInterfaces() è¿”å›ä¸€ä¸ª Class å¯¹è±¡æ•°ç»„ï¼Œè¡¨ç¤ºç±»æˆ–æ¥å£å®ç°çš„æ‰€æœ‰æ¥å£ã€‚ 2.6 ç¤ºä¾‹ä»£ç ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ä»£ç 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374public class ReflectionExample &#123; public static void main(String[] args) &#123; try &#123; // è·å–Classå¯¹è±¡ Class&lt;?&gt; clazz = Class.forName(&quot;com.example.codingInAction.reflectionPractice.Person&quot;); // è·å–æ‰€æœ‰æ„é€ å‡½æ•° Constructor&lt;?&gt;[] constructors = clazz.getDeclaredConstructors(); for (Constructor&lt;?&gt; constructor : constructors) &#123; System.out.println(&quot;Constructor: &quot; + constructor); &#125; // è·å–æ— å‚æ„é€ å‡½æ•° Constructor&lt;?&gt; constructor1 = clazz.getDeclaredConstructor(); System.out.println(&quot;Constructor1: &quot; + constructor1); Constructor&lt;?&gt; constructor2 = clazz.getDeclaredConstructor(String.class); System.out.println(&quot;Constructor2: &quot; + constructor2); Constructor&lt;?&gt; constructor3 = clazz.getDeclaredConstructor(int.class); System.out.println(&quot;Constructor3: &quot; + constructor3); Constructor&lt;?&gt; constructor4 = clazz.getConstructor(String.class, int.class); System.out.println(&quot;Constructor4: &quot; + constructor4); Object alex = constructor4.newInstance(&quot;Alex&quot;, 30); System.out.println(alex); // è·å–æ‰€æœ‰æ–¹æ³• Method[] methods = clazz.getDeclaredMethods(); for (Method method : methods) &#123; System.out.println(&quot;Method: &quot; + method); &#125; // è·å–æŒ‡å®šåç§°å’Œå‚æ•°ç±»å‹çš„å£°æ˜çš„æ–¹æ³• Method setAgeMethod = clazz.getDeclaredMethod(&quot;setAge&quot;, int.class); System.out.println(&quot;Method: &quot; + setAgeMethod); // å¦‚æœæ˜¯ç§æœ‰æ–¹æ³•ï¼Œéœ€è¦è®¾ç½®æˆ å¯è®¿é—® // setAgeMethod.setAccessible(true); setAgeMethod.invoke(alex, 35); Method getAgeMethod = clazz.getDeclaredMethod(&quot;getAge&quot;); int age = (Integer) getAgeMethod.invoke(alex); System.out.println(&quot;alex&#x27;s age is &quot; + age); // è·å–æ‰€æœ‰å­—æ®µ Field[] fields = clazz.getDeclaredFields(); for (Field field : fields) &#123; System.out.println(&quot;Field: &quot; + field); &#125; // è·å–æŒ‡å®šåç§°çš„å£°æ˜çš„å­—æ®µ Field ageField = clazz.getDeclaredField(&quot;age&quot;); System.out.println(&quot;Field: &quot; + ageField); //å¦‚æœæ˜¯private, éœ€è¦è®¾ç½®æˆ â€œå¯è®¿é—®â€ ageField.setAccessible(true); System.out.println(&quot;Age: &quot; + ageField.get(alex)); &#125; catch (ClassNotFoundException | NoSuchMethodException | IllegalAccessException | InvocationTargetException | InstantiationException e) &#123; e.printStackTrace(); &#125; catch (NoSuchFieldException e) &#123; throw new RuntimeException(e); &#125; &#125;&#125; 3. åå°„çš„ç¼ºç‚¹3.1 ç ´åå°è£…æ€§åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œå°è£…æ€§æ˜¯æŒ‡å°†å¯¹è±¡çš„å±æ€§å’Œå®ç°ç»†èŠ‚éšè—èµ·æ¥ï¼Œåªæš´éœ²å¿…è¦çš„æ¥å£ç»™å¤–éƒ¨ä½¿ç”¨ã€‚é€šè¿‡è®¿é—®æ§åˆ¶ä¿®é¥°ç¬¦ï¼ˆå¦‚ privateã€protectedã€publicï¼‰ï¼Œç±»å¯ä»¥æ§åˆ¶å“ªäº›æˆå‘˜å¯ä»¥è¢«å¤–éƒ¨è®¿é—®ï¼Œä»è€Œä¿æŠ¤å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œç¡®ä¿å¯¹è±¡çš„ä¸€è‡´æ€§å’Œå®‰å…¨æ€§ã€‚ ä»ä¸Šé¢çš„ä»£ç å¯ä»¥æ˜æ˜¾çœ‹å‡ºä¸€ä¸ªé—®é¢˜ï¼Œ æˆ‘ä»¬å®šä¹‰çš„private æ„é€ å‡½æ•°å’Œå­—æ®µï¼Œ é€šè¿‡getDeclared* å’ŒsetAccessible åå¯ä»¥ä½¿å¾—åŸæœ¬ç§æœ‰çš„æˆå‘˜å˜å¾—å¯è®¿é—®ï¼Œè¿™æ— ç–‘ç ´åäº†priavte çš„è¯­ä¹‰ï¼Œä¹Ÿå°±æ˜¯å°è£…æ€§ã€‚ è®¿é—®ç§æœ‰æ–¹æ³• è®¿é—®ç§æœ‰å˜é‡ åå°„ç ´åå°è£…æ€§çš„å½±å“ å®‰å…¨æ€§é—®é¢˜ï¼šç§æœ‰å­—æ®µå’Œæ–¹æ³•çš„è®¿é—®æ§åˆ¶è¢«ç»•è¿‡ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºçš„å®‰å…¨æ€§é—®é¢˜ã€‚ å¯¹è±¡ä¸€è‡´æ€§ï¼šç§æœ‰å­—æ®µçš„ä¿®æ”¹å¯èƒ½ä¼šç ´åå¯¹è±¡çš„ä¸€è‡´æ€§ï¼Œå¯¼è‡´ä¸å¯é¢„çŸ¥çš„è¡Œä¸ºã€‚ä¾‹å¦‚ï¼ŒæŸä¸ªå­—æ®µå¯èƒ½éœ€è¦é€šè¿‡ç‰¹å®šçš„æ–¹æ³•è¿›è¡Œä¿®æ”¹ï¼Œä»¥ç¡®ä¿å…¶å€¼çš„åˆæ³•æ€§ï¼Œè€Œç›´æ¥ä¿®æ”¹å­—æ®µå¯èƒ½ä¼šç»•è¿‡è¿™äº›æ£€æŸ¥ã€‚ ç»´æŠ¤æ€§é™ä½ï¼šä½¿ç”¨åå°„è®¿é—®ç§æœ‰æˆå‘˜ä¼šä½¿ä»£ç å˜å¾—éš¾ä»¥ç»´æŠ¤ï¼Œå› ä¸ºè¿™äº›æ“ä½œä¾èµ–äºç±»çš„å†…éƒ¨å®ç°ï¼Œè€Œä¸æ˜¯å…¶å…¬å¼€çš„æ¥å£ã€‚ç±»çš„å®ç°ç»†èŠ‚å˜åŒ–å¯èƒ½ä¼šå¯¼è‡´åå°„ä»£ç å¤±æ•ˆã€‚ å¦‚ä½•é¿å…åå°„ç ´åå°è£…æ€§ æœ€å°åŒ–åå°„çš„ä½¿ç”¨ï¼šå°½é‡å‡å°‘åå°„çš„ä½¿ç”¨ï¼Œå°¤å…¶æ˜¯å¯¹äºç§æœ‰æˆå‘˜çš„è®¿é—®ã€‚ ä½¿ç”¨é€‚å½“çš„è®¿é—®ä¿®é¥°ç¬¦ï¼šç¡®ä¿ç±»çš„è®¾è®¡åˆç†ï¼Œå…¬å¼€å¿…è¦çš„æ¥å£ï¼Œç§æœ‰åŒ–ä¸åº”è¢«å¤–éƒ¨è®¿é—®çš„æˆå‘˜ã€‚ å®‰å…¨ç®¡ç†å™¨ï¼šåœ¨æ•æ„Ÿåº”ç”¨ä¸­ï¼Œä½¿ç”¨å®‰å…¨ç®¡ç†å™¨æ¥é™åˆ¶åå°„æ“ä½œï¼Œé˜²æ­¢æœªç»æˆæƒçš„è®¿é—®ã€‚ 3.2 æ•ˆç‡ä½å¤§å®¶éƒ½è¯´ Java åå°„æ•ˆç‡ä½ï¼Œä½ çŸ¥é“åŸå› åœ¨å“ªé‡Œä¹ˆ åå°„æ•ˆç‡ä½çš„åŸå› ä¸»è¦åœ¨äºé¢å¤–çš„ç±»å‹æ£€æŸ¥å’Œå®‰å…¨æ£€æŸ¥ã€æ–¹æ³•è°ƒç”¨çš„é—´æ¥æ€§ã€ç¼ºä¹ç¼–è¯‘æ—¶ä¼˜åŒ–ä»¥åŠå¢åŠ çš„å†…å­˜å¼€é”€ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œé™¤éç¡®å®éœ€è¦åŠ¨æ€æ€§å’Œçµæ´»æ€§ï¼Œå¦åˆ™åº”å°½é‡é¿å…ä½¿ç”¨åå°„ï¼Œä»¥æé«˜ä»£ç çš„æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚å¦‚æœå¿…é¡»ä½¿ç”¨åå°„ï¼Œåº”å°½é‡å‡å°‘åå°„è°ƒç”¨çš„æ¬¡æ•°ï¼Œæˆ–è€…åœ¨åˆå§‹åŒ–é˜¶æ®µä½¿ç”¨åå°„å°†ç»“æœç¼“å­˜èµ·æ¥ï¼Œä»¥é™ä½è¿è¡Œæ—¶çš„å¼€é”€ã€‚ 1. é¢å¤–çš„ç±»å‹æ£€æŸ¥å’Œå®‰å…¨æ£€æŸ¥ ç±»å‹æ£€æŸ¥ï¼š åå°„åœ¨è¿è¡Œæ—¶æ‰§è¡Œï¼ŒJVM éœ€è¦åœ¨æ¯æ¬¡è®¿é—®å­—æ®µæˆ–è°ƒç”¨æ–¹æ³•æ—¶è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œä»¥ç¡®ä¿æ“ä½œçš„åˆæ³•æ€§ã€‚è¿™ä¸æ™®é€šæ–¹æ³•è°ƒç”¨çš„ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ç›¸æ¯”ï¼Œå¢åŠ äº†é¢å¤–çš„å¼€é”€ã€‚ å®‰å…¨æ£€æŸ¥ï¼š åå°„éœ€è¦è¿›è¡Œå®‰å…¨æ£€æŸ¥ï¼ˆå¦‚è®¿é—®æ§åˆ¶æ£€æŸ¥ï¼‰ï¼Œç‰¹åˆ«æ˜¯åœ¨è®¾ç½® setAccessible(true) æ—¶ã€‚è¿™äº›æ£€æŸ¥åœ¨æ¯æ¬¡åå°„è°ƒç”¨æ—¶éƒ½ä¼šè¿›è¡Œï¼Œå¢åŠ äº†è¿è¡Œæ—¶çš„å¼€é”€ã€‚ 2. æ–¹æ³•è°ƒç”¨çš„é—´æ¥æ€§æ™®é€šæ–¹æ³•è°ƒç”¨æ˜¯é€šè¿‡ç›´æ¥çš„å­—èŠ‚ç æŒ‡ä»¤è¿›è¡Œçš„ï¼ŒJVM å¯ä»¥è¿›è¡Œå„ç§ä¼˜åŒ–ï¼Œå¦‚å†…è”ï¼ˆinliningï¼‰ã€å³æ—¶ç¼–è¯‘ï¼ˆJITï¼‰ç­‰ã€‚è€Œåå°„è°ƒç”¨æ˜¯é€šè¿‡åå°„ API é—´æ¥è°ƒç”¨æ–¹æ³•ï¼Œä¸èƒ½äº«å—è¿™äº›ä¼˜åŒ–ã€‚ 3. ç¼ºä¹ç¼–è¯‘æ—¶ä¼˜åŒ–ç¼–è¯‘æ—¶ä¼˜åŒ–å¯ä»¥æ˜¾è‘—æé«˜ä»£ç æ‰§è¡Œæ•ˆç‡ï¼Œä½†åå°„æ“ä½œæ˜¯åœ¨è¿è¡Œæ—¶å†³å®šçš„ï¼Œå› æ­¤ç¼–è¯‘å™¨æ— æ³•è¿›è¡Œè¿™äº›ä¼˜åŒ–ã€‚ç¼–è¯‘å™¨å¯¹æ™®é€šæ–¹æ³•è°ƒç”¨å¯ä»¥è¿›è¡Œå¤šç§ä¼˜åŒ–ï¼Œå¦‚å¸¸é‡æŠ˜å ã€å¾ªç¯å±•å¼€ç­‰ï¼Œä½†å¯¹åå°„æ“ä½œåˆ™æ— èƒ½ä¸ºåŠ›ã€‚ 4. å†…å­˜å¼€é”€åå°„æ“ä½œä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€ï¼ŒåŒ…æ‹¬ï¼š åˆ›å»ºå’Œç»´æŠ¤åå°„å¯¹è±¡ï¼ˆå¦‚ Methodã€Field ç­‰ï¼‰ã€‚ åå°„è°ƒç”¨æ—¶éœ€è¦åˆ›å»ºæ•°ç»„æ¥ä¼ é€’å‚æ•°å’Œè¿”å›å€¼ã€‚ åå°„è°ƒç”¨çš„ç»“æœéœ€è¦è¿›è¡Œç±»å‹è½¬æ¢ï¼Œè¿™ä¹Ÿä¼šå¢åŠ å†…å­˜å¼€é”€ã€‚ 4. æºç è§£æ-invokeé‡ç‚¹ä»‹ç»method.invoke çš„å®ç°åŸç† 1234567891011121314151617181920212223242526272829@CallerSensitive@ForceInline // to ensure Reflection.getCallerClass optimization@HotSpotIntrinsicCandidatepublic Object invoke(Object obj, Object... args) throws IllegalAccessException, IllegalArgumentException, InvocationTargetException&#123; // æ£€æŸ¥æ˜¯å¦éœ€è¦è¿›è¡Œè®¿é—®æ§åˆ¶æ£€æŸ¥ if (!override) &#123; // è·å–è°ƒç”¨è€…çš„ç±» Class&lt;?&gt; caller = Reflection.getCallerClass(); // æ£€æŸ¥è®¿é—®æƒé™ï¼Œæ£€æŸ¥è°ƒç”¨è€…æ˜¯å¦æœ‰æƒé™è°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚å¦‚æœç›®æ ‡æ–¹æ³•æ˜¯é™æ€çš„ï¼Œåˆ™ç¬¬ä¸‰ä¸ªå‚æ•°ä¸º nullï¼Œå¦åˆ™ä¸ºç›®æ ‡å¯¹è±¡çš„ç±»ã€‚ checkAccess(caller, clazz, Modifier.isStatic(modifiers) ? null : obj.getClass(), modifiers); &#125; // è·å–MethodAccessorå®ä¾‹ // è¿™æ˜¯ä¸€ä¸ªvolatileå­—æ®µï¼Œç¡®ä¿å¤šçº¿ç¨‹è®¿é—®æ—¶çš„å¯è§æ€§ã€‚ MethodAccessor ma = methodAccessor; // read volatile // å¦‚æœ methodAccessor ä¸ºç©ºï¼Œåˆ™è°ƒç”¨æ­¤æ–¹æ³•è·å–ä¸€ä¸ªæ–°çš„ MethodAccessor å®ä¾‹ã€‚ // MethodAccessor æ˜¯å®é™…æ‰§è¡Œåå°„è°ƒç”¨çš„æ¥å£ï¼Œå…¶å®ç°ç”±JVMæä¾›ï¼Œå¯èƒ½æ˜¯ç”Ÿæˆçš„å­—èŠ‚ç æˆ–æœ¬åœ°ä»£ç ã€‚ if (ma == null) &#123; ma = acquireMethodAccessor(); &#125; // ä½¿ç”¨MethodAccessorè°ƒç”¨ç›®æ ‡æ–¹æ³• return ma.invoke(obj, args);&#125; 4.1 ä¼˜åŒ–ä¸æ€§èƒ½é€šè¿‡æ³¨è§£ @ForceInline å’Œ @HotSpotIntrinsicCandidateï¼ŒJVMå¯ä»¥å¯¹ invoke æ–¹æ³•è¿›è¡Œå†…è”ä¼˜åŒ–å’Œæœ¬åœ°ä»£ç ä¼˜åŒ–ï¼Œä»è€Œå‡å°‘åå°„è°ƒç”¨çš„æ€§èƒ½å¼€é”€ã€‚ 4.2 acquireMethodAccessor12345678910111213141516171819public final class Method extends Executable &#123; private MethodAccessor acquireMethodAccessor() &#123; // First check to see if one has been created yet, and take it // if so MethodAccessor tmp = null; if (root != null) tmp = root.getMethodAccessor(); if (tmp != null) &#123; methodAccessor = tmp; &#125; else &#123; // Otherwise fabricate one and propagate it up to the root tmp = reflectionFactory.newMethodAccessor(this); setMethodAccessor(tmp); &#125; return tmp; &#125;&#125; ä»ä»¥ä¸Šä»£ç å¯ä»¥çœ‹å‡ºï¼Œ ç”ŸæˆMethodAccessoræ—¶ç”¨åˆ°äº†å·¥å‚æ¨¡å¼ï¼Œ è¯´æ˜æœ‰å¤šä¸ªMethodAccessorï¼Œä¸‹é¢æ¥å…·ä½“çœ‹ä¸€ä¸‹MethodAccessoråŠå…¶å®ç° 4.3 MethodAccessorMethodAccessor æ˜¯ä¸€ä¸ªå†…éƒ¨æ¥å£ï¼Œç”¨äºæŠ½è±¡åå°„æœºåˆ¶ä¸­å®é™…çš„æ–¹æ³•è°ƒç”¨å®ç°ã€‚å…·ä½“çš„å®ç°ç±»æœ‰å‡ ç§ï¼Œå…¶ä¸­åŒ…æ‹¬ DelegatingMethodAccessorImplã€MethodAccessorImpl å’Œ NativeMethodAccessorImplã€‚æ¯ä¸ªå®ç°ç±»éƒ½æœ‰å…¶ç‰¹å®šçš„ä½œç”¨å’Œå®ç°æ–¹å¼ã€‚ å…¶å®ç°å¯èƒ½æ˜¯åŠ¨æ€ç”Ÿæˆçš„å­—èŠ‚ç ï¼ˆå¦‚MethodAccessorImplï¼‰ï¼Œæˆ–è€…æ˜¯é€šè¿‡JNIè°ƒç”¨æœ¬åœ°ä»£ç ï¼ˆå¦‚ NativeMethodAccessorImplï¼‰ã€‚å…·ä½“å®ç°å¯èƒ½ä¼šåœ¨ä¸åŒçš„JVMä¸­æœ‰æ‰€ä¸åŒï¼Œä½†ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æé«˜åå°„è°ƒç”¨çš„æ€§èƒ½ã€‚ 12345public interface MethodAccessor &#123; /** Matches specification in &#123;@link java.lang.reflect.Method&#125; */ public Object invoke(Object obj, Object[] args) throws IllegalArgumentException, InvocationTargetException; &#125; NativeMethodAccessorImpl ä½¿ç”¨JNIæ¥è°ƒç”¨æœ¬åœ°æ–¹æ³•ï¼Œå…·æœ‰è¾ƒé«˜çš„æ€§èƒ½ã€‚ MethodAccessorImpl ä½¿ç”¨ç”Ÿæˆå­—èŠ‚ç çš„æ–¹å¼æ¥æé«˜æ€§èƒ½ã€‚ DelegatingMethodAccessorImpl ç”¨äºåœ¨è¿è¡Œæ—¶åŠ¨æ€æ›¿æ¢ MethodAccessor å®ç°ï¼Œä»¥ä¼˜åŒ–åå°„è°ƒç”¨çš„æ€§èƒ½ã€‚ 4.3.1 NativeMethodAccessorImplNativeMethodAccessorImpl ä½¿ç”¨ JNIï¼ˆJava Native Interfaceï¼‰æ¥è°ƒç”¨æœ¬åœ°æ–¹æ³•ã€‚å®ƒæ˜¯é€šè¿‡æœ¬åœ°ä»£ç å®ç°çš„ï¼Œåœ¨å†·å¯åŠ¨æ–¹é¢å…·æœ‰è¾ƒé«˜çš„æ•ˆç‡ï¼Œä½†æ˜¯å®é™…è°ƒç”¨æ˜¯æ€§èƒ½è¾ƒæ…¢ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142/** Used only for the first few invocations of a Method; afterward, switches to bytecode-based implementation */class NativeMethodAccessorImpl extends MethodAccessorImpl &#123; private final Method method; private DelegatingMethodAccessorImpl parent; private int numInvocations; NativeMethodAccessorImpl(Method method) &#123; this.method = method; &#125; public Object invoke(Object obj, Object[] args) throws IllegalArgumentException, InvocationTargetException &#123; // We can&#x27;t inflate methods belonging to vm-anonymous classes because // that kind of class can&#x27;t be referred to by name, hence can&#x27;t be // found from the generated bytecode. if (++numInvocations &gt; ReflectionFactory.inflationThreshold() &amp;&amp; !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) &#123; MethodAccessorImpl acc = (MethodAccessorImpl) new MethodAccessorGenerator(). generateMethod(method.getDeclaringClass(), method.getName(), method.getParameterTypes(), method.getReturnType(), method.getExceptionTypes(), method.getModifiers()); parent.setDelegate(acc); &#125; return invoke0(method, obj, args); &#125; void setParent(DelegatingMethodAccessorImpl parent) &#123; this.parent = parent; &#125; private static native Object invoke0(Method m, Object obj, Object[] args);&#125; 4.3.2 MethodAccessorImplMethodAccessorImpl æ˜¯é€šè¿‡ç”Ÿæˆå­—èŠ‚ç æ¥æé«˜åå°„è°ƒç”¨çš„æ€§èƒ½ã€‚å…·ä½“å®ç°æ¶‰åŠç”ŸæˆåŠ¨æ€å­—èŠ‚ç ï¼Œä»¥ç›´æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚ 123456abstract class MethodAccessorImpl extends MagicAccessorImpl implements MethodAccessor &#123; /** Matches specification in &#123;@link java.lang.reflect.Method&#125; */ public abstract Object invoke(Object obj, Object[] args) throws IllegalArgumentException, InvocationTargetException; &#125; 4.3.3 DelegatingMethodAccessorImplDelegatingMethodAccessorImpl æ˜¯ä¸€ç§å§”æ‰˜å®ç°ï¼Œå®ƒå°†è°ƒç”¨å§”æ‰˜ç»™å¦ä¸€ä¸ª MethodAccessor å®ä¾‹ã€‚è¿™ç§è®¾è®¡é€šå¸¸ç”¨äºåœ¨è¿è¡Œæ—¶åŠ¨æ€æ›¿æ¢ MethodAccessor å®ç°ï¼Œä»¥æé«˜æ€§èƒ½ã€‚ 1234567891011121314151617class DelegatingMethodAccessorImpl extends MethodAccessorImpl &#123; private MethodAccessorImpl delegate; DelegatingMethodAccessorImpl(MethodAccessorImpl delegate) &#123; setDelegate(delegate); &#125; public Object invoke(Object obj, Object[] args) throws IllegalArgumentException, InvocationTargetException &#123; return delegate.invoke(obj, args); &#125; void setDelegate(MethodAccessorImpl delegate) &#123; this.delegate = delegate; &#125;&#125; 4.4 invoke å®ç°çš„ä¸¤ç§æ–¹å¼ä»MethodAccessorçš„3ä¸ªå®ç°ç±»å¯ä»¥çœ‹å‡ºï¼Œinvoke æ–¹æ³•å†…éƒ¨çš„å®ç°æ¶‰åŠåˆ°ä¸¤ç§ä¸åŒçš„æ–¹å¼ï¼šåŸç”Ÿï¼ˆnativeï¼‰å®ç°æ–¹å¼å’ŒJavaå­—èŠ‚ç å®ç°æ–¹å¼ã€‚è¿™ä¸¤ç§å®ç°æ–¹å¼æ—¨åœ¨ä¼˜åŒ–ä¸åŒé˜¶æ®µçš„åå°„è°ƒç”¨æ€§èƒ½ã€‚ä¸‹é¢è¯¦ç»†è§£é‡Šè¿™ä¸¤ç§å®ç°æ–¹å¼ä»¥åŠå®ƒä»¬åœ¨invokeæ–¹æ³•ä¸­çš„åŠ¨æ€åˆ‡æ¢ã€‚ 4.4.1 åˆå§‹å®ç°ï¼šNative å®ç°æ–¹å¼åœ¨åå°„è°ƒç”¨çš„åˆå§‹é˜¶æ®µï¼Œä½¿ç”¨JNIï¼ˆJava Native Interfaceï¼‰/ NativeMethodAccessorImpl æ–¹å¼å¯ä»¥==å¿«é€Ÿç”Ÿæˆ==ä¸€ä¸ªå¯è°ƒç”¨çš„åå°„æ–¹æ³•ã€‚è¿™æ˜¯å› ä¸ºJNIè°ƒç”¨ç›´æ¥åˆ©ç”¨äº†ç°æœ‰çš„æœ¬åœ°ä»£ç å®ç°ï¼Œä¸éœ€è¦é¢å¤–çš„å­—èŠ‚ç ç”Ÿæˆè¿‡ç¨‹ã€‚ è¿™ç§æ–¹å¼å¯åŠ¨å¿«ï¼Œé€‚åˆåˆæ¬¡å’Œå°‘é‡è°ƒç”¨ã€‚ ç”Ÿæˆé€Ÿåº¦ ç”Ÿæˆå¿«ï¼šåˆæ¬¡è°ƒç”¨åå°„æ–¹æ³•æ—¶ï¼Œä½¿ç”¨JNIï¼ˆJava Native Interfaceï¼‰æ–¹å¼å¯ä»¥å¿«é€Ÿç”Ÿæˆä¸€ä¸ªå¯è°ƒç”¨çš„åå°„æ–¹æ³•ã€‚è¿™æ˜¯å› ä¸ºJNIè°ƒç”¨ç›´æ¥åˆ©ç”¨äº†ç°æœ‰çš„æœ¬åœ°ä»£ç å®ç°ï¼Œä¸éœ€è¦é¢å¤–çš„å­—èŠ‚ç ç”Ÿæˆè¿‡ç¨‹ã€‚ è¿è¡Œæ€§èƒ½ è¿è¡Œæ€§èƒ½ç›¸å¯¹è¾ƒæ…¢ï¼šè™½ç„¶JNIæ–¹å¼ç”Ÿæˆé€Ÿåº¦å¿«ï¼Œä½†åœ¨å®é™…è°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œåå°„è°ƒç”¨é€šè¿‡JNIè¿›è¡Œæœ¬åœ°æ–¹æ³•è°ƒç”¨ï¼Œæ²¡æœ‰é’ˆå¯¹Javaæ–¹æ³•è°ƒç”¨çš„ä¼˜åŒ–ã€‚åœ¨éœ€è¦å¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªåå°„æ–¹æ³•æ—¶ï¼Œè¿è¡Œæ€§èƒ½ä¼šæ¯”è¾ƒä½ã€‚ 4.4.2 ä¼˜åŒ–é˜¶æ®µï¼šJava å­—èŠ‚ç å®ç°æ–¹å¼å½“åå°„è°ƒç”¨è¾¾åˆ°ä¸€å®šé¢‘ç‡æ—¶ï¼ŒJVMä¼šåŠ¨æ€åˆ‡æ¢åˆ°åŸºäºJava å­—èŠ‚ç  MethodAccessorImplå®ç°æ–¹å¼ã€‚è¿™ç§æ–¹å¼é€šè¿‡åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç æ¥ç›´æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚ 1. ç”Ÿæˆé€Ÿåº¦ ç”Ÿæˆè¾ƒæ…¢ï¼šä½¿ç”¨å­—èŠ‚ç ç”Ÿæˆæ–¹å¼éœ€è¦åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆå’Œç¼–è¯‘Javaå­—èŠ‚ç ï¼Œè¿™ä¸ªè¿‡ç¨‹ç›¸å¯¹å¤æ‚ï¼Œåˆæ¬¡ç”Ÿæˆæ—¶ä¼šæ¯”JNIæ–¹å¼æ…¢ã€‚2. è°ƒç”¨è¿‡ç¨‹ è¿è¡Œæ—¶æœ‰æ€§èƒ½ä¼˜åŒ–ï¼šä¸€æ—¦ç”Ÿæˆäº†å­—èŠ‚ç å®ç°ï¼ŒJVMçš„å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰å¯ä»¥å¯¹è¿™äº›å­—èŠ‚ç è¿›è¡Œä¼˜åŒ–ï¼Œä»è€Œæé«˜æ‰§è¡Œæ•ˆç‡ã€‚3. è¿è¡Œæ€§èƒ½ æ‰§è¡Œæ¯”è¾ƒå¿«ï¼šç”Ÿæˆå­—èŠ‚ç åï¼ŒJVMçš„å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰å¯ä»¥å¯¹è¿™äº›å­—èŠ‚ç è¿›è¡Œä¼˜åŒ–ï¼Œä»è€Œæé«˜æ‰§è¡Œæ•ˆç‡ã€‚ç‰¹åˆ«æ˜¯åœ¨å¤šæ¬¡è°ƒç”¨æ—¶ä¼˜åŠ¿æ˜æ˜¾ã€‚ æ ¹æ®ä»¥ä¸Š2ç§æ–¹å¼çš„ç‰¹ç‚¹ä»‹ç»ï¼Œå¯ä»¥æ€»ç»“ä¸º JNIæ–¹å¼ç”Ÿæˆå¿«ï¼Œä½†æ˜¯è¿è¡Œæ€§èƒ½ç›¸å¯¹è¾ƒæ…¢ã€‚ å­—èŠ‚ç ç”Ÿæˆæ–¹å¼ç”Ÿæˆè¾ƒæ…¢ï¼Œä½†ç”Ÿæˆåè°ƒç”¨æ—¶æ€§èƒ½æ›´é«˜ï¼Œå› ä¸ºJVMçš„å³æ—¶ç¼–è¯‘å™¨å¯ä»¥å¯¹å­—èŠ‚ç è¿›è¡Œä¼˜åŒ–ã€‚ åŠ¨æ€åˆ‡æ¢æ‰€ä»¥å½“åå°„è°ƒç”¨è¾¾åˆ°ä¸€å®šæ¬¡æ•°åï¼Œæ›´å¸Œæœ›æ‰§è¡Œé€Ÿåº¦å¾—åˆ°ä¼˜åŒ–ï¼ŒJVMå°±ä¼šåŠ¨æ€åˆ‡æ¢ï¼Œä¼šä»JNIæ–¹å¼åˆ‡æ¢åˆ°å­—èŠ‚ç ç”Ÿæˆæ–¹å¼ï¼Œä»¥æé«˜è¿è¡Œæ—¶æ€§èƒ½ã€‚","tags":["Java"]}]